<div id="Roth_Library">
<div class="head">
<h1>Theory Roth_Library</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Library Material for Extremal Graph Theory›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Roth_Library
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Complex_Main.html">Complex_Main</a> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Disjoint_Sets.html">HOL-Library.Disjoint_Sets</a>"</span> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/FuncSet.html">HOL-Library.FuncSet</a>"</span> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Countable_Set.html">HOL-Library.Countable_Set</a>"</span>

<span class="comment1">(*MATERIAL INSTALLED IN DEVELOPMENT VERSION OF ISABELLE in 2021: To delete in 2022*)</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Sets, Cardinalities, etc.›</span></span>

<span class="keyword1" id="Roth_Library-card_Diff1_le"><span class="command">lemma</span></span> card_Diff1_le<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> card <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card.infinite card_Diff1_le eq_refl infinite_remove<span class="main">)</span>

<span class="keyword1" id="Roth_Library-partition_on_insert"><span class="command">lemma</span></span> partition_on_insert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"disjnt <span class="free">p</span> <span class="main">(</span><span class="main">⋃</span><span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="main">(</span>insert <span class="free">p</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟷</span> partition_on <span class="main">(</span><span class="free">A</span><span class="main">-</span><span class="free">p</span><span class="main">)</span> <span class="free">P</span> <span class="main">∧</span> <span class="free">p</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">p</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> partition_on_def disjnt_iff pairwise_insert<span class="main">)</span>

<span class="comment1">(*moved from Analysis/Measure_Space to Library/Disjoint_Sets*)</span>
<span class="keyword1" id="Roth_Library-disjoint_family_on_insert"><span class="command">lemma</span></span> disjoint_family_on_insert<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> <span class="free">I</span> <span class="main">⟹</span> disjoint_family_on <span class="free">A</span> <span class="main">(</span>insert <span class="free">i</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">A</span> <span class="free">i</span> <span class="main">∩</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> disjoint_family_on <span class="free">A</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> disjoint_family_on_def<span class="main">)</span>

<span class="comment1">(*moved from Analysis/Ball_Volume to Nthroot*)</span>
<span class="keyword1" id="Roth_Library-power2_le_iff_abs_le"><span class="command">lemma</span></span> power2_le_iff_abs_le<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linordered_idom"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">⟷</span> <span class="main">¦</span><span class="free">x</span><span class="main">¦</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> abs_le_square_iff abs_of_nonneg<span class="main">)</span>

<span class="keyword1" id="Roth_Library-finite_inverse_image_gen"><span class="command">lemma</span></span> finite_inverse_image_gen<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">j</span></span><span class="main">∈</span><span class="free">D</span><span class="main">.</span> <span class="free">f</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_vimage_IntI <span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_conj_eq inf_commute vimage_def<span class="main">)</span>

<span class="keyword1" id="Roth_Library-finite_inverse_image"><span class="command">lemma</span></span> finite_inverse_image<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="free">f</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms finite_vimageI vimage_def<span class="main">)</span>

<span class="keyword1" id="Roth_Library-prod_le_power"><span class="command">lemma</span></span> prod_le_power<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linordered_semidom"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="free">A</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prod <span class="free">f</span> <span class="free">A</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">^</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> A
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">i</span> <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="skolem">A</span> <span class="main">≤</span> <span class="skolem">k'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> Suc <span class="skolem">k'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc_le_D <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">i</span> <span class="main">*</span> prod <span class="free">f</span> <span class="skolem">A</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">*</span> <span class="free">n</span> <span class="main">^</span> <span class="skolem">k'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> insert <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≥</span> <span class="main">1</span>›</span></span> k' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prod_nonneg mult_mono<span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">=</span> Suc <span class="skolem">k'</span>›</span></span> insert.hyps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≥</span> <span class="main">1</span>›</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Roth_Library-card_UN_disjoint'"><span class="command">lemma</span></span> card_UN_disjoint'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"disjoint_family_on <span class="free">C</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> finite <span class="main">(</span><span class="free">C</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">C</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> card <span class="main">(</span><span class="free">C</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_UN_disjoint disjoint_family_on_def<span class="main">)</span>

<span class="keyword1" id="Roth_Library-product_partition"><span class="command">lemma</span></span> product_partition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">X</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">U</span><span class="main">.</span> <span class="bound">U</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟹</span> finite <span class="bound">U</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">U</span><span class="main">∈</span><span class="free">R</span><span class="main">.</span> card <span class="bound">U</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> partition_on_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> card_Union_disjoint<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> comm_monoid_set
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Roth_Library-UNION_disjoint_family"><span class="command">lemma</span></span> UNION_disjoint_family<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> finite <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"disjoint_family_on <span class="free">A</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"F <span class="free">g</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">A</span> <span class="main">`</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> F <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> F <span class="free">g</span> <span class="main">(</span><span class="free">A</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> disjoint_family_on_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> UNION_disjoint<span class="main">)</span>

<span class="keyword1" id="Roth_Library-Union_disjoint_sets"><span class="command">lemma</span></span> Union_disjoint_sets<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> finite <span class="bound">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"disjoint <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"F <span class="free">g</span> <span class="main">(</span><span class="main">⋃</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>F <span class="main">∘</span> F<span class="main">)</span> <span class="free">g</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> disjoint_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Union_disjoint<span class="main">)</span>

<span class="keyword1" id="Roth_Library-card_from_nat_into"><span class="command">lemma</span></span> card_from_nat_into<span class="main">:</span>
  <span class="quoted"><span class="quoted">"F <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">h</span> <span class="main">(</span>from_nat_into <span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span>card <span class="free">A</span><span class="main">}</span> <span class="main">=</span> F <span class="free">h</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"F <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">h</span> <span class="main">(</span>from_nat_into <span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span>card <span class="free">A</span><span class="main">}</span> <span class="main">=</span> F <span class="free">h</span> <span class="main">(</span>from_nat_into <span class="free">A</span> <span class="main">`</span> <span class="main">{..&lt;</span>card <span class="free">A</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> True bij_betw_def bij_betw_from_nat_into_finite reindex_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> F <span class="free">h</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> True bij_betw_def bij_betw_from_nat_into_finite<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Roth_Library-disjoint_family_on_iff_disjoint_image"><span class="command">lemma</span></span> disjoint_family_on_iff_disjoint_image<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"disjoint_family_on <span class="free">A</span> <span class="free">I</span> <span class="main">⟷</span> disjoint <span class="main">(</span><span class="free">A</span> <span class="main">`</span> <span class="free">I</span><span class="main">)</span> <span class="main">∧</span> inj_on <span class="free">A</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"disjoint_family_on <span class="free">A</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"disjoint <span class="main">(</span><span class="free">A</span> <span class="main">`</span> <span class="free">I</span><span class="main">)</span> <span class="main">∧</span> inj_on <span class="free">A</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms disjoint_family_onD disjoint_family_on_disjoint_image inf.idem inj_onI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> disjoint_image_disjoint_family_on <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">metis</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement of Partitions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">refines</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set set <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">refines</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span>
        partition_on <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> partition_on <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> <span class="main">∃</span><span class="bound">Y</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">.</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="bound">Y</span><span class="main">)</span>"</span></span> 

<span class="keyword1" id="Roth_Library-refines_refl"><span class="command">lemma</span></span> refines_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="free">P</span> <span class="main">⟹</span> refines <span class="free">A</span> <span class="free">P</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> refines_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Roth_Library-refines_asym1"><span class="command">lemma</span></span> refines_asym1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"refines <span class="free">A</span> <span class="free">P</span> <span class="free">Q</span>"</span></span> <span class="quoted"><span class="quoted">"refines <span class="free">A</span> <span class="free">Q</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="skolem"><span class="skolem">X'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> <span class="skolem">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">⊆</span> <span class="skolem">X'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms refines_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> partition_on_def refines_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> <span class="free">P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">⊆</span> <span class="skolem">Y</span>›</span></span> disjnt_self_iff_empty disjnt_subset1 pairwiseD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">⊆</span> <span class="skolem">Y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Y</span> <span class="main">∈</span> <span class="free">Q</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Y</span> <span class="main">⊆</span> <span class="skolem">X'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Roth_Library-refines_asym"><span class="command">lemma</span></span> refines_asym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>refines <span class="free">A</span> <span class="free">P</span> <span class="free">Q</span><span class="main">;</span> refines <span class="free">A</span> <span class="free">Q</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">=</span><span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> antisym_conv refines_asym1<span class="main">)</span>

<span class="keyword1" id="Roth_Library-refines_trans"><span class="command">lemma</span></span> refines_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>refines <span class="free">A</span> <span class="free">P</span> <span class="free">Q</span><span class="main">;</span> refines <span class="free">A</span> <span class="free">Q</span> <span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span> refines <span class="free">A</span> <span class="free">P</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> order.trans refines_def<span class="main">)</span>

<span class="keyword1" id="Roth_Library-refines_obtains_subset"><span class="command">lemma</span></span> refines_obtains_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"refines <span class="free">A</span> <span class="free">P</span> <span class="free">Q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">q</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> <span class="bound">p</span> <span class="main">⊆</span> <span class="free">q</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">⊆</span> <span class="free">q</span> <span class="main">∨</span> disjnt <span class="skolem">p</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
    <span class="keyword1"><span class="command">using</span></span> that assms <span class="keyword1"><span class="command">unfolding</span></span> refines_def partition_on_def disjoint_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> disjnt_def disjnt_subset1<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">⊆</span> Union <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> <span class="bound">p</span> <span class="main">⊆</span> <span class="free">q</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms 
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> refines_def disjnt_iff partition_on_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Union_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> Union <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> <span class="bound">p</span> <span class="main">⊆</span> <span class="free">q</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> refines_def disjoint_def partition_on_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Common Refinement of a Set of Partitions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">common_refinement</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set set <span class="main">⇒</span> <span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">common_refinement</span> <span class="free"><span class="bound"><span class="entity">𝒫</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">f</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">Π<span class="hidden">⇩</span><sub>E</sub></span> <span class="bound">P</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">𝒫</span></span></span><span class="main">.</span> <span class="bound">P</span><span class="main">)</span><span class="main">.</span> <span class="main">{</span><span class="main">⋂</span> <span class="main">(</span><span class="bound">f</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">𝒫</span></span></span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹With non-extensional function space›</span></span>
<span class="keyword1" id="Roth_Library-common_refinement"><span class="command">lemma</span></span> common_refinement<span class="main">:</span> <span class="quoted"><span class="quoted">"common_refinement <span class="free">𝒫</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">f</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">Π</span> <span class="bound">P</span><span class="main">∈</span><span class="free">𝒫</span><span class="main">.</span> <span class="bound">P</span><span class="main">)</span><span class="main">.</span> <span class="main">{</span><span class="main">⋂</span> <span class="main">(</span><span class="bound">f</span> <span class="main">`</span> <span class="free">𝒫</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">⊆</span> <span class="var">?lhs</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> common_refinement_def PiE_def Ball_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> restrict_Pi_cancel image_restrict_eq restrict_extensional<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> common_refinement_def PiE_def<span class="main">)</span>

<span class="keyword1" id="Roth_Library-common_refinement_exists"><span class="command">lemma</span></span> common_refinement_exists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">X</span> <span class="main">∈</span> common_refinement <span class="free">𝒫</span><span class="main">;</span> <span class="free">P</span> <span class="main">∈</span> <span class="free">𝒫</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">R</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="free">X</span> <span class="main">⊆</span> <span class="bound">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> common_refinement<span class="main">)</span>

<span class="keyword1" id="Roth_Library-Union_common_refinement"><span class="command">lemma</span></span> Union_common_refinement<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>common_refinement <span class="free">𝒫</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋂</span> <span class="bound">P</span><span class="main">∈</span><span class="free">𝒫</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋂</span> <span class="bound">P</span><span class="main">∈</span><span class="free">𝒫</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">P</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span> <span class="main">(</span>common_refinement <span class="free">𝒫</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> common_refinement<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span><span class="main">∈</span><span class="free">𝒫</span><span class="main">.</span> <span class="main">∃</span><span class="bound">X</span><span class="main">∈</span><span class="bound">P</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">X</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="bound">P</span><span class="main">∈</span><span class="free">𝒫</span> <span class="main">⟹</span> <span class="skolem">F</span> <span class="bound">P</span> <span class="main">∈</span> <span class="bound">P</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="bound">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⋂</span> <span class="main">(</span><span class="skolem">F</span> <span class="main">`</span> <span class="free">𝒫</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">with</span></span> F <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span><span class="main">∈</span><span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="keyword1">Π</span> <span class="bound">P</span><span class="main">∈</span><span class="free">𝒫</span><span class="main">.</span> <span class="bound">P</span><span class="main">.</span> <span class="main">{</span><span class="main">⋂</span> <span class="main">(</span><span class="bound">x</span> <span class="main">`</span> <span class="free">𝒫</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Pi_iff Bex_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> common_refinement_def<span class="main">)</span>

<span class="keyword1" id="Roth_Library-partition_on_common_refinement"><span class="command">lemma</span></span> partition_on_common_refinement<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> <span class="free">𝒫</span> <span class="main">⟹</span> partition_on <span class="free">A</span> <span class="bound">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒫</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="main">(</span>common_refinement <span class="free">𝒫</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> partition_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>common_refinement <span class="free">𝒫</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_on_def Union_common_refinement<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> common_refinement <span class="free">𝒫</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∈</span> common_refinement <span class="free">𝒫</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≠</span> <span class="skolem">Q</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">Π<span class="hidden">⇩</span><sub>E</sub></span> <span class="bound">P</span><span class="main">∈</span><span class="free">𝒫</span><span class="main">.</span> <span class="bound">P</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="main">⋂</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="free">𝒫</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
                  <span class="keyword2"><span class="keyword">and</span></span>   g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">Π<span class="hidden">⇩</span><sub>E</sub></span> <span class="bound">P</span><span class="main">∈</span><span class="free">𝒫</span><span class="main">.</span> <span class="bound">P</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">=</span> <span class="main">⋂</span> <span class="main">(</span><span class="skolem">g</span> <span class="main">`</span> <span class="free">𝒫</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> common_refinement_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span><span class="main">=</span><span class="skolem">g</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> extensionalityI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">𝒫</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">R</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">∈</span> <span class="free">𝒫</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> that P Q f g A <span class="main">[</span><span class="operator">unfolded</span> partition_on_def<span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">R</span> <span class="main">∈</span> <span class="free">𝒫</span>›</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">R</span> <span class="main">=</span> <span class="skolem">g</span> <span class="skolem">R</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> INT_E Int_iff PiE_iff disjointD emptyE<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> PiE_iff f g <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"disjnt <span class="skolem">P</span> <span class="skolem">Q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> P Q <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">≠</span> <span class="skolem">Q</span>›</span></span> disjnt_iff<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> common_refinement_def<span class="main">)</span>

<span class="keyword1" id="Roth_Library-refines_common_refinement"><span class="command">lemma</span></span> refines_common_refinement<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> <span class="free">𝒫</span> <span class="main">⟹</span> partition_on <span class="free">A</span> <span class="bound">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∈</span> <span class="free">𝒫</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"refines <span class="free">A</span> <span class="main">(</span>common_refinement <span class="free">𝒫</span><span class="main">)</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> refines_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI strip<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> common_refinement <span class="free">𝒫</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Y</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="skolem">X</span> <span class="main">⊆</span> <span class="bound">Y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> common_refinement_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> assms partition_on_common_refinement <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The common refinement is itself refined by any other›</span></span>
<span class="keyword1" id="Roth_Library-common_refinement_coarsest"><span class="command">lemma</span></span> common_refinement_coarsest<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> <span class="free">𝒫</span> <span class="main">⟹</span> partition_on <span class="free">A</span> <span class="bound">P</span>"</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> <span class="free">𝒫</span> <span class="main">⟹</span> refines <span class="free">A</span> <span class="free">R</span> <span class="bound">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒫</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"refines <span class="free">A</span> <span class="free">R</span> <span class="main">(</span>common_refinement <span class="free">𝒫</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> refines_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI ballI partition_on_common_refinement<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span> <span class="main">∈</span> <span class="skolem">P</span><span class="main">.</span> <span class="skolem">X</span> <span class="main">⊆</span> <span class="bound">p</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="free">𝒫</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">P</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> refines_def that<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> <span class="free">𝒫</span> <span class="main">⟹</span> <span class="skolem">F</span> <span class="bound">P</span> <span class="main">∈</span> <span class="bound">P</span> <span class="main">∧</span> <span class="skolem">X</span> <span class="main">⊆</span> <span class="skolem">F</span> <span class="bound">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="free">A</span> <span class="free">R</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">𝒫</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋂</span> <span class="main">(</span><span class="skolem">F</span> <span class="main">`</span> <span class="free">𝒫</span><span class="main">)</span> <span class="main">∈</span> common_refinement <span class="free">𝒫</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_on_def common_refinement Pi_iff Bex_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> cINF_greatest subset_empty<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> f <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Y</span><span class="main">∈</span>common_refinement <span class="free">𝒫</span><span class="main">.</span> <span class="skolem">X</span> <span class="main">⊆</span> <span class="bound">Y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">𝒫</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> cINF_greatest<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Roth_Library-finite_common_refinement"><span class="command">lemma</span></span> finite_common_refinement<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">𝒫</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> <span class="free">𝒫</span> <span class="main">⟹</span> finite <span class="bound">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>common_refinement <span class="free">𝒫</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="keyword1">Π<span class="hidden">⇩</span><sub>E</sub></span> <span class="bound">P</span><span class="main">∈</span><span class="free">𝒫</span><span class="main">.</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms finite_PiE<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> common_refinement_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Roth_Library-card_common_refinement"><span class="command">lemma</span></span> card_common_refinement<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">𝒫</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> <span class="free">𝒫</span> <span class="main">⟹</span> finite <span class="bound">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>common_refinement <span class="free">𝒫</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∏</span><span class="bound">P</span> <span class="main">∈</span> <span class="free">𝒫</span><span class="main">.</span> card <span class="bound">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>common_refinement <span class="free">𝒫</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">⋃</span><span class="bound">f</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">Π<span class="hidden">⇩</span><sub>E</sub></span> <span class="bound">P</span><span class="main">∈</span><span class="free">𝒫</span><span class="main">.</span> <span class="bound">P</span><span class="main">)</span><span class="main">.</span> <span class="main">{</span><span class="main">⋂</span> <span class="main">(</span><span class="bound">f</span> <span class="main">`</span> <span class="free">𝒫</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> common_refinement_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> card_Diff1_le<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">f</span><span class="main">∈</span><span class="main">(</span><span class="keyword1">Π<span class="hidden">⇩</span><sub>E</sub></span> <span class="bound">P</span><span class="main">∈</span><span class="free">𝒫</span><span class="main">.</span> <span class="bound">P</span><span class="main">)</span><span class="main">.</span> card<span class="main">{</span><span class="main">⋂</span> <span class="main">(</span><span class="bound">f</span> <span class="main">`</span> <span class="free">𝒫</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms finite_PiE card_UN_le<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card<span class="main">(</span><span class="keyword1">Π<span class="hidden">⇩</span><sub>E</sub></span> <span class="bound">P</span><span class="main">∈</span><span class="free">𝒫</span><span class="main">.</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">P</span> <span class="main">∈</span> <span class="free">𝒫</span><span class="main">.</span> card <span class="bound">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> card_PiE dual_order.eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Szemeredi">
<div class="head">
<h1>Theory Szemeredi</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Szemerédi's Regularity Lemma›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Szemeredi
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Roth_Library">Roth_Library</a> <span class="quoted">"<a href="../../girth_chromatic/theories/#Ugraphs">Girth_Chromatic.Ugraphs</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We formalise Szemerédi's Regularity Lemma, which is a major result in the study of large graphs
(extremal graph theory).
We follow Yufei Zhao's notes ``Graph Theory and Additive Combinatorics'' (MIT)
<span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">🌐</span></span>‹https://ocw.mit.edu/courses/mathematics/18-217-graph-theory-and-additive-combinatorics-fall-2019/lecture-notes/MIT18_217F19_ch3.pdf›</span></span>
and W.T. Gowers's notes ``Topics in Combinatorics'' (University of Cambridge, Lent 2004, Chapter 3)
<span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">🌐</span></span>‹https://www.dpmms.cam.ac.uk/~par31/notes/tic.pdf›</span></span>.
We also refer to a third source, also by Zhao and also entitled 
``Graph Theory and Additive Combinatorics'': <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">🌐</span></span>‹https://yufeizhao.com/gtac/gtac17.pdf›</span></span>.›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Miscellaneous›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A technical lemma used below in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹energy_graph_partition_half›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="keyword1" id="Szemeredi-sum_products_le"><span class="command">lemma</span></span> sum_products_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>linordered_idom"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">b</span> <span class="bound">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span><span class="free">b</span> <span class="bound">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">I</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">j</span> <span class="skolem">I</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>insert <span class="skolem">j</span> <span class="skolem">I</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">b</span> <span class="bound">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>
          <span class="main">≤</span> <span class="main">(</span><span class="free">a</span> <span class="skolem">j</span> <span class="main">*</span> <span class="free">b</span> <span class="skolem">j</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">a</span> <span class="skolem">j</span> <span class="main">*</span> <span class="free">b</span> <span class="skolem">j</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">I</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">b</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">I</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">I</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span><span class="free">b</span> <span class="bound">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">a</span> <span class="skolem">j</span> <span class="main">*</span> <span class="main">(</span><span class="free">a</span> <span class="skolem">j</span> <span class="main">*</span> <span class="main">(</span><span class="free">b</span> <span class="skolem">j</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">a</span> <span class="skolem">j</span> <span class="main">*</span> <span class="main">(</span>sum <span class="free">a</span> <span class="skolem">I</span> <span class="main">*</span> <span class="main">(</span><span class="free">b</span> <span class="skolem">j</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">I</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span><span class="free">b</span> <span class="bound">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span> 
                 <span class="main">+</span> sum <span class="free">a</span> <span class="skolem">I</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">I</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span><span class="free">b</span> <span class="bound">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">I</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span><span class="free">b</span> <span class="bound">i</span> <span class="main">-</span> <span class="free">b</span> <span class="skolem">j</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert.prems sum_nonneg<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">b</span> <span class="skolem">j</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">I</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">b</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>sum <span class="free">a</span> <span class="skolem">I</span> <span class="main">*</span> <span class="main">(</span><span class="free">b</span> <span class="skolem">j</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">I</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span><span class="free">b</span> <span class="bound">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">algebra_simps</span></span> sum_subtractf sum.distrib sum_distrib_left<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert.prems power2_eq_square mult.commute mult.left_commute mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Partitions indexed by integers›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finite_graph_partition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>uvert set<span class="main">,</span> nat <span class="main">⇒</span> uvert set<span class="main">,</span> nat<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">finite_graph_partition</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> partition_on <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span> disjoint_family_on <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">{..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Equivalent, simpler characterisation›</span></span>
<span class="keyword1" id="Szemeredi-finite_graph_partition_eq"><span class="command">lemma</span></span> finite_graph_partition_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_graph_partition <span class="free">V</span> <span class="free">P</span> <span class="free">n</span> <span class="main">⟷</span> partition_on <span class="free">V</span> <span class="main">(</span><span class="free">P</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span> inj_on <span class="free">P</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> finite_graph_partition_def 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> conj_cong<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">V</span> <span class="main">(</span><span class="free">P</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span> disjoint_family_on <span class="free">P</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">=</span> inj_on <span class="free">P</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> finite_graph_partition_def partition_on_def disjoint_family_on_def inj_on_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> disjointD inf.idem image_eqI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Szemeredi-finite_graph_partition_0"><span class="command">lemma</span></span> finite_graph_partition_0 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite_graph_partition <span class="free">V</span> <span class="free">P</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">V</span><span class="main">=</span><span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_graph_partition_eq partition_on_def<span class="main">)</span>

<span class="keyword1" id="Szemeredi-finite_graph_partition_equals"><span class="command">lemma</span></span> finite_graph_partition_equals<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite_graph_partition <span class="free">V</span> <span class="free">P</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> finite_graph_partition_def partition_on_def<span class="main">)</span>

<span class="keyword1" id="Szemeredi-finite_graph_partition_subset"><span class="command">lemma</span></span> finite_graph_partition_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>finite_graph_partition <span class="free">V</span> <span class="free">P</span> <span class="free">n</span><span class="main">;</span> <span class="free">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">i</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_graph_partition_equals <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Szemeredi-finite_graph_partition_nonempty"><span class="command">lemma</span></span> finite_graph_partition_nonempty<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>finite_graph_partition <span class="free">V</span> <span class="free">P</span> <span class="free">n</span><span class="main">;</span> <span class="free">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_graph_partition_def image_eqI lessThan_iff partition_on_def<span class="main">)</span>

<span class="keyword1" id="Szemeredi-trivial_graph_partition"><span class="command">lemma</span></span> trivial_graph_partition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite_graph_partition <span class="free">V</span> <span class="free">P</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">0</span> <span class="main">=</span> <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_graph_partition_equals <span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Szemeredi-trivial_graph_partition_exists"><span class="command">lemma</span></span> trivial_graph_partition_exists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite_graph_partition <span class="free">V</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">V</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lessThan_Suc finite_graph_partition_eq partition_on_def<span class="main">)</span>

<span class="keyword1" id="Szemeredi-finite_graph_partition_finite"><span class="command">lemma</span></span> finite_graph_partition_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite_graph_partition <span class="free">V</span> <span class="free">P</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">P</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms finite_UN finite_graph_partition_equals finite_lessThan lessThan_iff<span class="main">)</span>

<span class="keyword1" id="Szemeredi-finite_graph_partition_le"><span class="command">lemma</span></span> finite_graph_partition_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite_graph_partition <span class="free">V</span> <span class="free">P</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">P</span> <span class="free">i</span><span class="main">)</span> <span class="main">≤</span> card <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> UN_I assms card_mono finite_graph_partition_equals lessThan_iff subsetI<span class="main">)</span>

<span class="keyword1" id="Szemeredi-finite_graph_partition_gt0"><span class="command">lemma</span></span> finite_graph_partition_gt0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite_graph_partition <span class="free">V</span> <span class="free">P</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">P</span> <span class="free">i</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms card_gt_0_iff finite_graph_partition_def finite_graph_partition_finite imageI lessThan_iff partition_on_def<span class="main">)</span>

<span class="keyword1" id="Szemeredi-card_finite_graph_partition"><span class="command">lemma</span></span> card_finite_graph_partition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite_graph_partition <span class="free">V</span> <span class="free">P</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> card <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> card <span class="free">V</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> card <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sum card <span class="main">(</span><span class="free">P</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="free">k</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> finite_graph_partition_eq sum.reindex_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="free">k</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms card_Union_disjoint finite_graph_partition_def partition_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="free">V</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms finite_graph_partition_equals <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Szemeredi-finite_graph_partition_obtain"><span class="command">lemma</span></span> finite_graph_partition_obtain<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite_graph_partition <span class="free">V</span> <span class="free">P</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">i</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">P</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms finite_graph_partition_equals <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Partitions into two parts›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">binary_partition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'a</span> set<span class="main">,</span> <span class="tfree">'a</span> set<span class="main">,</span> nat<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">binary_partition</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">binary_partition</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1" id="Szemeredi-binary_partition2_eq"><span class="command">lemma</span></span> binary_partition2_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"binary_partition <span class="free">A</span> <span class="free">B</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="numeral">2</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">-</span><span class="free">A</span><span class="main">}</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> numeral_2_eq_2 lessThan_Suc<span class="main">)</span>

<span class="keyword1" id="Szemeredi-inj_binary_partition"><span class="command">lemma</span></span> inj_binary_partition<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> inj_on <span class="main">(</span>binary_partition <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="numeral">2</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> numeral_2_eq_2 lessThan_Suc<span class="main">)</span>

<span class="keyword1" id="Szemeredi-disjoint_family_binary_partition"><span class="command">lemma</span></span> disjoint_family_binary_partition<span class="main">:</span> <span class="quoted"><span class="quoted">"disjoint_family_on <span class="main">(</span>binary_partition <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="numeral">2</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> numeral_2_eq_2 lessThan_Suc disjoint_family_on_def<span class="main">)</span>

<span class="keyword1" id="Szemeredi-finite_graph_partition_binary_partition"><span class="command">lemma</span></span> finite_graph_partition_binary_partition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊂</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite_graph_partition <span class="free">B</span> <span class="main">(</span>binary_partition <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> finite_graph_partition_def partition_on_def binary_partition2_eq
    <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjnt_iff pairwise_insert disjoint_family_binary_partition<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Tools to combine the refinements of the partition <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">P</span></span> <span class="free"><span class="free">i</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for each <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹These are needed to retain the ``intuitive'' idea of partitions as indexed by integers.›</span></span>

<span class="keyword1" id="Szemeredi-less_sum_nat_iff"><span class="command">lemma</span></span> less_sum_nat_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">b</span><span class="main">::</span><span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">k</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="bound">j</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="bound">j</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="free">a</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_Suc_eq<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> not_less trans_less_add1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Szemeredi-less_sum_nat_iff_uniq"><span class="command">lemma</span></span> less_sum_nat_iff_uniq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">b</span><span class="main">::</span><span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">k</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃!</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span><span class="main">&lt;</span><span class="free">k</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="bound">j</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="bound">j</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="free">a</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_sum_nat_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> leD less_sum_nat_iff nat_neq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">part</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">part</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="bound">j</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="bound">j</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">j</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Szemeredi-part"><span class="command">lemma</span></span> part<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">j</span> <span class="main">=</span> part <span class="free">a</span> <span class="free">k</span> <span class="free">b</span> <span class="keyword1">in</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="free">a</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> less_sum_nat_iff_uniq part_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> theI'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_sum_nat_iff Let_def<span class="main">)</span>

<span class="keyword1" id="Szemeredi-part_Suc"><span class="command">lemma</span></span> part_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"part <span class="free">a</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="free">b</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> sum <span class="free">a</span> <span class="main">{..&lt;</span><span class="free">k</span><span class="main">}</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">&lt;</span> sum <span class="free">a</span> <span class="main">{..&lt;</span><span class="free">k</span><span class="main">}</span> <span class="main">+</span> <span class="free">a</span> <span class="free">k</span> <span class="keyword1">then</span> <span class="free">k</span> <span class="keyword1">else</span> part <span class="free">a</span> <span class="free">k</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> leD 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> part_def less_Suc_eq less_sum_nat_iff conj_disj_distribR <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> conj_cong<span class="main">)</span>

<span class="keyword1" id="Szemeredi-part_eq"><span class="command">lemma</span></span> part_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"part <span class="free">a</span> <span class="free">k</span> <span class="main">(</span>sum <span class="free">a</span> <span class="main">{..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">+</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> §<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="main">⟦</span>sum <span class="free">a</span> <span class="main">{..&lt;</span><span class="bound">j</span><span class="main">}</span> <span class="main">≤</span> sum <span class="free">a</span> <span class="main">{..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">+</span> <span class="free">d</span><span class="main">;</span>
              sum <span class="free">a</span> <span class="main">{..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">+</span> <span class="free">d</span> <span class="main">&lt;</span> sum <span class="free">a</span> <span class="main">{..&lt;</span><span class="bound">j</span><span class="main">}</span> <span class="main">+</span> <span class="free">a</span> <span class="bound">j</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="free">i</span>›</span></span> leD le_add1 less_sum_nat_iff nat_add_left_cancel_less not_less_iff_gr_or_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> part_def
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> the_equality<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> §<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Szemeredi-sum_layers_less"><span class="command">lemma</span></span> sum_layers_less<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">d</span><span class="main">::</span><span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">k</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">;</span> <span class="free">d</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="free">i</span><span class="main">⟧</span> <span class="main">⟹</span> sum <span class="free">a</span> <span class="main">{..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">+</span> <span class="free">d</span> <span class="main">&lt;</span> sum <span class="free">a</span> <span class="main">{..&lt;</span><span class="free">k</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> le_add1 less_sum_nat_iff nat_add_left_cancel_less<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Edges›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All edges between two sets of vertices, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Y</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, in a graph, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">G</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">all_edges_between</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set <span class="main">⇒</span> nat set <span class="main">⇒</span> nat set <span class="main">×</span> nat set set <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">all_edges_between</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∧</span> <span class="bound">y</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∧</span> <span class="main">{</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">}</span> <span class="main">∈</span> uedges <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Szemeredi-all_edges_between_subset"><span class="command">lemma</span></span> all_edges_between_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"all_edges_between <span class="free">X</span> <span class="free">Y</span> <span class="free">G</span> <span class="main">⊆</span> <span class="free">X</span><span class="main">×</span><span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_edges_between_def<span class="main">)</span>

<span class="keyword1" id="Szemeredi-max_all_edges_between"><span class="command">lemma</span></span> max_all_edges_between<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>all_edges_between <span class="free">X</span> <span class="free">Y</span> <span class="free">G</span><span class="main">)</span> <span class="main">≤</span> card <span class="free">X</span> <span class="main">*</span> card <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms card_mono finite_SigmaI all_edges_between_subset card_cartesian_product<span class="main">)</span>

<span class="keyword1" id="Szemeredi-all_edges_between_empty"><span class="command">lemma</span></span> all_edges_between_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"all_edges_between <span class="main">{}</span> <span class="free">Z</span> <span class="free">G</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"all_edges_between <span class="free">Z</span> <span class="main">{}</span> <span class="free">G</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_edges_between_def<span class="main">)</span>

<span class="keyword1" id="Szemeredi-all_edges_between_disjnt1"><span class="command">lemma</span></span> all_edges_between_disjnt1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"disjnt <span class="free">X</span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"disjnt <span class="main">(</span>all_edges_between <span class="free">X</span> <span class="free">Z</span> <span class="free">G</span><span class="main">)</span> <span class="main">(</span>all_edges_between <span class="free">Y</span> <span class="free">Z</span> <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_edges_between_def disjnt_iff<span class="main">)</span>

<span class="keyword1" id="Szemeredi-all_edges_between_disjnt2"><span class="command">lemma</span></span> all_edges_between_disjnt2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"disjnt <span class="free">Y</span> <span class="free">Z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"disjnt <span class="main">(</span>all_edges_between <span class="free">X</span> <span class="free">Y</span> <span class="free">G</span><span class="main">)</span> <span class="main">(</span>all_edges_between <span class="free">X</span> <span class="free">Z</span> <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_edges_between_def disjnt_iff<span class="main">)</span>

<span class="keyword1" id="Szemeredi-all_edges_between_Un1"><span class="command">lemma</span></span> all_edges_between_Un1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"all_edges_between <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="free">Z</span> <span class="free">G</span> <span class="main">=</span> all_edges_between <span class="free">X</span> <span class="free">Z</span> <span class="free">G</span> <span class="main">∪</span> all_edges_between <span class="free">Y</span> <span class="free">Z</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_edges_between_def<span class="main">)</span>

<span class="keyword1" id="Szemeredi-all_edges_between_Un2"><span class="command">lemma</span></span> all_edges_between_Un2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"all_edges_between <span class="free">X</span> <span class="main">(</span><span class="free">Y</span> <span class="main">∪</span> <span class="free">Z</span><span class="main">)</span> <span class="free">G</span> <span class="main">=</span> all_edges_between <span class="free">X</span> <span class="free">Y</span> <span class="free">G</span> <span class="main">∪</span> all_edges_between <span class="free">X</span> <span class="free">Z</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_edges_between_def<span class="main">)</span>

<span class="keyword1" id="Szemeredi-finite_all_edges_between"><span class="command">lemma</span></span> finite_all_edges_between<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>all_edges_between <span class="free">X</span> <span class="free">Y</span> <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> all_edges_between_subset assms finite_cartesian_product finite_subset<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Edge Density and Regular Pairs›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The edge density between two sets of vertices, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Y</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">G</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
      Authors disagree on whether the sets are assumed to be disjoint!.
      Quite a few authors assume disjointness, e.g. Malliaris and Shelah <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">🌐</span></span>‹https://www.jstor.org/stable/23813167›</span></span>
      For the following definitions, see pages 49--50 in Zhao's notes.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">edge_density</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> card<span class="main">(</span>all_edges_between <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>card <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">*</span> card <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Szemeredi-edge_density_ge0"><span class="command">lemma</span></span> edge_density_ge0<span class="main">:</span> <span class="quoted"><span class="quoted">"edge_density <span class="free">X</span> <span class="free">Y</span> <span class="free">G</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> edge_density_def<span class="main">)</span>

<span class="keyword1" id="Szemeredi-edge_density_le1"><span class="command">lemma</span></span> edge_density_le1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"edge_density <span class="free">X</span> <span class="free">Y</span> <span class="free">G</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> of_nat_mono <span class="main">[</span><span class="operator">OF</span> max_all_edges_between <span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edge_density_def <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Szemeredi-all_edges_between_swap"><span class="command">lemma</span></span> all_edges_between_swap<span class="main">:</span>
  <span class="quoted"><span class="quoted">"all_edges_between <span class="free">X</span> <span class="free">Y</span> <span class="free">G</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>all_edges_between <span class="free">Y</span> <span class="free">X</span> <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> all_edges_between_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_commute image_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1" id="Szemeredi-card_all_edges_between_commute"><span class="command">lemma</span></span> card_all_edges_between_commute<span class="main">:</span>
  <span class="quoted"><span class="quoted">"card <span class="main">(</span>all_edges_between <span class="free">X</span> <span class="free">Y</span> <span class="free">G</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>all_edges_between <span class="free">Y</span> <span class="free">X</span> <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat<span class="main">*</span>nat<span class="main">)</span>set"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_edges_between_swap <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">Y</span></span><span class="main"><span class="main">]</span></span> card_image<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Szemeredi-edge_density_commute"><span class="command">lemma</span></span> edge_density_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"edge_density <span class="free">X</span> <span class="free">Y</span> <span class="free">G</span> <span class="main">=</span> edge_density <span class="free">Y</span> <span class="free">X</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edge_density_def card_all_edges_between_commute mult.commute<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹$\epsilon$-regular pairs, for two sets of vertices. Again, authors disagree on whether the
sets need to be disjoint, though it seems that overlapping sets cause double-counting. Authors also
disagree about whether or not to use the strict subset relation here. The proofs below are easier if
it is strict but later proofs require the non-strict version. The two definitions can be proved to
be equivalent under fairly mild conditions.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">regular_pair</span><span class="main">::</span>  <span class="quoted"><span class="quoted">"uvert set  <span class="main">⇒</span> uvert set <span class="main">⇒</span> ugraph <span class="main">⇒</span> real <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">regular_pair</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">ε</span></span></span> <span class="main">≡</span> 
    <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊂</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∧</span> <span class="bound">B</span> <span class="main">⊂</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∧</span> <span class="main">(</span>card <span class="bound">A</span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">ε</span></span></span> <span class="main">*</span> card <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>card <span class="bound">B</span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">ε</span></span></span> <span class="main">*</span> card <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">⟶</span>
              <span class="main">¦</span>edge_density <span class="bound">A</span> <span class="bound">B</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">-</span> edge_density <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">¦</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">ε</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">ε</span><span class="main">::</span><span class="quoted">real</span>

<span class="keyword1" id="Szemeredi-regular_pair_commute"><span class="command">lemma</span></span> regular_pair_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"regular_pair <span class="free">X</span> <span class="free">Y</span> <span class="free">G</span> <span class="free">ε</span> <span class="main">⟷</span> regular_pair <span class="free">Y</span> <span class="free">X</span> <span class="free">G</span> <span class="free">ε</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> edge_density_commute regular_pair_def<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">irregular_pair</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">ε</span></span></span> <span class="main">≡</span> <span class="main">¬</span> regular_pair <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">ε</span></span></span>"</span></span>

<span class="keyword1" id="Szemeredi-irregular_pair_E"><span class="command">lemma</span></span> irregular_pair_E<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ε</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"irregular_pair <span class="free">X</span> <span class="free">Y</span> <span class="free">G</span> <span class="free">ε</span>"</span></span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">A</span> <span class="free">B</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊂</span> <span class="free">X</span> <span class="main">∧</span> <span class="free">B</span> <span class="main">⊂</span> <span class="free">Y</span> <span class="main">∧</span> <span class="main">(</span>card <span class="free">A</span> <span class="main">≥</span> <span class="free">ε</span> <span class="main">*</span> card <span class="free">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>card <span class="free">B</span> <span class="main">≥</span> <span class="free">ε</span> <span class="main">*</span> card <span class="free">Y</span><span class="main">)</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="main">¦</span>edge_density <span class="free">A</span> <span class="free">B</span> <span class="free">G</span> <span class="main">-</span> edge_density <span class="free">X</span> <span class="free">Y</span> <span class="free">G</span><span class="main">¦</span> <span class="main">&gt;</span> <span class="free">ε</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_le regular_pair_def<span class="main">)</span>

<span class="keyword1" id="Szemeredi-irregular_pair_I"><span class="command">lemma</span></span> irregular_pair_I<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ε</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊂</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊂</span> <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>card <span class="free">A</span> <span class="main">≥</span> <span class="free">ε</span> <span class="main">*</span> card <span class="free">X</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>card <span class="free">B</span> <span class="main">≥</span> <span class="free">ε</span> <span class="main">*</span> card <span class="free">Y</span><span class="main">)</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="main">¦</span>edge_density <span class="free">A</span> <span class="free">B</span> <span class="free">G</span> <span class="main">-</span> edge_density <span class="free">X</span> <span class="free">Y</span> <span class="free">G</span><span class="main">¦</span> <span class="main">&gt;</span> <span class="free">ε</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"irregular_pair <span class="free">X</span> <span class="free">Y</span> <span class="free">G</span> <span class="free">ε</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_le regular_pair_def<span class="main">)</span>

<span class="keyword1" id="Szemeredi-edge_density_Un"><span class="command">lemma</span></span> edge_density_Un<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"disjnt <span class="free">X1</span> <span class="free">X2</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X1</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X2</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"edge_density <span class="main">(</span><span class="free">X1</span> <span class="main">∪</span> <span class="free">X2</span><span class="main">)</span> <span class="free">Y</span> <span class="free">G</span> <span class="main">=</span> <span class="main">(</span>edge_density <span class="free">X1</span> <span class="free">Y</span> <span class="free">G</span> <span class="main">*</span> card <span class="free">X1</span> <span class="main">+</span> edge_density <span class="free">X2</span> <span class="free">Y</span> <span class="free">G</span> <span class="main">*</span> card <span class="free">X2</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>card <span class="free">X1</span> <span class="main">+</span> card <span class="free">X2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> edge_density_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_edges_between_disjnt1 all_edges_between_Un1 finite_all_edges_between card_Un_disjnt <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Szemeredi-edge_density_partition"><span class="command">lemma</span></span> edge_density_partition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> U<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_graph_partition <span class="free">U</span> <span class="free">P</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">W</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"edge_density <span class="free">U</span> <span class="free">W</span> <span class="free">G</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> edge_density <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="free">W</span> <span class="free">G</span> <span class="main">*</span> card <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> card <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> U
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">U</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edge_density_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fin_n<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_graph_partition <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> partition_on_def finite_graph_partition_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjoint_family_on_disjoint_image disjoint_family_on_insert lessThan_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> finU<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P</span> <span class="main">`</span> <span class="main">{..&lt;</span>Suc <span class="skolem">n</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems finite_graph_partition_def partition_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> card_UP<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> card <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_finite_graph_partition finite_UN finite_lessThan lessI lessThan_iff less_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> eq0_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> card <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> card <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> finite_lessThan lessThan_iff sum_eq_0_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> fin_P<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">P</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems finite_graph_partition_finite that <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"edge_density <span class="skolem">U</span> <span class="free">W</span> <span class="free">G</span> <span class="main">=</span> edge_density <span class="main">(</span><span class="free">P</span> <span class="skolem">n</span> <span class="main">∪</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">P</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free">W</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lessThan_Suc <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> finite_graph_partition_equals <span class="main"><span class="main">[</span></span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>edge_density <span class="main">(</span><span class="free">P</span> <span class="skolem">n</span><span class="main">)</span> <span class="free">W</span> <span class="free">G</span> <span class="main">*</span> card <span class="main">(</span><span class="free">P</span> <span class="skolem">n</span><span class="main">)</span> 
                <span class="main">+</span> edge_density <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free">W</span> <span class="free">G</span> <span class="main">*</span> card <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>card <span class="main">(</span><span class="free">P</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> edge_density_Un<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"disjnt <span class="main">(</span><span class="free">P</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> disjnt_def disjoint_family_on_insert finite_graph_partition_def lessThan_Suc lessThan_iff less_irrefl_nat<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">P</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.prems finite_graph_partition_finite lessI <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> <span class="quoted"><span class="quoted">‹finite <span class="free">W</span>›</span></span> finU <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>edge_density <span class="main">(</span><span class="free">P</span> <span class="skolem">n</span><span class="main">)</span> <span class="free">W</span> <span class="free">G</span> <span class="main">*</span> card <span class="main">(</span><span class="free">P</span> <span class="skolem">n</span><span class="main">)</span> 
                <span class="main">+</span> edge_density <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free">W</span> <span class="free">G</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> card <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span>Suc <span class="skolem">n</span><span class="main">.</span> card <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_UP<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span>Suc <span class="skolem">n</span><span class="main">.</span> edge_density <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="free">W</span> <span class="free">G</span> <span class="main">*</span> card <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span>Suc <span class="skolem">n</span><span class="main">.</span> card <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc.IH <span class="main"><span class="main">[</span></span><span class="operator">OF</span> fin_n<span class="main"><span class="main">]</span></span> fin_P eq0_iff <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> of_nat_sum<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Let <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> be partitions of a set of vertices <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">V</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. 
  Then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> refines <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if for all <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">‹<span class="free"><span class="free">A</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">P</span></span>›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> there is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">‹<span class="free"><span class="free">B</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">Q</span></span>›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
  such that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">‹<span class="free"><span class="free">A</span></span> <span class="main"><span class="main">⊆</span></span> <span class="free"><span class="free">B</span></span>›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finite_graph_refines</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>uvert set<span class="main">,</span> nat <span class="main">⇒</span> uvert set<span class="main">,</span> nat<span class="main">,</span> nat <span class="main">⇒</span> uvert set<span class="main">,</span> nat<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">finite_graph_refines</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span>
        finite_graph_partition <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> finite_graph_partition <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">i</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">j</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For the sake of generality, and following Zhao's Online Lecture 
<span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">🌐</span></span>‹https://www.youtube.com/watch?v=vcsxCFSLyP8&amp;t=16s›</span></span>
we do not impose disjointness: we do not include <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">i</span></span><span class="main"><span class="main">≠</span></span><span class="free"><span class="free">j</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> below.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">irregular_set</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>real<span class="main">,</span> ugraph<span class="main">,</span> nat <span class="main">⇒</span> uvert set<span class="main">,</span> nat<span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span>nat<span class="main">×</span>nat<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">irregular_set</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">ε</span><span class="main">::</span>real<span class="main">.</span> <span class="main">λ</span><span class="bound">G</span> <span class="bound">P</span> <span class="bound">k</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">|</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="bound">k</span> <span class="main">∧</span> <span class="bound">j</span><span class="main">&lt;</span><span class="bound">k</span> <span class="main">∧</span> irregular_pair <span class="main">(</span><span class="bound">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="bound">P</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">G</span> <span class="bound">ε</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A regular partition may contain a few irregular pairs as long as their total size is bounded as follows.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">regular_partition</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>real<span class="main">,</span> ugraph<span class="main">,</span> nat <span class="main">⇒</span> uvert set<span class="main">,</span> nat<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">regular_partition</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">ε</span><span class="main">::</span>real<span class="main">.</span> <span class="main">λ</span><span class="bound">G</span> <span class="bound">P</span> <span class="bound">k</span><span class="main">.</span> 
     finite_graph_partition <span class="main">(</span>uverts <span class="bound">G</span><span class="main">)</span> <span class="bound">P</span> <span class="bound">k</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> irregular_set <span class="bound">ε</span> <span class="bound">G</span> <span class="bound">P</span> <span class="bound">k</span><span class="main">.</span> card <span class="main">(</span><span class="bound">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span><span class="bound">P</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">ε</span> <span class="main">*</span> <span class="main">(</span>card <span class="main">(</span>uverts <span class="bound">G</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>

<span class="keyword1" id="Szemeredi-irregular_set_subset"><span class="command">lemma</span></span> irregular_set_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"irregular_set <span class="free">ε</span> <span class="free">G</span> <span class="free">P</span> <span class="free">k</span> <span class="main">⊆</span> <span class="main">{..&lt;</span><span class="free">k</span><span class="main">}</span> <span class="main">×</span> <span class="main">{..&lt;</span><span class="free">k</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> irregular_set_def<span class="main">)</span>

<span class="keyword1" id="Szemeredi-irregular_set_swap"><span class="command">lemma</span></span> irregular_set_swap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">∈</span> irregular_set <span class="free">ε</span> <span class="free">G</span> <span class="free">P</span> <span class="free">k</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">∈</span> irregular_set <span class="free">ε</span> <span class="free">G</span> <span class="free">P</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> irregular_set_def regular_pair_commute<span class="main">)</span>

<span class="keyword1" id="Szemeredi-finite_graph_refines_refines"><span class="command">lemma</span></span> finite_graph_refines_refines<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite_graph_refines <span class="free">V</span> <span class="free">Y</span> <span class="free">n</span> <span class="free">X</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"refines <span class="free">V</span> <span class="main">(</span><span class="free">Y</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_graph_refines_def refines_def finite_graph_partition_def<span class="main">)</span>

<span class="keyword1" id="Szemeredi-finite_irregular_set"><span class="command">lemma</span></span> finite_irregular_set <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>irregular_set <span class="free">ε</span> <span class="free">G</span> <span class="free">P</span> <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"irregular_set <span class="free">ε</span> <span class="free">G</span> <span class="free">P</span> <span class="free">k</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> irregular_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Energy of a Graph›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Definition 3.7 (Energy), written <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">q</span></span><span class="main"><span class="main">(</span></span><span class="free"><span class="free">𝒰</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">𝒲</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">energy_graph_subsets</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>uvert set<span class="main">,</span> uvert set<span class="main">,</span> ugraph<span class="main">]</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">energy_graph_subsets</span> <span class="free"><span class="bound"><span class="entity">𝒰</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒲</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span>
     card <span class="free"><span class="bound"><span class="entity">𝒰</span></span></span> <span class="main">*</span> card <span class="free"><span class="bound"><span class="entity">𝒲</span></span></span> <span class="main">*</span> <span class="main">(</span>edge_density <span class="free"><span class="bound"><span class="entity">𝒰</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒲</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="main">(</span>card <span class="main">(</span>uverts <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Definition for partitions›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">energy_graph_partitions_subsets</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>ugraph<span class="main">,</span> nat <span class="main">⇒</span> uvert set<span class="main">,</span> nat<span class="main">,</span> nat <span class="main">⇒</span> uvert set<span class="main">,</span> nat<span class="main">]</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">energy_graph_partitions_subsets</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">W</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> 
           <span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">.</span><span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">.</span> energy_graph_subsets <span class="main">(</span><span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">W</span></span></span> <span class="bound">j</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span>"</span></span>

<span class="keyword1" id="Szemeredi-energy_graph_subsets_ge0"><span class="command">lemma</span></span> energy_graph_subsets_ge0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"energy_graph_subsets <span class="free">𝒰</span> <span class="free">𝒲</span> <span class="free">G</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> energy_graph_subsets_def<span class="main">)</span>

<span class="keyword1" id="Szemeredi-energy_graph_partitions_subsets_ge0"><span class="command">lemma</span></span> energy_graph_partitions_subsets_ge0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"energy_graph_partitions_subsets <span class="free">G</span> <span class="free">U</span> <span class="free">k</span> <span class="free">W</span> <span class="free">l</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_nonneg energy_graph_partitions_subsets_def<span class="main">)</span>

<span class="keyword1" id="Szemeredi-energy_graph_subsets_commute"><span class="command">lemma</span></span> energy_graph_subsets_commute<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"energy_graph_subsets <span class="free">𝒰</span> <span class="free">𝒲</span> <span class="free">G</span> <span class="main">=</span> energy_graph_subsets <span class="free">𝒲</span> <span class="free">𝒰</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> energy_graph_subsets_def edge_density_commute<span class="main">)</span>

<span class="keyword1" id="Szemeredi-energy_graph_partitions_subsets_commute"><span class="command">lemma</span></span> energy_graph_partitions_subsets_commute<span class="main">:</span>
  <span class="quoted"><span class="quoted">"energy_graph_partitions_subsets <span class="free">G</span> <span class="free">W</span> <span class="free">l</span> <span class="free">U</span> <span class="free">k</span> <span class="main">=</span> energy_graph_partitions_subsets <span class="free">G</span> <span class="free">U</span> <span class="free">k</span> <span class="free">W</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> energy_graph_partitions_subsets_def energy_graph_subsets_commute sum.swap <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span><span class="free">l</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Definition 3.7 (Energy of a Partition), or following Gowers, mean square density:
 a version of energy for a single partition of the vertex set. ›</span></span> 

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">mean_square_density</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>ugraph<span class="main">,</span> nat <span class="main">⇒</span> uvert set<span class="main">,</span> nat<span class="main">]</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mean_square_density</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≡</span> energy_graph_partitions_subsets <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>

<span class="keyword1" id="Szemeredi-mean_square_density"><span class="command">lemma</span></span> mean_square_density<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"mean_square_density <span class="free">G</span> <span class="free">U</span> <span class="free">k</span> <span class="main">≡</span> 
          <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> card <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span><span class="free">U</span> <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>edge_density <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">U</span> <span class="bound">j</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>
        <span class="main">/</span> <span class="main">(</span>card <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> energy_graph_partitions_subsets_def energy_graph_subsets_def sum_divide_distrib<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Observation: the energy is between 0 and 1 because the edge density is bounded above by 1.›</span></span>

<span class="keyword1" id="Szemeredi-sum_partition_le"><span class="command">lemma</span></span> sum_partition_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite_graph_partition <span class="free">V</span> <span class="free">P</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">V</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> real <span class="main">(</span>card <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span><span class="free">P</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>real<span class="main">(</span>card <span class="free">V</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">V</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">∩</span> <span class="free">P</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">P</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_graph_partition_equals <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">P</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">≤</span><span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems finite_graph_partition_finite that <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">P</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> card <span class="skolem">V</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">≤</span><span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems finite_graph_partition_le le_imp_less_Suc that <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">have</span></span> D <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span><span class="skolem">k</span><span class="main">.</span> real <span class="main">(</span>card <span class="main">(</span><span class="free">P</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> real <span class="main">(</span>card <span class="skolem">V</span><span class="main">)</span> <span class="main">-</span> real <span class="main">(</span>card <span class="main">(</span><span class="free">P</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> card_finite_graph_partition <span class="main"><span class="main">[</span></span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"disjnt <span class="main">(</span><span class="free">P</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">k</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> disjnt_def disjoint_family_on_insert finite_graph_partition_def lessThan_Suc lessThan_iff less_irrefl_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">k</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span><span class="skolem">k</span><span class="main">.</span> real <span class="main">(</span>card <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span><span class="free">P</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">≤</span> <span class="main">(</span>real <span class="main">(</span>card <span class="main">(</span><span class="skolem">V</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_graph_partition_def lessThan_Suc partition_on_insert disjoint_family_on_insert comm_monoid_add_class.sum.distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span>Suc <span class="skolem">k</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span>Suc <span class="skolem">k</span><span class="main">.</span> real <span class="main">(</span>card <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span><span class="free">P</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">=</span> real <span class="main">(</span>card <span class="main">(</span><span class="free">P</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span><span class="free">P</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>card <span class="skolem">V</span> <span class="main">-</span> card <span class="main">(</span><span class="free">P</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span><span class="free">P</span> <span class="skolem">k</span><span class="main">)</span>
        <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">k</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span><span class="skolem">k</span><span class="main">.</span> real <span class="main">(</span>card <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span><span class="free">P</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> C of_nat_diff sum.distrib <span class="dynamic"><span class="dynamic">algebra_simps</span></span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> sum_distrib_right<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> real <span class="main">(</span>card <span class="main">(</span><span class="free">P</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span><span class="free">P</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
        <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>card <span class="skolem">V</span> <span class="main">-</span> card <span class="main">(</span><span class="free">P</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span><span class="free">P</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>real <span class="main">(</span>card <span class="main">(</span><span class="skolem">V</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span>real <span class="main">(</span>card <span class="skolem">V</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_nat_diff C card_Diff_subset_Int <span class="dynamic"><span class="dynamic">algebra_simps</span></span> power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Szemeredi-mean_square_density_bounded"><span class="command">lemma</span></span> mean_square_density_bounded<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite_graph_partition <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span> <span class="free">P</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mean_square_density <span class="free">G</span> <span class="free">P</span> <span class="free">k</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> §<span class="main">:</span> <span class="quoted"><span class="quoted">"edge_density <span class="main">(</span><span class="free">P</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">G</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">using</span></span> assms of_nat_mono <span class="main">[</span><span class="operator">OF</span> max_all_edges_between<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> card.infinite divide_eq_0_iff edge_density_def edge_density_le1 mult_eq_0_iff of_nat_0<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> real <span class="main">(</span>card <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span><span class="free">P</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>edge_density <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="bound">j</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> 
     <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> real <span class="main">(</span>card <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span><span class="free">P</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono mult_right_le_one_le<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> abs_square_le_1 edge_density_ge0 §<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span>real<span class="main">(</span>card <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_partition_le <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mean_square_density <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Partitioning and Energy›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Zhao's Lemma 3.8 and Gowers's remark after Lemma 11. 
 Further partitioning of subsets of the vertex set cannot make the energy decrease. 
 We follow Gowers's proof, which avoids the use of probability.›</span></span>

<span class="keyword1" id="Szemeredi-energy_graph_partition_half"><span class="command">lemma</span></span> energy_graph_partition_half<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">𝒰</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">𝒲</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> U<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_graph_partition <span class="free">𝒰</span> <span class="free">U</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="free">𝒰</span> <span class="main">*</span> <span class="main">(</span>edge_density <span class="free">𝒰</span> <span class="free">𝒲</span> <span class="free">G</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> card <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>edge_density <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="free">𝒲</span> <span class="free">G</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="free">𝒰</span> <span class="main">*</span> <span class="main">(</span>edge_density <span class="free">𝒰</span> <span class="free">𝒲</span> <span class="free">G</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> card <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>edge_density <span class="free">𝒰</span> <span class="free">𝒲</span> <span class="free">G</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹finite <span class="free">𝒰</span>›</span></span> U sum_distrib_right card_finite_graph_partition of_nat_sum<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> edge_density <span class="free">𝒰</span> <span class="free">𝒲</span> <span class="free">G</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> edge_density <span class="free">𝒰</span> <span class="free">𝒲</span> <span class="free">G</span> <span class="main">*</span> card <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left power2_eq_square mult_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> edge_density <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="free">𝒲</span> <span class="free">G</span> <span class="main">*</span> real <span class="main">(</span>card <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> edge_density <span class="free">𝒰</span> <span class="free">𝒲</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"edge_density <span class="free">𝒰</span> <span class="free">𝒲</span> <span class="free">G</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> edge_density <span class="main">(</span><span class="free">U</span> <span class="bound">n</span><span class="main">)</span> <span class="free">𝒲</span> <span class="free">G</span> <span class="main">*</span> card <span class="main">(</span><span class="free">U</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> 
        <span class="main">=</span> edge_density <span class="free">𝒰</span> <span class="free">𝒲</span> <span class="free">G</span> <span class="main">*</span> <span class="main">(</span>edge_density <span class="free">𝒰</span> <span class="free">𝒲</span> <span class="free">G</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> card <span class="main">(</span><span class="free">U</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edge_density_partition <span class="main"><span class="main">[</span></span><span class="operator">OF</span> U fin<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute sum_distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> card <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> edge_density <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="free">𝒲</span> <span class="free">G</span><span class="main">)</span> <span class="main">*</span> edge_density <span class="free">𝒰</span> <span class="free">𝒲</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left mult_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> card <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> edge_density <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="free">𝒲</span> <span class="free">G</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> card <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> edge_density_partition <span class="main">[</span><span class="operator">OF</span> U fin<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_ac <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> card <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>edge_density <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="free">𝒲</span> <span class="free">G</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_ac <span class="dynamic"><span class="dynamic">divide_simps</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> of_nat_sum<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_products_le<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">proposition</span></span> energy_graph_partition_increase<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">𝒰</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">𝒲</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> U<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_graph_partition <span class="free">𝒰</span> <span class="free">U</span> <span class="free">k</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_graph_partition <span class="free">𝒲</span> <span class="free">W</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"energy_graph_partitions_subsets <span class="free">G</span> <span class="free">U</span> <span class="free">k</span> <span class="free">W</span> <span class="free">l</span> <span class="main">≥</span> energy_graph_subsets <span class="free">𝒰</span> <span class="free">𝒲</span> <span class="free">G</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>card <span class="free">𝒰</span> <span class="main">*</span> card <span class="free">𝒲</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>edge_density <span class="free">𝒰</span> <span class="free">𝒲</span> <span class="free">G</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> card <span class="free">𝒲</span> <span class="main">*</span> <span class="main">(</span>card <span class="free">𝒰</span> <span class="main">*</span> <span class="main">(</span>edge_density <span class="free">𝒰</span> <span class="free">𝒲</span> <span class="free">G</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fin <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> card <span class="free">𝒲</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> card <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>edge_density <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="free">𝒲</span> <span class="free">G</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_left_mono energy_graph_partition_half fin<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> card <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>card <span class="free">𝒲</span> <span class="main">*</span> <span class="main">(</span>edge_density <span class="free">𝒲</span> <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left edge_density_commute mult_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> card <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span><span class="free">l</span><span class="main">.</span> card <span class="main">(</span><span class="free">W</span> <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>edge_density <span class="main">(</span><span class="free">W</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> mult_left_mono energy_graph_partition_half sum_mono fin<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">U</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{..&lt;</span><span class="free">k</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">using</span></span> that U fin finite_graph_partition_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span><span class="free">l</span><span class="main">.</span> <span class="main">(</span>card <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span><span class="free">W</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>edge_density <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">W</span> <span class="bound">j</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left edge_density_commute mult_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>card <span class="free">𝒰</span> <span class="main">*</span> card <span class="free">𝒲</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>edge_density <span class="free">𝒰</span> <span class="free">𝒲</span> <span class="free">G</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> 
    <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span><span class="free">l</span><span class="main">.</span> <span class="main">(</span>card <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span><span class="free">W</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>edge_density <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">W</span> <span class="bound">j</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> energy_graph_partitions_subsets_def energy_graph_subsets_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> sum_divide_distrib<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Szemeredi-partition_imp_finite_graph_partition"><span class="command">lemma</span></span> partition_imp_finite_graph_partition<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>partition_on <span class="free">A</span> <span class="free">P</span><span class="main">;</span> finite <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> finite_graph_partition <span class="free">A</span> <span class="main">(</span>from_nat_into <span class="free">P</span><span class="main">)</span> <span class="main">(</span>card <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bij_betw_def bij_betw_from_nat_into_finite finite_graph_partition_eq<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following is the fully general version of Gowers's Lemma 11 and Zhao's Lemma 3.9. 
Further partitioning of subsets of the vertex set cannot make the energy decrease.
Note that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">V</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> should be <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"uverts <span class="free"><span class="free">G</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> even though this more general version holds.›</span></span>

<span class="keyword1" id="Szemeredi-energy_graph_partitions_subsets_increase_half"><span class="command">lemma</span></span> energy_graph_partitions_subsets_increase_half<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ref<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_graph_refines <span class="free">V</span> <span class="free">Y</span> <span class="free">n</span> <span class="free">X</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">V</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> finU<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">⟹</span> card <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"energy_graph_partitions_subsets <span class="free">G</span> <span class="free">X</span> <span class="free">m</span> <span class="free">U</span> <span class="free">k</span> <span class="main">≤</span> energy_graph_partitions_subsets <span class="free">G</span> <span class="free">Y</span> <span class="free">n</span> <span class="free">U</span> <span class="free">k</span>"</span></span> 
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">≤</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">F</span><span class="main">.</span> partition_on <span class="main">(</span><span class="free">X</span> <span class="skolem">i</span><span class="main">)</span> <span class="bound">F</span> <span class="main">∧</span> <span class="bound">F</span> <span class="main">=</span> <span class="free">Y</span> <span class="main">`</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span><span class="main">&lt;</span><span class="free">n</span> <span class="main">∧</span> <span class="free">Y</span> <span class="bound">j</span> <span class="main">⊆</span> <span class="free">X</span> <span class="skolem">i</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> that refines_obtains_subset <span class="main">[</span><span class="operator">OF</span> finite_graph_refines_refines <span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">m</span> <span class="main">⟹</span> partition_on <span class="main">(</span><span class="free">X</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">F</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">F</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">Y</span> <span class="main">`</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span><span class="main">&lt;</span><span class="free">n</span> <span class="main">∧</span> <span class="free">Y</span> <span class="bound">j</span> <span class="main">⊆</span> <span class="free">X</span> <span class="bound">i</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> finite_X<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">X</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">V</span>›</span></span> finite_graph_partition_finite finite_graph_refines_def ref that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> finite_F<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">F</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> F<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Fi_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="skolem">i</span> <span class="main">=</span> from_nat_into <span class="main">(</span><span class="skolem">F</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..&lt;</span>card <span class="main">(</span><span class="skolem">F</span> <span class="skolem">i</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bij_betw_def bij_betw_from_nat_into_finite finite_F that<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> F_disjoint<span class="main">:</span> <span class="quoted"><span class="quoted">"disjoint_family_on <span class="skolem">F</span> <span class="main">{..&lt;</span><span class="free">m</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ref <span class="keyword1"><span class="command">unfolding</span></span> finite_graph_refines_def finite_graph_partition_def disjoint_family_on_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">)</span></span> F Int_subset_iff Union_upper disjoint_iff lessThan_iff partition_on_def subset_empty<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> F_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> that ref F <span class="keyword1"><span class="command">unfolding</span></span> finite_graph_refines_def partition_on_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sup_empty finite_graph_partition_nonempty<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> injF<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="skolem">F</span> <span class="main">{..&lt;</span><span class="free">m</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> disjoint_family_on_iff_disjoint_image F_disjoint F_ne lessThan_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> injY<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">Y</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_graph_partition_eq finite_graph_refines_def ref<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">have</span></span> F_sums_Y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> <span class="main">∑</span><span class="bound">U</span><span class="main">∈</span><span class="skolem">F</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">U</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span><span class="free">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set <span class="main">⇒</span> real"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> Yn_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> <span class="skolem">F</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ref <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_graph_refines_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> F<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">{</span><span class="free">Y</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> injY <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span><span class="free">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sum <span class="skolem">f</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> <span class="skolem">F</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Yn_eq injY sum.reindex_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>sum <span class="main">∘</span> sum<span class="main">)</span> <span class="skolem">f</span> <span class="main">(</span><span class="skolem">F</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> F_disjoint finite_F 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjoint_family_on_disjoint_image sum.Union_disjoint_sets<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> <span class="main">∑</span><span class="bound">U</span><span class="main">∈</span><span class="skolem">F</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">U</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> comp_apply <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> injF sum.reindex_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> energy_graph_subsets <span class="main">(</span><span class="free">X</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">U</span> <span class="bound">j</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> energy_graph_partitions_subsets_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> energy_graph_partitions_subsets <span class="free">G</span> <span class="main">(</span>from_nat_into <span class="main">(</span><span class="skolem">F</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>card <span class="main">(</span><span class="skolem">F</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">U</span> <span class="bound">j</span><span class="main">)</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite_graph_partition <span class="main">(</span><span class="free">X</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>from_nat_into <span class="main">(</span><span class="skolem">F</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>card <span class="main">(</span><span class="skolem">F</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
      <span class="keyword1"><span class="command">using</span></span> partition_imp_finite_graph_partition that F <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite_graph_partition <span class="main">(</span><span class="free">U</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">U</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card.empty finU less_not_refl trivial_graph_partition_exists<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono energy_graph_partition_increase<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finU card_ge_0_finite finite_X<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> <span class="main">∑</span><span class="bound">r</span><span class="main">&lt;</span>card <span class="main">(</span><span class="skolem">F</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> energy_graph_subsets <span class="main">(</span>from_nat_into <span class="main">(</span><span class="skolem">F</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">U</span> <span class="bound">j</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> energy_graph_partitions_subsets_def sum.swap <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span><span class="free">k</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> <span class="main">∑</span><span class="bound">v</span><span class="main">∈</span><span class="skolem">F</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> energy_graph_subsets <span class="bound">v</span> <span class="main">(</span><span class="free">U</span> <span class="bound">j</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong sum.card_from_nat_into refl<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> energy_graph_partitions_subsets_def F_sums_Y<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">proposition</span></span> energy_graph_partitions_subsets_increase<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> refX<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_graph_refines <span class="free">V</span> <span class="free">Y</span> <span class="free">n</span> <span class="free">X</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> refU<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_graph_refines <span class="free">V'</span> <span class="free">W</span> <span class="free">l</span> <span class="free">U</span> <span class="free">k</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">V'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"energy_graph_partitions_subsets <span class="free">G</span> <span class="free">X</span> <span class="free">m</span> <span class="free">U</span> <span class="free">k</span> <span class="main">≤</span> energy_graph_partitions_subsets <span class="free">G</span> <span class="free">Y</span> <span class="free">n</span> <span class="free">W</span> <span class="free">l</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">≤</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> finU<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">⟹</span> card <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> finY<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> card <span class="main">(</span><span class="free">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_graph_partition_gt0 finite_graph_refines_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">≤</span> energy_graph_partitions_subsets <span class="free">G</span> <span class="free">Y</span> <span class="free">n</span> <span class="free">U</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms energy_graph_partitions_subsets_increase_half finU refX <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> energy_graph_partitions_subsets <span class="free">G</span> <span class="free">U</span> <span class="free">k</span> <span class="free">Y</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> energy_graph_partitions_subsets_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> energy_graph_partitions_subsets <span class="free">G</span> <span class="free">W</span> <span class="free">l</span> <span class="free">Y</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms energy_graph_partitions_subsets_increase_half finY refU <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> energy_graph_partitions_subsets_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The original version of Gowers's Lemma 11 and Zhao's Lemma 3.9 
      is not general enough to be used for anything.›</span></span>
<span class="keyword1"><span class="command">corollary</span></span> mean_square_density_increase<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite_graph_refines <span class="free">V</span> <span class="free">Y</span> <span class="free">n</span> <span class="free">X</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mean_square_density <span class="free">G</span> <span class="free">X</span> <span class="free">m</span> <span class="main">≤</span> mean_square_density <span class="free">G</span> <span class="free">Y</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms energy_graph_partitions_subsets_increase <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span> 


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The Energy Boost Lemma (Lemma 3.10 in Zhao's notes) says that an 
irregular partition increases the energy substantially. We assume that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">𝒰</span></span> <span class="main"><span class="main">⊆</span></span> uverts <span class="free"><span class="free">G</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">𝒲</span></span> <span class="main"><span class="main">⊆</span></span> uverts <span class="free"><span class="free">G</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are not irregular, as witnessed by their subsets <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">U1</span></span> <span class="main"><span class="main">⊆</span></span> <span class="free"><span class="free">𝒰</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">W1</span></span> <span class="main"><span class="main">⊆</span></span> <span class="free"><span class="free">𝒲</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
The proof follows Lemma 12 of Gowers. ›</span></span>

<span class="keyword1"><span class="command">proposition</span></span> energy_boost<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ε</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝒰</span> <span class="free">𝒲</span> <span class="free">G</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">alpha</span> <span class="main">≡</span> edge_density <span class="free">𝒰</span> <span class="free">𝒲</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> edge_density <span class="bound">X</span> <span class="bound">Y</span> <span class="free">G</span> <span class="main">-</span> <span class="free">alpha</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">𝒰</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">𝒲</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">U1</span> <span class="main">⊂</span> <span class="free">𝒰</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">W1</span> <span class="main">⊂</span> <span class="free">𝒲</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> U1<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">U1</span> <span class="main">≥</span> <span class="free">ε</span> <span class="main">*</span> card <span class="free">𝒰</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> W1<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">W1</span> <span class="main">≥</span> <span class="free">ε</span> <span class="main">*</span> card <span class="free">𝒲</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">u</span> <span class="free">U1</span> <span class="free">W1</span><span class="main">¦</span> <span class="main">&gt;</span> <span class="free">ε</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">A</span> <span class="main">∈</span> <span class="main">{</span><span class="free">U1</span><span class="main">,</span> <span class="free">𝒰</span> <span class="main">-</span> <span class="free">U1</span><span class="main">}</span><span class="main">.</span> <span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="main">{</span><span class="free">W1</span><span class="main">,</span> <span class="free">𝒲</span> <span class="main">-</span> <span class="free">W1</span><span class="main">}</span><span class="main">.</span> energy_graph_subsets <span class="bound">A</span> <span class="bound">B</span> <span class="free">G</span><span class="main">)</span>
         <span class="main">≥</span> energy_graph_subsets <span class="free">𝒰</span> <span class="free">𝒲</span> <span class="free">G</span> <span class="main">+</span> <span class="free">ε</span><span class="main">^</span><span class="numeral">4</span> <span class="main">*</span> <span class="main">(</span>card <span class="free">𝒰</span> <span class="main">*</span> card <span class="free">𝒲</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>card <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">≥</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">UF</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">UF</span> <span class="main">≡</span> <span class="main">{</span><span class="free">U1</span><span class="main">,</span> <span class="free">𝒰</span> <span class="main">-</span> <span class="free">U1</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">WF</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">WF</span> <span class="main">≡</span> <span class="main">{</span><span class="free">W1</span><span class="main">,</span> <span class="free">𝒲</span> <span class="main">-</span> <span class="free">W1</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">𝒰</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">𝒲</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">𝒰</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="free">𝒲</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">U1</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="free">W1</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">)</span></span> U1 W1 <span class="quoted"><span class="quoted">‹<span class="free">ε</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> of_nat_0_less_iff zero_less_mult_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">U1</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">W1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> card_ge_0_finite<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">UF</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span><span class="main">(</span>1<span class="main">)</span> UF_def assms that <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> 3 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">WF</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span><span class="main">(</span>2<span class="main">)</span> WF_def assms that <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> cardUW<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">𝒰</span> <span class="main">=</span> card <span class="free">U1</span> <span class="main">+</span> card<span class="main">(</span><span class="free">𝒰</span> <span class="main">-</span> <span class="free">U1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="free">𝒲</span> <span class="main">=</span> card <span class="free">W1</span> <span class="main">+</span> card<span class="main">(</span><span class="free">𝒲</span> <span class="main">-</span> <span class="free">W1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 0 1 <span class="quoted"><span class="quoted">‹<span class="free">U1</span> <span class="main">⊂</span> <span class="free">𝒰</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">W1</span> <span class="main">⊂</span> <span class="free">𝒲</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_eq_0_iff card_Diff_subset card_mono le_add_diff_inverse less_le<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> CU<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>all_edges_between <span class="free">𝒰</span> <span class="skolem">Z</span> <span class="free">G</span><span class="main">)</span> 
          <span class="main">=</span> card <span class="main">(</span>all_edges_between <span class="main">(</span><span class="free">𝒰</span> <span class="main">-</span> <span class="free">U1</span><span class="main">)</span> <span class="skolem">Z</span> <span class="free">G</span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span>all_edges_between <span class="free">U1</span> <span class="skolem">Z</span> <span class="free">G</span><span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">Z</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">Z</span>
    <span class="keyword1"><span class="command">using</span></span> card_Un_disjnt all_edges_between_Un1 all_edges_between_disjnt1 <span class="quoted"><span class="quoted">‹<span class="free">U1</span> <span class="main">⊂</span> <span class="free">𝒰</span>›</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> DiffD2 Un_Diff_cancel2 <span class="quoted"><span class="quoted">‹finite <span class="free">U1</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">𝒰</span>›</span></span> disjnt_iff finite_Diff 
        finite_all_edges_between sup.strict_order_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> CW<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>all_edges_between <span class="skolem">Z</span> <span class="free">𝒲</span> <span class="free">G</span><span class="main">)</span> 
          <span class="main">=</span> card <span class="main">(</span>all_edges_between <span class="skolem">Z</span> <span class="main">(</span><span class="free">𝒲</span> <span class="main">-</span> <span class="free">W1</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span>all_edges_between <span class="skolem">Z</span> <span class="free">W1</span> <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">Z</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">Z</span>
    <span class="keyword1"><span class="command">using</span></span> card_Un_disjnt all_edges_between_Un2 all_edges_between_disjnt2 <span class="quoted"><span class="quoted">‹<span class="free">W1</span> <span class="main">⊂</span> <span class="free">𝒲</span>›</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> DiffD2 Un_Diff_cancel2 <span class="quoted"><span class="quoted">‹finite <span class="free">W1</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">𝒲</span>›</span></span> disjnt_iff finite_Diff 
        finite_all_edges_between sup.strict_order_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U1</span> <span class="main">≠</span> <span class="free">𝒰</span> <span class="main">-</span> <span class="free">U1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">W1</span> <span class="main">≠</span> <span class="free">𝒲</span> <span class="main">-</span> <span class="free">W1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">UF</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">∈</span><span class="skolem">WF</span><span class="main">.</span> real <span class="main">(</span>card <span class="main">(</span>all_edges_between <span class="bound">i</span> <span class="bound">j</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
         <span class="main">=</span> card <span class="main">(</span>all_edges_between <span class="free">𝒰</span> <span class="free">𝒲</span> <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> UF_def WF_def cardUW CU CW<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>card <span class="free">𝒰</span><span class="main">)</span> <span class="main">*</span> real <span class="main">(</span>card <span class="free">𝒲</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">UF</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">∈</span><span class="skolem">WF</span><span class="main">.</span> card <span class="bound">i</span> <span class="main">*</span> card <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> UF_def WF_def cardUW <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">UF</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">∈</span><span class="skolem">WF</span><span class="main">.</span> <span class="main">(</span>card <span class="bound">i</span> <span class="main">*</span> card <span class="bound">j</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>card <span class="free">𝒰</span> <span class="main">*</span> card <span class="free">𝒲</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>edge_density <span class="bound">i</span> <span class="bound">j</span> <span class="free">G</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> §<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">UF</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">∈</span><span class="skolem">WF</span><span class="main">.</span>
                 <span class="main">(</span>card <span class="bound">i</span> <span class="main">*</span> card <span class="bound">j</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>card <span class="free">𝒰</span> <span class="main">*</span> card <span class="free">𝒲</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>edge_density <span class="bound">i</span> <span class="bound">j</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span> 
         <span class="main">=</span> <span class="free">alpha</span> <span class="main">+</span> <span class="free">alpha</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">UF</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">∈</span><span class="skolem">WF</span><span class="main">.</span> <span class="main">(</span>card <span class="bound">i</span> <span class="main">*</span> card <span class="bound">j</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>card <span class="free">𝒰</span> <span class="main">*</span> card <span class="free">𝒲</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> alpha_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> * ** edge_density_def <span class="dynamic"><span class="dynamic">divide_simps</span></span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> sum_divide_distrib<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="main">*</span> <span class="free">ε</span> <span class="main">≤</span> <span class="free">u</span> <span class="free">U1</span> <span class="free">W1</span> <span class="main">*</span> <span class="free">u</span> <span class="free">U1</span> <span class="free">W1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> abs_ge_zero abs_mult_self_eq <span class="quoted"><span class="quoted">‹<span class="free">ε</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> gt less_le mult_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ε</span><span class="main">*</span><span class="free">ε</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">ε</span><span class="main">*</span><span class="free">ε</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>card <span class="free">U1</span> <span class="main">*</span> card <span class="free">W1</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>card <span class="free">𝒰</span> <span class="main">*</span> card <span class="free">𝒲</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="free">U1</span> <span class="free">W1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 0 mult_mono <span class="main">[</span><span class="operator">OF</span> U1 W1<span class="main">]</span>  <span class="quoted"><span class="quoted">‹<span class="free">ε</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> eval_nat_numeral<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> del_insts<span class="main"><span class="main">)</span></span> mult.assoc mult.commute mult_mono' of_nat_0_le_iff zero_le_mult_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">UF</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">∈</span><span class="skolem">WF</span><span class="main">.</span>  <span class="main">(</span>card <span class="bound">i</span> <span class="main">*</span> card <span class="bound">j</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>card <span class="free">𝒰</span> <span class="main">*</span> card <span class="free">𝒲</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> UF_def WF_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?S</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">alpha</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">UF</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">∈</span><span class="skolem">WF</span><span class="main">.</span> 
                         <span class="main">(</span>card <span class="bound">i</span> <span class="main">*</span> card <span class="bound">j</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>card <span class="free">𝒰</span> <span class="main">*</span> card <span class="free">𝒲</span><span class="main">)</span> <span class="main">*</span> edge_density <span class="bound">i</span> <span class="bound">j</span> <span class="free">G</span><span class="main">)</span>
                 <span class="main">+</span> <span class="free">alpha</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">UF</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">∈</span><span class="skolem">WF</span><span class="main">.</span> <span class="main">(</span>card <span class="bound">i</span> <span class="main">*</span> card <span class="bound">j</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>card <span class="free">𝒰</span> <span class="main">*</span> card <span class="free">𝒲</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> u_def power2_diff mult_ac ring_distribs <span class="dynamic"><span class="dynamic">divide_simps</span></span> 
          sum_distrib_left sum_distrib_right sum_subtractf sum.distrib <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> sum_divide_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?S</span> <span class="main">-</span> <span class="free">alpha</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> § <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">alpha</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="free">ε</span><span class="main">^</span><span class="numeral">4</span> <span class="main">≤</span> <span class="var">?S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_nat_numeral<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="main">(</span><span class="free">alpha</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="free">ε</span><span class="main">^</span><span class="numeral">4</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>card <span class="free">𝒰</span> <span class="main">*</span> card <span class="free">𝒲</span> <span class="main">/</span> <span class="main">(</span>card <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> alpha_def energy_graph_subsets_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs <span class="dynamic"><span class="dynamic">divide_simps</span></span> power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="var">?S</span> <span class="main">*</span> <span class="main">(</span>card <span class="free">𝒰</span> <span class="main">*</span> card <span class="free">𝒲</span> <span class="main">/</span> <span class="main">(</span>card <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_right_mono <span class="main"><span class="main">[</span></span><span class="operator">OF</span> 12<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?lhs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">unfolding</span></span> energy_graph_subsets_def UF_def WF_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Towards Zhao's Lemma 3.11›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Lemma 3.11 says that we can always find a refinement
that increases the energy by a certain amount.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A necessary lemma for the tower of exponentials in the result. Angeliki's proof›</span></span>
<span class="keyword1" id="Szemeredi-le_tower_2"><span class="command">lemma</span></span> le_tower_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> Suc <span class="free">k</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> kj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> Suc <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False j_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">3</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> kj False Suc_leI less_trans_Suc less_exp not_less numeral_3_eq_3<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> §<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="skolem">j</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">^</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kj<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">6</span> <span class="main">*</span> <span class="skolem">j</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kj<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">6</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> kj less.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="numeral">8</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="skolem">j</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_add<span class="main">)</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">^</span><span class="numeral">2</span><span class="main">^</span><span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> § <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def less_2_cases_iff power_increasing_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>      
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_Suc_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Zhao's actual Lemma 3.11. However, the bound $m \le k 2 ^{k+1}$  
comes from a different source by Zhao: ``Graph Theory and Additive Combinatorics'', <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">🌐</span></span>‹https://yufeizhao.com/gtac/gtac17.pdf›</span></span>.
Zhao's original version, and Gowers', both have incorrect bounds.›</span></span>
<span class="keyword1"><span class="command">proposition</span></span> exists_refinement<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite_graph_partition <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span> <span class="free">P</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> irreg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> regular_partition <span class="free">ε</span> <span class="free">G</span> <span class="free">P</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">Q</span> <span class="free">m</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"finite_graph_refines <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span> <span class="free">Q</span> <span class="free">m</span> <span class="free">P</span> <span class="free">k</span>"</span></span>                     
                    <span class="quoted"><span class="quoted">"mean_square_density <span class="free">G</span> <span class="free">Q</span> <span class="free">m</span> <span class="main">≥</span> mean_square_density <span class="free">G</span> <span class="free">P</span> <span class="free">k</span> <span class="main">+</span> <span class="free">ε</span><span class="main">^</span><span class="numeral">5</span>"</span></span> 
                    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span> <span class="main">⟹</span> card <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span><span class="main">&lt;</span><span class="free">m</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">j</span> <span class="main">⊆</span> <span class="free">P</span> <span class="bound">i</span><span class="main">}</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> Suc <span class="free">k</span>"</span></span>
                    <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> Suc <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sum_pp</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sum_pp</span> <span class="main">≡</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> irregular_set <span class="free">ε</span> <span class="free">G</span> <span class="free">P</span> <span class="free">k</span><span class="main">.</span> card <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span><span class="free">P</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> regular_partition_def irregular_set_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> G_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> card <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> finite_graph_partition_gt0 finite_graph_partition_le gr_zeroI leD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> part_GP<span class="main">:</span> <span class="quoted"><span class="quoted">"partition_on <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="free">k</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">P</span> <span class="main">{..&lt;</span><span class="free">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_graph_partition_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> disjfam_P<span class="main">:</span> <span class="quoted"><span class="quoted">"disjoint_family_on <span class="free">P</span> <span class="main">{..&lt;</span><span class="free">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_graph_partition_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> finP<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">P</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> assms that finite_graph_partition_finite finite_graph_partition_nonempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> spp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sum_pp</span> <span class="main">&gt;</span> <span class="free">ε</span> <span class="main">*</span> <span class="main">(</span>card <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_le regular_partition_def sum_pp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sum_irreg_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sum_pp</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ε</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> G_nonempty less_asym <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">X</span></span><span class="main">⊂</span><span class="free">P</span> <span class="skolem">i</span><span class="main">.</span>
         <span class="main">∃</span><span class="bound"><span class="bound">Y</span></span><span class="main">⊂</span><span class="free">P</span> <span class="skolem">j</span><span class="main">.</span>
            <span class="free">ε</span> <span class="main">*</span> card <span class="main">(</span><span class="free">P</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> card <span class="bound">X</span> <span class="main">∧</span>
            <span class="free">ε</span> <span class="main">*</span> card <span class="main">(</span><span class="free">P</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">≤</span> card <span class="bound">Y</span> <span class="main">∧</span>
            <span class="main">¦</span>edge_density <span class="bound">X</span> <span class="bound">Y</span> <span class="free">G</span> <span class="main">-</span> edge_density <span class="main">(</span><span class="free">P</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">G</span><span class="main">¦</span> <span class="main">&gt;</span> <span class="free">ε</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> irregular_set <span class="free">ε</span> <span class="free">G</span> <span class="free">P</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">using</span></span> that assms<span class="main">(</span>1<span class="main">)</span> finite_graph_partition_subset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> irregular_set_def regular_pair_def not_le<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X0</span></span> <span class="skolem"><span class="skolem">Y0</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> XY0_psub_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">⟦</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> irregular_set <span class="free">ε</span> <span class="free">G</span> <span class="free">P</span> <span class="free">k</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="skolem">X0</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">⊂</span> <span class="free">P</span> <span class="bound">i</span> <span class="main">∧</span> <span class="skolem">Y0</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">⊂</span> <span class="free">P</span> <span class="bound">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> XY0_eps<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">⟦</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> irregular_set <span class="free">ε</span> <span class="free">G</span> <span class="free">P</span> <span class="free">k</span><span class="main">⟧</span> 
        <span class="main">⟹</span> <span class="free">ε</span> <span class="main">*</span> card <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="skolem">X0</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span>
            <span class="free">ε</span> <span class="main">*</span> card <span class="main">(</span><span class="free">P</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="skolem">Y0</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span>
            <span class="main">¦</span>edge_density <span class="main">(</span><span class="skolem">X0</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Y0</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="free">G</span> <span class="main">-</span> edge_density <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="bound">j</span><span class="main">)</span> <span class="free">G</span><span class="main">¦</span> <span class="main">&gt;</span> <span class="free">ε</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">j</span><span class="main">&gt;</span><span class="bound">i</span> <span class="keyword1">then</span> <span class="skolem">Y0</span> <span class="bound">j</span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="skolem">X0</span> <span class="bound">i</span> <span class="bound">j</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">j</span><span class="main">&gt;</span><span class="bound">i</span> <span class="keyword1">then</span> <span class="skolem">X0</span> <span class="bound">j</span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="skolem">Y0</span> <span class="bound">i</span> <span class="bound">j</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> XY_psub_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">⟦</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> irregular_set <span class="free">ε</span> <span class="free">G</span> <span class="free">P</span> <span class="free">k</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="skolem">X</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">⊂</span> <span class="free">P</span> <span class="bound">i</span> <span class="main">∧</span> <span class="skolem">Y</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">⊂</span> <span class="free">P</span> <span class="bound">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> XY0_psub_P <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X_def Y_def irregular_set_swap<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> XY_eps<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">⟦</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> irregular_set <span class="free">ε</span> <span class="free">G</span> <span class="free">P</span> <span class="free">k</span><span class="main">⟧</span> 
        <span class="main">⟹</span> <span class="free">ε</span> <span class="main">*</span> card <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="skolem">X</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span>
            <span class="free">ε</span> <span class="main">*</span> card <span class="main">(</span><span class="free">P</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span>
            <span class="main">¦</span>edge_density <span class="main">(</span><span class="skolem">X</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="free">G</span> <span class="main">-</span> edge_density <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="bound">j</span><span class="main">)</span> <span class="free">G</span><span class="main">¦</span> <span class="main">&gt;</span> <span class="free">ε</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> XY0_eps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X_def Y_def edge_density_commute irregular_set_swap<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> cardP<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">P</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> assms finite_graph_partition_gt0 that <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

  <span class="keyword1"><span class="command">have</span></span> XY_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> irregular_set <span class="free">ε</span> <span class="free">G</span> <span class="free">P</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">using</span></span> XY_eps <span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span> that <span class="quoted"><span class="quoted">‹<span class="free">ε</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> cardP <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> cardP <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> irregular_set_def mult_le_0_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹By the assumption that our partition is irregular, there are many irregular pairs.
       For each irregular pair, find pairs of subsets that witness irregularity.›</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">XP</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">XP</span> <span class="skolem">i</span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">{</span><span class="skolem">X</span> <span class="skolem">i</span> <span class="bound">j</span><span class="main">,</span> <span class="free">P</span> <span class="skolem">i</span> <span class="main">-</span> <span class="skolem">X</span> <span class="skolem">i</span> <span class="bound">j</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> irregular_set <span class="free">ε</span> <span class="free">G</span> <span class="free">P</span> <span class="free">k</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">YP</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">YP</span> <span class="skolem">j</span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">{</span><span class="skolem">Y</span> <span class="bound">i</span> <span class="skolem">j</span><span class="main">,</span> <span class="free">P</span> <span class="skolem">j</span> <span class="main">-</span> <span class="skolem">Y</span> <span class="bound">i</span> <span class="skolem">j</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> irregular_set <span class="free">ε</span> <span class="free">G</span> <span class="free">P</span> <span class="free">k</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹include degenerate partition to ensure it works whether or not there's an irregular pair›</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">PP</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">PP</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> insert <span class="main">{</span><span class="free">P</span> <span class="bound">i</span><span class="main">}</span> <span class="main">(</span><span class="skolem">XP</span> <span class="bound">i</span> <span class="main">∪</span> <span class="skolem">YP</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> finPP<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">PP</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">unfolding</span></span> PP_def XP_def YP_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_inverse_image finite_irregular_set<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> inPP_fin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="skolem">PP</span> <span class="skolem">i</span> <span class="main">⟹</span> finite <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">P</span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> PP_def XP_def YP_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> fin_cf<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>common_refinement <span class="main">(</span><span class="skolem">PP</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finPP finite_common_refinement inPP_fin<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> part_cr<span class="main">:</span> <span class="quoted"><span class="quoted">"partition_on <span class="main">(</span><span class="free">P</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>common_refinement <span class="main">(</span><span class="skolem">PP</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> partition_on_common_refinement partition_onI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">𝒜</span><span class="main">.</span> <span class="bound">𝒜</span> <span class="main">∈</span> <span class="skolem">PP</span> <span class="skolem">i</span> <span class="main">⟹</span> <span class="main">{}</span> <span class="main">∉</span> <span class="bound">𝒜</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that XY_nonempty XY_psub_P finP<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PP_def XP_def YP_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> disjnt_iff PP_def XP_def YP_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> XY_psub_P<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">QS</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">QS</span> <span class="skolem">i</span> <span class="main">≡</span> from_nat_into <span class="main">(</span>common_refinement <span class="main">(</span><span class="skolem">PP</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="skolem">i</span> <span class="main">≡</span> card <span class="main">(</span>common_refinement <span class="main">(</span><span class="skolem">PP</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">have</span></span> to_nat_on_cr<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">i</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈</span> common_refinement <span class="main">(</span><span class="skolem">PP</span> <span class="bound">i</span><span class="main">)</span><span class="main">;</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">⟧</span>
           <span class="main">⟹</span> to_nat_on <span class="main">(</span>common_refinement <span class="main">(</span><span class="skolem">PP</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">r</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bij_betw_apply fin_cf lessThan_iff r_def to_nat_on_finite<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> QSr_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">QS</span> <span class="skolem">i</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">r</span> <span class="skolem">i</span><span class="main">}</span> <span class="main">=</span> common_refinement <span class="main">(</span><span class="skolem">PP</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> QS_def r_def fin_cf bij_betw_from_nat_into_finite bij_betw_imp_surj_on<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> inj_QS<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="skolem">QS</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="skolem">r</span> <span class="skolem">i</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> QSr_eq card_lessThan eq_card_imp_inj_on finite_lessThan r_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> part_P_QS<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_graph_partition <span class="main">(</span><span class="free">P</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">QS</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> QSr_eq that finite_graph_partition_eq inj_QS part_cr<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> QS_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">QS</span> <span class="skolem">i</span> <span class="skolem">q</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">&lt;</span> <span class="skolem">r</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">q</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> QSr_eq imageI lessThan_iff part_cr partition_on_def that<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> QS_subset_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">QS</span> <span class="skolem">i</span> <span class="skolem">q</span> <span class="main">⊆</span> <span class="free">P</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">&lt;</span> <span class="skolem">r</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">q</span>
    <span class="keyword1"><span class="command">using</span></span> part_cr <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> QSr_eq that
    <span class="keyword1"><span class="command">unfolding</span></span> partition_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> QS_inject<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">QS</span> <span class="skolem">i</span> <span class="skolem">q</span> <span class="main">=</span> <span class="skolem">QS</span> <span class="skolem">i'</span> <span class="skolem">q'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span><span class="main">&lt;</span><span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">&lt;</span> <span class="skolem">r</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">&lt;</span> <span class="skolem">r</span> <span class="skolem">i'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">i'</span> <span class="skolem">q</span> <span class="skolem">q'</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> QS_ne disjfam_P disjnt_def disjnt_iff disjnt_subset2 disjoint_family_on_def equals0I lessThan_iff that<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sumr</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sumr</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">r</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≡</span> <span class="skolem">sumr</span> <span class="free">k</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">d</span><span class="main">.</span> <span class="skolem">QS</span> <span class="main">(</span>part <span class="skolem">r</span> <span class="free">k</span> <span class="bound">d</span><span class="main">)</span> <span class="main">(</span><span class="bound">d</span> <span class="main">-</span> <span class="skolem">sumr</span> <span class="main">(</span>part <span class="skolem">r</span> <span class="free">k</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> QS_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">QS</span> <span class="skolem">j</span> <span class="skolem">q</span> <span class="main">=</span> <span class="skolem">Q</span> <span class="main">(</span><span class="skolem">sumr</span> <span class="skolem">j</span> <span class="main">+</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">&lt;</span><span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">&lt;</span> <span class="skolem">r</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="skolem">q</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Q_def part_eq sumr_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Qm_eq_QS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">m</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span>  <span class="main">(</span><span class="skolem">QS</span> <span class="bound">i</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">r</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⊆</span> <span class="var">?rhs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> QSr_eq r_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_subset_iff Ball_def Bex_def QS_def Q_def m_def<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sumr_def add.right_neutral card.empty from_nat_into leD part<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">⊆</span> <span class="var">?lhs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> QS_Q m_def sum_layers_less sumr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> Qm_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">m</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> common_refinement <span class="main">(</span><span class="skolem">PP</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> QSr_eq Qm_eq_QS <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> ref_QP<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_graph_refines <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">m</span> <span class="free">P</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> finite_graph_refines_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI strip<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite_graph_partition <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">m</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> finite_graph_partition_eq
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI partition_onI<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">m</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="main">⋃</span> <span class="main">(</span>common_refinement <span class="main">(</span><span class="skolem">PP</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Qm_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> uverts <span class="free">G</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> part_cr finite_graph_partition_equals assms<span class="main">(</span>1<span class="main">)</span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> partition_on_def<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">m</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> uverts <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"disjnt <span class="skolem">p</span> <span class="skolem">q</span>"</span></span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">Q</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">m</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="skolem">Q</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">m</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="skolem">q</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">from</span></span> that 
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">&lt;</span><span class="free">k</span>"</span></span> 
            <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> common_refinement <span class="main">(</span><span class="skolem">PP</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> common_refinement <span class="main">(</span><span class="skolem">PP</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Qm_eq<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">=</span><span class="skolem">j</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> part_cr <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> i j pairwise_def partition_on_def <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">q</span>›</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">⊆</span> <span class="free">P</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">q</span> <span class="main">⊆</span> <span class="free">P</span> <span class="skolem">j</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Union_upper <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> i j part_cr partition_onD1<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> False <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> part_GP disjfam_P
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> disjnt_Union1 disjnt_Union2 disjnt_def disjoint_family_on_def i j lessThan_iff part_cr partition_onD1<span class="main">)</span> 
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="skolem">Q</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">m</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Qm_eq common_refinement_def<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="skolem">Q</span> <span class="main">{..&lt;</span><span class="skolem">m</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> inj_QS QS_inject <span class="keyword1"><span class="command">unfolding</span></span> Q_def inj_on_def m_def sumr_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_add_diff_inverse lessThan_iff nat_add_left_cancel_less part<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"part <span class="skolem">r</span> <span class="free">k</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">&lt;</span> part <span class="skolem">r</span> <span class="free">k</span> <span class="skolem">i</span><span class="main">.</span> <span class="skolem">r</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">&lt;</span> part <span class="skolem">r</span> <span class="free">k</span> <span class="skolem">i</span><span class="main">.</span> <span class="skolem">r</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">r</span> <span class="main">(</span>part <span class="skolem">r</span> <span class="free">k</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">m</span>›</span></span> m_def part sumr_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">QS</span> <span class="main">(</span>part <span class="skolem">r</span> <span class="free">k</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> sum <span class="skolem">r</span> <span class="main">{..&lt;</span>part <span class="skolem">r</span> <span class="free">k</span> <span class="skolem">i</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">P</span> <span class="main">(</span>part <span class="skolem">r</span> <span class="free">k</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> QS_subset_P less_diff_conv2<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="skolem">Q</span> <span class="skolem">i</span> <span class="main">⊆</span> <span class="free">P</span> <span class="bound">j</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> Q_def sumr_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹part <span class="skolem">r</span> <span class="free">k</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> inj_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="skolem">Q</span> <span class="main">{..&lt;</span><span class="skolem">m</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_graph_partition_eq finite_graph_refines_def ref_QP <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?KK</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span><span class="free">k</span><span class="main">}</span> <span class="main">×</span> <span class="main">{..&lt;</span><span class="free">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?REG</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?KK</span> <span class="main">-</span> irregular_set <span class="free">ε</span> <span class="free">G</span> <span class="free">P</span> <span class="free">k</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sum_eps</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sum_eps</span> <span class="main">≡</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> irregular_set <span class="free">ε</span> <span class="free">G</span> <span class="free">P</span> <span class="free">k</span><span class="main">.</span> <span class="free">ε</span><span class="main">^</span><span class="numeral">4</span> <span class="main">*</span> <span class="main">(</span>card <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span><span class="free">P</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>card <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> irregular_set <span class="free">ε</span> <span class="free">G</span> <span class="free">P</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">&lt;</span><span class="free">k</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> irregular_set_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"energy_graph_subsets <span class="main">(</span><span class="free">P</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">G</span> <span class="main">+</span> <span class="free">ε</span><span class="main">^</span><span class="numeral">4</span> <span class="main">*</span> <span class="main">(</span>card <span class="main">(</span><span class="free">P</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span><span class="free">P</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>card <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>
         <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">A</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">X</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">,</span> <span class="free">P</span> <span class="skolem">i</span> <span class="main">-</span> <span class="skolem">X</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">}</span><span class="main">.</span> <span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">Y</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">,</span> <span class="free">P</span> <span class="skolem">j</span> <span class="main">-</span> <span class="skolem">Y</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">}</span><span class="main">.</span> energy_graph_subsets <span class="bound">A</span> <span class="bound">B</span> <span class="free">G</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> XY_psub_P <span class="main">[</span><span class="operator">OF</span> ij<span class="main">]</span> XY_eps <span class="main">[</span><span class="operator">OF</span> ij<span class="main">]</span> assms
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> energy_boost <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> finP <span class="quoted"><span class="quoted">‹<span class="free">ε</span><span class="main">&gt;</span><span class="main">0</span>›</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">&lt;</span><span class="numeral">2</span><span class="main">.</span> <span class="main">∑</span><span class="bound">b</span><span class="main">&lt;</span><span class="numeral">2</span><span class="main">.</span> energy_graph_subsets <span class="main">(</span>binary_partition <span class="main">(</span><span class="skolem">X</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">i</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span>binary_partition <span class="main">(</span><span class="skolem">Y</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">j</span><span class="main">)</span> <span class="bound">b</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.reindex inj_binary_partition finP <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> binary_partition2_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> energy_graph_partitions_subsets <span class="free">G</span> <span class="main">(</span>binary_partition <span class="main">(</span><span class="skolem">X</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="numeral">2</span> <span class="main">(</span>binary_partition <span class="main">(</span><span class="skolem">Y</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> energy_graph_partitions_subsets_def<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"energy_graph_subsets <span class="main">(</span><span class="free">P</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">G</span> <span class="main">+</span> <span class="free">ε</span><span class="main">^</span><span class="numeral">4</span> <span class="main">*</span> <span class="main">(</span>card <span class="main">(</span><span class="free">P</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span><span class="free">P</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>card <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>
                  <span class="main">≤</span> energy_graph_partitions_subsets <span class="free">G</span> <span class="main">(</span>binary_partition <span class="main">(</span><span class="skolem">X</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="numeral">2</span> <span class="main">(</span>binary_partition <span class="main">(</span><span class="skolem">Y</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> A <span class="main">=</span> this
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> irregular_set <span class="free">ε</span> <span class="free">G</span> <span class="free">P</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">&lt;</span><span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> irregular_set_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> XPX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">X</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">,</span> <span class="free">P</span> <span class="skolem">i</span> <span class="main">-</span> <span class="skolem">X</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">}</span> <span class="main">∈</span> <span class="skolem">PP</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ij <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PP_def XP_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_graph_partition <span class="main">(</span><span class="free">P</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">QS</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> QSr_eq <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> finite_graph_partition_eq inj_QS part_cr<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">q</span></span><span class="main">&lt;</span><span class="skolem">r</span> <span class="skolem">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">b</span></span><span class="main">&lt;</span><span class="numeral">2</span><span class="main">.</span> <span class="skolem">QS</span> <span class="skolem">i</span> <span class="bound">q</span> <span class="main">⊆</span> binary_partition <span class="main">(</span><span class="skolem">X</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">i</span><span class="main">)</span> <span class="bound">b</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> common_refinement_exists <span class="main">[</span><span class="operator">OF</span> _ XPX<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> QS_def r_def numeral_2_eq_2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> from_nat_into<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> ref_XP<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_graph_refines <span class="main">(</span><span class="free">P</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">QS</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>binary_partition <span class="main">(</span><span class="skolem">X</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> finite_graph_refines_def
        <span class="keyword1"><span class="command">using</span></span> XY_nonempty<span class="main">(</span>1<span class="main">)</span> XY_psub_P finite_graph_partition_binary_partition ij <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword1"><span class="command">have</span></span> YPY<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">Y</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">,</span> <span class="free">P</span> <span class="skolem">j</span> <span class="main">-</span> <span class="skolem">Y</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">}</span> <span class="main">∈</span> <span class="skolem">PP</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ij <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PP_def YP_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_graph_partition <span class="main">(</span><span class="free">P</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">QS</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> QSr_eq <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> finite_graph_partition_eq inj_QS part_cr<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">q</span></span><span class="main">&lt;</span><span class="skolem">r</span> <span class="skolem">j</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">b</span></span><span class="main">&lt;</span><span class="numeral">2</span><span class="main">.</span> <span class="skolem">QS</span> <span class="skolem">j</span> <span class="bound">q</span> <span class="main">⊆</span> binary_partition <span class="main">(</span><span class="skolem">Y</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">j</span><span class="main">)</span> <span class="bound">b</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> common_refinement_exists <span class="main">[</span><span class="operator">OF</span> _ YPY<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> QS_def r_def numeral_2_eq_2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> from_nat_into<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> ref_YP<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_graph_refines <span class="main">(</span><span class="free">P</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">QS</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>binary_partition <span class="main">(</span><span class="skolem">Y</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> finite_graph_refines_def
        <span class="keyword1"><span class="command">using</span></span> XY_nonempty<span class="main">(</span>2<span class="main">)</span> XY_psub_P finite_graph_partition_binary_partition ij <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"energy_graph_partitions_subsets <span class="free">G</span> <span class="main">(</span>binary_partition <span class="main">(</span><span class="skolem">X</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="numeral">2</span> <span class="main">(</span>binary_partition <span class="main">(</span><span class="skolem">Y</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="numeral">2</span>
          <span class="main">≤</span> energy_graph_partitions_subsets <span class="free">G</span> <span class="main">(</span><span class="skolem">QS</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">QS</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finP energy_graph_partitions_subsets_increase <span class="main"><span class="main">[</span></span><span class="operator">OF</span> ref_XP ref_YP<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> B <span class="main">=</span> this 
    <span class="keyword1"><span class="command">have</span></span> df_QS<span class="main">:</span> <span class="quoted"><span class="quoted">"disjoint_family_on <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">QS</span> <span class="bound">i</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">r</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="free">k</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> disjoint_family_on_def <span class="keyword1"><span class="command">using</span></span> QS_inject <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mean_square_density <span class="free">G</span> <span class="free">P</span> <span class="free">k</span> <span class="main">+</span> <span class="free">ε</span><span class="main">^</span><span class="numeral">5</span> <span class="main">≤</span> mean_square_density <span class="free">G</span> <span class="free">P</span> <span class="free">k</span> <span class="main">+</span> <span class="skolem">sum_eps</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ε</span><span class="main">^</span><span class="numeral">5</span> <span class="main">=</span> <span class="main">(</span><span class="free">ε</span> <span class="main">*</span> <span class="main">(</span>card <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">ε</span><span class="main">^</span><span class="numeral">4</span> <span class="main">/</span> <span class="main">(</span>card <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> G_nonempty <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> eval_nat_numeral<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="skolem">sum_pp</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">sum_eps</span> <span class="main">/</span> <span class="skolem">sum_pp</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mult_mono<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ε</span><span class="main">^</span><span class="numeral">4</span> <span class="main">/</span> real <span class="main">(</span><span class="main">(</span>card <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">sum_eps</span> <span class="main">/</span> <span class="skolem">sum_pp</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> sum_irreg_pos sum_eps_def sum_pp_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold sum.neutral <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> sum_distrib_left sum_divide_distrib of_nat_sum of_nat_mult<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> spp sum_nonneg <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="skolem">sum_eps</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_irreg_pos<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">∈</span><span class="var">?REG</span><span class="main">.</span> energy_graph_subsets <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="bound">j</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span> 
                   <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">∈</span>irregular_set <span class="free">ε</span> <span class="free">G</span> <span class="free">P</span> <span class="free">k</span><span class="main">.</span> energy_graph_subsets <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="bound">j</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">sum_eps</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> energy_graph_partitions_subsets_def sum.cartesian_product irregular_set_subset sum.subset_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?REG</span><span class="main">.</span> energy_graph_subsets <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="bound">j</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span>
                   <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> irregular_set <span class="free">ε</span> <span class="free">G</span> <span class="free">P</span> <span class="free">k</span><span class="main">.</span> energy_graph_partitions_subsets <span class="free">G</span> <span class="main">(</span>binary_partition <span class="main">(</span><span class="skolem">X</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="numeral">2</span> <span class="main">(</span>binary_partition <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">unfolding</span></span> sum_eps_def case_prod_unfold
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum_mono <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> energy_graph_partitions_subsets_def sum.distrib<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?REG</span><span class="main">.</span> energy_graph_partitions_subsets <span class="free">G</span> <span class="main">(</span><span class="skolem">QS</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">QS</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>
                   <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> irregular_set <span class="free">ε</span> <span class="free">G</span> <span class="free">P</span> <span class="free">k</span><span class="main">.</span> energy_graph_partitions_subsets <span class="free">G</span> <span class="main">(</span>binary_partition <span class="main">(</span><span class="skolem">X</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="numeral">2</span> <span class="main">(</span>binary_partition <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> part_P_QS finP <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_mono energy_graph_partition_increase<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?REG</span><span class="main">.</span> energy_graph_partitions_subsets <span class="free">G</span> <span class="main">(</span><span class="skolem">QS</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">QS</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> 
                  <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> irregular_set <span class="free">ε</span> <span class="free">G</span> <span class="free">P</span> <span class="free">k</span><span class="main">.</span> energy_graph_partitions_subsets <span class="free">G</span> <span class="main">(</span><span class="skolem">QS</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">QS</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono add_mono ordered_comm_monoid_add_class.sum_mono2<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?KK</span><span class="main">.</span> energy_graph_partitions_subsets <span class="free">G</span> <span class="main">(</span><span class="skolem">QS</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">QS</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> finite_SigmaI finite_lessThan irregular_set_subset sum.subset_diff<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> energy_graph_partitions_subsets <span class="free">G</span> <span class="main">(</span><span class="skolem">QS</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">QS</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> sum.cartesian_product<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">A</span> <span class="main">∈</span> <span class="skolem">Q</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">m</span><span class="main">}</span><span class="main">.</span> <span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="skolem">Q</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">m</span><span class="main">}</span><span class="main">.</span> energy_graph_subsets <span class="bound">A</span> <span class="bound">B</span> <span class="free">G</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Qm_eq_QS sum.UNION_disjoint_family df_QS energy_graph_partitions_subsets_def 
          inj_QS sum.reindex  sum.swap <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span><span class="free">k</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span><span class="skolem">r</span> <span class="main">_</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">m</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span><span class="skolem">m</span><span class="main">.</span> energy_graph_subsets <span class="main">(</span><span class="skolem">Q</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Q</span> <span class="bound">j</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_Q sum.reindex<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> mean_square_density <span class="free">G</span> <span class="skolem">Q</span> <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mean_square_density energy_graph_subsets_def sum_divide_distrib<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mean_square_density <span class="free">G</span> <span class="free">P</span> <span class="free">k</span> <span class="main">+</span> <span class="free">ε</span> <span class="main">^</span> <span class="numeral">5</span> <span class="main">≤</span> mean_square_density <span class="free">G</span> <span class="skolem">Q</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?QinP</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="skolem">m</span> <span class="main">∧</span> <span class="skolem">Q</span> <span class="bound">j</span> <span class="main">⊆</span> <span class="free">P</span> <span class="bound">i</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> card_QP<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?QinP</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> Suc <span class="free">k</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> card_cr<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>common_refinement <span class="main">(</span><span class="skolem">PP</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> Suc <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>common_refinement <span class="main">(</span><span class="skolem">PP</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> prod card <span class="main">(</span><span class="skolem">PP</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_common_refinement finPP inPP_fin<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> prod card <span class="main">(</span><span class="skolem">XP</span> <span class="skolem">i</span> <span class="main">∪</span> <span class="skolem">YP</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> PP_def
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> prod.insert<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> XYP_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">𝒜</span><span class="main">.</span> <span class="bound">𝒜</span> <span class="main">∈</span> <span class="skolem">XP</span> <span class="bound">i</span> <span class="main">∪</span> <span class="skolem">YP</span> <span class="bound">i</span> <span class="main">⟹</span> card <span class="bound">𝒜</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> XP_def YP_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> Diff_iff XY_psub_P card_2_iff psubset_imp_ex_mem<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">P</span> <span class="skolem">i</span><span class="main">}</span> <span class="main">∉</span> <span class="skolem">XP</span> <span class="skolem">i</span> <span class="main">∪</span> <span class="skolem">YP</span> <span class="skolem">i</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> PP_def finPP <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> Suc <span class="free">k</span>"</span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> prod_le_power<span class="main">)</span>
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">XS</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">XS</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> <span class="main">{</span><span class="skolem">X0</span> <span class="skolem">i</span> <span class="bound">l</span><span class="main">,</span> <span class="free">P</span> <span class="skolem">i</span> <span class="main">-</span> <span class="skolem">X0</span> <span class="skolem">i</span> <span class="bound">l</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..</span><span class="skolem">i</span><span class="main">}</span>"</span></span>
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">YS</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">YS</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> <span class="main">{</span><span class="skolem">Y0</span> <span class="bound">l</span> <span class="skolem">i</span><span class="main">,</span> <span class="free">P</span> <span class="skolem">i</span> <span class="main">-</span> <span class="skolem">Y0</span> <span class="bound">l</span> <span class="skolem">i</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">i</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">XS</span> <span class="main">≤</span> Suc <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">YS</span> <span class="main">≤</span> <span class="free">k</span><span class="main">-</span><span class="skolem">i</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> XS_def YS_def <span class="keyword1"><span class="command">using</span></span> card_image_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command">with</span></span> that <span class="keyword1"><span class="command">have</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="skolem">XS</span> <span class="main">+</span> card <span class="skolem">YS</span> <span class="main">≤</span> Suc <span class="free">k</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
          <span class="keyword1"><span class="command">have</span></span> finXYS<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">XS</span> <span class="main">∪</span> <span class="skolem">YS</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> XS_def YS_def<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">XP</span> <span class="skolem">i</span> <span class="main">∪</span> <span class="skolem">YP</span> <span class="skolem">i</span> <span class="main">⊆</span> <span class="skolem">XS</span> <span class="main">∪</span> <span class="skolem">YS</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> XP_def YP_def X_def Y_def XS_def YS_def irregular_set_def<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="skolem">XP</span> <span class="skolem">i</span> <span class="main">∪</span> <span class="skolem">YP</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> card <span class="skolem">XS</span> <span class="main">+</span> card <span class="skolem">YS</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> card_Un_le card_mono finXYS order_trans<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="skolem">XP</span> <span class="skolem">i</span> <span class="main">∪</span> <span class="skolem">YP</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> Suc <span class="free">k</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> k' le_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">XP</span> <span class="skolem">i</span> <span class="main">∪</span> <span class="skolem">YP</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> card <span class="skolem">x</span> <span class="main">∧</span> card <span class="skolem">x</span> <span class="main">≤</span> <span class="numeral">2</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> XP_def YP_def card_insert_le_m1<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">QS</span> <span class="skolem">i'</span> <span class="skolem">q</span> <span class="main">⊆</span> <span class="free">P</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span><span class="main">&lt;</span><span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">&lt;</span> <span class="skolem">r</span> <span class="skolem">i'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i'</span> <span class="skolem">q</span>
        <span class="keyword1"><span class="command">using</span></span> disjfam_P <span class="keyword1"><span class="command">unfolding</span></span> disjoint_family_on_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> QS_ne QS_subset_P <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> inf.bounded_iff lessThan_iff subset_empty that<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?QinP</span> <span class="skolem">i</span> <span class="main">⊆</span> <span class="main">{</span><span class="skolem">sumr</span> <span class="skolem">i</span><span class="main">..&lt;</span> <span class="skolem">sumr</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Q_def sumr_def m_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> add_less_cancel_left le_add_diff_inverse part<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?QinP</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">{</span><span class="skolem">sumr</span> <span class="skolem">i</span><span class="main">..&lt;</span> <span class="skolem">sumr</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> card_mono finite_atLeastLessThan<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> Suc <span class="free">k</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> card_cr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sumr_def r_def<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="skolem">m</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="var">?QinP</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> card_mono<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="skolem">m</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="var">?QinP</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ref_QP <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_graph_refines_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> card <span class="main">(</span><span class="var">?QinP</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> card_UN_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">^</span> Suc <span class="free">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> card_QP <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> lessThan_iff sum_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> Suc <span class="free">k</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Regularity Proof Itself›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Szemerédi's Regularity Lemma is Theorem 3.5 in Zhao's notes.›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We start with a trivial partition (one part). If it is already $\epsilon$-regular, we are done. If
not, we refine it by applying lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source]"exists_refinement"<span class="antiquote"><span class="antiquote">}</span></span></span></span> above, which increases the
energy. We can repeat this step, but it cannot increase forever: by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source]
mean_square_density_bounded<span class="antiquote"><span class="antiquote">}</span></span></span></span> it cannot exceed~1. This defines an algorithm that must stop
after at most $\epsilon^{-5}$ steps, resulting in an $\epsilon$-regular partition.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> Szemeredi_Regularity_Lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">M</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">G</span><span class="main">.</span> card <span class="main">(</span>uverts <span class="bound">G</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">P</span> <span class="bound">k</span><span class="main">.</span> regular_partition <span class="free">ε</span> <span class="bound">G</span> <span class="bound">P</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">G</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>uverts <span class="skolem">G</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> finG<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>uverts <span class="skolem">G</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"uverts <span class="skolem">G</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_gt_0_iff<span class="main">)</span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Φ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">Q</span> <span class="bound">m</span> <span class="bound">P</span> <span class="bound">k</span><span class="main">.</span> finite_graph_refines <span class="main">(</span>uverts <span class="skolem">G</span><span class="main">)</span> <span class="bound">Q</span> <span class="bound">m</span> <span class="bound">P</span> <span class="bound">k</span> <span class="main">∧</span> 
                                 mean_square_density <span class="skolem">G</span> <span class="bound">Q</span> <span class="bound">m</span> <span class="main">≥</span> mean_square_density <span class="skolem">G</span> <span class="bound">P</span> <span class="bound">k</span> <span class="main">+</span> <span class="free">ε</span><span class="main">^</span><span class="numeral">5</span> <span class="main">∧</span> 
                                 <span class="bound">m</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> Suc <span class="bound">k</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">nxt</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nxt</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">k</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> regular_partition <span class="free">ε</span> <span class="skolem">G</span> <span class="bound">P</span> <span class="bound">k</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">k</span><span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">SOME</span> <span class="main">(</span><span class="bound">Q</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span><span class="main">.</span> <span class="skolem">Φ</span> <span class="bound">Q</span> <span class="bound">m</span> <span class="bound">P</span> <span class="bound">k</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">iter</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">iter</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">nxt</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> uverts <span class="skolem">G</span><span class="main">,</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">last</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">last</span> <span class="main">≡</span> Suc <span class="main">(</span>nat<span class="main">⌈</span><span class="main">1</span> <span class="main">/</span> <span class="free">ε</span> <span class="main">^</span> <span class="numeral">5</span><span class="main">⌉</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> iter_Suc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">iter</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">nxt</span> <span class="main">(</span><span class="skolem">iter</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iter_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Φ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="skolem">Q</span> <span class="skolem">m</span> <span class="skolem">P</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> Pk<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_graph_partition <span class="main">(</span>uverts <span class="skolem">G</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> irreg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> regular_partition <span class="free">ε</span> <span class="skolem">G</span> <span class="skolem">P</span> <span class="skolem">k</span>"</span></span> 
       <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Q</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">nxt</span> <span class="main">(</span><span class="skolem">P</span><span class="main">,</span><span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">P</span> <span class="skolem">k</span> <span class="skolem">Q</span> <span class="skolem">m</span>
    <span class="keyword1"><span class="command">using</span></span> that exists_refinement <span class="main">[</span><span class="operator">OF</span> Pk finG irreg assms<span class="main">]</span> irreg
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nxt_def Φ_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prod_conv someI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> iter_finite_graph_partition<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">iter</span> <span class="skolem">i</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">k</span><span class="main">)</span> <span class="main">⇒</span> finite_graph_partition <span class="main">(</span>uverts <span class="skolem">G</span><span class="main">)</span> <span class="bound">P</span> <span class="bound">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iter_def nonempty trivial_graph_partition_exists<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Φ <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nxt_def Φ_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prodD finite_graph_refines_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword2"><span class="keyword">if</span></span> irreg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">≤</span><span class="skolem">last</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">iter</span> <span class="bound">i</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">k</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">¬</span> regular_partition <span class="free">ε</span> <span class="skolem">G</span> <span class="bound">P</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> Φ_loop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="skolem">Q</span> <span class="skolem">m</span> <span class="skolem">P</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nxt</span> <span class="main">(</span><span class="skolem">P</span><span class="main">,</span><span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Q</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">iter</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">P</span><span class="main">,</span><span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">≤</span><span class="skolem">last</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">Q</span> <span class="skolem">m</span> <span class="skolem">P</span> <span class="skolem">k</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Φ case_prod_conv irreg iter_finite_graph_partition that<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> iter_grow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="skolem">iter</span> <span class="skolem">i</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">Q</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">⇒</span> mean_square_density <span class="skolem">G</span> <span class="bound">Q</span> <span class="bound">m</span><span class="main">)</span> <span class="main">≥</span> <span class="skolem">i</span> <span class="main">*</span> <span class="free">ε</span><span class="main">^</span><span class="numeral">5</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">≤</span><span class="skolem">last</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> Φ_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split prod.split_asm <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Φ_loop<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> iter_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">last</span> <span class="main">*</span> <span class="free">ε</span><span class="main">^</span><span class="numeral">5</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">iter</span> <span class="skolem">last</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">Q</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">⇒</span> mean_square_density <span class="skolem">G</span> <span class="bound">Q</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iter_grow<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> finG case_prod_beta iter_finite_graph_partition mean_square_density_bounded<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="skolem">last</span> <span class="main">*</span> <span class="free">ε</span> <span class="main">^</span> <span class="numeral">5</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">unfolding</span></span> last_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> lessI natceiling_lessD not_less pos_divide_less_eq zero_less_power<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">last</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">iter</span> <span class="skolem">i</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">k</span><span class="main">)</span> <span class="main">⇒</span> regular_partition <span class="free">ε</span> <span class="skolem">G</span> <span class="bound">P</span> <span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> reglar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">iter</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">d</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">k</span><span class="main">)</span> <span class="main">⇒</span> regular_partition <span class="free">ε</span> <span class="skolem">G</span> <span class="bound">P</span> <span class="bound">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">d</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">d</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nxt_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split prod.split_asm<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tower</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tower</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span>power<span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">^^</span> <span class="bound">k</span><span class="main">)</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tower</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">tower</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tower_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> iter_tower<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="skolem">iter</span> <span class="skolem">i</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">Q</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">m</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">tower</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> iter_def tower_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> Qm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nxt</span> <span class="main">(</span><span class="skolem">P</span><span class="main">,</span><span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Q</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">iter</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">P</span><span class="main">,</span><span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> kle<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">tower</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> case_prod_conv surj_pair<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> Suc <span class="skolem">k</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> iter_finite_graph_partition <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> Φ 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> ccfv_SIG<span class="main"><span class="main">)</span></span> Suc_leD Φ_def case_prod_conv le_eq_less_or_eq mult_le_mono2 nxt_def 
                    power2_eq_square power2_nat_le_imp_le prod.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> self_le_ge2_pow<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">tower</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> One_nat_def le_tower_2 lessI numeral_2_eq_2 order.trans power_increasing_iff kle<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Qm<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P</span> <span class="bound">k</span><span class="main">.</span> regular_partition <span class="free">ε</span> <span class="skolem">G</span> <span class="bound">P</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> <span class="skolem">tower</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">last</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reglar <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">last</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> case_prod_beta nat_le_iff_add<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The actual value of the bound is visible above: a tower of exponentials of height $2(1 + \epsilon^{-5})$.›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>