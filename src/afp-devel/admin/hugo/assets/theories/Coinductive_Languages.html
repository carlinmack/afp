<div id="Coinductive_Language">
<div class="head">
<h1>Theory Coinductive_Language</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="comment1">(* Author: Dmitriy Traytel *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹A Codatatype of Formal Languages›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Coinductive_Language
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Inter
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Introduction›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We define formal languages as a codataype of infinite trees branching over the
alphabet <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Each node in such a tree indicates whether the path to this
node constitutes a word inside or outside of the language.

›</span></span>

<span class="keyword1"><span class="command">codatatype</span></span> <span class="tfree">'a</span> language <span class="main">=</span> Lang <span class="main">(</span><span class="free"><span class="entity">𝔬</span></span><span class="main">:</span> <span class="quoted">bool</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">𝔡</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> language"</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This codatatype is isormorphic to the set of lists representation of languages,
but caters for definitions by corecursion and proofs by coinduction.

Regular operations on languages are then defined by primitive corecursion.
A difficulty arises here, since the standard definitions of concatenation and
iteration from the coalgebraic literature are not primitively corecursive---they
require guardedness up-to union/concatenation. Without support for up-to corecursion,
these operation must be defined as a composition of primitive ones (and proved being
equal to the standard definitions). As an exercise in coinduction we also prove the
axioms of Kleene algebra for the defined regular operations.

Furthermore, a language for context-free grammars given by productions in Greibach
normal form and an initial nonterminal is constructed by primitive corecursion,
yielding an executable decision procedure for the word problem without further ado.
›</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="comment1">(* custom coinduction theorem (getting rid of rel_fun) *)</span>
<span class="keyword1"><span class="command">declare</span></span> language.coinduct_strong<span class="main">[</span><span class="operator">unfolded</span> rel_fun_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">case_names</span> Lang<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword">pred</span><span class="main">]</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Regular Languages›</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">Zero</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> language"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"𝔬 <span class="free">Zero</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"𝔡 <span class="free">Zero</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">Zero</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">One</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> language"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"𝔬 <span class="free">One</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"𝔡 <span class="free">One</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Zero<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">Atom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> language"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"𝔬 <span class="main">(</span><span class="free">Atom</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"𝔡 <span class="main">(</span><span class="free">Atom</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="bound">b</span> <span class="keyword1">then</span> One <span class="keyword1">else</span> Zero<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">Plus</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> language <span class="main">⇒</span> <span class="tfree">'a</span> language <span class="main">⇒</span> <span class="tfree">'a</span> language"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"𝔬 <span class="main">(</span><span class="free">Plus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>𝔬 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∨</span> 𝔬 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"𝔡 <span class="main">(</span><span class="free">Plus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">Plus</span> <span class="main">(</span>𝔡 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span>𝔡 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> Plus_ZeroL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Plus Zero <span class="free">r</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">theorem</span></span> Plus_ZeroR<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Plus <span class="free">r</span> Zero <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">theorem</span></span> Plus_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"Plus <span class="main">(</span>Plus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> Plus <span class="free">r</span> <span class="main">(</span>Plus <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> Plus_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"Plus <span class="free">r</span> <span class="free">s</span> <span class="main">=</span> Plus <span class="free">s</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-Plus_rotate"><span class="command">lemma</span></span> Plus_rotate<span class="main">:</span> <span class="quoted"><span class="quoted">"Plus <span class="free">r</span> <span class="main">(</span>Plus <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Plus <span class="free">s</span> <span class="main">(</span>Plus <span class="free">r</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Plus_assoc Plus_comm <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">theorem</span></span> Plus_idem<span class="main">:</span> <span class="quoted"><span class="quoted">"Plus <span class="free">r</span> <span class="free">r</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-Plus_idem_assoc"><span class="command">lemma</span></span> Plus_idem_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"Plus <span class="free">r</span> <span class="main">(</span>Plus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> Plus <span class="free">r</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Plus_assoc Plus_idem<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> Plus_ACI<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> Plus_rotate Plus_comm Plus_assoc Plus_idem_assoc Plus_idem

<span class="keyword1" id="Coinductive_Language-Plus_OneL"><span class="command">lemma</span></span> Plus_OneL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"𝔬 <span class="free">r</span> <span class="main">⟹</span> Plus One <span class="free">r</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-Plus_OneR"><span class="command">lemma</span></span> Plus_OneR<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"𝔬 <span class="free">r</span> <span class="main">⟹</span> Plus <span class="free">r</span> One <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Concatenation is not primitively corecursive---the corecursive call of its derivative is
  guarded by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Plus</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. However, it can be defined as a composition of two primitively
  corecursive functions.
›</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">TimesLR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> language <span class="main">⇒</span> <span class="tfree">'a</span> language <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> bool<span class="main">)</span> language"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"𝔬 <span class="main">(</span><span class="free">TimesLR</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>𝔬 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> 𝔬 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"𝔡 <span class="main">(</span><span class="free">TimesLR</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span>
   <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="free">TimesLR</span> <span class="main">(</span>𝔡 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">a</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">else</span> <span class="keyword1">if</span> 𝔬 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> <span class="free">TimesLR</span> <span class="main">(</span>𝔡 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">a</span><span class="main">)</span> One <span class="keyword1">else</span> Zero<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">Times_Plus</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> bool<span class="main">)</span> language <span class="main">⇒</span> <span class="tfree">'a</span> language"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"𝔬 <span class="main">(</span><span class="free">Times_Plus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> 𝔬 <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"𝔡 <span class="main">(</span><span class="free">Times_Plus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">Times_Plus</span> <span class="main">(</span>Plus <span class="main">(</span>𝔡 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> True<span class="main">)</span><span class="main">)</span> <span class="main">(</span>𝔡 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Coinductive_Language-TimesLR_ZeroL"><span class="command">lemma</span></span> TimesLR_ZeroL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"TimesLR Zero <span class="free">r</span> <span class="main">=</span> Zero"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-TimesLR_ZeroR"><span class="command">lemma</span></span> TimesLR_ZeroR<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"TimesLR <span class="free">r</span> Zero <span class="main">=</span> Zero"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted">Zero</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Coinductive_Language-TimesLR_PlusL"><span class="command">lemma</span></span> TimesLR_PlusL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"TimesLR <span class="main">(</span>Plus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> Plus <span class="main">(</span>TimesLR <span class="free">r</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>TimesLR <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-TimesLR_PlusR"><span class="command">lemma</span></span> TimesLR_PlusR<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"TimesLR <span class="free">r</span> <span class="main">(</span>Plus <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span>TimesLR <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>TimesLR <span class="free">r</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-Times_Plus_Zero"><span class="command">lemma</span></span> Times_Plus_Zero<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Times_Plus Zero <span class="main">=</span> Zero"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">coinduction</span> <span class="operator">simp</span>

<span class="keyword1" id="Coinductive_Language-Times_Plus_Plus"><span class="command">lemma</span></span> Times_Plus_Plus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Times_Plus <span class="main">(</span>Plus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span>Times_Plus <span class="free">r</span><span class="main">)</span> <span class="main">(</span>Times_Plus <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Lang <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Times_Plus.sel Plus.sel
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Plus_comm Plus_rotate<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coinductive_Language-Times_Plus_TimesLR_One"><span class="command">lemma</span></span> Times_Plus_TimesLR_One<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Times_Plus <span class="main">(</span>TimesLR <span class="free">r</span> One<span class="main">)</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Coinductive_Language-Times_Plus_TimesLR_PlusL"><span class="command">lemma</span></span> Times_Plus_TimesLR_PlusL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Times_Plus <span class="main">(</span>TimesLR <span class="main">(</span>Plus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span>Times_Plus <span class="main">(</span>TimesLR <span class="free">r</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Times_Plus <span class="main">(</span>TimesLR <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-Times_Plus_TimesLR_PlusR"><span class="command">lemma</span></span> Times_Plus_TimesLR_PlusR<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Times_Plus <span class="main">(</span>TimesLR <span class="free">r</span> <span class="main">(</span>Plus <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span>Times_Plus <span class="main">(</span>TimesLR <span class="free">r</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Times_Plus <span class="main">(</span>TimesLR <span class="free">r</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Times</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> language <span class="main">⇒</span> <span class="tfree">'a</span> language <span class="main">⇒</span> <span class="tfree">'a</span> language"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Times</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Times_Plus <span class="main">(</span>TimesLR <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Coinductive_Language-𝔬_Times"><span class="command">lemma</span></span> 𝔬_Times<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"𝔬 <span class="main">(</span>Times <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>𝔬 <span class="free">r</span> <span class="main">∧</span> 𝔬 <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Times_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Coinductive_Language-𝔡_Times"><span class="command">lemma</span></span> 𝔡_Times<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"𝔡 <span class="main">(</span>Times <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> 𝔬 <span class="free">r</span> <span class="keyword1">then</span> Plus <span class="main">(</span>Times <span class="main">(</span>𝔡 <span class="free">r</span> <span class="bound">a</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>𝔡 <span class="free">s</span> <span class="bound">a</span><span class="main">)</span> <span class="keyword1">else</span> Times <span class="main">(</span>𝔡 <span class="free">r</span> <span class="bound">a</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Times_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> Times_ZeroL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Times Zero <span class="free">r</span> <span class="main">=</span> Zero"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">coinduction</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">theorem</span></span> Times_ZeroR<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Times <span class="free">r</span> Zero <span class="main">=</span> Zero"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> Times_OneL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Times One <span class="free">r</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> language.coinduct_strong<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> Times_OneR<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Times <span class="free">r</span> One <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">simp</span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Coinduction up-to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Plus</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>--congruence relaxes the coinduction hypothesis by requiring
  membership in the congruence closure of the bisimulation rather than in the bisimulation itself.
›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">Plus_cong</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">R</span> <span class="keyword2"><span class="keyword">where</span></span>
  Refl<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟹</span> <span class="free">Plus_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="main">|</span> Base<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟹</span> <span class="free">Plus_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="main">|</span> Sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Plus_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟹</span> <span class="free">Plus_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> Trans<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Plus_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟹</span> <span class="free">Plus_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">⟹</span> <span class="free">Plus_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>"</span></span>
<span class="main">|</span> Plus<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">Plus_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span> <span class="free">Plus_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x'</span></span></span> <span class="free"><span class="bound"><span class="entity">y'</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Plus_cong</span> <span class="free">R</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">x'</span></span></span><span class="main">)</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">y'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Coinductive_Language-language_coinduct_upto_Plus"><span class="command">lemma</span></span> language_coinduct_upto_Plus<span class="main">[</span><span class="operator">unfolded</span> rel_fun_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">case_names</span> Lang<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">L</span> <span class="free">K</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hyp<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">L</span> <span class="bound">K</span><span class="main">.</span> <span class="free">R</span> <span class="bound">L</span> <span class="bound">K</span> <span class="main">⟹</span> 𝔬 <span class="bound">L</span> <span class="main">=</span> 𝔬 <span class="bound">K</span> <span class="main">∧</span> rel_fun <span class="main">(=)</span> <span class="main">(</span>Plus_cong <span class="free">R</span><span class="main">)</span> <span class="main">(</span>𝔡 <span class="bound">L</span><span class="main">)</span> <span class="main">(</span>𝔡 <span class="bound">K</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">=</span> <span class="free">K</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> language.coinduct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"Plus_cong <span class="free"><span class="free">R</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">L</span> <span class="skolem">K</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Plus_cong <span class="free">R</span> <span class="skolem">L</span> <span class="skolem">K</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"𝔬 <span class="skolem">L</span> <span class="main">=</span> 𝔬 <span class="skolem">K</span> <span class="main">∧</span> rel_fun <span class="main">(=)</span> <span class="main">(</span>Plus_cong <span class="free">R</span><span class="main">)</span> <span class="main">(</span>𝔡 <span class="skolem">L</span><span class="main">)</span> <span class="main">(</span>𝔡 <span class="skolem">K</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Plus_cong.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fun_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sym <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> hyp<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">intro</span> Base R<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> Times_PlusL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Times <span class="main">(</span>Plus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> Plus <span class="main">(</span>Times <span class="free">r</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>Times <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> language_coinduct_upto_Plus<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> Times_PlusR<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Times <span class="free">r</span> <span class="main">(</span>Plus <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span>Times <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>Times <span class="free">r</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> language_coinduct_upto_Plus<span class="main">)</span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">theorem</span></span> Times_assoc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Times <span class="main">(</span>Times <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> Times <span class="free">r</span> <span class="main">(</span>Times <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> language_coinduct_upto_Plus<span class="main">)</span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Similarly to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Times</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, iteration is not primitively corecursive (guardedness by
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Times</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is required). We apply a similar trick to obtain its definition.
›</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">StarLR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> language <span class="main">⇒</span> <span class="tfree">'a</span> language <span class="main">⇒</span> <span class="tfree">'a</span> language"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"𝔬 <span class="main">(</span><span class="free">StarLR</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> 𝔬 <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"𝔡 <span class="main">(</span><span class="free">StarLR</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">StarLR</span> <span class="main">(</span>𝔡 <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>Plus One <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Coinductive_Language-StarLR_Zero"><span class="command">lemma</span></span> StarLR_Zero<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"StarLR Zero <span class="free">r</span> <span class="main">=</span> Zero"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">coinduction</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-StarLR_Plus"><span class="command">lemma</span></span> StarLR_Plus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"StarLR <span class="main">(</span>Plus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> Plus <span class="main">(</span>StarLR <span class="free">r</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>StarLR <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> Plus_ACI Times_PlusR<span class="main">)</span>

<span class="keyword1" id="Coinductive_Language-StarLR_Times_Plus_One"><span class="command">lemma</span></span> StarLR_Times_Plus_One<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"StarLR <span class="main">(</span>Times <span class="free">r</span> <span class="main">(</span>Plus One <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> StarLR <span class="free">r</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Lang
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> Plus <span class="main">(</span>𝔡 <span class="skolem">r</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>Plus <span class="main">(</span>Times <span class="main">(</span>𝔡 <span class="skolem">r</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>𝔡 <span class="skolem">s</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> Times <span class="main">(</span>Plus <span class="main">(</span>𝔡 <span class="skolem">r</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>Plus <span class="main">(</span>Times <span class="main">(</span>𝔡 <span class="skolem">r</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>𝔡 <span class="skolem">s</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Plus <span class="skolem">L</span> <span class="main">(</span>Plus <span class="skolem">R</span> <span class="main">(</span>𝔡 <span class="skolem">s</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span>Plus <span class="skolem">L</span> <span class="main">(</span>𝔡 <span class="skolem">s</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Plus_assoc Plus_comm<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Plus <span class="skolem">L</span> <span class="main">(</span>𝔡 <span class="skolem">s</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">L</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> L_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Plus <span class="skolem">L</span> <span class="main">(</span>Plus <span class="skolem">R</span> <span class="main">(</span>𝔡 <span class="skolem">s</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Plus <span class="skolem">L</span> <span class="skolem">R</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> StarLR_Plus Plus_assoc Times_PlusL<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coinductive_Language-StarLR_Times"><span class="command">lemma</span></span> StarLR_Times<span class="main">:</span> <span class="quoted"><span class="quoted">"StarLR <span class="main">(</span>Times <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> Times <span class="free">r</span> <span class="main">(</span>StarLR <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> language_coinduct_upto_Plus<span class="main">)</span>
    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> Plus_ACI Times_PlusR<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Star</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> language <span class="main">⇒</span> <span class="tfree">'a</span> language"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Star</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> StarLR One <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1" id="Coinductive_Language-𝔬_Star"><span class="command">lemma</span></span> 𝔬_Star<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"𝔬 <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Star_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Coinductive_Language-𝔡_Star"><span class="command">lemma</span></span> 𝔡_Star<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"𝔡 <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> Times <span class="main">(</span>𝔡 <span class="free">r</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Star_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Star_def StarLR_Times<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Coinductive_Language-Star_Zero"><span class="command">lemma</span></span> Star_Zero<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Star Zero <span class="main">=</span> One"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">coinduction</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-Star_One"><span class="command">lemma</span></span> Star_One<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Star One <span class="main">=</span> One"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">coinduction</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-Star_unfoldL"><span class="command">lemma</span></span> Star_unfoldL<span class="main">:</span> <span class="quoted"><span class="quoted">"Star <span class="free">r</span> <span class="main">=</span> Plus One <span class="main">(</span>Times <span class="free">r</span> <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">coinduction</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">Inter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> language <span class="main">⇒</span> <span class="tfree">'a</span> language <span class="main">⇒</span> <span class="tfree">'a</span> language"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"𝔬 <span class="main">(</span><span class="free">Inter</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>𝔬 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> 𝔬 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"𝔡 <span class="main">(</span><span class="free">Inter</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">Inter</span> <span class="main">(</span>𝔡 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span>𝔡 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">Not</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> language <span class="main">⇒</span> <span class="tfree">'a</span> language"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"𝔬 <span class="main">(</span><span class="free">Not</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> 𝔬 <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"𝔡 <span class="main">(</span><span class="free">Not</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">Not</span> <span class="main">(</span>𝔡 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">Full</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> language"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">Σ<span class="hidden">⇧</span><sup>*</sup></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"𝔬 <span class="free">Full</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"𝔡 <span class="free">Full</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">Full</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Shuffle product is not primitively corecursive---the corecursive call of its derivative is
  guarded by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Plus</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. However, it can be defined as a composition of two primitively
  corecursive functions.
›</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">ShuffleLR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> language <span class="main">⇒</span> <span class="tfree">'a</span> language <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> bool<span class="main">)</span> language"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"𝔬 <span class="main">(</span><span class="free">ShuffleLR</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>𝔬 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> 𝔬 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"𝔡 <span class="main">(</span><span class="free">ShuffleLR</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="free">ShuffleLR</span> <span class="main">(</span>𝔡 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">a</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">else</span> <span class="free">ShuffleLR</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>𝔡 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Coinductive_Language-ShuffleLR_ZeroL"><span class="command">lemma</span></span> ShuffleLR_ZeroL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ShuffleLR Zero <span class="free">r</span> <span class="main">=</span> Zero"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-ShuffleLR_ZeroR"><span class="command">lemma</span></span> ShuffleLR_ZeroR<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ShuffleLR <span class="free">r</span> Zero <span class="main">=</span> Zero"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted">Zero</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Coinductive_Language-ShuffleLR_PlusL"><span class="command">lemma</span></span> ShuffleLR_PlusL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ShuffleLR <span class="main">(</span>Plus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> Plus <span class="main">(</span>ShuffleLR <span class="free">r</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>ShuffleLR <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-ShuffleLR_PlusR"><span class="command">lemma</span></span> ShuffleLR_PlusR<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ShuffleLR <span class="free">r</span> <span class="main">(</span>Plus <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span>ShuffleLR <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>ShuffleLR <span class="free">r</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-Shuffle_Plus_ShuffleLR_One"><span class="command">lemma</span></span> Shuffle_Plus_ShuffleLR_One<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Times_Plus <span class="main">(</span>ShuffleLR <span class="free">r</span> One<span class="main">)</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Coinductive_Language-Shuffle_Plus_ShuffleLR_PlusL"><span class="command">lemma</span></span> Shuffle_Plus_ShuffleLR_PlusL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Times_Plus <span class="main">(</span>ShuffleLR <span class="main">(</span>Plus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span>Times_Plus <span class="main">(</span>ShuffleLR <span class="free">r</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Times_Plus <span class="main">(</span>ShuffleLR <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-Shuffle_Plus_ShuffleLR_PlusR"><span class="command">lemma</span></span> Shuffle_Plus_ShuffleLR_PlusR<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Times_Plus <span class="main">(</span>ShuffleLR <span class="free">r</span> <span class="main">(</span>Plus <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span>Times_Plus <span class="main">(</span>ShuffleLR <span class="free">r</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Times_Plus <span class="main">(</span>ShuffleLR <span class="free">r</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Shuffle</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> language <span class="main">⇒</span> <span class="tfree">'a</span> language <span class="main">⇒</span> <span class="tfree">'a</span> language"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Shuffle</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Times_Plus <span class="main">(</span>ShuffleLR <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Coinductive_Language-𝔬_Shuffle"><span class="command">lemma</span></span> 𝔬_Shuffle<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"𝔬 <span class="main">(</span>Shuffle <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>𝔬 <span class="free">r</span> <span class="main">∧</span> 𝔬 <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Shuffle_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Coinductive_Language-𝔡_Shuffle"><span class="command">lemma</span></span> 𝔡_Shuffle<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"𝔡 <span class="main">(</span>Shuffle <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> Plus <span class="main">(</span>Shuffle <span class="main">(</span>𝔡 <span class="free">r</span> <span class="bound">a</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>Shuffle <span class="free">r</span> <span class="main">(</span>𝔡 <span class="free">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Shuffle_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> Shuffle_ZeroL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Shuffle Zero <span class="free">r</span> <span class="main">=</span> Zero"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> language_coinduct_upto_Plus<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 4<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> Shuffle_ZeroR<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Shuffle <span class="free">r</span> Zero <span class="main">=</span> Zero"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> language_coinduct_upto_Plus<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 4<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> Shuffle_OneL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Shuffle One <span class="free">r</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">theorem</span></span> Shuffle_OneR<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Shuffle <span class="free">r</span> One <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">theorem</span></span> Shuffle_PlusL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Shuffle <span class="main">(</span>Plus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> Plus <span class="main">(</span>Shuffle <span class="free">r</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>Shuffle <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> language_coinduct_upto_Plus<span class="main">)</span>
    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Plus<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> Base Base<span class="main"><span class="main"><span class="main">]</span></span></span> Refl<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> Shuffle_PlusR<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Shuffle <span class="free">r</span> <span class="main">(</span>Plus <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span>Shuffle <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>Shuffle <span class="free">r</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> language_coinduct_upto_Plus<span class="main">)</span>
    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Plus<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> Base Base<span class="main"><span class="main"><span class="main">]</span></span></span> Refl<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> Shuffle_assoc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Shuffle <span class="main">(</span>Shuffle <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> Shuffle <span class="free">r</span> <span class="main">(</span>Shuffle <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> language_coinduct_upto_Plus<span class="main">)</span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">theorem</span></span> Shuffle_comm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Shuffle <span class="free">r</span> <span class="free">s</span> <span class="main">=</span> Shuffle <span class="free">s</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> language_coinduct_upto_Plus<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Plus<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> Base Base<span class="main"><span class="main"><span class="main">]</span></span></span> Refl<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We generalize coinduction up-to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Plus</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to coinduction up-to all previously defined concepts.
›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">regular_cong</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">R</span> <span class="keyword2"><span class="keyword">where</span></span>
  Refl<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟹</span> <span class="free">regular_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="main">|</span> Sym<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">regular_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟹</span> <span class="free">regular_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> Trans<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">regular_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span> <span class="free">regular_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">regular_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>"</span></span>
<span class="main">|</span> Base<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟹</span> <span class="free">regular_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="main">|</span> Plus<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">regular_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span> <span class="free">regular_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x'</span></span></span> <span class="free"><span class="bound"><span class="entity">y'</span></span></span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free">regular_cong</span> <span class="free">R</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">x'</span></span></span><span class="main">)</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">y'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Times<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">regular_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span> <span class="free">regular_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x'</span></span></span> <span class="free"><span class="bound"><span class="entity">y'</span></span></span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free">regular_cong</span> <span class="free">R</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">x'</span></span></span><span class="main">)</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">y'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Star<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">regular_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free">regular_cong</span> <span class="free">R</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Inter<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">regular_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span> <span class="free">regular_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x'</span></span></span> <span class="free"><span class="bound"><span class="entity">y'</span></span></span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free">regular_cong</span> <span class="free">R</span> <span class="main">(</span>Inter <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">x'</span></span></span><span class="main">)</span> <span class="main">(</span>Inter <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">y'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Not<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">regular_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free">regular_cong</span> <span class="free">R</span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Shuffle<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">regular_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span> <span class="free">regular_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x'</span></span></span> <span class="free"><span class="bound"><span class="entity">y'</span></span></span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free">regular_cong</span> <span class="free">R</span> <span class="main">(</span>Shuffle <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">x'</span></span></span><span class="main">)</span> <span class="main">(</span>Shuffle <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">y'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Coinductive_Language-language_coinduct_upto_regular"><span class="command">lemma</span></span> language_coinduct_upto_regular<span class="main">[</span><span class="operator">unfolded</span> rel_fun_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">case_names</span> Lang<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">L</span> <span class="free">K</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hyp<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">L</span> <span class="bound">K</span><span class="main">.</span> <span class="free">R</span> <span class="bound">L</span> <span class="bound">K</span> <span class="main">⟹</span> 𝔬 <span class="bound">L</span> <span class="main">=</span> 𝔬 <span class="bound">K</span> <span class="main">∧</span> rel_fun <span class="main">(=)</span> <span class="main">(</span>regular_cong <span class="free">R</span><span class="main">)</span> <span class="main">(</span>𝔡 <span class="bound">L</span><span class="main">)</span> <span class="main">(</span>𝔡 <span class="bound">K</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">=</span> <span class="free">K</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> language.coinduct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"regular_cong <span class="free"><span class="free">R</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">L</span> <span class="skolem">K</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"regular_cong <span class="free">R</span> <span class="skolem">L</span> <span class="skolem">K</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"𝔬 <span class="skolem">L</span> <span class="main">=</span> 𝔬 <span class="skolem">K</span> <span class="main">∧</span> rel_fun <span class="main">(=)</span> <span class="main">(</span>regular_cong <span class="free">R</span><span class="main">)</span> <span class="main">(</span>𝔡 <span class="skolem">L</span><span class="main">)</span> <span class="main">(</span>𝔡 <span class="skolem">K</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> regular_cong.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> hyp <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fun_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">intro</span> Base R<span class="main">)</span>

<span class="keyword1" id="Coinductive_Language-Star_unfoldR"><span class="command">lemma</span></span> Star_unfoldR<span class="main">:</span> <span class="quoted"><span class="quoted">"Star <span class="free">r</span> <span class="main">=</span> Plus One <span class="main">(</span>Times <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> language_coinduct_upto_regular<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Lang
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Plus <span class="main">(</span>Times <span class="main">(</span>𝔡 <span class="skolem">r</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>Times <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>𝔡 <span class="skolem">r</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span>
      Times <span class="main">(</span>𝔡 <span class="skolem">r</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>Plus One <span class="main">(</span>Times <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> Times_PlusR<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coinductive_Language-Star_Star"><span class="command">lemma</span></span> Star_Star<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Star <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Star <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Star_unfoldL<span class="main"><span class="keyword3">,</span></span> <span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> language_coinduct_upto_regular<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-Times_Star"><span class="command">lemma</span></span> Times_Star<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Times <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span> <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Star <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> language_coinduct_upto_regular<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Lang
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> Plus <span class="main">(</span>Times <span class="bound">r</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">r</span> <span class="main">=</span> Times <span class="bound">r</span> <span class="main">(</span>Plus <span class="bound">s</span> One<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> Times_PlusR Plus_ACI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Times_PlusR<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> *<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> language <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>semiring_1<span class="main">,</span> order<span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Coinductive_Language-Zero_One"><span class="command">lemma</span></span> Zero_One<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Zero <span class="main">≠</span> One"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Zero.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">zero_language</span></span> <span class="main">=</span> Zero"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">one_language</span></span> <span class="main">=</span> One"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">plus_language</span></span> <span class="main">=</span> Plus"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">times_language</span></span> <span class="main">=</span> Times"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">less_eq_language</span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">less_language</span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> language_defs <span class="main">=</span> zero_language_def one_language_def plus_language_def times_language_def
  less_eq_language_def less_language_def

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">intro_classes</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> language"</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">z</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> language_defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Plus_assoc<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> language"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">+</span> <span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> language_defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Plus_assoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> language_defs<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Coinductive_Language-𝔬_mono"><span class="command">lemma</span></span> 𝔬_mono<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≤</span> <span class="free">s</span> <span class="main">⟹</span> 𝔬 <span class="free">r</span> <span class="main">⟹</span> 𝔬 <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_eq_language_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">𝔬</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Coinductive_Language-𝔡_mono"><span class="command">lemma</span></span> 𝔡_mono<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≤</span> <span class="free">s</span> <span class="main">⟹</span> 𝔡 <span class="free">r</span> <span class="free">a</span> <span class="main">≤</span> 𝔡 <span class="free">s</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_eq_language_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Plus.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  For reasoning about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(≤)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, we prove a coinduction principle and generalize it
  to support up-to reasoning.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> language_simulation_coinduction<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Lang<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">pred</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">L</span> <span class="free">K</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">L</span> <span class="bound">K</span><span class="main">.</span> <span class="free">R</span> <span class="bound">L</span> <span class="bound">K</span> <span class="main">⟹</span> 𝔬 <span class="bound">L</span> <span class="main">≤</span> 𝔬 <span class="bound">K</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span>𝔡 <span class="bound">L</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>𝔡 <span class="bound">K</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">≤</span> <span class="free">K</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="free">L</span> <span class="free">K</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> less_eq_language_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">L</span></span> <span class="quoted"><span class="free">K</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Coinductive_Language-le_PlusL"><span class="command">lemma</span></span> le_PlusL<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≤</span> Plus <span class="free">r</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-le_PlusR"><span class="command">lemma</span></span> le_PlusR<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≤</span> Plus <span class="free">r</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">Plus_Times_pre_cong</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">R</span> <span class="keyword2"><span class="keyword">where</span></span>
  pre_Less<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟹</span> <span class="free">Plus_Times_pre_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="main">|</span> pre_Trans<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">Plus_Times_pre_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span> <span class="free">Plus_Times_pre_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Plus_Times_pre_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>"</span></span>
<span class="main">|</span> pre_Base<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟹</span> <span class="free">Plus_Times_pre_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="main">|</span> pre_Plus<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">Plus_Times_pre_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span> <span class="free">Plus_Times_pre_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x'</span></span></span> <span class="free"><span class="bound"><span class="entity">y'</span></span></span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free">Plus_Times_pre_cong</span> <span class="free">R</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">x'</span></span></span><span class="main">)</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">y'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> pre_Times<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">Plus_Times_pre_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span> <span class="free">Plus_Times_pre_cong</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x'</span></span></span> <span class="free"><span class="bound"><span class="entity">y'</span></span></span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free">Plus_Times_pre_cong</span> <span class="free">R</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">x'</span></span></span><span class="main">)</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">y'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> language_simulation_coinduction_upto_Plus_Times<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Lang<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">pred</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">L</span> <span class="free">K</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">L</span> <span class="bound">K</span><span class="main">.</span> <span class="free">R</span> <span class="bound">L</span> <span class="bound">K</span> <span class="main">⟹</span> 𝔬 <span class="bound">L</span> <span class="main">≤</span> 𝔬 <span class="bound">K</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> Plus_Times_pre_cong <span class="free">R</span> <span class="main">(</span>𝔡 <span class="bound">L</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>𝔡 <span class="bound">K</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">≤</span> <span class="free">K</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> language_simulation_coinduction<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"Plus_Times_pre_cong <span class="free"><span class="free">R</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">L</span> <span class="skolem">K</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Plus_Times_pre_cong <span class="free">R</span> <span class="skolem">L</span> <span class="skolem">K</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"𝔬 <span class="skolem">L</span> <span class="main">≤</span> 𝔬 <span class="skolem">K</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> Plus_Times_pre_cong <span class="free">R</span> <span class="main">(</span>𝔡 <span class="skolem">L</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>𝔡 <span class="skolem">K</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Plus_Times_pre_cong.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> hyp<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">intro</span> pre_Base R<span class="main">)</span>

<span class="keyword1" id="Coinductive_Language-ge_One"><span class="command">lemma</span></span> ge_One<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"One <span class="main">≤</span> <span class="free">r</span> <span class="main">⟷</span> 𝔬 <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_eq_language_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Plus.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Plus_OneL<span class="main">)</span>

<span class="keyword1" id="Coinductive_Language-Plus_mono"><span class="command">lemma</span></span> Plus_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">r1</span> <span class="main">≤</span> <span class="free">s1</span><span class="main">;</span> <span class="free">r2</span> <span class="main">≤</span> <span class="free">s2</span><span class="main">⟧</span> <span class="main">⟹</span> Plus <span class="free">r1</span> <span class="free">r2</span> <span class="main">≤</span> Plus <span class="free">s1</span> <span class="free">s2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r1</span></span> <span class="quoted"><span class="free">r2</span></span> <span class="quoted"><span class="free">s1</span></span> <span class="quoted"><span class="free">s2</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> 𝔡_mono<span class="main">)</span>

<span class="keyword1" id="Coinductive_Language-Plus_upper"><span class="command">lemma</span></span> Plus_upper<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">r1</span> <span class="main">≤</span> <span class="free">s</span><span class="main">;</span> <span class="free">r2</span> <span class="main">≤</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> Plus <span class="free">r1</span> <span class="free">r2</span> <span class="main">≤</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r1</span></span> <span class="quoted"><span class="free">r2</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-Inter_mono"><span class="command">lemma</span></span> Inter_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">r1</span> <span class="main">≤</span> <span class="free">s1</span><span class="main">;</span> <span class="free">r2</span> <span class="main">≤</span> <span class="free">s2</span><span class="main">⟧</span> <span class="main">⟹</span> Inter <span class="free">r1</span> <span class="free">r2</span> <span class="main">≤</span> Inter <span class="free">s1</span> <span class="free">s2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r1</span></span> <span class="quoted"><span class="free">r2</span></span> <span class="quoted"><span class="free">s1</span></span> <span class="quoted"><span class="free">s2</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> 𝔡_mono<span class="main">)</span>

<span class="keyword1" id="Coinductive_Language-Times_mono"><span class="command">lemma</span></span> Times_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">r1</span> <span class="main">≤</span> <span class="free">s1</span><span class="main">;</span> <span class="free">r2</span> <span class="main">≤</span> <span class="free">s2</span><span class="main">⟧</span> <span class="main">⟹</span> Times <span class="free">r1</span> <span class="free">r2</span> <span class="main">≤</span> Times <span class="free">s1</span> <span class="free">s2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r1</span></span> <span class="quoted"><span class="free">r2</span></span> <span class="quoted"><span class="free">s1</span></span> <span class="quoted"><span class="free">s2</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> 𝔡_mono<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We prove the missing axioms of Kleene Algebras about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Star</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, as well as monotonicity
  properties and three standard interesting rules: bisimulation, sliding, and denesting.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> le_StarL<span class="main">:</span> <span class="quoted"><span class="quoted">"Plus One <span class="main">(</span>Times <span class="free">r</span> <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> Star <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">coinduction</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> le_StarR<span class="main">:</span> <span class="quoted"><span class="quoted">"Plus One <span class="main">(</span>Times <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span> <span class="main">≤</span> Star <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_eq_refl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Star_unfoldR<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Coinductive_Language-le_TimesL"><span class="command">lemma</span></span> le_TimesL<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"𝔬 <span class="free">s</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">≤</span> Times <span class="free">r</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-le_TimesR"><span class="command">lemma</span></span> le_TimesR<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"𝔬 <span class="free">r</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">≤</span> Times <span class="free">r</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">coinduction</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-Plus_le_iff"><span class="command">lemma</span></span> Plus_le_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"Plus <span class="free">r</span> <span class="free">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">⟷</span> <span class="free">r</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">≤</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_eq_language_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Plus_assoc Plus_idem_assoc Plus_rotate<span class="main">)</span>

<span class="keyword1" id="Coinductive_Language-Plus_Times_pre_cong_mono"><span class="command">lemma</span></span> Plus_Times_pre_cong_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">L'</span> <span class="main">≤</span> <span class="free">L</span> <span class="main">⟹</span> <span class="free">K</span> <span class="main">≤</span> <span class="free">K'</span> <span class="main">⟹</span> Plus_Times_pre_cong <span class="free">R</span> <span class="free">L</span> <span class="free">K</span> <span class="main">⟹</span> Plus_Times_pre_cong <span class="free">R</span> <span class="free">L'</span> <span class="free">K'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> pre_Trans pre_Less<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> ardenL<span class="main">:</span> <span class="quoted"><span class="quoted">"Plus <span class="free">r</span> <span class="main">(</span>Times <span class="free">s</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟹</span> Times <span class="main">(</span>Star <span class="free">s</span><span class="main">)</span> <span class="free">r</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Lang
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Plus_Times_pre_cong_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> order_refl 𝔡_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Lang<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> ardenR<span class="main">:</span> <span class="quoted"><span class="quoted">"Plus <span class="free">r</span> <span class="main">(</span>Times <span class="free">x</span> <span class="free">s</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟹</span> Times <span class="free">r</span> <span class="main">(</span>Star <span class="free">s</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Lang
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Plus_Times_pre_cong <span class="main">(</span><span class="main">λ</span><span class="bound">L</span> <span class="bound">K</span><span class="main">.</span> <span class="main">∃</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">L</span> <span class="main">=</span> Times <span class="bound">r</span> <span class="main">(</span>Star <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> Plus <span class="bound">r</span> <span class="main">(</span>Times <span class="bound">K</span> <span class="bound">s</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">K</span><span class="main">)</span>
    <span class="main">(</span>𝔡 <span class="main">(</span>Times <span class="skolem">r</span> <span class="main">(</span>Star <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>𝔡 <span class="skolem">x</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="keyword1"><span class="command">using</span></span> 𝔡_mono<span class="main">[</span><span class="operator">OF</span> Lang<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> Times_PlusL <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Times_PlusL<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Plus_le_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Lang <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coinductive_Language-le_Star"><span class="command">lemma</span></span> le_Star<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≤</span> Star <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">coinduction</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-Star_mono"><span class="command">lemma</span></span> Star_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≤</span> <span class="free">s</span> <span class="main">⟹</span> Star <span class="free">r</span> <span class="main">≤</span> Star <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">coinduction</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-Not_antimono"><span class="command">lemma</span></span> Not_antimono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≤</span> <span class="free">s</span> <span class="main">⟹</span> Not <span class="free">s</span> <span class="main">≤</span> Not <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-Not_Plus"><span class="command">lemma</span></span> Not_Plus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Not <span class="main">(</span>Plus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> Inter <span class="main">(</span>Not <span class="free">r</span><span class="main">)</span> <span class="main">(</span>Not <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-Not_Inter"><span class="command">lemma</span></span> Not_Inter<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Not <span class="main">(</span>Inter <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span>Not <span class="free">r</span><span class="main">)</span> <span class="main">(</span>Not <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-Inter_assoc"><span class="command">lemma</span></span> Inter_assoc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Inter <span class="main">(</span>Inter <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> Inter <span class="free">r</span> <span class="main">(</span>Inter <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-Inter_comm"><span class="command">lemma</span></span> Inter_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"Inter <span class="free">r</span> <span class="free">s</span> <span class="main">=</span> Inter <span class="free">s</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-Inter_idem"><span class="command">lemma</span></span> Inter_idem<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Inter <span class="free">r</span> <span class="free">r</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-Inter_ZeroL"><span class="command">lemma</span></span> Inter_ZeroL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Inter Zero <span class="free">r</span> <span class="main">=</span> Zero"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-Inter_ZeroR"><span class="command">lemma</span></span> Inter_ZeroR<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Inter <span class="free">r</span> Zero <span class="main">=</span> Zero"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-Inter_FullL"><span class="command">lemma</span></span> Inter_FullL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Inter Full <span class="free">r</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-Inter_FullR"><span class="command">lemma</span></span> Inter_FullR<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Inter <span class="free">r</span> Full <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-Plus_FullL"><span class="command">lemma</span></span> Plus_FullL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Plus Full <span class="free">r</span> <span class="main">=</span> Full"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-Plus_FullR"><span class="command">lemma</span></span> Plus_FullR<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Plus <span class="free">r</span> Full <span class="main">=</span> Full"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-Not_Not"><span class="command">lemma</span></span> Not_Not<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Not <span class="main">(</span>Not <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-Not_Zero"><span class="command">lemma</span></span> Not_Zero<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Not Zero <span class="main">=</span> Full"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">coinduction</span> <span class="operator">simp</span>

<span class="keyword1" id="Coinductive_Language-Not_Full"><span class="command">lemma</span></span> Not_Full<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Not Full <span class="main">=</span> Zero"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">coinduction</span> <span class="operator">simp</span>

<span class="keyword1" id="Coinductive_Language-bisimulation"><span class="command">lemma</span></span> bisimulation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Times <span class="free">r</span> <span class="free">s</span> <span class="main">=</span> Times <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Times <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> Times <span class="free">s</span> <span class="main">(</span>Star <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ardenL<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Plus_upper<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le_TimesL<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> ardenR<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Plus_upper<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le_TimesR<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Times <span class="free">r</span> <span class="main">(</span>Times <span class="free">s</span> <span class="main">(</span>Star <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> Times <span class="free">s</span> <span class="main">(</span>Star <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _
        Times_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> order_refl ord_le_eq_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le_PlusR Star_unfoldL<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> assms Times_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Times <span class="main">(</span>Times <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="free">t</span> <span class="main">≤</span> Times <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _
        Times_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ord_le_eq_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le_PlusR Star_unfoldR<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> order_refl<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> assms Times_assoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Coinductive_Language-sliding"><span class="command">lemma</span></span> sliding<span class="main">:</span> <span class="quoted"><span class="quoted">"Times <span class="main">(</span>Star <span class="main">(</span>Times <span class="free">r</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> Times <span class="free">r</span> <span class="main">(</span>Star <span class="main">(</span>Times <span class="free">s</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ardenL<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Plus_upper<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le_TimesL<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> ardenR<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Plus_upper<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le_TimesR<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Times <span class="main">(</span>Times <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>Times <span class="free">r</span> <span class="main">(</span>Star <span class="main">(</span>Times <span class="free">s</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> Times <span class="free">r</span> <span class="main">(</span>Star <span class="main">(</span>Times <span class="free">s</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _
        Times_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> order_refl ord_le_eq_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le_PlusR Star_unfoldL<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Times <span class="main">(</span>Times <span class="main">(</span>Star <span class="main">(</span>Times <span class="free">r</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>Times <span class="free">s</span> <span class="free">r</span><span class="main">)</span> <span class="main">≤</span> Times <span class="main">(</span>Star <span class="main">(</span>Times <span class="free">r</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _
        Times_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ord_le_eq_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le_PlusR Star_unfoldR<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> order_refl<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Coinductive_Language-denesting"><span class="command">lemma</span></span> denesting<span class="main">:</span> <span class="quoted"><span class="quoted">"Star <span class="main">(</span>Plus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> Times <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span> <span class="main">(</span>Star <span class="main">(</span>Times <span class="free">s</span> <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ord_eq_le_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Times_OneR<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ardenL<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Plus_upper<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span>
   ardenR<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Plus_upper<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Star_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le_PlusL<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Times <span class="main">(</span>Plus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>Times <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span> <span class="main">(</span>Star <span class="main">(</span>Times <span class="free">s</span> <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">≤</span> Times <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span> <span class="main">(</span>Star <span class="main">(</span>Times <span class="free">s</span> <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"Times <span class="main">_</span> <span class="var">?L</span> <span class="main">≤</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> Times_PlusL
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Plus_upper<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">metis</span> Star_unfoldL Times_assoc Times_mono le_PlusR order_refl<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">metis</span> Star_unfoldL Times_assoc 𝔬_Star le_PlusR le_TimesR order_trans<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Times <span class="main">(</span>Star <span class="main">(</span>Plus <span class="free">r</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Times <span class="free">s</span> <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> Star <span class="main">(</span>Plus <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Plus_comm Star_unfoldL Times_PlusR Times_assoc ardenR bisimulation le_PlusR<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
It is useful to lift binary operators <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Plus</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Times</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
to $n$-ary operators (that take a list as input).
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">PLUS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> language list <span class="main">⇒</span> <span class="tfree">'a</span> language"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">PLUS</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> foldr Plus <span class="free"><span class="bound"><span class="entity">xs</span></span></span> Zero"</span></span>

<span class="keyword1" id="Coinductive_Language-𝔬_foldr_Plus"><span class="command">lemma</span></span> 𝔬_foldr_Plus<span class="main">:</span> <span class="quoted"><span class="quoted">"𝔬 <span class="main">(</span>foldr Plus <span class="free">xs</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span><span class="free">s</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> 𝔬 <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-𝔡_foldr_Plus"><span class="command">lemma</span></span> 𝔡_foldr_Plus<span class="main">:</span> <span class="quoted"><span class="quoted">"𝔡 <span class="main">(</span>foldr Plus <span class="free">xs</span> <span class="free">s</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> foldr Plus <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> 𝔡 <span class="bound">r</span> <span class="free">a</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>𝔡 <span class="free">s</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Coinductive_Language-𝔬_PLUS"><span class="command">lemma</span></span> 𝔬_PLUS<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"𝔬 <span class="main">(</span>PLUS <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> 𝔬 <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> PLUS_def 𝔬_foldr_Plus <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Coinductive_Language-𝔡_PLUS"><span class="command">lemma</span></span> 𝔡_PLUS<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"𝔡 <span class="main">(</span>PLUS <span class="free">xs</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> PLUS <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> 𝔡 <span class="bound">r</span> <span class="free">a</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> PLUS_def 𝔡_foldr_Plus <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">TIMES</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> language list <span class="main">⇒</span> <span class="tfree">'a</span> language"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">TIMES</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> foldr Times <span class="free"><span class="bound"><span class="entity">xs</span></span></span> One"</span></span>

<span class="keyword1" id="Coinductive_Language-𝔬_foldr_Times"><span class="command">lemma</span></span> 𝔬_foldr_Times<span class="main">:</span> <span class="quoted"><span class="quoted">"𝔬 <span class="main">(</span>foldr Times <span class="free">xs</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span><span class="free">s</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> 𝔬 <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> PLUS_def<span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">tails</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tails</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[</span><span class="main">[]</span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tails</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free">tails</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1" id="Coinductive_Language-tails_snoc"><span class="command">lemma</span></span> tails_snoc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tails <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> <span class="bound">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>tails <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">[]</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-length_tails"><span class="command">lemma</span></span> length_tails<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>tails <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-𝔡_foldr_Times"><span class="command">lemma</span></span> 𝔡_foldr_Times<span class="main">:</span> <span class="quoted"><span class="quoted">"𝔡 <span class="main">(</span>foldr Times <span class="free">xs</span> <span class="free">s</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> length <span class="main">(</span>takeWhile 𝔬 <span class="free">xs</span><span class="main">)</span>
  <span class="keyword1">in</span> PLUS <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">zs</span><span class="main">.</span> TIMES <span class="main">(</span>𝔡 <span class="main">(</span>hd <span class="bound">zs</span><span class="main">)</span> <span class="free">a</span> <span class="main">#</span> tl <span class="bound">zs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>tails <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> TIMES_def PLUS_def Let_def foldr_map o_def<span class="main">)</span>

<span class="keyword1" id="Coinductive_Language-𝔬_TIMES"><span class="command">lemma</span></span> 𝔬_TIMES<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"𝔬 <span class="main">(</span>TIMES <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> 𝔬 <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> TIMES_def 𝔬_foldr_Times <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Coinductive_Language-TIMES_snoc_One"><span class="command">lemma</span></span> TIMES_snoc_One<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"TIMES <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span>One<span class="main">]</span><span class="main">)</span> <span class="main">=</span> TIMES <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> TIMES_def<span class="main">)</span>

<span class="keyword1" id="Coinductive_Language-𝔡_TIMES"><span class="command">lemma</span></span> 𝔡_TIMES<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"𝔡 <span class="main">(</span>TIMES <span class="free">xs</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> length <span class="main">(</span>takeWhile 𝔬 <span class="free">xs</span><span class="main">)</span>
  <span class="keyword1">in</span> PLUS <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">zs</span><span class="main">.</span> TIMES <span class="main">(</span>𝔡 <span class="main">(</span>hd <span class="bound">zs</span><span class="main">)</span> <span class="free">a</span> <span class="main">#</span> tl <span class="bound">zs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>tails <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span>One<span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> TIMES_def 𝔡_foldr_Times <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>



<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Word-theoretic Semantics of Languages›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We show our <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> language<span class="antiquote"><span class="antiquote">}</span></span></span></span> codatatype being isomorphic to the standard
language representation as a set of lists.
›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">in_language</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> language <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">in_language</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">[]</span> <span class="main">=</span> 𝔬 <span class="free"><span class="bound"><span class="entity">L</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">in_language</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">in_language</span> <span class="main">(</span>𝔡 <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">to_language</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list set <span class="main">⇒</span> <span class="tfree">'a</span> language"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"𝔬 <span class="main">(</span><span class="free">to_language</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"𝔡 <span class="main">(</span><span class="free">to_language</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">to_language</span> <span class="main">{</span><span class="bound">w</span><span class="main">.</span> <span class="bound">a</span> <span class="main">#</span> <span class="bound">w</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Coinductive_Language-in_language_to_language"><span class="command">lemma</span></span> in_language_to_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Collect <span class="main">(</span>in_language <span class="main">(</span>to_language <span class="free">L</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">L</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> mem_Collect_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"in_language <span class="main">(</span>to_language <span class="free">L</span><span class="main">)</span> <span class="skolem">w</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">∈</span> <span class="free">L</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coinductive_Language-to_language_in_language"><span class="command">lemma</span></span> to_language_in_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"to_language <span class="main">(</span>Collect <span class="main">(</span>in_language <span class="free">L</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Language-in_language_bij"><span class="command">lemma</span></span> in_language_bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="main">(</span>Collect <span class="keyword1">o</span> in_language<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> bijI'<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> o_apply<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">L</span> <span class="skolem">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> language"</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Collect <span class="main">(</span>in_language <span class="skolem">L</span><span class="main">)</span> <span class="main">=</span> Collect <span class="main">(</span>in_language <span class="skolem">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> <span class="skolem">R</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> set_eq_iff mem_Collect_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">L</span></span> <span class="quoted"><span class="skolem">R</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> in_language.simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">L</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list set"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> Collect <span class="main">(</span>in_language <span class="main">(</span>to_language <span class="skolem">L</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">K</span><span class="main">.</span> <span class="skolem">L</span> <span class="main">=</span> Collect <span class="main">(</span>in_language <span class="bound">K</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coinductive_Language-to_language_bij"><span class="command">lemma</span></span> to_language_bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij to_language"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> o_bij<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Collect <span class="keyword1"><span class="keyword1"><span class="keyword1">o</span></span></span> in_language"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> TimesLR Times_Plus StarLR ShuffleLR

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Coinductive_Regular_Set">
<div class="head">
<h1>Theory Coinductive_Regular_Set</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Coinductively Defined Operations Are Standard›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Coinductive_Regular_Set
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../Regular-Sets/Regular_Set.html">Regular-Sets.Regular_Set</a>"</span> <a href="Coinductive_Language.html">Coinductive_Language</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1" id="Coinductive_Regular_Set-to_language_empty"><span class="command">lemma</span></span> to_language_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"to_language <span class="main">{}</span> <span class="main">=</span> Zero"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Regular_Set-in_language_Zero"><span class="command">lemma</span></span> in_language_Zero<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> in_language Zero <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Regular_Set-in_language_One"><span class="command">lemma</span></span> in_language_One<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"in_language One <span class="free">xs</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Regular_Set-in_language_Atom"><span class="command">lemma</span></span> in_language_Atom<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"in_language <span class="main">(</span>Atom <span class="free">a</span><span class="main">)</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="Coinductive_Regular_Set-to_language_eps"><span class="command">lemma</span></span> to_language_eps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"to_language <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">=</span> One"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_is_inj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> in_language_bij<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> injD<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Regular_Set-to_language_singleton"><span class="command">lemma</span></span> to_language_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"to_language <span class="main">{</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span>Atom <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_is_inj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> in_language_bij<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> injD<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coinductive_Regular_Set-to_language_Un"><span class="command">lemma</span></span> to_language_Un<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"to_language <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span>to_language <span class="free">A</span><span class="main">)</span> <span class="main">(</span>to_language <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Collect_disj_eq<span class="main">)</span>

<span class="keyword1" id="Coinductive_Regular_Set-to_language_Int"><span class="command">lemma</span></span> to_language_Int<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"to_language <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> Inter <span class="main">(</span>to_language <span class="free">A</span><span class="main">)</span> <span class="main">(</span>to_language <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Collect_conj_eq<span class="main">)</span>

<span class="keyword1" id="Coinductive_Regular_Set-to_language_Neg"><span class="command">lemma</span></span> to_language_Neg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"to_language <span class="main">(</span><span class="main">-</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> Not <span class="main">(</span>to_language <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Collect_neg_eq<span class="main">)</span>

<span class="keyword1" id="Coinductive_Regular_Set-to_language_Diff"><span class="command">lemma</span></span> to_language_Diff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"to_language <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> Inter <span class="main">(</span>to_language <span class="free">A</span><span class="main">)</span> <span class="main">(</span>Not <span class="main">(</span>to_language <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Diff_eq<span class="main">)</span>

<span class="keyword1" id="Coinductive_Regular_Set-to_language_conc"><span class="command">lemma</span></span> to_language_conc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"to_language <span class="main">(</span><span class="free">A</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> Times <span class="main">(</span>to_language <span class="free">A</span><span class="main">)</span> <span class="main">(</span>to_language <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> language_coinduct_upto_Plus<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Deriv_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Coinductive_Regular_Set-to_language_star"><span class="command">lemma</span></span> to_language_star<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"to_language <span class="main">(</span>star <span class="free">A</span><span class="main">)</span> <span class="main">=</span> Star <span class="main">(</span>to_language <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> language_coinduct_upto_regular<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Deriv_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Coinductive_Regular_Set-to_language_shuffle"><span class="command">lemma</span></span> to_language_shuffle<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"to_language <span class="main">(</span><span class="free">A</span> <span class="main">∥</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> Shuffle <span class="main">(</span>to_language <span class="free">A</span><span class="main">)</span> <span class="main">(</span>to_language <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> language_coinduct_upto_Plus<span class="main">)</span>
    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Deriv_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Context_Free_Grammar">
<div class="head">
<h1>Theory Context_Free_Grammar</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Word Problem for Context-Free Grammars›</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Context_Free_Grammar
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Coinductive_Language.html">Coinductive_Language</a> <span class="quoted">"<a href="../../HOL/HOL-Library/FSet.html">HOL-Library.FSet</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Context Free Languages›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
A context-free grammar consists of a list of productions for every nonterminal
and an initial nonterminal. The productions are required to be in weak Greibach
normal form, i.e. each right hand side of a production must either be empty or
start with a terminal.
›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">wgreibach</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="keyword1">of</span> <span class="main">(</span>Inr <span class="bound">N</span> <span class="main">#</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> False <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'n</span><span class="main">)</span> cfg <span class="main">=</span>
  init <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'n</span> <span class="main">::</span> finite"</span></span>
  prod <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'n</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'t</span> <span class="main">+</span> <span class="tfree">'n</span><span class="main">)</span> list fset"</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'n</span> <span class="main">::</span> finite<span class="main">)</span> cfg"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">in_cfl</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">in_cfl</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">in_cfl</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">⟹</span> <span class="free">in_cfl</span> <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"fBex <span class="main">(</span>prod <span class="free">G</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">β</span><span class="main">.</span> <span class="free">in_cfl</span> <span class="main">(</span><span class="bound">β</span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">in_cfl</span> <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">lang_trad</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lang_trad</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">w</span><span class="main">.</span> in_cfl <span class="main">[</span>Inr <span class="main">(</span>init <span class="free">G</span><span class="main">)</span><span class="main">]</span> <span class="bound">w</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">𝔬<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">𝔬<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">[]</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">𝔬<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">(</span>Inl <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">#</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">𝔬<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span> <span class="main">|∈|</span> prod <span class="free">G</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">∧</span> <span class="free">𝔬<span class="hidden">⇩</span><sub>P</sub></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">𝔡<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">𝔡<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">𝔡<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="main">{|</span><span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">|}</span> <span class="keyword1">else</span> <span class="main">{||}</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">𝔡<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">β</span><span class="main">.</span> tl <span class="bound">β</span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span> <span class="main">|`|</span> ffilter <span class="main">(</span><span class="main">λ</span><span class="bound">β</span><span class="main">.</span> <span class="bound">β</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> hd <span class="bound">β</span> <span class="main">=</span> Inl <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>prod <span class="free">G</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span> <span class="main">|∪|</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">[]</span> <span class="main">|∈|</span> prod <span class="free">G</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="keyword1">then</span> <span class="free">𝔡<span class="hidden">⇩</span><sub>P</sub></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">else</span> <span class="main">{||}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'t</span> <span class="main">+</span> <span class="tfree">'n</span><span class="main">)</span> list fset <span class="main">⇒</span> <span class="tfree">'t</span> language"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> Lang <span class="main">(</span>fBex <span class="free"><span class="bound"><span class="entity">P</span></span></span> 𝔬<span class="hidden">⇩</span><sub>P</sub><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">subst</span> <span class="main">(</span>ffUnion <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> 𝔡<span class="hidden">⇩</span><sub>P</sub> <span class="bound">r</span> <span class="bound">a</span><span class="main">)</span> <span class="main">|`|</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">in_cfls</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"fBex <span class="free"><span class="bound"><span class="entity">P</span></span></span> 𝔬<span class="hidden">⇩</span><sub>P</sub> <span class="main">⟹</span> <span class="free">in_cfls</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">in_cfls</span> <span class="main">(</span>ffUnion <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">α</span><span class="main">.</span> 𝔡<span class="hidden">⇩</span><sub>P</sub> <span class="bound">α</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">|`|</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">⟹</span> <span class="free">in_cfls</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"in_cfls <span class="free">P</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"in_cfls <span class="free">P</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">w</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> inj_eq<span class="main">[</span><span class="operator">OF</span> bij_is_inj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> to_language_bij<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span>

<span class="keyword1" id="Context_Free_Grammar-subst_in_cfls"><span class="command">lemma</span></span> subst_in_cfls<span class="main">:</span> <span class="quoted"><span class="quoted">"subst <span class="free">P</span> <span class="main">=</span> to_language <span class="main">{</span><span class="bound">w</span><span class="main">.</span> in_cfls <span class="free">P</span> <span class="bound">w</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> in_cfls.intros<span class="main">)</span>

<span class="keyword1" id="Context_Free_Grammar-𝔬"><span class="command">lemma</span></span> 𝔬<span class="hidden">⇩</span><sub>P</sub>_in_cfl<span class="main">:</span> <span class="quoted"><span class="quoted">"𝔬<span class="hidden">⇩</span><sub>P</sub> <span class="free">α</span> <span class="main">⟹</span> in_cfl <span class="free">α</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">α</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> 𝔬<span class="hidden">⇩</span><sub>P</sub>.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_cfl.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> fBexI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Context_Free_Grammar-𝔡"><span class="command">lemma</span></span> 𝔡<span class="hidden">⇩</span><sub>P</sub>_in_cfl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="main">|∈|</span> 𝔡<span class="hidden">⇩</span><sub>P</sub> <span class="free">α</span> <span class="free">a</span> <span class="main">⟹</span> in_cfl <span class="free">β</span> <span class="free">w</span> <span class="main">⟹</span> in_cfl <span class="free">α</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">w</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">α</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">β</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> 𝔡<span class="hidden">⇩</span><sub>P</sub>.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">N</span> <span class="skolem">α</span> <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rev_fBexI neq_Nil_conv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_cfl.intros  <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rev_fBexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">#</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> in_cfl.intros<span class="main">)</span>

<span class="keyword1" id="Context_Free_Grammar-in_cfls_in_cfl"><span class="command">lemma</span></span> in_cfls_in_cfl<span class="main">:</span> <span class="quoted"><span class="quoted">"in_cfls <span class="free">P</span> <span class="free">w</span> <span class="main">⟹</span> fBex <span class="free">P</span> <span class="main">(</span><span class="main">λ</span><span class="bound">α</span><span class="main">.</span> in_cfl <span class="bound">α</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> in_cfls.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 𝔬<span class="hidden">⇩</span><sub>P</sub>_in_cfl 𝔡<span class="hidden">⇩</span><sub>P</sub>_in_cfl ffUnion.rep_eq fmember.rep_eq fBex.rep_eq fBall.rep_eq
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> in_cfl.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rev_bexI<span class="main">)</span>

<span class="keyword1" id="Context_Free_Grammar-in_cfls_mono"><span class="command">lemma</span></span> in_cfls_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"in_cfls <span class="free">P</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">|⊆|</span> <span class="free">Q</span> <span class="main">⟹</span> in_cfls <span class="free">Q</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> in_cfls.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">a</span> <span class="skolem">P</span> <span class="skolem">w</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>3<span class="main">)</span> 2<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"ffUnion <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">α</span><span class="main">.</span> local.𝔡<span class="hidden">⇩</span><sub>P</sub> <span class="bound">α</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">|`|</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ffunion_mono in_cfls.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_cfls.intros<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> cfg_wgreibach <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'n</span> <span class="main">::</span> finite<span class="main">)</span> cfg"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> weakGreibach<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">N</span> <span class="bound">α</span><span class="main">.</span> <span class="bound">α</span> <span class="main">|∈|</span> prod <span class="free">G</span> <span class="bound">N</span> <span class="main">⟹</span> wgreibach <span class="bound">α</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Context_Free_Grammar-in_cfl_in_cfls"><span class="command">lemma</span></span> in_cfl_in_cfls<span class="main">:</span> <span class="quoted"><span class="quoted">"in_cfl <span class="free">G</span> <span class="free">α</span> <span class="free">w</span> <span class="main">⟹</span> in_cfls <span class="free">G</span> <span class="main">{|</span><span class="free">α</span><span class="main">|}</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">α</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> in_cfl.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">N</span> <span class="skolem">α</span> <span class="skolem">w</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    β<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">β</span> <span class="main">|∈|</span> prod <span class="free">G</span> <span class="skolem">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    in_cfl<span class="main">:</span> <span class="quoted"><span class="quoted">"in_cfl <span class="free">G</span> <span class="main">(</span><span class="skolem">β</span> <span class="main">@</span> <span class="skolem">α</span><span class="main">)</span> <span class="skolem">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    in_cfls<span class="main">:</span> <span class="quoted"><span class="quoted">"in_cfls <span class="free">G</span> <span class="main">{|</span><span class="skolem">β</span> <span class="main">@</span> <span class="skolem">α</span><span class="main">|}</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">β</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> Nil
    <span class="keyword1"><span class="command">from</span></span> β in_cfls <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_cfls.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> in_cfls_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">γ</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> weakGreibach<span class="main">[</span><span class="operator">OF</span> β<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Inl <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> β in_cfls <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span>  in_cfl.cases<span class="main"><span class="main">[</span></span><span class="operator">OF</span> in_cfl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> in_cfls.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_cfls_mono<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_cfls.intros<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">lang</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lang</span> <span class="main">≡</span> subst <span class="free">G</span> <span class="main">{|</span><span class="main">[</span>Inr <span class="main">(</span>init <span class="free">G</span><span class="main">)</span><span class="main">]</span><span class="main">|}</span>"</span></span>

<span class="keyword1" id="Context_Free_Grammar-lang_lang_trad"><span class="command">lemma</span></span> lang_lang_trad<span class="main">:</span> <span class="quoted"><span class="quoted">"lang <span class="main">=</span> to_language <span class="main">(</span>lang_trad <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"in_cfls <span class="free">G</span> <span class="main">{|</span><span class="main">[</span>Inr <span class="main">(</span>init <span class="free">G</span><span class="main">)</span><span class="main">]</span><span class="main">|}</span> <span class="skolem">w</span> <span class="main">⟷</span> in_cfl <span class="free">G</span> <span class="main">[</span>Inr <span class="main">(</span>init <span class="free">G</span><span class="main">)</span><span class="main">]</span> <span class="skolem">w</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">w</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_cfls_in_cfl in_cfl_in_cfls<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_in_cfls<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">in_language</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> decides the word problem for a given language.
Since we can construct the language of a CFG using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> cfg_wgreibach.lang<span class="antiquote"><span class="antiquote">}</span></span></span></span> we obtain an
executable (but not very efficient) decision procedure for CFGs for free.
›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝔞</span> <span class="main">≡</span> Inl True"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝔟</span> <span class="main">≡</span> Inl False"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≡</span> Inr <span class="main">()</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> palindromes<span class="main">:</span> cfg_wgreibach <span class="quoted"><span class="quoted">"<span class="main">⦇</span>init <span class="main">=</span> <span class="main">()</span><span class="main">,</span> prod <span class="main">=</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{|</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span>𝔞<span class="main">]</span><span class="main">,</span> <span class="main">[</span>𝔟<span class="main">]</span><span class="main">,</span> <span class="main">[</span>𝔞<span class="main">,</span> S<span class="main">,</span> 𝔞<span class="main">]</span><span class="main">,</span> <span class="main">[</span>𝔟<span class="main">,</span> S<span class="main">,</span> 𝔟<span class="main">]</span><span class="main">|}</span><span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"in_language palindromes.lang <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">normalization</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"in_language palindromes.lang <span class="main">[</span>True<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">normalization</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"in_language palindromes.lang <span class="main">[</span>False<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">normalization</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"in_language palindromes.lang <span class="main">[</span>True<span class="main">,</span> True<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">normalization</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"in_language palindromes.lang <span class="main">[</span>True<span class="main">,</span> False<span class="main">,</span> True<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">normalization</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> in_language palindromes.lang <span class="main">[</span>True<span class="main">,</span> False<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">normalization</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> in_language palindromes.lang <span class="main">[</span>True<span class="main">,</span> False<span class="main">,</span> True<span class="main">,</span> False<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">normalization</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"in_language palindromes.lang <span class="main">[</span>True<span class="main">,</span> False<span class="main">,</span> True<span class="main">,</span> True<span class="main">,</span> False<span class="main">,</span> True<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">normalization</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> in_language palindromes.lang <span class="main">[</span>True<span class="main">,</span> False<span class="main">,</span> True<span class="main">,</span> False<span class="main">,</span> False<span class="main">,</span> True<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">normalization</span>

<span class="keyword1"><span class="command">interpretation</span></span> Dyck<span class="main">:</span> cfg_wgreibach <span class="quoted"><span class="quoted">"<span class="main">⦇</span>init <span class="main">=</span> <span class="main">()</span><span class="main">,</span> prod <span class="main">=</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{|</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span>𝔞<span class="main">,</span> S<span class="main">,</span> 𝔟<span class="main">,</span> S<span class="main">]</span><span class="main">|}</span><span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"in_language Dyck.lang <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">normalization</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> in_language Dyck.lang <span class="main">[</span>True<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">normalization</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> in_language Dyck.lang <span class="main">[</span>False<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">normalization</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"in_language Dyck.lang <span class="main">[</span>True<span class="main">,</span> False<span class="main">,</span> True<span class="main">,</span> False<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">normalization</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"in_language Dyck.lang <span class="main">[</span>True<span class="main">,</span> True<span class="main">,</span> False<span class="main">,</span> False<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">normalization</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"in_language Dyck.lang <span class="main">[</span>True<span class="main">,</span> False<span class="main">,</span> True<span class="main">,</span> False<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">normalization</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"in_language Dyck.lang <span class="main">[</span>True<span class="main">,</span> False<span class="main">,</span> True<span class="main">,</span> False<span class="main">,</span> True<span class="main">,</span> True<span class="main">,</span> False<span class="main">,</span> False<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">normalization</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> in_language Dyck.lang <span class="main">[</span>True<span class="main">,</span> False<span class="main">,</span> True<span class="main">,</span> True<span class="main">,</span> False<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">normalization</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> in_language Dyck.lang <span class="main">[</span>True<span class="main">,</span> True<span class="main">,</span> False<span class="main">,</span> False<span class="main">,</span> False<span class="main">,</span> True<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">normalization</span>

<span class="keyword1"><span class="command">interpretation</span></span> abSSa<span class="main">:</span> cfg_wgreibach <span class="quoted"><span class="quoted">"<span class="main">⦇</span>init <span class="main">=</span> <span class="main">()</span><span class="main">,</span> prod <span class="main">=</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{|</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span>𝔞<span class="main">,</span> 𝔟<span class="main">,</span> S<span class="main">,</span> S<span class="main">,</span> 𝔞<span class="main">]</span><span class="main">|}</span><span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"in_language abSSa.lang <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">normalization</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> in_language abSSa.lang <span class="main">[</span>True<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">normalization</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> in_language abSSa.lang <span class="main">[</span>False<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">normalization</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"in_language abSSa.lang <span class="main">[</span>True<span class="main">,</span> False<span class="main">,</span> True<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">normalization</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"in_language abSSa.lang <span class="main">[</span>True<span class="main">,</span> False<span class="main">,</span> True<span class="main">,</span> False<span class="main">,</span> True<span class="main">,</span> True<span class="main">,</span> False<span class="main">,</span> True<span class="main">,</span> True<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">normalization</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"in_language abSSa.lang <span class="main">[</span>True<span class="main">,</span> False<span class="main">,</span> True<span class="main">,</span> False<span class="main">,</span> True<span class="main">,</span> True<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">normalization</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> in_language abSSa.lang <span class="main">[</span>True<span class="main">,</span> False<span class="main">,</span> True<span class="main">,</span> True<span class="main">,</span> False<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">normalization</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> in_language abSSa.lang <span class="main">[</span>True<span class="main">,</span> True<span class="main">,</span> False<span class="main">,</span> False<span class="main">,</span> False<span class="main">,</span> True<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">normalization</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span></pre>
</div>