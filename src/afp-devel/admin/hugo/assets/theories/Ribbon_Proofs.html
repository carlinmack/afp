<div id="More_Finite_Map">
<div class="head">
<h1>Theory More_Finite_Map</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Finite partial functions›</span></span>

<span class="keyword1"><span class="command">theory</span></span> More_Finite_Map <span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Finite_Map.html">HOL-Library.Finite_Map</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">unbundle</span></span> lifting_syntax
<span class="keyword1"><span class="command">unbundle</span></span> fmap.lifting

<span class="keyword1"><span class="command">type_notation</span></span> fmap <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⇀<span class="hidden">⇩</span><sub>f</sub></span>"</span> 9<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Difference›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">map_diff</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span> <span class="main">⇀</span> <span class="tfree">'v</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'k</span> fset <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span> <span class="main">⇀</span> <span class="tfree">'v</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_diff</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="main">=</span> restrict_map <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="main">-</span> fset <span class="free"><span class="bound"><span class="entity">ks</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span>
  fmap_diff <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span> <span class="keyword1">⇀<span class="hidden">⇩</span><sub>f</sub></span> <span class="tfree">'v</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'k</span> fset <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span> <span class="keyword1">⇀<span class="hidden">⇩</span><sub>f</sub></span> <span class="tfree">'v</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊖</span>"</span> 110<span class="main">)</span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"map_diff"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_diff_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Comprehension›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">make_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> fset <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span> <span class="main">⇀</span> <span class="tfree">'v</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">make_map</span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">∈</span> fset <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">else</span> None"</span></span>

<span class="keyword1" id="More_Finite_Map-make_map_transfer"><span class="command">lemma</span></span> make_map_transfer<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_fset <span class="main">(=)</span> <span class="main">===&gt;</span> <span class="free">A</span> <span class="main">===&gt;</span> rel_map <span class="free">A</span><span class="main">)</span> make_map make_map"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> make_map_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword1" id="More_Finite_Map-dom_make_map"><span class="command">lemma</span></span> dom_make_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dom <span class="main">(</span>make_map <span class="free">ks</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> fset <span class="free">ks</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domIff make_map_def not_Some_eq set_eqI<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span>
  make_fmap <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> fset <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span> <span class="keyword1">⇀<span class="hidden">⇩</span><sub>f</sub></span> <span class="tfree">'v</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">[</span> _ <span class="keyword1">|=&gt;</span> _ <span class="keyword1">]</span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"make_map"</span></span> <span class="keyword2"><span class="keyword">parametric</span></span> make_map_transfer
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> make_map_def dom_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="More_Finite_Map-make_fmap_empty"><span class="command">lemma</span></span> make_fmap_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span> <span class="main">{||}</span> <span class="main">|=&gt;</span> <span class="free">f</span> <span class="main">]</span> <span class="main">=</span> fmempty"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> make_map_def<span class="main">)</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Domain›</span></span>


<span class="keyword1" id="More_Finite_Map-fmap_add_commute"><span class="command">lemma</span></span> fmap_add_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="free">A</span> <span class="main">|∩|</span> fmdom <span class="free">B</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">B</span> <span class="main">=</span> <span class="free">B</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">including</span></span> fset.lifting
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dom_def map_add_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="More_Finite_Map-make_fmap_union"><span class="command">lemma</span></span> make_fmap_union<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span> <span class="free">xs</span> <span class="main">|=&gt;</span> <span class="free">v</span> <span class="main">]</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">[</span> <span class="free">ys</span> <span class="main">|=&gt;</span> <span class="free">v</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span> <span class="free">xs</span> <span class="main">|∪|</span> <span class="free">ys</span> <span class="main">|=&gt;</span> <span class="free">v</span> <span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> make_map_def map_add_def<span class="main">)</span>

<span class="keyword1" id="More_Finite_Map-fdom_make_fmap"><span class="command">lemma</span></span> fdom_make_fmap<span class="main">:</span> <span class="quoted"><span class="quoted">"fmdom <span class="main">[</span> <span class="free">ks</span> <span class="main">|=&gt;</span> <span class="free">v</span> <span class="main">]</span> <span class="main">=</span> <span class="free">ks</span>"</span></span>
<span class="comment1">(* FIXME proper transfer proof *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fmdom_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dom_def make_map_def fset_inverse<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lookup›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span>
  lookup <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span> <span class="keyword1">⇀<span class="hidden">⇩</span><sub>f</sub></span> <span class="tfree">'v</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'k</span> <span class="main">⇒</span> <span class="tfree">'v</span>"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(∘)</span> the"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="More_Finite_Map-lookup_make_fmap"><span class="command">lemma</span></span> lookup_make_fmap<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∈</span> fset <span class="free">ks</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">[</span> <span class="free">ks</span> <span class="main">|=&gt;</span> <span class="free">v</span> <span class="main">]</span> <span class="free">k</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> make_map_def<span class="main">)</span>

<span class="keyword1" id="More_Finite_Map-lookup_make_fmap1"><span class="command">lemma</span></span> lookup_make_fmap1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lookup <span class="main">[</span> <span class="main">{|</span><span class="free">k</span><span class="main">|}</span> <span class="main">|=&gt;</span> <span class="free">v</span> <span class="main">]</span> <span class="free">k</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finsert.rep_eq insert_iff lookup_make_fmap<span class="main">)</span>

<span class="keyword1" id="More_Finite_Map-lookup_union1"><span class="command">lemma</span></span> lookup_union1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">|∈|</span> fmdom <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="free">xs</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">ys</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> lookup <span class="free">ys</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">including</span></span> fset.lifting
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="More_Finite_Map-lookup_union2"><span class="command">lemma</span></span> lookup_union2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">|∉|</span> fmdom <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="free">xs</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">ys</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> lookup <span class="free">xs</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">including</span></span> fset.lifting
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_add_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="More_Finite_Map-lookup_union3"><span class="command">lemma</span></span> lookup_union3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">|∉|</span> fmdom <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="free">xs</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">ys</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> lookup <span class="free">ys</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">including</span></span> fset.lifting
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_add_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="JHelper">
<div class="head">
<h1>Theory JHelper</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹General purpose definitions and lemmas›</span></span>

<span class="keyword1"><span class="command">theory</span></span> JHelper <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="JHelper-Collect_iff"><span class="command">lemma</span></span> Collect_iff<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span> <span class="main">≡</span> <span class="free">P</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="JHelper-diff_diff_eq"><span class="command">lemma</span></span> diff_diff_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">C</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">-</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="JHelper-nth_in_set"><span class="command">lemma</span></span> nth_in_set<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">;</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="JHelper-disjI"><span class="command">lemma</span></span> disjI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∨</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="JHelper-empty_eq_Plus_conv"><span class="command">lemma</span></span> empty_eq_Plus_conv<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{}</span> <span class="main">=</span> <span class="free">A</span> <span class="main">&lt;+&gt;</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Projection functions on triples›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fst3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fst3</span> <span class="main">≡</span> fst"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">snd3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">snd3</span> <span class="main">≡</span> fst <span class="main">∘</span> snd"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">thd3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">thd3</span> <span class="main">≡</span> snd <span class="main">∘</span> snd"</span></span>

<span class="keyword1" id="JHelper-fst3_simp"><span class="command">lemma</span></span> fst3_simp<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> fst3 <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">=</span> <span class="bound">a</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fst3_def<span class="main">)</span>

<span class="keyword1" id="JHelper-snd3_simp"><span class="command">lemma</span></span> snd3_simp<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> snd3 <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">=</span> <span class="bound">b</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> snd3_def<span class="main">)</span>

<span class="keyword1" id="JHelper-thd3_simp"><span class="command">lemma</span></span> thd3_simp<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> thd3 <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">=</span> <span class="bound">c</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> thd3_def<span class="main">)</span>

<span class="keyword1" id="JHelper-tripleI"><span class="command">lemma</span></span> tripleI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">T</span> <span class="free">U</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fst3 <span class="free">T</span> <span class="main">=</span> fst3 <span class="free">U</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"snd3 <span class="free">T</span> <span class="main">=</span> snd3 <span class="free">U</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"thd3 <span class="free">T</span> <span class="main">=</span> thd3 <span class="free">U</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">=</span> <span class="free">U</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms fst3_def snd3_def thd3_def o_def surjective_pairing<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Proofchain">
<div class="head">
<h1>Theory Proofchain</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Proof chains›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Proofchain <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#JHelper">JHelper</a>  
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'c</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) chain is a sequence of alternating 
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'c</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s, beginning and ending with an <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Usually 
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> represents some sort of assertion, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'c</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> represents some 
  sort of command. Proof chains are useful for stating the SMain proof rule,
  and for conducting the proof of soundness.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> chain <span class="main">=</span> 
  cNil <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span>                         <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⦃</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _ <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⦄</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span><span class="main">)</span>
<span class="main">|</span> cCons <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> chain"</span></span>   <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⦃</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _ <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⦄</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⋅</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _ <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⋅</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _"</span> <span class="main">[</span>0<span class="main">,</span>0<span class="main">,</span>0<span class="main">]</span> 60<span class="main">)</span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For example, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">⦃</span></span> <span class="free"><span class="free">a</span></span> <span class="main"><span class="main">⦄</span></span> <span class="main"><span class="main">⋅</span></span> <span class="free"><span class="free">proof</span></span> <span class="main"><span class="main">⋅</span></span> <span class="main"><span class="main">⦃</span></span> <span class="free"><span class="free">chain</span></span> <span class="main"><span class="main">⦄</span></span> <span class="main"><span class="main">⋅</span></span> <span class="free"><span class="free">might</span></span> <span class="main"><span class="main">⋅</span></span> <span class="main"><span class="main">⦃</span></span> <span class="free"><span class="free">look</span></span> <span class="main"><span class="main">⦄</span></span> <span class="main"><span class="main">⋅</span></span> 
  <span class="free"><span class="free">like</span></span> <span class="main"><span class="main">⋅</span></span> <span class="main"><span class="main">⦃</span></span> <span class="free"><span class="free">this</span></span> <span class="main"><span class="main">⦄</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Projections›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Project first assertion.›</span></span>
<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">pre</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> chain <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pre</span> <span class="main">⦃</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⦄</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pre</span> <span class="main">(</span><span class="main">⦃</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⦄</span> <span class="main">⋅</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⋅</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Project final assertion.›</span></span>
<span class="keyword1"><span class="command">fun</span></span> 
  <span class="entity">post</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> chain <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">post</span> <span class="main">⦃</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⦄</span>  <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">post</span> <span class="main">(</span><span class="main">⦃</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⦄</span> <span class="main">⋅</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">Π</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">post</span> <span class="free"><span class="bound"><span class="entity">Π</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Project list of commands.›</span></span>
<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">comlist</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> chain <span class="main">⇒</span> <span class="tfree">'c</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">comlist</span> <span class="main">⦃</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⦄</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">comlist</span> <span class="main">(</span><span class="main">⦃</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⦄</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">Π</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="main">(</span><span class="free">comlist</span> <span class="free"><span class="bound"><span class="entity">Π</span></span></span><span class="main">)</span>"</span></span> 


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Chain length›</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">chainlen</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> chain <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">chainlen</span> <span class="main">⦃</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⦄</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">chainlen</span> <span class="main">(</span><span class="main">⦃</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⦄</span> <span class="main">⋅</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">Π</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="free">chainlen</span> <span class="free"><span class="bound"><span class="entity">Π</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Proofchain-len_comlist_chainlen"><span class="command">lemma</span></span> len_comlist_chainlen<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>comlist <span class="free">Π</span><span class="main">)</span> <span class="main">=</span> chainlen <span class="free">Π</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Π</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Extracting triples from chains›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">nthtriple</span></span> <span class="free"><span class="free">Π</span></span> <span class="free"><span class="free">n</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> extracts the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>th triple of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Π</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  counting from 0. The function is well-defined when <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"chainlen <span class="free"><span class="free">Π</span></span> <span class="main"><span class="main">&gt;</span></span> <span class="free"><span class="free">n</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. 
›</span></span>
<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">nthtriple</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> chain <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">*</span> <span class="tfree">'c</span> <span class="main">*</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nthtriple</span> <span class="main">(</span><span class="main">⦃</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⦄</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">Π</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> pre <span class="free"><span class="bound"><span class="entity">Π</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nthtriple</span> <span class="main">(</span><span class="main">⦃</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⦄</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">Π</span></span></span><span class="main">)</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">nthtriple</span> <span class="free"><span class="bound"><span class="entity">Π</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The list of middle components of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Π</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s triples is the list of
   <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Π</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s commands.›</span></span>
<span class="keyword1" id="Proofchain-snds_of_triples_form_comlist"><span class="command">lemma</span></span> snds_of_triples_form_comlist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Π</span> <span class="free">i</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> chainlen <span class="free">Π</span> <span class="main">⟹</span> snd3 <span class="main">(</span>nthtriple <span class="free">Π</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>comlist <span class="free">Π</span><span class="main">)</span><span class="main">!</span><span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Π</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">i</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> snd3_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Evaluating a predicate on each triple of a chain›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">chain_all</span></span> <span class="free"><span class="free">φ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> holds of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Π</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> iff <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">φ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> holds for each
  of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Π</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s individual triples.›</span></span> 
<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">chain_all</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> chain <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">chain_all</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">⦃</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⦄</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">chain_all</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span><span class="main">⦃</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⦄</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">Π</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span>pre <span class="free"><span class="bound"><span class="entity">Π</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free">chain_all</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">Π</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Proofchain-chain_all_mono"><span class="command">lemma</span></span> chain_all_mono <span class="main">[</span><span class="operator">mono</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> chain_all <span class="free">x</span> <span class="main">≤</span> chain_all <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> le_funI le_boolI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Π</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> chain"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">≤</span> <span class="skolem">g</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"chain_all <span class="skolem">f</span> <span class="skolem">Π</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"chain_all <span class="skolem">g</span> <span class="skolem">Π</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">Π</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">≤</span> <span class="skolem">g</span>›</span></span> chain_all.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> predicate1D<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="Proofchain-chain_all_nthtriple"><span class="command">lemma</span></span> chain_all_nthtriple<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>chain_all <span class="free">φ</span> <span class="free">Π</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> chainlen <span class="free">Π</span><span class="main">.</span> <span class="free">φ</span> <span class="main">(</span>nthtriple <span class="free">Π</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> iffI allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"chain_all <span class="free">φ</span> <span class="free">Π</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> chainlen <span class="free">Π</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">(</span>nthtriple <span class="free">Π</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Π</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">Π'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Π_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Π</span> <span class="main">=</span> <span class="main">⦃</span> <span class="skolem">σ</span> <span class="main">⦄</span> <span class="main">⋅</span> <span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">Π'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> chain.exhaust chainlen.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> less_nat_zero_code<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> Π_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">Π'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Π_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Π</span> <span class="main">=</span> <span class="main">⦃</span> <span class="skolem">σ</span> <span class="main">⦄</span> <span class="main">⋅</span> <span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">Π'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> chain.exhaust chainlen.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> less_nat_zero_code<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> Π_def nthtriple.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> Suc.hyps<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Suc.prems<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Π_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>chainlen <span class="free">Π</span><span class="main">.</span> <span class="free">φ</span> <span class="main">(</span>nthtriple <span class="free">Π</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> chainlen <span class="free">Π</span> <span class="main">⟹</span> <span class="free">φ</span> <span class="main">(</span>nthtriple <span class="free">Π</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"chain_all <span class="free">φ</span> <span class="free">Π</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Π</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cCons <span class="skolem">σ</span> <span class="skolem">x</span> <span class="skolem">Π'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">(</span>nthtriple <span class="main">(</span><span class="main">⦃</span> <span class="skolem">σ</span> <span class="main">⦄</span> <span class="main">⋅</span> <span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">Π'</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> cCons.prems<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> cCons.hyps<span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> chainlen <span class="skolem">Π'</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">&lt;</span> chainlen <span class="main">(</span><span class="main">⦃</span> <span class="skolem">σ</span> <span class="main">⦄</span> <span class="main">⋅</span> <span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">Π'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> cCons.prems<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">(</span>nthtriple <span class="skolem">Π'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹A map function for proof chains›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">chainmap</span></span> <span class="free"><span class="free">f</span></span> <span class="free"><span class="free">g</span></span> <span class="free"><span class="free">Π</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> maps <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> over each of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Π</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s 
  assertions, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">g</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> over each of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Π</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s commands.›</span></span>
<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">chainmap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> chain <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> chain"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">chainmap</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⦃</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⦄</span> <span class="main">=</span> <span class="main">⦃</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⦄</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">chainmap</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="main">⦃</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⦄</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">Π</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">⦃</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⦄</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⋅</span> <span class="free">chainmap</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">Π</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Mapping over a chain preserves its length.›</span></span>
<span class="keyword1" id="Proofchain-chainmap_preserves_length"><span class="command">lemma</span></span> chainmap_preserves_length<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"chainlen <span class="main">(</span>chainmap <span class="free">f</span> <span class="free">g</span> <span class="free">Π</span><span class="main">)</span> <span class="main">=</span> chainlen <span class="free">Π</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Π</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Proofchain-pre_chainmap"><span class="command">lemma</span></span> pre_chainmap<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pre <span class="main">(</span>chainmap <span class="free">f</span> <span class="free">g</span> <span class="free">Π</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>pre <span class="free">Π</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Π</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Proofchain-post_chainmap"><span class="command">lemma</span></span> post_chainmap<span class="main">:</span>
  <span class="quoted"><span class="quoted">"post <span class="main">(</span>chainmap <span class="free">f</span> <span class="free">g</span> <span class="free">Π</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>post <span class="free">Π</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Π</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Proofchain-nthtriple_chainmap"><span class="command">lemma</span></span> nthtriple_chainmap<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> chainlen <span class="free">Π</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nthtriple <span class="main">(</span>chainmap <span class="free">f</span> <span class="free">g</span> <span class="free">Π</span><span class="main">)</span> <span class="free">i</span> 
    <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>fst3 <span class="bound">t</span><span class="main">)</span><span class="main">,</span> <span class="free">g</span> <span class="main">(</span>snd3 <span class="bound">t</span><span class="main">)</span><span class="main">,</span> <span class="free">f</span> <span class="main">(</span>thd3 <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>nthtriple <span class="free">Π</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Π</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> cCons
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pre_chainmap fst3_def snd3_def thd3_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Extending a chain on its right-hand side›</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">cSnoc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> chain <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> chain"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cSnoc</span> <span class="main">⦃</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⦄</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">=</span> <span class="main">⦃</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⦄</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⋅</span> <span class="main">⦃</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">⦄</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cSnoc</span> <span class="main">(</span><span class="main">⦃</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⦄</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">Π</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">=</span> <span class="main">⦃</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⦄</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">cSnoc</span> <span class="free"><span class="bound"><span class="entity">Π</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Proofchain-len_snoc"><span class="command">lemma</span></span> len_snoc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Π</span> <span class="free">x</span> <span class="free">P</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"chainlen <span class="main">(</span>cSnoc <span class="free">Π</span> <span class="free">x</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span>chainlen <span class="free">Π</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Π</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Proofchain-pre_snoc"><span class="command">lemma</span></span> pre_snoc<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"pre <span class="main">(</span>cSnoc <span class="free">Π</span> <span class="free">x</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> pre <span class="free">Π</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Π</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Proofchain-post_snoc"><span class="command">lemma</span></span> post_snoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"post <span class="main">(</span>cSnoc <span class="free">Π</span> <span class="free">x</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Π</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Proofchain-comlist_snoc"><span class="command">lemma</span></span> comlist_snoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"comlist <span class="main">(</span>cSnoc <span class="free">Π</span> <span class="free">x</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> comlist <span class="free">Π</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Π</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>



<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Ribbons_Basic">
<div class="head">
<h1>Theory Ribbons_Basic</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Assertions, commands, and separation logic proof rules›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Ribbons_Basic <span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a> 
<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define a command language, assertions, and the rules of separation
  logic, plus some derived rules that are used by our tool. This is the only 
  theory file that is loaded by the tool. We keep it as small as possible. 
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Assertions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The language of assertions includes (at least) an emp constant, 
  a star-operator, and existentially-quantified logical variables.›</span></span>

<span class="keyword1"><span class="command">typedecl</span></span> assertion

<span class="keyword1"><span class="command">axiomatization</span></span>
  <span class="free">Emp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"assertion"</span></span>

<span class="keyword1"><span class="command">axiomatization</span></span>
  <span class="free">Star</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"assertion <span class="main">⇒</span> assertion <span class="main">⇒</span> assertion"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">⋆</span>"</span> 55<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  star_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main"><span class="free">⋆</span></span> <span class="free">q</span> <span class="main">=</span> <span class="free">q</span> <span class="main"><span class="free">⋆</span></span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  star_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main"><span class="free">⋆</span></span> <span class="free">q</span><span class="main">)</span> <span class="main"><span class="free">⋆</span></span> <span class="free">r</span> <span class="main">=</span> <span class="free">p</span> <span class="main"><span class="free">⋆</span></span> <span class="main">(</span><span class="free">q</span> <span class="main"><span class="free">⋆</span></span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  star_emp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main"><span class="free">⋆</span></span> Emp <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  emp_star<span class="main">:</span> <span class="quoted"><span class="quoted">"Emp <span class="main"><span class="free">⋆</span></span> <span class="free">p</span> <span class="main">=</span> <span class="free">p</span>"</span></span>

<span class="keyword1" id="Ribbons_Basic-star_rot"><span class="command">lemma</span></span> star_rot<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">⋆</span> <span class="free">p</span> <span class="main">⋆</span> <span class="free">r</span> <span class="main">=</span> <span class="free">p</span> <span class="main">⋆</span> <span class="free">q</span> <span class="main">⋆</span> <span class="free">r</span>"</span></span> 
<span class="keyword1"><span class="command">using</span></span> star_assoc star_comm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">axiomatization</span></span> 
  <span class="free">Exists</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> assertion <span class="main">⇒</span> assertion"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Extracting the set of program variables mentioned in an assertion.›</span></span>
<span class="keyword1"><span class="command">axiomatization</span></span> 
  <span class="free">rd_ass</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"assertion <span class="main">⇒</span> string set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> rd_emp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rd_ass</span> Emp <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> rd_star<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rd_ass</span> <span class="main">(</span><span class="free">p</span> <span class="main">⋆</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">rd_ass</span> <span class="free">p</span> <span class="main">∪</span> <span class="free">rd_ass</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> rd_exists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rd_ass</span> <span class="main">(</span>Exists <span class="free">x</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">rd_ass</span> <span class="free">p</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Commands›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The language of commands comprises (at least) non-deterministic 
  choice, non-deterministic looping, skip and sequencing.›</span></span>

<span class="keyword1"><span class="command">typedecl</span></span> command

<span class="keyword1"><span class="command">axiomatization</span></span> 
  <span class="free">Choose</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"command <span class="main">⇒</span> command <span class="main">⇒</span> command"</span></span>

<span class="keyword1"><span class="command">axiomatization</span></span> 
  <span class="free">Loop</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"command <span class="main">⇒</span> command"</span></span>

<span class="keyword1"><span class="command">axiomatization</span></span> 
  <span class="free">Skip</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"command"</span></span>

<span class="keyword1"><span class="command">axiomatization</span></span>
  <span class="free">Seq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"command <span class="main">⇒</span> command <span class="main">⇒</span> command"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">;;</span>"</span> 55<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> seq_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c1</span> <span class="main"><span class="free">;;</span></span> <span class="main">(</span><span class="free">c2</span> <span class="main"><span class="free">;;</span></span> <span class="free">c3</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">c1</span> <span class="main"><span class="free">;;</span></span> <span class="free">c2</span><span class="main">)</span> <span class="main"><span class="free">;;</span></span> <span class="free">c3</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> seq_skip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main"><span class="free">;;</span></span> Skip <span class="main">=</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> skip_seq<span class="main">:</span> <span class="quoted"><span class="quoted">"Skip <span class="main"><span class="free">;;</span></span> <span class="free">c</span> <span class="main">=</span> <span class="free">c</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Extracting the set of program variables read by a command.›</span></span>
<span class="keyword1"><span class="command">axiomatization</span></span>
  <span class="free">rd_com</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"command <span class="main">⇒</span> string set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> rd_com_choose<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rd_com</span> <span class="main">(</span>Choose <span class="free">c1</span> <span class="free">c2</span><span class="main">)</span> <span class="main">=</span> <span class="free">rd_com</span> <span class="free">c1</span> <span class="main">∪</span> <span class="free">rd_com</span> <span class="free">c2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> rd_com_loop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rd_com</span> <span class="main">(</span>Loop <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">rd_com</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> rd_com_skip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rd_com</span> <span class="main">(</span>Skip<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> rd_com_seq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rd_com</span> <span class="main">(</span><span class="free">c1</span> <span class="main">;;</span> <span class="free">c2</span><span class="main">)</span> <span class="main">=</span> <span class="free">rd_com</span> <span class="free">c1</span> <span class="main">∪</span> <span class="free">rd_com</span> <span class="free">c2</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Extracting the set of program variables written by a command.›</span></span>
<span class="keyword1"><span class="command">axiomatization</span></span>
  <span class="free">wr_com</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"command <span class="main">⇒</span> string set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> wr_com_choose<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wr_com</span> <span class="main">(</span>Choose <span class="free">c1</span> <span class="free">c2</span><span class="main">)</span> <span class="main">=</span> <span class="free">wr_com</span> <span class="free">c1</span> <span class="main">∪</span> <span class="free">wr_com</span> <span class="free">c2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> wr_com_loop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wr_com</span> <span class="main">(</span>Loop <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">wr_com</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> wr_com_skip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wr_com</span> <span class="main">(</span>Skip<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> wr_com_seq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wr_com</span> <span class="main">(</span><span class="free">c1</span> <span class="main">;;</span> <span class="free">c2</span><span class="main">)</span> <span class="main">=</span> <span class="free">wr_com</span> <span class="free">c1</span> <span class="main">∪</span> <span class="free">wr_com</span> <span class="free">c2</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Separation logic proof rules›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Note that the frame rule has a side-condition concerning program
  variables. When proving the soundness of our graphical formalisation of
  ribbon proofs, we shall omit this side-condition.›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">prov_triple</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"assertion <span class="main">×</span> command <span class="main">×</span> assertion <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  exists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prov_triple</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">prov_triple</span> <span class="main">(</span>Exists <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> Exists <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> choose<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">prov_triple</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">;</span> <span class="free">prov_triple</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="free">prov_triple</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> Choose <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> loop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prov_triple</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">prov_triple</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> Loop <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span> 
<span class="main">|</span> frame<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">prov_triple</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">;</span> wr_com<span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">∩</span> rd_ass<span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="free">prov_triple</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⋆</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">⋆</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> skip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prov_triple</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> Skip<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> seq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">prov_triple</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">;</span> <span class="free">prov_triple</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="free">prov_triple</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">;;</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Here are some derived proof rules, which are used in our 
  ribbon-checking tool.›</span></span>

<span class="keyword1" id="Ribbons_Basic-choice_lemma"><span class="command">lemma</span></span> choice_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prov_triple <span class="main">(</span><span class="free">p1</span><span class="main">,</span> <span class="free">c1</span><span class="main">,</span> <span class="free">q1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prov_triple <span class="main">(</span><span class="free">p2</span><span class="main">,</span> <span class="free">c2</span><span class="main">,</span> <span class="free">q2</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">p1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">=</span> <span class="free">p2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">q1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q1</span> <span class="main">=</span> <span class="free">q2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prov_triple <span class="main">(</span><span class="free">p</span><span class="main">,</span> Choose <span class="free">c1</span> <span class="free">c2</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms prov_triple.choose <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Ribbons_Basic-loop_lemma"><span class="command">lemma</span></span> loop_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prov_triple <span class="main">(</span><span class="free">p1</span><span class="main">,</span> <span class="free">c</span><span class="main">,</span> <span class="free">q1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">p1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">=</span> <span class="free">q1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q1</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prov_triple <span class="main">(</span><span class="free">p</span><span class="main">,</span> Loop <span class="free">c</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms prov_triple.loop <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Ribbons_Basic-seq_lemma"><span class="command">lemma</span></span> seq_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prov_triple <span class="main">(</span><span class="free">p1</span><span class="main">,</span> <span class="free">c1</span><span class="main">,</span> <span class="free">q1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prov_triple <span class="main">(</span><span class="free">p2</span><span class="main">,</span> <span class="free">c2</span><span class="main">,</span> <span class="free">q2</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q1</span> <span class="main">=</span> <span class="free">p2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prov_triple <span class="main">(</span><span class="free">p1</span><span class="main">,</span> <span class="free">c1</span> <span class="main">;;</span> <span class="free">c2</span><span class="main">,</span> <span class="free">q2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms prov_triple.seq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Ribbons_Interfaces">
<div class="head">
<h1>Theory Ribbons_Interfaces</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Ribbon proof interfaces›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Ribbons_Interfaces <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Ribbons_Basic">Ribbons_Basic</a>
  <a href="#Proofchain">Proofchain</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/FSet.html">HOL-Library.FSet</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Interfaces are the top and bottom boundaries through which diagrams 
  can be connected into a surrounding context. For instance, when composing two 
  diagrams vertically, the bottom interface of the upper diagram must match the 
  top interface of the lower diagram. 

  We define a datatype of concrete interfaces. We then quotient by the 
  associativity, commutativity and unity properties of our 
  horizontal-composition operator.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Syntax of interfaces›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> conc_interface <span class="main">=</span>
  Ribbon_conc <span class="quoted"><span class="quoted">"assertion"</span></span>
<span class="main">|</span> HComp_int_conc <span class="quoted"><span class="quoted">"conc_interface"</span></span> <span class="quoted"><span class="quoted">"conc_interface"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⊗<span class="hidden">⇩</span><sub>c</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 50<span class="main">)</span>
<span class="main">|</span> Emp_int_conc <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">ε<span class="hidden">⇩</span><sub>c</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span><span class="main">)</span>
<span class="main">|</span> Exists_int_conc <span class="quoted"><span class="quoted">"string"</span></span> <span class="quoted"><span class="quoted">"conc_interface"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define an equivalence on interfaces. The first three rules make this 
  an equivalence relation. The next three make it a congruence. The next two 
  identify interfaces up to associativity and commutativity of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">(⊗<span class="hidden">⇩</span><sub>c</sub>)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
  The final two make <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">ε<span class="hidden">⇩</span><sub>c</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> the left and right unit of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">(⊗<span class="hidden">⇩</span><sub>c</sub>)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. 
›</span></span>
<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">equiv_int</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"conc_interface <span class="main">⇒</span> conc_interface <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≃</span>"</span> 45<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">≃</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>
<span class="main">|</span> sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">≃</span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main"><span class="free">≃</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>
<span class="main">|</span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">≃</span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main"><span class="free">≃</span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">≃</span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span>
<span class="main">|</span> cong_hcomp1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">≃</span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="keyword1">⊗<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">≃</span></span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="keyword1">⊗<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span>
<span class="main">|</span> cong_hcomp2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">≃</span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1">⊗<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main"><span class="free">≃</span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="keyword1">⊗<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span>"</span></span>
<span class="main">|</span> cong_exists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">≃</span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">⟹</span> Exists_int_conc <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">≃</span></span> Exists_int_conc <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span>
<span class="main">|</span> hcomp_conc_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1">⊗<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="keyword1">⊗<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main"><span class="free">≃</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1">⊗<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="keyword1">⊗<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span>
<span class="main">|</span> hcomp_conc_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1">⊗<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main"><span class="free">≃</span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="keyword1">⊗<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>
<span class="main">|</span> hcomp_conc_unit1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ε<span class="hidden">⇩</span><sub>c</sub></span> <span class="keyword1">⊗<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">≃</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>
<span class="main">|</span> hcomp_conc_unit2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1">⊗<span class="hidden">⇩</span><sub>c</sub></span> <span class="keyword1">ε<span class="hidden">⇩</span><sub>c</sub></span> <span class="main"><span class="free">≃</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1" id="Ribbons_Interfaces-equiv_int_cong_hcomp"><span class="command">lemma</span></span> equiv_int_cong_hcomp<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">≃</span> <span class="free">Q</span> <span class="main">;</span> <span class="free">P'</span> <span class="main">≃</span> <span class="free">Q'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="keyword1">⊗<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">P'</span> <span class="main">≃</span> <span class="free">Q</span> <span class="keyword1">⊗<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">Q'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cong_hcomp1 cong_hcomp2 equiv_int.trans<span class="main">)</span>

<span class="keyword1"><span class="command">quotient_type</span></span> interface <span class="main">=</span> <span class="quoted"><span class="quoted">"conc_interface"</span></span> <span class="main">/</span> <span class="quoted"><span class="quoted">"equiv_int"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> equivpI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> reflpI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> equiv_int.refl<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> sympI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> equiv_int.sym<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> transpI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> equiv_int.trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> equiv_int.refl<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> 
  Ribbon <span class="main">::</span> <span class="quoted"><span class="quoted">"assertion <span class="main">⇒</span> interface"</span></span> 
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"Ribbon_conc"</span></span> <span class="keyword1"><span class="command">.</span></span>


<span class="keyword1"><span class="command">lift_definition</span></span>
  Emp_int <span class="main">::</span> <span class="quoted"><span class="quoted">"interface"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ε</span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ε<span class="hidden">⇩</span><sub>c</sub></span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span>
  Exists_int <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> interface <span class="main">⇒</span> interface"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"Exists_int_conc"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> equiv_int.cong_exists<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span>
  HComp_int <span class="main">::</span> <span class="quoted"><span class="quoted">"interface <span class="main">⇒</span> interface <span class="main">⇒</span> interface"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊗</span>"</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"HComp_int_conc"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> equiv_int_cong_hcomp<span class="main">)</span>

<span class="keyword1" id="Ribbons_Interfaces-hcomp_comm"><span class="command">lemma</span></span> hcomp_comm<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">⊗</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Q</span> <span class="main">⊗</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hcomp_conc_comm<span class="main"><span class="main">[</span></span><span class="operator">Transfer.transferred</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Ribbons_Interfaces-hcomp_assoc"><span class="command">lemma</span></span> hcomp_assoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">⊗</span> <span class="main">(</span><span class="free">Q</span> <span class="main">⊗</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="main">⊗</span> <span class="free">Q</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hcomp_conc_assoc<span class="main"><span class="main">[</span></span><span class="operator">Transfer.transferred</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Ribbons_Interfaces-emp_hcomp"><span class="command">lemma</span></span> emp_hcomp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">ε</span> <span class="main">⊗</span> <span class="free">P</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hcomp_conc_unit1<span class="main"><span class="main">[</span></span><span class="operator">Transfer.transferred</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Ribbons_Interfaces-hcomp_emp"><span class="command">lemma</span></span> hcomp_emp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊗</span> <span class="keyword1">ε</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hcomp_conc_unit2<span class="main"><span class="main">[</span></span><span class="operator">Transfer.transferred</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Ribbons_Interfaces-comp_fun_commute_hcomp"><span class="command">lemma</span></span> comp_fun_commute_hcomp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"comp_fun_commute <span class="main">(⊗)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hcomp_assoc fun_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> hcomp_comm<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹An iterated horizontal-composition operator›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">iter_hcomp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> fset<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> interface<span class="main">)</span> <span class="main">⇒</span> interface"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">iter_hcomp</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> ffold <span class="main">(</span><span class="main">(⊗)</span> <span class="main">∘</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="keyword1">ε</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span>"</span></span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"iter_hcomp_syntax"</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> fset<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> interface<span class="main">)</span> <span class="main">⇒</span> interface"</span></span>
      <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">⨂</span>_<span class="keyword1">|∈|</span>_<span class="keyword1">.</span> _<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span>0<span class="main">,</span>10<span class="main">]</span> 10<span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"<span class="main">⨂</span><span class="free">x</span><span class="main">|∈|</span><span class="free">M</span><span class="main">.</span> <span class="free">e</span>"</span> <span class="main">==</span> <span class="quoted">"<span class="keyword1">CONST</span> iter_hcomp <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="free">x</span><span class="main">.</span> <span class="free">e</span><span class="main">)</span>"</span>

<span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">"<span class="main">⨂</span><span class="bound">P</span><span class="main">|∈|</span><span class="free">Ps</span><span class="main">.</span> <span class="free">f</span> <span class="bound">P</span>"</span></span> <span class="comment1">― ‹this is eta-expanded, so prints in expanded form›</span>
<span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">"<span class="main">⨂</span><span class="bound">P</span><span class="main">|∈|</span><span class="free">Ps</span><span class="main">.</span> <span class="free">f</span>"</span></span> <span class="comment1">― ‹this isn't eta-expanded, so prints as written›</span>

<span class="keyword1" id="Ribbons_Interfaces-iter_hcomp_cong"><span class="command">lemma</span></span> iter_hcomp_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> fset <span class="free">vs</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">φ'</span> <span class="bound">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨂</span><span class="bound">v</span><span class="main">|∈|</span><span class="free">vs</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨂</span><span class="bound">v</span><span class="main">|∈|</span><span class="free">vs</span><span class="main">.</span> <span class="free">φ'</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> iter_hcomp_def  
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmember.rep_eq comp_fun_commute.comp_comp_fun_commute comp_fun_commute_hcomp 
  <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ffold_cong<span class="main">)</span>

<span class="keyword1" id="Ribbons_Interfaces-iter_hcomp_empty"><span class="command">lemma</span></span> iter_hcomp_empty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨂</span><span class="bound">x</span> <span class="main">|∈|</span> <span class="main">{||}</span><span class="main">.</span> <span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_fun_commute.ffold_empty comp_fun_commute_hcomp iter_hcomp_def<span class="main">)</span>

<span class="keyword1" id="Ribbons_Interfaces-iter_hcomp_insert"><span class="command">lemma</span></span> iter_hcomp_insert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">|∉|</span> <span class="free">ws</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨂</span><span class="bound">x</span> <span class="main">|∈|</span> finsert <span class="free">v</span> <span class="free">ws</span><span class="main">.</span> <span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span> <span class="free">v</span> <span class="main">⊗</span> <span class="main">(</span><span class="main">⨂</span><span class="bound">x</span> <span class="main">|∈|</span> <span class="free">ws</span><span class="main">.</span> <span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> comp_fun_commute <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(⊗)</span> <span class="main">∘</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_fun_commute.comp_comp_fun_commute comp_fun_commute_hcomp<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> iter_hcomp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ribbons_Interfaces-iter_hcomp_union"><span class="command">lemma</span></span> iter_hcomp_union<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">|∩|</span> <span class="free">ws</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨂</span><span class="bound">x</span> <span class="main">|∈|</span> <span class="free">vs</span> <span class="main">|∪|</span> <span class="free">ws</span><span class="main">.</span> <span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">⨂</span><span class="bound">x</span> <span class="main">|∈|</span> <span class="free">vs</span><span class="main">.</span> <span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⊗</span> <span class="main">(</span><span class="main">⨂</span><span class="bound">x</span> <span class="main">|∈|</span> <span class="free">ws</span><span class="main">.</span> <span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">vs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emp_hcomp iter_hcomp_empty iter_hcomp_insert hcomp_assoc<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Semantics of interfaces›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The semantics of an interface is an assertion.›</span></span>
<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">conc_asn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"conc_interface <span class="main">⇒</span> assertion"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">conc_asn</span> <span class="main">(</span>Ribbon_conc <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">conc_asn</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1">⊗<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">conc_asn</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">⋆</span> <span class="main">(</span><span class="free">conc_asn</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">conc_asn</span> <span class="main">(</span><span class="keyword1">ε<span class="hidden">⇩</span><sub>c</sub></span><span class="main">)</span> <span class="main">=</span> Emp"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">conc_asn</span> <span class="main">(</span>Exists_int_conc <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">=</span> Exists <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">conc_asn</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> 
  asn <span class="main">::</span> <span class="quoted"><span class="quoted">"interface <span class="main">⇒</span> assertion"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"conc_asn"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>equiv_int.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_assoc star_comm star_rot emp_star<span class="main">)</span>

<span class="keyword1" id="Ribbons_Interfaces-asn_simps"><span class="command">lemma</span></span> asn_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"asn <span class="main">(</span>Ribbon <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
  <span class="quoted"><span class="quoted">"asn <span class="main">(</span><span class="free">P</span> <span class="main">⊗</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>asn <span class="free">P</span><span class="main">)</span> <span class="main">⋆</span> <span class="main">(</span>asn <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"asn <span class="keyword1">ε</span> <span class="main">=</span> Emp"</span></span>
  <span class="quoted"><span class="quoted">"asn <span class="main">(</span>Exists_int <span class="free">x</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> Exists <span class="free">x</span> <span class="main">(</span>asn <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Program variables mentioned in an interface.›</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">rd_conc_int</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"conc_interface <span class="main">⇒</span> string set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rd_conc_int</span> <span class="main">(</span>Ribbon_conc <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> rd_ass <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rd_conc_int</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1">⊗<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">rd_conc_int</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∪</span> <span class="free">rd_conc_int</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rd_conc_int</span> <span class="main">(</span><span class="keyword1">ε<span class="hidden">⇩</span><sub>c</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rd_conc_int</span> <span class="main">(</span>Exists_int_conc <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">rd_conc_int</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span>
  rd_int <span class="main">::</span> <span class="quoted"><span class="quoted">"interface <span class="main">⇒</span> string set"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"rd_conc_int"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> equiv_int.induct<span class="main">)</span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The program variables read by an interface are the same as those read 
  by its corresponding assertion.›</span></span>

<span class="keyword1" id="Ribbons_Interfaces-rd_int_is_rd_ass"><span class="command">lemma</span></span> rd_int_is_rd_ass<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rd_ass <span class="main">(</span>asn <span class="free">P</span><span class="main">)</span> <span class="main">=</span> rd_int <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">P</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rd_star rd_exists rd_emp<span class="main">)</span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Here is an iterated version of the Hoare logic sequencing rule.›</span></span>

<span class="keyword1" id="Ribbons_Interfaces-seq_fold"><span class="command">lemma</span></span> seq_fold<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Π</span><span class="main">.</span> <span class="main">⟦</span> length <span class="free">cs</span> <span class="main">=</span> chainlen <span class="bound">Π</span> <span class="main">;</span> <span class="free">p1</span> <span class="main">=</span> asn <span class="main">(</span>pre <span class="bound">Π</span><span class="main">)</span> <span class="main">;</span> <span class="free">p2</span> <span class="main">=</span> asn <span class="main">(</span>post <span class="bound">Π</span><span class="main">)</span> <span class="main">;</span> 
  <span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> chainlen <span class="bound">Π</span> <span class="main">⟹</span> prov_triple 
  <span class="main">(</span>asn <span class="main">(</span>fst3 <span class="main">(</span>nthtriple <span class="bound">Π</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free">cs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> asn <span class="main">(</span>thd3 <span class="main">(</span>nthtriple <span class="bound">Π</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> prov_triple <span class="main">(</span><span class="free">p1</span><span class="main">,</span> foldr <span class="main">(;;)</span> <span class="free">cs</span> Skip<span class="main">,</span> <span class="free">p2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">cs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p1</span></span> <span class="quoted"><span class="free">p2</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Π</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prov_triple.skip<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">c</span> <span class="skolem">cs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">Π'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Π_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Π</span> <span class="main">=</span> <span class="main">⦃</span> <span class="skolem">p</span> <span class="main">⦄</span> <span class="main">⋅</span> <span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">Π'</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> chain.exhaust chainlen.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> impossible_Cons le0<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> foldr_Cons o_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> prov_triple.seq<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> q <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"asn <span class="main"><span class="main">(</span></span>pre <span class="skolem"><span class="skolem">Π'</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Cons.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Π_def pre.simps post.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nth_Cons_0<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">c</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">cs</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fst3_simp<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">p</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"pre <span class="skolem"><span class="skolem">Π'</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> thd3_simp<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">p</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"pre <span class="skolem"><span class="skolem">Π'</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span><span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> nthtriple.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">p</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">Π'</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> Π_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> Cons.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Π_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> Cons.hyps<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Π_def Cons.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> nth_Cons_Suc<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">c</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">cs</span></span></span></span><span class="main"><span class="main">]</span></span> nthtriple.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">p</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">Π'</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> Π_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> Cons.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Π_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Ribbons_Stratified">
<div class="head">
<h1>Theory Ribbons_Stratified</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Syntax and proof rules for stratified diagrams›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Ribbons_Stratified <span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="#Ribbons_Interfaces">Ribbons_Interfaces</a>
  <a href="#Proofchain">Proofchain</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define the syntax of stratified diagrams. We give proof rules 
  for stratified diagrams, and prove them sound with respect to the 
  ordinary rules of separation logic.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Syntax of stratified diagrams›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> sdiagram <span class="main">=</span> SDiagram <span class="quoted"><span class="quoted">"<span class="main">(</span>cell <span class="main">×</span> interface<span class="main">)</span> list"</span></span> 
<span class="keyword2"><span class="keyword">and</span></span> cell <span class="main">=</span> 
  Filler <span class="quoted"><span class="quoted">"interface"</span></span>
<span class="main">|</span> Basic <span class="quoted"><span class="quoted">"interface"</span></span> <span class="quoted"><span class="quoted">"command"</span></span> <span class="quoted"><span class="quoted">"interface"</span></span>
<span class="main">|</span> Exists_sdia <span class="quoted"><span class="quoted">"string"</span></span> <span class="quoted"><span class="quoted">"sdiagram"</span></span>
<span class="main">|</span> Choose_sdia <span class="quoted"><span class="quoted">"interface"</span></span> <span class="quoted"><span class="quoted">"sdiagram"</span></span> <span class="quoted"><span class="quoted">"sdiagram"</span></span> <span class="quoted"><span class="quoted">"interface"</span></span>
<span class="main">|</span> Loop_sdia <span class="quoted"><span class="quoted">"interface"</span></span> <span class="quoted"><span class="quoted">"sdiagram"</span></span> <span class="quoted"><span class="quoted">"interface"</span></span>

<span class="keyword1"><span class="command">datatype_compat</span></span> sdiagram cell

<span class="keyword1"><span class="command">type_synonym</span></span> row <span class="main">=</span> <span class="quoted"><span class="quoted">"cell <span class="main">×</span> interface"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Extracting the command from a stratified diagram.›</span></span>
<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">com_sdia</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sdiagram <span class="main">⇒</span> command"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">com_cell</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cell <span class="main">⇒</span> command"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">com_sdia</span> <span class="main">(</span>SDiagram <span class="free"><span class="bound"><span class="entity">ρs</span></span></span><span class="main">)</span> <span class="main">=</span> foldr <span class="main">(;;)</span> <span class="main">(</span>map <span class="main">(</span><span class="free">com_cell</span> <span class="main">∘</span> fst<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρs</span></span></span><span class="main">)</span> Skip"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">com_cell</span> <span class="main">(</span>Filler <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">=</span> Skip"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">com_cell</span> <span class="main">(</span>Basic <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">com_cell</span> <span class="main">(</span>Exists_sdia <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">com_sdia</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">com_cell</span> <span class="main">(</span>Choose_sdia <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main">=</span> Choose <span class="main">(</span><span class="free">com_sdia</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">com_sdia</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">com_cell</span> <span class="main">(</span>Loop_sdia <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main">=</span> Loop <span class="main">(</span><span class="free">com_sdia</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Extracting the program variables written by a stratified diagram.›</span></span>
<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">wr_sdia</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sdiagram <span class="main">⇒</span> string set"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">wr_cell</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cell <span class="main">⇒</span> string set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wr_sdia</span> <span class="main">(</span>SDiagram <span class="free"><span class="bound"><span class="entity">ρs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ρs</span></span></span><span class="main">.</span> <span class="free">wr_cell</span> <span class="main">(</span>fst <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wr_cell</span> <span class="main">(</span>Filler <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wr_cell</span> <span class="main">(</span>Basic <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main">=</span> wr_com <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wr_cell</span> <span class="main">(</span>Exists_sdia <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">wr_sdia</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wr_cell</span> <span class="main">(</span>Choose_sdia <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">wr_sdia</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">∪</span> <span class="free">wr_sdia</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wr_cell</span> <span class="main">(</span>Loop_sdia <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">wr_sdia</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The program variables written by a stratified diagram correspond to
  those written by the commands therein.›</span></span>
<span class="keyword1" id="Ribbons_Stratified-wr_sdia_is_wr_com"><span class="command">lemma</span></span> wr_sdia_is_wr_com<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ρs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"row list"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ρ</span> <span class="main">::</span> <span class="quoted">row</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>wr_sdia <span class="free">D</span> <span class="main">=</span> wr_com <span class="main">(</span>com_sdia <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>wr_cell <span class="free">γ</span> <span class="main">=</span> wr_com <span class="main">(</span>com_cell <span class="free">γ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">ρ</span> <span class="main">∈</span> set <span class="free">ρs</span><span class="main">.</span> wr_cell <span class="main">(</span>fst <span class="bound">ρ</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">=</span> wr_com <span class="main">(</span>foldr <span class="main">(;;)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">γ</span><span class="main">,</span><span class="bound">F</span><span class="main">)</span><span class="main">.</span> com_cell <span class="bound">γ</span><span class="main">)</span> <span class="free">ρs</span><span class="main">)</span> Skip<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wr_cell <span class="main">(</span>fst <span class="free">ρ</span><span class="main">)</span> <span class="main">=</span> wr_com <span class="main">(</span>com_cell <span class="main">(</span>fst <span class="free">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">D</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">ρs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">ρ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> compat_sdiagram.induct compat_cell.induct
  compat_cell_interface_prod_list.induct compat_cell_interface_prod.induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wr_com_skip wr_com_choose
  wr_com_loop wr_com_seq split_def o_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proof rules for stratified diagrams›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> 
  <span class="entity">prov_sdia</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>sdiagram<span class="main">,</span> interface<span class="main">,</span> interface<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">prov_row</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>row<span class="main">,</span> interface<span class="main">,</span> interface<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">prov_cell</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>cell<span class="main">,</span> interface<span class="main">,</span> interface<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  SRibbon<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prov_cell</span> <span class="main">(</span>Filler <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>
<span class="main">|</span> SBasic<span class="main">:</span> <span class="quoted"><span class="quoted">"prov_triple <span class="main">(</span>asn <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> asn <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">prov_cell</span> <span class="main">(</span>Basic <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span>
<span class="main">|</span> SExists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prov_sdia</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> 
    <span class="main">⟹</span> <span class="free">prov_cell</span> <span class="main">(</span>Exists_sdia <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">(</span>Exists_int <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">(</span>Exists_int <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> SChoice<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">prov_sdia</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">;</span> <span class="free">prov_sdia</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">prov_cell</span> <span class="main">(</span>Choose_sdia <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span>
<span class="main">|</span> SLoop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prov_sdia</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟹</span> <span class="free">prov_cell</span> <span class="main">(</span>Loop_sdia <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>
<span class="main">|</span> SRow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">prov_cell</span> <span class="free"><span class="bound"><span class="entity">γ</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">;</span> wr_cell <span class="free"><span class="bound"><span class="entity">γ</span></span></span> <span class="main">∩</span> rd_int <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">prov_row</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊗</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">⊗</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> SMain<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> chain_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">ρ</span><span class="main">,</span><span class="bound">Q</span><span class="main">)</span><span class="main">.</span> <span class="free">prov_row</span> <span class="bound">ρ</span> <span class="bound">P</span> <span class="bound">Q</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Π</span></span></span> <span class="main">;</span> <span class="main">0</span> <span class="main">&lt;</span> chainlen <span class="free"><span class="bound"><span class="entity">Π</span></span></span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">prov_sdia</span> <span class="main">(</span>SDiagram <span class="main">(</span>comlist <span class="free"><span class="bound"><span class="entity">Π</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pre <span class="free"><span class="bound"><span class="entity">Π</span></span></span><span class="main">)</span> <span class="main">(</span>post <span class="free"><span class="bound"><span class="entity">Π</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Soundness›</span></span>

<span class="keyword1" id="Ribbons_Stratified-soundness_strat_helper"><span class="command">lemma</span></span> soundness_strat_helper<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>prov_sdia <span class="free">D</span> <span class="free">P</span> <span class="free">Q</span> <span class="main">⟶</span> prov_triple <span class="main">(</span>asn <span class="free">P</span><span class="main">,</span> com_sdia <span class="free">D</span><span class="main">,</span> asn <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
   <span class="main">(</span>prov_row <span class="free">ρ</span> <span class="free">P</span> <span class="free">Q</span> <span class="main">⟶</span> prov_triple <span class="main">(</span>asn <span class="free">P</span><span class="main">,</span> com_cell <span class="main">(</span>fst <span class="free">ρ</span><span class="main">)</span><span class="main">,</span> asn <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
   <span class="main">(</span>prov_cell <span class="free">γ</span> <span class="free">P</span> <span class="free">Q</span> <span class="main">⟶</span> prov_triple <span class="main">(</span>asn <span class="free">P</span><span class="main">,</span> com_cell <span class="free">γ</span><span class="main">,</span> asn <span class="free">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> prov_sdia_prov_row_prov_cell.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SRibbon <span class="skolem">P</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prov_triple.skip<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SBasic <span class="skolem">P</span> <span class="skolem">c</span> <span class="skolem">Q</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SExists <span class="skolem">D</span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prov_triple.exists<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SChoice <span class="skolem">D</span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">E</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prov_triple.choose<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SLoop <span class="skolem">D</span> <span class="skolem">P</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prov_triple.loop<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SRow <span class="skolem">γ</span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prov_triple.frame rd_int_is_rd_ass wr_sdia_is_wr_com<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SMain <span class="skolem">Π</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> com_sdia.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> seq_fold<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Π</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> len_comlist_chainlen<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">Π</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fst3_simp thd3_simp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">corollary</span></span> soundness_strat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prov_sdia <span class="free">D</span> <span class="free">P</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prov_triple <span class="main">(</span>asn <span class="free">P</span><span class="main">,</span> com_sdia <span class="free">D</span><span class="main">,</span> asn <span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms soundness_strat_helper <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Ribbons_Graphical">
<div class="head">
<h1>Theory Ribbons_Graphical</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Syntax and proof rules for graphical diagrams›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Ribbons_Graphical <span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="#Ribbons_Interfaces">Ribbons_Interfaces</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We introduce a graphical syntax for diagrams, describe how to extract 
  commands and interfaces, and give proof rules for graphical diagrams.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Syntax of graphical diagrams›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Fix a type for node identifiers›</span></span>
<span class="keyword1"><span class="command">typedecl</span></span> node

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Note that this datatype is necessarily an overapproximation of 
  syntactically-wellformed diagrams, for the reason that we can't impose the 
  well-formedness constraints while maintaining admissibility of the datatype 
  declarations. So, we shall impose well-formedness in a separate definition. 
›</span></span>
  
<span class="keyword1"><span class="command">datatype</span></span> assertion_gadget <span class="main">=</span>
  Rib <span class="quoted"><span class="quoted">"assertion"</span></span>
<span class="main">|</span> Exists_dia <span class="quoted"><span class="quoted">"string"</span></span> <span class="quoted"><span class="quoted">"diagram"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> command_gadget <span class="main">=</span> 
  Com <span class="quoted"><span class="quoted">"command"</span></span>
<span class="main">|</span> Choose_dia <span class="quoted"><span class="quoted">"diagram"</span></span> <span class="quoted"><span class="quoted">"diagram"</span></span>
<span class="main">|</span> Loop_dia <span class="quoted"><span class="quoted">"diagram"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> diagram <span class="main">=</span> Graph 
  <span class="quoted"><span class="quoted">"node fset"</span></span> 
  <span class="quoted"><span class="quoted">"node <span class="main">⇒</span> assertion_gadget"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>node fset <span class="main">×</span> command_gadget <span class="main">×</span> node fset<span class="main">)</span> list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> labelling <span class="main">=</span> <span class="quoted"><span class="quoted">"node <span class="main">⇒</span> assertion_gadget"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> edge <span class="main">=</span> <span class="quoted"><span class="quoted">"node fset <span class="main">×</span> command_gadget <span class="main">×</span> node fset"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Projecting components from a graph›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">vertices</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"diagram <span class="main">⇒</span> node fset"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">^V</span>"</span> <span class="main">[</span>1000<span class="main">]</span> 1000<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Graph <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Λ</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">)</span><span class="keyword1"><span class="free">^V</span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span>"</span></span>

<span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">"<span class="free">this</span> <span class="main">(</span><span class="free">is</span><span class="keyword1">^V</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="free">test</span><span class="main">)</span><span class="keyword1">^V</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">labelling</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"diagram <span class="main">⇒</span> labelling"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">^Λ</span>"</span> <span class="main">[</span>1000<span class="main">]</span> 1000<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Graph <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Λ</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">)</span><span class="keyword1"><span class="free">^Λ</span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Λ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">edges</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"diagram <span class="main">⇒</span> edge list"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">^E</span>"</span> <span class="main">[</span>1000<span class="main">]</span> 1000<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Graph <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Λ</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">)</span><span class="keyword1"><span class="free">^E</span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Well formedness of graphical diagrams›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">acyclicity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"edge list <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">acyclicity</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">≡</span> acyclic <span class="main">(</span><span class="main">⋃</span><span class="bound">e</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">.</span> fset <span class="main">(</span>fst3 <span class="bound">e</span><span class="main">)</span> <span class="main">×</span> fset <span class="main">(</span>thd3 <span class="bound">e</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">linearity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"edge list <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">linearity</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">≡</span> 
    distinct <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">.</span> <span class="bound">e</span> <span class="main">≠</span> <span class="bound">f</span> <span class="main">⟶</span> 
    fst3 <span class="bound">e</span> <span class="main">|∩|</span> fst3 <span class="bound">f</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">∧</span>
    thd3 <span class="bound">e</span> <span class="main">|∩|</span> thd3 <span class="bound">f</span> <span class="main">=</span> <span class="main">{||}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Ribbons_Graphical-linearityD"><span class="command">lemma</span></span> linearityD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linearity <span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">e</span> <span class="bound">f</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">e</span> <span class="main">∈</span> set <span class="free">E</span> <span class="main">;</span> <span class="bound">f</span> <span class="main">∈</span> set <span class="free">E</span> <span class="main">;</span> <span class="bound">e</span> <span class="main">≠</span> <span class="bound">f</span> <span class="main">⟧</span> <span class="main">⟹</span> 
    fst3 <span class="bound">e</span> <span class="main">|∩|</span> fst3 <span class="bound">f</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">∧</span>
    thd3 <span class="bound">e</span> <span class="main">|∩|</span> thd3 <span class="bound">f</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> linearity_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Ribbons_Graphical-linearityD2"><span class="command">lemma</span></span> linearityD2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"linearity <span class="free">E</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">e</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> set <span class="free">E</span> <span class="main">∧</span> <span class="bound">f</span> <span class="main">∈</span> set <span class="free">E</span> <span class="main">∧</span> <span class="bound">e</span> <span class="main">≠</span> <span class="bound">f</span> <span class="main">⟶</span> 
    fst3 <span class="bound">e</span> <span class="main">|∩|</span> fst3 <span class="bound">f</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">∧</span>
    thd3 <span class="bound">e</span> <span class="main">|∩|</span> thd3 <span class="bound">f</span> <span class="main">=</span> <span class="main">{||}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> linearity_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">wf_ass</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"assertion_gadget <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">wf_com</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"command_gadget <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">wf_dia</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"diagram <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  wf_rib<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_ass</span> <span class="main">(</span>Rib <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span> 
<span class="main">|</span> wf_exists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_dia</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">⟹</span> <span class="free">wf_ass</span> <span class="main">(</span>Exists_dia <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> wf_com<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_com</span> <span class="main">(</span>Com <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> wf_choice<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">wf_dia</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">;</span> <span class="free">wf_dia</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">wf_com</span> <span class="main">(</span>Choose_dia <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> wf_loop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_dia</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">⟹</span> <span class="free">wf_com</span> <span class="main">(</span>Loop_dia <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> wf_dia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">.</span> <span class="free">wf_com</span> <span class="main">(</span>snd3 <span class="bound">e</span><span class="main">)</span> <span class="main">;</span> <span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> fset <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">.</span> <span class="free">wf_ass</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Λ</span></span></span> <span class="bound">v</span><span class="main">)</span> <span class="main">;</span>
  acyclicity <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">;</span> linearity <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">;</span> <span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">.</span> fst3 <span class="bound">e</span> <span class="main">|∪|</span> thd3 <span class="bound">e</span> <span class="main">|⊆|</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> 
  <span class="free">wf_dia</span> <span class="main">(</span>Graph <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Λ</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> wf_dia_inv'<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dia <span class="main">(</span>Graph <span class="free">V</span> <span class="free">Λ</span> <span class="free">E</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Ribbons_Graphical-wf_dia_inv"><span class="command">lemma</span></span> wf_dia_inv<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_dia <span class="main">(</span>Graph <span class="free">V</span> <span class="free">Λ</span> <span class="free">E</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> fset <span class="free">V</span><span class="main">.</span> wf_ass <span class="main">(</span><span class="free">Λ</span> <span class="bound">v</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> set <span class="free">E</span><span class="main">.</span> wf_com <span class="main">(</span>snd3 <span class="bound">e</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"acyclicity <span class="free">E</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"linearity <span class="free">E</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> set <span class="free">E</span><span class="main">.</span> fst3 <span class="bound">e</span> <span class="main">|∪|</span> thd3 <span class="bound">e</span> <span class="main">|⊆|</span> <span class="free">V</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>  <span class="comment1">(* This acts as an intro rule for &amp;&amp;&amp; *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> wf_dia_inv'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Initial and terminal nodes›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">initials</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"diagram <span class="main">⇒</span> node fset"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">initials</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">=</span> ffilter <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="keyword1">^E</span><span class="main">.</span> <span class="bound">v</span> <span class="main">|∉|</span> thd3 <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="keyword1">^V</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
   <span class="entity">terminals</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"diagram <span class="main">⇒</span> node fset"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">terminals</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">=</span> ffilter <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="keyword1">^E</span><span class="main">.</span> <span class="bound">v</span> <span class="main">|∉|</span> fst3 <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="keyword1">^V</span>"</span></span>

<span class="keyword1" id="Ribbons_Graphical-no_edges_imp_all_nodes_initial"><span class="command">lemma</span></span> no_edges_imp_all_nodes_initial<span class="main">:</span>
  <span class="quoted"><span class="quoted">"initials <span class="main">(</span>Graph <span class="free">V</span> <span class="free">Λ</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="free">V</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> initials_def<span class="main">)</span>

<span class="keyword1" id="Ribbons_Graphical-no_edges_imp_all_nodes_terminal"><span class="command">lemma</span></span> no_edges_imp_all_nodes_terminal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"terminals <span class="main">(</span>Graph <span class="free">V</span> <span class="free">Λ</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="free">V</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminals_def<span class="main">)</span>

<span class="keyword1" id="Ribbons_Graphical-initials_in_vertices"><span class="command">lemma</span></span> initials_in_vertices<span class="main">:</span>
   <span class="quoted"><span class="quoted">"initials <span class="free">G</span> <span class="main">|⊆|</span> <span class="free">G</span><span class="keyword1">^V</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> initials_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Ribbons_Graphical-terminals_in_vertices"><span class="command">lemma</span></span> terminals_in_vertices<span class="main">:</span>
   <span class="quoted"><span class="quoted">"terminals <span class="free">G</span> <span class="main">|⊆|</span> <span class="free">G</span><span class="keyword1">^V</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> terminals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Top and bottom interfaces›</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">top_ass</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"assertion_gadget <span class="main">⇒</span> interface"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">top_dia</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"diagram <span class="main">⇒</span> interface"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">top_dia</span> <span class="main">(</span>Graph <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Λ</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨂</span><span class="bound">v</span> <span class="main">|∈|</span> initials <span class="main">(</span>Graph <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Λ</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">)</span><span class="main">.</span> <span class="free">top_ass</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Λ</span></span></span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">top_ass</span> <span class="main">(</span>Rib <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> Ribbon <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">top_ass</span> <span class="main">(</span>Exists_dia <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">=</span> Exists_int <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">top_dia</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">bot_ass</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"assertion_gadget <span class="main">⇒</span> interface"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">bot_dia</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"diagram <span class="main">⇒</span> interface"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bot_dia</span> <span class="main">(</span>Graph <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Λ</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨂</span><span class="bound">v</span> <span class="main">|∈|</span> terminals <span class="main">(</span>Graph <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Λ</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">)</span><span class="main">.</span> <span class="free">bot_ass</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Λ</span></span></span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bot_ass</span> <span class="main">(</span>Rib <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> Ribbon <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bot_ass</span> <span class="main">(</span>Exists_dia <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">=</span> Exists_int <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">bot_dia</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proof rules for graphical diagrams›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">prov_dia</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>diagram<span class="main">,</span> interface<span class="main">,</span> interface<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">prov_com</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>command_gadget<span class="main">,</span> interface<span class="main">,</span> interface<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">prov_ass</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"assertion_gadget <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  Skip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prov_ass</span> <span class="main">(</span>Rib <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Exists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prov_dia</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟹</span> <span class="free">prov_ass</span> <span class="main">(</span>Exists_dia <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Basic<span class="main">:</span> <span class="quoted"><span class="quoted">"prov_triple <span class="main">(</span>asn <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> asn <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">prov_com</span> <span class="main">(</span>Com <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span>
<span class="main">|</span> Choice<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">prov_dia</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">;</span> <span class="free">prov_dia</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">prov_com</span> <span class="main">(</span>Choose_dia <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span>
<span class="main">|</span> Loop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prov_dia</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟹</span> <span class="free">prov_com</span> <span class="main">(</span>Loop_dia <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>
<span class="main">|</span> Main<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> wf_dia <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">;</span> <span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> fset <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="keyword1">^V</span> <span class="main">⟹</span> <span class="free">prov_ass</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="keyword1">^Λ</span> <span class="bound">v</span><span class="main">)</span><span class="main">;</span>
    <span class="main">⋀</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="keyword1">^E</span> <span class="main">⟹</span> <span class="free">prov_com</span> <span class="main">(</span>snd3 <span class="bound">e</span><span class="main">)</span> 
      <span class="main">(</span><span class="main">⨂</span><span class="bound">v</span> <span class="main">|∈|</span> fst3 <span class="bound">e</span><span class="main">.</span> bot_ass <span class="main">(</span><span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="keyword1">^Λ</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="main">⨂</span><span class="bound">v</span> <span class="main">|∈|</span> thd3 <span class="bound">e</span><span class="main">.</span> top_ass <span class="main">(</span><span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="keyword1">^Λ</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">prov_dia</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">(</span>top_dia <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">(</span>bot_dia <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> main_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"prov_dia <span class="main">(</span>Graph <span class="free">V</span> <span class="free">Λ</span> <span class="free">E</span><span class="main">)</span> <span class="free">P</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> loop_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"prov_com <span class="main">(</span>Loop_dia <span class="free">G</span><span class="main">)</span> <span class="free">P</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> choice_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"prov_com <span class="main">(</span>Choose_dia <span class="free">G</span> <span class="free">H</span><span class="main">)</span> <span class="free">P</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> basic_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"prov_com <span class="main">(</span>Com <span class="free">c</span><span class="main">)</span> <span class="free">P</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> exists_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"prov_ass <span class="main">(</span>Exists_dia <span class="free">x</span> <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> skip_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"prov_ass <span class="main">(</span>Rib <span class="free">p</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Extracting commands from diagrams›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> lin <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>node <span class="main">+</span> edge<span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A linear extension (lin) of a diagram is a list of its nodes and edges
  which respects the order of those nodes and edges. That is, if an edge
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">e</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> goes from node <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">v</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to node <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">w</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">v</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and 
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">e</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">w</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> must have strictly increasing positions in the list. 
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lins</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"diagram <span class="main">⇒</span> lin set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">lins</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">π</span> <span class="main">::</span> lin<span class="main">.</span> 
    <span class="main">(</span>distinct <span class="bound">π</span><span class="main">)</span> 
  <span class="main">∧</span> <span class="main">(</span>set <span class="bound">π</span> <span class="main">=</span> <span class="main">(</span>fset <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="keyword1">^V</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="keyword1">^E</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span> <span class="bound">v</span> <span class="bound">e</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="bound">π</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="bound">π</span> <span class="main">∧</span> <span class="bound">π</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> Inl <span class="bound">v</span> <span class="main">∧</span> <span class="bound">π</span><span class="main">!</span><span class="bound">j</span> <span class="main">=</span> Inr <span class="bound">e</span> 
    <span class="main">∧</span> <span class="bound">v</span> <span class="main">|∈|</span> fst3 <span class="bound">e</span> <span class="main">⟶</span> <span class="bound">i</span><span class="main">&lt;</span><span class="bound">j</span><span class="main">)</span> 
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j</span> <span class="bound">k</span> <span class="bound">w</span> <span class="bound">e</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="bound">π</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="bound">π</span> <span class="main">∧</span> <span class="bound">π</span><span class="main">!</span><span class="bound">j</span> <span class="main">=</span> Inr <span class="bound">e</span> <span class="main">∧</span> <span class="bound">π</span><span class="main">!</span><span class="bound">k</span> <span class="main">=</span> Inl <span class="bound">w</span> 
    <span class="main">∧</span> <span class="bound">w</span> <span class="main">|∈|</span> thd3 <span class="bound">e</span> <span class="main">⟶</span> <span class="bound">j</span><span class="main">&lt;</span><span class="bound">k</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="Ribbons_Graphical-linsD"><span class="command">lemma</span></span> linsD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∈</span> lins <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>distinct <span class="free">π</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="free">π</span> <span class="main">=</span> <span class="main">(</span>fset <span class="free">G</span><span class="keyword1">^V</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> <span class="main">(</span>set <span class="free">G</span><span class="keyword1">^E</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span> <span class="bound">v</span> <span class="bound">e</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">π</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">π</span> 
     <span class="main">∧</span> <span class="free">π</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> Inl <span class="bound">v</span> <span class="main">∧</span> <span class="free">π</span><span class="main">!</span><span class="bound">j</span> <span class="main">=</span> Inr <span class="bound">e</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">|∈|</span> fst3 <span class="bound">e</span> <span class="main">⟶</span> <span class="bound">i</span><span class="main">&lt;</span><span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">j</span> <span class="bound">k</span> <span class="bound">w</span> <span class="bound">e</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">π</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">π</span> 
     <span class="main">∧</span> <span class="free">π</span><span class="main">!</span><span class="bound">j</span> <span class="main">=</span> Inr <span class="bound">e</span> <span class="main">∧</span> <span class="free">π</span><span class="main">!</span><span class="bound">k</span> <span class="main">=</span> Inl <span class="bound">w</span> <span class="main">∧</span> <span class="bound">w</span> <span class="main">|∈|</span> thd3 <span class="bound">e</span> <span class="main">⟶</span> <span class="bound">j</span><span class="main">&lt;</span><span class="bound">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> lins_def Collect_iff<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following lemma enables the inductive definition below to be
  proved monotonic. It does this by showing how one of the premises of the
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">coms_main</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> rule can be rewritten in a form that is more verbose but 
  easier to prove monotonic.›</span></span>

<span class="keyword1" id="Ribbons_Graphical-coms_mono_helper"><span class="command">lemma</span></span> coms_mono_helper<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">π</span><span class="main">.</span> case_sum <span class="main">(</span><span class="free">coms_ass</span> <span class="main">∘</span> <span class="free">Λ</span><span class="main">)</span> <span class="main">(</span><span class="free">coms_com</span> <span class="main">∘</span> snd3<span class="main">)</span> <span class="main">(</span><span class="free">π</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">cs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">=</span> 
  <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free">π</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="free">π</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">=</span> Inl <span class="bound">v</span><span class="main">)</span> <span class="main">⟶</span> 
    <span class="free">coms_ass</span> <span class="main">(</span><span class="free">Λ</span> <span class="main">(</span>projl <span class="main">(</span><span class="free">π</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free">π</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">e</span><span class="main">.</span> <span class="main">(</span><span class="free">π</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">=</span> Inr <span class="bound">e</span><span class="main">)</span> <span class="main">⟶</span> 
    <span class="free">coms_com</span> <span class="main">(</span>snd3 <span class="main">(</span>projr <span class="main">(</span><span class="free">π</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> iffI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">!</span><span class="improper">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">coms_dia</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> function extracts a set of commands from a 
  diagram. Each command in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">coms_dia</span></span> <span class="free"><span class="free">G</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is obtained by extracting a 
  command from each of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">G</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s nodes and edges (using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">coms_ass</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> or 
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">coms_com</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> respectively), then picking a linear extension <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">π</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of 
  these nodes and edges (using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">lins</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>), and composing the extracted 
  commands in accordance with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">π</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">coms_dia</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>diagram<span class="main">,</span> command<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">coms_ass</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>assertion_gadget<span class="main">,</span> command<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">coms_com</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>command_gadget<span class="main">,</span> command<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  coms_skip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">coms_ass</span> <span class="main">(</span>Rib <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> Skip"</span></span>
<span class="main">|</span> coms_exists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">coms_dia</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⟹</span> <span class="free">coms_ass</span> <span class="main">(</span>Exists_dia <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
<span class="main">|</span> coms_basic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">coms_com</span> <span class="main">(</span>Com <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
<span class="main">|</span> coms_choice<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">coms_dia</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">;</span> <span class="free">coms_dia</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> 
    <span class="free">coms_com</span> <span class="main">(</span>Choose_dia <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">)</span> <span class="main">(</span>Choose <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> coms_loop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">coms_dia</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⟹</span> <span class="free">coms_com</span> <span class="main">(</span>Loop_dia <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">(</span>Loop <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> coms_main<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">∈</span> lins <span class="main">(</span>Graph <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Λ</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">)</span><span class="main">;</span> length <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">;</span>
    <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">.</span> case_sum <span class="main">(</span><span class="free">coms_ass</span> <span class="main">∘</span> <span class="free"><span class="bound"><span class="entity">Λ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">coms_com</span> <span class="main">∘</span> snd3<span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">coms_dia</span> <span class="main">(</span>Graph <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Λ</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">)</span> <span class="main">(</span>foldr <span class="main">(;;)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> Skip<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">monos</span></span> 
  coms_mono_helper

<span class="keyword1"><span class="command">inductive_cases</span></span> coms_skip_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"coms_ass <span class="main">(</span>Rib <span class="free">p</span><span class="main">)</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> coms_exists_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"coms_ass <span class="main">(</span>Exists_dia <span class="free">x</span> <span class="free">G</span><span class="main">)</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> coms_basic_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"coms_com <span class="main">(</span>Com <span class="free">c'</span><span class="main">)</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> coms_choice_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"coms_com <span class="main">(</span>Choose_dia <span class="free">G</span> <span class="free">H</span><span class="main">)</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> coms_loop_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"coms_com <span class="main">(</span>Loop_dia <span class="free">G</span><span class="main">)</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> coms_main_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"coms_dia <span class="free">G</span> <span class="free">c</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Ribbons_Graphical_Soundness">
<div class="head">
<h1>Theory Ribbons_Graphical_Soundness</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Soundness for graphical diagrams›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Ribbons_Graphical_Soundness <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Ribbons_Graphical">Ribbons_Graphical</a>
  <a href="#More_Finite_Map">More_Finite_Map</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We prove that the proof rules for graphical ribbon proofs are sound
  with respect to the rules of separation logic.

  We impose an additional assumption to achieve soundness: that the
  Frame rule has no side-condition. This assumption is reasonable because there
  are several separation logics that lack such a side-condition, such as
  ``variables-as-resource''.

  We first describe how to extract proofchains from a diagram. This process is
  similar to the process of extracting commands from a diagram, which was
  described in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="Ribbons_Graphical.html"></a><a href="Ribbons_Graphical.html">Ribbon_Proofs.Ribbons_Graphical</a><span class="antiquote"><span class="antiquote">}</span></span></span></span>. When we extract a proofchain, we
  don't just include the commands, but the assertions in between them. Our
  main lemma for proving soundness says that each of these proofchains
  corresponds to a valid separation logic proof.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proofstate chains›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹When extracting a proofchain from a diagram, we need to keep track
  of which nodes we have processed and which ones we haven't. A
  proofstate, defined below, maps a node to ``Top'' if it hasn't been
  processed and ``Bot'' if it has.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> topbot <span class="main">=</span> Top <span class="main">|</span> Bot

<span class="keyword1"><span class="command">type_synonym</span></span> proofstate <span class="main">=</span> <span class="quoted"><span class="quoted">"node <span class="keyword1">⇀<span class="hidden">⇩</span><sub>f</sub></span> topbot"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A proofstate chain contains all the nodes and edges of a graphical
  diagram, interspersed with proofstates that track which nodes have been
  processed at each point.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> ps_chain <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>proofstate<span class="main">,</span> node <span class="main">+</span> edge<span class="main">)</span> chain"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">next_ps</span></span> <span class="free"><span class="free">σ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> function processes one node or one edge in a
  diagram, given the current proofstate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">σ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. It processes a node
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">v</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by replacing the mapping from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">v</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Top</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with a
  mapping from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">v</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Bot</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. It processes an edge <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">e</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  (whose source and target nodes are <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">vs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">ws</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> respectively)
  by removing all the mappings from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">vs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Bot</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and adding
  mappings from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">ws</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Top</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">next_ps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"proofstate <span class="main">⇒</span> node <span class="main">+</span> edge <span class="main">⇒</span> proofstate"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_ps</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⊖</span> <span class="main">{|</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">|}</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">[</span><span class="main">{|</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">|}</span> <span class="main">|=&gt;</span> Bot<span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">next_ps</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⊖</span> fst3 <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">[</span>thd3 <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">|=&gt;</span> Top<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">mk_ps_chain</span></span> <span class="free"><span class="free">Π</span></span> <span class="free"><span class="free">π</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> generates from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">π</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which
  is a list of nodes and edges, a proofstate chain, by interspersing the
  elements of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">π</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with the appropriate proofstates. The first argument
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Π</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the part of the chain that has already been converted.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">mk_ps_chain</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>ps_chain<span class="main">,</span> <span class="main">(</span>node <span class="main">+</span> edge<span class="main">)</span> list<span class="main">]</span> <span class="main">⇒</span> ps_chain"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mk_ps_chain</span> <span class="main">≡</span> foldl <span class="main">(</span><span class="main">λ</span><span class="bound">Π</span> <span class="bound">x</span><span class="main">.</span> cSnoc <span class="bound">Π</span> <span class="bound">x</span> <span class="main">(</span>next_ps <span class="main">(</span>post <span class="bound">Π</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Ribbons_Graphical_Soundness-mk_ps_chain_preserves_length"><span class="command">lemma</span></span> mk_ps_chain_preserves_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">π</span> <span class="free">Π</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"chainlen <span class="main">(</span>mk_ps_chain <span class="free">Π</span> <span class="free">π</span><span class="main">)</span> <span class="main">=</span> chainlen <span class="free">Π</span> <span class="main">+</span> length <span class="free">π</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">π</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Π</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mk_ps_chain_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">π</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> mk_ps_chain_def list.size foldl.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> mk_ps_chain_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons len_snoc<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Distributing <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">mk_ps_chain</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> over <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Cons</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1" id="Ribbons_Graphical_Soundness-mk_ps_chain_cons"><span class="command">lemma</span></span> mk_ps_chain_cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mk_ps_chain <span class="free">Π</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">π</span><span class="main">)</span> <span class="main">=</span> mk_ps_chain <span class="main">(</span>cSnoc <span class="free">Π</span> <span class="free">x</span> <span class="main">(</span>next_ps <span class="main">(</span>post <span class="free">Π</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="free">π</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_ps_chain_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Distributing <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">mk_ps_chain</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> over <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">snoc</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1" id="Ribbons_Graphical_Soundness-mk_ps_chain_snoc"><span class="command">lemma</span></span> mk_ps_chain_snoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mk_ps_chain <span class="free">Π</span> <span class="main">(</span><span class="free">π</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>
    <span class="main">=</span> cSnoc <span class="main">(</span>mk_ps_chain <span class="free">Π</span> <span class="free">π</span><span class="main">)</span> <span class="free">x</span> <span class="main">(</span>next_ps <span class="main">(</span>post <span class="main">(</span>mk_ps_chain <span class="free">Π</span> <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mk_ps_chain_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Distributing <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">mk_ps_chain</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> over <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">cCons</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1" id="Ribbons_Graphical_Soundness-mk_ps_chain_ccons"><span class="command">lemma</span></span> mk_ps_chain_ccons<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">π</span> <span class="free">Π</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mk_ps_chain <span class="main">(</span><span class="main">⦃</span> <span class="free">σ</span> <span class="main">⦄</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">Π</span><span class="main">)</span> <span class="free">π</span> <span class="main">=</span> <span class="main">⦃</span> <span class="free">σ</span> <span class="main">⦄</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> mk_ps_chain <span class="free">Π</span> <span class="free">π</span> "</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">π</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Π</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_ps_chain_cons mk_ps_chain_def<span class="main">)</span>

<span class="keyword1" id="Ribbons_Graphical_Soundness-pre_mk_ps_chain"><span class="command">lemma</span></span> pre_mk_ps_chain<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Π</span> <span class="free">π</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pre <span class="main">(</span>mk_ps_chain <span class="free">Π</span> <span class="free">π</span><span class="main">)</span> <span class="main">=</span> pre <span class="free">Π</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">π</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Π</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_ps_chain_def mk_ps_chain_cons pre_snoc<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A chain which is obtained from the list <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">π</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, has <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">π</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  as its list of commands. The following lemma states this in a slightly
  more general form, that allows for part of the chain to have already
  been processed.›</span></span>

<span class="keyword1" id="Ribbons_Graphical_Soundness-comlist_mk_ps_chain"><span class="command">lemma</span></span> comlist_mk_ps_chain<span class="main">:</span>
  <span class="quoted"><span class="quoted">"comlist <span class="main">(</span>mk_ps_chain <span class="free">Π</span> <span class="free">π</span><span class="main">)</span> <span class="main">=</span> comlist <span class="free">Π</span> <span class="main">@</span> <span class="free">π</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">π</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Π</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_ps_chain_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">π'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> mk_ps_chain_def foldl.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">fold</span> mk_ps_chain_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons comlist_snoc<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In order to perform induction over our diagrams, we shall wish
  to obtain ``smaller'' diagrams, by removing nodes or edges. However, the
  syntax and well-formedness constraints for diagrams are such that although
  we can always remove an edge from a diagram, we cannot (in general) remove
  a node -- the resultant diagram would not be a well-formed if an edge
  connected to that node.

  Hence, we consider ``partially-processed diagrams'' <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">G</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">S</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which
  comprise a diagram <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">G</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and a set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of nodes. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> denotes
  the subset of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">G</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s initial nodes that have already been processed,
  and can be thought of as having been removed from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">G</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

  We now give an updated version of the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"lins <span class="free"><span class="free">G</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> function. This was
  originally defined in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="Ribbons_Graphical.html"></a><a href="Ribbons_Graphical.html">Ribbon_Proofs.Ribbons_Graphical</a><span class="antiquote"><span class="antiquote">}</span></span></span></span>. We provide an extra
  parameter, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which denotes the subset of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">G</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s initial nodes
  that shouldn't be included in the linear extensions.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lins2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>node fset<span class="main">,</span> diagram<span class="main">]</span> <span class="main">⇒</span> lin set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lins2</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">π</span> <span class="main">::</span> lin <span class="main">.</span>
    <span class="main">(</span>distinct <span class="bound">π</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span>set <span class="bound">π</span> <span class="main">=</span> <span class="main">(</span>fset <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="keyword1">^V</span> <span class="main">-</span> fset <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">&lt;+&gt;</span> set <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="keyword1">^E</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span> <span class="bound">v</span> <span class="bound">e</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="bound">π</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="bound">π</span>
    <span class="main">∧</span> <span class="bound">π</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> Inl <span class="bound">v</span> <span class="main">∧</span> <span class="bound">π</span><span class="main">!</span><span class="bound">j</span> <span class="main">=</span> Inr <span class="bound">e</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">|∈|</span> fst3 <span class="bound">e</span> <span class="main">⟶</span> <span class="bound">i</span><span class="main">&lt;</span><span class="bound">j</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j</span> <span class="bound">k</span> <span class="bound">w</span> <span class="bound">e</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="bound">π</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="bound">π</span>
    <span class="main">∧</span> <span class="bound">π</span><span class="main">!</span><span class="bound">j</span> <span class="main">=</span> Inr <span class="bound">e</span> <span class="main">∧</span> <span class="bound">π</span><span class="main">!</span><span class="bound">k</span> <span class="main">=</span> Inl <span class="bound">w</span> <span class="main">∧</span> <span class="bound">w</span> <span class="main">|∈|</span> thd3 <span class="bound">e</span> <span class="main">⟶</span> <span class="bound">j</span><span class="main">&lt;</span><span class="bound">k</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="Ribbons_Graphical_Soundness-lins2D"><span class="command">lemma</span></span> lins2D<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∈</span> lins2 <span class="free">S</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">π</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">π</span> <span class="main">=</span> <span class="main">(</span>fset <span class="free">G</span><span class="keyword1">^V</span> <span class="main">-</span> fset <span class="free">S</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> set <span class="free">G</span><span class="keyword1">^E</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span> <span class="bound">v</span> <span class="bound">e</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">π</span> <span class="main">;</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">π</span> <span class="main">;</span>
      <span class="free">π</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> Inl <span class="bound">v</span> <span class="main">;</span> <span class="free">π</span><span class="main">!</span><span class="bound">j</span> <span class="main">=</span> Inr <span class="bound">e</span> <span class="main">;</span> <span class="bound">v</span> <span class="main">|∈|</span> fst3 <span class="bound">e</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">i</span><span class="main">&lt;</span><span class="bound">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">k</span> <span class="bound">w</span> <span class="bound">e</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">π</span> <span class="main">;</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">π</span> <span class="main">;</span>
      <span class="free">π</span><span class="main">!</span><span class="free">j</span> <span class="main">=</span> Inr <span class="bound">e</span> <span class="main">;</span> <span class="free">π</span><span class="main">!</span><span class="bound">k</span> <span class="main">=</span> Inl <span class="bound">w</span> <span class="main">;</span> <span class="bound">w</span> <span class="main">|∈|</span> thd3 <span class="bound">e</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">j</span><span class="main">&lt;</span><span class="bound">k</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> lins2_def Collect_iff<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Ribbons_Graphical_Soundness-lins2I"><span class="command">lemma</span></span> lins2I<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">π</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">π</span> <span class="main">=</span> <span class="main">(</span>fset <span class="free">G</span><span class="keyword1">^V</span> <span class="main">-</span> fset <span class="free">S</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> set <span class="free">G</span><span class="keyword1">^E</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span> <span class="bound">v</span> <span class="bound">e</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">π</span> <span class="main">;</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">π</span> <span class="main">;</span>
      <span class="free">π</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> Inl <span class="bound">v</span> <span class="main">;</span> <span class="free">π</span><span class="main">!</span><span class="bound">j</span> <span class="main">=</span> Inr <span class="bound">e</span> <span class="main">;</span> <span class="bound">v</span> <span class="main">|∈|</span> fst3 <span class="bound">e</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">i</span><span class="main">&lt;</span><span class="bound">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span> <span class="bound">k</span> <span class="bound">w</span> <span class="bound">e</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">π</span> <span class="main">;</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">π</span> <span class="main">;</span>
      <span class="free">π</span><span class="main">!</span><span class="bound">j</span> <span class="main">=</span> Inr <span class="bound">e</span> <span class="main">;</span> <span class="free">π</span><span class="main">!</span><span class="bound">k</span> <span class="main">=</span> Inl <span class="bound">w</span> <span class="main">;</span> <span class="bound">w</span> <span class="main">|∈|</span> thd3 <span class="bound">e</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">j</span><span class="main">&lt;</span><span class="bound">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∈</span> lins2 <span class="free">S</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> lins2_def Collect_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹When <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is empty, the two definitions coincide.›</span></span>
<span class="keyword1" id="Ribbons_Graphical_Soundness-lins_is_lins2_with_empty_S"><span class="command">lemma</span></span> lins_is_lins2_with_empty_S<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lins <span class="free">G</span> <span class="main">=</span> lins2 <span class="main">{||}</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> lins_def lins2_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The first proofstate for a diagram <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">G</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is obtained by
  mapping each of its initial nodes to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Top</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">initial_ps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"diagram <span class="main">⇒</span> proofstate"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">initial_ps</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> <span class="main">[</span> initials <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">|=&gt;</span> Top <span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The first proofstate for the partially-processed diagram <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">G</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is
  obtained by mapping each of its initial nodes to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Top</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, except those
  in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which are mapped to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Bot</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">initial_ps2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>node fset<span class="main">,</span> diagram<span class="main">]</span> <span class="main">⇒</span> proofstate"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">initial_ps2</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> <span class="main">[</span> initials <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">|=&gt;</span> Top <span class="main">]</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">[</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">|=&gt;</span> Bot <span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹When <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is empty, the above two definitions coincide.›</span></span>
<span class="keyword1" id="Ribbons_Graphical_Soundness-initial_ps_is_initial_ps2_with_empty_S"><span class="command">lemma</span></span> initial_ps_is_initial_ps2_with_empty_S<span class="main">:</span>
  <span class="quoted"><span class="quoted">"initial_ps <span class="main">=</span> initial_ps2 <span class="main">{||}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> fun_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> initial_ps_def initial_ps2_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following function extracts the set of proofstate chains from
   a diagram.›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">ps_chains</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"diagram <span class="main">⇒</span> ps_chain set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ps_chains</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> mk_ps_chain <span class="main">(</span>cNil <span class="main">(</span>initial_ps <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> lins <span class="free"><span class="bound"><span class="entity">G</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following function extracts the set of proofstate chains from
   a partially-processed diagram. Nodes in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are excluded from
   the resulting chains.›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">ps_chains2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>node fset<span class="main">,</span> diagram<span class="main">]</span> <span class="main">⇒</span> ps_chain set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ps_chains2</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> mk_ps_chain <span class="main">(</span>cNil <span class="main">(</span>initial_ps2 <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> lins2 <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹When <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is empty, the above two definitions coincide.›</span></span>
<span class="keyword1" id="Ribbons_Graphical_Soundness-ps_chains_is_ps_chains2_with_empty_S"><span class="command">lemma</span></span> ps_chains_is_ps_chains2_with_empty_S<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ps_chains <span class="main">=</span> ps_chains2 <span class="main">{||}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> fun_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> ps_chains_def ps_chains2_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> initial_ps_is_initial_ps2_with_empty_S<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> lins_is_lins2_with_empty_S<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now wish to describe proofstates chain that are well-formed. First,
  let us say that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">f</span></span> <span class="keyword1"><span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span></span><span class="free"><span class="free">disjoint</span></span> <span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is defined, when <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">g</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> have disjoint domains, as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">f</span></span> <span class="keyword1"><span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span></span> <span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Then, a well-formed
  proofstate chain consists of triples of the form <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">σ</span></span> <span class="keyword1"><span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span></span><span class="free"><span class="free">disjoint</span></span>
  <span class="main"><span class="main">[</span></span><span class="main"><span class="main">{|</span></span> <span class="free"><span class="free">v</span></span> <span class="main"><span class="main">|}</span></span> <span class="main"><span class="main">|=&gt;</span></span> Top<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> Inl <span class="free"><span class="free">v</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">σ</span></span> <span class="keyword1"><span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span></span><span class="free"><span class="free">disjoint</span></span> <span class="main"><span class="main">[</span></span><span class="main"><span class="main">{|</span></span> <span class="free"><span class="free">v</span></span> <span class="main"><span class="main">|}</span></span> <span class="main"><span class="main">|=&gt;</span></span> Bot<span class="main"><span class="main">]</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">v</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  is a node, or of the form <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">σ</span></span> <span class="keyword1"><span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span></span><span class="free"><span class="free">disjoint</span></span> <span class="main"><span class="main">[</span></span><span class="main"><span class="main">{|</span></span> <span class="free"><span class="free">vs</span></span> <span class="main"><span class="main">|}</span></span> <span class="main"><span class="main">|=&gt;</span></span> Bot<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> Inr <span class="free"><span class="free">e</span></span><span class="main"><span class="main">,</span></span>
  <span class="free"><span class="free">σ</span></span> <span class="keyword1"><span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span></span><span class="free"><span class="free">disjoint</span></span> <span class="main"><span class="main">[</span></span><span class="main"><span class="main">{|</span></span> <span class="free"><span class="free">ws</span></span> <span class="main"><span class="main">|}</span></span> <span class="main"><span class="main">|=&gt;</span></span> Top<span class="main"><span class="main">]</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">e</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is an edge with source
  and target nodes <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">vs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">ws</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> respectively.

  The definition below describes a well-formed triple; we then lift this
  to complete chains shortly.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">wf_ps_triple</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"proofstate <span class="main">×</span> <span class="main">(</span>node <span class="main">+</span> edge<span class="main">)</span> <span class="main">×</span> proofstate <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_ps_triple</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> snd3 <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="keyword1">of</span>
    Inl <span class="bound">v</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">v</span> <span class="main">|∉|</span> fmdom <span class="bound">σ</span>
      <span class="main">∧</span> fst3 <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="main">[</span> <span class="main">{|</span><span class="bound">v</span><span class="main">|}</span> <span class="main">|=&gt;</span> Top <span class="main">]</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="bound">σ</span>
      <span class="main">∧</span> thd3 <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="main">[</span> <span class="main">{|</span><span class="bound">v</span><span class="main">|}</span> <span class="main">|=&gt;</span> Bot <span class="main">]</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="bound">σ</span><span class="main">)</span>
  <span class="main">|</span> Inr <span class="bound">e</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="main">(</span>fst3 <span class="bound">e</span> <span class="main">|∪|</span> thd3 <span class="bound">e</span><span class="main">)</span> <span class="main">|∩|</span> fmdom <span class="bound">σ</span> <span class="main">=</span> <span class="main">{||}</span>
      <span class="main">∧</span> fst3 <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="main">[</span> fst3 <span class="bound">e</span> <span class="main">|=&gt;</span> Bot <span class="main">]</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="bound">σ</span>
      <span class="main">∧</span> thd3 <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="main">[</span> thd3 <span class="bound">e</span> <span class="main">|=&gt;</span> Top <span class="main">]</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Ribbons_Graphical_Soundness-wf_ps_triple_nodeI"><span class="command">lemma</span></span> wf_ps_triple_nodeI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="free">v</span> <span class="main">|∉|</span> fmdom <span class="bound">σ</span>  <span class="main">∧</span>
    <span class="free">σ1</span> <span class="main">=</span> <span class="main">[</span> <span class="main">{|</span><span class="free">v</span><span class="main">|}</span> <span class="main">|=&gt;</span> Top <span class="main">]</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="bound">σ</span> <span class="main">∧</span>
    <span class="free">σ2</span> <span class="main">=</span> <span class="main">[</span> <span class="main">{|</span><span class="free">v</span><span class="main">|}</span> <span class="main">|=&gt;</span> Bot <span class="main">]</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_ps_triple <span class="main">(</span><span class="free">σ1</span><span class="main">,</span> Inl <span class="free">v</span><span class="main">,</span> <span class="free">σ2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wf_ps_triple_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fst3_simp snd3_simp thd3_simp<span class="main">)</span>

<span class="keyword1" id="Ribbons_Graphical_Soundness-wf_ps_triple_edgeI"><span class="command">lemma</span></span> wf_ps_triple_edgeI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="main">(</span>fst3 <span class="free">e</span> <span class="main">|∪|</span> thd3 <span class="free">e</span><span class="main">)</span> <span class="main">|∩|</span> fmdom <span class="bound">σ</span> <span class="main">=</span> <span class="main">{||}</span>
      <span class="main">∧</span> <span class="free">σ1</span> <span class="main">=</span> <span class="main">[</span> fst3 <span class="free">e</span> <span class="main">|=&gt;</span> Bot <span class="main">]</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="bound">σ</span>
      <span class="main">∧</span> <span class="free">σ2</span> <span class="main">=</span> <span class="main">[</span> thd3 <span class="free">e</span> <span class="main">|=&gt;</span> Top <span class="main">]</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_ps_triple <span class="main">(</span><span class="free">σ1</span><span class="main">,</span> Inr <span class="free">e</span><span class="main">,</span> <span class="free">σ2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wf_ps_triple_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fst3_simp snd3_simp thd3_simp<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">wf_ps_chain</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ps_chain <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_ps_chain</span> <span class="main">≡</span> chain_all wf_ps_triple"</span></span>

<span class="keyword1" id="Ribbons_Graphical_Soundness-next_initial_ps2_vertex"><span class="command">lemma</span></span> next_initial_ps2_vertex<span class="main">:</span>
  <span class="quoted"><span class="quoted">"initial_ps2 <span class="main">(</span><span class="main">{|</span><span class="free">v</span><span class="main">|}</span> <span class="main">|∪|</span> <span class="free">S</span><span class="main">)</span> <span class="free">G</span>
  <span class="main">=</span> initial_ps2 <span class="free">S</span> <span class="free">G</span> <span class="main">⊖</span> <span class="main">{|</span><span class="free">v</span><span class="main">|}</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">[</span> <span class="main">{|</span><span class="free">v</span><span class="main">|}</span> <span class="main">|=&gt;</span> Bot <span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> initial_ps2_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> make_map_def map_diff_def map_add_def restrict_map_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Ribbons_Graphical_Soundness-next_initial_ps2_edge"><span class="command">lemma</span></span> next_initial_ps2_edge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">=</span> Graph <span class="free">V</span> <span class="free">Λ</span> <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">G'</span> <span class="main">=</span> Graph <span class="free">V'</span> <span class="free">Λ</span> <span class="free">E'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">V'</span> <span class="main">=</span> <span class="free">V</span> <span class="main">-</span> fst3 <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">E'</span> <span class="main">=</span> removeAll <span class="free">e</span> <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> set <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"fst3 <span class="free">e</span> <span class="main">|⊆|</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">|⊆|</span> initials <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf_dia <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"initial_ps2 <span class="main">(</span><span class="free">S</span> <span class="main">-</span> fst3 <span class="free">e</span><span class="main">)</span> <span class="free">G'</span> <span class="main">=</span>
  initial_ps2 <span class="free">S</span> <span class="free">G</span> <span class="main">⊖</span> fst3 <span class="free">e</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">[</span> thd3 <span class="free">e</span> <span class="main">|=&gt;</span> Top <span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> initial_ps2_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">G</span> <span class="skolem">V</span> <span class="skolem">Λ</span> <span class="skolem">E</span> <span class="skolem">G'</span> <span class="skolem">V'</span> <span class="skolem">E'</span> <span class="skolem">e</span> <span class="skolem">S</span>
  <span class="keyword3"><span class="command">assume</span></span> G_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">=</span> Graph <span class="skolem">V</span> <span class="skolem">Λ</span> <span class="skolem">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> G'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">G'</span> <span class="main">=</span> Graph <span class="skolem">V'</span> <span class="skolem">Λ</span> <span class="skolem">E'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    V'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">V'</span> <span class="main">=</span> <span class="skolem">V</span> <span class="main">-</span> fst3 <span class="skolem">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> E'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E'</span> <span class="main">=</span> removeAll <span class="skolem">e</span> <span class="skolem">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    e_in_E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> set <span class="skolem">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fst_e_in_S<span class="main">:</span> <span class="quoted"><span class="quoted">"fst3 <span class="skolem">e</span> <span class="main">|⊆|</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    S_initials<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">|⊆|</span> initials <span class="skolem">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wf_G<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dia <span class="skolem">G</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"thd3 <span class="skolem">e</span> <span class="main">|∩|</span> initials <span class="skolem">G</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> initials_def G_def e_in_E<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"make_map <span class="main">(</span>initials <span class="skolem">G'</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> fst3 <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> Top <span class="main">++</span> make_map <span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> fst3 <span class="skolem">e</span><span class="main">)</span> Bot
    <span class="main">=</span> map_diff <span class="main">(</span>make_map <span class="main">(</span>initials <span class="skolem">G</span> <span class="main">-</span> <span class="skolem">S</span><span class="main">)</span> Top <span class="main">++</span> make_map <span class="skolem">S</span> Bot<span class="main">)</span> <span class="main">(</span>fst3 <span class="skolem">e</span><span class="main">)</span>
        <span class="main">++</span> make_map <span class="main">(</span>thd3 <span class="skolem">e</span><span class="main">)</span> Top"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> make_map_def map_diff_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> map_add_def restrict_map_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> minus_fset<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> fun_eq_iff initials_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> G_def G'_def V'_def E'_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> edges.simps vertices.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_fset.rep_eq fmember.rep_eq e_in_E<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> <span class="quoted"><span class="quoted">‹thd3 <span class="skolem">e</span> <span class="main">|∩|</span> initials <span class="skolem">G</span> <span class="main">=</span> <span class="main">{||}</span>›</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> S_initials<span class="main"><span class="keyword3">,</span></span> <span class="operator">fold</span> fset_cong<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> less_eq_fset.rep_eq initials_def filter_fset<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmember.rep_eq G_def e_in_E<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmember.rep_eq G_def e_in_E<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmember.rep_eq G_def e_in_E<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> wf_G<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> G_def vertices.simps edges.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> wf_dia_inv<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> acyclicity_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> fst_e_in_S inter_fset le_iff_inf subsetD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> wf_G<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> G_def vertices.simps edges.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> wf_dia_inv<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> linearityD2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> fset_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> inter_fset fset_simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> e_in_E<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> wf_G<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> G_def vertices.simps edges.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> wf_dia_inv<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> e_in_E G_def empty_iff fset_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
    finter_iff linearityD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> notin_fset wf_G wf_dia_inv<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> wf_G<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> G_def vertices.simps edges.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> wf_dia_inv<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> linearityD2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> fset_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> inter_fset fset_simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> e_in_E<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> wf_G<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> G_def vertices.simps edges.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> wf_dia_inv<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> e_in_E G_def empty_iff fset_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
    finter_iff linearityD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> notin_fset wf_G wf_dia_inv<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> wf_G<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> G_def vertices.simps edges.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> wf_dia_inv<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> less_eq_fset.rep_eq union_fset<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> wf_dia_inv<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> less_eq_fset.rep_eq union_fset<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> wf_dia_inv<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> less_eq_fset.rep_eq union_fset<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> e_in_E<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> wf_dia_inv<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> less_eq_fset.rep_eq union_fset<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> e_in_E<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ribbons_Graphical_Soundness-next_lins2_vertex"><span class="command">lemma</span></span> next_lins2_vertex<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Inl <span class="free">v</span> <span class="main">#</span> <span class="free">π</span> <span class="main">∈</span> lins2 <span class="free">S</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">|∉|</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∈</span> lins2 <span class="main">(</span><span class="main">{|</span><span class="free">v</span><span class="main">|}</span> <span class="main">|∪|</span> <span class="free">S</span><span class="main">)</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> lins2D <span class="main">=</span> lins2D<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> lins2I<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">π</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lins2D<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">π</span> <span class="main">=</span> set <span class="main">(</span>Inl <span class="free">v</span> <span class="main">#</span> <span class="free">π</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span>Inl <span class="free">v</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lins2D<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>fset <span class="free">G</span><span class="keyword1">^V</span> <span class="main">-</span> fset <span class="main">(</span><span class="main">{|</span><span class="free">v</span><span class="main">|}</span> <span class="main">|∪|</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> set <span class="free">G</span><span class="keyword1">^E</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lins2D<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="free">π</span> <span class="main">=</span> <span class="main">(</span>fset <span class="free">G</span><span class="keyword1">^V</span> <span class="main">-</span> fset <span class="main">(</span><span class="main">{|</span><span class="free">v</span><span class="main">|}</span> <span class="main">|∪|</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> set <span class="free">G</span><span class="keyword1">^E</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">v</span> <span class="skolem">e</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">π</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">π</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> Inl <span class="skolem">v</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Inr <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">|∈|</span> fst3 <span class="skolem">e</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lins2D<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">+</span><span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="skolem">k</span> <span class="skolem">w</span> <span class="skolem">e</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">π</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">π</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Inr <span class="skolem">e</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> Inl <span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">|∈|</span> thd3 <span class="skolem">e</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lins2D<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">+</span><span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ribbons_Graphical_Soundness-next_lins2_edge"><span class="command">lemma</span></span> next_lins2_edge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Inr <span class="free">e</span> <span class="main">#</span> <span class="free">π</span> <span class="main">∈</span> lins2 <span class="free">S</span> <span class="main">(</span>Graph <span class="free">V</span> <span class="free">Λ</span> <span class="free">E</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">|⊆|</span> <span class="free">S</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="free">vs</span><span class="main">,</span><span class="free">c</span><span class="main">,</span><span class="free">ws</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∈</span> lins2 <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>Graph <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="free">vs</span><span class="main">)</span> <span class="free">Λ</span> <span class="main">(</span>removeAll <span class="free">e</span> <span class="free">E</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> lins2D <span class="main">=</span> lins2D<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> lins2I<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> vertices.simps edges.simps<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">π</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lins2D<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="free">π</span> <span class="main">=</span> <span class="main">(</span>fset <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="free">vs</span><span class="main">)</span> <span class="main">-</span> fset <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="free">vs</span><span class="main">)</span><span class="main">)</span>
      <span class="main">&lt;+&gt;</span> set <span class="main">(</span>removeAll <span class="free">e</span> <span class="free">E</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> lins2D<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> lins2D<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> vertices.simps edges.simps less_eq_fset.rep_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> diff_diff_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="bound">aa</span> <span class="bound">b</span><span class="main">.</span>
       insert <span class="main">(</span>Inr <span class="main">(</span><span class="free">vs</span><span class="main">,</span> <span class="free">c</span><span class="main">,</span> <span class="free">ws</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="free">π</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fset <span class="free">V</span> <span class="main">-</span> fset <span class="free">S</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> set <span class="free">E</span> <span class="main">⟶</span>
       fset <span class="free">vs</span> <span class="main">⊆</span> fset <span class="free">S</span> <span class="main">⟶</span>
       Inr <span class="main">(</span><span class="free">vs</span><span class="main">,</span> <span class="free">c</span><span class="main">,</span> <span class="free">ws</span><span class="main">)</span> <span class="main">∉</span> set <span class="free">π</span> <span class="main">⟶</span>
       distinct <span class="free">π</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">aa</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">E</span> <span class="main">⟶</span> Inr <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">aa</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∉</span> set <span class="free">π</span> <span class="main">⟶</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">ws</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> InrI List.set_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
      prod.inject set_ConsD sum.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

     <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="bound">aa</span> <span class="bound">b</span><span class="main">.</span>
       insert <span class="main">(</span>Inr <span class="main">(</span><span class="free">vs</span><span class="main">,</span> <span class="free">c</span><span class="main">,</span> <span class="free">ws</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="free">π</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fset <span class="free">V</span> <span class="main">-</span> fset <span class="free">S</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> set <span class="free">E</span> <span class="main">⟶</span>
       fset <span class="free">vs</span> <span class="main">⊆</span> fset <span class="free">S</span> <span class="main">⟶</span>
       Inr <span class="main">(</span><span class="free">vs</span><span class="main">,</span> <span class="free">c</span><span class="main">,</span> <span class="free">ws</span><span class="main">)</span> <span class="main">∉</span> set <span class="free">π</span> <span class="main">⟶</span>
       distinct <span class="free">π</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">aa</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">E</span> <span class="main">⟶</span> Inr <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">aa</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∉</span> set <span class="free">π</span> <span class="main">⟶</span> <span class="bound">aa</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> InrI List.set_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
      prod.inject set_ConsD sum.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

     <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> insert <span class="main">(</span>Inr <span class="main">(</span><span class="free">vs</span><span class="main">,</span> <span class="free">c</span><span class="main">,</span> <span class="free">ws</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="free">π</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fset <span class="free">V</span> <span class="main">-</span> fset <span class="free">S</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> set <span class="free">E</span> <span class="main">⟶</span>
         fset <span class="free">vs</span> <span class="main">⊆</span> fset <span class="free">S</span> <span class="main">⟶</span>
         Inr <span class="main">(</span><span class="free">vs</span><span class="main">,</span> <span class="free">c</span><span class="main">,</span> <span class="free">ws</span><span class="main">)</span> <span class="main">∉</span> set <span class="free">π</span> <span class="main">⟶</span>
         distinct <span class="free">π</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">π</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>fset <span class="free">V</span> <span class="main">-</span> fset <span class="free">S</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> set <span class="free">E</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">vs</span><span class="main">,</span> <span class="free">c</span><span class="main">,</span> <span class="free">ws</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> insert_is_Un<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"set <span class="free"><span class="free">π</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"set <span class="free">π</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>fset <span class="free">V</span> <span class="main">-</span> fset <span class="free">S</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> set <span class="free">E</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span>Inr <span class="free">e</span><span class="main">}</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Inr <span class="main">(</span><span class="free">vs</span><span class="main">,</span> <span class="free">c</span><span class="main">,</span> <span class="free">ws</span><span class="main">)</span> <span class="main">∉</span> set <span class="free">π</span> <span class="main">∧</span> distinct <span class="free">π</span> <span class="main">⟹</span>
      insert <span class="main">(</span>Inr <span class="main">(</span><span class="free">vs</span><span class="main">,</span> <span class="free">c</span><span class="main">,</span> <span class="free">ws</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="free">π</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fset <span class="free">V</span> <span class="main">-</span> fset <span class="free">S</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> set <span class="free">E</span> <span class="main">⟹</span>
      fset <span class="free">vs</span> <span class="main">⊆</span> fset <span class="free">S</span> <span class="main">⟹</span> set <span class="free">π</span> <span class="main">=</span> <span class="main">(</span>fset <span class="free">V</span> <span class="main">-</span> fset <span class="free">S</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> set <span class="free">E</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">vs</span><span class="main">,</span> <span class="free">c</span><span class="main">,</span> <span class="free">ws</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">v</span> <span class="skolem">e</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">π</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">π</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> Inl <span class="skolem">v</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Inr <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">|∈|</span> fst3 <span class="skolem">e</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lins2D<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">+</span><span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="skolem">k</span> <span class="skolem">w</span> <span class="skolem">e</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">π</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">π</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Inr <span class="skolem">e</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> Inl <span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">|∈|</span> thd3 <span class="skolem">e</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lins2D<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">+</span><span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We wish to prove that every proofstate chain that can be obtained from
  a linear extension of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">G</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is well-formed and has as its final
  proofstate that state in which every terminal node in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">G</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is mapped
  to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Bot</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

  We first prove this for partially-processed diagrams, for
  then the result for ordinary diagrams follows as an easy corollary.

  We use induction on the size of the partially-processed diagram. The size of
  a partially-processed diagram <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">G</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">S</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is defined as the number of
  nodes in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">G</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, plus the number of edges, minus the number of nodes in
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> fmember.rep_eq

<span class="keyword1" id="Ribbons_Graphical_Soundness-wf_chains2"><span class="command">lemma</span></span> wf_chains2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">|⊆|</span> initials <span class="free">G</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf_dia <span class="free">G</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Π</span> <span class="main">∈</span> ps_chains2 <span class="free">S</span> <span class="free">G</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fcard <span class="free">G</span><span class="keyword1">^V</span> <span class="main">+</span> length <span class="free">G</span><span class="keyword1">^E</span> <span class="main">=</span> <span class="free">k</span> <span class="main">+</span> fcard <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_ps_chain <span class="free">Π</span> <span class="main">∧</span> <span class="main">(</span>post <span class="free">Π</span> <span class="main">=</span> <span class="main">[</span> terminals <span class="free">G</span> <span class="main">|=&gt;</span> Bot <span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="free">Π</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">V</span></span> <span class="skolem"><span class="skolem">Λ</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="keyword2"><span class="keyword">where</span></span> G_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">=</span> Graph <span class="skolem">V</span> <span class="skolem">Λ</span> <span class="skolem">E</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diagram.exhaust<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">|⊆|</span> <span class="skolem">V</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>1<span class="main">)</span> initials_in_vertices<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> G_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fcard <span class="skolem">V</span> <span class="main">≤</span> fcard <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> G_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> fcard_seteq<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">|⊆|</span> <span class="skolem">V</span>›</span></span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="skolem">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> G_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"initials <span class="skolem">G</span> <span class="main">=</span> <span class="skolem">V</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> G_def <span class="quoted"><span class="quoted">‹<span class="skolem">E</span><span class="main">=</span><span class="main">[]</span>›</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> no_edges_imp_all_nodes_initial<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"terminals <span class="skolem">G</span> <span class="main">=</span> <span class="skolem">V</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> G_def <span class="quoted"><span class="quoted">‹<span class="skolem">E</span><span class="main">=</span><span class="main">[]</span>›</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> no_edges_imp_all_nodes_terminal<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">&lt;+&gt;</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lins2 <span class="skolem">S</span> <span class="skolem">G</span> <span class="main">=</span> <span class="main">{</span> <span class="main">[]</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> G_def <span class="quoted"><span class="quoted">‹<span class="skolem">S</span><span class="main">=</span><span class="skolem">V</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">E</span><span class="main">=</span><span class="main">[]</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> lins2_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{}</span> <span class="main">&lt;+&gt;</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">hence</span></span> Π_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Π</span> <span class="main">=</span> <span class="main">⦃</span> initial_ps2 <span class="skolem">S</span> <span class="skolem">G</span> <span class="main">⦄</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ps_chains2_def mk_ps_chain_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> Π_def wf_ps_chain_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> post.simps initial_ps2_def <span class="quoted"><span class="quoted">‹initials <span class="skolem">G</span> <span class="main">=</span> <span class="skolem">V</span>›</span></span> <span class="quoted"><span class="quoted">‹terminals <span class="skolem">G</span> <span class="main">=</span> <span class="skolem">V</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span><span class="main">=</span><span class="skolem">V</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">-</span> <span class="skolem">V</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">V</span></span> <span class="skolem"><span class="skolem">Λ</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="keyword2"><span class="keyword">where</span></span> G_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">=</span> Graph <span class="skolem">V</span> <span class="skolem">Λ</span> <span class="skolem">E</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diagram.exhaust<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    Π_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Π</span> <span class="main">=</span> mk_ps_chain <span class="main">⦃</span> initial_ps2 <span class="skolem">S</span> <span class="skolem">G</span> <span class="main">⦄</span> <span class="skolem">π</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    π_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">∈</span> lins2 <span class="skolem">S</span> <span class="skolem">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ps_chains2_def<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> lins2 <span class="main">=</span> lins2D<span class="main">[</span><span class="operator">OF</span> π_in<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">|⊆|</span> <span class="skolem">V</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> initials_in_vertices<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> G_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">π</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">from</span></span> π_in <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">-</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">=</span> <span class="main">[]</span>›</span></span> lins2_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> empty_eq_Plus_conv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> G_def vertices.simps edges.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">|⊆|</span> <span class="skolem">V</span>›</span></span> less_eq_fset.rep_eq subset_antisym<span class="main">)</span>

    <span class="keyword1"><span class="command">with</span></span> Suc.prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> G_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">π'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> π_def <span class="main">=</span> this
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">v</span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> x_def <span class="main">=</span> this

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">|∉|</span> <span class="skolem">S</span> <span class="main">∧</span> <span class="skolem">v</span> <span class="main">|∈|</span> <span class="skolem">V</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> fset <span class="skolem">V</span> <span class="main">-</span> fset <span class="skolem">S</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Inl <span class="skolem">v</span> <span class="main">∈</span> <span class="main">(</span>fset <span class="skolem">V</span> <span class="main">-</span> fset <span class="skolem">S</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> set <span class="skolem">E</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Inl_inject Inr_not_Inl PlusE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> lins2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> lins2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Cons G_def Inl distinct.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
        distinct_length_2_or_more edges.simps vertices.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">hence</span></span> v_notin_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">|∉|</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v_in_V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">|∈|</span> <span class="skolem">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> v_initial_not_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">|∈|</span> initials <span class="skolem">G</span> <span class="main">-</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> G_def initials_def vertices.simps edges.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> fminus_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> conj_commute<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> v_notin_S<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span>
        <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> fset <span class="main">(</span>ffilter <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">∀</span><span class="bound">e</span><span class="main">∈</span>set <span class="skolem">E</span><span class="main">.</span> <span class="bound">v</span> <span class="main">|∉|</span> thd3 <span class="bound">e</span><span class="main">)</span> <span class="skolem">V</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> filter_fset<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> conj_commute<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI ballI notI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> v_in_V<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="main">::</span> <span class="quoted">edge</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> fset <span class="main">(</span>thd3 <span class="skolem">e</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">|∈|</span> <span class="main">(</span>thd3 <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> set <span class="skolem">E</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Inr <span class="skolem">e</span> <span class="main">∈</span> set <span class="skolem">π</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lins2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> G_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">π</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">π</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span><span class="main">!</span><span class="skolem">j</span> <span class="main">=</span> Inr <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span><span class="main">!</span><span class="main">0</span> <span class="main">=</span> Inl <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> π_def x_def in_set_conv_nth length_pos_if_in_set nth_Cons_0<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> lins2<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">|∈|</span> <span class="main">(</span>thd3 <span class="skolem">e</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S'</span> <span class="main">=</span> <span class="main">{|</span><span class="skolem">v</span><span class="main">|}</span> <span class="main">|∪|</span> <span class="skolem">S</span>"</span></span>

      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Π'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Π'</span> <span class="main">=</span> mk_ps_chain <span class="main">⦃</span> initial_ps2 <span class="skolem">S'</span> <span class="skolem">G</span> <span class="main">⦄</span> <span class="skolem">π'</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> pre_Π'<span class="main">:</span> <span class="quoted"><span class="quoted">"pre <span class="skolem">Π'</span> <span class="main">=</span> initial_ps2 <span class="skolem">S'</span> <span class="skolem">G</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> pre.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pre_mk_ps_chain<span class="main">)</span>

      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">=</span> <span class="main">[</span> initials <span class="skolem">G</span> <span class="main">-</span> <span class="main">(</span><span class="main">{|</span><span class="skolem">v</span><span class="main">|}</span> <span class="main">|∪|</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">|=&gt;</span> Top <span class="main">]</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">[</span> <span class="skolem">S</span> <span class="main">|=&gt;</span> Bot <span class="main">]</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_ps_chain <span class="skolem">Π'</span> <span class="main">∧</span> <span class="main">(</span>post <span class="skolem">Π'</span> <span class="main">=</span> <span class="main">[</span>terminals <span class="skolem">G</span> <span class="main">|=&gt;</span> Bot<span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> Suc.hyps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">S'</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S'</span> <span class="main">|⊆|</span> initials <span class="skolem">G</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> S'_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> fmember.rep_eq fminus_iff v_initial_not_S<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fmember.rep_eq fset_rev_mp<span class="main">)</span>
     <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_dia <span class="skolem">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Π'</span> <span class="main">∈</span> ps_chains2 <span class="skolem">S'</span> <span class="skolem">G</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> ps_chains2_def Π'_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> imageI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> S'_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> next_lins2_vertex<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> x_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">fold</span> π_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> π_in<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> v_notin_S<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fcard <span class="skolem">G</span><span class="keyword1">^V</span> <span class="main">+</span> length <span class="skolem">G</span><span class="keyword1">^E</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">+</span> fcard <span class="skolem">S'</span>"</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> S'_def<span class="main">)</span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> fcard_finsert_disjoint<span class="main"><span class="main">[</span></span><span class="operator">OF</span> v_notin_S<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span>
        wf_Π'<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_ps_chain <span class="skolem">Π'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        post_Π'<span class="main">:</span> <span class="quoted"><span class="quoted">"post <span class="skolem">Π'</span> <span class="main">=</span> <span class="main">[</span>terminals <span class="skolem">G</span> <span class="main">|=&gt;</span> Bot<span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"fmdom <span class="main">[</span> <span class="main">{|</span><span class="skolem">v</span><span class="main">|}</span> <span class="main">|=&gt;</span> Bot <span class="main">]</span>
        <span class="main">|∩|</span> fmdom <span class="main">(</span><span class="main">[</span> initials <span class="skolem">G</span> <span class="main">-</span> <span class="main">(</span><span class="main">{|</span><span class="skolem">v</span><span class="main">|}</span> <span class="main">|∪|</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">|=&gt;</span> Top <span class="main">]</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span>
     <span class="main">[</span> <span class="skolem">S</span> <span class="main">|=&gt;</span> Bot <span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> fdom_make_fmap fmdom_add
          bot_least funion_iff finter_finsert_left le_iff_inf
          fminus_iff finsert_fsubset sup_ge1 v_initial_not_S<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_ps_chain <span class="skolem">Π</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">unfold_abs_def</span> <span class="main"><span class="main">=</span></span> <span class="quasi_keyword">false</span><span class="main">]</span><span class="main">]</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Π_def π_def x_def mk_ps_chain_cons<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> mk_ps_chain_ccons<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> next_initial_ps2_vertex S'_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> Π'_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> wf_ps_chain_def chain_all.simps conj_commute<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> wf_ps_chain_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> wf_Π'<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> wf_ps_triple_nodeI exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">σ</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> σ_def fmdom_add fdom_make_fmap<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> finsertI1 fminus_iff funion_iff v_notin_S<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> pre_Π' initial_ps2_def S'_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> fmap_add_commute<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 1<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> fmadd_assoc<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> fmadd_assoc<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="main"><span class="main">|=&gt;</span></span> Bot <span class="main"><span class="main">]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> make_fmap_union sup.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{|</span></span><span class="skolem"><span class="skolem">v</span></span><span class="main"><span class="main">|}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> fminus_funion<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> v_initial_not_S <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> finsert_absorb finsert_fminus_single finter_fminus
            inf_commute inf_idem v_initial_not_S<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"post <span class="skolem">Π</span> <span class="main">=</span> <span class="main">[</span> terminals <span class="skolem">G</span> <span class="main">|=&gt;</span> Bot <span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> Π_def π_def x_def mk_ps_chain_cons<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> mk_ps_chain_ccons post.simps<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> next_initial_ps2_vertex S'_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> Π'_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> post_Π'<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">e</span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> x_def <span class="main">=</span> this
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> fst3 <span class="skolem">e</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">=</span> thd3 <span class="skolem">e</span>"</span></span>

      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> e_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">c</span><span class="main">,</span> <span class="skolem">ws</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> vs_def ws_def fst3_simp thd3_simp prod_cases3<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linearity <span class="skolem">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"acyclicity <span class="skolem">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        e_in_V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> set <span class="skolem">E</span> <span class="main">⟹</span> fst3 <span class="bound">e</span> <span class="main">|∪|</span> thd3 <span class="bound">e</span> <span class="main">|⊆|</span> <span class="skolem">V</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> wf_dia_inv<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> G_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">note</span></span> lin <span class="main">=</span> linearityD<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span>

      <span class="keyword1"><span class="command">have</span></span> acy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> set <span class="skolem">E</span> <span class="main">⟹</span> fst3 <span class="bound">e</span> <span class="main">|∩|</span> thd3 <span class="bound">e</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> fset_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> <span class="quoted"><span class="quoted">‹acyclicity <span class="skolem">E</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> acyclicity_def acyclic_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

      <span class="keyword1"><span class="command">note</span></span> lins <span class="main">=</span> lins2D<span class="main">[</span><span class="operator">OF</span> π_in<span class="main">]</span>

      <span class="keyword1"><span class="command">have</span></span> e_in_E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> set <span class="skolem">E</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"set <span class="skolem">π</span> <span class="main">=</span> <span class="main">(</span>fset <span class="skolem">G</span><span class="keyword1">^V</span> <span class="main">-</span> fset <span class="skolem">S</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> set <span class="skolem">G</span><span class="keyword1">^E</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> π_def x_def G_def edges.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lins<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

      <span class="keyword1"><span class="command">have</span></span> vs_in_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">|⊆|</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> e_in_V<span class="main"><span class="main">[</span></span><span class="operator">OF</span> e_in_E<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> less_eq_fset.rep_eq<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> subsetI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> vs_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">∈</span> fset <span class="skolem">V</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
        <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> fset <span class="main">(</span>fst3 <span class="skolem">e</span><span class="main">)</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> fset <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> fset <span class="skolem">V</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Inl <span class="skolem">v</span> <span class="main">∈</span> set <span class="skolem">π</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> DiffI G_def InlI lins<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> vertices.simps<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">π</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">π</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> Inl <span class="skolem">v</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">π</span><span class="main">!</span><span class="main">0</span> <span class="main">=</span> Inr <span class="skolem">e</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons Inr in_set_conv_nth length_pos_if_in_set nth_Cons_0<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> lins<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">|∩|</span> <span class="main">(</span>initials <span class="skolem">G</span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> e_in_V<span class="main"><span class="main">[</span></span><span class="operator">OF</span> e_in_E<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> initials_def less_eq_fset.rep_eq fmember.rep_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">fold</span> fset_cong<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> ws_def G_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> e_in_E<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S'</span> <span class="main">=</span> <span class="skolem">S</span> <span class="main">-</span> <span class="skolem">vs</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">V'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V'</span> <span class="main">=</span> <span class="skolem">V</span> <span class="main">-</span> <span class="skolem">vs</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">E'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E'</span> <span class="main">=</span> removeAll <span class="skolem">e</span> <span class="skolem">E</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">G'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G'</span> <span class="main">=</span> Graph <span class="skolem">V'</span> <span class="skolem">Λ</span> <span class="skolem">E'</span>"</span></span>

      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Π'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Π'</span> <span class="main">=</span> mk_ps_chain <span class="main">⦃</span> initial_ps2 <span class="skolem">S'</span> <span class="skolem">G'</span> <span class="main">⦄</span> <span class="skolem">π'</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> pre_Π'<span class="main">:</span> <span class="quoted"><span class="quoted">"pre <span class="skolem">Π'</span> <span class="main">=</span> initial_ps2 <span class="skolem">S'</span> <span class="skolem">G'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> pre.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pre_mk_ps_chain<span class="main">)</span>

      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">=</span> <span class="main">[</span> initials <span class="skolem">G</span> <span class="main">-</span> <span class="skolem">S</span> <span class="main">|=&gt;</span> Top <span class="main">]</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">[</span> <span class="skolem">S</span> <span class="main">-</span> <span class="skolem">vs</span> <span class="main">|=&gt;</span> Bot <span class="main">]</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> next_initial_ps2<span class="main">:</span> <span class="quoted"><span class="quoted">"initial_ps2 <span class="skolem">S'</span> <span class="skolem">G'</span>
        <span class="main">=</span> initial_ps2 <span class="skolem">S</span> <span class="skolem">G</span> <span class="main">⊖</span> <span class="skolem">vs</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">[</span><span class="skolem">ws</span> <span class="main">|=&gt;</span> Top<span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> next_initial_ps2_edge<span class="main">[</span><span class="operator">OF</span> G_def _ _ _ e_in_E _ Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
        Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> G'_def E'_def vs_def ws_def V'_def vs_in_S S'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_ps_chain <span class="skolem">Π'</span> <span class="main">∧</span> post <span class="skolem">Π'</span> <span class="main">=</span> <span class="main">[</span> terminals <span class="skolem">G'</span> <span class="main">|=&gt;</span> Bot <span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> Suc.hyps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">S'</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S'</span> <span class="main">|⊆|</span> initials <span class="skolem">G'</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> G'_def G_def initials_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> less_eq_fset.rep_eq S'_def E'_def V'_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">from</span></span> Suc.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_dia <span class="main">(</span>Graph <span class="skolem">V</span> <span class="skolem">Λ</span> <span class="skolem">E</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> G_def<span class="main">)</span>
        <span class="keyword1"><span class="command">note</span></span> wf_G <span class="main">=</span> wf_dia_inv<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_dia <span class="skolem">G'</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> G'_def V'_def E'_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> wf_G e_in_E vs_in_S Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> vs_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> wf_dia<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> linearity_def initials_def G_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> fset_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> less_eq_fset.rep_eq fmember.rep_eq<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> acyclicity_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> acyclic_subset<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_removeAll<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> IntI empty_iff<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Π'</span> <span class="main">∈</span> ps_chains2 <span class="skolem">S'</span> <span class="skolem">G'</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> Π_def Π'_def ps_chains2_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> imageI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> S'_def G'_def V'_def E'_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> next_lins2_edge<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> π_def G_def x_def π_in<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> vs_in_S e_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">|⊆|</span> <span class="skolem">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">|⊆|</span> <span class="skolem">V</span>›</span></span> order_trans vs_in_S<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">E</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹linearity <span class="skolem">E</span>›</span></span> linearity_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fcard <span class="skolem">G'</span><span class="keyword1">^V</span> <span class="main">+</span> length <span class="skolem">G'</span><span class="keyword1">^E</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">+</span> fcard <span class="skolem">S'</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> Suc.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> G_def G'_def vertices.simps edges.simps<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> V'_def E'_def S'_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> fcard_funion_fsubset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">vs</span> <span class="main">|⊆|</span> <span class="skolem">V</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> fcard_funion_fsubset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">vs</span> <span class="main">|⊆|</span> <span class="skolem">S</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> distinct_remove1_removeAll<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹distinct <span class="skolem">E</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> length_remove1<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> e_in_E<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">-</span></span> fcard <span class="skolem"><span class="skolem">vs</span></span> <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">1</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> add_diff_assoc2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fcard_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">vs</span> <span class="main">|⊆|</span> <span class="skolem">V</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> add_diff_assoc<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> length_pos_if_in_set<span class="main"><span class="main">[</span></span><span class="operator">OF</span> e_in_E<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">arith</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> add_diff_assoc<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fcard_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">vs</span> <span class="main">|⊆|</span> <span class="skolem">S</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span>
        wf_Π'<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_ps_chain <span class="skolem">Π'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        post_Π'<span class="main">:</span> <span class="quoted"><span class="quoted">"post <span class="skolem">Π'</span> <span class="main">=</span> <span class="main">[</span> terminals <span class="skolem">G'</span> <span class="main">|=&gt;</span> Bot <span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> terms_same<span class="main">:</span> <span class="quoted"><span class="quoted">"terminals <span class="skolem">G</span> <span class="main">=</span> terminals <span class="skolem">G'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> G'_def G_def terminals_def edges.simps vertices.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> E'_def V'_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> fset_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> e_in_E vs_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"fmdom <span class="main">[</span> fst3 <span class="skolem">e</span> <span class="main">|=&gt;</span> Bot <span class="main">]</span> <span class="main">|∩|</span>
        fmdom<span class="main">(</span><span class="main">[</span> ffilter <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">∀</span><span class="bound">e</span><span class="main">∈</span>set <span class="skolem">E</span><span class="main">.</span> <span class="bound">v</span> <span class="main">|∉|</span> thd3 <span class="bound">e</span><span class="main">)</span> <span class="skolem">V</span> <span class="main">-</span> <span class="skolem">S</span> <span class="main">|=&gt;</span> Top <span class="main">]</span>
        <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">[</span> <span class="skolem">S</span> <span class="main">-</span> fst3 <span class="skolem">e</span> <span class="main">|=&gt;</span> Bot <span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> fmdom_add fdom_make_fmap<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> fset_cong<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> in_mono less_eq_fset.rep_eq vs_def vs_in_S<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_ps_chain <span class="skolem">Π</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">unfold_abs_def</span> <span class="main"><span class="main">=</span></span> <span class="quasi_keyword">false</span><span class="main">]</span><span class="main">]</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> Π_def π_def x_def mk_ps_chain_cons<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> mk_ps_chain_ccons<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> vs_def ws_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> next_initial_ps2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> Π'_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> wf_ps_chain_def chain_all.simps conj_commute<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> wf_ps_chain_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Π'<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> wf_ps_triple_edgeI exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">σ</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> e_def fst3_simp thd3_simp σ_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> pre_Π' initial_ps2_def initials_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> vs_in_S acy<span class="main"><span class="main">[</span></span><span class="operator">OF</span> e_in_E<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> fset_cong<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> less_eq_fset.rep_eq<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> G_def G'_def vs_def ws_def V'_def E'_def S'_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> vertices.simps edges.simps<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> fmap_add_commute<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 1<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> fmadd_assoc<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> make_fmap_union<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fdom_make_fmap e_in_E<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> fmadd_assoc<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> make_fmap_union<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> funion_absorb2 vs_def vs_in_S<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="main"><span class="main">-</span></span> fst3 <span class="skolem"><span class="skolem">e</span></span> <span class="main"><span class="main">|=&gt;</span></span> Bot <span class="main"><span class="main">]</span></span>"</span></span></span>
            <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="main"><span class="main">-</span></span> fst3 <span class="skolem"><span class="skolem">e</span></span> <span class="main"><span class="main">|=&gt;</span></span> Bot <span class="main"><span class="main">]</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">(++<span class="hidden">⇩</span><sub>f</sub>)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Top"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Top"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"make_fmap"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span> 1
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> fset_cong<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> less_eq_fset.rep_eq fmember.rep_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> set_eqI iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> disjI conjI ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">ea</span><span class="main">=</span><span class="skolem">e</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI ballI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> e_in_E lin<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fset_cong<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> inter_fset<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> fset_simps<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> disjoint_iff_not_equal<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> G_def Suc<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> e_in_E subsetD less_eq_fset.rep_eq wf_dia_inv'<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> IntI Suc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ws</span> <span class="main">|∩|</span> initials <span class="skolem">G</span> <span class="main">=</span> <span class="main">{||}</span>›</span></span>
            empty_iff fset_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> in_mono inter_fset less_eq_fset.rep_eq ws_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"post <span class="skolem">Π</span> <span class="main">=</span> <span class="main">[</span>terminals <span class="skolem">G</span> <span class="main">|=&gt;</span> Bot<span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> Π_def π_def x_def mk_ps_chain_cons<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> mk_ps_chain_ccons post.simps<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> vs_def ws_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> next_initial_ps2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> Π'_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> terms_same<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> post_Π'<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> wf_chains<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_dia <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Π</span> <span class="main">∈</span> ps_chains <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_ps_chain <span class="free">Π</span> <span class="main">∧</span> post <span class="free">Π</span> <span class="main">=</span> <span class="main">[</span> terminals <span class="free">G</span> <span class="main">|=&gt;</span> Bot <span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> wf_chains2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{||}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ps_chains_is_ps_chains2_with_empty_S fcard_fempty<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Interface chains›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> int_chain <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>interface<span class="main">,</span> assertion_gadget <span class="main">+</span> command_gadget<span class="main">)</span> chain"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An interface chain is similar to a proofstate chain. However, where a
  proofstate chain talks about nodes and edges, an interface chain talks about
  the assertion-gadgets and command-gadgets that label those nodes and edges
  in a diagram. And where a proofstate chain talks about proofstates, an
  interface chain talks about the interfaces obtained from those proofstates.

  The following functions convert a proofstate chain into an
  interface chain.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">ps_to_int</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>diagram<span class="main">,</span> proofstate<span class="main">]</span> <span class="main">⇒</span> interface"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ps_to_int</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
    <span class="main">⨂</span><span class="bound">v</span> <span class="main">|∈|</span> fmdom <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">.</span> case_topbot top_ass bot_ass <span class="main">(</span>lookup <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="keyword1">^Λ</span> <span class="bound">v</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">ps_chain_to_int_chain</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>diagram<span class="main">,</span> ps_chain<span class="main">]</span> <span class="main">⇒</span> int_chain"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ps_chain_to_int_chain</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">Π</span></span></span> <span class="main">≡</span>
    chainmap <span class="main">(</span>ps_to_int <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>case_sum <span class="main">(</span>Inl <span class="main">∘</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="keyword1">^Λ</span><span class="main">)</span> <span class="main">(</span>Inr <span class="main">∘</span> snd3<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Π</span></span></span>"</span></span>

<span class="keyword1" id="Ribbons_Graphical_Soundness-ps_chain_to_int_chain_simp"><span class="command">lemma</span></span> ps_chain_to_int_chain_simp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ps_chain_to_int_chain <span class="main">(</span>Graph <span class="free">V</span> <span class="free">Λ</span> <span class="free">E</span><span class="main">)</span> <span class="free">Π</span> <span class="main">=</span>
    chainmap <span class="main">(</span>ps_to_int <span class="main">(</span>Graph <span class="free">V</span> <span class="free">Λ</span> <span class="free">E</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>case_sum <span class="main">(</span>Inl <span class="main">∘</span> <span class="free">Λ</span><span class="main">)</span> <span class="main">(</span>Inr <span class="main">∘</span> snd3<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">Π</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ps_chain_to_int_chain_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Soundness proof›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We assume that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">wr_com</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> always returns <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">{}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. This is
  equivalent to changing our axiomatization of separation logic such that the
  frame rule has no side-condition. One way to obtain a separation logic
  lacking a side-condition on its frame rule is to use variables-as-
  resource.

  We proceed by induction on the proof rules for graphical diagrams. We
  show that: (1) if a diagram <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">G</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is provable w.r.t. interfaces
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are the top and bottom
  interfaces of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">G</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and that the Hoare triple <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span>asn <span class="free"><span class="free">P</span></span><span class="main"><span class="main">,</span></span>
  <span class="free"><span class="free">c</span></span><span class="main"><span class="main">,</span></span> asn <span class="free"><span class="free">Q</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is provable for each command <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that can be extracted
  from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">G</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>; (2) if a command-gadget <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">C</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is provable w.r.t.
  interfaces <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, then the Hoare triple <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span>asn <span class="free"><span class="free">P</span></span><span class="main"><span class="main">,</span></span>
  <span class="free"><span class="free">c</span></span><span class="main"><span class="main">,</span></span> asn <span class="free"><span class="free">Q</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is provable for each command <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that can be extracted
  from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">C</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>; and (3) if an assertion-gadget <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is provable, and if
  the top and bottom interfaces of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  respectively, then the Hoare triple <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span>asn <span class="free"><span class="free">P</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">c</span></span><span class="main"><span class="main">,</span></span> asn <span class="free"><span class="free">Q</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is provable
  for each command <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that can be extracted from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>



<span class="keyword1" id="Ribbons_Graphical_Soundness-soundness_graphical_helper"><span class="command">lemma</span></span> soundness_graphical_helper<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> no_var_interference<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> wr_com <span class="bound">c</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>prov_dia <span class="free">G</span> <span class="free">P</span> <span class="free">Q</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="free">P</span> <span class="main">=</span> top_dia <span class="free">G</span> <span class="main">∧</span> <span class="free">Q</span> <span class="main">=</span> bot_dia <span class="free">G</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">c</span><span class="main">.</span> coms_dia <span class="free">G</span> <span class="bound">c</span> <span class="main">⟶</span> prov_triple <span class="main">(</span>asn <span class="free">P</span><span class="main">,</span> <span class="bound">c</span><span class="main">,</span> asn <span class="free">Q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span>prov_com <span class="free">C</span> <span class="free">P</span> <span class="free">Q</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">c</span><span class="main">.</span> coms_com <span class="free">C</span> <span class="bound">c</span> <span class="main">⟶</span> prov_triple <span class="main">(</span>asn <span class="free">P</span><span class="main">,</span> <span class="bound">c</span><span class="main">,</span> asn <span class="free">Q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span>prov_ass <span class="free">A</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">c</span><span class="main">.</span> coms_ass <span class="free">A</span> <span class="bound">c</span> <span class="main">⟶</span> prov_triple <span class="main">(</span>asn <span class="main">(</span>top_ass <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="bound">c</span><span class="main">,</span> asn <span class="main">(</span>bot_ass <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> prov_dia_prov_com_prov_ass.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Skip <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE coms_skip_inv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prov_triple.skip<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Exists <span class="skolem">G</span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE coms_exists_inv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prov_triple.exists<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Basic <span class="skolem">P</span> <span class="skolem">c</span> <span class="skolem">Q</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE coms_basic_inv<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Choice <span class="skolem">G</span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">H</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE coms_choice_inv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prov_triple.choose<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Loop <span class="skolem">G</span> <span class="skolem">P</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE coms_loop_inv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prov_triple.loop<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Main <span class="skolem">G</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> coms_main_inv<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">V</span> <span class="skolem">Λ</span> <span class="skolem">E</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">π</span><span class="main">::</span><span class="quoted"><span class="quoted">"lin"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cs</span><span class="main">::</span><span class="quoted"><span class="quoted">"command list"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> wf_G<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dia <span class="main">(</span>Graph <span class="skolem">V</span> <span class="skolem">Λ</span> <span class="skolem">E</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> fset <span class="skolem">V</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">c</span><span class="main">.</span> coms_ass <span class="main">(</span><span class="skolem">Λ</span> <span class="bound">v</span><span class="main">)</span> <span class="bound">c</span> <span class="main">⟶</span>
      prov_triple <span class="main">(</span>asn <span class="main">(</span>top_ass <span class="main">(</span><span class="skolem">Λ</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">c</span><span class="main">,</span> asn <span class="main">(</span>bot_ass <span class="main">(</span><span class="skolem">Λ</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> prov_vertex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span> <span class="bound">c</span> <span class="bound">P</span> <span class="bound">Q</span> <span class="bound">F</span><span class="main">.</span> <span class="main">⟦</span> coms_ass <span class="main">(</span><span class="skolem">Λ</span> <span class="bound">v</span><span class="main">)</span> <span class="bound">c</span><span class="main">;</span> <span class="bound">v</span> <span class="main">∈</span> fset <span class="skolem">V</span><span class="main">;</span>
      <span class="bound">P</span> <span class="main">=</span> <span class="main">(</span>top_ass <span class="main">(</span><span class="skolem">Λ</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⊗</span> <span class="bound">F</span><span class="main">)</span> <span class="main">;</span> <span class="bound">Q</span> <span class="main">=</span> <span class="main">(</span>bot_ass <span class="main">(</span><span class="skolem">Λ</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⊗</span> <span class="bound">F</span><span class="main">)</span> <span class="main">⟧</span>
      <span class="main">⟹</span> prov_triple <span class="main">(</span>asn <span class="bound">P</span><span class="main">,</span> <span class="bound">c</span><span class="main">,</span> asn <span class="bound">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prov_triple.frame no_var_interference<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> set <span class="skolem">E</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">c</span><span class="main">.</span> coms_com <span class="main">(</span>snd3 <span class="bound">e</span><span class="main">)</span> <span class="bound">c</span> <span class="main">⟶</span> prov_triple
      <span class="main">(</span>asn <span class="main">(</span><span class="main">⨂</span><span class="bound">v</span><span class="main">|∈|</span>fst3 <span class="bound">e</span><span class="main">.</span> bot_ass <span class="main">(</span><span class="skolem">Λ</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="bound">c</span><span class="main">,</span>asn <span class="main">(</span><span class="main">⨂</span><span class="bound">v</span><span class="main">|∈|</span>thd3 <span class="bound">e</span><span class="main">.</span> top_ass <span class="main">(</span><span class="skolem">Λ</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> prov_edge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">e</span> <span class="bound">c</span> <span class="bound">P</span> <span class="bound">Q</span> <span class="bound">F</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">e</span> <span class="main">∈</span> set <span class="skolem">E</span> <span class="main">;</span> coms_com <span class="main">(</span>snd3 <span class="bound">e</span><span class="main">)</span> <span class="bound">c</span> <span class="main">;</span>
      <span class="bound">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">⨂</span><span class="bound">v</span><span class="main">|∈|</span>fst3 <span class="bound">e</span><span class="main">.</span> bot_ass <span class="main">(</span><span class="skolem">Λ</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⊗</span> <span class="bound">F</span><span class="main">)</span> <span class="main">;</span>
      <span class="bound">Q</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">⨂</span><span class="bound">v</span><span class="main">|∈|</span>thd3 <span class="bound">e</span><span class="main">.</span> top_ass <span class="main">(</span><span class="skolem">Λ</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⊗</span> <span class="bound">F</span><span class="main">)</span> <span class="main">⟧</span>
      <span class="main">⟹</span> prov_triple <span class="main">(</span>asn <span class="bound">P</span><span class="main">,</span> <span class="bound">c</span><span class="main">,</span> asn <span class="bound">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prov_triple.frame no_var_interference<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> len_cs<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">cs</span> <span class="main">=</span> length <span class="skolem">π</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="skolem">π</span><span class="main">.</span>
      case_sum <span class="main">(</span>coms_ass <span class="main">∘</span> <span class="skolem">Λ</span><span class="main">)</span> <span class="main">(</span>coms_com <span class="main">∘</span> snd3<span class="main">)</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> π_cs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">π</span> <span class="main">⟹</span>
      case_sum <span class="main">(</span>coms_ass <span class="main">∘</span> <span class="skolem">Λ</span><span class="main">)</span> <span class="main">(</span>coms_com <span class="main">∘</span> snd3<span class="main">)</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">assume</span></span> G_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">=</span> Graph <span class="skolem">V</span> <span class="skolem">Λ</span> <span class="skolem">E</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> c_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> foldr <span class="main">(;;)</span> <span class="skolem">cs</span> Skip"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> π_lin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">∈</span> lins <span class="main">(</span>Graph <span class="skolem">V</span> <span class="skolem">Λ</span> <span class="skolem">E</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">note</span></span> lins <span class="main">=</span> linsD<span class="main">[</span><span class="operator">OF</span> π_lin<span class="main">]</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Π</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Π</span> <span class="main">=</span> mk_ps_chain <span class="main">⦃</span> initial_ps <span class="skolem">G</span> <span class="main">⦄</span> <span class="skolem">π</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Π</span> <span class="main">∈</span> ps_chains <span class="skolem">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_lin Π_def ps_chains_def G_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"post <span class="skolem">Π</span> <span class="main">=</span> <span class="main">[</span> terminals <span class="skolem">G</span> <span class="main">|=&gt;</span> Bot <span class="main">]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"chain_all wf_ps_triple <span class="skolem">Π</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> wf_chains G_def wf_G<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_ps_chain_def<span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"prov_triple <span class="main">(</span>asn <span class="main">(</span><span class="main">⨂</span><span class="bound">v</span><span class="main">|∈|</span>initials <span class="main">(</span>Graph <span class="skolem">V</span> <span class="skolem">Λ</span> <span class="skolem">E</span><span class="main">)</span><span class="main">.</span> top_ass <span class="main">(</span><span class="skolem">Λ</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      foldr <span class="main">(;;)</span> <span class="skolem">cs</span> Skip<span class="main">,</span> asn <span class="main">(</span><span class="main">⨂</span><span class="bound">v</span><span class="main">|∈|</span>terminals <span class="main">(</span>Graph <span class="skolem">V</span> <span class="skolem">Λ</span> <span class="skolem">E</span><span class="main">)</span><span class="main">.</span> bot_ass <span class="main">(</span><span class="skolem">Λ</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">unfold_abs_def</span> <span class="main"><span class="main">=</span></span> <span class="quasi_keyword">false</span><span class="main">]</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> seq_fold<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"ps_chain_to_int_chain <span class="skolem"><span class="skolem">G</span></span> <span class="skolem"><span class="skolem">Π</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> len_cs<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> ps_chain_to_int_chain_def chainmap_preserves_length Π_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> mk_ps_chain_preserves_length<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> pre_chainmap post_chainmap<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> pre_mk_ps_chain pre.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> Π_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> 1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> initial_ps_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> ps_to_int_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> fdom_make_fmap<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> G_def labelling.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">fold</span> G_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> fset <span class="main">(</span>initials <span class="skolem">G</span><span class="main">)</span><span class="main">.</span> top_ass <span class="main">(</span><span class="skolem">Λ</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span>
      case_topbot top_ass bot_ass <span class="main">(</span>lookup <span class="main">[</span> initials <span class="skolem">G</span> <span class="main">|=&gt;</span> Top <span class="main">]</span> <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Λ</span> <span class="bound">v</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> iter_hcomp_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> lookup_make_fmap topbot.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> fset <span class="main">(</span>terminals <span class="skolem">G</span><span class="main">)</span><span class="main">.</span> bot_ass <span class="main">(</span><span class="skolem">Λ</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span>
      case_topbot top_ass bot_ass <span class="main">(</span>lookup <span class="main">[</span> terminals <span class="skolem">G</span> <span class="main">|=&gt;</span> Bot <span class="main">]</span> <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Λ</span> <span class="bound">v</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> iter_hcomp_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> lookup_make_fmap topbot.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> G_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">fold</span> ps_chain_to_int_chain_simp G_def<span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">π</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> chainlen <span class="skolem">Π</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Π_def add_0_left chainlen.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
        mk_ps_chain_preserves_length<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> wf_Πi<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_ps_triple <span class="main">(</span>nthtriple <span class="skolem">Π</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> 2<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> chain_all_nthtriple<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"prov_triple <span class="main">(</span>asn <span class="main">(</span>fst3 <span class="main">(</span>nthtriple <span class="main">(</span>ps_chain_to_int_chain <span class="skolem">G</span> <span class="skolem">Π</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
                 <span class="skolem">cs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> asn <span class="main">(</span>thd3 <span class="main">(</span>nthtriple <span class="main">(</span>ps_chain_to_int_chain <span class="skolem">G</span> <span class="skolem">Π</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> ps_chain_to_int_chain_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> nthtriple_chainmap<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> chainlen <span class="skolem">Π</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> fst3_simp thd3_simp<span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span><span class="main">!</span><span class="skolem">i</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">v</span><span class="main">)</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd3 <span class="main">(</span>nthtriple <span class="skolem">Π</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> Inl <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> snds_of_triples_form_comlist<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> chainlen <span class="skolem">Π</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Π_def comlist_mk_ps_chain Inl<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

        <span class="keyword1"><span class="command">with</span></span> wf_Πi wf_ps_triple_def <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          v_notin_σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">|∉|</span> fmdom <span class="skolem">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          fst_Πi<span class="main">:</span> <span class="quoted"><span class="quoted">"fst3 <span class="main">(</span>nthtriple <span class="skolem">Π</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span> <span class="main">{|</span><span class="skolem">v</span><span class="main">|}</span> <span class="main">|=&gt;</span> Top <span class="main">]</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          thd_Πi<span class="main">:</span> <span class="quoted"><span class="quoted">"thd3 <span class="main">(</span>nthtriple <span class="skolem">Π</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span> <span class="main">{|</span><span class="skolem">v</span><span class="main">|}</span> <span class="main">|=&gt;</span> Bot <span class="main">]</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"prov_triple <span class="main">(</span>asn <span class="main">(</span>ps_to_int <span class="skolem">G</span> <span class="main">(</span>fst3 <span class="main">(</span>nthtriple <span class="skolem">Π</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
                   <span class="skolem">cs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> asn <span class="main">(</span>ps_to_int <span class="skolem">G</span> <span class="main">(</span>thd3 <span class="main">(</span>nthtriple <span class="skolem">Π</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> prov_vertex<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> v<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">v</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Inl <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">π</span>›</span></span> π_cs o_def sum.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> Inl lins<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Inl_not_Inr PlusE <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">π</span>›</span></span>
          nth_mem sum.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> vertices.simps<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> fst_Πi thd_Πi<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> ps_to_int_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> fmdom_add fdom_make_fmap<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> finsert_is_funion<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> v_notin_σ<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> iter_hcomp_insert<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> lookup_union2 lookup_make_fmap1<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> G_def labelling.simps<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">va</span> <span class="main">∈</span> fset <span class="main">(</span>fmdom <span class="skolem">σ</span><span class="main">)</span><span class="main">.</span> case_topbot top_ass bot_ass
          <span class="main">(</span>lookup <span class="main">(</span><span class="main">[</span> <span class="main">{|</span><span class="skolem">v</span><span class="main">|}</span> <span class="main">|=&gt;</span> Top <span class="main">]</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">σ</span><span class="main">)</span> <span class="bound">va</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Λ</span> <span class="bound">va</span><span class="main">)</span> <span class="main">=</span>
          case_topbot top_ass bot_ass <span class="main">(</span>lookup <span class="main">(</span><span class="main">[</span><span class="main">{|</span><span class="skolem">v</span><span class="main">|}</span> <span class="main">|=&gt;</span> Bot<span class="main">]</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">σ</span><span class="main">)</span> <span class="bound">va</span><span class="main">)</span><span class="main">(</span><span class="skolem">Λ</span> <span class="bound">va</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> iter_hcomp_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> fmember.rep_eq lookup_union1<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">e</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd3 <span class="main">(</span>nthtriple <span class="skolem">Π</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> Inr <span class="skolem">e</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> snds_of_triples_form_comlist<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> chainlen <span class="skolem">Π</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Π_def comlist_mk_ps_chain Inr<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

        <span class="keyword1"><span class="command">with</span></span> wf_Πi wf_ps_triple_def <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          fst_e_disjoint_σ<span class="main">:</span> <span class="quoted"><span class="quoted">"fst3 <span class="skolem">e</span> <span class="main">|∩|</span> fmdom <span class="skolem">σ</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          thd_e_disjoint_σ<span class="main">:</span> <span class="quoted"><span class="quoted">"thd3 <span class="skolem">e</span> <span class="main">|∩|</span> fmdom <span class="skolem">σ</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          fst_Πi<span class="main">:</span> <span class="quoted"><span class="quoted">"fst3 <span class="main">(</span>nthtriple <span class="skolem">Π</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span> fst3 <span class="skolem">e</span> <span class="main">|=&gt;</span> Bot <span class="main">]</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          thd_Πi<span class="main">:</span> <span class="quoted"><span class="quoted">"thd3 <span class="main">(</span>nthtriple <span class="skolem">Π</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span> thd3 <span class="skolem">e</span> <span class="main">|=&gt;</span> Top <span class="main">]</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">σ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inf_sup_distrib2<span class="main">)</span>

        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"prov_triple <span class="main">(</span>asn <span class="main">(</span>ps_to_int <span class="skolem">G</span> <span class="main">(</span>fst3 <span class="main">(</span>nthtriple <span class="skolem">Π</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
                   <span class="skolem">cs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> asn <span class="main">(</span>ps_to_int <span class="skolem">G</span> <span class="main">(</span>thd3 <span class="main">(</span>nthtriple <span class="skolem">Π</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> prov_edge<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> e<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">e</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Inr <span class="skolem">e</span> <span class="main">∈</span> set <span class="skolem">π</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Inr_not_Inl PlusE edges.simps lins<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sum.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Inr <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">π</span>›</span></span> nth_mem<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Inr <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">π</span>›</span></span> π_cs o_def sum.simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> fst_Πi thd_Πi<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> ps_to_int_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> G_def labelling.simps<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> fmdom_add fdom_make_fmap<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> fst_e_disjoint_σ<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> iter_hcomp_union<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> fset <span class="main">(</span>fst3 <span class="skolem">e</span><span class="main">)</span><span class="main">.</span> case_topbot top_ass bot_ass
          <span class="main">(</span>lookup <span class="main">(</span><span class="main">[</span> fst3 <span class="skolem">e</span> <span class="main">|=&gt;</span> Bot <span class="main">]</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">σ</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Λ</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> bot_ass <span class="main">(</span><span class="skolem">Λ</span> <span class="bound">v</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> iter_hcomp_cong<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> ballI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">v</span> <span class="main">|∉|</span> fmdom <span class="skolem">σ</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> lookup_union2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> lookup_make_fmap topbot.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> fempty_iff finterI fmember.rep_eq<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> thd_e_disjoint_σ<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> iter_hcomp_union<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> fset <span class="main">(</span>thd3 <span class="skolem">e</span><span class="main">)</span><span class="main">.</span> case_topbot top_ass bot_ass
          <span class="main">(</span>lookup <span class="main">(</span><span class="main">[</span> thd3 <span class="skolem">e</span> <span class="main">|=&gt;</span> Top <span class="main">]</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">σ</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Λ</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> top_ass <span class="main">(</span><span class="skolem">Λ</span> <span class="bound">v</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> iter_hcomp_cong<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> fset <span class="main">(</span>fmdom <span class="skolem">σ</span><span class="main">)</span><span class="main">.</span> case_topbot top_ass bot_ass
          <span class="main">(</span>lookup <span class="main">(</span><span class="main">[</span> thd3 <span class="skolem">e</span> <span class="main">|=&gt;</span> Top <span class="main">]</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">σ</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Λ</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span>
          case_topbot top_ass bot_ass <span class="main">(</span>lookup <span class="main">(</span><span class="main">[</span>fst3 <span class="skolem">e</span> <span class="main">|=&gt;</span> Bot<span class="main">]</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">σ</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Λ</span> <span class="bound">v</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> iter_hcomp_cong<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> ballI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">v</span> <span class="main">|∈|</span> fmdom <span class="skolem">σ</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> lookup_union1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">v</span> <span class="main">|∉|</span> fmdom <span class="skolem">σ</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> lookup_union2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> lookup_make_fmap topbot.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fempty_iff finterI fmember.rep_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The soundness theorem states that any diagram provable using the
  proof rules for ribbons can be recreated as a valid proof in separation
  logic.›</span></span>

<span class="keyword1"><span class="command">corollary</span></span> soundness_graphical<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> wr_com <span class="bound">c</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prov_dia <span class="free">G</span> <span class="free">P</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">c</span><span class="main">.</span> coms_dia <span class="free">G</span> <span class="bound">c</span> <span class="main">⟶</span> prov_triple <span class="main">(</span>asn <span class="free">P</span><span class="main">,</span> <span class="bound">c</span><span class="main">,</span> asn <span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> soundness_graphical_helper<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>