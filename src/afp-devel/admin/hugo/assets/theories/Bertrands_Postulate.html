<div id="Bertrand">
<div class="head">
<h1>Theory Bertrand</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Bertrand.thy
  Authors:  Julian Biendarra, Manuel Eberl &lt;eberlm@in.tum.de&gt;, Larry Paulson

  A proof of Bertrand's postulate (based on John Harrison's HOL Light proof).
  Uses reflection and the approximation tactic.
*)</span>
<span class="keyword1"><span class="command">theory</span></span> Bertrand
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a>
    <span class="quoted">"<a href="../../HOL/HOL-Number_Theory/Number_Theory.html">HOL-Number_Theory.Number_Theory</a>"</span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Discrete.html">HOL-Library.Discrete</a>"</span>
    <span class="quoted">"<a href="../../HOL/HOL-Decision_Procs/Approximation_Bounds.html">HOL-Decision_Procs.Approximation_Bounds</a>"</span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Code_Target_Numeral.html">HOL-Library.Code_Target_Numeral</a>"</span>
    <a href="../Pratt_Certificate/Pratt_Certificate.html">Pratt_Certificate.Pratt_Certificate</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary facts›</span></span>
 
<span class="keyword1" id="Bertrand-ln_2_le"><span class="command">lemma</span></span> ln_2_le<span class="main">:</span> <span class="quoted"><span class="quoted">"ln <span class="numeral">2</span> <span class="main">≤</span> <span class="numeral">355</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">512</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="numeral">2</span> <span class="main">≤</span> real_of_float <span class="main">(</span>ub_ln2 <span class="numeral">12</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ub_ln2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ub_ln2 <span class="numeral">12</span> <span class="main">=</span> Float <span class="numeral">5680</span> <span class="main">(</span><span class="main">-</span> <span class="numeral">13</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Bertrand-ln_2_ge"><span class="command">lemma</span></span> ln_2_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"ln <span class="numeral">2</span> <span class="main">≥</span> <span class="main">(</span><span class="numeral">5677</span> <span class="main">/</span> <span class="numeral">8192</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="numeral">2</span> <span class="main">≥</span> real_of_float <span class="main">(</span>lb_ln2 <span class="numeral">12</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lb_ln2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lb_ln2 <span class="numeral">12</span> <span class="main">=</span> Float <span class="numeral">5677</span> <span class="main">(</span><span class="main">-</span><span class="numeral">13</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Bertrand-ln_2_ge'"><span class="command">lemma</span></span> ln_2_ge'<span class="main">:</span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">/</span><span class="numeral">3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ln_2_le'<span class="main">:</span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">≤</span> <span class="numeral">16</span><span class="main">/</span><span class="numeral">23</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ln_2_le ln_2_ge <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Bertrand-of_nat_ge_1_iff"><span class="command">lemma</span></span> of_nat_ge_1_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>of_nat <span class="free">x</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> linordered_semidom<span class="main">)</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> of_nat_le_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> of_nat_1<span class="main">)</span>
  
<span class="keyword1" id="Bertrand-floor_conv_div_nat"><span class="command">lemma</span></span> floor_conv_div_nat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"of_int <span class="main">(</span>floor <span class="main">(</span>real <span class="free">m</span> <span class="main">/</span> real <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> real <span class="main">(</span><span class="free">m</span> <span class="keyword1">div</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> floor_divide_of_nat_eq<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Bertrand-frac_conv_mod_nat"><span class="command">lemma</span></span> frac_conv_mod_nat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"frac <span class="main">(</span>real <span class="free">m</span> <span class="main">/</span> real <span class="free">n</span><span class="main">)</span> <span class="main">=</span> real <span class="main">(</span><span class="free">m</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">/</span> real <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> frac_def floor_conv_div_nat <span class="dynamic"><span class="dynamic">field_simps</span></span> of_nat_mult 
        <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> of_nat_add <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_mult of_nat_add<span class="main">)</span>

<span class="keyword1" id="Bertrand-of_nat_prod_mset"><span class="command">lemma</span></span> of_nat_prod_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"prod_mset <span class="main">(</span>image_mset of_nat <span class="free">A</span><span class="main">)</span> <span class="main">=</span> of_nat <span class="main">(</span>prod_mset <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Bertrand-prod_mset_pos"><span class="command">lemma</span></span> prod_mset_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> linordered_semidom<span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> prod_mset <span class="free">A</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Bertrand-ln_msetprod"><span class="command">lemma</span></span> ln_msetprod<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span><span class="free">I</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">::</span>nat<span class="main">∈#</span><span class="free">I</span><span class="main">.</span> ln <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> ln <span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈#</span><span class="free">I</span><span class="main">.</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">I</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_nat_prod_mset ln_mult prod_mset_pos<span class="main">)</span>

<span class="keyword1" id="Bertrand-ln_fact"><span class="command">lemma</span></span> ln_fact<span class="main">:</span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> ln <span class="bound">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ln_mult<span class="main">)</span>

<span class="keyword1" id="Bertrand-overpower_lemma"><span class="command">lemma</span></span> overpower_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">g</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">a</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">has_real_derivative</span> <span class="main">(</span><span class="free">d</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">a</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">d</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">g</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="free">a</span> <span class="main">∧</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">g</span> <span class="free">x</span> <span class="main">-</span> <span class="free">f</span> <span class="free">x</span> <span class="main">-</span> <span class="main">(</span><span class="free">g</span> <span class="free">a</span> <span class="main">-</span> <span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">*</span> <span class="free">d</span> <span class="bound">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> MVT2<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">&gt;</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">x</span> <span class="main">-</span> <span class="free">f</span> <span class="free">x</span> <span class="main">-</span> <span class="main">(</span><span class="free">g</span> <span class="free">a</span> <span class="main">-</span> <span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">*</span> <span class="free">d</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">g</span> <span class="free">x</span> <span class="main">+</span> <span class="main">(</span><span class="free">f</span> <span class="free">a</span> <span class="main">-</span> <span class="free">g</span> <span class="free">a</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="main">*</span> <span class="free">d</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">a</span> <span class="main">-</span> <span class="free">g</span> <span class="free">a</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms z <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="main">*</span> <span class="free">d</span> <span class="skolem">z</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">*</span> <span class="free">d</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_right_mono<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preliminary definitions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">primepow_even</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">primepow_even</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">p</span> <span class="bound">k</span><span class="main">.</span> <span class="main">1</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="bound">p</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">primepow_odd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">primepow_odd</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">p</span> <span class="bound">k</span><span class="main">.</span> <span class="main">1</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="bound">p</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">isprimedivisor</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">isprimedivisor</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> prime <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">dvd</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pre_mangoldt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pre_mangoldt</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> primepow <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="keyword1">then</span> aprimedivisor <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mangoldt_even</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mangoldt_even</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> primepow_even <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="keyword1">then</span> ln <span class="main">(</span>real <span class="main">(</span>aprimedivisor <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mangoldt_odd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mangoldt_odd</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> primepow_odd <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="keyword1">then</span> ln <span class="main">(</span>real <span class="main">(</span>aprimedivisor <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mangoldt_1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mangoldt_1</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> prime <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="keyword1">then</span> ln <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">psi</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">psi</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> mangoldt <span class="bound">d</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">psi_even</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">psi_even</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> mangoldt_even <span class="bound">d</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">psi_odd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">psi_odd</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> mangoldt_odd <span class="bound">d</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">psi_even_2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">psi_even_2</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="numeral">2</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> mangoldt_even <span class="bound">d</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">psi_odd_2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">psi_odd_2</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="numeral">2</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> mangoldt_odd <span class="bound">d</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">theta</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">theta</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> <span class="keyword1">if</span> prime <span class="bound">p</span> <span class="keyword1">then</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of prime powers›</span></span>  

<span class="keyword1" id="Bertrand-primepow_even_imp_primepow"><span class="command">lemma</span></span> primepow_even_imp_primepow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"primepow_even <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"primepow <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> primepow_even_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> primepow_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Bertrand-primepow_odd_imp_primepow"><span class="command">lemma</span></span> primepow_odd_imp_primepow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"primepow_odd <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"primepow <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> primepow_odd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> primepow_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Bertrand-primepow_odd_altdef"><span class="command">lemma</span></span> primepow_odd_altdef<span class="main">:</span>
  <span class="quoted"><span class="quoted">"primepow_odd <span class="free">n</span> <span class="main">⟷</span>
     primepow <span class="free">n</span> <span class="main">∧</span> odd <span class="main">(</span>multiplicity <span class="main">(</span>aprimedivisor <span class="free">n</span><span class="main">)</span> <span class="free">n</span><span class="main">)</span> <span class="main">∧</span> multiplicity <span class="main">(</span>aprimedivisor <span class="free">n</span><span class="main">)</span> <span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> iffI conjI<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"primepow_odd <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> primepow_odd_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"odd <span class="main">(</span>multiplicity <span class="main">(</span>aprimedivisor <span class="free">n</span><span class="main">)</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="main">(</span>aprimedivisor <span class="free">n</span><span class="main">)</span> <span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> aprimedivisor_primepow prime_elem_multiplicity_mult_distrib<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"primepow <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"odd <span class="main">(</span>multiplicity <span class="main">(</span>aprimedivisor <span class="free">n</span><span class="main">)</span> <span class="free">n</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"multiplicity <span class="main">(</span>aprimedivisor <span class="free">n</span><span class="main">)</span> <span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> A <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">^</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> primepow_def Suc_le_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> B C <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"odd <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> aprimedivisor_primepow prime_elem_multiplicity_mult_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> oddE<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> n <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"primepow_odd <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> primepow_odd_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> exI<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> primepow_odd_imp_primepow<span class="main">)</span>

<span class="keyword1" id="Bertrand-primepow_even_altdef"><span class="command">lemma</span></span> primepow_even_altdef<span class="main">:</span>
  <span class="quoted"><span class="quoted">"primepow_even <span class="free">n</span> <span class="main">⟷</span> primepow <span class="free">n</span> <span class="main">∧</span> even <span class="main">(</span>multiplicity <span class="main">(</span>aprimedivisor <span class="free">n</span><span class="main">)</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> iffI conjI<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"primepow_even <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> primepow_even_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"even <span class="main">(</span>multiplicity <span class="main">(</span>aprimedivisor <span class="free">n</span><span class="main">)</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> aprimedivisor_primepow prime_elem_multiplicity_mult_distrib<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"primepow <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"even <span class="main">(</span>multiplicity <span class="main">(</span>aprimedivisor <span class="free">n</span><span class="main">)</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> A <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">^</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> primepow_def Suc_le_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"even <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> aprimedivisor_primepow prime_elem_multiplicity_mult_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> evenE<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> j n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">with</span></span> j n <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"primepow_even <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> primepow_even_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> exI<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> primepow_even_imp_primepow<span class="main">)</span>

<span class="keyword1" id="Bertrand-primepow_odd_mult"><span class="command">lemma</span></span> primepow_odd_mult<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> Suc <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"primepow_odd <span class="main">(</span>aprimedivisor <span class="free">d</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span> <span class="main">⟷</span> primepow_even <span class="free">d</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> primepow_odd_altdef primepow_even_altdef primepow_mult_aprimedivisorI
                   aprimedivisor_primepow prime_aprimedivisor' aprimedivisor_dvd'
                   prime_elem_multiplicity_mult_distrib prime_elem_aprimedivisor_nat
             <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> primepow_multD<span class="main">)</span>

<span class="keyword1" id="Bertrand-pre_mangoldt_primepow"><span class="command">lemma</span></span> pre_mangoldt_primepow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"primepow <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"aprimedivisor <span class="free">n</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pre_mangoldt <span class="free">n</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pre_mangoldt_def<span class="main">)</span>

<span class="keyword1" id="Bertrand-pre_mangoldt_notprimepow"><span class="command">lemma</span></span> pre_mangoldt_notprimepow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>primepow <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pre_mangoldt <span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pre_mangoldt_def<span class="main">)</span>

<span class="keyword1" id="Bertrand-primepow_cases"><span class="command">lemma</span></span> primepow_cases<span class="main">:</span>
  <span class="quoted"><span class="quoted">"primepow <span class="free">d</span> <span class="main">⟷</span>
     <span class="main">(</span>  primepow_even <span class="free">d</span> <span class="main">∧</span> <span class="main">¬</span> primepow_odd <span class="free">d</span> <span class="main">∧</span> <span class="main">¬</span> prime <span class="free">d</span><span class="main">)</span> <span class="main">∨</span>
     <span class="main">(</span><span class="main">¬</span> primepow_even <span class="free">d</span> <span class="main">∧</span>   primepow_odd <span class="free">d</span> <span class="main">∧</span> <span class="main">¬</span> prime <span class="free">d</span><span class="main">)</span> <span class="main">∨</span>
     <span class="main">(</span><span class="main">¬</span> primepow_even <span class="free">d</span> <span class="main">∧</span> <span class="main">¬</span> primepow_odd <span class="free">d</span> <span class="main">∧</span>   prime <span class="free">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> primepow_even_altdef primepow_odd_altdef multiplicity_aprimedivisor_Suc_0_iff
           <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> oddE <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Nat.gr0I<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Deriving a recurrence for the psi function›</span></span>
  
<span class="keyword1" id="Bertrand-ln_fact_bounds"><span class="command">lemma</span></span> ln_fact_bounds<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"abs<span class="main">(</span>ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="free">n</span> <span class="main">*</span> ln <span class="free">n</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> ln <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..}</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">z</span></span><span class="main">&gt;</span>real <span class="bound">n</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> real <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> real <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> 
          real <span class="bound">n</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>real <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> real <span class="bound">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>ln <span class="bound">z</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ballI MVT2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..}</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">z</span></span><span class="main">&gt;</span>real <span class="bound">n</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> real <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> real <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> 
          real <span class="bound">n</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>ln <span class="bound">z</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> bchoice<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> lb<span class="main">:</span> <span class="quoted"><span class="quoted">"real <span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="skolem">n</span> <span class="main">&lt;</span> real <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
          mvt<span class="main">:</span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> real <span class="skolem">n</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> ln <span class="main">(</span><span class="skolem">k</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> 
          <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span><span class="main">::</span><span class="quoted">nat</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> ln <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> ln<span class="main">(</span><span class="skolem">k</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">.</span> ln <span class="main">(</span><span class="skolem">k</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> ln <span class="main">(</span><span class="skolem">k</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> ln <span class="main">(</span><span class="skolem">k</span> <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> Suc.IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> ln <span class="main">(</span><span class="skolem">k</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> real <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> mvt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">+</span><span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> real <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> ln <span class="main">(</span><span class="skolem">k</span> <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"abs<span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">.</span> ln <span class="bound">i</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> ln <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> ln<span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">.</span> ln <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> ln <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> ln <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> ln <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> ln <span class="main">(</span><span class="skolem">k</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> ln_le_cancel_iff<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc_le_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> lb ub<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> ln <span class="main">(</span><span class="skolem">k</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.distrib<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> ln <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> a_minus_b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">.</span> ln <span class="bound">i</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> ln <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> ln <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> ln <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> ln <span class="main">(</span><span class="skolem">k</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> ln <span class="main">(</span><span class="skolem">k</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.distrib<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> ln <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> ln_le_cancel_iff<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc_le_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> lb ub<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sum.shift_bounds_cl_nat_ivl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"ln"</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">.</span> ln <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">.</span> ln <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.mono_neutral_left<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> b_minus_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> ln <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">.</span> ln <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> ln <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> b_minus_a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> ln <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">.</span> ln <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> ln <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">with</span></span> a_minus_b <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dec_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> base
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> ln_fact<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">+</span><span class="main">1</span>"</span></span><span class="main">]</span> **<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Bertrand-ln_fact_diff_bounds"><span class="command">lemma</span></span> ln_fact_diff_bounds<span class="main">:</span>
  <span class="quoted"><span class="quoted">"abs<span class="main">(</span>ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>fact <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="free">n</span> <span class="main">*</span> ln <span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">4</span> <span class="main">*</span> ln <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> ln_le_minus_one<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">::</span>real"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real <span class="free">n</span> <span class="main">*</span> ln <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>fact <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> ln <span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real <span class="free">n</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">-</span> real <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> abs_a<span class="main">:</span> <span class="quoted"><span class="quoted">"abs<span class="main">(</span><span class="var">?a</span> <span class="main">-</span> <span class="main">(</span><span class="var">?a2</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="var">?a1</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?b</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="var">?b1</span> <span class="main">-</span> <span class="var">?b2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"even <span class="free">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> real <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> n_div_2<span class="main">:</span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> real <span class="free">n</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"abs<span class="main">(</span><span class="var">?a</span> <span class="main">-</span> <span class="main">(</span><span class="var">?a2</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="var">?a1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_div_2 ln_div <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹even <span class="free">n</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">-</span> ln <span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> evenE<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">…</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ln_ge_zero<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?b</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="var">?b1</span> <span class="main">-</span> <span class="var">?b2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> real <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> n_div_2<span class="main">:</span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>real <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="numeral">3</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">-</span> <span class="main">(</span><span class="var">?a2</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="var">?a1</span><span class="main">)</span> <span class="main">=</span> real <span class="free">n</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">-</span> real <span class="free">n</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">+</span> real <span class="free">n</span> <span class="main">+</span> 
             <span class="numeral">2</span> <span class="main">*</span> real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">*</span> real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> n_div_2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> real <span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="free">n</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">-</span> real <span class="free">n</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">+</span> real <span class="free">n</span> <span class="main">+</span> 
                   <span class="main">(</span>real <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>real <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>
                 <span class="main">=</span> real <span class="free">n</span> <span class="main">*</span> <span class="main">(</span>ln <span class="main">(</span>real <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> ln <span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> n_div_2 ln_div<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> lhs<span class="main">:</span> <span class="quoted"><span class="quoted">"abs<span class="main">(</span><span class="var">?a</span> <span class="main">-</span> <span class="main">(</span><span class="var">?a2</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="var">?a1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
        abs<span class="main">(</span>real <span class="free">n</span> <span class="main">*</span> <span class="main">(</span>ln <span class="main">(</span>real <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> ln <span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="free">n</span> <span class="main">*</span> <span class="main">(</span>ln <span class="main">(</span>real <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> mult_left_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"exp <span class="main">1</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">3</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exp_le<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≥</span> <span class="numeral">3</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> exp <span class="main">(</span>ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> ub<span class="main">:</span> <span class="quoted"><span class="quoted">"real <span class="free">n</span> <span class="main">*</span> <span class="main">(</span>ln <span class="main">(</span>real <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> ln<span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> 
                           <span class="numeral">3</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln<span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 
    <span class="keyword1"><span class="command">have</span></span> mon<span class="main">:</span> <span class="quoted"><span class="quoted">"real <span class="skolem">n'</span> <span class="main">*</span> <span class="main">(</span>ln <span class="main">(</span>real <span class="skolem">n'</span><span class="main">)</span> <span class="main">-</span> ln <span class="main">(</span>real <span class="skolem">n'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> 
                 real <span class="skolem">n</span> <span class="main">*</span> <span class="main">(</span>ln <span class="main">(</span>real <span class="skolem">n</span><span class="main">)</span> <span class="main">-</span> ln <span class="main">(</span>real <span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="numeral">3</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">≥</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="skolem">n'</span><span class="main">::</span><span class="quoted">nat</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> DERIV_nonpos_imp_nonincreasing<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">*</span></span> <span class="main"><span class="main">(</span></span>ln <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">-</span></span> ln <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">1</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"real <span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> real <span class="skolem">n'</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≥</span> ln <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">1</span><span class="main">/</span><span class="main">(</span><span class="skolem">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ln_add_one_self_le_self<span class="main">)</span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> t that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">1</span><span class="main">/</span><span class="main">(</span><span class="skolem">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ln <span class="skolem">t</span><span class="main">-</span> ln <span class="main">(</span><span class="skolem">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ln_div <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="skolem">t</span> <span class="main">-</span> ln <span class="main">(</span><span class="skolem">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">with</span></span> that t
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> <span class="main">(</span>ln <span class="bound">x</span> <span class="main">-</span> ln <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_field_derivative</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">1</span></span></span> <span class="main"><span class="main"><span class="main">/</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">1</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">t</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> ln <span class="skolem"><span class="skolem"><span class="skolem">t</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> ln <span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">t</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="main"><span class="main"><span class="main">1</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> that <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">simp_all</span><span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="numeral">2</span> <span class="main">=</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">-</span> ln <span class="main">(</span>real <span class="free">n</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ln_div<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">-</span> ln <span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">3</span><span class="main">*</span>ln <span class="numeral">2</span> <span class="main">+</span> ln<span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">3</span><span class="main">*</span> ln<span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">*</span> ln<span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> real <span class="free">n</span> <span class="main">*</span> <span class="main">(</span>ln <span class="main">(</span>real <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> ln<span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> 
            real <span class="free">n</span> <span class="main">*</span> <span class="main">(</span>ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">-</span> ln <span class="main">(</span>real <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">+</span> ln<span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="free">n</span> <span class="main">*</span> <span class="main">(</span>ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">-</span> ln <span class="main">(</span>real <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span>ln <span class="numeral">3</span> <span class="main">-</span> ln <span class="main">(</span><span class="numeral">3</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mon<span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≥</span> <span class="numeral">3</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span>Float <span class="numeral">3</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ub_ln <span class="main">1</span> <span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span>
      <span class="keyword1"><span class="command">from</span></span> ub_ln<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="numeral">3</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">1.6</span> <span class="main">::</span> real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">1.6</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">3</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span><span class="main">/</span><span class="numeral">3</span> <span class="main">::</span> real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">/</span><span class="numeral">3</span> <span class="main">≤</span> ln <span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ln_2_ge'<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="numeral">3</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">3</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span>ln <span class="numeral">3</span> <span class="main">-</span> ln <span class="main">(</span><span class="numeral">3</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> ln <span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> *
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> real <span class="free">n</span> <span class="main">*</span> <span class="main">(</span>ln <span class="main">(</span>real <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> ln<span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> 
                    <span class="numeral">3</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> lhs'<span class="main">:</span> <span class="quoted"><span class="quoted">"abs<span class="main">(</span>real <span class="free">n</span> <span class="main">*</span> <span class="main">(</span>ln <span class="main">(</span>real <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> ln<span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> 
                   <span class="numeral">3</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ub <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="var">?b1</span> <span class="main">-</span> <span class="var">?b2</span> <span class="main">=</span> <span class="numeral">3</span><span class="main">*</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">3</span><span class="main">*</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">*</span> ln <span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> rhs lhs lhs' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> minus_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="var">?a</span> <span class="main">≤</span> <span class="var">?b</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="var">?b1</span> <span class="main">-</span> <span class="var">?b2</span> <span class="main">-</span> <span class="main">(</span><span class="var">?a2</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="var">?a1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> abs_a <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">≤</span> <span class="var">?b</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="var">?b1</span> <span class="main">-</span> <span class="var">?b2</span> <span class="main">+</span> <span class="var">?a2</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="var">?a1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ln_fact_bounds<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span><span class="main">]</span> False <span class="keyword1"><span class="command">have</span></span> abs_l1<span class="main">:</span> <span class="quoted"><span class="quoted">"abs<span class="main">(</span><span class="var">?l1</span> <span class="main">-</span> <span class="var">?a1</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?b1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> minus_l1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?a1</span> <span class="main">-</span> <span class="var">?l1</span> <span class="main">≤</span> <span class="var">?b1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">from</span></span> abs_l1 <span class="keyword1"><span class="command">have</span></span> l1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?l1</span> <span class="main">-</span> <span class="var">?a1</span> <span class="main">≤</span> <span class="var">?b1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">from</span></span> ln_fact_bounds<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> False <span class="keyword1"><span class="command">have</span></span> abs_l2<span class="main">:</span> <span class="quoted"><span class="quoted">"abs<span class="main">(</span><span class="var">?l2</span> <span class="main">-</span> <span class="var">?a2</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?b2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?l2</span> <span class="main">-</span> <span class="var">?a2</span> <span class="main">≤</span> <span class="var">?b2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> abs_l2 <span class="keyword1"><span class="command">have</span></span> minus_l2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?a2</span> <span class="main">-</span> <span class="var">?l2</span> <span class="main">≤</span> <span class="var">?b2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> minus_a minus_l1 l2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l2</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="var">?l1</span> <span class="main">-</span> <span class="var">?a</span> <span class="main">≤</span> <span class="var">?b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> a l1 minus_l2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="var">?l2</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="var">?l1</span> <span class="main">+</span> <span class="var">?a</span> <span class="main">≤</span> <span class="var">?b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs<span class="main">(</span><span class="main">(</span><span class="var">?l2</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">*</span><span class="var">?l1</span><span class="main">)</span> <span class="main">-</span> <span class="var">?a</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>  
  
<span class="keyword1" id="Bertrand-ln_primefact"><span class="command">lemma</span></span> ln_primefact<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"ln <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="keyword1">if</span> primepow <span class="bound">d</span> <span class="main">∧</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="keyword1">then</span> ln <span class="main">(</span>aprimedivisor <span class="bound">d</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
          <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> primepow <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">}</span><span class="main">.</span> ln <span class="main">(</span>real <span class="main">(</span>aprimedivisor <span class="bound">d</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> primepow_factors_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.inter_filter <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> primepow <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">}</span> <span class="main">=</span> primepow_factors <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> primepow_factors_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dvd_imp_le primepow_gt_Suc_0<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">∈</span>primepow_factors <span class="free">n</span><span class="main">.</span> ln <span class="main">(</span>real <span class="main">(</span>aprimedivisor <span class="bound">d</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">from</span></span> in_prime_factors_imp_prime prime_gt_0_nat 
    <span class="keyword1"><span class="command">have</span></span> pf_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span><span class="main">∈#</span>prime_factorization <span class="free">n</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> ln_msetprod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"prime_factorization <span class="free">n</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> pf_pos<span class="main">]</span> assms
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">∈#</span>prime_factorization <span class="free">n</span><span class="main">.</span> ln <span class="bound">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_nat_prod_mset<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> * sum_prime_factorization_conv_sum_primepow_factors<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted">ln</span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Bertrand-divisors"><span class="command">lemma</span></span> divisors<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">d</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="keyword1">dvd</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="keyword1">div</span> <span class="free">d</span><span class="main">}</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> <span class="free">d</span> <span class="main">*</span> <span class="bound">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">div</span> <span class="free">d</span> <span class="main">≤</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="free">d</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> div_le_mono <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="free">x</span> <span class="keyword1">div</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> dvdE<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ub <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">div</span> <span class="free">d</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="keyword1">div</span> <span class="free">d</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="keyword1">dvd</span> <span class="free">x</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">div</span> <span class="free">d</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Bertrand-ln_fact_conv_mangoldt"><span class="command">lemma</span></span> ln_fact_conv_mangoldt<span class="main">:</span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> floor <span class="main">(</span><span class="free">n</span> <span class="main">/</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">da</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="keyword1">if</span> primepow <span class="bound">da</span> <span class="main">∧</span> <span class="bound">da</span> <span class="keyword1">dvd</span> <span class="skolem">d</span> <span class="keyword1">then</span> ln <span class="main">(</span>aprimedivisor <span class="bound">da</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> 
             <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">da</span><span class="main">::</span>nat<span class="main">)</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">d</span><span class="main">.</span> <span class="keyword1">if</span> primepow <span class="bound">da</span> <span class="main">∧</span> <span class="bound">da</span> <span class="keyword1">dvd</span> <span class="skolem">d</span> <span class="keyword1">then</span> ln <span class="main">(</span>aprimedivisor <span class="bound">da</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">if</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">d</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.mono_neutral_right<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> d<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dvd_imp_le<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">da</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="bound">d</span><span class="main">.</span> <span class="keyword1">if</span> primepow <span class="bound">da</span> <span class="main">∧</span>
      <span class="bound">da</span> <span class="keyword1">dvd</span> <span class="bound">d</span> <span class="keyword1">then</span> ln <span class="main">(</span>aprimedivisor <span class="bound">da</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">da</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="keyword1">if</span> primepow <span class="bound">da</span> <span class="main">∧</span>
      <span class="bound">da</span> <span class="keyword1">dvd</span> <span class="bound">d</span> <span class="keyword1">then</span> ln <span class="main">(</span>aprimedivisor <span class="bound">da</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> *<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">da</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="keyword1">if</span> primepow <span class="bound">da</span> <span class="main">∧</span>
                     <span class="bound">da</span> <span class="keyword1">dvd</span> <span class="bound">d</span> <span class="keyword1">then</span> ln <span class="main">(</span>aprimedivisor <span class="bound">da</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.swap<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> floor <span class="main">(</span><span class="free">n</span><span class="main">/</span><span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="keyword3"><span class="command">assume</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">da</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="keyword1">if</span> primepow <span class="skolem">d</span> <span class="main">∧</span> <span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="bound">da</span> <span class="keyword1">then</span> ln <span class="main">(</span>real <span class="main">(</span>aprimedivisor <span class="skolem">d</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span>
            <span class="main">(</span><span class="main">∑</span><span class="bound">da</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="keyword1">if</span> <span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="bound">da</span> <span class="keyword1">then</span> mangoldt <span class="skolem">d</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mangoldt_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> mangoldt <span class="skolem">d</span> <span class="main">*</span> real <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.inter_filter <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="bound">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="bound">k</span><span class="main">*</span><span class="skolem">d</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">}</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">k</span> <span class="main">*</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> divisors<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">d</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> k <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">*</span> <span class="skolem">d</span> <span class="main">≤</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">d</span> <span class="main">*</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_right_mono<span class="main">)</span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">d</span> <span class="main">*</span> <span class="skolem">d</span> <span class="main">≤</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">d</span> <span class="main">*</span> <span class="skolem">d</span> <span class="main">+</span> <span class="free">n</span> <span class="keyword1">mod</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> le_add1<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">*</span> <span class="skolem">d</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">*</span> <span class="skolem">d</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> d k <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">*</span><span class="skolem">d</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">…</span> <span class="main">=</span> card <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_image<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">d</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">⌊</span><span class="free">n</span> <span class="main">/</span> <span class="skolem">d</span><span class="main">⌋</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> floor_divide_of_nat_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> real_of_int <span class="main">⌊</span><span class="free">n</span> <span class="main">/</span> <span class="skolem">d</span><span class="main">⌋</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">da</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="keyword1">if</span> primepow <span class="skolem">d</span> <span class="main">∧</span> <span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="bound">da</span> <span class="keyword1">then</span> ln <span class="main">(</span>real <span class="main">(</span>aprimedivisor <span class="skolem">d</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span>
            mangoldt <span class="skolem">d</span> <span class="main">*</span> real_of_int <span class="main">⌊</span>real <span class="free">n</span> <span class="main">/</span> real <span class="skolem">d</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">da</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="bound">d</span><span class="main">.</span> <span class="keyword1">if</span> primepow <span class="bound">da</span> <span class="main">∧</span>
      <span class="bound">da</span> <span class="keyword1">dvd</span> <span class="bound">d</span> <span class="keyword1">then</span> ln <span class="main">(</span>aprimedivisor <span class="bound">da</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> 
    sum <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> floor <span class="main">(</span><span class="free">n</span><span class="main">/</span><span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> ln_primefact <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> ln <span class="bound">d</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> floor <span class="main">(</span><span class="free">n</span><span class="main">/</span><span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> ln_fact <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Bertrand-div_2_mult_2_bds"><span class="command">lemma</span></span> div_2_mult_2_bds<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="free">d</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">⌊</span><span class="free">n</span> <span class="main">/</span> <span class="free">d</span><span class="main">⌋</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">⌊</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="free">d</span><span class="main">⌋</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌊</span><span class="free">n</span> <span class="main">/</span> <span class="free">d</span><span class="main">⌋</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">⌊</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="free">d</span><span class="main">⌋</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌊</span><span class="numeral">2</span><span class="main">::</span>real<span class="main">⌋</span> <span class="main">*</span> <span class="main">⌊</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="free">d</span><span class="main">⌋</span> <span class="main">≤</span> <span class="main">⌊</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="free">d</span><span class="main">)</span><span class="main">⌋</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> le_mult_floor<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">⌊</span><span class="free">n</span> <span class="main">/</span> <span class="free">d</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> floor_mono<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">⌊</span><span class="free">n</span> <span class="main">/</span> <span class="free">d</span><span class="main">⌋</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">⌊</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="free">d</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="free">d</span><span class="main">)</span> <span class="main">≤</span> real <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">d</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> div_mult2_eq <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> div_mult2_eq<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌊</span><span class="free">n</span> <span class="main">/</span> <span class="free">d</span><span class="main">⌋</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">⌊</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="free">d</span><span class="main">⌋</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> of_nat_add of_nat_mult floor_conv_div_nat <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Bertrand-n_div_d_eq_1"><span class="command">lemma</span></span> n_div_d_eq_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">∈</span> <span class="main">{</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">⌊</span>real <span class="free">n</span> <span class="main">/</span> real <span class="free">d</span><span class="main">⌋</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="free">d</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> floor_eq<span class="main">)</span>
    
<span class="keyword1" id="Bertrand-psi_bounds_ln_fact"><span class="command">lemma</span></span> psi_bounds_ln_fact<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>fact <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> psi <span class="free">n</span>"</span></span>
        <span class="quoted"><span class="quoted">"psi <span class="free">n</span> <span class="main">-</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>fact <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?d</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="keyword1">mod</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⌊</span><span class="var">?k</span> <span class="main">/</span> <span class="skolem">d</span><span class="main">⌋</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&gt;</span> <span class="var">?k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">d</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> that div_less <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> <span class="var">?k</span> <span class="keyword1">div</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⌊</span><span class="var">?k</span> <span class="main">/</span> <span class="skolem">d</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> floor_divide_of_nat_eq <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌊</span><span class="var">?k</span> <span class="main">/</span> <span class="skolem">d</span><span class="main">⌋</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> sum_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="numeral">2</span><span class="main">*</span><span class="var">?k</span><span class="main">+</span><span class="var">?d</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> <span class="main">⌊</span><span class="var">?k</span> <span class="main">/</span> <span class="bound">d</span><span class="main">⌋</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="var">?k</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> <span class="main">⌊</span><span class="var">?k</span> <span class="main">/</span> <span class="bound">d</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_right<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ln_fact_conv_mangoldt <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>fact <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> <span class="main">⌊</span><span class="skolem">n</span> <span class="main">/</span> <span class="bound">d</span><span class="main">⌋</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> <span class="main">⌊</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">n</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="bound">d</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">⌊</span><span class="var">?k</span> <span class="main">/</span> <span class="bound">d</span><span class="main">⌋</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> div_2_mult_2_bds<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono mult_left_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> of_int_le_iff<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> mangoldt_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> <span class="main">⌊</span><span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="bound">d</span><span class="main">⌋</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> mangoldt <span class="bound">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> sum.distrib sum_distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="numeral">2</span><span class="main">*</span><span class="var">?k</span><span class="main">+</span><span class="var">?d</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> <span class="main">⌊</span><span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="bound">d</span><span class="main">⌋</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> mangoldt <span class="bound">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sum_eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="var">?k</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> <span class="main">⌊</span><span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="bound">d</span><span class="main">⌋</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> mangoldt <span class="bound">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> ln_fact_conv_mangoldt psi_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>fact <span class="var">?k</span><span class="main">)</span> <span class="main">+</span> psi <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>fact <span class="skolem">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>fact <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> psi <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="var"><span class="quoted"><span class="var">?d</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="keyword1">mod</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> psi_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"psi <span class="skolem">n</span> <span class="main">-</span> psi <span class="var">?k</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="numeral">2</span><span class="main">*</span><span class="var">?k</span><span class="main">+</span><span class="var">?d</span><span class="main">.</span> mangoldt <span class="bound">d</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="var">?k</span><span class="main">.</span> mangoldt <span class="bound">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum mangoldt <span class="main">(</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">n</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_diff<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">∈</span><span class="main">(</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">n</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> 
                    <span class="main">(</span><span class="keyword1">if</span> <span class="bound">d</span> <span class="main">≤</span> <span class="var">?k</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> mangoldt <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="numeral">2</span><span class="main">*</span><span class="var">?k</span><span class="main">+</span><span class="var">?d</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">d</span> <span class="main">≤</span> <span class="var">?k</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> mangoldt <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_left<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">d</span> <span class="main">≤</span> <span class="var">?k</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> mangoldt <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">d</span> <span class="main">≤</span> <span class="var">?k</span> <span class="keyword1">then</span> mangoldt <span class="bound">d</span> <span class="main">*</span> <span class="main">0</span> <span class="keyword1">else</span> mangoldt <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> div_2_mult_2_bds<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">d</span> <span class="main">≤</span> <span class="var">?k</span> <span class="keyword1">then</span> mangoldt <span class="bound">d</span> <span class="main">*</span> <span class="main">(</span><span class="main">⌊</span><span class="skolem">n</span><span class="main">/</span><span class="bound">d</span><span class="main">⌋</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">⌊</span><span class="var">?k</span><span class="main">/</span><span class="bound">d</span><span class="main">⌋</span><span class="main">)</span> <span class="keyword1">else</span> mangoldt <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono<span class="main">)</span> 
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> mangoldt_nonneg <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult_left_mono <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_int_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> n_div_d_eq_1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">d</span> <span class="main">≤</span> <span class="var">?k</span> <span class="keyword1">then</span> mangoldt <span class="bound">d</span> <span class="main">*</span> <span class="main">(</span><span class="main">⌊</span><span class="skolem">n</span><span class="main">/</span><span class="bound">d</span><span class="main">⌋</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">⌊</span><span class="var">?k</span><span class="main">/</span><span class="bound">d</span><span class="main">⌋</span><span class="main">)</span> <span class="keyword1">else</span> mangoldt <span class="bound">d</span> <span class="main">*</span> <span class="main">⌊</span><span class="skolem">n</span><span class="main">/</span><span class="bound">d</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> real_of_int <span class="main">(</span><span class="main">⌊</span>real <span class="skolem">n</span> <span class="main">/</span> real <span class="bound">d</span><span class="main">⌋</span><span class="main">)</span> <span class="main">-</span>
                     <span class="main">(</span><span class="keyword1">if</span> <span class="bound">d</span> <span class="main">≤</span> <span class="var">?k</span> <span class="keyword1">then</span> <span class="numeral">2</span> <span class="main">*</span> mangoldt <span class="bound">d</span> <span class="main">*</span> real_of_int <span class="main">⌊</span>real <span class="var">?k</span> <span class="main">/</span> real <span class="bound">d</span><span class="main">⌋</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> real_of_int <span class="main">(</span><span class="main">⌊</span>real <span class="skolem">n</span> <span class="main">/</span> real <span class="bound">d</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> 
                  <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">d</span> <span class="main">≤</span> <span class="var">?k</span> <span class="keyword1">then</span> <span class="numeral">2</span> <span class="main">*</span> mangoldt <span class="bound">d</span> <span class="main">*</span> real_of_int <span class="main">⌊</span>real <span class="var">?k</span> <span class="main">/</span> real <span class="bound">d</span><span class="main">⌋</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_subtractf<span class="main">)</span>    
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">d</span> <span class="main">≤</span> <span class="var">?k</span> <span class="keyword1">then</span> <span class="numeral">2</span> <span class="main">*</span> mangoldt <span class="bound">d</span> <span class="main">*</span> real_of_int <span class="main">⌊</span>real <span class="var">?k</span> <span class="main">/</span> real <span class="bound">d</span><span class="main">⌋</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="var">?k</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">d</span> <span class="main">≤</span> <span class="var">?k</span> <span class="keyword1">then</span> <span class="numeral">2</span> <span class="main">*</span> mangoldt <span class="bound">d</span> <span class="main">*</span> real_of_int <span class="main">⌊</span>real <span class="var">?k</span> <span class="main">/</span> real <span class="bound">d</span><span class="main">⌋</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_right<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="var">?k</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> mangoldt <span class="bound">d</span> <span class="main">*</span> real_of_int <span class="main">⌊</span>real <span class="var">?k</span> <span class="main">/</span> real <span class="bound">d</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="var">?k</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> real_of_int <span class="main">⌊</span>real <span class="var">?k</span> <span class="main">/</span> real <span class="bound">d</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left mult_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> real_of_int <span class="main">⌊</span>real <span class="skolem">n</span> <span class="main">/</span> real <span class="bound">d</span><span class="main">⌋</span><span class="main">)</span> <span class="main">-</span> <span class="main">…</span> <span class="main">=</span> 
               ln <span class="main">(</span>fact <span class="skolem">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>fact <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ln_fact_conv_mangoldt<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"psi <span class="skolem">n</span> <span class="main">-</span> psi <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> ln <span class="main">(</span>fact <span class="skolem">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>fact <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Bertrand-psi_bounds_induct"><span class="command">lemma</span></span> psi_bounds_induct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"real <span class="free">n</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">-</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">≤</span> psi <span class="free">n</span>"</span></span>
  <span class="quoted"><span class="quoted">"psi <span class="free">n</span> <span class="main">-</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> real <span class="free">n</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> le_imp_neg_le<span class="main">[</span><span class="operator">OF</span> ln_fact_diff_bounds<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">-</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> ln <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span>
         <span class="main">≤</span> <span class="free">n</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">-</span> abs<span class="main">(</span>ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>fact <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="free">n</span> <span class="main">*</span> ln <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>fact <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> psi_bounds_ln_fact <span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> psi <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"real <span class="free">n</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">-</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">≤</span> psi <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> psi_bounds_ln_fact <span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"psi <span class="free">n</span> <span class="main">-</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>fact <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">+</span> abs<span class="main">(</span>ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>fact <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="free">n</span> <span class="main">*</span> ln <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> ln_fact_diff_bounds <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs<span class="main">(</span>ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>fact <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="free">n</span> <span class="main">*</span> ln <span class="numeral">2</span><span class="main">)</span>
            <span class="main">≤</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"psi <span class="free">n</span> <span class="main">-</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> real <span class="free">n</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
  

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Bounding the psi function›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this section, we will first prove the relatively tight estimate
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">"psi <span class="free"><span class="free">n</span></span> <span class="main"><span class="main">≤</span></span> <span class="numeral"><span class="numeral">3</span></span> <span class="main"><span class="main">/</span></span> <span class="numeral"><span class="numeral">2</span></span> <span class="main"><span class="main">+</span></span> ln <span class="numeral"><span class="numeral">2</span></span> <span class="main"><span class="main">*</span></span> <span class="free"><span class="free">n</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">n</span></span> <span class="main"><span class="main">≤</span></span> <span class="numeral"><span class="numeral">128</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and then use the 
  recurrence we have just derived to extend it to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">"psi <span class="free"><span class="free">n</span></span> <span class="main"><span class="main">≤</span></span> <span class="numeral"><span class="numeral">551</span></span> <span class="main"><span class="main">/</span></span> <span class="numeral"><span class="numeral">256</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for 
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">n</span></span> <span class="main"><span class="main">≤</span></span> <span class="numeral"><span class="numeral">1024</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, at which point applying the recurrence can be used to prove 
  the same bound for arbitrarily big numbers.

  First of all, we will prove the bound for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">n</span></span> <span class="main"><span class="main">&lt;=</span></span> <span class="numeral"><span class="numeral">128</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> using reflection and
  approximation.
›</span></span>  

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Bertrand-Ball_insertD"><span class="command">lemma</span></span> Ball_insertD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>insert <span class="free">y</span> <span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Bertrand-meta_eq_TrueE"><span class="command">lemma</span></span> meta_eq_TrueE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="free">A</span> <span class="main">≡</span> Trueprop True <span class="main">⟹</span> <span class="keyword1">PROP</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Bertrand-pre_mangoldt_pos"><span class="command">lemma</span></span> pre_mangoldt_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"pre_mangoldt <span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pre_mangoldt_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> primepow_gt_Suc_0<span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Bertrand-psi_conv_pre_mangoldt"><span class="command">lemma</span></span> psi_conv_pre_mangoldt<span class="main">:</span> <span class="quoted"><span class="quoted">"psi <span class="free">n</span> <span class="main">=</span> ln <span class="main">(</span>real <span class="main">(</span>prod pre_mangoldt <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> psi_def mangoldt_def pre_mangoldt_def ln_prod primepow_gt_Suc_0 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Bertrand-eval_psi_aux1"><span class="command">lemma</span></span> eval_psi_aux1<span class="main">:</span> <span class="quoted"><span class="quoted">"psi <span class="main">0</span> <span class="main">=</span> ln <span class="main">(</span>real <span class="main">(</span>numeral Num.One<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> psi_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Bertrand-eval_psi_aux2"><span class="command">lemma</span></span> eval_psi_aux2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"psi <span class="free">m</span> <span class="main">=</span> ln <span class="main">(</span>real <span class="main">(</span>numeral <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"pre_mangoldt <span class="free">n</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"numeral <span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">=</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"psi <span class="free">n</span> <span class="main">=</span> ln <span class="main">(</span>real <span class="free">z</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pre_mangoldt_pos<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"psi <span class="free">n</span> <span class="main">=</span> psi <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ln <span class="main">(</span>real <span class="free">y</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">x</span> <span class="main">=</span> Suc <span class="main">0</span><span class="main">..</span><span class="free">m</span><span class="main">.</span> real <span class="main">(</span>pre_mangoldt <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> psi_conv_pre_mangoldt prod.nat_ivl_Suc' mult_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ln <span class="main">(</span>real <span class="free">y</span><span class="main">)</span> <span class="main">+</span> psi <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ln_mult<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pre_mangoldt_pos prod_pos psi_conv_pre_mangoldt<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"psi <span class="free">m</span> <span class="main">=</span> ln <span class="main">(</span>real <span class="main">(</span>numeral <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>real <span class="free">y</span><span class="main">)</span> <span class="main">+</span> <span class="main">…</span> <span class="main">=</span> ln <span class="main">(</span>real <span class="main">(</span>numeral <span class="free">x</span> <span class="main">*</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ln_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Bertrand-Ball_atLeast0AtMost_doubleton"><span class="command">lemma</span></span> Ball_atLeast0AtMost_doubleton<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"psi <span class="main">0</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> real <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"psi <span class="main">1</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> real <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> psi <span class="bound">x</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> real <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> One_nat_def atLeast0_atMost_Suc ball_simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Bertrand-Ball_atLeast0AtMost_insert"><span class="command">lemma</span></span> Ball_atLeast0AtMost_insert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> psi <span class="bound">x</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> real <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"psi <span class="main">(</span>numeral <span class="free">n</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> real <span class="main">(</span>numeral <span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> pred_numeral <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span>numeral <span class="free">n</span><span class="main">}</span><span class="main">.</span> psi <span class="bound">x</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> real <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> numeral_eq_Suc<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> atLeast0_atMost_Suc<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">subst</span> ball_simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> numeral_eq_Suc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Bertrand-eval_psi_ineq_aux"><span class="command">lemma</span></span> eval_psi_ineq_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"psi <span class="free">n</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"psi <span class="free">n</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Bertrand-eval_psi_ineq_aux2"><span class="command">lemma</span></span> eval_psi_ineq_aux2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"numeral <span class="free">m</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"ln <span class="main">(</span>real <span class="main">(</span>numeral <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> real <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>real <span class="main">(</span>numeral <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> real <span class="free">n</span> <span class="main">⟷</span> 
          <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>real <span class="main">(</span>numeral <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> real <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> log_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>real <span class="main">(</span>numeral <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> log <span class="numeral">2</span> <span class="main">(</span>real <span class="main">(</span>numeral <span class="free">m</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> of_nat_power<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> log_nat_power<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> real <span class="free">n</span> <span class="main">⟷</span> real <span class="main">(</span><span class="main">(</span>numeral <span class="free">m</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="keyword1">powr</span> real <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Transcendental.log_le_iff<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> real <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_realpow <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="main">(</span>numeral <span class="free">m</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> <span class="main">…</span> <span class="main">⟷</span> numeral <span class="free">m</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> of_nat_le_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Bertrand-eval_psi_ineq_aux_mono"><span class="command">lemma</span></span> eval_psi_ineq_aux_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"psi <span class="free">n</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"psi <span class="free">m</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"psi <span class="free">n</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"psi <span class="free">m</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"psi <span class="free">m</span> <span class="main">=</span> psi <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≤</span> <span class="free">m</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Bertrand-not_primepow_1_nat"><span class="command">lemma</span></span> not_primepow_1_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>primepow <span class="main">(</span><span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 
<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹bertrand.ML›</span>

<span class="comment1">(* This should not take more than 1 minute *)</span>
<span class="keyword1"><span class="command">local_setup</span></span> <span class="quoted">‹<span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span>
<span class="keyword2"><span class="keyword">let</span></span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tac</span> <span class="main">{</span>context <span class="main">=</span> <span class="entity">ctxt</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">psi_cache</span> <span class="main">=</span> <span class="entity">Bertrand.prove_psi</span> <span class="entity">ctxt</span> <span class="inner_numeral">129</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prove_psi_ineqs</span> <span class="entity">ctxt</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tac</span> <span class="main">{</span>context <span class="main">=</span> <span class="entity">ctxt</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> 
            HEADGOAL <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> eval_psi_ineq_aux2<span class="antiquote">}</span></span></span> THEN' <span class="entity">Simplifier.simp_tac</span> <span class="entity">ctxt</span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prove_by_approx</span> <span class="entity">n</span> <span class="entity">thm</span> <span class="main">=</span>
            <span class="keyword2"><span class="keyword">let</span></span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> <span class="entity">thm</span> RS <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> eval_psi_ineq_aux<span class="antiquote">}</span></span></span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="main">[</span><span class="entity">prem</span><span class="main">]</span> <span class="main">=</span> Thm.prems_of <span class="entity">thm</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prem</span> <span class="main">=</span> Goal.prove <span class="entity">ctxt</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> <span class="entity">prem</span> <span class="entity">tac</span>
            <span class="keyword2"><span class="keyword">in</span></span>
              <span class="entity">prem</span> RS <span class="entity">thm</span>
            <span class="keyword2"><span class="keyword">end</span></span>
          <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prove_by_mono</span> <span class="entity">last_thm</span> <span class="entity">last_thm'</span> <span class="entity">thm</span> <span class="main">=</span>
            <span class="keyword2"><span class="keyword">let</span></span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> eval_psi_ineq_aux_mono<span class="antiquote">}</span></span></span> OF <span class="main">[</span><span class="entity">last_thm</span><span class="main">,</span> <span class="entity">thm</span><span class="main">,</span> <span class="entity">last_thm'</span><span class="main">]</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="main">[</span><span class="entity">prem</span><span class="main">]</span> <span class="main">=</span> Thm.prems_of <span class="entity">thm</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prem</span> <span class="main">=</span> Goal.prove <span class="entity">ctxt</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> <span class="entity">prem</span> <span class="main">(</span>K <span class="main">(</span>HEADGOAL <span class="main">(</span><span class="entity">Simplifier.simp_tac</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="keyword2"><span class="keyword">in</span></span>
              <span class="entity">prem</span> RS <span class="entity">thm</span>
            <span class="keyword2"><span class="keyword">end</span></span>
          <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">go</span> <span class="main">_</span> <span class="entity">acc</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="entity">acc</span>
            <span class="main">|</span> <span class="entity">go</span> <span class="entity">last</span> <span class="entity">acc</span> <span class="main">(</span><span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">x</span><span class="main">,</span> <span class="entity">thm</span><span class="main">)</span> :: <span class="entity">xs</span><span class="main">)</span> <span class="main">=</span>
                <span class="keyword2"><span class="keyword">let</span></span>
                  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm'</span> <span class="main">=</span>
                    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">last</span> <span class="keyword2"><span class="keyword">of</span></span>
                      NONE <span class="main">=&gt;</span> <span class="entity">prove_by_approx</span> <span class="entity">n</span> <span class="entity">thm</span>
                    <span class="main">|</span> SOME <span class="main">(</span><span class="entity">last_x</span><span class="main">,</span> <span class="entity">last_thm</span><span class="main">,</span> <span class="entity">last_thm'</span><span class="main">)</span> <span class="main">=&gt;</span> 
                        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">last_x</span> <span class="main">=</span> <span class="entity">x</span> <span class="keyword2"><span class="keyword">then</span></span> 
                          <span class="entity">prove_by_mono</span> <span class="entity">last_thm</span> <span class="entity">last_thm'</span> <span class="entity">thm</span> 
                        <span class="keyword2"><span class="keyword">else</span></span>
                          <span class="entity">prove_by_approx</span> <span class="entity">n</span> <span class="entity">thm</span>
                <span class="keyword2"><span class="keyword">in</span></span>
                  <span class="entity">go</span> <span class="main">(</span>SOME <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">thm</span><span class="main">,</span> <span class="entity">thm'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">thm'</span> :: <span class="entity">acc</span><span class="main">)</span> <span class="entity">xs</span>
                <span class="keyword2"><span class="keyword">end</span></span>
        <span class="keyword2"><span class="keyword">in</span></span>
          rev o <span class="entity">go</span> NONE <span class="main">[</span><span class="main">]</span>
        <span class="keyword2"><span class="keyword">end</span></span>
            
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">psi_ineqs</span> <span class="main">=</span> <span class="entity">prove_psi_ineqs</span> <span class="entity">ctxt</span> <span class="entity">psi_cache</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prove_ball</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">thm1</span> :: <span class="entity">thm2</span> :: <span class="entity">thms</span><span class="main">)</span> <span class="main">=</span>
            <span class="keyword2"><span class="keyword">let</span></span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> Ball_atLeast0AtMost_doubleton<span class="antiquote">}</span></span></span> OF <span class="main">[</span><span class="entity">thm1</span><span class="main">,</span> <span class="entity">thm2</span><span class="main">]</span>
              <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">solve_prem</span> <span class="entity">thm</span> <span class="main">=</span>
                <span class="keyword2"><span class="keyword">let</span></span>
                  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tac</span> <span class="main">{</span>context <span class="main">=</span> <span class="entity">ctxt</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> HEADGOAL <span class="main">(</span><span class="entity">Simplifier.simp_tac</span> <span class="entity">ctxt</span><span class="main">)</span>
                  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm'</span> <span class="main">=</span> Goal.prove <span class="entity">ctxt</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> <span class="main">(</span>Thm.cprem_of <span class="entity">thm</span> <span class="inner_numeral">1</span> |&gt; Thm.term_of<span class="main">)</span> <span class="entity">tac</span>
                <span class="keyword2"><span class="keyword">in</span></span>
                  <span class="entity">thm'</span> RS <span class="entity">thm</span>
                <span class="keyword2"><span class="keyword">end</span></span>
              <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">go</span> <span class="entity">thm</span> <span class="entity">thm'</span> <span class="main">=</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> Ball_atLeast0AtMost_insert<span class="antiquote">}</span></span></span> OF <span class="main">[</span><span class="entity">thm'</span><span class="main">,</span> <span class="entity">thm</span><span class="main">]</span><span class="main">)</span> |&gt; <span class="entity">solve_prem</span>
            <span class="keyword2"><span class="keyword">in</span></span>
              fold <span class="entity">go</span> <span class="entity">thms</span> <span class="entity">thm</span>
            <span class="keyword2"><span class="keyword">end</span></span>
        <span class="main">|</span> <span class="entity">prove_ball</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> Match
    <span class="keyword2"><span class="keyword">in</span></span>
      HEADGOAL <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">prove_ball</span> <span class="entity">ctxt</span> <span class="entity">psi_ineqs</span><span class="main">]</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> Goal.prove <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">prop</span> <span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="numeral">128</span><span class="main">}</span><span class="main">.</span> psi <span class="bound">n</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="bound">n</span>"</span><span class="antiquote">}</span></span> <span class="entity">tac</span>
<span class="keyword2"><span class="keyword">in</span></span>
  Local_Theory.note <span class="main">(</span><span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> psi_ubound_log_128<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="entity">thm</span><span class="main">]</span><span class="main">)</span> <span class="entity">ctxt</span> |&gt; snd
<span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Bertrand-psi_ubound_aux"><span class="command">lemma</span></span> psi_ubound_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> ln <span class="bound">x</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>ln <span class="numeral">2</span> <span class="main">*</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≥</span> <span class="free">f</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> DERIV_nonpos_imp_nonincreasing<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="numeral">4</span> <span class="main">*</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> <span class="bound">x</span><span class="main">^</span><span class="numeral">2</span> <span class="main">/</span> ln <span class="numeral">2</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> 1 assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">has_real_derivative</span> <span class="skolem">f'</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f_def f'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> ln_2_ge <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span><span class="numeral">4</span> <span class="main">≤</span> ln <span class="main">(</span><span class="numeral">2</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> ln <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="skolem">t</span> <span class="main">≥</span> <span class="main">1</span><span class="main">/</span><span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> 1 assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="skolem">t</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f'_def <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">f'</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">t</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  These next rules are used in combination with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> psi_bounds_induct<span class="antiquote"><span class="antiquote">}</span></span></span></span> and 
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> psi_ubound_log_128<span class="antiquote"><span class="antiquote">}</span></span></span></span> to extend the upper bound for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"psi"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> from values no greater 
  than 128 to values no greater than 1024. The constant factor of the upper bound changes every 
  time, but once we have reached 1024, the recurrence is self-sustaining in the sense that we do 
  not have to adjust the constant factor anymore in order to double the range.
›</span></span>
<span class="keyword1" id="Bertrand-psi_ubound_log_double_cases'"><span class="command">lemma</span></span> psi_ubound_log_double_cases'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟹</span> psi <span class="bound">n</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> real <span class="bound">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">m'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m'</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="free">m</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≤</span> <span class="free">c'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">+</span> <span class="free">c</span><span class="main">/</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> ln <span class="main">(</span><span class="free">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>ln <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"psi <span class="free">n</span> <span class="main">≤</span> <span class="free">c'</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> real <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="free">m</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"psi <span class="free">n</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> real <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> assms<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≤</span> <span class="free">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_right_mono<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="free">m</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> psi_bounds_induct<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"psi <span class="free">n</span> <span class="main">≤</span> real <span class="free">n</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">+</span> <span class="numeral">4</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">+</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> assms<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> real <span class="free">n</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="main">…</span> <span class="main">=</span> <span class="free">c</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> real <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="free">n</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">+</span> <span class="numeral">4</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">+</span> <span class="main">…</span> <span class="main">=</span> 
               <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">c</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> real <span class="free">n</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>ln <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>real <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> ln <span class="main">(</span><span class="free">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>ln <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> psi_ubound_aux<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> ln <span class="main">(</span><span class="free">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>ln <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c'</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="free">c</span><span class="main">/</span><span class="numeral">2</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">≤</span> <span class="main">(</span><span class="free">c'</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="free">c</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> real <span class="free">n</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">c</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> real <span class="free">n</span> <span class="main">+</span> <span class="main">(</span><span class="free">c'</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="free">c</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> real <span class="free">n</span> <span class="main">=</span> <span class="free">c'</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> real <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_left_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>  

<span class="keyword1" id="Bertrand-psi_ubound_log_double_cases"><span class="command">lemma</span></span> psi_ubound_log_double_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="free">m</span><span class="main">.</span> psi <span class="bound">n</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> real <span class="bound">n</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">+</span> <span class="free">c</span><span class="main">/</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> ln <span class="main">(</span><span class="free">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>ln <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">m'</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≤</span> <span class="free">c'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="free">m'</span><span class="main">.</span> psi <span class="bound">n</span> <span class="main">≤</span> <span class="free">c'</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> real <span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI assms psi_ubound_log_double_cases'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">m'</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">c'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Bertrand-psi_ubound_log_1024"><span class="command">lemma</span></span> psi_ubound_log_1024<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="numeral">1024</span><span class="main">.</span> psi <span class="bound">n</span> <span class="main">≤</span> <span class="numeral">551</span> <span class="main">/</span> <span class="numeral">256</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> real <span class="bound">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> psi_ubound_log_128 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="numeral">128</span><span class="main">.</span> psi <span class="bound">n</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> real <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="numeral">256</span><span class="main">.</span> psi <span class="bound">n</span> <span class="main">≤</span> <span class="numeral">1025</span> <span class="main">/</span> <span class="numeral">512</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> real <span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> psi_ubound_log_double_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span>Float <span class="numeral">624</span> <span class="main">(</span><span class="main">-</span> <span class="numeral">7</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ub_ln <span class="numeral">9</span> <span class="numeral">129</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span>
    <span class="keyword1"><span class="command">from</span></span> ub_ln<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> ln_2_ge <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="numeral">512</span><span class="main">.</span> psi <span class="bound">n</span> <span class="main">≤</span> <span class="numeral">549</span> <span class="main">/</span> <span class="numeral">256</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> real <span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> psi_ubound_log_double_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span>Float <span class="numeral">180</span> <span class="main">(</span><span class="main">-</span> <span class="numeral">5</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ub_ln <span class="numeral">7</span> <span class="numeral">257</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span>
    <span class="keyword1"><span class="command">from</span></span> ub_ln<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> ln_2_ge <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="numeral">1024</span><span class="main">.</span> psi <span class="bound">n</span> <span class="main">≤</span> <span class="numeral">551</span> <span class="main">/</span> <span class="numeral">256</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> real <span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> psi_ubound_log_double_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span>Float <span class="numeral">203</span> <span class="main">(</span><span class="main">-</span> <span class="numeral">5</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ub_ln <span class="numeral">7</span> <span class="numeral">513</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span>
    <span class="keyword1"><span class="command">from</span></span> ub_ln<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> ln_2_ge <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="Bertrand-psi_bounds_sustained_induct"><span class="command">lemma</span></span> psi_bounds_sustained_induct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">*</span> ln <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">j</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">^</span><span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">^</span><span class="free">j</span><span class="main">)</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">*</span> ln <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">^</span><span class="free">k</span> <span class="main">⟹</span> psi <span class="bound">n</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="bound">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"psi <span class="free">n</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">^</span><span class="free">k</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">from</span></span> psi_bounds_induct<span class="main">(</span>2<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"psi <span class="free">n</span> <span class="main">-</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> real <span class="free">n</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"psi <span class="free">n</span> <span class="main">≤</span> real <span class="free">n</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">+</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>6<span class="main">,</span>7<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> real <span class="free">n</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="free">n</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> real <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> overpower_lemma<span class="main"><span class="main">[</span></span><span class="operator">of</span>
            <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">*</span></span> ln <span class="numeral"><span class="numeral">2</span></span> <span class="main"><span class="main">+</span></span> <span class="main"><span class="main">(</span></span><span class="numeral"><span class="numeral">4</span></span> <span class="main"><span class="main">*</span></span> ln <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">+</span></span> <span class="numeral"><span class="numeral">3</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">+</span></span> <span class="free"><span class="free">c</span></span> <span class="main"><span class="main">*</span></span> ln <span class="numeral"><span class="numeral">2</span></span> <span class="main"><span class="main">*</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">/</span></span> <span class="numeral"><span class="numeral">2</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">1</span></span><span class="main"><span class="main">+</span></span><span class="numeral"><span class="numeral">2</span></span><span class="main"><span class="main">^</span></span><span class="free"><span class="free">j</span></span>"</span></span></span>
            <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">c</span></span> <span class="main"><span class="main">*</span></span> ln <span class="numeral"><span class="numeral">2</span></span> <span class="main"><span class="main">*</span></span> <span class="bound"><span class="bound">x</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">c</span></span> <span class="main"><span class="main">*</span></span> ln <span class="numeral"><span class="numeral">2</span></span> <span class="main"><span class="main">-</span></span> ln <span class="numeral"><span class="numeral">2</span></span> <span class="main"><span class="main">-</span></span> <span class="numeral"><span class="numeral">4</span></span> <span class="main"><span class="main">/</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">-</span></span> <span class="free"><span class="free">c</span></span> <span class="main"><span class="main">/</span></span> <span class="numeral"><span class="numeral">2</span></span> <span class="main"><span class="main">*</span></span> ln <span class="numeral"><span class="numeral">2</span></span>"</span></span></span>
            <span class="quoted"><span class="quoted"><span class="quoted">"real <span class="free"><span class="free">n</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">*</span> ln <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">^</span><span class="free">j</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">^</span><span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">-</span> <span class="free">c</span><span class="main">/</span><span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">…</span><span class="main">)</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">j</span><span class="main">)</span> <span class="main">-</span> <span class="free">c</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">j</span><span class="main">)</span>
          <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">j</span><span class="main">)</span> <span class="main">*</span> ln <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> left_diff_distrib<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">*</span> ln <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">^</span><span class="free">j</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">j</span><span class="main">)</span> <span class="main">-</span> <span class="free">c</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">j</span><span class="main">)</span>
          <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">j</span><span class="main">)</span> <span class="main">*</span> ln <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_pos_pos<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">j</span><span class="main">)</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> ln <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">j</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span>
                    <span class="main">+</span> <span class="free">c</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">j</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span><span class="main">::</span><span class="quoted">real</span>
      <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">^</span><span class="free">j</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">j</span> <span class="main">&gt;</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_pos_pos<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> x_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">(</span><span class="bound">x</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> ln <span class="bound">x</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="bound">x</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword1">has_real_derivative</span> <span class="free">c</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">-</span> ln <span class="numeral">2</span> <span class="main">-</span> <span class="numeral">4</span> <span class="main">/</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">c</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> refl <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">x</span>›</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">^</span><span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">^</span><span class="free">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_pos_pos<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">/</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="numeral">4</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">^</span><span class="free">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> divide_left_mono mult_pos_pos add_pos_pos x x_pos<span class="main">)</span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">^</span><span class="free">j</span><span class="main">)</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">*</span> ln <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">-</span> <span class="free">c</span><span class="main">/</span><span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">=</span> <span class="free">c</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">-</span> <span class="free">c</span><span class="main">/</span><span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">-</span> ln <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">-</span> ln <span class="numeral">2</span> <span class="main">-</span> <span class="numeral">4</span> <span class="main">/</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">c</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">^</span><span class="free">j</span> <span class="main">=</span> real <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">^</span><span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> real <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">^</span><span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">^</span><span class="free">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">^</span><span class="free">j</span> <span class="main">≤</span> real <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_left_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Bertrand-psi_bounds_sustained"><span class="command">lemma</span></span> psi_bounds_sustained<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">^</span><span class="free">k</span> <span class="main">⟹</span> psi <span class="bound">n</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="bound">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">*</span> ln <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">^</span><span class="free">k</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">≤</span> <span class="main">(</span><span class="free">c</span><span class="main">/</span><span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">^</span><span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">^</span><span class="free">k</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">c</span><span class="main">/</span><span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> ln <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"psi <span class="free">n</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"psi <span class="skolem">n</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">^</span><span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="skolem">n</span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">j</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>4<span class="main">)</span> 0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> psi_def mangoldt_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> c_div_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">/</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="free">c</span><span class="main">/</span><span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> psi_bounds_sustained_induct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">/</span><span class="numeral">2</span> <span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">,</span>
             <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> c_div_2 True Suc.IH Suc.prems<span class="main">]</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_lt_k<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> Suc.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> Suc <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">^</span> Suc <span class="skolem">j</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">k</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> power_increasing<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">::</span>nat"</span></span><span class="main">,</span> <span class="operator">OF</span> j_lt_k<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">with</span></span> *<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Bertrand-psi_ubound_log"><span class="command">lemma</span></span> psi_ubound_log<span class="main">:</span> <span class="quoted"><span class="quoted">"psi <span class="free">n</span> <span class="main">≤</span> <span class="numeral">551</span> <span class="main">/</span> <span class="numeral">256</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> psi_bounds_sustained<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="numeral">551</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">256</span> <span class="main">::</span> real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="numeral">10</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> psi_ubound_log_1024 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"psi <span class="skolem">n</span> <span class="main">≤</span> <span class="numeral">551</span> <span class="main">/</span> <span class="numeral">256</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> real <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="numeral">10</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">551</span> <span class="main">/</span> <span class="numeral">256</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span><span class="main">/</span><span class="numeral">3</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">551</span> <span class="main">/</span> <span class="numeral">256</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> ln <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_left_mono ln_2_ge'<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="numeral">10</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">551</span> <span class="main">/</span> <span class="numeral">256</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> ln <span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span>Float <span class="numeral">16</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ub_ln <span class="numeral">3</span> <span class="numeral">1025</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span>
  <span class="keyword1"><span class="command">from</span></span> ub_ln<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> ln_2_ge 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2048</span> <span class="main">*</span> ln <span class="numeral">1025</span> <span class="main">+</span> <span class="numeral">1536</span> <span class="main">≤</span> <span class="numeral">39975</span> <span class="main">*</span> <span class="main">(</span>ln <span class="numeral">2</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">*</span> ln <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="numeral">10</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">551</span> <span class="main">/</span> <span class="numeral">256</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="numeral">10</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Bertrand-psi_ubound_3_2"><span class="command">lemma</span></span> psi_ubound_3_2<span class="main">:</span> <span class="quoted"><span class="quoted">"psi <span class="free">n</span> <span class="main">≤</span> <span class="numeral">3</span><span class="main">/</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">551</span> <span class="main">/</span> <span class="numeral">256</span><span class="main">)</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">551</span> <span class="main">/</span> <span class="numeral">256</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">16</span><span class="main">/</span><span class="numeral">23</span> <span class="main">::</span> real<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_left_mono ln_2_le'<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">551</span> <span class="main">/</span> <span class="numeral">256</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">≤</span> <span class="numeral">3</span><span class="main">/</span><span class="main">(</span><span class="numeral">2</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> of_nat_0_le_iff mult_right_mono <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">551</span> <span class="main">/</span> <span class="numeral">256</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">≤</span> <span class="numeral">3</span><span class="main">/</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> psi_ubound_log<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">n</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Doubling psi and theta›</span></span>  

<span class="keyword1" id="Bertrand-psi_residues_compare_2"><span class="command">lemma</span></span> psi_residues_compare_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"psi_odd_2 <span class="free">n</span> <span class="main">≤</span> psi_even_2 <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"psi_odd_2 <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">∈</span><span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> primepow_odd <span class="bound">d</span><span class="main">}</span><span class="main">.</span> mangoldt_odd <span class="bound">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mangoldt_odd_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.mono_neutral_right<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">∈</span><span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> primepow_odd <span class="bound">d</span><span class="main">}</span><span class="main">.</span> ln <span class="main">(</span>real <span class="main">(</span>aprimedivisor <span class="bound">d</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mangoldt_odd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">∈</span><span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> primepow_even <span class="bound">d</span><span class="main">}</span><span class="main">.</span> ln <span class="main">(</span>real <span class="main">(</span>aprimedivisor <span class="bound">d</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_le_included <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">y</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">y</span></span> <span class="main"><span class="main">*</span></span> aprimedivisor <span class="bound"><span class="bound">y</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarify</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"primepow_odd <span class="skolem">d</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> d <span class="main">=</span> this
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> d'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> primepow_odd_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> d' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">p</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> power_increasing_iff<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_gt_Suc_0_nat<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> d d' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> d' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> one_less_power<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_gt_Suc_0_nat<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> d' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"primepow_even <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> primepow_even_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> primepow_even <span class="bound">d</span><span class="main">}</span><span class="main">.</span> <span class="bound">y</span> <span class="main">*</span> aprimedivisor <span class="bound">y</span> <span class="main">=</span> <span class="skolem">d</span> <span class="main">∧</span>
                       ln <span class="main">(</span>real <span class="main">(</span>aprimedivisor <span class="skolem">d</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> ln <span class="main">(</span>real <span class="main">(</span>aprimedivisor <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> d'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">p</span></span></span> <span class="main"><span class="main"><span class="main">^</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="numeral"><span class="numeral"><span class="numeral">2</span></span></span> <span class="main"><span class="main"><span class="main">*</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">k</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> aprimedivisor_prime_power aprimedivisor_primepow<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_nat_ge_1_iff Suc_le_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">∈</span><span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> primepow_even <span class="bound">d</span><span class="main">}</span><span class="main">.</span> mangoldt_even <span class="bound">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mangoldt_even_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> psi_even_2 <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mangoldt_even_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.mono_neutral_left<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Bertrand-psi_residues_compare"><span class="command">lemma</span></span> psi_residues_compare<span class="main">:</span>
  <span class="quoted"><span class="quoted">"psi_odd <span class="free">n</span> <span class="main">≤</span> psi_even <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> primepow_odd <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> primepow_odd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"mangoldt_odd <span class="main">1</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mangoldt_odd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> primepow_even <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> primepow_gt_Suc_0<span class="main">[</span><span class="operator">OF</span> primepow_even_imp_primepow<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> mangoldt_even_def <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"mangoldt_even <span class="main">1</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> psi_odd_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"psi_odd <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt_odd <span class="bound">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> psi_odd_2 <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="main">1</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_nat_numeral sum.atLeast_Suc_atMost<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> psi_residues_compare_2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> psi_even_2 <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> ** <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> psi_even <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="main">1</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_nat_numeral sum.atLeast_Suc_atMost psi_even_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Bertrand-primepow_iff_even_sqr"><span class="command">lemma</span></span> primepow_iff_even_sqr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"primepow <span class="free">n</span> <span class="main">⟷</span> primepow_even <span class="main">(</span><span class="free">n</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> primepow_even_altdef aprimedivisor_primepow_power primepow_power_iff_nat
                 prime_elem_multiplicity_power_distrib prime_aprimedivisor' prime_imp_prime_elem
                 unit_factor_nat_def primepow_gt_0_nat <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> primepow_gt_Suc_0<span class="main">)</span>

<span class="keyword1" id="Bertrand-psi_sqrt"><span class="command">lemma</span></span> psi_sqrt<span class="main">:</span> <span class="quoted"><span class="quoted">"psi <span class="main">(</span>Discrete.sqrt <span class="free">n</span><span class="main">)</span> <span class="main">=</span> psi_even <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">with</span></span> psi_def psi_even_def <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">m</span><span class="main">.</span> Suc <span class="skolem">n</span> <span class="main">=</span> <span class="bound">m</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> sqrt_Suc <span class="keyword1"><span class="command">have</span></span> sqrt_seq<span class="main">:</span> <span class="quoted"><span class="quoted">"Discrete.sqrt<span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> Suc<span class="main">(</span>Discrete.sqrt <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> asm <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted">"<span class="skolem"><span class="skolem">m</span></span>"</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"   Suc <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">m</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> sqrt_seq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc<span class="main">(</span>Discrete.sqrt <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">m</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">m</span><span class="main">^</span><span class="numeral">2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> suc_sqrt_n_sqrt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc<span class="main">(</span>Discrete.sqrt <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> sqrt_seq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"psi <span class="main">(</span>Discrete.sqrt <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> psi <span class="main">(</span>Suc <span class="main">(</span>Discrete.sqrt <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> psi_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> psi <span class="main">(</span>Discrete.sqrt <span class="skolem">n</span><span class="main">)</span> <span class="main">+</span> mangoldt <span class="main">(</span>Suc <span class="main">(</span>Discrete.sqrt <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> Suc.IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"psi <span class="main">(</span>Discrete.sqrt <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> psi_even <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mangoldt <span class="main">(</span>Suc <span class="main">(</span>Discrete.sqrt <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> mangoldt_even <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"primepow <span class="main">(</span>Suc<span class="main">(</span>Discrete.sqrt <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> primepow_iff_even_sqr <span class="keyword1"><span class="command">have</span></span> True2<span class="main">:</span> <span class="quoted"><span class="quoted">"primepow_even <span class="main">(</span><span class="main">(</span>Suc<span class="main">(</span>Discrete.sqrt <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> suc_sqrt_n_sqrt <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mangoldt_even <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> mangoldt_even <span class="main">(</span><span class="main">(</span>Suc<span class="main">(</span>Discrete.sqrt <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> mangoldt_even_def True2
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ln <span class="main">(</span>aprimedivisor <span class="main">(</span><span class="main">(</span>Suc <span class="main">(</span>Discrete.sqrt <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"aprimedivisor <span class="main">(</span><span class="main">(</span>Suc <span class="main">(</span>Discrete.sqrt <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> aprimedivisor <span class="main">(</span>Suc <span class="main">(</span>Discrete.sqrt <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> aprimedivisor_primepow_power<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="main">…</span><span class="main">)</span> <span class="main">=</span> mangoldt <span class="main">(</span>Suc <span class="main">(</span>Discrete.sqrt <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mangoldt_def<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> primepow_iff_even_sqr
          <span class="keyword1"><span class="command">have</span></span> False2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> primepow_even <span class="main">(</span><span class="main">(</span>Suc<span class="main">(</span>Discrete.sqrt <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> suc_sqrt_n_sqrt <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mangoldt_even <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> mangoldt_even <span class="main">(</span><span class="main">(</span>Suc<span class="main">(</span>Discrete.sqrt <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> mangoldt_even_def False2
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> mangoldt <span class="main">(</span>Suc <span class="main">(</span>Discrete.sqrt <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mangoldt_def<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">qed</span></span>  
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> psi_even_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"psi_even <span class="skolem">n</span> <span class="main">+</span> mangoldt_even <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> psi_even <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> Suc <span class="skolem">n</span> <span class="main">=</span> <span class="bound">m</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> sqrt_Suc <span class="keyword1"><span class="command">have</span></span> sqrt_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Discrete.sqrt <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> Discrete.sqrt <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lhs<span class="main">:</span> <span class="quoted"><span class="quoted">"psi <span class="main">(</span>Discrete.sqrt <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> psi <span class="main">(</span>Discrete.sqrt <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> primepow_even <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"primepow_even <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> primepow_even_def <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted">"<span class="skolem"><span class="skolem">p</span></span>"</span> <span class="quoted">"<span class="skolem"><span class="skolem">k</span></span>"</span>
            <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">∧</span> prime <span class="skolem">p</span> <span class="main">∧</span> Suc <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">with</span></span> power_even_eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="skolem">k</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> asm <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">with</span></span> psi_even_def mangoldt_even_def
        <span class="keyword1"><span class="command">have</span></span> rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"psi_even <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> psi_even <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> Suc.IH lhs rhs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Bertrand-mangoldt_split"><span class="command">lemma</span></span> mangoldt_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mangoldt <span class="free">d</span> <span class="main">=</span> mangoldt_1 <span class="free">d</span> <span class="main">+</span> mangoldt_even <span class="free">d</span> <span class="main">+</span> mangoldt_odd <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"primepow <span class="free">d</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mangoldt_def mangoldt_1_def mangoldt_even_def mangoldt_odd_def
             <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> primepow_even_imp_primepow primepow_odd_imp_primepow<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mangoldt_def mangoldt_1_def mangoldt_even_def mangoldt_odd_def primepow_cases<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Bertrand-psi_split"><span class="command">lemma</span></span> psi_split<span class="main">:</span> <span class="quoted"><span class="quoted">"psi <span class="free">n</span> <span class="main">=</span> theta <span class="free">n</span> <span class="main">+</span> psi_even <span class="free">n</span> <span class="main">+</span> psi_odd <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> 
     <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> psi_def theta_def psi_even_def psi_odd_def mangoldt_1_def mangoldt_split<span class="main">)</span>

<span class="keyword1" id="Bertrand-psi_mono"><span class="command">lemma</span></span> psi_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> psi <span class="free">m</span> <span class="main">≤</span> psi <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> psi_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono2 mangoldt_nonneg<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Bertrand-psi_pos"><span class="command">lemma</span></span> psi_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> psi <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> psi_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_nonneg mangoldt_nonneg<span class="main">)</span>

<span class="keyword1" id="Bertrand-mangoldt_odd_pos"><span class="command">lemma</span></span> mangoldt_odd_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> mangoldt_odd <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> aprimedivisor_gt_Suc_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">d</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mangoldt_odd_def of_nat_le_iff<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> of_nat_1<span class="main"><span class="main">]</span></span> Suc_le_eq
           <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ln_ge_zero <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> primepow_odd_imp_primepow primepow_gt_Suc_0<span class="main">)</span>

<span class="keyword1" id="Bertrand-psi_odd_mono"><span class="command">lemma</span></span> psi_odd_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> psi_odd <span class="free">m</span> <span class="main">≤</span> psi_odd <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mangoldt_odd_pos sum_mono2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"mangoldt_odd"</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> psi_odd_def<span class="main">)</span>

<span class="keyword1" id="Bertrand-psi_odd_pos"><span class="command">lemma</span></span> psi_odd_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> psi_odd <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> psi_odd_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_nonneg mangoldt_odd_pos<span class="main">)</span>

<span class="keyword1" id="Bertrand-psi_theta"><span class="command">lemma</span></span> psi_theta<span class="main">:</span>
  <span class="quoted"><span class="quoted">"theta <span class="free">n</span> <span class="main">+</span> psi <span class="main">(</span>Discrete.sqrt <span class="free">n</span><span class="main">)</span> <span class="main">≤</span> psi <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"psi <span class="free">n</span> <span class="main">≤</span> theta <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> psi <span class="main">(</span>Discrete.sqrt <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> psi_odd_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> psi_residues_compare<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> psi_sqrt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> psi_split<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Bertrand-sum_minus_one"><span class="command">lemma</span></span> sum_minus_one<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">y</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> odd <span class="free">y</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Bertrand-div_invert"><span class="command">lemma</span></span> div_invert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">*</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="free">x</span><span class="main">)</span> <span class="main">*</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minus_mod_eq_div_mult<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">*</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> div_le_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main">*</span><span class="free">x</span>"</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Bertrand-sum_expand_lemma"><span class="command">lemma</span></span> sum_expand_lemma<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="bound">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> odd <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span> mangoldt <span class="bound">d</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">using</span></span> div_le_dividend order_trans that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
          <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">e</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">.</span> mangoldt <span class="bound">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> psi_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">e</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> mangoldt <span class="bound">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> ** <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">e</span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> mangoldt <span class="bound">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">x</span></span> <span class="main">|</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> mangoldt <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.swap_restrict<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">x</span></span> <span class="main">|</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> mangoldt <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> div_invert<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> ** <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">y</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> mangoldt <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">y</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> mangoldt <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_right<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> odd <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">y</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span> mangoldt <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sum_minus_one<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Bertrand-floor_half_interval"><span class="command">lemma</span></span> floor_half_interval<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="free">d</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="free">d</span><span class="main">)</span> <span class="main">-</span> real <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> odd <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="free">d</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> div_mult2_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="free">d</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_ac div_mult2_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="free">d</span><span class="main">)</span> <span class="main">-</span> real <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">…</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> odd <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="free">d</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"odd <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="free">d</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">div</span> <span class="free">d</span> <span class="main">=</span> <span class="main">0</span> "</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Bertrand-fact_expand_psi"><span class="command">lemma</span></span> fact_expand_psi<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>fact <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>fact <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> <span class="main">⌊</span><span class="free">n</span> <span class="main">/</span> <span class="bound">d</span><span class="main">⌋</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> <span class="main">⌊</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="bound">d</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  ln_fact_conv_mangoldt<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> <span class="main">⌊</span>real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="bound">d</span><span class="main">⌋</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> <span class="main">⌊</span>real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="bound">d</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.mono_neutral_left<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> floor_unique<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">⌊</span>real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="bound">d</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left mult_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> <span class="main">⌊</span><span class="free">n</span> <span class="main">/</span> <span class="bound">d</span><span class="main">⌋</span><span class="main">)</span> <span class="main">-</span> <span class="main">…</span> <span class="main">=</span> 
               <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span>mangoldt <span class="bound">d</span> <span class="main">*</span> <span class="main">⌊</span><span class="free">n</span> <span class="main">/</span> <span class="bound">d</span><span class="main">⌋</span> <span class="main">-</span> mangoldt <span class="bound">d</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">⌊</span>real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="bound">d</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_subtractf<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> <span class="main">(</span><span class="main">⌊</span><span class="free">n</span> <span class="main">/</span> <span class="bound">d</span><span class="main">⌋</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">⌊</span>real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="bound">d</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">if</span> odd<span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> floor_conv_div_nat <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> floor_half_interval <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> odd<span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span> mangoldt <span class="bound">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sum_expand_lemma<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>  
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Bertrand-psi_expansion_cutoff"><span class="command">lemma</span></span> psi_expansion_cutoff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="numeral">2</span><span class="main">*</span><span class="free">m</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="numeral">2</span><span class="main">*</span><span class="free">p</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="numeral">2</span><span class="main">*</span><span class="free">p</span><span class="main">+</span><span class="main">1</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="numeral">2</span><span class="main">*</span><span class="free">m</span><span class="main">+</span><span class="main">1</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> inc_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> 
          <span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="numeral">2</span> <span class="main">*</span> Suc <span class="skolem">k</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> psi_mono div_le_mono2<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> step.IH<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>
      <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">p</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> step.IH<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>
      <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="numeral">2</span> <span class="main">*</span> Suc <span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> psi_mono div_le_mono2<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>
       <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Bertrand-fact_psi_bound_even"><span class="command">lemma</span></span> fact_psi_bound_even<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"even <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>fact <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="bound">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> psi_expansion_cutoff<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>
        <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="bound">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="bound">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>
      <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="bound">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"even <span class="free">n</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">from</span></span> psi_pos <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="bound">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>
          <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="bound">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="main">(</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
            <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> psi_pos <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> sum.cl_ivl_Suc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">d</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">-</span><span class="main">1</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>
          <span class="main">+</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="free">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms psi_pos <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="free">k</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">-</span><span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> * psi_expansion_cutoff<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="bound">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"even <span class="free">n</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> psi_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> fact_expand_psi <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>fact <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Bertrand-fact_psi_bound_odd"><span class="command">lemma</span></span> fact_psi_bound_odd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>fact <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> fact_expand_psi 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>fact <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="bound">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>
             <span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"even <span class="free">n</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> psi_pos<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> True assms psi_expansion_cutoff<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"even <span class="free">n</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> psi_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> False assms psi_expansion_cutoff<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> oddE <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> psi_pos<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Bertrand-fact_psi_bound_2_3"><span class="command">lemma</span></span> fact_psi_bound_2_3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"psi <span class="free">n</span> <span class="main">-</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>fact <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>fact <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> psi <span class="free">n</span> <span class="main">-</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">3</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"psi <span class="free">n</span> <span class="main">-</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>fact <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> psi_bounds_ln_fact <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> fact_psi_bound_odd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">3</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>fact <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>
  <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="numeral">3</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="bound">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> psi <span class="free">n</span> <span class="main">-</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">3</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.atLeast_Suc_atMost numeral_2_eq_2<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>fact <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> psi <span class="free">n</span> <span class="main">-</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">3</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Bertrand-ub_ln_1200"><span class="command">lemma</span></span> ub_ln_1200<span class="main">:</span> <span class="quoted"><span class="quoted">"ln <span class="numeral">1200</span> <span class="main">≤</span> <span class="numeral">57</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">8</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span>Float <span class="numeral">57</span> <span class="main">(</span><span class="main">-</span><span class="numeral">3</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ub_ln <span class="numeral">8</span> <span class="numeral">1200</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span>
  <span class="keyword1"><span class="command">from</span></span> ub_ln<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="Bertrand-psi_double_lemma"><span class="command">lemma</span></span> psi_double_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="numeral">1200</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"real <span class="free">n</span> <span class="main">/</span> <span class="numeral">6</span> <span class="main">≤</span> psi <span class="free">n</span> <span class="main">-</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> ln_fact_diff_bounds
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>fact <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> real <span class="free">n</span> <span class="main">*</span> ln <span class="numeral">2</span><span class="main">¦</span>
        <span class="main">≤</span> <span class="numeral">4</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>fact <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>
        <span class="main">≥</span> real <span class="free">n</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">-</span> <span class="numeral">4</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">3</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="free">n</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">-</span> <span class="numeral">4</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">3</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> overpower_lemma<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">n</span></span><span class="main"><span class="main">.</span></span> <span class="numeral"><span class="numeral">2</span></span><span class="main"><span class="main">/</span></span><span class="numeral"><span class="numeral">3</span></span> <span class="main"><span class="main">*</span></span> <span class="bound"><span class="bound">n</span></span>"</span></span></span> <span class="quoted"><span class="numeral"><span class="quoted"><span class="numeral">1200</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">/</span> <span class="numeral">3</span> <span class="main">*</span> <span class="numeral">1200</span> <span class="main">≤</span> <span class="numeral">1200</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">-</span> <span class="numeral">4</span> <span class="main">*</span> ln <span class="numeral">1200</span> <span class="main">-</span> <span class="main">(</span><span class="numeral">3</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ub_ln_1200 ln_2_ge <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span><span class="main">::</span><span class="quoted">real</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">1200</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">-</span> <span class="numeral">4</span> <span class="main">*</span> ln <span class="bound">x</span> <span class="main">-</span> <span class="numeral">3</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">3</span> <span class="main">*</span> <span class="bound">x</span><span class="main">)</span>
        <span class="keyword1">has_real_derivative</span> ln <span class="numeral">2</span> <span class="main">-</span> <span class="numeral">4</span> <span class="main">/</span> <span class="skolem">x</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> refl <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">x</span>›</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span><span class="main">::</span><span class="quoted">real</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">1200</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">12</span> <span class="main">/</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="numeral">12</span> <span class="main">/</span> <span class="numeral">1200</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="numeral">0.67</span> <span class="main">-</span> <span class="numeral">4</span> <span class="main">/</span> <span class="skolem">x</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">0.67</span> <span class="main">≤</span> ln <span class="main">(</span><span class="numeral">2</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ln_2_ge <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> ln <span class="numeral">2</span> <span class="main">-</span> <span class="numeral">4</span> <span class="main">/</span> <span class="skolem">x</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">1200</span> <span class="main">≤</span> real <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">/</span> <span class="numeral">3</span> <span class="main">*</span> real <span class="free">n</span> <span class="main">≤</span> ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>fact <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> psi_ubound_3_2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">3</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">/</span><span class="numeral">6</span> <span class="main">+</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">≤</span> ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="main">(</span>fact <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> fact_psi_bound_2_3<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">n</span></span>"</span></span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Bertrand-theta_double_lemma"><span class="command">lemma</span></span> theta_double_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="numeral">1200</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"theta <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">&lt;</span> theta <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> psi_theta<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">n</span></span> <span class="keyword1"><span class="keyword1">div</span></span> <span class="numeral"><span class="numeral">2</span></span>"</span></span></span><span class="main">]</span> psi_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Discrete.sqrt <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> theta_le_psi_n_2<span class="main">:</span> <span class="quoted"><span class="quoted">"theta <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Discrete.sqrt <span class="free">n</span> <span class="main">*</span> <span class="numeral">18</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≤</span> <span class="numeral">324</span> <span class="main">*</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> mult_less_cancel2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="numeral">324</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span>"</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">324</span> <span class="main">*</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>Discrete.sqrt <span class="free">n</span> <span class="main">*</span> <span class="numeral">18</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≤</span> <span class="numeral">324</span> <span class="main">*</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Discrete.sqrt <span class="free">n</span><span class="main">*</span><span class="numeral">18</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">with</span></span> power2_less_imp_less assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Discrete.sqrt <span class="free">n</span> <span class="main">*</span> <span class="numeral">18</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> psi_ubound_3_2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Discrete.sqrt <span class="free">n</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> psi <span class="main">(</span>Discrete.sqrt <span class="free">n</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">/</span> <span class="numeral">6</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> psi_theta<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">n</span></span>"</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> psi_lt_theta_n<span class="main">:</span> <span class="quoted"><span class="quoted">"psi <span class="free">n</span> <span class="main">-</span> <span class="free">n</span> <span class="main">/</span> <span class="numeral">6</span> <span class="main">&lt;</span> theta <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> psi_double_lemma<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"psi <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> psi <span class="free">n</span> <span class="main">-</span> <span class="free">n</span> <span class="main">/</span> <span class="numeral">6</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> theta_le_psi_n_2 psi_lt_theta_n <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
  

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proof of the main result›</span></span>

<span class="keyword1" id="Bertrand-theta_mono"><span class="command">lemma</span></span> theta_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"mono theta"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> theta_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> monoI sum_mono2<span class="main">)</span>
  
<span class="keyword1" id="Bertrand-theta_lessE"><span class="command">lemma</span></span> theta_lessE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"theta <span class="free">m</span> <span class="main">&lt;</span> theta <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">p</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="free">m</span><span class="main">&lt;..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> mono_invE<span class="main">[</span><span class="operator">OF</span> theta_mono assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"theta <span class="free">n</span> <span class="main">=</span> theta <span class="free">m</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">∈</span><span class="main">{</span><span class="free">m</span><span class="main">&lt;..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="keyword1">if</span> prime <span class="bound">p</span> <span class="keyword1">then</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> theta_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.union_disjoint <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ivl_disj_un<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">∈</span><span class="main">{</span><span class="free">m</span><span class="main">&lt;..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="keyword1">if</span> prime <span class="bound">p</span> <span class="keyword1">then</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> sum.not_neutral_contains_not_neutral <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> p <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> bertrand<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">∈</span><span class="main">{</span><span class="free">n</span><span class="main">&lt;..&lt;</span><span class="numeral">2</span><span class="main">*</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> prime <span class="bound">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> n_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="numeral">600</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">prime_constants</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">prime_constants</span> <span class="main">=</span> <span class="main">{</span><span class="numeral">2</span><span class="main">,</span> <span class="numeral">3</span><span class="main">,</span> <span class="numeral">5</span><span class="main">,</span> <span class="numeral">7</span><span class="main">,</span> <span class="numeral">13</span><span class="main">,</span> <span class="numeral">23</span><span class="main">,</span> <span class="numeral">43</span><span class="main">,</span> <span class="numeral">83</span><span class="main">,</span> <span class="numeral">163</span><span class="main">,</span> <span class="numeral">317</span><span class="main">,</span> <span class="numeral">631</span><span class="main">::</span>nat<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> n_less <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span> <span class="main">∈</span> <span class="skolem">prime_constants</span><span class="main">.</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bex_simps greaterThanLessThan_iff prime_constants_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="skolem">prime_constants</span><span class="main">.</span> prime <span class="bound">p</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> prime_constants_def ball_simps HOL.simp_thms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="keyword3">;</span></span> <span class="operator">pratt</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">silent</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> greaterThanLessThan_def greaterThan_def lessThan_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="free">n</span> <span class="main">&lt;</span> <span class="numeral">600</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"theta <span class="free">n</span> <span class="main">&lt;</span> theta <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> theta_double_lemma<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="main">{</span><span class="free">n</span><span class="main">&lt;..</span><span class="numeral">2</span><span class="main">*</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> theta_lessE<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>prime <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prime_product<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
  
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proof of Mertens' first theorem›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following proof of Mertens' first theorem was ported from John Harrison's HOL Light
  proof by Larry Paulson:
›</span></span>

<span class="keyword1" id="Bertrand-sum_integral_ubound_decreasing'"><span class="command">lemma</span></span> sum_integral_ubound_decreasing'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> der<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span>of_nat <span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">..</span>of_nat <span class="free">n</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">g</span> <span class="keyword1">has_field_derivative</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span>real <span class="free">m</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span><span class="main">;</span> <span class="bound">y</span> <span class="main">≤</span> real <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="free">m</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>of_nat <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">g</span> <span class="main">(</span>of_nat <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="free">g</span> <span class="main">(</span>of_nat <span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="free">m</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>of_nat <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="free">m</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="free">g</span> <span class="main">(</span>of_nat<span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="free">g</span> <span class="main">(</span>of_nat <span class="bound">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
    <span class="keyword3"><span class="command">assume</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">z</span></span><span class="main">&gt;</span>real <span class="skolem">r</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> real <span class="skolem">r</span> <span class="main">∧</span> <span class="free">g</span> <span class="main">(</span>real <span class="skolem">r</span><span class="main">)</span> <span class="main">-</span> <span class="free">g</span> <span class="main">(</span>real <span class="skolem">r</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>real <span class="skolem">r</span> <span class="main">-</span> <span class="main">(</span>real <span class="skolem">r</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">z</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> MVT2<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z</span><span class="main">∈</span><span class="main">{</span>of_nat <span class="skolem">r</span> <span class="main">-</span> <span class="main">1</span><span class="main">..</span>of_nat <span class="skolem">r</span><span class="main">}</span><span class="main">.</span> <span class="free">g</span> <span class="main">(</span>real <span class="skolem">r</span><span class="main">)</span> <span class="main">-</span> <span class="free">g</span> <span class="main">(</span>real <span class="skolem">r</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="main">{</span>of_nat <span class="skolem">r</span> <span class="main">-</span> <span class="main">1</span><span class="main">..</span>of_nat <span class="skolem">r</span><span class="main">}</span>"</span></span>
                        <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">r</span> <span class="main">-</span> <span class="free">g</span> <span class="main">(</span>of_nat <span class="skolem">r</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="free">m</span> <span class="main">≤</span> <span class="skolem">u</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r u <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>of_nat <span class="skolem">r</span><span class="main">)</span> <span class="main">≤</span> <span class="free">f</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> u <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> le<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>of_nat <span class="skolem">r</span><span class="main">)</span> <span class="main">≤</span> <span class="free">g</span> <span class="skolem">r</span> <span class="main">-</span> <span class="free">g</span> <span class="main">(</span>of_nat <span class="skolem">r</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">g</span> <span class="main">(</span>of_nat <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="free">g</span> <span class="main">(</span>of_nat <span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_Suc_diff<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Bertrand-Mertens_lemma"><span class="command">lemma</span></span> Mertens_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">/</span> real <span class="bound">d</span><span class="main">)</span> <span class="main">-</span> ln <span class="free">n</span><span class="main">¦</span> <span class="main">≤</span> <span class="numeral">4</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>abs<span class="main">(</span><span class="skolem">s'</span> <span class="main">-</span> <span class="skolem">nl</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">a</span><span class="main">;</span> abs<span class="main">(</span><span class="skolem">s'</span> <span class="main">-</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">n</span> <span class="main">-</span> <span class="skolem">a</span><span class="main">⟧</span>
        <span class="main">⟹</span> abs<span class="main">(</span><span class="skolem">s</span> <span class="main">-</span> <span class="skolem">nl</span><span class="main">)</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s'</span> <span class="skolem">s</span> <span class="skolem">k</span> <span class="skolem">nl</span> <span class="skolem">a</span><span class="main">::</span><span class="quoted">real</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> abs_if <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> floor <span class="main">(</span><span class="free">n</span> <span class="main">/</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="free">n</span> <span class="main">*</span> ln <span class="free">n</span> <span class="main">+</span> <span class="free">n</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> ln <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ln_fact_bounds ln_fact_conv_mangoldt assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>real <span class="free">n</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">/</span> real <span class="bound">d</span><span class="main">)</span> <span class="main">-</span> ln <span class="free">n</span><span class="main">)</span><span class="main">¦</span> <span class="main">=</span>
        <span class="main">¦</span><span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> real <span class="free">n</span> <span class="main">*</span> mangoldt <span class="bound">d</span> <span class="main">/</span> real <span class="bound">d</span><span class="main">)</span> <span class="main">-</span> <span class="free">n</span> <span class="main">*</span> ln <span class="free">n</span><span class="main">)</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> sum_distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> real <span class="free">n</span> <span class="main">*</span> <span class="numeral">4</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> * <span class="main"><span class="main">[</span></span><span class="operator">OF</span> le<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> <span class="main">⌊</span><span class="free">n</span> <span class="main">/</span> <span class="bound">d</span><span class="main">⌋</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="free">n</span> <span class="main">*</span> mangoldt <span class="bound">d</span> <span class="main">/</span> <span class="bound">d</span><span class="main">)</span><span class="main">¦</span>
        <span class="main">=</span> <span class="main">¦</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> <span class="main">(</span><span class="main">⌊</span><span class="free">n</span> <span class="main">/</span> <span class="bound">d</span><span class="main">⌋</span> <span class="main">-</span> <span class="free">n</span> <span class="main">/</span> <span class="bound">d</span><span class="main">)</span><span class="main">¦</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_subtractf <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> psi <span class="free">n</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="var">?sm</span><span class="main">¦</span> <span class="main">≤</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="var">?sm</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span><span class="main">/</span><span class="bound">d</span> <span class="main">-</span> <span class="main">⌊</span><span class="free">n</span><span class="main">/</span><span class="bound">d</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_subtractf <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> <span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono mult_left_mono mangoldt_nonneg<span class="main">)</span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="var">?sm</span> <span class="main">≤</span> <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> psi_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sm</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> mangoldt_nonneg <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_le_0_iff sum_nonpos<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_if<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">3</span><span class="main">/</span><span class="numeral">2</span> <span class="main">*</span> real <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> psi_ubound_3_2<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span><span class="main">≤</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> real <span class="free">n</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> ln <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ln_le_minus_one <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> real_of_int <span class="main">⌊</span>real <span class="free">n</span> <span class="main">/</span> real <span class="bound">d</span><span class="main">⌋</span><span class="main">)</span> <span class="main">-</span>
           <span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> real <span class="free">n</span> <span class="main">*</span> mangoldt <span class="bound">d</span> <span class="main">/</span> real <span class="bound">d</span><span class="main">)</span><span class="main">¦</span>
          <span class="main">≤</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> real <span class="free">n</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> ln <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>real <span class="free">n</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">/</span> real <span class="bound">d</span><span class="main">)</span> <span class="main">-</span> ln <span class="free">n</span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span> real <span class="free">n</span> <span class="main">*</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms mult_le_cancel_left_pos <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_mult<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Bertrand-Mertens_mangoldt_versus_ln"><span class="command">lemma</span></span> Mertens_mangoldt_versus_ln<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> mangoldt <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> ln <span class="bound">p</span> <span class="main">/</span> <span class="bound">p</span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="var">?lhs</span><span class="main">¦</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> mangoldt <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span> <span class="main">-</span> <span class="main">(</span><span class="keyword1">if</span> prime <span class="bound">i</span> <span class="keyword1">then</span> ln <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mangoldt_nonneg <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_nonneg<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span> <span class="main">-</span> <span class="main">(</span><span class="keyword1">if</span> prime <span class="bound">i</span> <span class="keyword1">then</span> ln <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mangoldt_nonneg<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> mangoldt <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span> <span class="main">-</span> <span class="main">(</span><span class="keyword1">if</span> prime <span class="bound">i</span> <span class="keyword1">then</span> ln <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">¦</span>
                      <span class="main">≤</span> <span class="main">¦</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span> <span class="main">-</span> <span class="main">(</span><span class="keyword1">if</span> prime <span class="bound">i</span> <span class="keyword1">then</span> ln <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">¦</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> mangoldt <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span> <span class="main">-</span> <span class="main">(</span><span class="keyword1">if</span> prime <span class="bound">i</span> <span class="keyword1">then</span> ln <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span> <span class="main">-</span> <span class="main">(</span><span class="keyword1">if</span> prime <span class="bound">i</span> <span class="keyword1">then</span> ln <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>
                        <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">/</span> <span class="bound">d</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> ln <span class="bound">p</span> <span class="main">/</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sum.inter_restrict <span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">i</span><span class="main">)</span> <span class="main">/</span> <span class="bound">i</span>"</span></span> <span class="quoted"><span class="quoted">"Collect prime"</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>  
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_subtractf <span class="quoted"><span class="quoted">‹finite <span class="free">I</span>›</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="var">?lhs</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">¦</span><span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">/</span> <span class="bound">d</span><span class="main">)</span> <span class="main">-</span> 
                          <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> ln <span class="bound">p</span> <span class="main">/</span> <span class="bound">p</span><span class="main">)</span><span class="main">¦</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> eq_sm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> 
                     <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">p</span><span class="main">^</span><span class="bound">k</span> <span class="main">|</span><span class="bound">p</span> <span class="bound">k</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span><span class="main">^</span><span class="bound">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≥</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span> mangoldt <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_right ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">i</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>primepow <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> primepow_def Suc_le_eq<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mangoldt_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc_le_eq prime_gt_0_nat<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> ln <span class="bound">p</span> <span class="main">/</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span>
            <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">p</span><span class="main">^</span><span class="bound">k</span> <span class="main">|</span><span class="bound">p</span> <span class="bound">k</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span><span class="main">^</span><span class="bound">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">}</span><span class="main">.</span> mangoldt <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">|</span><span class="bound">p</span> <span class="bound">k</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">1</span> <span class="main">≤</span> <span class="bound">k</span><span class="main">}</span> <span class="main">=</span>
                  <span class="main">{</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">|</span><span class="bound">p</span> <span class="bound">k</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">k</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">}</span>"</span></span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="var">?B</span> <span class="main">∪</span> <span class="var">?C</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">elim</span> UnE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">^</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?B</span> <span class="main">∪</span> <span class="var">?C</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_power_iff Suc_le_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">^</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_power_iff Suc_le_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?C</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">^</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≥</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">^</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> eqln<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> ln <span class="bound">p</span> <span class="main">/</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> 
                      <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> mangoldt <span class="bound">p</span> <span class="main">/</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">p</span><span class="main">^</span><span class="bound">k</span> <span class="main">|</span><span class="bound">p</span> <span class="bound">k</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span><span class="main">^</span><span class="bound">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≥</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span> mangoldt <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> 
                <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">|</span><span class="bound">p</span> <span class="bound">k</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">k</span><span class="main">}</span> <span class="main">∪</span> 
                <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">}</span><span class="main">.</span> mangoldt <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> eq<span class="main">)</span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">p</span><span class="main">^</span><span class="bound">k</span> <span class="main">|</span><span class="bound">p</span> <span class="bound">k</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span><span class="main">^</span><span class="bound">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">}</span><span class="main">.</span> mangoldt <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span><span class="main">)</span>
                       <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> mangoldt <span class="bound">p</span> <span class="main">/</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.union_disjoint<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_power_iff finite_nat_set_iff_bounded_le<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">p</span><span class="main">^</span><span class="bound">k</span> <span class="main">|</span><span class="bound">p</span> <span class="bound">k</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span><span class="main">^</span><span class="bound">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">}</span><span class="main">.</span> mangoldt <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span><span class="main">)</span>
                       <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> ln <span class="bound">p</span> <span class="main">/</span> <span class="bound">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> eqln<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> eq_sm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> ln <span class="bound">p</span> <span class="main">/</span> <span class="bound">p</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> mangoldt <span class="bound">p</span> <span class="main">/</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> mangoldt_nonneg <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> Suc <span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mangoldt_nonneg<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> ln <span class="bound">p</span> <span class="main">/</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> ln <span class="bound">p</span> <span class="main">/</span> <span class="bound">p</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span>
                     <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">-</span> <span class="var">?L</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="main">∃</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="main">1</span> <span class="main">≤</span> <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span>
                  <span class="main">(</span><span class="bound">q</span> <span class="main">^</span> <span class="bound">j</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">∧</span> mangoldt <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">/</span> real <span class="skolem">p</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">≤</span> ln <span class="main">(</span>real <span class="bound">q</span><span class="main">)</span> <span class="main">/</span> real <span class="bound">q</span> <span class="main">^</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="skolem">k</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mangoldt <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">/</span> real <span class="skolem">p</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">≤</span> ln <span class="skolem">p</span> <span class="main">/</span> <span class="skolem">p</span> <span class="main">^</span> <span class="skolem">k</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> that self_le_power<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_ge_Suc_0_nat<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">^</span><span class="skolem">k</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> of_nat_less_two_power of_nat_less_numeral_power_cancel_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="skolem">p</span><span class="main">^</span><span class="skolem">k</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_mono prime_ge_2_nat that<span class="main">)</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> prime_ge_1_nat that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">use</span> atLeastAtMost_iff <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">blast</span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">|</span><span class="bound">p</span> <span class="bound">k</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">1</span> <span class="main">≤</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{..</span></span></span><span class="free"><span class="free"><span class="free">n</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span><span class="main">∈</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> real <span class="bound">x</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> eq_sm<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> sum_le_included <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="bound"><span class="bound"><span class="bound">p</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span><span class="bound"><span class="bound"><span class="bound">k</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">p</span></span></span><span class="main"><span class="main"><span class="main">^</span></span></span><span class="bound"><span class="bound"><span class="bound">k</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
             <span class="main">(</span><span class="operator">insert</span> * finite<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> ln <span class="bound">p</span> <span class="main">/</span> <span class="bound">p</span><span class="main">^</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.Sigma<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?L</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> ln <span class="bound">p</span> <span class="main">/</span> <span class="bound">p</span><span class="main">^</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comm_monoid_add_class.sum.distrib sum.atLeast_Suc_atMost numeral_2_eq_2<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">-</span> <span class="var">?L</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> ln <span class="bound">p</span> <span class="main">/</span> <span class="bound">p</span><span class="main">^</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> ln <span class="bound">p</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> inverse <span class="bound">p</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> sum_distrib_left<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> 
                          ln <span class="bound">p</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>inverse <span class="bound">p</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> inverse <span class="bound">p</span> <span class="main">^</span> Suc <span class="free">n</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> inverse <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_gp<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> ln <span class="bound">p</span> <span class="main">*</span> inverse <span class="main">(</span>real <span class="main">(</span><span class="bound">p</span> <span class="main">*</span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono mult_left_mono<span class="main">)</span>
             <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> power2_eq_square of_nat_diff mult_less_0_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> ln <span class="bound">p</span> <span class="main">*</span> inverse <span class="main">(</span>real <span class="main">(</span><span class="bound">p</span> <span class="main">*</span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mono2<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> prime_ge_2_nat <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> ln <span class="bound">i</span> <span class="main">/</span> <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> divide_inverse power2_eq_square mult.assoc
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum_mono mult_left_mono mult_right_mono<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="numeral">3</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
            <span class="keyword1"><span class="command">with</span></span> ln_le_minus_one <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="numeral">3</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">i</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>real <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>
                <span class="main">≤</span> <span class="main">(</span>ln <span class="main">(</span>of_nat <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span>of_nat <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span>of_nat <span class="free">n</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>of_nat <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> ln <span class="main">(</span><span class="bound">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> ln <span class="bound">z</span> <span class="main">-</span> ln <span class="bound">z</span> <span class="main">/</span> <span class="main">(</span><span class="bound">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_field_derivative</span> ln <span class="skolem">x</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
              <span class="keyword2"><span class="keyword">if</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span>real <span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">rule</span> refl <span class="main"><span class="keyword3">|</span></span> 
                   <span class="main">(</span><span class="operator">use</span> x <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main">:</span> power2_eq_square <span class="dynamic"><span class="dynamic">divide_simps</span></span>›</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"ln <span class="skolem">y</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> ln <span class="skolem">x</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≤</span> real <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> False
              <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real"</span></span>
                <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">u</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="bound">u</span> <span class="main">-</span> ln <span class="bound">u</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">u</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">u</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">4</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">have</span></span> f'_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="skolem">u</span> <span class="main">=</span> inverse <span class="skolem">u</span> <span class="main">*</span> inverse <span class="main">(</span><span class="main">(</span><span class="skolem">u</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="skolem">u</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">3</span>"</span></span> 
                <span class="keyword2"><span class="keyword">if</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">x</span><span class="main">..</span><span class="skolem">y</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword1"><span class="command">unfolding</span></span> f'_def <span class="keyword1"><span class="command">using</span></span> u <span class="comment1">(* TODO ugly *)</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_nat_numeral <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span>
              <span class="keyword1"><span class="command">have</span></span> deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> ln <span class="bound">z</span> <span class="main">/</span> <span class="main">(</span><span class="bound">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="keyword1">has_field_derivative</span> <span class="skolem">f'</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
                <span class="keyword2"><span class="keyword">if</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">x</span><span class="main">..</span><span class="skolem">y</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword1"><span class="command">unfolding</span></span> f'_def
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> refl <span class="main"><span class="keyword3">|</span></span> <span class="main">(</span><span class="operator">use</span> u xy <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main">:</span> <span class="dynamic"><span class="dynamic">divide_simps</span></span>›</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">z</span></span><span class="main">&gt;</span><span class="skolem">x</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="skolem">y</span> <span class="main">∧</span> ln <span class="skolem">y</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> ln <span class="skolem">x</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">-</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">f'</span> <span class="bound">z</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> xy <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> MVT2<span class="main">)</span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ξ</span></span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">ξ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ξ</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span>
                <span class="keyword2"><span class="keyword">and</span></span> ξ<span class="main">:</span> <span class="quoted"><span class="quoted">"ln <span class="skolem">y</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> ln <span class="skolem">x</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">-</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">f'</span> <span class="skolem">ξ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="skolem">ξ</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">/</span><span class="numeral">3</span> <span class="main">≤</span> ln <span class="main">(</span><span class="numeral">2</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> ln_2_ge'<span class="main">)</span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> ln <span class="skolem">ξ</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">ξ</span>›</span></span> xy <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="skolem">ξ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ξ</span> <span class="main">≤</span> <span class="skolem">ξ</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> ln <span class="skolem">ξ</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">ξ</span>›</span></span> xy <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ξ</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> ln <span class="skolem">ξ</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">ξ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">ξ</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">ξ</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">≤</span> ln <span class="skolem">ξ</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">ξ</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">3</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> xy <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">ξ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> power_eq_if<span class="main">)</span>
                <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> xy <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">ξ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ξ</span> <span class="main">&lt;</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> f'_altdef<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ln <span class="skolem">y</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> ln <span class="skolem">x</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_le_0_iff ξ<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> sum_integral_ubound_decreasing'
                <span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="numeral">3</span> <span class="main">≤</span> <span class="free">n</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">z</span><span class="main">.</span> ln<span class="main">(</span><span class="bound">z</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> ln <span class="bound">z</span> <span class="main">-</span> ln <span class="bound">z</span> <span class="main">/</span> <span class="main">(</span><span class="bound">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">z</span><span class="main">.</span> ln <span class="bound">z</span> <span class="main">/</span> <span class="main">(</span><span class="bound">z</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span><span class="main">]</span>
                1 2 <span class="quoted"><span class="quoted">‹<span class="numeral">3</span> <span class="main">≤</span> <span class="free">n</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_Reals_norm of_nat_diff<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>real <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> ln <span class="free">n</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> ln <span class="free">n</span> <span class="main">/</span> <span class="main">(</span>real <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">3</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>real <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> ln <span class="free">n</span> <span class="main">-</span> ln <span class="free">n</span> <span class="main">/</span> <span class="main">(</span>real <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
            <span class="keyword1"><span class="command">with</span></span> ln_2_less_1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">-</span> ln <span class="numeral">2</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> ln_2_less_1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> sum.atLeast_Suc_atMost <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">proposition</span></span> Mertens<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> <span class="free">n</span><span class="main">.</span> ln <span class="bound">p</span> <span class="main">/</span> of_nat <span class="bound">p</span><span class="main">)</span> <span class="main">-</span> ln <span class="free">n</span><span class="main">¦</span> <span class="main">≤</span> <span class="numeral">7</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">/</span> real <span class="bound">d</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> real <span class="bound">p</span><span class="main">)</span><span class="main">¦</span>
             <span class="main">≤</span> <span class="numeral">7</span> <span class="main">-</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Mertens_mangoldt_versus_ln <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> atLeastAtMost_iff prime_ge_1_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">/</span> real <span class="bound">d</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">∈</span><span class="main">…</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> real <span class="bound">p</span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span> <span class="numeral">7</span> <span class="main">-</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span><span class="main">∑</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">/</span> real <span class="bound">d</span><span class="main">)</span> <span class="main">-</span> ln <span class="free">n</span><span class="main">¦</span> <span class="main">≤</span> <span class="numeral">4</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Mertens_lemma<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/bertrand.ML">
<div class="head">
<h1>File ‹bertrand.ML›</h1>
</div>
<pre class="source"><span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">BERTRAND</span> <span class="main">=</span> 
<span class="keyword2"><span class="keyword">sig</span></span>

<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">cache</span> <span class="main">=</span> <span class="main">(</span>int * thm<span class="main">)</span> list
<span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">primepow_thm</span> <span class="main">=</span> <span class="entity">PrimepowThm</span> <span class="keyword2"><span class="keyword">of</span></span> thm * thm <span class="main">|</span> <span class="entity">NotPrimepowThm</span> <span class="keyword2"><span class="keyword">of</span></span> thm

<span class="keyword1"><span class="keyword">val</span></span> prime_conv <span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">cache</span> <span class="main">-&gt;</span> conv
<span class="keyword1"><span class="keyword">val</span></span> primepow_conv <span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">cache</span> <span class="main">-&gt;</span> conv
<span class="keyword1"><span class="keyword">val</span></span> pre_mangoldt_conv <span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">cache</span> <span class="main">-&gt;</span> conv

<span class="keyword1"><span class="keyword">val</span></span> prove_primepow <span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">cache</span> <span class="main">-&gt;</span> term <span class="main">-&gt;</span> <span class="entity">primepow_thm</span>
<span class="keyword1"><span class="keyword">val</span></span> prove_pre_mangoldt <span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">cache</span> <span class="main">-&gt;</span> term <span class="main">-&gt;</span> thm
<span class="keyword1"><span class="keyword">val</span></span> prove_psi <span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> <span class="main">(</span>int * int * thm<span class="main">)</span> list

<span class="keyword1"><span class="keyword">val</span></span> mk_prime_cache <span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> <span class="entity">cache</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Bertrand</span> <span class="main">:</span> <span class="entity">BERTRAND</span> <span class="main">=</span> 
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">cache</span> <span class="main">=</span> <span class="main">(</span>int * thm<span class="main">)</span> list

<span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">primepow_cert</span> <span class="main">=</span> <span class="entity">Primepow</span> <span class="keyword2"><span class="keyword">of</span></span> int * int <span class="main">|</span> <span class="entity">NotPrimepow</span> <span class="keyword2"><span class="keyword">of</span></span> int * int
<span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">primepow_thm</span> <span class="main">=</span> <span class="entity">PrimepowThm</span> <span class="keyword2"><span class="keyword">of</span></span> thm * thm <span class="main">|</span> <span class="entity">NotPrimepowThm</span> <span class="keyword2"><span class="keyword">of</span></span> thm

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mk_nat</span> <span class="main">=</span> <span class="entity">HOLogic.mk_number</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">nat</span><span class="antiquote">}</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_primepow_cert</span> <span class="entity">n</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">find_prime_divisor</span> <span class="entity">n</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">go</span> <span class="entity">k</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">n</span> mod <span class="entity">k</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">k</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">go</span> <span class="main">(</span><span class="entity">k</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">go</span> <span class="inner_numeral">2</span> <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">divide_out</span> <span class="entity">p</span> <span class="entity">m</span> <span class="entity">acc</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">m</span> mod <span class="entity">p</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">divide_out</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">m</span> div <span class="entity">p</span><span class="main">)</span> <span class="main">(</span><span class="entity">acc</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="entity">acc</span><span class="main">,</span> <span class="entity">m</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">p</span> <span class="main">=</span> <span class="entity">find_prime_divisor</span> <span class="entity">n</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">k</span><span class="main">,</span> <span class="entity">m</span><span class="main">)</span> <span class="main">=</span> <span class="entity">divide_out</span> <span class="entity">p</span> <span class="entity">n</span> <span class="inner_numeral">0</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">m</span> <span class="main">=</span> <span class="inner_numeral">1</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">Primepow</span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="entity">k</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">NotPrimepow</span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="entity">find_prime_divisor</span> <span class="entity">m</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">bool_thm_to_eq_thm</span> <span class="entity">thm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">HOLogic.dest_Trueprop</span> <span class="main">(</span>Thm.concl_of <span class="entity">thm</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
    <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"HOL.Not"</span><span class="antiquote">}</span></span> $ <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">thm</span> RS <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> Eq_FalseI<span class="antiquote">}</span></span></span>
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">thm</span> RS <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> Eq_TrueI<span class="antiquote">}</span></span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prime_conv</span> <span class="entity">ctxt</span> <span class="entity">cache</span> <span class="entity">ct</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> Thm.term_of <span class="entity">ct</span> <span class="keyword2"><span class="keyword">of</span></span>
    <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> "HOL.Trueprop"<span class="antiquote">}</span></span> $ <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"prime <span class="main">::</span> nat <span class="main">⇒</span> bool"</span><span class="antiquote">}</span></span> $ <span class="entity">p</span><span class="main">)</span> <span class="main">=&gt;</span>
      <span class="entity">Pratt.prove_prime</span> <span class="entity">cache</span> <span class="main">(</span>snd <span class="main">(</span><span class="entity">HOLogic.dest_number</span> <span class="entity">p</span><span class="main">)</span><span class="main">)</span> <span class="entity">ctxt</span>
      |&gt; fst |&gt; the |&gt; <span class="entity">bool_thm_to_eq_thm</span>
    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> CTERM <span class="main">(</span><span class="inner_quoted">"prime_conv"</span><span class="main">,</span> <span class="main">[</span><span class="entity">ct</span><span class="main">]</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prime_sieve</span> <span class="entity">n</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">let</span></span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">go</span> <span class="entity">ps</span> <span class="entity">k</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">k</span> &gt; <span class="entity">n</span> <span class="keyword2"><span class="keyword">then</span></span>
      rev <span class="entity">ps</span>
    <span class="keyword2"><span class="keyword">else</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> exists <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">p</span> <span class="main">=&gt;</span> <span class="entity">k</span> mod <span class="entity">p</span> <span class="main">=</span> <span class="inner_numeral">0</span><span class="main">)</span> <span class="entity">ps</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="entity">go</span> <span class="entity">ps</span> <span class="main">(</span><span class="entity">k</span> + <span class="inner_numeral">1</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">else</span></span>
        <span class="entity">go</span> <span class="main">(</span><span class="entity">k</span> :: <span class="entity">ps</span><span class="main">)</span> <span class="main">(</span><span class="entity">k</span> + <span class="inner_numeral">1</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">go</span> <span class="main">[</span><span class="main">]</span> <span class="inner_numeral">2</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fold_accum</span> <span class="entity">f</span> <span class="entity">xs</span> <span class="entity">acc</span> <span class="main">=</span>
  fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">ys</span><span class="main">,</span> <span class="entity">acc</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">f</span> <span class="entity">x</span> <span class="entity">acc</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">(</span><span class="entity">y</span><span class="main">,</span> <span class="entity">acc'</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">y</span> :: <span class="entity">ys</span><span class="main">,</span> <span class="entity">acc'</span><span class="main">)</span><span class="main">)</span> <span class="entity">xs</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="entity">acc</span><span class="main">)</span>
  |&gt; apfst rev

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_prime_cache</span> <span class="entity">ctxt</span> <span class="entity">n</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ps</span> <span class="main">=</span> <span class="entity">prime_sieve</span> <span class="entity">n</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">fold_accum</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">p</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">cache</span> <span class="main">=&gt;</span> <span class="entity">Pratt.prove_prime</span> <span class="entity">cache</span> <span class="entity">p</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">ps</span> <span class="main">[</span><span class="main">]</span> |&gt; snd
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prove_primepow</span> <span class="entity">ctxt</span> <span class="entity">cache</span> <span class="entity">t</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">n</span><span class="main">)</span> <span class="main">=</span> <span class="entity">HOLogic.dest_number</span> <span class="entity">t</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">inst</span> <span class="entity">xs</span> <span class="main">=</span> Drule.infer_instantiate' <span class="entity">ctxt</span> <span class="main">(</span>map <span class="main">(</span>SOME o Thm.cterm_of <span class="entity">ctxt</span> o <span class="entity">mk_nat</span><span class="main">)</span> <span class="entity">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prove</span> <span class="main">=</span> Goal.prove <span class="entity">ctxt</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prove_prime'</span> <span class="entity">p</span> <span class="main">=</span> the <span class="main">(</span>fst <span class="main">(</span><span class="entity">Pratt.prove_prime</span> <span class="entity">cache</span> <span class="entity">p</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">n</span> &lt;= <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"prove_primepow"</span><span class="main">,</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">n</span> <span class="main">=</span> <span class="inner_numeral">1</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="entity">NotPrimepowThm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> not_primepow_1_nat<span class="antiquote">}</span></span></span>
    <span class="keyword2"><span class="keyword">else</span></span>
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">mk_primepow_cert</span> <span class="entity">n</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="entity">Primepow</span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="entity">k</span><span class="main">)</span> <span class="main">=&gt;</span>
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> <span class="entity">prove_prime'</span> <span class="entity">p</span> RS <span class="entity">inst</span> <span class="main">[</span><span class="entity">p</span><span class="main">,</span> <span class="entity">k</span><span class="main">,</span> <span class="entity">n</span><span class="main">]</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> primepowI<span class="antiquote">}</span></span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm'</span> <span class="main">=</span> <span class="entity">prove</span> <span class="main">(</span>Thm.concl_of <span class="entity">thm</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span>context <span class="main">=</span> <span class="entity">ctxt</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span>
              HEADGOAL <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">thm</span><span class="main">]</span><span class="main">)</span> THEN ALLGOALS <span class="main">(</span><span class="entity">Simplifier.simp_tac</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">in</span></span>
            <span class="entity">PrimepowThm</span> <span class="main">(</span><span class="entity">thm'</span> RS <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> conjunct1<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="entity">thm'</span> RS <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> conjunct2<span class="antiquote">}</span></span></span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">end</span></span>
      <span class="main">|</span> <span class="entity">NotPrimepow</span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span>
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> <span class="entity">inst</span> <span class="main">[</span><span class="entity">p</span><span class="main">,</span> <span class="entity">q</span><span class="main">,</span> <span class="entity">n</span><span class="main">]</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> not_primepowI<span class="antiquote">}</span></span></span> OF <span class="main">(</span>map <span class="entity">prove_prime'</span> <span class="main">[</span><span class="entity">p</span><span class="main">,</span> <span class="entity">q</span><span class="main">]</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm'</span> <span class="main">=</span> <span class="entity">prove</span> <span class="main">(</span>Thm.concl_of <span class="entity">thm</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span>context <span class="main">=</span> <span class="entity">ctxt</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span>
              HEADGOAL <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">thm</span><span class="main">]</span><span class="main">)</span> THEN ALLGOALS <span class="main">(</span><span class="entity">Simplifier.simp_tac</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">in</span></span>
            <span class="entity">NotPrimepowThm</span> <span class="entity">thm'</span>
          <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">primepow_conv</span> <span class="entity">ctxt</span> <span class="entity">cache</span> <span class="entity">ct</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">prove_primepow</span> <span class="entity">ctxt</span> <span class="entity">cache</span> <span class="main">(</span>Thm.term_of <span class="entity">ct</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
    <span class="entity">PrimepowThm</span> <span class="main">(</span><span class="entity">thm</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">bool_thm_to_eq_thm</span> <span class="entity">thm</span>
  <span class="main">|</span> <span class="entity">NotPrimepowThm</span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="entity">bool_thm_to_eq_thm</span> <span class="entity">thm</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prove_pre_mangoldt</span> <span class="entity">ctxt</span> <span class="entity">cache</span> <span class="entity">t</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">prove_primepow</span> <span class="entity">ctxt</span> <span class="entity">cache</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
    <span class="entity">PrimepowThm</span> <span class="main">(</span><span class="entity">thm1</span><span class="main">,</span> <span class="entity">thm2</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> pre_mangoldt_primepow<span class="antiquote">}</span></span></span> OF <span class="main">[</span><span class="entity">thm1</span><span class="main">,</span> <span class="entity">thm2</span><span class="main">]</span>
  <span class="main">|</span> <span class="entity">NotPrimepowThm</span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="entity">thm</span> RS <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> pre_mangoldt_notprimepow<span class="antiquote">}</span></span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pre_mangoldt_conv</span> <span class="entity">ctxt</span> <span class="entity">cache</span> <span class="main">=</span> 
  <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="entity">thm</span> RS <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> eq_reflection<span class="antiquote">}</span></span></span><span class="main">)</span> o <span class="entity">prove_pre_mangoldt</span> <span class="entity">ctxt</span> <span class="entity">cache</span> o Thm.term_of

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">nat_eq_ss</span> <span class="main">=</span>
  simpset_of <span class="main">(</span>put_simpset <span class="entity">HOL_basic_ss</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> addsimps <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> Numeral_Simprocs.semiring_norm<span class="antiquote">}</span></span></span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prove_nat_eq</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">t1</span><span class="main">,</span> <span class="entity">t2</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">goal</span> <span class="main">=</span> <span class="entity">HOLogic.mk_eq</span> <span class="main">(</span><span class="entity">t1</span><span class="main">,</span> <span class="entity">t2</span><span class="main">)</span> |&gt; <span class="entity">HOLogic.mk_Trueprop</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tac</span> <span class="main">{</span>context <span class="main">=</span> <span class="entity">ctxt</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span>
      HEADGOAL <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> mult_1_left mult_1_right<span class="antiquote">}</span></span></span><span class="main">)</span>
      ORELSE HEADGOAL <span class="main">(</span><span class="entity">Simplifier.simp_tac</span> <span class="main">(</span>put_simpset <span class="entity">nat_eq_ss</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    Goal.prove <span class="entity">ctxt</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> <span class="entity">goal</span> <span class="entity">tac</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prove_psi</span> <span class="entity">ctxt</span> <span class="entity">n</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cache</span> <span class="main">=</span> <span class="entity">mk_prime_cache</span> <span class="entity">ctxt</span> <span class="entity">n</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">go</span> <span class="entity">thm</span> <span class="entity">x</span> <span class="entity">x'</span> <span class="entity">k</span> <span class="entity">acc</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">k</span> &gt; <span class="entity">n</span> <span class="keyword2"><span class="keyword">then</span></span>
        rev <span class="entity">acc</span>
      <span class="keyword2"><span class="keyword">else</span></span>
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pre_mangoldt_thm</span> <span class="main">=</span> <span class="entity">prove_pre_mangoldt</span> <span class="entity">ctxt</span> <span class="entity">cache</span> <span class="main">(</span><span class="entity">mk_nat</span> <span class="entity">k</span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">y</span> <span class="main">=</span> <span class="entity">pre_mangoldt_thm</span>
            |&gt; Thm.concl_of |&gt; <span class="entity">HOLogic.dest_Trueprop</span> |&gt; <span class="entity">HOLogic.dest_eq</span> |&gt; snd
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">y'</span> <span class="main">=</span> <span class="entity">HOLogic.dest_number</span> <span class="entity">y</span> |&gt; snd
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">eq_thm1</span> <span class="main">=</span> <span class="entity">prove_nat_eq</span> <span class="entity">ctxt</span>
            <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">(+)</span> <span class="main">::</span> nat <span class="main">⇒</span> <span class="main">_</span>"</span><span class="antiquote">}</span></span> $ <span class="entity">mk_nat</span> <span class="main">(</span><span class="entity">k</span> - <span class="inner_numeral">1</span><span class="main">)</span> $ <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">1</span> <span class="main">::</span> nat"</span><span class="antiquote">}</span></span><span class="main">,</span> <span class="entity">mk_nat</span> <span class="entity">k</span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">z</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">y'</span> <span class="main">=</span> <span class="inner_numeral">1</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">x</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">mk_nat</span> <span class="main">(</span><span class="entity">x'</span> * <span class="entity">y'</span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">eq_thm2</span> <span class="main">=</span> <span class="entity">prove_nat_eq</span> <span class="entity">ctxt</span>
            <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">(*)</span> <span class="main">::</span> nat <span class="main">=&gt;</span> <span class="main">_</span>"</span><span class="antiquote">}</span></span> $ <span class="entity">x</span> $ <span class="entity">y</span><span class="main">,</span> <span class="entity">z</span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm'</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> eval_psi_aux2<span class="antiquote">}</span></span></span> OF <span class="main">[</span><span class="entity">thm</span><span class="main">,</span> <span class="entity">pre_mangoldt_thm</span><span class="main">,</span> <span class="entity">eq_thm1</span><span class="main">,</span> <span class="entity">eq_thm2</span><span class="main">]</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="entity">go</span> <span class="entity">thm'</span> <span class="entity">z</span> <span class="main">(</span><span class="entity">x'</span> * <span class="entity">y'</span><span class="main">)</span> <span class="main">(</span><span class="entity">k</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="entity">k</span> - <span class="inner_numeral">1</span><span class="main">,</span> <span class="entity">x'</span><span class="main">,</span> <span class="entity">thm</span><span class="main">)</span> :: <span class="entity">acc</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">go</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> eval_psi_aux1<span class="antiquote">}</span></span></span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"numeral Num.One <span class="main">::</span> nat"</span><span class="antiquote">}</span></span> <span class="inner_numeral">1</span> <span class="inner_numeral">1</span> <span class="main">[</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>