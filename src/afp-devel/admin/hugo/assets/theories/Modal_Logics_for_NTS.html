<div id="Nominal_Bounded_Set">
<div class="head">
<h1>Theory Nominal_Bounded_Set</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Nominal_Bounded_Set
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../nominal2/theories/#Nominal2">Nominal2.Nominal2</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Cardinals/Bounded_Set.html">HOL-Cardinals.Bounded_Set</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Bounded Sets Equipped With a Permutation Action›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Additional lemmas about bounded sets.›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> bset_lifting<span class="main">:</span> bset_lifting <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Nominal_Bounded_Set-Abs_bset_inverse'"><span class="command">lemma</span></span> Abs_bset_inverse' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="free">A</span><span class="main">|</span> <span class="keyword1">&lt;o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'k</span> set<span class="main">|</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set_bset <span class="main">(</span>Abs_bset <span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="keyword1">set[</span><span class="tfree">'k</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Abs_bset_inverse assms mem_Collect_eq<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Bounded sets are equipped with a permutation action, provided their elements are.›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> bset <span class="main">::</span> <span class="main">(</span><span class="quoted">pt</span><span class="main">,</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">pt</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">permute_bset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"perm <span class="main">⇒</span> <span class="tfree">'a</span> <span class="keyword1">set[</span><span class="tfree">'b</span><span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="keyword1">set[</span><span class="tfree">'b</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
    <span class="quoted">permute</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">A</span><span class="main">|</span> <span class="keyword1">≤o</span> <span class="main">|</span><span class="skolem">A</span><span class="main">|</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_set_eq_image<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="skolem">A</span><span class="main">|</span> <span class="keyword1">&lt;o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">|</span>"</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">A</span><span class="main">|</span> <span class="keyword1">&lt;o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">|</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Nominal_Bounded_Set-Abs_bset_eqvt"><span class="command">lemma</span></span> Abs_bset_eqvt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="free">A</span><span class="main">|</span> <span class="keyword1">&lt;o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'k</span> set<span class="main">|</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="main">(</span>Abs_bset <span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>pt <span class="keyword1">set[</span><span class="tfree">'k</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> Abs_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_bset_def map_bset_def image_def permute_set_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Abs_bset_inverse' assms<span class="main">)</span>

<span class="keyword1" id="Nominal_Bounded_Set-supp_Abs_bset"><span class="command">lemma</span></span> supp_Abs_bset <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="free">A</span><span class="main">|</span> <span class="keyword1">&lt;o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'k</span> set<span class="main">|</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Abs_bset <span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>pt <span class="keyword1">set[</span><span class="tfree">'k</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∙</span> <span class="main">(</span>Abs_bset <span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>pt <span class="keyword1">set[</span><span class="tfree">'k</span><span class="main">]</span><span class="main">)</span> <span class="main">≠</span> Abs_bset <span class="free">A</span> <span class="main">⟷</span> <span class="bound">p</span> <span class="main">∙</span> <span class="free">A</span> <span class="main">≠</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> map_bset.rep_eq permute_set_eq_image set_bset_inverse set_bset_to_set_bset<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Nominal_Bounded_Set-map_bset_permute"><span class="command">lemma</span></span> map_bset_permute<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="free">B</span> <span class="main">=</span> map_bset <span class="main">(</span>permute <span class="free">p</span><span class="main">)</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def permute_set_def<span class="main">)</span>

<span class="keyword1" id="Nominal_Bounded_Set-set_bset_eqvt"><span class="command">lemma</span></span> set_bset_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> set_bset <span class="free">B</span> <span class="main">=</span> set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="Nominal_Bounded_Set-map_bset_eqvt"><span class="command">lemma</span></span> map_bset_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> map_bset <span class="free">f</span> <span class="free">B</span> <span class="main">=</span> map_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="Nominal_Bounded_Set-bempty_eqvt"><span class="command">lemma</span></span> bempty_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> bempty <span class="main">=</span> bempty"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="Nominal_Bounded_Set-binsert_eqvt"><span class="command">lemma</span></span> binsert_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="main">(</span>binsert <span class="free">x</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> binsert <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="Nominal_Bounded_Set-bsingleton_eqvt"><span class="command">lemma</span></span> bsingleton_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> bsingleton <span class="free">x</span> <span class="main">=</span> bsingleton <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_bset_permute<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Nominal_Wellfounded">
<div class="head">
<h1>Theory Nominal_Wellfounded</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Nominal_Wellfounded
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../nominal2/theories/#Nominal2">Nominal2.Nominal2</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Lemmas about Well-Foundedness and Permutations›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">less_bool_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool rel"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">less_bool_rel</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">&lt;</span><span class="bound">y</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Nominal_Wellfounded-less_bool_rel_iff"><span class="command">lemma</span></span> less_bool_rel_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">∈</span> less_bool_rel <span class="main">⟷</span> <span class="main">¬</span> <span class="free">a</span> <span class="main">∧</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_bool_def less_bool_rel_def mem_Collect_eq split_conv<span class="main">)</span>

<span class="keyword1" id="Nominal_Wellfounded-wf_less_bool_rel"><span class="command">lemma</span></span> wf_less_bool_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"wf less_bool_rel"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_bool_rel_iff wfUNIVI<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Hull and well-foundedness›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">hull_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">hull_rel</span>"</span></span>

<span class="keyword1" id="Nominal_Wellfounded-hull_relp_reflp"><span class="command">lemma</span></span> hull_relp_reflp<span class="main">:</span> <span class="quoted"><span class="quoted">"reflp hull_relp"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hull_relp.intros permute_zero reflpI<span class="main">)</span>

<span class="keyword1" id="Nominal_Wellfounded-hull_relp_symp"><span class="command">lemma</span></span> hull_relp_symp<span class="main">:</span> <span class="quoted"><span class="quoted">"symp hull_relp"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">)</span></span> hull_relp.simps permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sympI<span class="main">)</span>

<span class="keyword1" id="Nominal_Wellfounded-hull_relp_transp"><span class="command">lemma</span></span> hull_relp_transp<span class="main">:</span> <span class="quoted"><span class="quoted">"transp hull_relp"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> hull_relp.simps permute_plus transpI<span class="main">)</span>

<span class="keyword1" id="Nominal_Wellfounded-hull_relp_equivp"><span class="command">lemma</span></span> hull_relp_equivp<span class="main">:</span> <span class="quoted"><span class="quoted">"equivp hull_relp"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> equivpI hull_relp_reflp hull_relp_symp hull_relp_transp<span class="main">)</span>

<span class="keyword1" id="Nominal_Wellfounded-hull_rel_relcomp_subset"><span class="command">lemma</span></span> hull_rel_relcomp_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eqvt <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="keyword1">O</span> hull_rel <span class="main">⊆</span> hull_rel <span class="keyword1">O</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">R</span> <span class="keyword1">O</span> hull_rel"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x1</span></span> <span class="skolem"><span class="skolem">x2</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span><span class="skolem">x2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x1</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">x2</span><span class="main">)</span> <span class="main">∈</span> hull_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">x2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hull_rel.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">x2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> R assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_eqvt eqvt_def mem_permute_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">∈</span> hull_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hull_rel.intros permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> hull_rel <span class="keyword1">O</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Nominal_Wellfounded-wf_hull_rel_relcomp"><span class="command">lemma</span></span> wf_hull_rel_relcomp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eqvt <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>hull_rel <span class="keyword1">O</span> <span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hull_rel_relcomp_subset wf_relcomp_compatible<span class="main">)</span>

<span class="keyword1" id="Nominal_Wellfounded-hull_rel_relcompI"><span class="command">lemma</span></span> hull_rel_relcompI <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> hull_rel <span class="keyword1">O</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hull_rel.intros relcomp.relcompI<span class="main">)</span>

<span class="keyword1" id="Nominal_Wellfounded-hull_rel_relcomp_trivialI"><span class="command">lemma</span></span> hull_rel_relcomp_trivialI <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> hull_rel <span class="keyword1">O</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hull_rel_relcompI permute_zero<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Residual">
<div class="head">
<h1>Theory Residual</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Residual
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../nominal2/theories/#Nominal2">Nominal2.Nominal2</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Residuals›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Binding names›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹To define $\alpha$-equivalence, we require actions to be equipped with an equivariant
function~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">bn</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that gives their binding names. Actions may only bind finitely many names. This
is necessary to ensure that we can use a finite permutation to rename the binding names in an
action.›</span></span>

<span class="keyword1"><span class="command">class</span></span> bn <span class="main">=</span> fs <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">bn</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> atom set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bn_eqvt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="main">(</span><span class="free">bn</span> <span class="free">α</span><span class="main">)</span> <span class="main">=</span> <span class="free">bn</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">α</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> bn_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">bn</span> <span class="free">α</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Residual-bn_subset_supp"><span class="command">lemma</span></span> bn_subset_supp<span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="free">α</span> <span class="main">⊆</span> supp <span class="free">α</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> bn_eqvt bn_finite eqvt_at_def finite_supp supp_eqvt_at supp_finite_atom_set<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Raw residuals and \texorpdfstring{$\alpha$}{alpha}-equivalence›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Raw residuals are simply pairs of actions and states. Binding names in the action bind into
(the action and) the state.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">alpha_residual</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'act</span><span class="main">::</span>bn <span class="main">×</span> <span class="tfree">'state</span><span class="main">::</span>pt<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'act</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">alpha_residual</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">α1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">P1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">α2</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">P2</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">[</span>bn <span class="free"><span class="bound"><span class="entity">α1</span></span></span><span class="keyword1">]set.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">α1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P1</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>bn <span class="free"><span class="bound"><span class="entity">α2</span></span></span><span class="keyword1">]set.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">α2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹$\alpha$-equivalence is equivariant.›</span></span>

<span class="keyword1" id="Residual-alpha_residual_eqvt"><span class="command">lemma</span></span> alpha_residual_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"alpha_residual <span class="free">r1</span> <span class="free">r2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"alpha_residual <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">r1</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">r2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">r2</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> Pair_eqvt bn_eqvt permute_Abs_set<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹$\alpha$-equivalence is an equivalence relation.›</span></span>

<span class="keyword1" id="Residual-alpha_residual_reflp"><span class="command">lemma</span></span> alpha_residual_reflp<span class="main">:</span> <span class="quoted"><span class="quoted">"reflp alpha_residual"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_residual.simps prod.exhaust reflpI<span class="main">)</span>

<span class="keyword1" id="Residual-alpha_residual_symp"><span class="command">lemma</span></span> alpha_residual_symp<span class="main">:</span> <span class="quoted"><span class="quoted">"symp alpha_residual"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_residual.simps prod.exhaust sympI<span class="main">)</span>

<span class="keyword1" id="Residual-alpha_residual_transp"><span class="command">lemma</span></span> alpha_residual_transp<span class="main">:</span> <span class="quoted"><span class="quoted">"transp alpha_residual"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> transpI<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> alpha_residual.simps prod.exhaust<span class="main">)</span>

<span class="keyword1" id="Residual-alpha_residual_equivp"><span class="command">lemma</span></span> alpha_residual_equivp<span class="main">:</span> <span class="quoted"><span class="quoted">"equivp alpha_residual"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_residual_reflp alpha_residual_symp alpha_residual_transp equivpI<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Residuals›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Residuals are raw residuals quotiented by $\alpha$-equivalence.›</span></span>

<span class="keyword1"><span class="command">quotient_type</span></span>
  <span class="main">(</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'state</span><span class="main">)</span> residual <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'act</span><span class="main">::</span>bn <span class="main">×</span> <span class="tfree">'state</span><span class="main">::</span>pt"</span></span> <span class="main">/</span> <span class="quoted"><span class="quoted">"alpha_residual"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> alpha_residual_equivp<span class="main">)</span>

<span class="keyword1" id="Residual-residual_abs_rep"><span class="command">lemma</span></span> residual_abs_rep <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"abs_residual <span class="main">(</span>rep_residual <span class="free">res</span><span class="main">)</span> <span class="main">=</span> <span class="free">res</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Quotient_residual Quotient_abs_rep<span class="main">)</span>

<span class="keyword1" id="Residual-residual_rep_abs"><span class="command">lemma</span></span> residual_rep_abs <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"alpha_residual <span class="main">(</span>rep_residual <span class="main">(</span>abs_residual <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> residual.abs_eq_iff residual_abs_rep<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The permutation operation is lifted from raw residuals.›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> residual <span class="main">::</span> <span class="main">(</span><span class="quoted">bn</span><span class="main">,</span><span class="quoted">pt</span><span class="main">)</span> <span class="quoted">pt</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">permute_residual</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"perm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> residual <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> residual"</span></span>
    <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">permute</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> alpha_residual_eqvt<span class="main">)</span>

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">res</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> residual"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∙</span> <span class="skolem">res</span> <span class="main">=</span> <span class="skolem">res</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">metis</span> alpha_residual_equivp equivp_reflp permute_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">::</span> <span class="quoted">perm</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">res</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> residual"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">+</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">res</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="skolem">res</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">metis</span> alpha_residual_equivp equivp_reflp permute_plus<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The abstraction function from raw residuals to residuals is equivariant. The representation
function is equivariant modulo $\alpha$-equivalence.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> permute_residual.abs_eq <span class="main">[</span><span class="operator">eqvt</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span>

<span class="keyword1" id="Residual-alpha_residual_permute_rep_commute"><span class="command">lemma</span></span> alpha_residual_permute_rep_commute <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"alpha_residual <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> rep_residual <span class="free">res</span><span class="main">)</span> <span class="main">(</span>rep_residual <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">res</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> residual.abs_eq_iff residual_abs_rep permute_residual.abs_eq<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Notation for pairs as residuals›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">abs_residual_pair</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'act</span><span class="main">::</span>bn <span class="main">⇒</span> <span class="tfree">'state</span><span class="main">::</span>pt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'state</span><span class="main">)</span> residual"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⟨</span>_<span class="keyword1">,</span>_<span class="keyword1">⟩</span>"</span> <span class="main">[</span>0<span class="main">,</span>0<span class="main">]</span> 1000<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main"><span class="free">⟩</span></span> <span class="main">==</span> abs_residual <span class="main">(</span><span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Residual-abs_residual_pair_eqvt"><span class="command">lemma</span></span> abs_residual_pair_eqvt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="main">⟨</span><span class="free">α</span><span class="main">,</span><span class="free">P</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">p</span> <span class="main">∙</span> <span class="free">α</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_eqvt permute_residual.abs_eq<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Support of residuals›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We only consider finitely supported states now.›</span></span>

<span class="keyword1" id="Residual-supp_abs_residual_pair"><span class="command">lemma</span></span> supp_abs_residual_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">⟨</span><span class="free">α</span><span class="main">,</span> <span class="free">P</span><span class="main">::</span><span class="tfree">'state</span><span class="main">::</span>fs<span class="main">⟩</span> <span class="main">=</span> supp <span class="main">(</span><span class="free">α</span><span class="main">,</span><span class="free">P</span><span class="main">)</span> <span class="main">-</span> bn <span class="free">α</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">⟨</span><span class="free">α</span><span class="main">,</span><span class="free">P</span><span class="main">⟩</span> <span class="main">=</span> supp <span class="main">(</span><span class="main">[</span>bn <span class="free">α</span><span class="keyword1">]set.</span> <span class="main">(</span><span class="free">α</span><span class="main">,</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_def residual.abs_eq_iff bn_eqvt<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_Abs<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Residual-bn_abs_residual_fresh"><span class="command">lemma</span></span> bn_abs_residual_fresh <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="free">α</span> <span class="main">♯*</span> <span class="main">⟨</span><span class="free">α</span><span class="main">,</span><span class="free">P</span><span class="main">::</span><span class="tfree">'state</span><span class="main">::</span>fs<span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_def supp_abs_residual_pair<span class="main">)</span>

<span class="keyword1" id="Residual-finite_supp_abs_residual_pair"><span class="command">lemma</span></span> finite_supp_abs_residual_pair <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">⟨</span><span class="free">α</span><span class="main">,</span> <span class="free">P</span><span class="main">::</span><span class="tfree">'state</span><span class="main">::</span>fs<span class="main">⟩</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_Diff finite_supp supp_abs_residual_pair<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Equality between residuals›</span></span>

<span class="keyword1" id="Residual-residual_eq_iff_perm"><span class="command">lemma</span></span> residual_eq_iff_perm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">α1</span><span class="main">,</span><span class="free">P1</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">α2</span><span class="main">,</span><span class="free">P2</span><span class="main">⟩</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> supp <span class="main">(</span><span class="free">α1</span><span class="main">,</span> <span class="free">P1</span><span class="main">)</span> <span class="main">-</span> bn <span class="free">α1</span> <span class="main">=</span> supp <span class="main">(</span><span class="free">α2</span><span class="main">,</span> <span class="free">P2</span><span class="main">)</span> <span class="main">-</span> bn <span class="free">α2</span> <span class="main">∧</span> <span class="main">(</span>supp <span class="main">(</span><span class="free">α1</span><span class="main">,</span> <span class="free">P1</span><span class="main">)</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∙</span> <span class="main">(</span><span class="free">α1</span><span class="main">,</span> <span class="free">P1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">α2</span><span class="main">,</span> <span class="free">P2</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∙</span> bn <span class="free">α1</span> <span class="main">=</span> bn <span class="free">α2</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">⟷</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?l</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>bn <span class="free">α1</span><span class="keyword1">]set.</span> <span class="main">(</span><span class="free">α1</span><span class="main">,</span> <span class="free">P1</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>bn <span class="free">α2</span><span class="keyword1">]set.</span> <span class="main">(</span><span class="free">α2</span><span class="main">,</span> <span class="free">P2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> residual.abs_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="free">α1</span><span class="main">,</span> <span class="main">(</span><span class="free">α1</span><span class="main">,</span><span class="free">P1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(</span><span class="main">(=)</span><span class="main">)</span> supp <span class="skolem">p</span> <span class="main">(</span>bn <span class="free">α2</span><span class="main">,</span> <span class="main">(</span><span class="free">α2</span><span class="main">,</span><span class="free">P2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Abs_eq_iff<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alpha_set.simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?r</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="free">α1</span><span class="main">,</span> <span class="main">(</span><span class="free">α1</span><span class="main">,</span><span class="free">P1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(</span><span class="main">(=)</span><span class="main">)</span> supp <span class="skolem">p</span> <span class="main">(</span>bn <span class="free">α2</span><span class="main">,</span> <span class="main">(</span><span class="free">α2</span><span class="main">,</span><span class="free">P2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> alpha_set.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>bn <span class="free">α1</span><span class="keyword1">]set.</span> <span class="main">(</span><span class="free">α1</span><span class="main">,</span> <span class="free">P1</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>bn <span class="free">α2</span><span class="keyword1">]set.</span> <span class="main">(</span><span class="free">α2</span><span class="main">,</span> <span class="free">P2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Abs_eq_iff<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> residual.abs_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Residual-residual_eq_iff_perm_renaming"><span class="command">lemma</span></span> residual_eq_iff_perm_renaming<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">α1</span><span class="main">,</span><span class="free">P1</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">α2</span><span class="main">,</span><span class="free">P2</span><span class="main">⟩</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> supp <span class="main">(</span><span class="free">α1</span><span class="main">,</span> <span class="free">P1</span><span class="main">)</span> <span class="main">-</span> bn <span class="free">α1</span> <span class="main">=</span> supp <span class="main">(</span><span class="free">α2</span><span class="main">,</span> <span class="free">P2</span><span class="main">)</span> <span class="main">-</span> bn <span class="free">α2</span> <span class="main">∧</span> <span class="main">(</span>supp <span class="main">(</span><span class="free">α1</span><span class="main">,</span> <span class="free">P1</span><span class="main">)</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∙</span> <span class="main">(</span><span class="free">α1</span><span class="main">,</span> <span class="free">P1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">α2</span><span class="main">,</span> <span class="free">P2</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∙</span> bn <span class="free">α1</span> <span class="main">=</span> bn <span class="free">α2</span> <span class="main">∧</span> supp <span class="bound">p</span> <span class="main">⊆</span> bn <span class="free">α1</span> <span class="main">∪</span> <span class="bound">p</span> <span class="main">∙</span> bn <span class="free">α1</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">⟷</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="free">α1</span><span class="main">,</span> <span class="free">P1</span><span class="main">)</span> <span class="main">-</span> bn <span class="free">α1</span> <span class="main">=</span> supp <span class="main">(</span><span class="free">α2</span><span class="main">,</span> <span class="free">P2</span><span class="main">)</span> <span class="main">-</span> bn <span class="free">α2</span> <span class="main">∧</span> <span class="main">(</span>supp <span class="main">(</span><span class="free">α1</span><span class="main">,</span> <span class="free">P1</span><span class="main">)</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="main">(</span><span class="free">α1</span><span class="main">,</span> <span class="free">P1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">α2</span><span class="main">,</span> <span class="free">P2</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">∙</span> bn <span class="free">α1</span> <span class="main">=</span> bn <span class="free">α2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> residual_eq_iff_perm<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> q_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">b</span><span class="main">∈</span>bn <span class="free">α1</span><span class="main">.</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="bound">b</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="bound">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> supp_q<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="skolem">q</span> <span class="main">⊆</span> bn <span class="free">α1</span> <span class="main">∪</span> <span class="skolem">p</span> <span class="main">∙</span> bn <span class="free">α1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> set_renaming_perm2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="skolem">q</span> <span class="main">⊆</span> supp <span class="skolem">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> supp <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> supp <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> bn <span class="free">α1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"*"</span> q_p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_Collect_eq supp_perm<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="skolem">p</span> <span class="main">∙</span> bn <span class="free">α1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"*"</span> supp_q <span class="keyword1"><span class="command">using</span></span> UnE subsetCE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">a</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_permute_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> fresh_def fresh_perm <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp <span class="main">(</span><span class="free">α1</span><span class="main">,</span> <span class="free">P1</span><span class="main">)</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> fresh_def fresh_star_def subset_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> p <span class="keyword2"><span class="keyword">and</span></span> q_p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> supp <span class="free">α1</span> <span class="main">⟹</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="bound">a</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="bound">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> supp <span class="free">P1</span> <span class="main">⟹</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="bound">a</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="bound">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_iff fresh_perm fresh_star_def UnCI supp_Pair<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∙</span> <span class="free">α1</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">α1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∙</span> <span class="free">P1</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">P1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> supp_perm_perm_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> supp_q <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_eqvt bn_eqvt<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> residual_eq_iff_perm<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Strong induction›</span></span>

<span class="keyword1" id="Residual-residual_strong_induct"><span class="command">lemma</span></span> residual_strong_induct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="main">(</span><span class="bound">act</span><span class="main">::</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">)</span> <span class="main">(</span><span class="bound">state</span><span class="main">::</span><span class="tfree">'state</span><span class="main">::</span>fs<span class="main">)</span> <span class="main">(</span><span class="bound">c</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>fs<span class="main">)</span><span class="main">.</span> bn <span class="bound">act</span> <span class="main">♯*</span> <span class="bound">c</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">⟨</span><span class="bound">act</span><span class="main">,</span><span class="bound">state</span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">c</span> <span class="free">residual</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> residual.abs_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">act</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'act</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">state</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'state</span></span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> bn <span class="skolem">act</span><span class="main">)</span> <span class="main">♯*</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">⟨</span><span class="skolem">act</span><span class="main">,</span><span class="skolem">state</span><span class="main">⟩</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> at_set_avoiding2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"bn <span class="skolem"><span class="skolem">act</span></span>"</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">⟨</span></span><span class="skolem"><span class="skolem">act</span></span><span class="main"><span class="main">,</span></span><span class="skolem"><span class="skolem">state</span></span><span class="main"><span class="main">⟩</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> exE<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>bn <span class="skolem">act</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> bn_finite<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> finite_supp<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">⟨</span><span class="skolem">act</span><span class="main">,</span><span class="skolem">state</span><span class="main">⟩</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> finite_supp_abs_residual_pair<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bn <span class="skolem">act</span> <span class="main">♯*</span> <span class="main">⟨</span><span class="skolem">act</span><span class="main">,</span><span class="skolem">state</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> bn_abs_residual_fresh<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">act</span><span class="main">,</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">state</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="skolem">act</span><span class="main">,</span><span class="skolem">state</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> supp_perm_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">c</span> <span class="main">⟨</span><span class="skolem">act</span><span class="main">,</span><span class="skolem">state</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bn_eqvt<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Other lemmas›</span></span>

<span class="keyword1" id="Residual-residual_empty_bn_eq_iff"><span class="command">lemma</span></span> residual_empty_bn_eq_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bn <span class="free">α1</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">α1</span><span class="main">,</span><span class="free">P1</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">α2</span><span class="main">,</span><span class="free">P2</span><span class="main">⟩</span> <span class="main">⟷</span> <span class="free">α1</span> <span class="main">=</span> <span class="free">α2</span> <span class="main">∧</span> <span class="free">P1</span> <span class="main">=</span> <span class="free">P2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">α1</span><span class="main">,</span><span class="free">P1</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">α2</span><span class="main">,</span><span class="free">P2</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">{}</span><span class="keyword1">]set.</span> <span class="main">(</span><span class="free">α1</span><span class="main">,</span> <span class="free">P1</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>bn <span class="free">α2</span><span class="keyword1">]set.</span> <span class="main">(</span><span class="free">α2</span><span class="main">,</span> <span class="free">P2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> residual.abs_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{}</span><span class="main">,</span> <span class="main">(</span><span class="free">α1</span><span class="main">,</span> <span class="free">P1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(</span><span class="main">(=)</span><span class="main">)</span> supp <span class="skolem">p</span> <span class="main">(</span>bn <span class="free">α2</span><span class="main">,</span> <span class="main">(</span><span class="free">α2</span><span class="main">,</span> <span class="free">P2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Abs_eq_iff<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">α1</span> <span class="main">=</span> <span class="free">α2</span> <span class="main">∧</span> <span class="free">P1</span> <span class="main">=</span> <span class="free">P2</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> alpha_set <span class="keyword1"><span class="command">using</span></span> supp_perm_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">α1</span> <span class="main">=</span> <span class="free">α2</span> <span class="main">∧</span> <span class="free">P1</span> <span class="main">=</span> <span class="free">P2</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">α1</span><span class="main">,</span><span class="free">P1</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">α2</span><span class="main">,</span><span class="free">P2</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹The following lemma is not about residuals, but we have no better place for it.›</span>
<span class="keyword1" id="Residual-set_bounded_supp"><span class="command">lemma</span></span> set_bounded_supp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">X</span> <span class="main">⟹</span> supp <span class="bound">x</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"supp <span class="free">X</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">supports</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> supports_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a b <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">X</span> <span class="main">⟹</span> supp <span class="bound">x</span> <span class="main">⊆</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> fresh_def subsetCE swap_fresh_fresh<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">X</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> eqvt_bound mem_permute_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> mem_permute_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"supp <span class="free">X</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> supp_is_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Transition_System">
<div class="head">
<h1>Theory Transition_System</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Transition_System
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Residual">Residual</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Nominal Transition Systems and Bisimulations›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic Lemmas›</span></span>

<span class="keyword1" id="Transition_System-symp_eqvt"><span class="command">lemma</span></span> symp_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"symp <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"symp <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> symp_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> permute_fun_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_pure<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Nominal transition systems›</span></span>

<span class="keyword1"><span class="command">locale</span></span> nominal_ts <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">satisfies</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span><span class="main">::</span>fs <span class="main">⇒</span> <span class="tfree">'pred</span><span class="main">::</span>fs <span class="main">⇒</span> bool"</span></span>                <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊢</span>"</span> 70<span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">transition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">,</span><span class="tfree">'state</span><span class="main">)</span> residual <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">→</span>"</span> 70<span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> satisfies_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main"><span class="free">⊢</span></span> <span class="free">φ</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">P</span> <span class="main"><span class="free">⊢</span></span> <span class="free">p</span> <span class="main">∙</span> <span class="free">φ</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> transition_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="free">αQ</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="free">p</span> <span class="main">∙</span> <span class="free">αQ</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Transition_System-transition_eqvt'"><span class="command">lemma</span></span> transition_eqvt'<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">α</span><span class="main">,</span><span class="free">Q</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">p</span> <span class="main">∙</span> <span class="free">α</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> abs_residual_pair_eqvt transition_eqvt<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Bisimulations›</span></span>

<span class="keyword1"><span class="command">context</span></span> nominal_ts
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_bisimulation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">is_bisimulation</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span>
      symp <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">P</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span><span class="main">.</span> <span class="bound">P</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span> <span class="main">⟶</span> <span class="bound">Q</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">P</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">α</span> <span class="bound">P'</span><span class="main">.</span> bn <span class="bound">α</span> <span class="main">♯*</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="bound">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="bound">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">Q'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">P'</span> <span class="bound">Q'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">bisimilar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">∼⋅</span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">∼⋅</span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">R</span><span class="main">.</span> is_bisimulation <span class="bound">R</span> <span class="main">∧</span> <span class="bound">R</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> bisimilar<span class="antiquote"><span class="antiquote">}</span></span></span></span> is an equivariant equivalence relation.›</span></span>

  <span class="keyword1" id="Transition_System-is_bisimulation_eqvt"><span class="command">lemma</span></span> is_bisimulation_eqvt <span class="comment1">(*[eqvt]*)</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_bisimulation <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_bisimulation <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_bisimulation_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"symp <span class="free">R</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="free">R</span> <span class="bound">P</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span><span class="main">.</span> <span class="bound">P</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span> <span class="main">⟶</span> <span class="bound">Q</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="free">R</span> <span class="bound">P</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">α</span> <span class="bound">P'</span><span class="main">.</span> bn <span class="bound">α</span> <span class="main">♯*</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="bound">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="bound">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">Q'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">P'</span> <span class="bound">Q'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"symp <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> symp_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span> <span class="bound">P</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span><span class="main">.</span> <span class="bound">P</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span> <span class="main">⟶</span> <span class="bound">Q</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">φ</span>
        <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_lambda permute_bool_def unpermute_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 2 ** <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> satisfies_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span> <span class="bound">P</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">α</span> <span class="bound">P'</span><span class="main">.</span> bn <span class="bound">α</span> <span class="main">♯*</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="bound">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="bound">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">Q'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span> <span class="bound">P'</span> <span class="bound">Q'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?U</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">α</span> <span class="skolem">P'</span>
        <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ***<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_lambda permute_bool_def unpermute_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">♯*</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ** <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bn_eqvt fresh_star_permute_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">,</span> <span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> *** <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> transition_eqvt'<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">,</span><span class="skolem">Q'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">)</span> <span class="skolem">Q'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">from</span></span> T <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q'</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> transition_eqvt'<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> R <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span> <span class="skolem">P'</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eqvt_apply eqvt_lambda permute_bool_def unpermute_def<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="bound">Q'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span> <span class="skolem">P'</span> <span class="bound">Q'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">∧</span> <span class="var">?T</span> <span class="main">∧</span> <span class="var">?U</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Transition_System-bisimilar_eqvt"><span class="command">lemma</span></span> bisimilar_eqvt <span class="comment1">(*[eqvt]*)</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∼⋅</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">∼⋅</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"is_bisimulation <span class="skolem">R</span> <span class="main">∧</span> <span class="skolem">R</span> <span class="free">P</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> bisimilar_def <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_bisimulation <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">R</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_bisimulation_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"*"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eqvt_apply permute_boolI<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">∼⋅</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> bisimilar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Transition_System-bisimilar_reflp"><span class="command">lemma</span></span> bisimilar_reflp<span class="main">:</span> <span class="quoted"><span class="quoted">"reflp bisimilar"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> reflpI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_bisimulation <span class="main">(=)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_bisimulation_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> symp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∼⋅</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> bisimilar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Transition_System-bisimilar_symp"><span class="command">lemma</span></span> bisimilar_symp<span class="main">:</span> <span class="quoted"><span class="quoted">"symp bisimilar"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sympI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∼⋅</span> <span class="skolem">Q</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"is_bisimulation <span class="skolem">R</span> <span class="main">∧</span> <span class="skolem">R</span> <span class="skolem">P</span> <span class="skolem">Q</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> bisimilar_def <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="skolem">Q</span> <span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_bisimulation_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> symp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"*"</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∼⋅</span> <span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> bisimilar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Transition_System-bisimilar_is_bisimulation"><span class="command">lemma</span></span> bisimilar_is_bisimulation<span class="main">:</span> <span class="quoted"><span class="quoted">"is_bisimulation bisimilar"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_bisimulation_def <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"symp <span class="main">(∼⋅)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> bisimilar_symp<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∼⋅</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span><span class="main">.</span> <span class="bound">P</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span> <span class="main">⟶</span> <span class="bound">Q</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∼⋅</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">α</span> <span class="bound">P'</span><span class="main">.</span> bn <span class="bound">α</span> <span class="main">♯*</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="bound">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="bound">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">Q'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">∼⋅</span> <span class="bound">Q'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_bisimulation_def bisimilar_def<span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Transition_System-bisimilar_transp"><span class="command">lemma</span></span> bisimilar_transp<span class="main">:</span> <span class="quoted"><span class="quoted">"transp bisimilar"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> transpI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">R</span>
    <span class="keyword3"><span class="command">assume</span></span> PQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∼⋅</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> QR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∼⋅</span> <span class="skolem">R</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?bisim</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"bisimilar <span class="keyword1">OO</span> bisimilar"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"symp <span class="var">?bisim</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sympI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">R</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bisim</span> <span class="skolem">P</span> <span class="skolem">R</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∼⋅</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∼⋅</span> <span class="skolem">R</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">∼⋅</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∼⋅</span> <span class="skolem">P</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bisimilar_symp sympE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bisim</span> <span class="skolem">R</span> <span class="skolem">P</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="var">?bisim</span> <span class="bound">P</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span><span class="main">.</span> <span class="bound">P</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span> <span class="main">⟶</span> <span class="bound">Q</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bisimilar_is_bisimulation is_bisimulation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="var">?bisim</span> <span class="bound">P</span> <span class="bound">Q</span> <span class="main">⟶</span>
           <span class="main">(</span><span class="main">∀</span><span class="bound">α</span> <span class="bound">P'</span><span class="main">.</span> bn <span class="bound">α</span> <span class="main">♯*</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="bound">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="bound">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">Q'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="var">?bisim</span> <span class="bound">P'</span> <span class="bound">Q'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">R</span> <span class="skolem">Q</span> <span class="skolem">α</span> <span class="skolem">P'</span>
        <span class="keyword3"><span class="command">assume</span></span> PR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∼⋅</span> <span class="skolem">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> RQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">∼⋅</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
        <span class="comment1">― ‹rename~<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span><span class="antiquote">}</span></span> to avoid~<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">R</span></span><span class="antiquote">}</span></span>, without touching~<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">Q</span></span><span class="antiquote">}</span></span>›</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> bn <span class="skolem">α</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> at_set_avoiding2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"bn <span class="skolem"><span class="skolem">α</span></span>"</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">R</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">⟨</span></span><span class="skolem"><span class="skolem">α</span></span><span class="main"><span class="main">,</span></span><span class="skolem"><span class="skolem">P'</span></span><span class="main"><span class="main">⟩</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">Q</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> exE<span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>bn <span class="skolem">α</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> bn_finite<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="skolem">R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> finite_supp<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span><span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_supp supp_Pair<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh fresh_star_Pair<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="skolem">Q</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Un supp_Pair<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">from</span></span> 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">,</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> supp_perm_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pR'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">,</span> <span class="skolem">pR'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">)</span> <span class="main">∼⋅</span> <span class="skolem">pR'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> PR trans 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> bisimilar_is_bisimulation bn_eqvt is_bisimulation_def<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> fresh <span class="keyword2"><span class="keyword">and</span></span> 4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">Q</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bn_eqvt fresh_star_permute_iff supp_perm_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pQ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">,</span> <span class="skolem">pQ'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 8<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pR'</span> <span class="main">∼⋅</span> <span class="skolem">pQ'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> RQ 5 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> bisimilar_is_bisimulation is_bisimulation_def<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> 7 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span> <span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">pQ'</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> supp_perm_eq transition_eqvt'<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 6 <span class="keyword2"><span class="keyword">and</span></span> 8 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bisim</span> <span class="skolem">P'</span> <span class="main">(</span><span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">pQ'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> bisimilar_eqvt permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> relcompp.simps<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="bound">Q'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="var">?bisim</span> <span class="skolem">P'</span> <span class="bound">Q'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_bisimulation <span class="var">?bisim</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_bisimulation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bisim</span> <span class="skolem">P</span> <span class="skolem">R</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> PQ QR <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∼⋅</span> <span class="skolem">R</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> bisimilar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Transition_System-bisimilar_equivp"><span class="command">lemma</span></span> bisimilar_equivp<span class="main">:</span> <span class="quoted"><span class="quoted">"equivp bisimilar"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bisimilar_reflp bisimilar_symp bisimilar_transp equivp_reflp_symp_transp<span class="main">)</span>

  <span class="keyword1" id="Transition_System-bisimilar_simulation_step"><span class="command">lemma</span></span> bisimilar_simulation_step<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∼⋅</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bn <span class="free">α</span> <span class="main">♯*</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">α</span><span class="main">,</span><span class="free">P'</span><span class="main">⟩</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">Q'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">α</span><span class="main">,</span><span class="free">Q'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">∼⋅</span> <span class="free">Q'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">)</span></span> bisimilar_is_bisimulation is_bisimulation_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Formula">
<div class="head">
<h1>Theory Formula</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Formula
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Nominal_Bounded_Set">Nominal_Bounded_Set</a>
  <a href="#Nominal_Wellfounded">Nominal_Wellfounded</a>
  <a href="#Residual">Residual</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Infinitary Formulas›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Infinitely branching trees›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First, we define a type of trees, with a constructor~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">tConj</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that maps (potentially
infinite) sets of trees into trees. To avoid paradoxes (note that there is no injection from the
powerset of trees into the set of trees), the cardinality of the argument set must be bounded.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">)</span> Tree <span class="main">=</span>
    tConj <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">)</span> Tree <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span>"</span></span>  <span class="comment1">― ‹potentially infinite sets of trees›</span>
  <span class="main">|</span> tNot <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">)</span> Tree"</span></span>
  <span class="main">|</span> tPred <span class="tfree"><span class="quoted"><span class="tfree">'pred</span></span></span>
  <span class="main">|</span> tAct <span class="tfree"><span class="quoted"><span class="tfree">'act</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">)</span> Tree"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The (automatically generated) induction principle for trees allows us to prove that the
following relation over trees is well-founded. This will be useful for termination proofs when we
define functions by recursion over trees.›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">Tree_wf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">)</span> Tree rel"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∈</span> set_bset <span class="free"><span class="bound"><span class="entity">tset</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> tConj <span class="free"><span class="bound"><span class="entity">tset</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">Tree_wf</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> tNot <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">Tree_wf</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> tAct <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">Tree_wf</span>"</span></span>

<span class="keyword1" id="Formula-wf_Tree_wf"><span class="command">lemma</span></span> wf_Tree_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf Tree_wf"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> wf_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">)</span> Tree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> Tree_wf <span class="main">⟶</span> <span class="skolem">P</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">P</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> tConj <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree.distinct<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Tree.distinct<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> Tree.inject<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Tree_wf.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> tNot <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Tree.distinct<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> Tree.inject<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Tree_wf.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> tPred <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree.distinct<span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span> Tree.distinct<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Tree.distinct<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> Tree_wf.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> tAct <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree.distinct<span class="main"><span class="main">(</span></span>10<span class="main"><span class="main">)</span></span> Tree.distinct<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> Tree.inject<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> Tree_wf.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define a permutation operation on the type of trees.›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> Tree <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">pt</span><span class="main">,</span> <span class="quoted">pt</span><span class="main">)</span> <span class="quoted">pt</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">primrec</span></span> <span class="entity"><span class="class_parameter">permute_Tree</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"perm <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> Tree <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> Tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="main">(</span>tConj <span class="free"><span class="bound"><span class="entity">tset</span></span></span><span class="main">)</span> <span class="main">=</span> tConj <span class="main">(</span>map_bset <span class="main">(</span>permute <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tset</span></span></span><span class="main">)</span>"</span></span>  <span class="comment1">― ‹neat trick to get around the fact that~<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">tset</span></span><span class="antiquote">}</span></span> is not of permutation type yet›</span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="main">(</span>tNot <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> tNot <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="main">(</span>tPred <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> tPred <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="main">(</span>tAct <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> tAct <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> Tree"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∙</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> tConj <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">::</span> <span class="quoted">perm</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> Tree"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">+</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> tConj <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now that the type of trees---and hence the type of (bounded) sets of trees---is a permutation
type, we can massage the definition of~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">p</span></span> <span class="main"><span class="main">∙</span></span> tConj <span class="free"><span class="free">tset</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> into its more usual form.›</span></span>

<span class="keyword1" id="Formula-permute_Tree_tConj"><span class="command">lemma</span></span> permute_Tree_tConj <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> tConj <span class="free">tset</span> <span class="main">=</span> tConj <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">tset</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_bset_permute<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> permute_Tree.simps<span class="main">(</span>1<span class="main">)</span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The relation~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Tree_wf<span class="antiquote"><span class="antiquote">}</span></span></span></span> is equivariant.›</span></span>

<span class="keyword1" id="Formula-Tree_wf_eqvt_aux"><span class="command">lemma</span></span> Tree_wf_eqvt_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t1</span><span class="main">,</span> <span class="free">t2</span><span class="main">)</span> <span class="main">∈</span> Tree_wf"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">t1</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">t2</span><span class="main">)</span> <span class="main">∈</span> Tree_wf"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Tree_wf.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> Tree"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">tset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> Tree <span class="keyword1">set[</span><span class="tfree">'a</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> set_bset <span class="skolem">tset</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">t</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> tConj <span class="skolem">tset</span><span class="main">)</span> <span class="main">∈</span> Tree_wf"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree_wf.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> mem_permute_iff permute_Tree_tConj set_bset_eqvt<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> Tree"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">t</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> tNot <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> Tree_wf"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree_wf.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> permute_Tree.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> Tree"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">α</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">t</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> tAct <span class="skolem">α</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> Tree_wf"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree_wf.intros<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> permute_Tree.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Formula-Tree_wf_eqvt"><span class="command">lemma</span></span> Tree_wf_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Tree_wf <span class="main">=</span> Tree_wf"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Tree_wf <span class="main">⊆</span> Tree_wf"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_set_def<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> Tree_wf_eqvt_aux<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Tree_wf <span class="main">⊆</span> <span class="free">p</span> <span class="main">∙</span> Tree_wf"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_set_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Tree_wf_eqvt_aux permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Formula-Tree_wf_eqvt'"><span class="command">lemma</span></span> Tree_wf_eqvt'<span class="main">:</span> <span class="quoted"><span class="quoted">"eqvt Tree_wf"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree_wf_eqvt eqvtI<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The definition of~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> permute<span class="antiquote"><span class="antiquote">}</span></span></span></span> for trees gives rise to the usual notion of support. The
following lemmas, one for each constructor, describe the support of trees.›</span></span>

<span class="keyword1" id="Formula-supp_tConj"><span class="command">lemma</span></span> supp_tConj <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>tConj <span class="free">tset</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">tset</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Formula-supp_tNot"><span class="command">lemma</span></span> supp_tNot <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>tNot <span class="free">t</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Formula-supp_tPred"><span class="command">lemma</span></span> supp_tPred <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>tPred <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Formula-supp_tAct"><span class="command">lemma</span></span> supp_tAct <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>tAct <span class="free">α</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">α</span> <span class="main">∪</span> supp <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_imp_eq Collect_neg_eq<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Trees modulo \texorpdfstring{$\alpha$}{alpha}-equivalence›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We generalize the notion of support, which considers whether a permuted element is
\emph{equal} to itself, to arbitrary endorelations. This is available as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> supp_rel<span class="antiquote"><span class="antiquote">}</span></span></span></span> in
Nominal Isabelle.›</span></span>

<span class="keyword1" id="Formula-supp_rel_eqvt"><span class="command">lemma</span></span> supp_rel_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> supp_rel <span class="free">R</span> <span class="free">x</span> <span class="main">=</span> supp_rel <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Usually, the definition of $\alpha$-equivalence presupposes a notion of free variables.
However, the variables that are ``free'' in an infinitary conjunction are not necessarily those
that are free in one of the conjuncts. For instance, consider a conjunction over \emph{all} names.
Applying any permutation will yield the same conjunction, i.e., this conjunction has \emph{no} free
variables.

To obtain the correct notion of free variables for infinitary conjunctions, we initially defined
$\alpha$-equivalence and free variables via mutual recursion. In particular, we defined the free
variables of a conjunction as term <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">fv_Tree</span></span> <span class="main"><span class="main">(</span></span>tConj <span class="free"><span class="free">tset</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> supp_rel <span class="free"><span class="free">alpha_Tree</span></span> <span class="main"><span class="main">(</span></span>tConj <span class="free"><span class="free">tset</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

We then realized that it is not necessary to define the concept of ``free variables'' at all, but
the definition of $\alpha$-equivalence becomes much simpler (in particular, it is no longer mutually
recursive) if we directly use the support modulo $\alpha$-equivalence.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following lemmas and constructions are used to prove termination of our definition.›</span></span>

<span class="keyword1" id="Formula-supp_rel_cong"><span class="command">lemma</span></span> supp_rel_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span><span class="main">=</span><span class="free">x'</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="main">(</span><span class="bound">a</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">x'</span><span class="main">)</span> <span class="free">x'</span> <span class="main">⟷</span> <span class="free">R'</span> <span class="main">(</span><span class="main">(</span><span class="bound">a</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">x'</span><span class="main">)</span> <span class="free">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> supp_rel <span class="free">R</span> <span class="free">x</span> <span class="main">=</span> supp_rel <span class="free">R'</span> <span class="free">x'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_rel_def<span class="main">)</span>

<span class="keyword1" id="Formula-rel_bset_cong"><span class="command">lemma</span></span> rel_bset_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span><span class="main">=</span><span class="free">x'</span><span class="main">;</span> <span class="free">y</span><span class="main">=</span><span class="free">y'</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set_bset <span class="free">x'</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">∈</span> set_bset <span class="free">y'</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟷</span> <span class="free">R'</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟧</span> <span class="main">⟹</span> rel_bset <span class="free">R</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟷</span> rel_bset <span class="free">R'</span> <span class="free">x'</span> <span class="free">y'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_bset_def rel_set_def<span class="main">)</span>

<span class="keyword1" id="Formula-alpha_set_cong"><span class="command">lemma</span></span> alpha_set_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">bs</span><span class="main">=</span><span class="free">bs'</span><span class="main">;</span> <span class="free">x</span><span class="main">=</span><span class="free">x'</span><span class="main">;</span> <span class="free">R</span> <span class="main">(</span><span class="free">p'</span> <span class="main">∙</span> <span class="free">x'</span><span class="main">)</span> <span class="free">y'</span> <span class="main">⟷</span> <span class="free">R'</span> <span class="main">(</span><span class="free">p'</span> <span class="main">∙</span> <span class="free">x'</span><span class="main">)</span> <span class="free">y'</span><span class="main">;</span> <span class="free">f</span> <span class="free">x'</span> <span class="main">=</span> <span class="free">f'</span> <span class="free">x'</span><span class="main">;</span> <span class="free">f</span> <span class="free">y'</span> <span class="main">=</span> <span class="free">f'</span> <span class="free">y'</span><span class="main">;</span> <span class="free">p</span><span class="main">=</span><span class="free">p'</span><span class="main">;</span> <span class="free">cs</span><span class="main">=</span><span class="free">cs'</span><span class="main">;</span> <span class="free">y</span><span class="main">=</span><span class="free">y'</span> <span class="main">⟧</span> <span class="main">⟹</span>
    alpha_set <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="free">R</span> <span class="free">f</span> <span class="free">p</span> <span class="main">(</span><span class="free">cs</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">⟷</span> alpha_set <span class="main">(</span><span class="free">bs'</span><span class="main">,</span> <span class="free">x'</span><span class="main">)</span> <span class="free">R'</span> <span class="free">f'</span> <span class="free">p'</span> <span class="main">(</span><span class="free">cs'</span><span class="main">,</span> <span class="free">y'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set<span class="main">)</span>

<span class="keyword1"><span class="command">quotient_type</span></span>
  <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">)</span> Tree<span class="hidden">⇩</span><sub>p</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>pt<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">)</span> Tree"</span></span> <span class="main">/</span> <span class="quoted"><span class="quoted">"hull_relp"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> hull_relp_equivp<span class="main">)</span>

<span class="keyword1" id="Formula-abs_Tree"><span class="command">lemma</span></span> abs_Tree<span class="hidden">⇩</span><sub>p</sub>_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"abs_Tree<span class="hidden">⇩</span><sub>p</sub> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> abs_Tree<span class="hidden">⇩</span><sub>p</sub> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hull_relp.simps Tree<span class="hidden">⇩</span><sub>p</sub>.abs_eq_iff<span class="main">)</span>

<span class="keyword1" id="Formula-permute_rep_abs_Tree"><span class="command">lemma</span></span> permute_rep_abs_Tree<span class="hidden">⇩</span><sub>p</sub><span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">p</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"rep_Tree<span class="hidden">⇩</span><sub>p</sub> <span class="main">(</span>abs_Tree<span class="hidden">⇩</span><sub>p</sub> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Quotient3_Tree<span class="hidden">⇩</span><sub>p</sub> Tree<span class="hidden">⇩</span><sub>p</sub>.abs_eq_iff rep_abs_rsp hull_relp.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> Tree_wf<span class="hidden">⇩</span><sub>p</sub> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>pt<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">)</span> Tree<span class="hidden">⇩</span><sub>p</sub> rel"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted">Tree_wf</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Formula-Tree_wf"><span class="command">lemma</span></span> Tree_wf<span class="hidden">⇩</span><sub>p</sub>I <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> Tree_wf"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>abs_Tree<span class="hidden">⇩</span><sub>p</sub> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">a</span><span class="main">)</span><span class="main">,</span> abs_Tree<span class="hidden">⇩</span><sub>p</sub> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> Tree_wf<span class="hidden">⇩</span><sub>p</sub>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Tree<span class="hidden">⇩</span><sub>p</sub>.abs_eq_iff Tree_wf<span class="hidden">⇩</span><sub>p</sub>.abs_eq hull_relp.intros map_prod_simp rev_image_eqI<span class="main">)</span>

<span class="keyword1" id="Formula-Tree_wf"><span class="command">lemma</span></span> Tree_wf<span class="hidden">⇩</span><sub>p</sub>_trivialI <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> Tree_wf"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>abs_Tree<span class="hidden">⇩</span><sub>p</sub> <span class="free">a</span><span class="main">,</span> abs_Tree<span class="hidden">⇩</span><sub>p</sub> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> Tree_wf<span class="hidden">⇩</span><sub>p</sub>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree_wf<span class="hidden">⇩</span><sub>p</sub>I permute_zero<span class="main">)</span>

<span class="keyword1" id="Formula-Tree_wf"><span class="command">lemma</span></span> Tree_wf<span class="hidden">⇩</span><sub>p</sub>E<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a<span class="hidden">⇩</span><sub>p</sub></span><span class="main">,</span> <span class="free">b<span class="hidden">⇩</span><sub>p</sub></span><span class="main">)</span> <span class="main">∈</span> Tree_wf<span class="hidden">⇩</span><sub>p</sub>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="free">b</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">a<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">=</span> abs_Tree<span class="hidden">⇩</span><sub>p</sub> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">=</span> abs_Tree<span class="hidden">⇩</span><sub>p</sub> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">∈</span> Tree_wf"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject Tree_wf<span class="hidden">⇩</span><sub>p</sub>.abs_eq prod_fun_imageE<span class="main">)</span>

<span class="keyword1" id="Formula-wf_Tree_wf"><span class="command">lemma</span></span> wf_Tree_wf<span class="hidden">⇩</span><sub>p</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"wf Tree_wf<span class="hidden">⇩</span><sub>p</sub>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> wf_subset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"inv_image <span class="main"><span class="main">(</span></span>hull_rel <span class="keyword1"><span class="keyword1">O</span></span> Tree_wf<span class="main"><span class="main">)</span></span> rep_Tree<span class="hidden">⇩</span><sub>p</sub>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>inv_image <span class="main">(</span>hull_rel <span class="keyword1">O</span> Tree_wf<span class="main">)</span> rep_Tree<span class="hidden">⇩</span><sub>p</sub><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree_wf_eqvt' wf_Tree_wf wf_hull_rel_relcomp wf_inv_image<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Tree_wf<span class="hidden">⇩</span><sub>p</sub> <span class="main">⊆</span> inv_image <span class="main">(</span>hull_rel <span class="keyword1">O</span> Tree_wf<span class="main">)</span> rep_Tree<span class="hidden">⇩</span><sub>p</sub>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">b<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> Tree<span class="hidden">⇩</span><sub>p</sub>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a<span class="hidden">⇩</span><sub>p</sub></span><span class="main">,</span> <span class="skolem">b<span class="hidden">⇩</span><sub>p</sub></span><span class="main">)</span> <span class="main">∈</span> Tree_wf<span class="hidden">⇩</span><sub>p</sub>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">=</span> abs_Tree<span class="hidden">⇩</span><sub>p</sub> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">=</span> abs_Tree<span class="hidden">⇩</span><sub>p</sub> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> Tree_wf"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Tree_wf<span class="hidden">⇩</span><sub>p</sub>E<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"rep_Tree<span class="hidden">⇩</span><sub>p</sub> <span class="skolem">a<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_rep_abs_Tree<span class="hidden">⇩</span><sub>p</sub><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"rep_Tree<span class="hidden">⇩</span><sub>p</sub> <span class="skolem">b<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="skolem">b</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_rep_abs_Tree<span class="hidden">⇩</span><sub>p</sub><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> hull_rel"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hull_rel.simps permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> permute_plus<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q</span> <span class="main">∙</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> Tree_wf"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Tree_wf_eqvt_aux<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a<span class="hidden">⇩</span><sub>p</sub></span><span class="main">,</span> <span class="skolem">b<span class="hidden">⇩</span><sub>p</sub></span><span class="main">)</span> <span class="main">∈</span> inv_image <span class="main">(</span>hull_rel <span class="keyword1">O</span> Tree_wf<span class="main">)</span> rep_Tree<span class="hidden">⇩</span><sub>p</sub>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 4 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">alpha_Tree_termination</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> Tree <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> Tree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>pt<span class="main">,</span> <span class="tfree">'c</span><span class="main">::</span>bn<span class="main">)</span> Tree<span class="hidden">⇩</span><sub>p</sub> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">alpha_Tree_termination</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>abs_Tree<span class="hidden">⇩</span><sub>p</sub> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> abs_Tree<span class="hidden">⇩</span><sub>p</sub> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Here it comes \ldots›</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">)</span>
  <span class="entity">alpha_Tree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>pt<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">)</span> Tree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">)</span> Tree <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> alpha_Tree<span class="antiquote">}</span></span>›</span>
  alpha_tConj<span class="main">:</span> <span class="quoted"><span class="quoted">"tConj <span class="free"><span class="bound"><span class="entity">tset1</span></span></span> <span class="keyword1"><span class="free">=<span class="hidden">⇩</span><sub>α</sub></span></span> tConj <span class="free"><span class="bound"><span class="entity">tset2</span></span></span> <span class="main">⟷</span> rel_bset <span class="free">alpha_Tree</span> <span class="free"><span class="bound"><span class="entity">tset1</span></span></span> <span class="free"><span class="bound"><span class="entity">tset2</span></span></span>"</span></span>
<span class="main">|</span> alpha_tNot<span class="main">:</span> <span class="quoted"><span class="quoted">"tNot <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="keyword1"><span class="free">=<span class="hidden">⇩</span><sub>α</sub></span></span> tNot <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="keyword1"><span class="free">=<span class="hidden">⇩</span><sub>α</sub></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>
<span class="main">|</span> alpha_tPred<span class="main">:</span> <span class="quoted"><span class="quoted">"tPred <span class="free"><span class="bound"><span class="entity">φ1</span></span></span> <span class="keyword1"><span class="free">=<span class="hidden">⇩</span><sub>α</sub></span></span> tPred <span class="free"><span class="bound"><span class="entity">φ2</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">φ1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ2</span></span></span>"</span></span>
<span class="comment1">― ‹the action may have binding names›</span>
<span class="main">|</span> alpha_tAct<span class="main">:</span> <span class="quoted"><span class="quoted">"tAct <span class="free"><span class="bound"><span class="entity">α1</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="keyword1"><span class="free">=<span class="hidden">⇩</span><sub>α</sub></span></span> tAct <span class="free"><span class="bound"><span class="entity">α2</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">⟷</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>bn <span class="free"><span class="bound"><span class="entity">α1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="free">alpha_Tree</span> <span class="main">(</span>supp_rel <span class="free">alpha_Tree</span><span class="main">)</span> <span class="bound">p</span> <span class="main">(</span>bn <span class="free"><span class="bound"><span class="entity">α2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>bn <span class="free"><span class="bound"><span class="entity">α1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">α1</span></span></span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(</span><span class="main">(=)</span><span class="main">)</span> supp <span class="bound">p</span> <span class="main">(</span>bn <span class="free"><span class="bound"><span class="entity">α2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">α2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> alpha_other<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="keyword1"><span class="free">=<span class="hidden">⇩</span><sub>α</sub></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟷</span> False"</span></span>
<span class="comment1">― ‹254 subgoals (!)›</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inv_image <span class="main">(</span>max_ext Tree_wf<span class="hidden">⇩</span><sub>p</sub><span class="main">)</span> alpha_Tree_termination"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> max_ext_wf wf_Tree_wf<span class="hidden">⇩</span><sub>p</sub> wf_inv_image<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_ext.simps Tree_wf.simps <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> permute_Tree_tConj<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We provide more descriptive case names for the automatically generated induction principle.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> alpha_Tree_induct' <span class="main">=</span> alpha_Tree.induct<span class="main">[</span><span class="operator">case_names</span> alpha_tConj alpha_tNot
  alpha_tPred alpha_tAct <span class="quoted">"alpha_other(1)"</span> <span class="quoted">"alpha_other(2)"</span> <span class="quoted">"alpha_other(3)"</span> <span class="quoted">"alpha_other(4)"</span>
  <span class="quoted">"alpha_other(5)"</span> <span class="quoted">"alpha_other(6)"</span> <span class="quoted">"alpha_other(7)"</span> <span class="quoted">"alpha_other(8)"</span> <span class="quoted">"alpha_other(9)"</span>
  <span class="quoted">"alpha_other(10)"</span> <span class="quoted">"alpha_other(11)"</span> <span class="quoted">"alpha_other(12)"</span> <span class="quoted">"alpha_other(13)"</span> <span class="quoted">"alpha_other(14)"</span>
  <span class="quoted">"alpha_other(15)"</span> <span class="quoted">"alpha_other(16)"</span> <span class="quoted">"alpha_other(17)"</span> <span class="quoted">"alpha_other(18)"</span><span class="main">]</span>

<span class="keyword1" id="Formula-alpha_Tree_induct"><span class="command">lemma</span></span> alpha_Tree_induct<span class="main">[</span><span class="operator">case_names</span> tConj tNot tPred tAct<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">tset1</span> <span class="bound">tset2</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set_bset <span class="bound">tset1</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">∈</span> set_bset <span class="bound">tset2</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⟹</span>
            rel_bset <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="bound">tset1</span> <span class="bound">tset2</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>tConj <span class="bound">tset1</span><span class="main">)</span> <span class="main">(</span>tConj <span class="bound">tset2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t1</span> <span class="bound">t2</span><span class="main">.</span> <span class="bound">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="bound">t2</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">t1</span> <span class="bound">t2</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>tNot <span class="bound">t1</span><span class="main">)</span> <span class="main">(</span>tNot <span class="bound">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>tPred <span class="bound">φ</span><span class="main">)</span> <span class="main">(</span>tPred <span class="bound">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">α1</span> <span class="bound">t1</span> <span class="bound">α2</span> <span class="bound">t2</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∙</span> <span class="bound">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="bound">t2</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="bound">t1</span><span class="main">)</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">⟹</span>
            <span class="main">(</span><span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">a</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="bound">t1</span><span class="main">)</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="bound">t1</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="main">(</span><span class="bound">a</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="bound">t1</span><span class="main">)</span> <span class="bound">t1</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">a</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="bound">t2</span><span class="main">)</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="bound">t2</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="main">(</span><span class="bound">a</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="bound">t2</span><span class="main">)</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">⟹</span>
            <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>bn <span class="bound">α1</span><span class="main">,</span> <span class="bound">t1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span><span class="main">)</span> <span class="bound">p</span> <span class="main">(</span>bn <span class="bound">α2</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>bn <span class="bound">α1</span><span class="main">,</span> <span class="bound">α1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="bound">p</span> <span class="main">(</span>bn <span class="bound">α2</span><span class="main">,</span> <span class="bound">α2</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
            <span class="free">P</span> <span class="main">(</span>tAct <span class="bound">α1</span> <span class="bound">t1</span><span class="main">)</span> <span class="main">(</span>tAct <span class="bound">α2</span> <span class="bound">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">t1</span> <span class="free">t2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alpha_Tree.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹$\alpha$-equivalence is equivariant.›</span></span>

<span class="keyword1" id="Formula-alpha_Tree_eqvt_aux"><span class="command">lemma</span></span> alpha_Tree_eqvt_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">∙</span> <span class="main">(</span><span class="bound">a</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">p</span> <span class="main">∙</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span> <span class="main">=</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pB</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">a</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?B</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>unpermute <span class="free">p</span><span class="main">)</span> <span class="var">?pB</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def unpermute_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unpermute <span class="free">p</span> <span class="main">`</span> <span class="var">?pB</span> <span class="main">⊆</span> <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> eqvt_bound permute_eqvt swap_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?pB</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inj_on_finite<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?pB</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>permute <span class="free">p</span><span class="main">)</span> <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"permute <span class="free">p</span> <span class="main">`</span> <span class="var">?B</span> <span class="main">⊆</span> <span class="var">?pB</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> permute_eqvt swap_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inj_on_finite<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="var">?B</span> <span class="main">⟷</span> infinite <span class="var">?pB</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_rel_def permute_set_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> eqvt_bound<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Formula-alpha_Tree_eqvt'"><span class="command">lemma</span></span> alpha_Tree_eqvt'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t2</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">p</span> <span class="main">∙</span> <span class="free">t2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alpha_Tree_induct'<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>alpha_tConj <span class="skolem">tset1</span> <span class="skolem">tset2</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"tConj <span class="skolem">tset1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tConj <span class="skolem">tset2</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">tset1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> set_bset <span class="skolem">tset1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">x'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> imageE permute_bset.rep_eq permute_set_eq_image<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">∈</span> set_bset <span class="skolem">tset2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">y'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"*"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Formula.alpha_tConj rel_bset.rep_eq rel_set_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="skolem">y'</span> <span class="main">∈</span> set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">tset2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_permute_iff set_bset_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> 2 <span class="keyword2"><span class="keyword">and</span></span> 3 <span class="keyword2"><span class="keyword">and</span></span> 4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">y'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> alpha_tConj.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">∈</span>set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">tset2</span><span class="main">)</span><span class="main">.</span> <span class="skolem">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">tset2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">∈</span> set_bset <span class="skolem">tset2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="skolem">y'</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> imageE permute_bset.rep_eq permute_set_eq_image<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> set_bset <span class="skolem">tset1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">y'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"*"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Formula.alpha_tConj rel_bset.rep_eq rel_set_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="skolem">x'</span> <span class="main">∈</span> set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">tset1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_permute_iff set_bset_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> 2 <span class="keyword2"><span class="keyword">and</span></span> 3 <span class="keyword2"><span class="keyword">and</span></span> 4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="skolem">x'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> alpha_tConj.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span>set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">tset1</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> tConj <span class="skolem">tset1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">p</span> <span class="main">∙</span> tConj <span class="skolem">tset2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_bset_def rel_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> tConj <span class="skolem">tset1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">p</span> <span class="main">∙</span> tConj <span class="skolem">tset2</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_bset <span class="skolem">tset1</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">∈</span> set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">tset1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_permute_iff set_bset_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">∈</span> set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">tset2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">y'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"*"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Formula.alpha_tConj permute_Tree_tConj rel_bset.rep_eq rel_set_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set_bset <span class="skolem">tset2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> imageE permute_bset.rep_eq permute_set_eq_image<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> 3 <span class="keyword2"><span class="keyword">and</span></span> 4 <span class="keyword2"><span class="keyword">and</span></span> 5 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> alpha_tConj.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> 4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">∈</span>set_bset <span class="skolem">tset2</span><span class="main">.</span> <span class="skolem">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set_bset <span class="skolem">tset2</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="skolem">y</span> <span class="main">∈</span> set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">tset2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_permute_iff set_bset_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">tset1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"*"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Formula.alpha_tConj permute_Tree_tConj rel_bset.rep_eq rel_set_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_bset <span class="skolem">tset1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> imageE permute_bset.rep_eq permute_set_eq_image<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> 3 <span class="keyword2"><span class="keyword">and</span></span> 4 <span class="keyword2"><span class="keyword">and</span></span> 5 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> alpha_tConj.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> 4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span>set_bset <span class="skolem">tset1</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"tConj <span class="skolem">tset1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tConj <span class="skolem">tset2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_bset_def rel_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>alpha_tAct <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="skolem">α2</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> alpha_tAct.IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="skolem">t1</span> <span class="main">=</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">t1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> alpha_Tree_eqvt_aux<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> alpha_tAct.IH<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="skolem">t2</span> <span class="main">=</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> alpha_Tree_eqvt_aux<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"tAct <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="skolem">α2</span> <span class="skolem">t2</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> <span class="skolem">t1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> <span class="skolem">α1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="skolem">q</span> <span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> <span class="skolem">α2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> t1 <span class="keyword2"><span class="keyword">and</span></span> t2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">-</span> bn <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α1</span><span class="main">)</span> <span class="main">=</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">-</span> bn <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_eqvt alpha_set bn_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> t1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">-</span> bn <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α1</span><span class="main">)</span><span class="main">)</span> <span class="main">♯*</span> <span class="main">(</span><span class="free">p</span> <span class="main">+</span> <span class="skolem">q</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_eqvt alpha_set bn_eqvt fresh_star_permute_iff permute_perm_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> alpha_tAct.IH<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="skolem">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">t2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="main">-</span><span class="free">p</span> <span class="main">∙</span> bn <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α1</span><span class="main">)</span> <span class="main">=</span> bn <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set bn_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α1</span><span class="main">)</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">t1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">+</span> <span class="skolem">q</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>bn <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α2</span><span class="main">)</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α1</span><span class="main">)</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">α1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="main">(</span><span class="free">p</span> <span class="main">+</span> <span class="skolem">q</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>bn <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α2</span><span class="main">)</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">α2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Diff_eqvt bn_eqvt fresh_star_permute_iff permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> permute_perm_def supp_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> tAct <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">p</span> <span class="main">∙</span> tAct <span class="skolem">α2</span> <span class="skolem">t2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> tAct <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">p</span> <span class="main">∙</span> tAct <span class="skolem">α2</span> <span class="skolem">t2</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α1</span><span class="main">)</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">t1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">(</span>bn <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α2</span><span class="main">)</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α1</span><span class="main">)</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">α1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="skolem">q</span> <span class="main">(</span>bn <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α2</span><span class="main">)</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">α2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> t1 <span class="keyword2"><span class="keyword">and</span></span> t2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="skolem">t1</span> <span class="main">-</span> bn <span class="skolem">α1</span> <span class="main">=</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="skolem">t2</span> <span class="main">-</span> bn <span class="skolem">α2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Diff_eqvt alpha_set bn_eqvt permute_eq_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> t2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="skolem">t1</span> <span class="main">-</span> bn <span class="skolem">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="main">(</span><span class="main">-</span> <span class="free">p</span> <span class="main">+</span> <span class="skolem">q</span> <span class="main">+</span> <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_perm alphas<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> DiffI bn_eqvt mem_permute_iff permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">t2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> alpha_tAct.IH<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> permute_eqvt permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="free">p</span> <span class="main">∙</span> bn <span class="skolem">α1</span> <span class="main">=</span> bn <span class="skolem">α2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_set bn_eqvt permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> <span class="skolem">t1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">+</span> <span class="skolem">q</span> <span class="main">+</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="skolem">α1</span> <span class="main">-</span> bn <span class="skolem">α1</span> <span class="main">=</span> supp <span class="skolem">α2</span> <span class="main">-</span> bn <span class="skolem">α2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Diff_eqvt alpha_set bn_eqvt permute_eq_iff supp_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp <span class="skolem">α1</span> <span class="main">-</span> bn <span class="skolem">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">+</span> <span class="skolem">q</span> <span class="main">+</span> <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_perm alphas<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> DiffI bn_eqvt mem_permute_iff permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> supp_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">α1</span> <span class="main">=</span> <span class="skolem">α2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="free">p</span> <span class="main">∙</span> bn <span class="skolem">α1</span> <span class="main">=</span> bn <span class="skolem">α2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bn_eqvt calculation<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> <span class="skolem">α1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">+</span> <span class="skolem">q</span> <span class="main">+</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> <span class="skolem">α2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"tAct <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="skolem">α2</span> <span class="skolem">t2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Formula-alpha_Tree_eqvt"><span class="command">lemma</span></span> alpha_Tree_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t2</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">p</span> <span class="main">∙</span> <span class="free">t2</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_Tree_eqvt'<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> alpha_Tree<span class="antiquote"><span class="antiquote">}</span></span></span></span> is an equivalence relation.›</span></span>

<span class="keyword1" id="Formula-alpha_Tree_reflp"><span class="command">lemma</span></span> alpha_Tree_reflp<span class="main">:</span> <span class="quoted"><span class="quoted">"reflp alpha_Tree"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> reflpI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> Tree"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> tConj <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_tConj rel_bset.rep_eq rel_setI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> tNot <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_tNot<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> tPred <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_tPred<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> tAct <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> alpha_tAct alpha_refl<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Formula-alpha_Tree_symp"><span class="command">lemma</span></span> alpha_Tree_symp<span class="main">:</span> <span class="quoted"><span class="quoted">"symp alpha_Tree"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sympI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> Tree"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alpha_Tree_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> tConj <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_bset_def rel_set_def<span class="main">)</span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tAct <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="skolem">α2</span> <span class="skolem">t2</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> <span class="skolem">t1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> <span class="skolem">α1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="skolem">p</span> <span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> <span class="skolem">α2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> <span class="skolem">t2</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> <span class="skolem">α2</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="main">(</span><span class="main">-</span><span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> <span class="skolem">α1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tAct.IH <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alpha_Tree_eqvt alpha_sym<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Formula-alpha_Tree_transp"><span class="command">lemma</span></span> alpha_Tree_transp<span class="main">:</span> <span class="quoted"><span class="quoted">"transp alpha_Tree"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> transpI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> Tree"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">z</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">z</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">z</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alpha_Tree_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tConj <span class="skolem">tset_x</span> <span class="skolem">tset_y</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tset_z</span>
        <span class="keyword3"><span class="command">assume</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> tConj <span class="skolem">tset_z</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_bset <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="skolem">tset_x</span> <span class="skolem">tset_z</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> rel_bset.rep_eq rel_set_def Ball_def Bex_def
          <span class="keyword1"><span class="command">proof</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> set_bset <span class="skolem">tset_x</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">z'</span><span class="main">.</span> <span class="bound">z'</span> <span class="main">∈</span> set_bset <span class="skolem">tset_z</span> <span class="main">∧</span> <span class="bound">x'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="bound">z'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span> <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> set_bset <span class="skolem">tset_x</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">∈</span> set_bset <span class="skolem">tset_y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">y'</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rel_bset.rep_eq rel_set_def tConj.hyps<span class="main">)</span>
              <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z'</span> <span class="main">∈</span> set_bset <span class="skolem">tset_z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">z'</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_tConj rel_bset.rep_eq rel_set_def tConj.prems z<span class="main">)</span>
              <span class="keyword1"><span class="command">from</span></span> 1 2 3 5 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">z'</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tConj.IH<span class="main">)</span>
              <span class="keyword1"><span class="command">with</span></span> 4 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z'</span><span class="main">.</span> <span class="bound">z'</span> <span class="main">∈</span> set_bset <span class="skolem">tset_z</span> <span class="main">∧</span> <span class="skolem">x'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="bound">z'</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z'</span><span class="main">.</span> <span class="bound">z'</span> <span class="main">∈</span> set_bset <span class="skolem">tset_z</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> set_bset <span class="skolem">tset_x</span> <span class="main">∧</span> <span class="bound">x'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="bound">z'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z'</span> <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z'</span> <span class="main">∈</span> set_bset <span class="skolem">tset_z</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">∈</span> set_bset <span class="skolem">tset_y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">z'</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_tConj rel_bset.rep_eq rel_set_def tConj.prems z<span class="main">)</span>
              <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> set_bset <span class="skolem">tset_x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">y'</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rel_bset.rep_eq rel_set_def tConj.hyps<span class="main">)</span>
              <span class="keyword1"><span class="command">from</span></span> 4 2 5 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">z'</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tConj.IH<span class="main">)</span>
              <span class="keyword1"><span class="command">with</span></span> 4 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> set_bset <span class="skolem">tset_x</span> <span class="main">∧</span> <span class="bound">x'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">z'</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">with</span></span> z <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"tConj <span class="skolem">tset_x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">z</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> tConj.prems<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> tNot <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> tPred <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tAct <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="skolem">α2</span> <span class="skolem">t2</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">α</span> <span class="skolem">t</span>
      <span class="keyword3"><span class="command">assume</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> tAct <span class="skolem">α</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> <span class="skolem">t1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> <span class="skolem">α1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="skolem">p</span> <span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> <span class="skolem">α2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> tAct.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> <span class="skolem">t2</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">(</span>bn <span class="skolem">α</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> <span class="skolem">α2</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="skolem">q</span> <span class="main">(</span>bn <span class="skolem">α</span><span class="main">,</span> <span class="skolem">α</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> tAct.prems z <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> <span class="skolem">t1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">+</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>bn <span class="skolem">α</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="skolem">t1</span> <span class="main">-</span> bn <span class="skolem">α1</span> <span class="main">=</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="skolem">t</span> <span class="main">-</span> bn <span class="skolem">α</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_set<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="skolem">t1</span> <span class="main">-</span> bn <span class="skolem">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">+</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_set fresh_star_plus<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q</span> <span class="main">+</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">t</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> 2 <span class="keyword2"><span class="keyword">and</span></span> tAct.IH <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alpha_Tree_eqvt alpha_set permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> permute_plus<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q</span> <span class="main">+</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∙</span> bn <span class="skolem">α1</span> <span class="main">=</span> bn <span class="skolem">α</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_set permute_plus<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_set<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> <span class="skolem">α1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="main">(</span><span class="skolem">q</span> <span class="main">+</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>bn <span class="skolem">α</span><span class="main">,</span> <span class="skolem">α</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> alpha_trans<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> permute_plus<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"tAct <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">z</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> z <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> tAct.prems<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Formula-alpha_Tree_equivp"><span class="command">lemma</span></span> alpha_Tree_equivp<span class="main">:</span> <span class="quoted"><span class="quoted">"equivp alpha_Tree"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> equivpI alpha_Tree_reflp alpha_Tree_symp alpha_Tree_transp<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹$alpha$-equivalent trees have the same support modulo $alpha$-equivalence.›</span></span>

<span class="keyword1" id="Formula-alpha_Tree_supp_rel"><span class="command">lemma</span></span> alpha_Tree_supp_rel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t1</span> <span class="main">=</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alpha_Tree_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tConj <span class="skolem">tset1</span> <span class="skolem">tset2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> rel_bset <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟷</span> rel_bset <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="bound">y</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> alpha_Tree_symp bset.rel_symp sympE<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">from</span></span> tConj.hyps <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_bset <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">tset1</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">tset2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_tConj alpha_Tree_eqvt permute_Tree_tConj<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_bset <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">tset1</span><span class="main">)</span> <span class="skolem">tset1</span> <span class="main">⟷</span> rel_bset <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">tset2</span><span class="main">)</span> <span class="skolem">tset2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span> alpha_Tree_transp bset.rel_transp sym tConj.hyps transpE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_rel_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> tNot <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_rel_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tAct <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="skolem">α2</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tAct <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="skolem">α2</span> <span class="skolem">t2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tAct.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> tAct <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="main">⟷</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> tAct <span class="skolem">α2</span> <span class="skolem">t2</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="skolem">α2</span> <span class="skolem">t2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alpha_Tree_eqvt alpha_Tree_symp alpha_Tree_transp sympE transpE<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_rel_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> tAct<span class="antiquote"><span class="antiquote">}</span></span></span></span> preserves $\alpha$-equivalence.›</span></span>

<span class="keyword1" id="Formula-alpha_Tree_tAct"><span class="command">lemma</span></span> alpha_Tree_tAct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tAct <span class="free">α</span> <span class="free">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="free">α</span> <span class="free">t2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="free">α</span><span class="main">,</span> <span class="free">t1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span>bn <span class="free">α</span><span class="main">,</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_Tree_supp_rel alpha_set fresh_star_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="free">α</span><span class="main">,</span> <span class="free">α</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="main">0</span> <span class="main">(</span>bn <span class="free">α</span><span class="main">,</span> <span class="free">α</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> alpha_refl<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following lemmas describe the support modulo $alpha$-equivalence.›</span></span>

<span class="keyword1" id="Formula-supp_rel_tNot"><span class="command">lemma</span></span> supp_rel_tNot <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>tNot <span class="free">t</span><span class="main">)</span> <span class="main">=</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> supp_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Formula-supp_rel_tPred"><span class="command">lemma</span></span> supp_rel_tPred <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>tPred <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> supp_rel_def supp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The support modulo $\alpha$-equivalence of~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"tAct <span class="free"><span class="free">α</span></span> <span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not easily described:
when~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> has infinite support (modulo $\alpha$-equivalence), the support (modulo
$\alpha$-equivalence) of~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"tAct <span class="free"><span class="free">α</span></span> <span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> may still contain names in~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"bn <span class="free"><span class="free">α</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. This
incongruity is avoided when~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> has finite support modulo $\alpha$-equivalence.›</span></span>

<span class="keyword1" id="Formula-infinite_mono"><span class="command">lemma</span></span> infinite_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">T</span><span class="main">)</span> <span class="main">⟹</span> infinite <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> infinite_super subsetI<span class="main">)</span>

<span class="keyword1" id="Formula-supp_rel_tAct"><span class="command">lemma</span></span> supp_rel_tAct <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>tAct <span class="free">α</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">α</span> <span class="main">∪</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span> <span class="main">-</span> bn <span class="free">α</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"supp <span class="free">α</span> <span class="main">∪</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span> <span class="main">-</span> bn <span class="free">α</span> <span class="main">⊆</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>tAct <span class="free">α</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> supp <span class="free">α</span> <span class="main">∪</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span> <span class="main">-</span> bn <span class="free">α</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> x1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> supp <span class="free">α</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> bn <span class="free">α</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> x1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span> <span class="main">≠</span> <span class="free">α</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span><span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span> <span class="main">≠</span> <span class="free">α</span><span class="main">}</span> <span class="main">-</span> supp <span class="free">α</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_supp<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span> <span class="main">≠</span> <span class="free">α</span><span class="main">}</span> <span class="main">-</span> supp <span class="free">α</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> b1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span> <span class="main">≠</span> <span class="free">α</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> supp <span class="free">α</span> <span class="main">-</span> bn <span class="free">α</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">from</span></span> b1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sort_of <span class="skolem">x</span> <span class="main">=</span> sort_of <span class="skolem">b</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> swap_different_sorts <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span>supp <span class="free">α</span> <span class="main">-</span> bn <span class="free">α</span><span class="main">)</span> <span class="main">≠</span> supp <span class="free">α</span> <span class="main">-</span> bn <span class="free">α</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> b2 x1 x2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> swap_set_in<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> tAct <span class="free">α</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="free">α</span> <span class="free">t</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set Diff_eqvt bn_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> tAct <span class="free">α</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="free">α</span> <span class="free">t</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> infinite_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>tAct <span class="free">α</span> <span class="free">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> supp_rel_def <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> x1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> bn <span class="free">α</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> x1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> supp_rel_def <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span><span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t</span><span class="main">}</span> <span class="main">-</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t</span><span class="main">}</span> <span class="main">-</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> b1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span> <span class="main">-</span> bn <span class="free">α</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">from</span></span> b1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span> <span class="main">≠</span> <span class="free">t</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_Tree_reflp reflpE<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sort_of <span class="skolem">x</span> <span class="main">=</span> sort_of <span class="skolem">b</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> swap_different_sorts <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span> <span class="main">-</span> bn <span class="free">α</span><span class="main">)</span> <span class="main">≠</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span> <span class="main">-</span> bn <span class="free">α</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> b2 x1 x2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> swap_set_in<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span> <span class="main">-</span> bn <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span><span class="main">)</span> <span class="main">≠</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span> <span class="main">-</span> bn <span class="free">α</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Diff_eqvt bn_eqvt<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> tAct <span class="free">α</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="free">α</span> <span class="free">t</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> tAct <span class="free">α</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="free">α</span> <span class="free">t</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> infinite_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>tAct <span class="free">α</span> <span class="free">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> supp_rel_def <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>tAct <span class="free">α</span> <span class="free">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>tAct <span class="free">α</span> <span class="free">t</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">α</span> <span class="main">∪</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span> <span class="main">-</span> bn <span class="free">α</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>tAct <span class="free">α</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> tAct <span class="free">α</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="free">α</span> <span class="free">t</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> supp_rel_def <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> tAct <span class="free">α</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="free">α</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span> <span class="main">≠</span> <span class="free">α</span> <span class="main">∨</span> <span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> alpha_Tree_tAct <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span> <span class="main">≠</span> <span class="free">α</span> <span class="main">∨</span> <span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> infinite_mono mem_Collect_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span> <span class="main">≠</span> <span class="free">α</span><span class="main">}</span> <span class="main">∨</span> infinite <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> finite_Collect_disjI<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> supp <span class="free">α</span> <span class="main">∪</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_def supp_rel_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> bn <span class="free">α</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"*"</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> b1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> tAct <span class="free">α</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="free">α</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> supp <span class="free">α</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> UnCI finite_UnI finite_supp infinite_mono mem_Collect_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span> <span class="main">-</span> bn <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span><span class="main">)</span> <span class="main">=</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span> <span class="main">-</span> bn <span class="free">α</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"**"</span> <span class="keyword2"><span class="keyword">and</span></span> b3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Diff_eqvt Diff_iff alpha_Tree_eqvt' alpha_Tree_eqvt_aux bn_eqvt swap_set_not_in<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span> <span class="main">-</span> bn <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span><span class="main">)</span><span class="main">)</span> <span class="main">♯*</span> <span class="var">?p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"**"</span> <span class="keyword2"><span class="keyword">and</span></span> b3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_iff fresh_perm fresh_star_def swap_atom_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">∙</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> alpha_Tree_reflp reflpE <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">∙</span> bn <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span><span class="main">)</span> <span class="main">=</span> bn <span class="free">α</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bn_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span><span class="main">)</span> <span class="main">-</span> bn <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">α</span> <span class="main">-</span> bn <span class="free">α</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"**"</span> <span class="keyword2"><span class="keyword">and</span></span> b2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Diff_eqvt Diff_iff bn_eqvt supp_eqvt swap_set_not_in<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span><span class="main">)</span> <span class="main">-</span> bn <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span><span class="main">)</span><span class="main">)</span> <span class="main">♯*</span> <span class="var">?p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"**"</span> <span class="keyword2"><span class="keyword">and</span></span> b2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_def supp_perm<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Diff_iff swap_atom_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">∙</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span> <span class="main">=</span> <span class="free">α</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> tAct <span class="free">α</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="free">α</span> <span class="free">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> b1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> supp <span class="free">α</span> <span class="main">∪</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span> <span class="main">-</span> bn <span class="free">α</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define the type of (infinitely branching) trees quotiented by $\alpha$-equivalence.›</span></span>

<span class="comment1">(* FIXME: No map function defined. No relator found. *)</span>
<span class="keyword1"><span class="command">quotient_type</span></span>
  <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>pt<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">)</span> Tree"</span></span> <span class="main">/</span> <span class="quoted"><span class="quoted">"alpha_Tree"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> alpha_Tree_equivp<span class="main">)</span>

<span class="keyword1" id="Formula-Tree"><span class="command">lemma</span></span> Tree<span class="hidden">⇩</span><sub>α</sub>_abs_rep <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"abs_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Quotient_Tree<span class="hidden">⇩</span><sub>α</sub> Quotient_abs_rep<span class="main">)</span>

<span class="keyword1" id="Formula-Tree"><span class="command">lemma</span></span> Tree<span class="hidden">⇩</span><sub>α</sub>_rep_abs <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>abs_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">t</span><span class="main">)</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff Tree<span class="hidden">⇩</span><sub>α</sub>_abs_rep<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The permutation operation is lifted from trees.›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">pt</span><span class="main">,</span> <span class="quoted">bn</span><span class="main">)</span> <span class="quoted">pt</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">permute_Tree<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"perm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub>"</span></span>
    <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">permute</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> alpha_Tree_eqvt<span class="main">)</span>

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∙</span> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">metis</span> alpha_Tree_equivp equivp_reflp permute_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">::</span> <span class="quoted">perm</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">+</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">metis</span> alpha_Tree_equivp equivp_reflp permute_plus<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The abstraction function from trees to trees modulo $\alpha$-equivalence is equivariant. The
representation function is equivariant modulo $\alpha$-equivalence.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> permute_Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq <span class="main">[</span><span class="operator">eqvt</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span>

<span class="keyword1" id="Formula-alpha_Tree_permute_rep_commute"><span class="command">lemma</span></span> alpha_Tree_permute_rep_commute <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff Tree<span class="hidden">⇩</span><sub>α</sub>_abs_rep permute_Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Constructors for trees modulo \texorpdfstring{$\alpha$}{alpha}-equivalence›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The constructors are lifted from trees.›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> Conj<span class="hidden">⇩</span><sub>α</sub> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>pt<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted">tConj</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Formula-map_bset_abs_rep_Tree"><span class="command">lemma</span></span> map_bset_abs_rep_Tree<span class="hidden">⇩</span><sub>α</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"map_bset abs_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Quotient_Tree<span class="hidden">⇩</span><sub>α</sub> Quotient_abs_rep bset_lifting.bset_quot_map<span class="main">)</span>

<span class="keyword1" id="Formula-Conj"><span class="command">lemma</span></span> Conj<span class="hidden">⇩</span><sub>α</sub>_def'<span class="main">:</span> <span class="quoted"><span class="quoted">"Conj<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> abs_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>tConj <span class="main">(</span>map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Conj<span class="hidden">⇩</span><sub>α</sub>.abs_eq map_bset_abs_rep_Tree<span class="hidden">⇩</span><sub>α</sub><span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> Not<span class="hidden">⇩</span><sub>α</sub> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>pt<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted">tNot</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lift_definition</span></span> Pred<span class="hidden">⇩</span><sub>α</sub> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'pred</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>pt<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted">tPred</span>
<span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'act</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>pt<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted">tAct</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> alpha_Tree_tAct<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The lifted constructors are equivariant.›</span></span>

<span class="keyword1" id="Formula-Conj"><span class="command">lemma</span></span> Conj<span class="hidden">⇩</span><sub>α</sub>_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Conj<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> Conj<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set_bset <span class="main">(</span>map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> imageE permute_bset.rep_eq permute_set_eq_image<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">∈</span> set_bset <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∙</span> rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> imageE map_bset.rep_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">∈</span> set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_permute_iff permute_bset.rep_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x'</span> <span class="main">∈</span> set_bset <span class="main">(</span>map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bset.set_map<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="var">?x'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_Tree_permute_rep_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x'</span><span class="main">∈</span>set_bset <span class="main">(</span>map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="bound">x'</span>"</span></span>
      <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set_bset <span class="main">(</span>map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> imageE map_bset.rep_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">∈</span> set_bset <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> imageE permute_bset.rep_eq permute_set_eq_image<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">∈</span> set_bset <span class="main">(</span>map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bset.set_map<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y'</span> <span class="main">∈</span> set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_permute_iff permute_bset.rep_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_Tree_permute_rep_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y'</span><span class="main">∈</span>set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span><span class="main">.</span> <span class="bound">y'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Conj<span class="hidden">⇩</span><sub>α</sub>_def' map_bset_eqvt rel_bset_def rel_set_def Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Formula-Not"><span class="command">lemma</span></span> Not<span class="hidden">⇩</span><sub>α</sub>_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Not<span class="hidden">⇩</span><sub>α</sub> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> Not<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t<span class="hidden">⇩</span><sub>α</sub></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Not<span class="hidden">⇩</span><sub>α</sub>.abs_eq<span class="main">)</span>

<span class="keyword1" id="Formula-Pred"><span class="command">lemma</span></span> Pred<span class="hidden">⇩</span><sub>α</sub>_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free">φ</span> <span class="main">=</span> Pred<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Pred<span class="hidden">⇩</span><sub>α</sub>.abs_eq<span class="main">)</span>

<span class="keyword1" id="Formula-Act"><span class="command">lemma</span></span> Act<span class="hidden">⇩</span><sub>α</sub>_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">α</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">α</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t<span class="hidden">⇩</span><sub>α</sub></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Act<span class="hidden">⇩</span><sub>α</sub>.abs_eq<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The lifted constructors are injective (except for~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Act<span class="hidden">⇩</span><sub>α</sub><span class="antiquote"><span class="antiquote">}</span></span></span></span>).›</span></span>

<span class="keyword1" id="Formula-Conj"><span class="command">lemma</span></span> Conj<span class="hidden">⇩</span><sub>α</sub>_eq_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Conj<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset1<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> Conj<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset2<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">⟷</span> <span class="free">tset1<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> <span class="free">tset2<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Conj<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset1<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> Conj<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset2<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tConj <span class="main">(</span>map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset1<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tConj <span class="main">(</span>map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset2<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Conj<span class="hidden">⇩</span><sub>α</sub>_def' Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_bset <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset1<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">(</span>map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset2<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> alpha_Tree.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">tset1<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> <span class="free">tset2<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Quotient_Tree<span class="hidden">⇩</span><sub>α</sub> Quotient_rel_abs2 bset_lifting.bset_quot_map map_bset_abs_rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">fact</span> arg_cong<span class="main">)</span>

<span class="keyword1" id="Formula-Not"><span class="command">lemma</span></span> Not<span class="hidden">⇩</span><sub>α</sub>_eq_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Not<span class="hidden">⇩</span><sub>α</sub> <span class="free">t1<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> Not<span class="hidden">⇩</span><sub>α</sub> <span class="free">t2<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">⟷</span> <span class="free">t1<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> <span class="free">t2<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Not<span class="hidden">⇩</span><sub>α</sub> <span class="free">t1<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> Not<span class="hidden">⇩</span><sub>α</sub> <span class="free">t2<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tNot <span class="main">(</span>rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">t1<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tNot <span class="main">(</span>rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">t2<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Not<span class="hidden">⇩</span><sub>α</sub>.abs_eq Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff Tree<span class="hidden">⇩</span><sub>α</sub>_abs_rep<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">t1<span class="hidden">⇩</span><sub>α</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">t2<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> alpha_Tree.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">t1<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> <span class="free">t2<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff Tree<span class="hidden">⇩</span><sub>α</sub>_abs_rep<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">t1<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> <span class="free">t2<span class="hidden">⇩</span><sub>α</sub></span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Not<span class="hidden">⇩</span><sub>α</sub> <span class="free">t1<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> Not<span class="hidden">⇩</span><sub>α</sub> <span class="free">t2<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Formula-Pred"><span class="command">lemma</span></span> Pred<span class="hidden">⇩</span><sub>α</sub>_eq_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free">φ1</span> <span class="main">=</span> Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free">φ2</span> <span class="main">⟷</span> <span class="free">φ1</span> <span class="main">=</span> <span class="free">φ2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free">φ1</span> <span class="main">=</span> Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free">φ2</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>tPred <span class="free">φ1</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> Tree<span class="main">)</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tPred <span class="free">φ2</span>"</span></span>  <span class="comment1">― ‹note the unrelated type›</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pred<span class="hidden">⇩</span><sub>α</sub>.abs_eq Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ1</span> <span class="main">=</span> <span class="free">φ2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> alpha_Tree.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ1</span> <span class="main">=</span> <span class="free">φ2</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free">φ1</span> <span class="main">=</span> Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free">φ2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Formula-Act"><span class="command">lemma</span></span> Act<span class="hidden">⇩</span><sub>α</sub>_eq_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">α1</span> <span class="free">t1</span> <span class="main">=</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">α2</span> <span class="free">t2</span> <span class="main">⟷</span> tAct <span class="free">α1</span> <span class="main">(</span>rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">t1</span><span class="main">)</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="free">α2</span> <span class="main">(</span>rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">t2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act<span class="hidden">⇩</span><sub>α</sub>.abs_eq Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff Tree<span class="hidden">⇩</span><sub>α</sub>_abs_rep<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The lifted constructors are free (except for~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Act<span class="hidden">⇩</span><sub>α</sub><span class="antiquote"><span class="antiquote">}</span></span></span></span>).›</span></span>

<span class="keyword1" id="Formula-Tree"><span class="command">lemma</span></span> Tree<span class="hidden">⇩</span><sub>α</sub>_free <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Conj<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">≠</span> Not<span class="hidden">⇩</span><sub>α</sub> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Conj<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">≠</span> Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Conj<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">≠</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">α</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Not<span class="hidden">⇩</span><sub>α</sub> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">≠</span> Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Not<span class="hidden">⇩</span><sub>α</sub> <span class="free">t1<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">≠</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">α</span> <span class="free">t2<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free">φ</span> <span class="main">≠</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">α</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Conj<span class="hidden">⇩</span><sub>α</sub>_def' Not<span class="hidden">⇩</span><sub>α</sub>_def Pred<span class="hidden">⇩</span><sub>α</sub>_def Act<span class="hidden">⇩</span><sub>α</sub>_def Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following lemmas describe the support of constructed trees modulo $\alpha$-equivalence.›</span></span>

<span class="keyword1" id="Formula-supp_alpha_supp_rel"><span class="command">lemma</span></span> supp_alpha_supp_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> supp_def supp_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Collect_cong Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff Tree<span class="hidden">⇩</span><sub>α</sub>_abs_rep alpha_Tree_permute_rep_commute<span class="main">)</span>

<span class="keyword1" id="Formula-supp_Conj"><span class="command">lemma</span></span> supp_Conj<span class="hidden">⇩</span><sub>α</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Conj<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">=</span> supp <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Formula-supp_Not"><span class="command">lemma</span></span> supp_Not<span class="hidden">⇩</span><sub>α</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Not<span class="hidden">⇩</span><sub>α</sub> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">=</span> supp <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Formula-supp_Pred"><span class="command">lemma</span></span> supp_Pred<span class="hidden">⇩</span><sub>α</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Formula-supp_Act"><span class="command">lemma</span></span> supp_Act<span class="hidden">⇩</span><sub>α</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">α</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">=</span> supp <span class="free">α</span> <span class="main">∪</span> supp <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">-</span> bn <span class="free">α</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act<span class="hidden">⇩</span><sub>α</sub>.abs_eq Tree<span class="hidden">⇩</span><sub>α</sub>_abs_rep Tree<span class="hidden">⇩</span><sub>α</sub>_rep_abs alpha_Tree_supp_rel supp_alpha_supp_rel supp_rel_tAct<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Induction over trees modulo \texorpdfstring{$\alpha$}{alpha}-equivalence›</span></span>

<span class="keyword1" id="Formula-Tree"><span class="command">lemma</span></span> Tree<span class="hidden">⇩</span><sub>α</sub>_induct <span class="main">[</span><span class="operator">case_names</span> Conj<span class="hidden">⇩</span><sub>α</sub> Not<span class="hidden">⇩</span><sub>α</sub> Pred<span class="hidden">⇩</span><sub>α</sub> Act<span class="hidden">⇩</span><sub>α</sub> Env<span class="hidden">⇩</span><sub>α</sub><span class="main">,</span> <span class="operator">induct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">type</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> Tree<span class="hidden">⇩</span><sub>α</sub><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set_bset <span class="bound">tset<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Conj<span class="hidden">⇩</span><sub>α</sub> <span class="bound">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">.</span> <span class="free">P</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Not<span class="hidden">⇩</span><sub>α</sub> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">pred</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Pred<span class="hidden">⇩</span><sub>α</sub> <span class="bound">pred</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">act</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">.</span> <span class="free">P</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Act<span class="hidden">⇩</span><sub>α</sub> <span class="bound">act</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Tree<span class="hidden">⇩</span><sub>α</sub>.abs_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>abs_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tConj <span class="skolem">tset</span><span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?tset<span class="hidden">⇩</span><sub>α</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_bset abs_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="skolem">tset</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>tConj <span class="skolem">tset</span><span class="main">)</span> <span class="main">=</span> Conj<span class="hidden">⇩</span><sub>α</sub> <span class="var">?tset<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Conj<span class="hidden">⇩</span><sub>α</sub>.abs_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> tConj.IH <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> imageE map_bset.rep_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> tNot <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Not<span class="hidden">⇩</span><sub>α</sub>.abs_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> tPred <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pred<span class="hidden">⇩</span><sub>α</sub>.abs_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> tAct <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act<span class="hidden">⇩</span><sub>α</sub>.abs_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There is no (obvious) strong induction principle for trees modulo $\alpha$-equivalence: since
their support may be infinite, we may not be able to rename bound variables without also renaming
free variables.›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Hereditarily finitely supported trees›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We cannot obtain the type of infinitary formulas simply as the sub-type of all trees (modulo
$\alpha$-equivalence) that are finitely supported: since an infinite set of trees may be finitely
supported even though its members are not (and thus, would not be formulas), the sub-type of
\emph{all} finitely supported trees does not validate the induction principle that we desire for
formulas.

Instead, we define \emph{hereditarily} finitely supported trees. We require that environments and
state predicates are finitely supported.›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">hereditarily_fs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>fs<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  Conj<span class="hidden">⇩</span><sub>α</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free"><span class="bound"><span class="entity">tset<span class="hidden">⇩</span><sub>α</sub></span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">.</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">∈</span> set_bset <span class="free"><span class="bound"><span class="entity">tset<span class="hidden">⇩</span><sub>α</sub></span></span></span> <span class="main">⟹</span> <span class="free">hereditarily_fs</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">hereditarily_fs</span> <span class="main">(</span>Conj<span class="hidden">⇩</span><sub>α</sub> <span class="free"><span class="bound"><span class="entity">tset<span class="hidden">⇩</span><sub>α</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Not<span class="hidden">⇩</span><sub>α</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">hereditarily_fs</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>α</sub></span></span></span> <span class="main">⟹</span> <span class="free">hereditarily_fs</span> <span class="main">(</span>Not<span class="hidden">⇩</span><sub>α</sub> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>α</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Pred<span class="hidden">⇩</span><sub>α</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">hereditarily_fs</span> <span class="main">(</span>Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Act<span class="hidden">⇩</span><sub>α</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">hereditarily_fs</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>α</sub></span></span></span> <span class="main">⟹</span> <span class="free">hereditarily_fs</span> <span class="main">(</span>Act<span class="hidden">⇩</span><sub>α</sub> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>α</sub></span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> hereditarily_fs<span class="antiquote"><span class="antiquote">}</span></span></span></span> is equivariant.›</span></span>

<span class="keyword1" id="Formula-hereditarily_fs_eqvt"><span class="command">lemma</span></span> hereditarily_fs_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> hereditarily_fs.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Conj<span class="hidden">⇩</span><sub>α</sub> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Conj<span class="hidden">⇩</span><sub>α</sub>_eqvt hereditarily_fs.Conj<span class="hidden">⇩</span><sub>α</sub> mem_permute_iff permute_finite permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> set_bset_eqvt supp_eqvt<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Not<span class="hidden">⇩</span><sub>α</sub> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Not<span class="hidden">⇩</span><sub>α</sub>_eqvt hereditarily_fs.Not<span class="hidden">⇩</span><sub>α</sub><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Pred<span class="hidden">⇩</span><sub>α</sub> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pred<span class="hidden">⇩</span><sub>α</sub>_eqvt hereditarily_fs.Pred<span class="hidden">⇩</span><sub>α</sub><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act<span class="hidden">⇩</span><sub>α</sub>_eqvt hereditarily_fs.Act<span class="hidden">⇩</span><sub>α</sub><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> hereditarily_fs<span class="antiquote"><span class="antiquote">}</span></span></span></span> is preserved under $\alpha$-renaming.›</span></span>

<span class="keyword1" id="Formula-hereditarily_fs_alpha_renaming"><span class="command">lemma</span></span> hereditarily_fs_alpha_renaming<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">α</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">α'</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub>'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">⟷</span> hereditarily_fs <span class="free">t<span class="hidden">⇩</span><sub>α</sub>'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="free">t<span class="hidden">⇩</span><sub>α</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Act<span class="hidden">⇩</span><sub>α</sub>_def Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff alphas<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff Tree<span class="hidden">⇩</span><sub>α</sub>_abs_rep hereditarily_fs_eqvt permute_Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="free">t<span class="hidden">⇩</span><sub>α</sub>'</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Act<span class="hidden">⇩</span><sub>α</sub>_def Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff alphas<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff Tree<span class="hidden">⇩</span><sub>α</sub>_abs_rep hereditarily_fs_eqvt permute_Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Hereditarily finitely supported trees have finite support.›</span></span>

<span class="keyword1" id="Formula-hereditarily_fs_implies_finite_supp"><span class="command">lemma</span></span> hereditarily_fs_implies_finite_supp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> hereditarily_fs.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_supp<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Infinitary formulas›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now, infinitary formulas are simply the sub-type of hereditarily finitely supported trees.›</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span><span class="quoted">fs</span><span class="main">,</span><span class="tfree">'act</span><span class="main">::</span><span class="quoted">bn</span><span class="main">)</span> formula <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">::</span><span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub><span class="main">.</span> hereditarily_fs <span class="bound">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hereditarily_fs.Pred<span class="hidden">⇩</span><sub>α</sub> mem_Collect_eq<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We set up Isabelle's lifting infrastructure so that we can lift definitions from the type of
trees modulo $\alpha$-equivalence to the sub-type of formulas.›</span></span>

<span class="comment1">(* FIXME: No relator found. *)</span>
<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_formula

<span class="keyword1" id="Formula-Abs_formula_inverse"><span class="command">lemma</span></span> Abs_formula_inverse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Rep_formula <span class="main">(</span>Abs_formula <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Abs_formula_inverse mem_Collect_eq<span class="main">)</span>

<span class="keyword1" id="Formula-Rep_formula'"><span class="command">lemma</span></span> Rep_formula' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="main">(</span>Rep_formula <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Rep_formula mem_Collect_eq<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we lift the permutation operation.›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> formula <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">fs</span><span class="main">,</span> <span class="quoted">bn</span><span class="main">)</span> <span class="quoted">pt</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">permute_formula</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"perm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> formula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> formula"</span></span>
    <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">permute</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> hereditarily_fs_eqvt<span class="main">)</span>

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The abstraction and representation functions for formulas are equivariant, and they preserve
support.›</span></span>

<span class="keyword1" id="Formula-Abs_formula_eqvt"><span class="command">lemma</span></span> Abs_formula_eqvt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Abs_formula <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> Abs_formula <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms eq_onp_same_args permute_formula.abs_eq<span class="main">)</span>

<span class="keyword1" id="Formula-supp_Abs_formula"><span class="command">lemma</span></span> supp_Abs_formula <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Abs_formula <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">=</span> supp <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted">perm</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> Abs_formula <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> Abs_formula <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Abs_formula_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hereditarily_fs_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> Abs_formula <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> Abs_formula <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">⟷</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Abs_formula_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> Rep_formula_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> permute_formula.rep_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>

<span class="keyword1" id="Formula-supp_Rep_formula"><span class="command">lemma</span></span> supp_Rep_formula <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Rep_formula <span class="free">x</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Rep_formula' Rep_formula_inverse supp_Abs_formula<span class="main">)</span>

<span class="keyword1" id="Formula-supp_map_bset_Rep_formula"><span class="command">lemma</span></span> supp_map_bset_Rep_formula <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>map_bset Rep_formula <span class="free">xset</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">xset</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eqvt <span class="main">(</span>map_bset Rep_formula<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eqvt_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>map_bset Rep_formula <span class="free">xset</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">xset</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> supp_fun_app_eqvt<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">atom</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span>map_bset Rep_formula<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bset.inj_map Rep_formula_inject injI<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">⟹</span> map_bset Rep_formula <span class="bound">x</span> <span class="main">≠</span> map_bset Rep_formula <span class="bound">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inj_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">xset</span> <span class="main">≠</span> <span class="free">xset</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> map_bset Rep_formula <span class="free">xset</span> <span class="main">≠</span> map_bset Rep_formula <span class="free">xset</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">⊆</span> <span class="var">?T</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="var">?S</span> <span class="main">⟹</span> infinite <span class="var">?T</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> infinite_super<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"supp <span class="free">xset</span> <span class="main">⊆</span> supp <span class="main">(</span>map_bset Rep_formula <span class="free">xset</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Formulas are in fact finitely supported.›</span></span>

<span class="keyword1"><span class="command">instance</span></span> formula <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">fs</span><span class="main">,</span> <span class="quoted">bn</span><span class="main">)</span> <span class="quoted">fs</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">metis</span> Rep_formula' hereditarily_fs_implies_finite_supp supp_Rep_formula<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Constructors for infinitary formulas›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We lift the constructors for trees (modulo $\alpha$-equivalence) to infinitary formulas.
Since~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Conj<span class="hidden">⇩</span><sub>α</sub><span class="antiquote"><span class="antiquote">}</span></span></span></span> does not necessarily yield a (hereditarily) finitely supported tree when
applied to a (potentially infinite) set of (hereditarily) finitely supported trees, we cannot use
Isabelle's {\bf lift\_definition} to define~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Conj</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Instead, theorems about terms of the
form~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Conj</span></span> <span class="free"><span class="free">xset</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> will usually carry an assumption that~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xset</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is finitely supported.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Conj</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">)</span> formula <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>fs<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">)</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Conj</span> <span class="free"><span class="bound"><span class="entity">xset</span></span></span> <span class="main">=</span> Abs_formula <span class="main">(</span>Conj<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>map_bset Rep_formula <span class="free"><span class="bound"><span class="entity">xset</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Formula-finite_supp_implies_hereditarily_fs_Conj"><span class="command">lemma</span></span> finite_supp_implies_hereditarily_fs_Conj<span class="hidden">⇩</span><sub>α</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="main">(</span>Conj<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>map_bset Rep_formula <span class="free">xset</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> hereditarily_fs.Conj<span class="hidden">⇩</span><sub>α</sub><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>map_bset Rep_formula <span class="free">xset</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> supp_map_bset_Rep_formula<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">∈</span> set_bset <span class="main">(</span>map_bset Rep_formula <span class="free">xset</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bset.set_map<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Formula-Conj_rep_eq"><span class="command">lemma</span></span> Conj_rep_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Rep_formula <span class="main">(</span>Conj <span class="free">xset</span><span class="main">)</span> <span class="main">=</span> Conj<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>map_bset Rep_formula <span class="free">xset</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Conj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lift_definition</span></span> Not <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">)</span> formula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>fs<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">)</span> formula"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted">Not<span class="hidden">⇩</span><sub>α</sub></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> hereditarily_fs.Not<span class="hidden">⇩</span><sub>α</sub><span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> Pred <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'pred</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>fs<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">)</span> formula"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted">Pred<span class="hidden">⇩</span><sub>α</sub></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> hereditarily_fs.Pred<span class="hidden">⇩</span><sub>α</sub><span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> Act <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'act</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">)</span> formula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>fs<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">)</span> formula"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted">Act<span class="hidden">⇩</span><sub>α</sub></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> hereditarily_fs.Act<span class="hidden">⇩</span><sub>α</sub><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The lifted constructors are equivariant (in the case of~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Conj<span class="antiquote"><span class="antiquote">}</span></span></span></span>, on finitely supported
arguments).›</span></span>

<span class="keyword1" id="Formula-Conj_eqvt"><span class="command">lemma</span></span> Conj_eqvt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Conj <span class="free">xset</span> <span class="main">=</span> Conj <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">xset</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Conj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Formula-Not_eqvt"><span class="command">lemma</span></span> Not_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Not <span class="free">x</span> <span class="main">=</span> Not <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="Formula-Pred_eqvt"><span class="command">lemma</span></span> Pred_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Pred <span class="free">φ</span> <span class="main">=</span> Pred <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="Formula-Act_eqvt"><span class="command">lemma</span></span> Act_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Act <span class="free">α</span> <span class="free">x</span> <span class="main">=</span> Act <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">α</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following lemmas describe the support of constructed formulas.›</span></span>

<span class="keyword1" id="Formula-supp_Conj"><span class="command">lemma</span></span> supp_Conj <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Conj <span class="free">xset</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">xset</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Conj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Formula-supp_Not"><span class="command">lemma</span></span> supp_Not <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Not <span class="free">x</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Not.rep_eq supp_Not<span class="hidden">⇩</span><sub>α</sub> supp_Rep_formula<span class="main">)</span>

<span class="keyword1" id="Formula-supp_Pred"><span class="command">lemma</span></span> supp_Pred <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Pred <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pred.rep_eq supp_Pred<span class="hidden">⇩</span><sub>α</sub> supp_Rep_formula<span class="main">)</span>

<span class="keyword1" id="Formula-supp_Act"><span class="command">lemma</span></span> supp_Act <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Act <span class="free">α</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">α</span> <span class="main">∪</span> supp <span class="free">x</span> <span class="main">-</span> bn <span class="free">α</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act.rep_eq finite_supp supp_Act<span class="hidden">⇩</span><sub>α</sub> supp_Rep_formula<span class="main">)</span>

<span class="keyword1" id="Formula-bn_fresh_Act"><span class="command">lemma</span></span> bn_fresh_Act <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="free">α</span> <span class="main">♯*</span> Act <span class="free">α</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_def fresh_star_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The lifted constructors are injective (except for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Act<span class="antiquote"><span class="antiquote">}</span></span></span></span>).›</span></span>

<span class="keyword1" id="Formula-Conj_eq_iff"><span class="command">lemma</span></span> Conj_eq_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Conj <span class="free">xset1</span> <span class="main">=</span> Conj <span class="free">xset2</span> <span class="main">⟷</span> <span class="free">xset1</span> <span class="main">=</span> <span class="free">xset2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Conj<span class="hidden">⇩</span><sub>α</sub>_eq_iff Conj_rep_eq Rep_formula_inverse injI inj_eq bset.inj_map<span class="main">)</span>

<span class="keyword1" id="Formula-Not_eq_iff"><span class="command">lemma</span></span> Not_eq_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Not <span class="free">x1</span> <span class="main">=</span> Not <span class="free">x2</span> <span class="main">⟷</span> <span class="free">x1</span> <span class="main">=</span> <span class="free">x2</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Not.rep_eq Not<span class="hidden">⇩</span><sub>α</sub>_eq_iff Rep_formula_inverse<span class="main">)</span>

<span class="keyword1" id="Formula-Pred_eq_iff"><span class="command">lemma</span></span> Pred_eq_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Pred <span class="free">φ1</span> <span class="main">=</span> Pred <span class="free">φ2</span> <span class="main">⟷</span> <span class="free">φ1</span> <span class="main">=</span> <span class="free">φ2</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pred.rep_eq Pred<span class="hidden">⇩</span><sub>α</sub>_eq_iff<span class="main">)</span>

<span class="keyword1" id="Formula-Act_eq_iff"><span class="command">lemma</span></span> Act_eq_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"Act <span class="free">α1</span> <span class="free">x1</span> <span class="main">=</span> Act <span class="free">α2</span> <span class="free">x2</span> <span class="main">⟷</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">α1</span> <span class="main">(</span>Rep_formula <span class="free">x1</span><span class="main">)</span> <span class="main">=</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">α2</span> <span class="main">(</span>Rep_formula <span class="free">x2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act.rep_eq Rep_formula_inverse<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Helpful lemmas for dealing with equalities involving~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Act<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1" id="Formula-Act_eq_iff_perm"><span class="command">lemma</span></span> Act_eq_iff_perm<span class="main">:</span> <span class="quoted"><span class="quoted">"Act <span class="free">α1</span> <span class="free">x1</span> <span class="main">=</span> Act <span class="free">α2</span> <span class="free">x2</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> supp <span class="free">x1</span> <span class="main">-</span> bn <span class="free">α1</span> <span class="main">=</span> supp <span class="free">x2</span> <span class="main">-</span> bn <span class="free">α2</span> <span class="main">∧</span> <span class="main">(</span>supp <span class="free">x1</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∙</span> <span class="free">x1</span> <span class="main">=</span> <span class="free">x2</span> <span class="main">∧</span> supp <span class="free">α1</span> <span class="main">-</span> bn <span class="free">α1</span> <span class="main">=</span> supp <span class="free">α2</span> <span class="main">-</span> bn <span class="free">α2</span> <span class="main">∧</span> <span class="main">(</span>supp <span class="free">α1</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∙</span> <span class="free">α1</span> <span class="main">=</span> <span class="free">α2</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">⟷</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> alpha<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="free">α1</span><span class="main">,</span> rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>Rep_formula <span class="free">x1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">(</span>bn <span class="free">α2</span><span class="main">,</span> rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>Rep_formula <span class="free">x2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="free">α1</span><span class="main">,</span> <span class="free">α1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="skolem">p</span> <span class="main">(</span>bn <span class="free">α2</span><span class="main">,</span> <span class="free">α2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act_eq_iff Act<span class="hidden">⇩</span><sub>α</sub>_eq_iff alpha_tAct<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> alpha <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="free">x1</span> <span class="main">-</span> bn <span class="free">α1</span> <span class="main">=</span> supp <span class="free">x2</span> <span class="main">-</span> bn <span class="free">α2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_set.simps supp_Rep_formula supp_alpha_supp_rel<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> alpha <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp <span class="free">x1</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_set.simps supp_Rep_formula supp_alpha_supp_rel<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> alpha <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="free">x1</span> <span class="main">=</span> <span class="free">x2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Rep_formula_eqvt Rep_formula_inject Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff Tree<span class="hidden">⇩</span><sub>α</sub>_abs_rep alpha_Tree_permute_rep_commute alpha_set.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="free">α1</span> <span class="main">-</span> bn <span class="free">α1</span> <span class="main">=</span> supp <span class="free">α2</span> <span class="main">-</span> bn <span class="free">α2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_set.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp <span class="free">α1</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_set.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="free">α1</span> <span class="main">=</span> <span class="free">α2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="free">x1</span> <span class="main">-</span> bn <span class="free">α1</span> <span class="main">=</span> supp <span class="free">x2</span> <span class="main">-</span> bn <span class="free">α2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp <span class="free">x1</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="free">x1</span> <span class="main">=</span> <span class="free">x2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="free">α1</span> <span class="main">-</span> bn <span class="free">α1</span> <span class="main">=</span> supp <span class="free">α2</span> <span class="main">-</span> bn <span class="free">α2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp <span class="free">α1</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="free">α1</span> <span class="main">=</span> <span class="free">α2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">from</span></span> 1 2 3 6 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="free">α1</span><span class="main">,</span> rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>Rep_formula <span class="free">x1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">(</span>bn <span class="free">α2</span><span class="main">,</span> rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>Rep_formula <span class="free">x2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Rep_formula_eqvt alpha_Tree_permute_rep_commute alpha_set.simps bn_eqvt supp_Rep_formula supp_alpha_supp_rel<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 4 5 6 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="free">α1</span><span class="main">,</span> <span class="free">α1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="skolem">p</span> <span class="main">(</span>bn <span class="free">α2</span><span class="main">,</span> <span class="free">α2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set.simps bn_eqvt<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Act <span class="free">α1</span> <span class="free">x1</span> <span class="main">=</span> Act <span class="free">α2</span> <span class="free">x2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act_eq_iff Act<span class="hidden">⇩</span><sub>α</sub>_eq_iff alpha_tAct<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Formula-Act_eq_iff_perm_renaming"><span class="command">lemma</span></span> Act_eq_iff_perm_renaming<span class="main">:</span> <span class="quoted"><span class="quoted">"Act <span class="free">α1</span> <span class="free">x1</span> <span class="main">=</span> Act <span class="free">α2</span> <span class="free">x2</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> supp <span class="free">x1</span> <span class="main">-</span> bn <span class="free">α1</span> <span class="main">=</span> supp <span class="free">x2</span> <span class="main">-</span> bn <span class="free">α2</span> <span class="main">∧</span> <span class="main">(</span>supp <span class="free">x1</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∙</span> <span class="free">x1</span> <span class="main">=</span> <span class="free">x2</span> <span class="main">∧</span> supp <span class="free">α1</span> <span class="main">-</span> bn <span class="free">α1</span> <span class="main">=</span> supp <span class="free">α2</span> <span class="main">-</span> bn <span class="free">α2</span> <span class="main">∧</span> <span class="main">(</span>supp <span class="free">α1</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∙</span> <span class="free">α1</span> <span class="main">=</span> <span class="free">α2</span> <span class="main">∧</span> supp <span class="bound">p</span> <span class="main">⊆</span> bn <span class="free">α1</span> <span class="main">∪</span> <span class="bound">p</span> <span class="main">∙</span> bn <span class="free">α1</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">⟷</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="free">x1</span> <span class="main">-</span> bn <span class="free">α1</span> <span class="main">=</span> supp <span class="free">x2</span> <span class="main">-</span> bn <span class="free">α2</span> <span class="main">∧</span> <span class="main">(</span>supp <span class="free">x1</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">x1</span> <span class="main">=</span> <span class="free">x2</span> <span class="main">∧</span> supp <span class="free">α1</span> <span class="main">-</span> bn <span class="free">α1</span> <span class="main">=</span> supp <span class="free">α2</span> <span class="main">-</span> bn <span class="free">α2</span> <span class="main">∧</span> <span class="main">(</span>supp <span class="free">α1</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">α1</span> <span class="main">=</span> <span class="free">α2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act_eq_iff_perm<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> q_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">b</span><span class="main">∈</span>bn <span class="free">α1</span><span class="main">.</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="bound">b</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="bound">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> supp_q<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="skolem">q</span> <span class="main">⊆</span> bn <span class="free">α1</span> <span class="main">∪</span> <span class="skolem">p</span> <span class="main">∙</span> bn <span class="free">α1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> set_renaming_perm2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="skolem">q</span> <span class="main">⊆</span> supp <span class="skolem">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> supp <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> supp <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> bn <span class="free">α1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"*"</span> q_p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_Collect_eq supp_perm<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="skolem">p</span> <span class="main">∙</span> bn <span class="free">α1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"*"</span> supp_q <span class="keyword1"><span class="command">using</span></span> UnE subsetCE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">a</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_permute_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> fresh_def fresh_perm <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp <span class="free">x1</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp <span class="free">α1</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> fresh_def fresh_star_def subset_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> p <span class="keyword2"><span class="keyword">and</span></span> q_p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> supp <span class="free">α1</span> <span class="main">⟹</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="bound">a</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="bound">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> supp <span class="free">x1</span> <span class="main">⟹</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="bound">a</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="bound">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_iff fresh_perm fresh_star_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∙</span> <span class="free">α1</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">α1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∙</span> <span class="free">x1</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">x1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> supp_perm_perm_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> supp_q <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bn_eqvt<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Act_eq_iff_perm<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The lifted constructors are free (except for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Act<span class="antiquote"><span class="antiquote">}</span></span></span></span>).›</span></span>

<span class="keyword1" id="Formula-Tree_free"><span class="command">lemma</span></span> Tree_free <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span> <span class="main">⟹</span> Conj <span class="free">xset</span> <span class="main">≠</span> Not <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span> <span class="main">⟹</span> Conj <span class="free">xset</span> <span class="main">≠</span> Pred <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span> <span class="main">⟹</span> Conj <span class="free">xset</span> <span class="main">≠</span> Act <span class="free">α</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Not <span class="free">x</span> <span class="main">≠</span> Pred <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Not <span class="free">x1</span> <span class="main">≠</span> Act <span class="free">α</span> <span class="free">x2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Pred <span class="free">φ</span> <span class="main">≠</span> Act <span class="free">α</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span> <span class="main">⟹</span> Conj <span class="free">xset</span> <span class="main">≠</span> Not <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Conj_rep_eq Not.rep_eq Tree<span class="hidden">⇩</span><sub>α</sub>_free<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span> <span class="main">⟹</span> Conj <span class="free">xset</span> <span class="main">≠</span> Pred <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Conj_rep_eq Pred.rep_eq Tree<span class="hidden">⇩</span><sub>α</sub>_free<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span> <span class="main">⟹</span> Conj <span class="free">xset</span> <span class="main">≠</span> Act <span class="free">α</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Conj_rep_eq Act.rep_eq Tree<span class="hidden">⇩</span><sub>α</sub>_free<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Not <span class="free">x</span> <span class="main">≠</span> Pred <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Not.rep_eq Pred.rep_eq Tree<span class="hidden">⇩</span><sub>α</sub>_free<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Not <span class="free">x1</span> <span class="main">≠</span> Act <span class="free">α</span> <span class="free">x2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Not.rep_eq Act.rep_eq Tree<span class="hidden">⇩</span><sub>α</sub>_free<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Pred <span class="free">φ</span> <span class="main">≠</span> Act <span class="free">α</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pred.rep_eq Act.rep_eq Tree<span class="hidden">⇩</span><sub>α</sub>_free<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Induction over infinitary formulas›</span></span>

<span class="keyword1" id="Formula-formula_induct"><span class="command">lemma</span></span> formula_induct <span class="main">[</span><span class="operator">case_names</span> Conj Not Pred Act<span class="main">,</span> <span class="operator">induct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">type</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> formula<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xset</span><span class="main">.</span> finite <span class="main">(</span>supp <span class="bound">xset</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set_bset <span class="bound">xset</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Conj <span class="bound">xset</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">formula</span><span class="main">.</span> <span class="free">P</span> <span class="bound">formula</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Not <span class="bound">formula</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">pred</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Pred <span class="bound">pred</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">act</span> <span class="bound">formula</span><span class="main">.</span> <span class="free">P</span> <span class="bound">formula</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Act <span class="bound">act</span> <span class="bound">formula</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">∈</span> <span class="main">{</span><span class="bound">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">.</span> hereditarily_fs <span class="bound">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>Abs_formula <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Conj<span class="hidden">⇩</span><sub>α</sub> <span class="skolem">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?tset</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_bset Abs_formula <span class="skolem">tset<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t<span class="hidden">⇩</span><sub>α</sub>'</span><span class="main">.</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub>'</span> <span class="main">∈</span> set_bset <span class="skolem">tset<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">⟹</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub>'</span> <span class="main">=</span> <span class="main">(</span>Rep_formula <span class="main">∘</span> Abs_formula<span class="main">)</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub>'</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Conj<span class="hidden">⇩</span><sub>α</sub>.hyps<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tset<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> map_bset <span class="main">(</span>Rep_formula <span class="main">∘</span> Abs_formula<span class="main">)</span> <span class="skolem">tset<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bset.map_cong0 bset.map_id id_apply<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tset<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> map_bset Rep_formula <span class="var">?tset</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bset.map_comp<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Abs_formula <span class="main">(</span>Conj<span class="hidden">⇩</span><sub>α</sub> <span class="skolem">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">=</span> Conj <span class="var">?tset</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Conj_def<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"*"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="var">?tset</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Conj<span class="hidden">⇩</span><sub>α</sub>.hyps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> supp_map_bset_Rep_formula<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> set_bset <span class="var">?tset</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Conj<span class="hidden">⇩</span><sub>α</sub>.IH <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> imageE map_bset.rep_eq<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Not<span class="hidden">⇩</span><sub>α</sub> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Formula.Abs_formula_inverse Not.rep_eq Rep_formula_inverse<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Pred<span class="hidden">⇩</span><sub>α</sub> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pred.abs_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Formula.Abs_formula_inverse Act.rep_eq Rep_formula_inverse<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Strong induction over infinitary formulas›</span></span>

<span class="keyword1" id="Formula-formula_strong_induct_aux"><span class="command">lemma</span></span> formula_strong_induct_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xset</span> <span class="bound">c</span><span class="main">.</span> finite <span class="main">(</span>supp <span class="bound">xset</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set_bset <span class="bound">xset</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span>Conj <span class="bound">xset</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">formula</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">formula</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span>Not <span class="bound">formula</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">pred</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span>Pred <span class="bound">pred</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">act</span> <span class="bound">formula</span> <span class="bound">c</span><span class="main">.</span> bn <span class="bound">act</span> <span class="main">♯*</span> <span class="bound">c</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">formula</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span>Act <span class="bound">act</span> <span class="bound">formula</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="main">(</span><span class="bound">c</span> <span class="main">::</span> <span class="tfree">'d</span><span class="main">::</span>fs<span class="main">)</span> <span class="bound">p</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Conj <span class="skolem">xset</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">xset</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_finite supp_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set_bset <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">xset</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Conj.IH <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> eqvt_bound mem_permute_iff set_bset_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Not <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Pred <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Act <span class="skolem">α</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="comment1">― ‹rename~<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"bn <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span>"</span><span class="antiquote">}</span></span> to avoid~<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">c</span></span><span class="antiquote">}</span></span>, without touching~<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Act <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span>"</span><span class="antiquote">}</span></span>›</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q</span> <span class="main">∙</span> bn <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Act <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> at_set_avoiding2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"bn <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">p</span></span> <span class="main"><span class="main">∙</span></span> <span class="skolem"><span class="skolem">α</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">c</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Act <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">p</span></span> <span class="main"><span class="main">∙</span></span> <span class="skolem"><span class="skolem">α</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">p</span></span> <span class="main"><span class="main">∙</span></span> <span class="skolem"><span class="skolem">x</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> exE<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>bn <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> bn_finite<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> finite_supp<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>Act <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_supp<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bn <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">♯*</span> Act <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_def fresh_star_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn <span class="main">(</span><span class="skolem">q</span> <span class="main">∙</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">c</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bn_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Act.IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">∙</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_plus<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">c</span> <span class="main">(</span>Act <span class="main">(</span><span class="skolem">q</span> <span class="main">∙</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">∙</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Act <span class="main">(</span><span class="skolem">q</span> <span class="main">∙</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">∙</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> Act <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> supp_perm_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> formula_strong_induct <span class="main">=</span> formula_strong_induct_aux<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> formula_strong_induct <span class="main">[</span><span class="operator">case_names</span> Conj Not Pred Act<span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Validity">
<div class="head">
<h1>Theory Validity</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Validity
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Transition_System">Transition_System</a>
  <a href="#Formula">Formula</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Validity›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following is needed to prove termination of~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">validTree</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">alpha_Tree_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">alpha_Tree_rel</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="bound">y</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Validity-alpha_Tree_relI"><span class="command">lemma</span></span> alpha_Tree_relI <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> alpha_Tree_rel"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> alpha_Tree_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Validity-alpha_Tree_relE"><span class="command">lemma</span></span> alpha_Tree_relE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> alpha_Tree_rel"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">P</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> alpha_Tree_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Validity-wf_alpha_Tree_rel_hull_rel_Tree_wf"><span class="command">lemma</span></span> wf_alpha_Tree_rel_hull_rel_Tree_wf<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf <span class="main">(</span>alpha_Tree_rel <span class="keyword1">O</span> hull_rel <span class="keyword1">O</span> Tree_wf<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> wf_relcomp_compatible<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>hull_rel <span class="keyword1">O</span> Tree_wf<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree_wf_eqvt' wf_Tree_wf wf_hull_rel_relcomp<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>hull_rel <span class="keyword1">O</span> Tree_wf<span class="main">)</span> <span class="keyword1">O</span> alpha_Tree_rel <span class="main">⊆</span> alpha_Tree_rel <span class="keyword1">O</span> <span class="main">(</span>hull_rel <span class="keyword1">O</span> Tree_wf<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> Tree <span class="main">×</span> <span class="main">(</span><span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> Tree"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span>hull_rel <span class="keyword1">O</span> Tree_wf<span class="main">)</span> <span class="keyword1">O</span> alpha_Tree_rel"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x1</span></span> <span class="skolem"><span class="skolem">x2</span></span> <span class="skolem"><span class="skolem">x3</span></span> <span class="skolem"><span class="skolem">x4</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span><span class="skolem">x4</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x1</span><span class="main">,</span><span class="skolem">x2</span><span class="main">)</span> <span class="main">∈</span> hull_rel"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x2</span><span class="main">,</span><span class="skolem">x3</span><span class="main">)</span> <span class="main">∈</span> Tree_wf"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x3</span><span class="main">,</span><span class="skolem">x4</span><span class="main">)</span> <span class="main">∈</span> alpha_Tree_rel"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x1</span><span class="main">,</span><span class="skolem">x4</span><span class="main">)</span> <span class="main">∈</span> alpha_Tree_rel <span class="keyword1">O</span> hull_rel <span class="keyword1">O</span> Tree_wf"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> 3 <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Tree_wf.induct<span class="main">)</span>
        <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> tConj<span class="antiquote">}</span></span>›</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">tset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span><span class="main">,</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> Tree <span class="keyword1">set[</span><span class="tfree">'d</span><span class="main">]</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> set_bset <span class="skolem">tset</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x1</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> hull_rel"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ***<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>tConj <span class="skolem">tset</span><span class="main">,</span> <span class="skolem">x4</span><span class="main">)</span> <span class="main">∈</span> alpha_Tree_rel"</span></span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"**"</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> x1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> hull_rel.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"***"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tConj <span class="skolem">tset</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">x4</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> alpha_Tree_relE<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tset'</span></span> <span class="keyword2"><span class="keyword">where</span></span> x4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x4</span> <span class="main">=</span> tConj <span class="skolem">tset'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rel_bset <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="skolem">tset</span> <span class="skolem">tset'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x4</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"*"</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">∈</span> set_bset <span class="skolem">tset'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rel_bset.rep_eq rel_set_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> x1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">∈</span> alpha_Tree_rel"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff alpha_Tree_relI permute_Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">t'</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">∈</span> hull_rel"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hull_rel.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> x4 <span class="keyword2"><span class="keyword">and</span></span> t' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t'</span><span class="main">,</span> <span class="skolem">x4</span><span class="main">)</span> <span class="main">∈</span> Tree_wf"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Tree_wf.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x1</span><span class="main">,</span><span class="skolem">x4</span><span class="main">)</span> <span class="main">∈</span> alpha_Tree_rel <span class="keyword1">O</span> hull_rel <span class="keyword1">O</span> Tree_wf"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> tNot<span class="antiquote">}</span></span>›</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
        <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x1</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> hull_rel"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>tNot <span class="skolem">t</span><span class="main">,</span> <span class="skolem">x4</span><span class="main">)</span> <span class="main">∈</span> alpha_Tree_rel"</span></span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"*"</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> x1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> hull_rel.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"**"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tNot <span class="skolem">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">x4</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> alpha_Tree_relE<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> x4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x4</span> <span class="main">=</span> tNot <span class="skolem">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x4</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command">with</span></span> x1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">∈</span> alpha_Tree_rel"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff alpha_Tree_relI permute_Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq x1<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">t'</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">∈</span> hull_rel"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hull_rel.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> x4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t'</span><span class="main">,</span> <span class="skolem">x4</span><span class="main">)</span> <span class="main">∈</span> Tree_wf"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Tree_wf.intros<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x1</span><span class="main">,</span><span class="skolem">x4</span><span class="main">)</span> <span class="main">∈</span> alpha_Tree_rel <span class="keyword1">O</span> hull_rel <span class="keyword1">O</span> Tree_wf"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> tAct<span class="antiquote">}</span></span>›</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">α</span> <span class="skolem">t</span>
        <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x1</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> hull_rel"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>tAct <span class="skolem">α</span> <span class="skolem">t</span><span class="main">,</span> <span class="skolem">x4</span><span class="main">)</span> <span class="main">∈</span> alpha_Tree_rel"</span></span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"*"</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> x1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> hull_rel.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"**"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tAct <span class="skolem">α</span> <span class="skolem">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">x4</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> alpha_Tree_relE<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> x4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x4</span> <span class="main">=</span> tAct <span class="main">(</span><span class="skolem">q</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∙</span> <span class="skolem">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x4</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> x1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="main">-</span><span class="skolem">q</span> <span class="main">∙</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">∈</span> alpha_Tree_rel"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff alpha_Tree_relI permute_Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="main">-</span><span class="skolem">q</span> <span class="main">∙</span> <span class="skolem">t'</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">∈</span> hull_rel"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hull_rel.simps permute_plus<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> x4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t'</span><span class="main">,</span> <span class="skolem">x4</span><span class="main">)</span> <span class="main">∈</span> Tree_wf"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Tree_wf.intros<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x1</span><span class="main">,</span><span class="skolem">x4</span><span class="main">)</span> <span class="main">∈</span> alpha_Tree_rel <span class="keyword1">O</span> hull_rel <span class="keyword1">O</span> Tree_wf"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> x <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> alpha_Tree_rel <span class="keyword1">O</span> hull_rel <span class="keyword1">O</span> Tree_wf"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Validity-alpha_Tree_rel_relcomp_trivialI"><span class="command">lemma</span></span> alpha_Tree_rel_relcomp_trivialI <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> alpha_Tree_rel <span class="keyword1">O</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> alpha_Tree_rel_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff case_prodI mem_Collect_eq relcomp.relcompI<span class="main">)</span>

<span class="keyword1" id="Validity-alpha_Tree_rel_relcompI"><span class="command">lemma</span></span> alpha_Tree_rel_relcompI <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x'</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> alpha_Tree_rel <span class="keyword1">O</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> alpha_Tree_rel_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> case_prodI mem_Collect_eq relcomp.relcompI<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Validity for infinitely branching trees›</span></span>

<span class="keyword1"><span class="command">context</span></span> nominal_ts
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Since we defined formulas via a manual quotient construction, we also need to define
  validity via lifting from the underlying type of infinitely branching trees. We cannot use
  {\bf nominal\_function} because that generates proof obligations where, for formulas of the
  form~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Conj <span class="free"><span class="free">xset</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the assumption that~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xset</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> has finite support is missing.›</span></span>

  <span class="keyword1"><span class="command">declare</span></span> conj_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span>

  <span class="keyword1"><span class="command">function</span></span> <span class="entity">valid_Tree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">)</span> Tree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">valid_Tree</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>tConj <span class="free"><span class="bound"><span class="entity">tset</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>set_bset <span class="free"><span class="bound"><span class="entity">tset</span></span></span><span class="main">.</span> <span class="free">valid_Tree</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">valid_Tree</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>tNot <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">¬</span> <span class="free">valid_Tree</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">valid_Tree</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>tPred <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">valid_Tree</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>tAct <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">α'</span> <span class="bound">t'</span> <span class="bound">P'</span><span class="main">.</span> tAct <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="bound">α'</span> <span class="bound">t'</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α'</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="free">valid_Tree</span> <span class="bound">P'</span> <span class="bound">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inv_image <span class="main">(</span>alpha_Tree_rel <span class="keyword1">O</span> hull_rel <span class="keyword1">O</span> Tree_wf<span class="main">)</span> snd"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf <span class="var">?R</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wf_alpha_Tree_rel_hull_rel_Tree_wf wf_inv_image<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'state</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">tset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">)</span> Tree <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">t</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> set_bset <span class="skolem">tset</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">P</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">P</span><span class="main">,</span> tConj <span class="skolem">tset</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Tree_wf.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'state</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">)</span> Tree"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">P</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">P</span><span class="main">,</span> tNot <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Tree_wf.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P1</span> <span class="skolem">P2</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'state</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">α1</span> <span class="skolem">α2</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'act</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">)</span> Tree"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"tAct <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="skolem">α2</span> <span class="skolem">t2</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">t1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alphas<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> alpha_Tree_symp sympE<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">P2</span><span class="main">,</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">P1</span><span class="main">,</span> tAct <span class="skolem">α1</span> <span class="skolem">t1</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Tree_wf.intros<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> valid_Tree<span class="antiquote"><span class="antiquote">}</span></span></span></span> is equivariant.›</span></span>

  <span class="keyword1" id="Validity-valid_Tree_eqvt'"><span class="command">lemma</span></span> valid_Tree_eqvt'<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_Tree <span class="free">P</span> <span class="free">t</span> <span class="main">⟷</span> valid_Tree <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> valid_Tree.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">P</span> <span class="skolem">tset</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_Tree <span class="skolem">P</span> <span class="main">(</span>tConj <span class="skolem">tset</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="free">p</span> <span class="main">∙</span> set_bset <span class="skolem">tset</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"1.IH"</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"*"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_Tree <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> imageE permute_set_eq_image valid_Tree.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"valid_Tree <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> tConj <span class="skolem">tset</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_Tree <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> tConj <span class="skolem">tset</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> set_bset <span class="skolem">tset</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"1.IH"</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"*"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_Tree <span class="skolem">P</span> <span class="skolem">t</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_permute_iff permute_Tree_tConj set_bset_eqvt valid_Tree.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"valid_Tree <span class="skolem">P</span> <span class="main">(</span>tConj <span class="skolem">tset</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> satisfies_eqvt<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">P</span> <span class="skolem">α</span> <span class="skolem">t</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"valid_Tree <span class="skolem">P</span> <span class="main">(</span>tAct <span class="skolem">α</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"tAct <span class="skolem">α</span> <span class="skolem">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="skolem">α'</span> <span class="skolem">t'</span> <span class="main">∧</span> <span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span> <span class="main">∧</span> valid_Tree <span class="skolem">P'</span> <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"4.IH"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_Tree <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"*"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α'</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> transition_eqvt'<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"*"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> tAct <span class="skolem">α</span> <span class="skolem">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α'</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_Tree_eqvt permute_Tree.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"valid_Tree <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> tAct <span class="skolem">α</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"valid_Tree <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> tAct <span class="skolem">α</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> tAct <span class="skolem">α</span> <span class="skolem">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="skolem">α'</span> <span class="skolem">t'</span> <span class="main">∧</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P</span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span> <span class="main">∧</span> valid_Tree <span class="skolem">P'</span> <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"tAct <span class="skolem">α</span> <span class="skolem">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α'</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_Tree_eqvt permute_Tree.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"*"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α'</span><span class="main">,</span> <span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> transition_eqvt'<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> <span class="quoted">"4.IH"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_Tree <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"*"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"valid_Tree <span class="skolem">P</span> <span class="main">(</span>tAct <span class="skolem">α</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Validity-valid_Tree_eqvt"><span class="command">lemma</span></span> valid_Tree_eqvt <span class="comment1">(*[eqvt]*)</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_Tree <span class="free">P</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_Tree <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> valid_Tree_eqvt'<span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹$\alpha$-equivalent trees validate the same states.›</span></span>

  <span class="keyword1" id="Validity-alpha_Tree_valid_Tree"><span class="command">lemma</span></span> alpha_Tree_valid_Tree<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t2</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_Tree <span class="free">P</span> <span class="free">t1</span> <span class="main">⟷</span> valid_Tree <span class="free">P</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alpha_Tree_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> tConj <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> rel_bset.rep_eq rel_set_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tAct <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="skolem">α2</span> <span class="skolem">t2</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"valid_Tree <span class="skolem">P</span> <span class="main">(</span>tAct <span class="skolem">α1</span> <span class="skolem">t1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"tAct <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="skolem">α'</span> <span class="skolem">t'</span> <span class="main">∧</span> <span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span> <span class="main">∧</span> valid_Tree <span class="skolem">P'</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> tAct.hyps <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tAct <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="skolem">α2</span> <span class="skolem">t2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> alpha_tAct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"valid_Tree <span class="skolem">P</span> <span class="main">(</span>tAct <span class="skolem">α2</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff valid_Tree.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"valid_Tree <span class="skolem">P</span> <span class="main">(</span>tAct <span class="skolem">α2</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"tAct <span class="skolem">α2</span> <span class="skolem">t2</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="skolem">α'</span> <span class="skolem">t'</span> <span class="main">∧</span> <span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span> <span class="main">∧</span> valid_Tree <span class="skolem">P'</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> tAct.hyps <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tAct <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="skolem">α2</span> <span class="skolem">t2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> alpha_tAct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"valid_Tree <span class="skolem">P</span> <span class="main">(</span>tAct <span class="skolem">α1</span> <span class="skolem">t1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff valid_Tree.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>


  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Validity for trees modulo \texorpdfstring{$\alpha$}{alpha}-equivalence›</span></span>

  <span class="keyword1"><span class="command">lift_definition</span></span> valid_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
    <span class="quoted">valid_Tree</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> alpha_Tree_valid_Tree<span class="main">)</span>

  <span class="keyword1" id="Validity-valid_Tree"><span class="command">lemma</span></span> valid_Tree<span class="hidden">⇩</span><sub>α</sub>_eqvt <span class="comment1">(*[eqvt]*)</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">P</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">fact</span> valid_Tree_eqvt<span class="main">)</span>

  <span class="keyword1" id="Validity-valid_Tree"><span class="command">lemma</span></span> valid_Tree<span class="hidden">⇩</span><sub>α</sub>_Conj<span class="hidden">⇩</span><sub>α</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"valid_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">P</span> <span class="main">(</span>Conj<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">∈</span>set_bset <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">.</span> valid_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">P</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_Tree <span class="free">P</span> <span class="main">(</span>rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>abs_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>tConj <span class="main">(</span>map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> valid_Tree <span class="free">P</span> <span class="main">(</span>tConj <span class="main">(</span>map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree<span class="hidden">⇩</span><sub>α</sub>_rep_abs alpha_Tree_valid_Tree<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_Tree<span class="hidden">⇩</span><sub>α</sub>_def Conj<span class="hidden">⇩</span><sub>α</sub>_def map_bset.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Validity-valid_Tree"><span class="command">lemma</span></span> valid_Tree<span class="hidden">⇩</span><sub>α</sub>_Not<span class="hidden">⇩</span><sub>α</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"valid_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">P</span> <span class="main">(</span>Not<span class="hidden">⇩</span><sub>α</sub> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">¬</span> valid_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">P</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

  <span class="keyword1" id="Validity-valid_Tree"><span class="command">lemma</span></span> valid_Tree<span class="hidden">⇩</span><sub>α</sub>_Pred<span class="hidden">⇩</span><sub>α</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"valid_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">P</span> <span class="main">(</span>Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free">φ</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">P</span> <span class="main"><span class="free">⊢</span></span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

  <span class="keyword1" id="Validity-valid_Tree"><span class="command">lemma</span></span> valid_Tree<span class="hidden">⇩</span><sub>α</sub>_Act<span class="hidden">⇩</span><sub>α</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"valid_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">P</span> <span class="main">(</span>Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">α</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">α'</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub>'</span> <span class="bound">P'</span><span class="main">.</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">α</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="bound">α'</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub>'</span> <span class="main">∧</span> <span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α'</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">∧</span> valid_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="bound">P'</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub>'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"valid_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">P</span> <span class="main">(</span>Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">α</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">α</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> abs_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>tAct <span class="free">α</span> <span class="main">(</span>rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act<span class="hidden">⇩</span><sub>α</sub>.abs_eq Tree<span class="hidden">⇩</span><sub>α</sub>_abs_rep<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">α'</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub>'</span> <span class="bound">P'</span><span class="main">.</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">α</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="bound">α'</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub>'</span> <span class="main">∧</span> <span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α'</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">∧</span> valid_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="bound">P'</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act<span class="hidden">⇩</span><sub>α</sub>.abs_eq Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff valid_Tree.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> valid_Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">α'</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub>'</span> <span class="bound">P'</span><span class="main">.</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">α</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="bound">α'</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub>'</span> <span class="main">∧</span> <span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α'</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">∧</span> valid_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="bound">P'</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">α'</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub>'</span><span class="main">.</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="bound">α'</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub>'</span> <span class="main">=</span> abs_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>tAct <span class="bound">α'</span> <span class="main">(</span>rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub>'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act<span class="hidden">⇩</span><sub>α</sub>.abs_eq Tree<span class="hidden">⇩</span><sub>α</sub>_abs_rep<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"valid_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">P</span> <span class="main">(</span>Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">α</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff valid_Tree.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> valid_Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq valid_Tree<span class="hidden">⇩</span><sub>α</sub>.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>


  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Validity for infinitary formulas›</span></span>

  <span class="keyword1"><span class="command">lift_definition</span></span> valid <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">)</span> formula <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊨</span>"</span> 70<span class="main">)</span> <span class="keyword2"><span class="keyword">is</span></span>
    <span class="quoted">valid_Tree<span class="hidden">⇩</span><sub>α</sub></span>
  <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1" id="Validity-valid_eqvt"><span class="command">lemma</span></span> valid_eqvt <span class="comment1">(*[eqvt]*)</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">⊨</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">metis</span> valid_Tree<span class="hidden">⇩</span><sub>α</sub>_eqvt<span class="main">)</span>

  <span class="keyword1" id="Validity-valid_Conj"><span class="command">lemma</span></span> valid_Conj <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Conj <span class="free">xset</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set_bset <span class="free">xset</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊨</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_def Conj_def map_bset.rep_eq<span class="main">)</span>

  <span class="keyword1" id="Validity-valid_Not"><span class="command">lemma</span></span> valid_Not <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Not <span class="free">x</span> <span class="main">⟷</span> <span class="main">¬</span> <span class="free">P</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

  <span class="keyword1" id="Validity-valid_Pred"><span class="command">lemma</span></span> valid_Pred <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Pred <span class="free">φ</span> <span class="main">⟷</span> <span class="free">P</span> <span class="main"><span class="free">⊢</span></span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

  <span class="keyword1" id="Validity-valid_Act"><span class="command">lemma</span></span> valid_Act<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Act <span class="free">α</span> <span class="free">x</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">α'</span> <span class="bound">x'</span> <span class="bound">P'</span><span class="main">.</span> Act <span class="free">α</span> <span class="free">x</span> <span class="main">=</span> Act <span class="bound">α'</span> <span class="bound">x'</span> <span class="main">∧</span> <span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α'</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊨</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Act <span class="free">α</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Rep_formula <span class="main">(</span>Abs_formula <span class="main">(</span>Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">α</span> <span class="main">(</span>Rep_formula <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">α</span> <span class="main">(</span>Rep_formula <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act.rep_eq Rep_formula_inverse<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">α'</span> <span class="bound">x'</span> <span class="bound">P'</span><span class="main">.</span> Act <span class="free">α</span> <span class="free">x</span> <span class="main">=</span> Act <span class="bound">α'</span> <span class="bound">x'</span> <span class="main">∧</span> <span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α'</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊨</span> <span class="bound">x'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_def Act_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Abs_formula_inverse Rep_formula' hereditarily_fs_alpha_renaming<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">α'</span> <span class="bound">x'</span> <span class="bound">P'</span><span class="main">.</span> Act <span class="free">α</span> <span class="free">x</span> <span class="main">=</span> Act <span class="bound">α'</span> <span class="bound">x'</span> <span class="main">∧</span> <span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α'</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊨</span> <span class="bound">x'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Act <span class="free">α</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act.rep_eq valid.rep_eq valid_Tree<span class="hidden">⇩</span><sub>α</sub>_Act<span class="hidden">⇩</span><sub>α</sub><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The binding names in the alpha-variant that witnesses validity may be chosen fresh for any
  finitely supported context.›</span></span>

  <span class="keyword1" id="Validity-valid_Act_strong"><span class="command">lemma</span></span> valid_Act_strong<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Act <span class="free">α</span> <span class="free">x</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">α'</span> <span class="bound">x'</span> <span class="bound">P'</span><span class="main">.</span> Act <span class="free">α</span> <span class="free">x</span> <span class="main">=</span> Act <span class="bound">α'</span> <span class="bound">x'</span> <span class="main">∧</span> <span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α'</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊨</span> <span class="bound">x'</span> <span class="main">∧</span> bn <span class="bound">α'</span> <span class="main">♯*</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Act <span class="free">α</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Act <span class="free">α</span> <span class="free">x</span> <span class="main">=</span> Act <span class="skolem">α'</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> <span class="skolem">x'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> valid_Act<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>bn <span class="skolem">α'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> bn_finite<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>supp <span class="free">X</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>Act <span class="skolem">α'</span> <span class="skolem">x'</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_Diff finite_UnI finite_supp supp_Pair supp_abs_residual_pair<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α'</span> <span class="main">♯*</span> <span class="main">(</span>Act <span class="skolem">α'</span> <span class="skolem">x'</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_def supp_Pair supp_abs_residual_pair<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> fresh_X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> bn <span class="skolem">α'</span><span class="main">)</span> <span class="main">♯*</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Act <span class="skolem">α'</span> <span class="skolem">x'</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> at_set_avoiding2<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Act <span class="skolem">α'</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_star_Un supp_Pair<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Act <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">=</span> Act <span class="skolem">α'</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α'</span><span class="main">,</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act_eqvt supp_perm_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> abs_residual_pair_eqvt supp_perm_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">α'</span> <span class="bound">x'</span> <span class="bound">P'</span><span class="main">.</span> Act <span class="free">α</span> <span class="free">x</span> <span class="main">=</span> Act <span class="bound">α'</span> <span class="bound">x'</span> <span class="main">∧</span> <span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α'</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊨</span> <span class="bound">x'</span> <span class="main">∧</span> bn <span class="bound">α'</span> <span class="main">♯*</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword2"><span class="keyword">and</span></span> trans <span class="keyword2"><span class="keyword">and</span></span> valid <span class="keyword2"><span class="keyword">and</span></span> fresh_X <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bn_eqvt valid_eqvt<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">α'</span> <span class="bound">x'</span> <span class="bound">P'</span><span class="main">.</span> Act <span class="free">α</span> <span class="free">x</span> <span class="main">=</span> Act <span class="bound">α'</span> <span class="bound">x'</span> <span class="main">∧</span> <span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α'</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊨</span> <span class="bound">x'</span> <span class="main">∧</span> bn <span class="bound">α'</span> <span class="main">♯*</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Act <span class="free">α</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> valid_Act<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Validity-valid_Act_fresh"><span class="command">lemma</span></span> valid_Act_fresh<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bn <span class="free">α</span> <span class="main">♯*</span> <span class="free">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Act <span class="free">α</span> <span class="free">x</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> <span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">α</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊨</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Act <span class="free">α</span> <span class="free">x</span>"</span></span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> finite_supp<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Act <span class="free">α</span> <span class="free">x</span> <span class="main">=</span> Act <span class="skolem">α'</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α'</span> <span class="main">♯*</span> <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> valid_Act_strong<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p_α<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">α'</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">α</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> supp_p<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="skolem">p</span> <span class="main">⊆</span> bn <span class="free">α</span> <span class="main">∪</span> <span class="skolem">p</span> <span class="main">∙</span> bn <span class="free">α</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act_eq_iff_perm_renaming<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> fresh <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="free">α</span> <span class="main">∪</span> <span class="skolem">p</span> <span class="main">∙</span> bn <span class="free">α</span><span class="main">)</span> <span class="main">♯*</span> <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p_α <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bn_eqvt fresh_star_Un<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="skolem">p</span> <span class="main">♯*</span> <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> supp_p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_star_def subset_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> p_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">P</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> perm_supp_eq supp_minus_perm<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> trans <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">α</span><span class="main">,</span><span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p_P p_α <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> transition_eqvt'<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> valid <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p_x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> valid_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> <span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">α</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> <span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">α</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Act <span class="free">α</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> valid_Act<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Logical_Equivalence">
<div class="head">
<h1>Theory Logical_Equivalence</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Logical_Equivalence
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Validity">Validity</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹(Strong) Logical Equivalence›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The definition of formulas is parametric in the index type, but from now on we want to work
with a fixed (sufficiently large) index type.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> indexed_nominal_ts <span class="main">=</span> nominal_ts <span class="quoted"><span class="free">satisfies</span></span> <span class="quoted"><span class="free">transition</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">satisfies</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span><span class="main">::</span>fs <span class="main">⇒</span> <span class="tfree">'pred</span><span class="main">::</span>fs <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊢</span>"</span> 70<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">transition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">,</span><span class="tfree">'state</span><span class="main">)</span> residual <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">→</span>"</span> 70<span class="main">)</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> card_idx_perm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV<span class="main">::</span>perm set<span class="main">|</span> <span class="keyword1">&lt;o</span> <span class="main">|</span>UNIV<span class="main">::</span><span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> card_idx_state<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV<span class="main">::</span><span class="tfree">'state</span> set<span class="main">|</span> <span class="keyword1">&lt;o</span> <span class="main">|</span>UNIV<span class="main">::</span><span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">logically_equivalent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">logically_equivalent</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">::</span><span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">)</span> formula<span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊨</span> <span class="bound">x</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">⊨</span> <span class="bound">x</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">notation</span></span> logically_equivalent <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">=⋅</span>"</span> 50<span class="main">)</span>

  <span class="keyword1" id="Logical_Equivalence-logically_equivalent_eqvt"><span class="command">lemma</span></span> logically_equivalent_eqvt<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=⋅</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="free">P</span> <span class="main">=⋅</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> logically_equivalent_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> valid_eqvt<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Bisimilarity_Implies_Equivalence">
<div class="head">
<h1>Theory Bisimilarity_Implies_Equivalence</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Bisimilarity_Implies_Equivalence
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Logical_Equivalence">Logical_Equivalence</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Bisimilarity Implies Logical Equivalence›</span></span>

<span class="keyword1"><span class="command">context</span></span> indexed_nominal_ts
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Bisimilarity_Implies_Equivalence-bisimilarity_implies_equivalence_Act"><span class="command">lemma</span></span> bisimilarity_implies_equivalence_Act<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∼⋅</span> <span class="bound">Q</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="main">⊨</span> <span class="free">x</span> <span class="main">⟷</span> <span class="bound">Q</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∼⋅</span> <span class="free">Q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Act <span class="free">α</span> <span class="free">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⊨</span> Act <span class="free">α</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> finite_supp<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">⊨</span> Act <span class="free">α</span> <span class="free">x</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Act <span class="free">α</span> <span class="free">x</span> <span class="main">=</span> Act <span class="skolem">α'</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α'</span> <span class="main">♯*</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> valid_Act_strong<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">∼⋅</span> <span class="free">Q</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh <span class="keyword2"><span class="keyword">and</span></span> trans <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> trans'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">Q'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bisim'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">∼⋅</span> <span class="skolem">Q'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bisimilar_simulation_step<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> px<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act_eq_iff_perm<span class="main">)</span>

    <span class="keyword1"><span class="command">with</span></span> valid <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> valid_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> bisim' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">)</span> <span class="main">∼⋅</span> <span class="main">(</span><span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">Q'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bisimilar_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">Q'</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∼⋅</span> <span class="bound">Q</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="main">⊨</span> <span class="free">x</span> <span class="main">⟷</span> <span class="bound">Q</span> <span class="main">⊨</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">with</span></span> px <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">⊨</span> <span class="skolem">x'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> valid_eqvt<span class="main">)</span>

    <span class="keyword1"><span class="command">with</span></span> eq <span class="keyword2"><span class="keyword">and</span></span> trans' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⊨</span> Act <span class="free">α</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> valid_Act <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">theorem</span></span> bisimilarity_implies_equivalence<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∼⋅</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=⋅</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> logically_equivalent_def <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">)</span> formula"</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> <span class="skolem">x</span> <span class="main">⟷</span> <span class="free">Q</span> <span class="main">⊨</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">Q</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Conj <span class="skolem">xset</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Not <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Pred <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bisimilar_is_bisimulation is_bisimulation_def symp_def valid_Pred<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Act <span class="skolem">α</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bisimilar_symp bisimilarity_implies_equivalence_Act sympE<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Equivalence_Implies_Bisimilarity">
<div class="head">
<h1>Theory Equivalence_Implies_Bisimilarity</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Equivalence_Implies_Bisimilarity
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Logical_Equivalence">Logical_Equivalence</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Logical Equivalence Implies Bisimilarity›</span></span>

<span class="keyword1"><span class="command">context</span></span> indexed_nominal_ts
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_distinguishing_formula</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">)</span> formula <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
    <span class="main">(</span><span class="quoted">"_ <span class="keyword1">distinguishes</span> _ <span class="keyword1">from</span> _"</span> <span class="main">[</span>100<span class="main">,</span>100<span class="main">,</span>100<span class="main">]</span> 100<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">distinguishes</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1"><span class="free">from</span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊨</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">⊨</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

  <span class="keyword1" id="Equivalence_Implies_Bisimilarity-is_distinguishing_formula_eqvt"><span class="command">lemma</span></span> is_distinguishing_formula_eqvt <span class="comment1">(*[eqvt]*)</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">distinguishes</span> <span class="free">P</span> <span class="keyword1">from</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">distinguishes</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">from</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_distinguishing_formula_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> valid_eqvt<span class="main">)</span>

  <span class="keyword1" id="Equivalence_Implies_Bisimilarity-equivalent_iff_not_distinguished"><span class="command">lemma</span></span> equivalent_iff_not_distinguished<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">=⋅</span> <span class="free">Q</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">distinguishes</span> <span class="free">P</span> <span class="keyword1">from</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> is_distinguishing_formula_def logically_equivalent_def valid_Not<span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There exists a distinguishing formula for~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> whose support is contained
  in~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"supp <span class="free"><span class="free">P</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

  <span class="keyword1" id="Equivalence_Implies_Bisimilarity-distinguished_bounded_support"><span class="command">lemma</span></span> distinguished_bounded_support<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">distinguishes</span> <span class="free">P</span> <span class="keyword1">from</span> <span class="free">Q</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"supp <span class="free">y</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="keyword1">distinguishes</span> <span class="free">P</span> <span class="keyword1">from</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">|</span><span class="bound">p</span><span class="main">.</span> supp <span class="free">P</span> <span class="main">♯*</span> <span class="bound">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="free">P</span> <span class="keyword1">supports</span> <span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> supports_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
      <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> supp <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> supp <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?B</span> <span class="main">⊆</span> <span class="var">?B</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="free">P</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_set_def<span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="var">?q</span> <span class="main">∙</span> <span class="free">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> a <span class="keyword2"><span class="keyword">and</span></span> b <span class="keyword2"><span class="keyword">and</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="free">P</span> <span class="main">♯*</span> <span class="var">?q</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_perm fresh_star_def fresh_star_plus swap_atom_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">⊆</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?B</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="free">P</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?q</span> <span class="main">∙</span> <span class="free">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> a <span class="keyword2"><span class="keyword">and</span></span> b <span class="keyword2"><span class="keyword">and</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="free">P</span> <span class="main">♯*</span> <span class="var">?q</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_perm fresh_star_def fresh_star_plus swap_atom_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?B</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> mem_permute_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?B</span> <span class="main">=</span> <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> supp_B_subset_supp_P<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="var">?B</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> finite_supp supp_is_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> finite_supp_B<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="var">?B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_supp rev_finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="main">`</span> UNIV"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?B</span><span class="main">|</span> <span class="keyword1">≤o</span> <span class="main">|</span>UNIV <span class="main">::</span> perm set<span class="main">|</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> surj_imp_ordLeq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV <span class="main">::</span> perm set<span class="main">|</span> <span class="keyword1">&lt;o</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_idx_perm<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span> <span class="keyword1">≤o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cnotzero_UNIV ordLeq_csum2<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> card_B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?B</span><span class="main">|</span> <span class="keyword1">&lt;o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Conj <span class="main">(</span>Abs_bset <span class="var">?B</span><span class="main">)</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">)</span> formula"</span></span>
    <span class="keyword1"><span class="command">from</span></span> finite_supp_B <span class="keyword2"><span class="keyword">and</span></span> card_B <span class="keyword2"><span class="keyword">and</span></span> supp_B_subset_supp_P <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="var">?y</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="keyword1">distinguishes</span> <span class="free">P</span> <span class="keyword1">from</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_distinguishing_formula_def <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> <span class="var">?y</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_B finite_supp_B<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> is_distinguishing_formula_def supp_perm_eq valid_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">Q</span> <span class="main">⊨</span> <span class="var">?y</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_B finite_supp_B<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> is_distinguishing_formula_def permute_zero fresh_star_zero<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Equivalence_Implies_Bisimilarity-equivalence_is_bisimulation"><span class="command">lemma</span></span> equivalence_is_bisimulation<span class="main">:</span> <span class="quoted"><span class="quoted">"is_bisimulation logically_equivalent"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"symp logically_equivalent"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> logically_equivalent_def sympI<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">φ</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=⋅</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span> <span class="main">⟶</span> <span class="skolem">Q</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> logically_equivalent_def valid_Pred<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">α</span> <span class="skolem">P'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=⋅</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="bound">Q'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="skolem">P'</span> <span class="main">=⋅</span> <span class="bound">Q'</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">Q'</span><span class="main">.</span> <span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="bound">Q'</span><span class="main">⟩</span><span class="main">}</span>"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Q'</span><span class="main">∈</span><span class="var">?Q'</span><span class="main">.</span> <span class="main">¬</span> <span class="skolem">P'</span> <span class="main">=⋅</span> <span class="bound">Q'</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Q'</span><span class="main">∈</span><span class="var">?Q'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">)</span> formula<span class="main">.</span> <span class="bound">x</span> <span class="keyword1">distinguishes</span> <span class="skolem">P'</span> <span class="keyword1">from</span> <span class="bound">Q'</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> equivalent_iff_not_distinguished<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Q'</span><span class="main">∈</span><span class="var">?Q'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">)</span> formula<span class="main">.</span> supp <span class="bound">x</span> <span class="main">⊆</span> supp <span class="skolem">P'</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">distinguishes</span> <span class="skolem">P'</span> <span class="keyword1">from</span> <span class="bound">Q'</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distinguished_bounded_support<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">)</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
              *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Q'</span><span class="main">∈</span><span class="var">?Q'</span><span class="main">.</span> supp <span class="main">(</span><span class="skolem">f</span> <span class="bound">Q'</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="skolem">P'</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">Q'</span><span class="main">)</span> <span class="keyword1">distinguishes</span> <span class="skolem">P'</span> <span class="keyword1">from</span> <span class="bound">Q'</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="skolem">P'</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> set_bounded_supp<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> finite_supp<span class="main"><span class="keyword3">,</span></span> <span class="operator">cut_tac</span> <span class="quoted">"*"</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> finite_supp_image<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> finite_supp rev_finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="skolem">f</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">|</span> <span class="keyword1">≤o</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'state</span> set<span class="main">|</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_of_UNIV card_of_image ordLeq_transitive<span class="main">)</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'state</span> set<span class="main">|</span> <span class="keyword1">&lt;o</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_idx_state<span class="main">)</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span> <span class="keyword1">≤o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cnotzero_UNIV ordLeq_csum2<span class="main">)</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> card_image<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="skolem">f</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">|</span> <span class="keyword1">&lt;o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Conj <span class="main">(</span>Abs_bset <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">)</span><span class="main">)</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">)</span> formula"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊨</span> Act <span class="skolem">α</span> <span class="var">?y</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> valid_Act <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword1"><span class="command">{</span></span>
                  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q'</span>
                  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">Q'</span><span class="main">⟩</span>"</span></span>
                  <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"*"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> <span class="skolem">f</span> <span class="skolem">Q'</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_distinguishing_formula_def mem_Collect_eq<span class="main">)</span>
                <span class="keyword1"><span class="command">}</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> <span class="var">?y</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_supp_image card_image<span class="main">)</span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">Q</span> <span class="main">⊨</span> Act <span class="skolem">α</span> <span class="var">?y</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⊨</span> Act <span class="skolem">α</span> <span class="var">?y</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">Q'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">⊨</span> <span class="var">?y</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="skolem">Q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> valid_Act_fresh<span class="main">)</span>
                <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Q''</span><span class="main">.</span> <span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="bound">Q''</span><span class="main">⟩</span> <span class="main">⟶</span> <span class="skolem">Q'</span> <span class="main">⊨</span> <span class="skolem">f</span> <span class="bound">Q''</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_supp_image card_image<span class="main">)</span>
                <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"*"</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
                  <span class="keyword1"><span class="command">using</span></span> is_distinguishing_formula_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">=⋅</span> <span class="skolem">Q</span>›</span></span> logically_equivalent_def<span class="main">)</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_bisimulation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">theorem</span></span> equivalence_implies_bisimilarity<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=⋅</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∼⋅</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bisimilar_def equivalence_is_bisimulation<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Disjunction">
<div class="head">
<h1>Theory Disjunction</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Disjunction
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Formula">Formula</a>
  <a href="#Validity">Validity</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Disjunction›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Disj</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>fs<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">)</span> formula <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">)</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Disj</span> <span class="free"><span class="bound"><span class="entity">xset</span></span></span> <span class="main">=</span> Not <span class="main">(</span>Conj <span class="main">(</span>map_bset Not <span class="free"><span class="bound"><span class="entity">xset</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Disjunction-finite_supp_map_bset_Not"><span class="command">lemma</span></span> finite_supp_map_bset_Not <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>map_bset Not <span class="free">xset</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eqvt map_bset"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eqvt Not"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvtI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>map_bset Not<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> supp_fun_eqvt supp_fun_app_eqvt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>map_bset Not <span class="free">xset</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">xset</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> supp_fun_app <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>map_bset Not <span class="free">xset</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Disjunction-Disj_eqvt"><span class="command">lemma</span></span> Disj_eqvt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Disj <span class="free">xset</span> <span class="main">=</span> Disj <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">xset</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Disj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Disjunction-Disj_eq_iff"><span class="command">lemma</span></span> Disj_eq_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Disj <span class="free">xset1</span> <span class="main">=</span> Disj <span class="free">xset2</span> <span class="main">⟷</span> <span class="free">xset1</span> <span class="main">=</span> <span class="free">xset2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Disj_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Conj_eq_iff Not_eq_iff bset.inj_map_strong finite_supp_map_bset_Not<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> nominal_ts
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Disjunction-valid_Disj"><span class="command">lemma</span></span> valid_Disj <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Disj <span class="free">xset</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">∈</span>set_bset <span class="free">xset</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊨</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Disj_def map_bset.rep_eq<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Expressive_Completeness">
<div class="head">
<h1>Theory Expressive_Completeness</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Expressive_Completeness
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Bisimilarity_Implies_Equivalence">Bisimilarity_Implies_Equivalence</a>
  <a href="#Equivalence_Implies_Bisimilarity">Equivalence_Implies_Bisimilarity</a>
  <a href="#Disjunction">Disjunction</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Expressive Completeness›</span></span>

<span class="keyword1"><span class="command">context</span></span> indexed_nominal_ts
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Distinguishing formulas›</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lemma \emph{distinguished\_bounded\_support} only shows the existence of a distinguishing
    formula, without stating what this formula looks like. We now define an explicit function that
    returns a distinguishing formula, in a way that this function is equivariant (on pairs of
    non-equivalent states).

    Note that this definition uses Hilbert's choice operator~$\varepsilon$, which is not necessarily
    equivariant. This is immediately remedied by a hull construction.›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">distinguishing_formula</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">)</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">distinguishing_formula</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> Conj <span class="main">(</span>Abs_bset <span class="main">{</span><span class="main">-</span><span class="bound">p</span> <span class="main">∙</span> <span class="main">(</span><span class="main">ϵ</span><span class="bound">x</span><span class="main">.</span> supp <span class="bound">x</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">distinguishes</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="keyword1">from</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">p</span><span class="main">.</span> True<span class="main">}</span><span class="main">)</span>"</span></span>

  <span class="comment1">― ‹just an auxiliary lemma that will be useful further below›</span>
  <span class="keyword1" id="Expressive_Completeness-distinguishing_formula_card_aux"><span class="command">lemma</span></span> distinguishing_formula_card_aux<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="main">{</span><span class="main">-</span><span class="bound">p</span> <span class="main">∙</span> <span class="main">(</span><span class="main">ϵ</span><span class="bound">x</span><span class="main">.</span> supp <span class="bound">x</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">distinguishes</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">from</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">p</span><span class="main">.</span> True<span class="main">}</span><span class="main">|</span> <span class="keyword1">&lt;o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?some</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="main">ϵ</span><span class="bound">x</span><span class="main">.</span> supp <span class="bound">x</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">distinguishes</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">from</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">-</span><span class="bound">p</span> <span class="main">∙</span> <span class="var">?some</span> <span class="bound">p</span><span class="main">|</span><span class="bound">p</span><span class="main">.</span> True<span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">-</span><span class="bound">p</span> <span class="main">∙</span> <span class="var">?some</span> <span class="bound">p</span><span class="main">)</span> <span class="main">`</span> UNIV"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?B</span><span class="main">|</span> <span class="keyword1">≤o</span> <span class="main">|</span>UNIV <span class="main">::</span> perm set<span class="main">|</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> surj_imp_ordLeq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV <span class="main">::</span> perm set<span class="main">|</span> <span class="keyword1">&lt;o</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_idx_perm<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span> <span class="keyword1">≤o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cnotzero_UNIV ordLeq_csum2<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">― ‹just an auxiliary lemma that will be useful further below›</span>
  <span class="keyword1" id="Expressive_Completeness-distinguishing_formula_supp_aux"><span class="command">lemma</span></span> distinguishing_formula_supp_aux<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="main">=⋅</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Abs_bset <span class="main">{</span><span class="main">-</span><span class="bound">p</span> <span class="main">∙</span> <span class="main">(</span><span class="main">ϵ</span><span class="bound">x</span><span class="main">.</span> supp <span class="bound">x</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">distinguishes</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">from</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">p</span><span class="main">.</span> True<span class="main">}</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?some</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="main">ϵ</span><span class="bound">x</span><span class="main">.</span> supp <span class="bound">x</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">distinguishes</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">from</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">-</span><span class="bound">p</span> <span class="main">∙</span> <span class="var">?some</span> <span class="bound">p</span><span class="main">|</span><span class="bound">p</span><span class="main">.</span> True<span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">P</span> <span class="main">=⋅</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> logically_equivalent_eqvt permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="var">?some</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> distinguished_bounded_support <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> equivalent_iff_not_distinguished someI_ex<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> supp_some <span class="main">=</span> this

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="var">?some</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> supp_some <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="skolem">x</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> permute_boolE subset_eqvt supp_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> <span class="quoted">"*"</span> <span class="main">=</span> this
    <span class="keyword1"><span class="command">have</span></span> supp_B<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="var">?B</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> set_bounded_supp<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> finite_supp<span class="main"><span class="keyword3">,</span></span> <span class="operator">cut_tac</span> <span class="quoted">"*"</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> supp_B <span class="keyword2"><span class="keyword">and</span></span> distinguishing_formula_card_aux <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> supp_Abs_bset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Expressive_Completeness-distinguishing_formula_eqvt"><span class="command">lemma</span></span> distinguishing_formula_eqvt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="main">=⋅</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> distinguishing_formula <span class="free">P</span> <span class="free">Q</span> <span class="main">=</span> distinguishing_formula <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?some</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="main">ϵ</span><span class="bound">x</span><span class="main">.</span> supp <span class="bound">x</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">distinguishes</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">from</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">-</span><span class="bound">p</span> <span class="main">∙</span> <span class="var">?some</span> <span class="bound">p</span><span class="main">|</span><span class="bound">p</span><span class="main">.</span> True<span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> distinguishing_formula_supp_aux<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_supp rev_finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> distinguishing_formula_card_aux <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Conj <span class="main">(</span>Abs_bset <span class="var">?B</span><span class="main">)</span> <span class="main">=</span> Conj <span class="main">(</span>Abs_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="var">?B</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?some'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p'</span><span class="main">.</span> <span class="main">(</span><span class="main">ϵ</span><span class="bound">x</span><span class="main">.</span> supp <span class="bound">x</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="bound">p'</span> <span class="main">∙</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">distinguishes</span> <span class="main">(</span><span class="bound">p'</span> <span class="main">∙</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">from</span> <span class="main">(</span><span class="bound">p'</span> <span class="main">∙</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">-</span><span class="bound">p'</span> <span class="main">∙</span> <span class="var">?some'</span> <span class="bound">p'</span><span class="main">|</span><span class="bound">p'</span><span class="main">.</span> True<span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="var">?B</span> <span class="main">=</span> <span class="var">?B'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">px</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">px</span> <span class="main">∈</span> <span class="free">p</span> <span class="main">∙</span> <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">px</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> image_iff permute_set_eq_image<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">-</span><span class="skolem">p'</span> <span class="main">∙</span> <span class="var">?some</span> <span class="skolem">p'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">px</span> <span class="main">=</span> <span class="main">-</span><span class="main">(</span><span class="skolem">p'</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?some'</span> <span class="main">(</span><span class="skolem">p'</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">px</span> <span class="main">∈</span> <span class="var">?B'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="var">?B</span> <span class="main">⊆</span> <span class="var">?B'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?B'</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">-</span><span class="skolem">p'</span> <span class="main">∙</span> <span class="var">?some'</span> <span class="skolem">p'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∙</span> <span class="main">-</span><span class="main">(</span><span class="skolem">p'</span> <span class="main">+</span> <span class="free">p</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?some</span> <span class="main">(</span><span class="skolem">p'</span> <span class="main">+</span> <span class="free">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.inverse_distrib_swap<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">p</span> <span class="main">∙</span> <span class="var">?B</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> mem_permute_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B'</span> <span class="main">⊆</span> <span class="free">p</span> <span class="main">∙</span> <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"*"</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> distinguishing_formula_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Expressive_Completeness-supp_distinguishing_formula"><span class="command">lemma</span></span> supp_distinguishing_formula<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="main">=⋅</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>distinguishing_formula <span class="free">P</span> <span class="free">Q</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?some</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="main">ϵ</span><span class="bound">x</span><span class="main">.</span> supp <span class="bound">x</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">distinguishes</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">from</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">-</span> <span class="bound">p</span> <span class="main">∙</span> <span class="var">?some</span> <span class="bound">p</span><span class="main">|</span><span class="bound">p</span><span class="main">.</span> True<span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> distinguishing_formula_supp_aux<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_supp rev_finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> distinguishing_formula_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Expressive_Completeness-distinguishing_formula_distinguishes"><span class="command">lemma</span></span> distinguishing_formula_distinguishes<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="main">=⋅</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>distinguishing_formula <span class="free">P</span> <span class="free">Q</span><span class="main">)</span> <span class="keyword1">distinguishes</span> <span class="free">P</span> <span class="keyword1">from</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?some</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="main">ϵ</span><span class="bound">x</span><span class="main">.</span> supp <span class="bound">x</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">distinguishes</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">from</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">-</span> <span class="bound">p</span> <span class="main">∙</span> <span class="var">?some</span> <span class="bound">p</span><span class="main">|</span><span class="bound">p</span><span class="main">.</span> True<span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?some</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">distinguishes</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">from</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> is_distinguishing_formula_eqvt distinguished_bounded_support equivalent_iff_not_distinguished someI_ex<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> some_distinguishes <span class="main">=</span> this

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P'</span>
      <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> distinguishing_formula_supp_aux<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> finite_supp rev_finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> distinguishing_formula_card_aux <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> distinguishing_formula <span class="free">P</span> <span class="free">Q</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="var">?B</span><span class="main">.</span> <span class="skolem">P'</span> <span class="main">⊨</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> distinguishing_formula_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> valid_distinguishing_formula <span class="main">=</span> this

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> <span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="var">?some</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> is_distinguishing_formula_def permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> some_distinguishes valid_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> distinguishing_formula <span class="free">P</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid_distinguishing_formula <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">Q</span> <span class="main">⊨</span> distinguishing_formula <span class="free">P</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid_distinguishing_formula <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> is_distinguishing_formula_def mem_Collect_eq permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> some_distinguishes valid_eqvt<span class="main">)</span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>distinguishing_formula <span class="free">P</span> <span class="free">Q</span><span class="main">)</span> <span class="keyword1">distinguishes</span> <span class="free">P</span> <span class="keyword1">from</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> is_distinguishing_formula_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>


  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Characteristic formulas›</span></span>
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A \emph{characteristic formula} for a state~$P$ is valid for (exactly) those states that are
    bisimilar to~$P$.›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">characteristic_formula</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">)</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">characteristic_formula</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> Conj <span class="main">(</span>Abs_bset <span class="main">{</span>distinguishing_formula <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">Q</span><span class="main">|</span><span class="bound">Q</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=⋅</span> <span class="bound">Q</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>

  <span class="comment1">― ‹just an auxiliary lemma that will be useful further below›</span>
  <span class="keyword1" id="Expressive_Completeness-characteristic_formula_card_aux"><span class="command">lemma</span></span> characteristic_formula_card_aux<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="main">{</span>distinguishing_formula <span class="free">P</span> <span class="bound">Q</span><span class="main">|</span><span class="bound">Q</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="main">=⋅</span> <span class="bound">Q</span><span class="main">)</span><span class="main">}</span><span class="main">|</span> <span class="keyword1">&lt;o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>distinguishing_formula <span class="free">P</span> <span class="bound">Q</span><span class="main">|</span><span class="bound">Q</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="main">=⋅</span> <span class="bound">Q</span><span class="main">)</span><span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">⊆</span> <span class="main">(</span>distinguishing_formula <span class="free">P</span><span class="main">)</span> <span class="main">`</span> UNIV"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?B</span><span class="main">|</span> <span class="keyword1">≤o</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'state</span> set<span class="main">|</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> surj_imp_ordLeq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'state</span> set<span class="main">|</span> <span class="keyword1">&lt;o</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_idx_state<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span> <span class="keyword1">≤o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cnotzero_UNIV ordLeq_csum2<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">― ‹just an auxiliary lemma that will be useful further below›</span>
  <span class="keyword1" id="Expressive_Completeness-characteristic_formula_supp_aux"><span class="command">lemma</span></span> characteristic_formula_supp_aux<span class="main">:</span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Abs_bset <span class="main">{</span>distinguishing_formula <span class="free">P</span> <span class="bound">Q</span><span class="main">|</span><span class="bound">Q</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="main">=⋅</span> <span class="bound">Q</span><span class="main">)</span><span class="main">}</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>distinguishing_formula <span class="free">P</span> <span class="bound">Q</span><span class="main">|</span><span class="bound">Q</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="main">=⋅</span> <span class="bound">Q</span><span class="main">)</span><span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> distinguishing_formula <span class="free">P</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="main">=⋅</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> supp_distinguishing_formula <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="skolem">x</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> <span class="quoted">"*"</span> <span class="main">=</span> this
    <span class="keyword1"><span class="command">have</span></span> supp_B<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="var">?B</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> set_bounded_supp<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> finite_supp<span class="main"><span class="keyword3">,</span></span> <span class="operator">cut_tac</span> <span class="quoted">"*"</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> supp_B <span class="keyword2"><span class="keyword">and</span></span> characteristic_formula_card_aux <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> supp_Abs_bset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Expressive_Completeness-characteristic_formula_eqvt"><span class="command">lemma</span></span> characteristic_formula_eqvt <span class="comment1">(*[eqvt]*)</span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> characteristic_formula <span class="free">P</span> <span class="main">=</span> characteristic_formula <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>distinguishing_formula <span class="free">P</span> <span class="bound">Q</span><span class="main">|</span><span class="bound">Q</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="main">=⋅</span> <span class="bound">Q</span><span class="main">)</span><span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> characteristic_formula_supp_aux<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_supp rev_finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> characteristic_formula_card_aux <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Conj <span class="main">(</span>Abs_bset <span class="var">?B</span><span class="main">)</span> <span class="main">=</span> Conj <span class="main">(</span>Abs_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="var">?B</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>distinguishing_formula <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="bound">Q</span><span class="main">|</span><span class="bound">Q</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">=⋅</span> <span class="bound">Q</span><span class="main">)</span><span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="var">?B</span> <span class="main">=</span> <span class="var">?B'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">px</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">px</span> <span class="main">∈</span> <span class="free">p</span> <span class="main">∙</span> <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">px</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> image_iff permute_set_eq_image<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> distinguishing_formula <span class="free">P</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="main">=⋅</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">px</span> <span class="main">=</span> distinguishing_formula <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">=⋅</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> logically_equivalent_eqvt permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">px</span> <span class="main">∈</span> <span class="var">?B'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="var">?B</span> <span class="main">⊆</span> <span class="var">?B'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?B'</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> distinguishing_formula <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">=⋅</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="main">=⋅</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> logically_equivalent_eqvt permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∙</span> distinguishing_formula <span class="free">P</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">p</span> <span class="main">∙</span> <span class="var">?B</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> mem_permute_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B'</span> <span class="main">⊆</span> <span class="free">p</span> <span class="main">∙</span> <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"*"</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> characteristic_formula_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Expressive_Completeness-characteristic_formula_eqvt_raw"><span class="command">lemma</span></span> characteristic_formula_eqvt_raw <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> characteristic_formula <span class="main">=</span> characteristic_formula"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_fun_def<span class="main">)</span>

  <span class="keyword1" id="Expressive_Completeness-characteristic_formula_is_characteristic'"><span class="command">lemma</span></span> characteristic_formula_is_characteristic'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⊨</span> characteristic_formula <span class="free">P</span> <span class="main">⟷</span> <span class="free">P</span> <span class="main">=⋅</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>distinguishing_formula <span class="free">P</span> <span class="bound">Q</span><span class="main">|</span><span class="bound">Q</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="main">=⋅</span> <span class="bound">Q</span><span class="main">)</span><span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P'</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> characteristic_formula_supp_aux<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> finite_supp rev_finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> characteristic_formula_card_aux <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> characteristic_formula <span class="free">P</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="var">?B</span><span class="main">.</span> <span class="skolem">P'</span> <span class="main">⊨</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> characteristic_formula_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> valid_characteristic_formula <span class="main">=</span> this

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⊨</span> characteristic_formula <span class="free">P</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=⋅</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="main">=⋅</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"*"</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> distinguishing_formula_distinguishes is_distinguishing_formula_def valid_characteristic_formula <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=⋅</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> characteristic_formula <span class="free">P</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> distinguishing_formula_distinguishes is_distinguishing_formula_def valid_characteristic_formula <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⊨</span> characteristic_formula <span class="free">P</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> logically_equivalent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Expressive_Completeness-characteristic_formula_is_characteristic"><span class="command">lemma</span></span> characteristic_formula_is_characteristic<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⊨</span> characteristic_formula <span class="free">P</span> <span class="main">⟷</span> <span class="free">P</span> <span class="main">∼⋅</span> <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> characteristic_formula_is_characteristic' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> bisimilarity_implies_equivalence equivalence_implies_bisimilarity<span class="main">)</span>


  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Expressive completeness›</span></span>
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Every finitely supported set of states that is closed under bisimulation can be described by
    a formula; namely, by a disjunction of characteristic formulas.›</span></span>

  <span class="keyword1"><span class="command">theorem</span></span> expressive_completeness<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="main">∼⋅</span> <span class="bound">Q</span> <span class="main">⟹</span> <span class="bound">Q</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Disj <span class="main">(</span>Abs_bset <span class="main">(</span>characteristic_formula <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">P</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"characteristic_formula <span class="main">`</span> <span class="free">S</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">⊆</span> characteristic_formula <span class="main">`</span> UNIV"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?B</span><span class="main">|</span> <span class="keyword1">≤o</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'state</span> set<span class="main">|</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> surj_imp_ordLeq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'state</span> set<span class="main">|</span> <span class="keyword1">&lt;o</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_idx_state<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span> <span class="keyword1">≤o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cnotzero_UNIV ordLeq_csum2<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> card_B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?B</span><span class="main">|</span> <span class="keyword1">&lt;o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eqvt image"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eqvt characteristic_formula"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvtI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="var">?B</span> <span class="main">⊆</span> supp <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> supp_fun_eqvt supp_fun_app supp_fun_app_eqvt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> card_B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> supp_Abs_bset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>supp <span class="free">S</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_supp rev_finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> card_B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Disj <span class="main">(</span>Abs_bset <span class="main">(</span>characteristic_formula <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="var">?B</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊨</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="main">∼⋅</span> <span class="bound">Q</span> <span class="main">⟹</span> <span class="bound">Q</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> characteristic_formula_is_characteristic characteristic_formula_is_characteristic' logically_equivalent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="FS_Set">
<div class="head">
<h1>Theory FS_Set</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> FS_Set
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../nominal2/theories/#Nominal2">Nominal2.Nominal2</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Finitely Supported Sets›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define the type of finitely supported sets (over some permutation type~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span><span class="main"><span class="main">::</span></span>pt"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>).

Note that we cannot more generally define the (sub-)type of finitely supported elements for
arbitrary permutation types~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span><span class="main"><span class="main">::</span></span>pt"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: there is no guarantee that this type is non-empty.›</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="tfree">'a</span> fs_set <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>pt set<span class="main">.</span> finite <span class="main">(</span>supp <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main"><span class="main">]</span></span> supp_set_empty<span class="main">)</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_fs_set

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Type~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> fs_set"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a finitely supported permutation type.›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> fs_set <span class="main">::</span> <span class="main">(</span><span class="quoted">pt</span><span class="main">)</span> <span class="quoted">pt</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">permute_fs_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"perm <span class="main">⇒</span> <span class="tfree">'a</span> fs_set <span class="main">⇒</span> <span class="tfree">'a</span> fs_set"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">permute</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_finite supp_eqvt<span class="main">)</span>

  <span class="keyword1"><span class="command">instance</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> permute_fs_set.rep_eq Rep_fs_set_inverse permute_zero<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> permute_fs_set.rep_eq Rep_fs_set_inverse permute_plus<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> fs_set <span class="main">::</span> <span class="main">(</span><span class="quoted">pt</span><span class="main">)</span> <span class="quoted">fs</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fs_set"</span></span>
    <span class="keyword1"><span class="command">from</span></span> Rep_fs_set <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>Rep_fs_set <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">a</span><span class="main">.</span> infinite <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> Rep_fs_set <span class="skolem">x</span> <span class="main">≠</span> Rep_fs_set <span class="skolem">x</span><span class="main">}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> supp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">a</span><span class="main">.</span> infinite <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">a</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≠</span>  <span class="skolem">x</span><span class="main">}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> supp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Set membership.›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> member_fs_set <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>pt <span class="main">⇒</span> <span class="tfree">'a</span> fs_set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(∈)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">notation</span></span>
  member_fs_set <span class="main">(</span><span class="quoted">"<span class="keyword1">'(∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub>')</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  member_fs_set <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword3">/ </span><span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> _<span class="keyword3">)</span>"</span> <span class="main">[</span>51<span class="main">,</span> 51<span class="main">]</span> 50<span class="main">)</span>

<span class="keyword1" id="FS_Set-member_fs_set_permute_iff"><span class="command">lemma</span></span> member_fs_set_permute_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">p</span> <span class="main">∙</span> <span class="free">X</span> <span class="main">⟷</span> <span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mem_permute_iff<span class="main">)</span>

<span class="keyword1" id="FS_Set-member_fs_set_eqvt"><span class="command">lemma</span></span> member_fs_set_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">p</span> <span class="main">∙</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="FL_Transition_System">
<div class="head">
<h1>Theory FL_Transition_System</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> FL_Transition_System
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Transition_System">Transition_System</a> <a href="#FS_Set">FS_Set</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Nominal Transition Systems with Effects and \texorpdfstring{$F/L$}{F/L}-Bisimilarity›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Nominal transition systems with effects›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The paper defines an effect as a finitely supported function from states to states. It then
fixes an equivariant set~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">ℱ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of effects. In our formalization, we avoid working with such a
(carrier) set, and instead introduce a type of (finitely supported) effects together with an
(equivariant) application operator for effects and states.

Equivariance (of the type of effects) is implicitly guaranteed (by the type of~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> permute<span class="antiquote"><span class="antiquote">}</span></span></span></span>).

\emph{First} represents the (finitely supported) set of effects that must be observed before
following a transition.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'eff</span> first <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'eff</span> fs_set"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹\emph{Later} is a function that represents how the set~$F$ (for \emph{first}) changes
depending on the action of a transition and the chosen effect.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'eff</span><span class="main">)</span> later <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'eff</span> first <span class="main">×</span> <span class="tfree">'eff</span> <span class="main">⇒</span> <span class="tfree">'eff</span> first"</span></span>

<span class="keyword1"><span class="command">locale</span></span> effect_nominal_ts <span class="main">=</span> nominal_ts <span class="quoted"><span class="free">satisfies</span></span> <span class="quoted"><span class="free">transition</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">satisfies</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span><span class="main">::</span>fs <span class="main">⇒</span> <span class="tfree">'pred</span><span class="main">::</span>fs <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊢</span>"</span> 70<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">transition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">,</span><span class="tfree">'state</span><span class="main">)</span> residual <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">→</span>"</span> 70<span class="main">)</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">effect_apply</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'effect</span><span class="main">::</span>fs <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⟨</span>_<span class="keyword1">⟩</span>_"</span> <span class="main">[</span>0<span class="main">,</span>101<span class="main">]</span> 100<span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">L</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'effect</span><span class="main">)</span> later"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> effect_apply_eqvt<span class="main">:</span> <span class="quoted"><span class="quoted">"eqvt <span class="free">effect_apply</span>"</span></span>  <span class="comment1">(* using [eqvt] here generates an error message *)</span>
      <span class="keyword2"><span class="keyword">and</span></span> L_eqvt<span class="main">:</span> <span class="quoted"><span class="quoted">"eqvt <span class="free">L</span>"</span></span>  <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">L</span></span><span class="antiquote">}</span></span> is assumed to be equivariant.›</span>
                            <span class="comment1">(* using [eqvt] here generates an error message *)</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="FL_Transition_System-effect_apply_eqvt_aux"><span class="command">lemma</span></span> effect_apply_eqvt_aux <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="free">effect_apply</span> <span class="main">=</span> <span class="free">effect_apply</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> effect_apply_eqvt eqvt_def<span class="main">)</span>

  <span class="keyword1" id="FL_Transition_System-effect_apply_eqvt'"><span class="command">lemma</span></span> effect_apply_eqvt' <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">P</span> <span class="main">=</span> <span class="main"><span class="free">⟨</span></span><span class="free">p</span> <span class="main">∙</span> <span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="FL_Transition_System-L_eqvt_aux"><span class="command">lemma</span></span> L_eqvt_aux <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="free">L</span> <span class="main">=</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L_eqvt eqvt_def<span class="main">)</span>

  <span class="keyword1" id="FL_Transition_System-L_eqvt'"><span class="command">lemma</span></span> L_eqvt' <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="free">L</span> <span class="main">(</span><span class="free">α</span><span class="main">,</span> <span class="free">P</span><span class="main">,</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">L</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">α</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹\texorpdfstring{$L$}{L}-bisimulations and \texorpdfstring{$F/L$}{F/L}-bisimilarity›</span></span>

<span class="keyword1"><span class="command">context</span></span> effect_nominal_ts
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_L_bisimulation</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'effect</span> first <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">is_L_bisimulation</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span>
      <span class="main">∀</span><span class="bound">F</span><span class="main">.</span> symp <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">F</span><span class="main">)</span> <span class="main">∧</span>
          <span class="main">(</span><span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">F</span> <span class="bound">P</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">F</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span><span class="main">.</span> <span class="main"><span class="free">⟨</span></span><span class="bound">f</span><span class="main"><span class="free">⟩</span></span><span class="bound">P</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span> <span class="main">⟶</span> <span class="main"><span class="free">⟨</span></span><span class="bound">f</span><span class="main"><span class="free">⟩</span></span><span class="bound">Q</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
          <span class="main">(</span><span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">F</span> <span class="bound">P</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">F</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">α</span> <span class="bound">P'</span><span class="main">.</span> bn <span class="bound">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="bound">f</span><span class="main"><span class="free">⟩</span></span><span class="bound">Q</span><span class="main">,</span> <span class="bound">F</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span> <span class="main">⟶</span>
                  <span class="main"><span class="free">⟨</span></span><span class="bound">f</span><span class="main"><span class="free">⟩</span></span><span class="bound">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="main"><span class="free">⟨</span></span><span class="bound">f</span><span class="main"><span class="free">⟩</span></span><span class="bound">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">Q'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="bound">α</span><span class="main">,</span><span class="bound">F</span><span class="main">,</span><span class="bound">f</span><span class="main">)</span><span class="main">)</span> <span class="bound">P'</span> <span class="bound">Q'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">FL_bisimilar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'effect</span> first <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">FL_bisimilar</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">R</span><span class="main">.</span> is_L_bisimulation <span class="bound">R</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">R</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">FL_bisimilar'</span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">∼⋅[</span>_<span class="keyword1">]</span> _"</span> <span class="main">[</span>51<span class="main">,</span>0<span class="main">,</span>51<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">∼⋅[</span></span><span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main"><span class="free">]</span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> FL_bisimilar <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"FL_bisimilar"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is an equivariant relation, and (for every~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">F</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) an
    equivalence.›</span></span>

  <span class="keyword1" id="FL_Transition_System-is_L_bisimulation_eqvt"><span class="command">lemma</span></span> is_L_bisimulation_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_L_bisimulation <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_L_bisimulation <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_L_bisimulation_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">F</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"symp <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_L_bisimulation_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eqvt_lambda symp_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span> <span class="skolem">F</span> <span class="bound">P</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">F</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span><span class="main">.</span> <span class="main"><span class="free">⟨</span></span><span class="bound">f</span><span class="main"><span class="free">⟩</span></span><span class="bound">P</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span> <span class="main">⟶</span> <span class="main"><span class="free">⟨</span></span><span class="bound">f</span><span class="main"><span class="free">⟩</span></span><span class="bound">Q</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">f</span> <span class="skolem">φ</span>
        <span class="keyword3"><span class="command">assume</span></span> pR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span> <span class="skolem">F</span> <span class="skolem">P</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> effect<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> satisfies<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> pR <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_lambda permute_bool_def unpermute_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">f</span><span class="main">)</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">F</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> effect <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P</span><span class="main">)</span> <span class="main"><span class="free">⊢</span></span> <span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">φ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> satisfies <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> effect_apply_eqvt' satisfies_eqvt<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main"><span class="free">⊢</span></span> <span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">φ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_L_bisimulation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> effect_apply_eqvt' permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> satisfies_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span> <span class="skolem">F</span> <span class="bound">P</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">F</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">α</span> <span class="bound">P'</span><span class="main">.</span> bn <span class="bound">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="bound">f</span><span class="main"><span class="free">⟩</span></span><span class="bound">Q</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span> <span class="main">⟶</span>
                                <span class="main"><span class="free">⟨</span></span><span class="bound">f</span><span class="main"><span class="free">⟩</span></span><span class="bound">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="main"><span class="free">⟨</span></span><span class="bound">f</span><span class="main"><span class="free">⟩</span></span><span class="bound">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">Q'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="bound">α</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span><span class="main">)</span> <span class="bound">P'</span> <span class="bound">Q'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?U</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">P'</span>
        <span class="keyword3"><span class="command">assume</span></span> pR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span> <span class="skolem">F</span> <span class="skolem">P</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> effect<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> pR <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_lambda permute_bool_def unpermute_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">f</span><span class="main">)</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">F</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> effect <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">♯*</span> <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q</span><span class="main">)</span><span class="main">,</span> <span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">F</span><span class="main">,</span> <span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">f</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> fresh <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> effect_apply_eqvt' bn_eqvt fresh_star_Pair fresh_star_permute_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P</span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">,</span> <span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> trans <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> effect_apply_eqvt' transition_eqvt'<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">,</span><span class="skolem">Q'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">,</span> <span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">F</span><span class="main">,</span> <span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">)</span> <span class="skolem">Q'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_L_bisimulation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
        <span class="keyword1"><span class="command">from</span></span> T <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q'</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> effect_apply_eqvt' abs_residual_pair_eqvt permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> transition_eqvt<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> R <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">L</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">,</span> <span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">F</span><span class="main">,</span> <span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_boolI permute_fun_def permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="skolem">P'</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_self<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="bound">Q'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="skolem">P'</span> <span class="bound">Q'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">∧</span> <span class="var">?T</span> <span class="main">∧</span> <span class="var">?U</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="FL_Transition_System-FL_bisimilar_eqvt"><span class="command">lemma</span></span> FL_bisimilar_eqvt<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∼⋅[</span><span class="free">F</span><span class="main">]</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">∼⋅[</span><span class="free">p</span> <span class="main">∙</span> <span class="free">F</span><span class="main">]</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eqvt_apply permute_boolI is_L_bisimulation_eqvt FL_bisimilar_def<span class="main">)</span>

  <span class="keyword1" id="FL_Transition_System-FL_bisimilar_reflp"><span class="command">lemma</span></span> FL_bisimilar_reflp<span class="main">:</span> <span class="quoted"><span class="quoted">"reflp <span class="main">(</span>FL_bisimilar <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> reflpI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_L_bisimulation <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">(=)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_L_bisimulation_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> symp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∼⋅[</span><span class="free">F</span><span class="main">]</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> FL_bisimilar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="FL_Transition_System-FL_bisimilar_symp"><span class="command">lemma</span></span> FL_bisimilar_symp<span class="main">:</span> <span class="quoted"><span class="quoted">"symp <span class="main">(</span>FL_bisimilar <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sympI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∼⋅[</span><span class="free">F</span><span class="main">]</span> <span class="skolem">Q</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"is_L_bisimulation <span class="skolem">R</span> <span class="main">∧</span> <span class="skolem">R</span> <span class="free">F</span> <span class="skolem">P</span> <span class="skolem">Q</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> FL_bisimilar_def <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="free">F</span> <span class="skolem">Q</span> <span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_L_bisimulation_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> symp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"*"</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∼⋅[</span><span class="free">F</span><span class="main">]</span> <span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> FL_bisimilar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="FL_Transition_System-FL_bisimilar_is_L_bisimulation"><span class="command">lemma</span></span> FL_bisimilar_is_L_bisimulation<span class="main">:</span> <span class="quoted"><span class="quoted">"is_L_bisimulation FL_bisimilar"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_L_bisimulation_def <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">F</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"symp <span class="main">(</span>FL_bisimilar <span class="skolem">F</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> FL_bisimilar_symp<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∼⋅[</span><span class="skolem">F</span><span class="main">]</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">F</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span><span class="main">.</span> <span class="main"><span class="free">⟨</span></span><span class="bound">f</span><span class="main"><span class="free">⟩</span></span><span class="bound">P</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span> <span class="main">⟶</span> <span class="main"><span class="free">⟨</span></span><span class="bound">f</span><span class="main"><span class="free">⟩</span></span><span class="bound">Q</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_L_bisimulation_def FL_bisimilar_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∼⋅[</span><span class="skolem">F</span><span class="main">]</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">F</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">α</span> <span class="bound">P'</span><span class="main">.</span> bn <span class="bound">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="bound">f</span><span class="main"><span class="free">⟩</span></span><span class="bound">Q</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span> <span class="main">⟶</span>
          <span class="main"><span class="free">⟨</span></span><span class="bound">f</span><span class="main"><span class="free">⟩</span></span><span class="bound">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="main"><span class="free">⟨</span></span><span class="bound">f</span><span class="main"><span class="free">⟩</span></span><span class="bound">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">Q'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">∼⋅[</span><span class="free">L</span> <span class="main">(</span><span class="bound">α</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span><span class="main">]</span> <span class="bound">Q'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_L_bisimulation_def FL_bisimilar_def<span class="main">)</span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">∧</span> <span class="var">?S</span> <span class="main">∧</span> <span class="var">?T</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="FL_Transition_System-FL_bisimilar_simulation_step"><span class="command">lemma</span></span> FL_bisimilar_simulation_step<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∼⋅[</span><span class="free">F</span><span class="main">]</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bn <span class="free">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">Q</span><span class="main">,</span> <span class="free">F</span><span class="main">,</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">α</span><span class="main">,</span><span class="free">P'</span><span class="main">⟩</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">Q'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">α</span><span class="main">,</span><span class="free">Q'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">∼⋅[</span><span class="free">L</span> <span class="main">(</span><span class="free">α</span><span class="main">,</span><span class="free">F</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">]</span> <span class="free">Q'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">)</span></span> FL_bisimilar_is_L_bisimulation is_L_bisimulation_def<span class="main">)</span>

  <span class="keyword1" id="FL_Transition_System-FL_bisimilar_transp"><span class="command">lemma</span></span> FL_bisimilar_transp<span class="main">:</span> <span class="quoted"><span class="quoted">"transp <span class="main">(</span>FL_bisimilar <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> transpI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">R</span>
    <span class="keyword3"><span class="command">assume</span></span> PQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∼⋅[</span><span class="free">F</span><span class="main">]</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> QR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∼⋅[</span><span class="free">F</span><span class="main">]</span> <span class="skolem">R</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?FL_bisim</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">F</span><span class="main">.</span> <span class="main">(</span>FL_bisimilar <span class="bound">F</span><span class="main">)</span> <span class="keyword1">OO</span> <span class="main">(</span>FL_bisimilar <span class="bound">F</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">F</span><span class="main">.</span> symp <span class="main">(</span><span class="var">?FL_bisim</span> <span class="bound">F</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sympI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">F</span> <span class="skolem">P</span> <span class="skolem">R</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?FL_bisim</span> <span class="skolem">F</span> <span class="skolem">P</span> <span class="skolem">R</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∼⋅[</span><span class="skolem">F</span><span class="main">]</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∼⋅[</span><span class="skolem">F</span><span class="main">]</span> <span class="skolem">R</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">∼⋅[</span><span class="skolem">F</span><span class="main">]</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∼⋅[</span><span class="skolem">F</span><span class="main">]</span> <span class="skolem">P</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> FL_bisimilar_symp sympE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?FL_bisim</span> <span class="skolem">F</span> <span class="skolem">R</span> <span class="skolem">P</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">F</span><span class="main">.</span> <span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="var">?FL_bisim</span> <span class="bound">F</span> <span class="bound">P</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">F</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span><span class="main">.</span> <span class="main"><span class="free">⟨</span></span><span class="bound">f</span><span class="main"><span class="free">⟩</span></span><span class="bound">P</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span> <span class="main">⟶</span> <span class="main"><span class="free">⟨</span></span><span class="bound">f</span><span class="main"><span class="free">⟩</span></span><span class="bound">Q</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> FL_bisimilar_is_L_bisimulation is_L_bisimulation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">F</span><span class="main">.</span> <span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="var">?FL_bisim</span> <span class="bound">F</span> <span class="bound">P</span> <span class="bound">Q</span> <span class="main">⟶</span>
           <span class="main">(</span><span class="main">∀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">F</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">α</span> <span class="bound">P'</span><span class="main">.</span> bn <span class="bound">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="bound">f</span><span class="main"><span class="free">⟩</span></span><span class="bound">Q</span><span class="main">,</span> <span class="bound">F</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span> <span class="main">⟶</span>
                     <span class="main"><span class="free">⟨</span></span><span class="bound">f</span><span class="main"><span class="free">⟩</span></span><span class="bound">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="main"><span class="free">⟨</span></span><span class="bound">f</span><span class="main"><span class="free">⟩</span></span><span class="bound">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">Q'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="var">?FL_bisim</span> <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="bound">α</span><span class="main">,</span><span class="bound">F</span><span class="main">,</span><span class="bound">f</span><span class="main">)</span><span class="main">)</span> <span class="bound">P'</span> <span class="bound">Q'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">F</span> <span class="skolem">P</span> <span class="skolem">R</span> <span class="skolem">Q</span> <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">P'</span>
        <span class="keyword3"><span class="command">assume</span></span> PR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∼⋅[</span><span class="skolem">F</span><span class="main">]</span> <span class="skolem">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> RQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">∼⋅[</span><span class="skolem">F</span><span class="main">]</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> effect<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
        <span class="comment1">― ‹rename~<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span><span class="antiquote">}</span></span> to avoid~<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">R</span><span class="main">,</span> <span class="skolem">F</span><span class="main">)</span>"</span><span class="antiquote">}</span></span>, without touching~<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span>"</span><span class="antiquote">}</span></span>›</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> bn <span class="skolem">α</span><span class="main">)</span> <span class="main">♯*</span> <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">R</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span><span class="main">,</span> <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> at_set_avoiding2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"bn <span class="skolem"><span class="skolem">α</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="free"><span class="main"><span class="free">⟨</span></span></span></span><span class="skolem"><span class="skolem">f</span></span><span class="main"><span class="free"><span class="main"><span class="free">⟩</span></span></span></span><span class="skolem"><span class="skolem">R</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">F</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">f</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">⟨</span></span><span class="skolem"><span class="skolem">α</span></span><span class="main"><span class="main">,</span></span><span class="skolem"><span class="skolem">P'</span></span><span class="main"><span class="main">⟩</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="free"><span class="main"><span class="free">⟨</span></span></span></span><span class="skolem"><span class="skolem">f</span></span><span class="main"><span class="free"><span class="main"><span class="free">⟩</span></span></span></span><span class="skolem"><span class="skolem">Q</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">F</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">f</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> exE<span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>bn <span class="skolem">α</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> bn_finite<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">R</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> finite_supp<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span><span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span><span class="main">,</span> <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_supp supp_Pair<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span><span class="main">,</span> <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> bn_abs_residual_fresh fresh fresh_star_Pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Un supp_Pair<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">from</span></span> 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">,</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> supp_perm_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pR'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">R</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">,</span> <span class="skolem">pR'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">)</span> <span class="main">∼⋅[</span><span class="free">L</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">,</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span><span class="main">]</span> <span class="skolem">pR'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> PR effect trans 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> FL_bisimilar_simulation_step bn_eqvt<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> fresh <span class="keyword2"><span class="keyword">and</span></span> 4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">♯*</span> <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bn_eqvt fresh_star_permute_iff supp_perm_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pQ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">,</span> <span class="skolem">pQ'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 8<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pR'</span> <span class="main">∼⋅[</span><span class="free">L</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">,</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span><span class="main">]</span> <span class="skolem">pQ'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> RQ effect 5 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> FL_bisimilar_simulation_step<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> 4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Un supp_Pair<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> 7 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span> <span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">pQ'</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> supp_perm_eq transition_eqvt'<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 6 <span class="keyword2"><span class="keyword">and</span></span> 8 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?FL_bisim</span> <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">)</span> <span class="skolem">pQ'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> relcompp.relcompI<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?FL_bisim</span> <span class="main">(</span><span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">L</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">pQ'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> FL_bisimilar_eqvt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?FL_bisim</span> <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span> <span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">F</span><span class="main">,</span> <span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="skolem">P'</span> <span class="main">(</span><span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">pQ'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L_eqvt'<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?FL_bisim</span> <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="skolem">P'</span> <span class="main">(</span><span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">pQ'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_star_Un permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> supp_Pair supp_perm_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="bound">Q'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="var">?FL_bisim</span> <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="skolem">P'</span> <span class="bound">Q'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_L_bisimulation <span class="var">?FL_bisim</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_L_bisimulation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?FL_bisim</span> <span class="free">F</span> <span class="skolem">P</span> <span class="skolem">R</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> PQ QR <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∼⋅[</span><span class="free">F</span><span class="main">]</span> <span class="skolem">R</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> FL_bisimilar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="FL_Transition_System-FL_bisimilar_equivp"><span class="command">lemma</span></span> FL_bisimilar_equivp<span class="main">:</span> <span class="quoted"><span class="quoted">"equivp <span class="main">(</span>FL_bisimilar <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> FL_bisimilar_reflp FL_bisimilar_symp FL_bisimilar_transp equivp_reflp_symp_transp<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="FL_Formula">
<div class="head">
<h1>Theory FL_Formula</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> FL_Formula
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Nominal_Bounded_Set">Nominal_Bounded_Set</a>
  <a href="#Nominal_Wellfounded">Nominal_Wellfounded</a>
  <a href="#Residual">Residual</a>
  <a href="#FL_Transition_System">FL_Transition_System</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Infinitary Formulas With Effects›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Infinitely branching trees›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First, we define a type of trees, with a constructor~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">tConj</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that maps (potentially
infinite) sets of trees into trees. To avoid paradoxes (note that there is no injection from the
powerset of trees into the set of trees), the cardinality of the argument set must be bounded.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The effect consequence operator~<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⟨f⟩›</span></span></span></span> is always and only used as a prefix to a
predicate or an action formula. So to simplify the representation of formula trees with effects, the
effect operator is merged into the predicate or action it precedes.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'eff</span><span class="main">)</span> Tree <span class="main">=</span>
    tConj <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'eff</span><span class="main">)</span> Tree <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span>"</span></span>  <span class="comment1">― ‹potentially infinite sets of trees›</span>
  <span class="main">|</span> tNot <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'eff</span><span class="main">)</span> Tree"</span></span>
  <span class="main">|</span> tPred <span class="tfree"><span class="quoted"><span class="tfree">'eff</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'pred</span></span></span>
  <span class="main">|</span> tAct  <span class="tfree"><span class="quoted"><span class="tfree">'eff</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'act</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'eff</span><span class="main">)</span> Tree"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The (automatically generated) induction principle for trees allows us to prove that the
following relation over trees is well-founded. This will be useful for termination proofs when we
define functions by recursion over trees.›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">Tree_wf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'eff</span><span class="main">)</span> Tree rel"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∈</span> set_bset <span class="free"><span class="bound"><span class="entity">tset</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> tConj <span class="free"><span class="bound"><span class="entity">tset</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">Tree_wf</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> tNot <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">Tree_wf</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> tAct <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">Tree_wf</span>"</span></span>

<span class="keyword1" id="FL_Formula-wf_Tree_wf"><span class="command">lemma</span></span> wf_Tree_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf Tree_wf"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> wf_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'eff</span><span class="main">)</span> Tree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> Tree_wf <span class="main">⟶</span> <span class="skolem">P</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">P</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> tConj <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree.distinct<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Tree.distinct<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> Tree.inject<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Tree_wf.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> tNot <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Tree.distinct<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> Tree.inject<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Tree_wf.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> tPred <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree.distinct<span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span> Tree.distinct<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Tree.distinct<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> Tree_wf.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> tAct <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree.distinct<span class="main"><span class="main">(</span></span>10<span class="main"><span class="main">)</span></span> Tree.distinct<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> Tree.inject<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> Tree_wf.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define a permutation operation on the type of trees.›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> Tree <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">pt</span><span class="main">,</span> <span class="quoted">pt</span><span class="main">,</span> <span class="quoted">pt</span><span class="main">)</span> <span class="quoted">pt</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">primrec</span></span> <span class="entity"><span class="class_parameter">permute_Tree</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"perm <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> Tree <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> Tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="main">(</span>tConj <span class="free"><span class="bound"><span class="entity">tset</span></span></span><span class="main">)</span> <span class="main">=</span> tConj <span class="main">(</span>map_bset <span class="main">(</span>permute <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tset</span></span></span><span class="main">)</span>"</span></span>  <span class="comment1">― ‹neat trick to get around the fact that~<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">tset</span></span><span class="antiquote">}</span></span> is not of permutation type yet›</span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="main">(</span>tNot <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> tNot <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="main">(</span>tPred <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> tPred <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="main">(</span>tAct <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> tAct <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> Tree"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∙</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> tConj <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">::</span> <span class="quoted">perm</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> Tree"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">+</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> tConj <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now that the type of trees---and hence the type of (bounded) sets of trees---is a permutation
type, we can massage the definition of~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">p</span></span> <span class="main"><span class="main">∙</span></span> tConj <span class="free"><span class="free">tset</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> into its more usual form.›</span></span>

<span class="keyword1" id="FL_Formula-permute_Tree_tConj"><span class="command">lemma</span></span> permute_Tree_tConj <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> tConj <span class="free">tset</span> <span class="main">=</span> tConj <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">tset</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_bset_permute<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> permute_Tree.simps<span class="main">(</span>1<span class="main">)</span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The relation~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Tree_wf<span class="antiquote"><span class="antiquote">}</span></span></span></span> is equivariant.›</span></span>

<span class="keyword1" id="FL_Formula-Tree_wf_eqvt_aux"><span class="command">lemma</span></span> Tree_wf_eqvt_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t1</span><span class="main">,</span> <span class="free">t2</span><span class="main">)</span> <span class="main">∈</span> Tree_wf"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">t1</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">t2</span><span class="main">)</span> <span class="main">∈</span> Tree_wf"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Tree_wf.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> Tree"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">tset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> Tree <span class="keyword1">set[</span><span class="tfree">'a</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> set_bset <span class="skolem">tset</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">t</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> tConj <span class="skolem">tset</span><span class="main">)</span> <span class="main">∈</span> Tree_wf"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree_wf.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> mem_permute_iff permute_Tree_tConj set_bset_eqvt<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> Tree"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">t</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> tNot <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> Tree_wf"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree_wf.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> permute_Tree.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> Tree"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">f</span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="skolem">α</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">t</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> tAct <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> Tree_wf"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree_wf.intros<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> permute_Tree.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FL_Formula-Tree_wf_eqvt"><span class="command">lemma</span></span> Tree_wf_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Tree_wf <span class="main">=</span> Tree_wf"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Tree_wf <span class="main">⊆</span> Tree_wf"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_set_def<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> Tree_wf_eqvt_aux<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Tree_wf <span class="main">⊆</span> <span class="free">p</span> <span class="main">∙</span> Tree_wf"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_set_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Tree_wf_eqvt_aux permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FL_Formula-Tree_wf_eqvt'"><span class="command">lemma</span></span> Tree_wf_eqvt'<span class="main">:</span> <span class="quoted"><span class="quoted">"eqvt Tree_wf"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree_wf_eqvt eqvtI<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The definition of~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> permute<span class="antiquote"><span class="antiquote">}</span></span></span></span> for trees gives rise to the usual notion of support. The
following lemmas, one for each constructor, describe the support of trees.›</span></span>

<span class="keyword1" id="FL_Formula-supp_tConj"><span class="command">lemma</span></span> supp_tConj <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>tConj <span class="free">tset</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">tset</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="FL_Formula-supp_tNot"><span class="command">lemma</span></span> supp_tNot <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>tNot <span class="free">t</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="FL_Formula-supp_tPred"><span class="command">lemma</span></span> supp_tPred <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>tPred <span class="free">f</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">f</span> <span class="main">∪</span> supp <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_imp_eq Collect_neg_eq<span class="main">)</span>

<span class="keyword1" id="FL_Formula-supp_tAct"><span class="command">lemma</span></span> supp_tAct <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">f</span> <span class="main">∪</span> supp <span class="free">α</span> <span class="main">∪</span> supp <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_imp_eq Collect_neg_eq<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Trees modulo \texorpdfstring{$\alpha$}{alpha}-equivalence›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We generalize the notion of support, which considers whether a permuted element is
\emph{equal} to itself, to arbitrary endorelations. This is available as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> supp_rel<span class="antiquote"><span class="antiquote">}</span></span></span></span> in
Nominal Isabelle.›</span></span>

<span class="keyword1" id="FL_Formula-supp_rel_eqvt"><span class="command">lemma</span></span> supp_rel_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> supp_rel <span class="free">R</span> <span class="free">x</span> <span class="main">=</span> supp_rel <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Usually, the definition of $\alpha$-equivalence presupposes a notion of free variables.
However, the variables that are ``free'' in an infinitary conjunction are not necessarily those
that are free in one of the conjuncts. For instance, consider a conjunction over \emph{all} names.
Applying any permutation will yield the same conjunction, i.e., this conjunction has \emph{no} free
variables.

To obtain the correct notion of free variables for infinitary conjunctions, we initially defined
$\alpha$-equivalence and free variables via mutual recursion. In particular, we defined the free
variables of a conjunction as term <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">fv_Tree</span></span> <span class="main"><span class="main">(</span></span>tConj <span class="free"><span class="free">tset</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> supp_rel <span class="free"><span class="free">alpha_Tree</span></span> <span class="main"><span class="main">(</span></span>tConj <span class="free"><span class="free">tset</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

We then realized that it is not necessary to define the concept of ``free variables'' at all, but
the definition of $\alpha$-equivalence becomes much simpler (in particular, it is no longer mutually
recursive) if we directly use the support modulo $\alpha$-equivalence.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following lemmas and constructions are used to prove termination of our definition.›</span></span>

<span class="keyword1" id="FL_Formula-supp_rel_cong"><span class="command">lemma</span></span> supp_rel_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span><span class="main">=</span><span class="free">x'</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="main">(</span><span class="bound">a</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">x'</span><span class="main">)</span> <span class="free">x'</span> <span class="main">⟷</span> <span class="free">R'</span> <span class="main">(</span><span class="main">(</span><span class="bound">a</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">x'</span><span class="main">)</span> <span class="free">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> supp_rel <span class="free">R</span> <span class="free">x</span> <span class="main">=</span> supp_rel <span class="free">R'</span> <span class="free">x'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_rel_def<span class="main">)</span>

<span class="keyword1" id="FL_Formula-rel_bset_cong"><span class="command">lemma</span></span> rel_bset_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span><span class="main">=</span><span class="free">x'</span><span class="main">;</span> <span class="free">y</span><span class="main">=</span><span class="free">y'</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set_bset <span class="free">x'</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">∈</span> set_bset <span class="free">y'</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟷</span> <span class="free">R'</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟧</span> <span class="main">⟹</span> rel_bset <span class="free">R</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟷</span> rel_bset <span class="free">R'</span> <span class="free">x'</span> <span class="free">y'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_bset_def rel_set_def<span class="main">)</span>

<span class="keyword1" id="FL_Formula-alpha_set_cong"><span class="command">lemma</span></span> alpha_set_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">bs</span><span class="main">=</span><span class="free">bs'</span><span class="main">;</span> <span class="free">x</span><span class="main">=</span><span class="free">x'</span><span class="main">;</span> <span class="free">R</span> <span class="main">(</span><span class="free">p'</span> <span class="main">∙</span> <span class="free">x'</span><span class="main">)</span> <span class="free">y'</span> <span class="main">⟷</span> <span class="free">R'</span> <span class="main">(</span><span class="free">p'</span> <span class="main">∙</span> <span class="free">x'</span><span class="main">)</span> <span class="free">y'</span><span class="main">;</span> <span class="free">f</span> <span class="free">x'</span> <span class="main">=</span> <span class="free">f'</span> <span class="free">x'</span><span class="main">;</span> <span class="free">f</span> <span class="free">y'</span> <span class="main">=</span> <span class="free">f'</span> <span class="free">y'</span><span class="main">;</span> <span class="free">p</span><span class="main">=</span><span class="free">p'</span><span class="main">;</span> <span class="free">cs</span><span class="main">=</span><span class="free">cs'</span><span class="main">;</span> <span class="free">y</span><span class="main">=</span><span class="free">y'</span> <span class="main">⟧</span> <span class="main">⟹</span>
    alpha_set <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="free">R</span> <span class="free">f</span> <span class="free">p</span> <span class="main">(</span><span class="free">cs</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">⟷</span> alpha_set <span class="main">(</span><span class="free">bs'</span><span class="main">,</span> <span class="free">x'</span><span class="main">)</span> <span class="free">R'</span> <span class="free">f'</span> <span class="free">p'</span> <span class="main">(</span><span class="free">cs'</span><span class="main">,</span> <span class="free">y'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set<span class="main">)</span>

<span class="keyword1"><span class="command">quotient_type</span></span>
  <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'eff</span><span class="main">)</span> Tree<span class="hidden">⇩</span><sub>p</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>pt<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">,</span><span class="tfree">'eff</span><span class="main">::</span>fs<span class="main">)</span> Tree"</span></span> <span class="main">/</span> <span class="quoted"><span class="quoted">"hull_relp"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> hull_relp_equivp<span class="main">)</span>

<span class="keyword1" id="FL_Formula-abs_Tree"><span class="command">lemma</span></span> abs_Tree<span class="hidden">⇩</span><sub>p</sub>_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"abs_Tree<span class="hidden">⇩</span><sub>p</sub> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> abs_Tree<span class="hidden">⇩</span><sub>p</sub> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hull_relp.simps Tree<span class="hidden">⇩</span><sub>p</sub>.abs_eq_iff<span class="main">)</span>

<span class="keyword1" id="FL_Formula-permute_rep_abs_Tree"><span class="command">lemma</span></span> permute_rep_abs_Tree<span class="hidden">⇩</span><sub>p</sub><span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">p</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"rep_Tree<span class="hidden">⇩</span><sub>p</sub> <span class="main">(</span>abs_Tree<span class="hidden">⇩</span><sub>p</sub> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Quotient3_Tree<span class="hidden">⇩</span><sub>p</sub> Tree<span class="hidden">⇩</span><sub>p</sub>.abs_eq_iff rep_abs_rsp hull_relp.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> Tree_wf<span class="hidden">⇩</span><sub>p</sub> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>pt<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">,</span><span class="tfree">'eff</span><span class="main">::</span>fs<span class="main">)</span> Tree<span class="hidden">⇩</span><sub>p</sub> rel"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted">Tree_wf</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="FL_Formula-Tree_wf"><span class="command">lemma</span></span> Tree_wf<span class="hidden">⇩</span><sub>p</sub>I <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> Tree_wf"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>abs_Tree<span class="hidden">⇩</span><sub>p</sub> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">a</span><span class="main">)</span><span class="main">,</span> abs_Tree<span class="hidden">⇩</span><sub>p</sub> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> Tree_wf<span class="hidden">⇩</span><sub>p</sub>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Tree<span class="hidden">⇩</span><sub>p</sub>.abs_eq_iff Tree_wf<span class="hidden">⇩</span><sub>p</sub>.abs_eq hull_relp.intros map_prod_simp rev_image_eqI<span class="main">)</span>

<span class="keyword1" id="FL_Formula-Tree_wf"><span class="command">lemma</span></span> Tree_wf<span class="hidden">⇩</span><sub>p</sub>_trivialI <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> Tree_wf"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>abs_Tree<span class="hidden">⇩</span><sub>p</sub> <span class="free">a</span><span class="main">,</span> abs_Tree<span class="hidden">⇩</span><sub>p</sub> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> Tree_wf<span class="hidden">⇩</span><sub>p</sub>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree_wf<span class="hidden">⇩</span><sub>p</sub>I permute_zero<span class="main">)</span>

<span class="keyword1" id="FL_Formula-Tree_wf"><span class="command">lemma</span></span> Tree_wf<span class="hidden">⇩</span><sub>p</sub>E<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a<span class="hidden">⇩</span><sub>p</sub></span><span class="main">,</span> <span class="free">b<span class="hidden">⇩</span><sub>p</sub></span><span class="main">)</span> <span class="main">∈</span> Tree_wf<span class="hidden">⇩</span><sub>p</sub>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="free">b</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">a<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">=</span> abs_Tree<span class="hidden">⇩</span><sub>p</sub> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">=</span> abs_Tree<span class="hidden">⇩</span><sub>p</sub> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">∈</span> Tree_wf"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Pair_inject Tree_wf<span class="hidden">⇩</span><sub>p</sub>.abs_eq prod_fun_imageE<span class="main">)</span> <span class="comment1">(* DIFF *)</span>

<span class="keyword1" id="FL_Formula-wf_Tree_wf"><span class="command">lemma</span></span> wf_Tree_wf<span class="hidden">⇩</span><sub>p</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"wf Tree_wf<span class="hidden">⇩</span><sub>p</sub>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_subset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"inv_image <span class="main"><span class="main">(</span></span>hull_rel <span class="keyword1"><span class="keyword1">O</span></span> Tree_wf<span class="main"><span class="main">)</span></span> rep_Tree<span class="hidden">⇩</span><sub>p</sub>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Tree_wf_eqvt' wf_Tree_wf wf_hull_rel_relcomp wf_inv_image<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Tree_wf<span class="hidden">⇩</span><sub>p</sub>E<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> t1 t2<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">t1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> permute_rep_abs_Tree<span class="hidden">⇩</span><sub>p</sub><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">t2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> permute_rep_abs_Tree<span class="hidden">⇩</span><sub>p</sub><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> p1 p2<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">p2</span> <span class="main">∙</span> <span class="improper">t1</span><span class="main">,</span> <span class="improper">p2</span> <span class="main">∙</span> <span class="improper">t2</span><span class="main">)</span> <span class="main">∈</span> Tree_wf"</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">p1</span> <span class="main">∙</span> <span class="improper">t1</span><span class="main">,</span> <span class="improper">p2</span> <span class="main">∙</span> <span class="improper">t1</span><span class="main">)</span> <span class="main">∈</span> hull_rel"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> relcomp.relcompI<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> hull_rel.simps permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> permute_plus<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Tree_wf_eqvt_aux<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">alpha_Tree_termination</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> Tree <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> Tree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>pt<span class="main">,</span> <span class="tfree">'c</span><span class="main">::</span>bn<span class="main">,</span> <span class="tfree">'d</span><span class="main">::</span>fs<span class="main">)</span> Tree<span class="hidden">⇩</span><sub>p</sub> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">alpha_Tree_termination</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>abs_Tree<span class="hidden">⇩</span><sub>p</sub> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> abs_Tree<span class="hidden">⇩</span><sub>p</sub> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Here it comes \ldots›</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">)</span>
  <span class="entity">alpha_Tree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>pt<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">,</span><span class="tfree">'eff</span><span class="main">::</span>fs<span class="main">)</span> Tree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'eff</span><span class="main">)</span> Tree <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> alpha_Tree<span class="antiquote">}</span></span>›</span>
  alpha_tConj<span class="main">:</span> <span class="quoted"><span class="quoted">"tConj <span class="free"><span class="bound"><span class="entity">tset1</span></span></span> <span class="keyword1"><span class="free">=<span class="hidden">⇩</span><sub>α</sub></span></span> tConj <span class="free"><span class="bound"><span class="entity">tset2</span></span></span> <span class="main">⟷</span> rel_bset <span class="free">alpha_Tree</span> <span class="free"><span class="bound"><span class="entity">tset1</span></span></span> <span class="free"><span class="bound"><span class="entity">tset2</span></span></span>"</span></span>
<span class="main">|</span> alpha_tNot<span class="main">:</span> <span class="quoted"><span class="quoted">"tNot <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="keyword1"><span class="free">=<span class="hidden">⇩</span><sub>α</sub></span></span> tNot <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="keyword1"><span class="free">=<span class="hidden">⇩</span><sub>α</sub></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>
<span class="main">|</span> alpha_tPred<span class="main">:</span> <span class="quoted"><span class="quoted">"tPred <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">φ1</span></span></span> <span class="keyword1"><span class="free">=<span class="hidden">⇩</span><sub>α</sub></span></span> tPred <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">φ2</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">φ1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ2</span></span></span>"</span></span>
<span class="comment1">― ‹the action may have binding names›</span>
<span class="main">|</span> alpha_tAct<span class="main">:</span> <span class="quoted"><span class="quoted">"tAct <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">α1</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="keyword1"><span class="free">=<span class="hidden">⇩</span><sub>α</sub></span></span> tAct <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">α2</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">⟷</span>
    <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>bn <span class="free"><span class="bound"><span class="entity">α1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="free">alpha_Tree</span> <span class="main">(</span>supp_rel <span class="free">alpha_Tree</span><span class="main">)</span> <span class="bound">p</span> <span class="main">(</span>bn <span class="free"><span class="bound"><span class="entity">α2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>bn <span class="free"><span class="bound"><span class="entity">α1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">α1</span></span></span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(</span><span class="main">(=)</span><span class="main">)</span> supp <span class="bound">p</span> <span class="main">(</span>bn <span class="free"><span class="bound"><span class="entity">α2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">α2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> alpha_other<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="keyword1"><span class="free">=<span class="hidden">⇩</span><sub>α</sub></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟷</span> False"</span></span>
<span class="comment1">― ‹254 subgoals (!)›</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inv_image <span class="main">(</span>max_ext Tree_wf<span class="hidden">⇩</span><sub>p</sub><span class="main">)</span> alpha_Tree_termination"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> max_ext_wf wf_Tree_wf<span class="hidden">⇩</span><sub>p</sub> wf_inv_image<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_ext.simps Tree_wf.simps <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> permute_Tree_tConj<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We provide more descriptive case names for the automatically generated induction principle,
and specialize it to an induction rule for $\alpha$-equivalence.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> alpha_Tree_induct' <span class="main">=</span> alpha_Tree.induct<span class="main">[</span><span class="operator">case_names</span> alpha_tConj alpha_tNot
  alpha_tPred alpha_tAct <span class="quoted">"alpha_other(1)"</span> <span class="quoted">"alpha_other(2)"</span> <span class="quoted">"alpha_other(3)"</span> <span class="quoted">"alpha_other(4)"</span>
  <span class="quoted">"alpha_other(5)"</span> <span class="quoted">"alpha_other(6)"</span> <span class="quoted">"alpha_other(7)"</span> <span class="quoted">"alpha_other(8)"</span> <span class="quoted">"alpha_other(9)"</span>
  <span class="quoted">"alpha_other(10)"</span> <span class="quoted">"alpha_other(11)"</span> <span class="quoted">"alpha_other(12)"</span> <span class="quoted">"alpha_other(13)"</span> <span class="quoted">"alpha_other(14)"</span>
  <span class="quoted">"alpha_other(15)"</span> <span class="quoted">"alpha_other(16)"</span> <span class="quoted">"alpha_other(17)"</span> <span class="quoted">"alpha_other(18)"</span><span class="main">]</span>

<span class="keyword1" id="FL_Formula-alpha_Tree_induct"><span class="command">lemma</span></span> alpha_Tree_induct<span class="main">[</span><span class="operator">case_names</span> tConj tNot tPred tAct<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">tset1</span> <span class="bound">tset2</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set_bset <span class="bound">tset1</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">∈</span> set_bset <span class="bound">tset2</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⟹</span>
            rel_bset <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="bound">tset1</span> <span class="bound">tset2</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>tConj <span class="bound">tset1</span><span class="main">)</span> <span class="main">(</span>tConj <span class="bound">tset2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t1</span> <span class="bound">t2</span><span class="main">.</span> <span class="bound">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="bound">t2</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">t1</span> <span class="bound">t2</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>tNot <span class="bound">t1</span><span class="main">)</span> <span class="main">(</span>tNot <span class="bound">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">φ</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>tPred <span class="bound">f</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">(</span>tPred <span class="bound">f</span> <span class="bound">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f1</span> <span class="bound">α1</span> <span class="bound">t1</span> <span class="bound">f2</span> <span class="bound">α2</span> <span class="bound">t2</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∙</span> <span class="bound">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="bound">t2</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="bound">t1</span><span class="main">)</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">f1</span> <span class="main">=</span> <span class="bound">f2</span> <span class="main">⟹</span>
            <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>bn <span class="bound">α1</span><span class="main">,</span> <span class="bound">t1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span><span class="main">)</span> <span class="bound">p</span> <span class="main">(</span>bn <span class="bound">α2</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>bn <span class="bound">α1</span><span class="main">,</span> <span class="bound">α1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="bound">p</span> <span class="main">(</span>bn <span class="bound">α2</span><span class="main">,</span> <span class="bound">α2</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
            <span class="free">P</span> <span class="main">(</span>tAct <span class="bound">f1</span> <span class="bound">α1</span> <span class="bound">t1</span><span class="main">)</span> <span class="main">(</span>tAct <span class="bound">f2</span> <span class="bound">α2</span> <span class="bound">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">t1</span> <span class="free">t2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alpha_Tree.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹$\alpha$-equivalence is equivariant.›</span></span>

<span class="keyword1" id="FL_Formula-alpha_Tree_eqvt_aux"><span class="command">lemma</span></span> alpha_Tree_eqvt_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">∙</span> <span class="main">(</span><span class="bound">a</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">p</span> <span class="main">∙</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span> <span class="main">=</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pB</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">a</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?B</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>unpermute <span class="free">p</span><span class="main">)</span> <span class="var">?pB</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def unpermute_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unpermute <span class="free">p</span> <span class="main">`</span> <span class="var">?pB</span> <span class="main">⊆</span> <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> eqvt_bound permute_eqvt swap_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?pB</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inj_on_finite<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?pB</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>permute <span class="free">p</span><span class="main">)</span> <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"permute <span class="free">p</span> <span class="main">`</span> <span class="var">?B</span> <span class="main">⊆</span> <span class="var">?pB</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> permute_eqvt swap_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inj_on_finite<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="var">?B</span> <span class="main">⟷</span> infinite <span class="var">?pB</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_rel_def permute_set_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> eqvt_bound<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FL_Formula-alpha_Tree_eqvt'"><span class="command">lemma</span></span> alpha_Tree_eqvt'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t2</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">p</span> <span class="main">∙</span> <span class="free">t2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alpha_Tree_induct'<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>alpha_tConj <span class="skolem">tset1</span> <span class="skolem">tset2</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"tConj <span class="skolem">tset1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tConj <span class="skolem">tset2</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">tset1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> set_bset <span class="skolem">tset1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">x'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> imageE permute_bset.rep_eq permute_set_eq_image<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">∈</span> set_bset <span class="skolem">tset2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">y'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"*"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> FL_Formula.alpha_tConj rel_bset.rep_eq rel_set_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="skolem">y'</span> <span class="main">∈</span> set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">tset2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_permute_iff set_bset_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> 2 <span class="keyword2"><span class="keyword">and</span></span> 3 <span class="keyword2"><span class="keyword">and</span></span> 4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">y'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> alpha_tConj.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">∈</span>set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">tset2</span><span class="main">)</span><span class="main">.</span> <span class="skolem">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">tset2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">∈</span> set_bset <span class="skolem">tset2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="skolem">y'</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> imageE permute_bset.rep_eq permute_set_eq_image<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> set_bset <span class="skolem">tset1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">y'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"*"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> FL_Formula.alpha_tConj rel_bset.rep_eq rel_set_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="skolem">x'</span> <span class="main">∈</span> set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">tset1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_permute_iff set_bset_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> 2 <span class="keyword2"><span class="keyword">and</span></span> 3 <span class="keyword2"><span class="keyword">and</span></span> 4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="skolem">x'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> alpha_tConj.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span>set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">tset1</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> tConj <span class="skolem">tset1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">p</span> <span class="main">∙</span> tConj <span class="skolem">tset2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_bset_def rel_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> tConj <span class="skolem">tset1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">p</span> <span class="main">∙</span> tConj <span class="skolem">tset2</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_bset <span class="skolem">tset1</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">∈</span> set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">tset1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_permute_iff set_bset_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">∈</span> set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">tset2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">y'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"*"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> FL_Formula.alpha_tConj permute_Tree_tConj rel_bset.rep_eq rel_set_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set_bset <span class="skolem">tset2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> imageE permute_bset.rep_eq permute_set_eq_image<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> 3 <span class="keyword2"><span class="keyword">and</span></span> 4 <span class="keyword2"><span class="keyword">and</span></span> 5 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> alpha_tConj.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> 4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">∈</span>set_bset <span class="skolem">tset2</span><span class="main">.</span> <span class="skolem">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set_bset <span class="skolem">tset2</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="skolem">y</span> <span class="main">∈</span> set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">tset2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_permute_iff set_bset_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">tset1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"*"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> FL_Formula.alpha_tConj permute_Tree_tConj rel_bset.rep_eq rel_set_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_bset <span class="skolem">tset1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> imageE permute_bset.rep_eq permute_set_eq_image<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> 3 <span class="keyword2"><span class="keyword">and</span></span> 4 <span class="keyword2"><span class="keyword">and</span></span> 5 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> alpha_tConj.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> 4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span>set_bset <span class="skolem">tset1</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"tConj <span class="skolem">tset1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tConj <span class="skolem">tset2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_bset_def rel_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>alpha_tAct <span class="skolem">f1</span> <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="skolem">f2</span> <span class="skolem">α2</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> alpha_tAct.IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="skolem">t1</span> <span class="main">=</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">t1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> alpha_Tree_eqvt_aux<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> alpha_tAct.IH<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="skolem">t2</span> <span class="main">=</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> alpha_Tree_eqvt_aux<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"tAct <span class="skolem">f1</span> <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="skolem">f2</span> <span class="skolem">α2</span> <span class="skolem">t2</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f1</span> <span class="main">=</span> <span class="skolem">f2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> <span class="skolem">t1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> <span class="skolem">α1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="skolem">q</span> <span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> <span class="skolem">α2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> t1 <span class="keyword2"><span class="keyword">and</span></span> t2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">-</span> bn <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α1</span><span class="main">)</span> <span class="main">=</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">-</span> bn <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_eqvt alpha_set bn_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> t1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">-</span> bn <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α1</span><span class="main">)</span><span class="main">)</span> <span class="main">♯*</span> <span class="main">(</span><span class="free">p</span> <span class="main">+</span> <span class="skolem">q</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_eqvt alpha_set bn_eqvt fresh_star_permute_iff permute_perm_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> alpha_tAct.IH<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="skolem">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">t2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="main">-</span><span class="free">p</span> <span class="main">∙</span> bn <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α1</span><span class="main">)</span> <span class="main">=</span> bn <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set bn_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α1</span><span class="main">)</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">t1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">+</span> <span class="skolem">q</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>bn <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α2</span><span class="main">)</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α1</span><span class="main">)</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">α1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="main">(</span><span class="free">p</span> <span class="main">+</span> <span class="skolem">q</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>bn <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α2</span><span class="main">)</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">α2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Diff_eqvt bn_eqvt fresh_star_permute_iff permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> permute_perm_def supp_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> tAct <span class="skolem">f1</span> <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">p</span> <span class="main">∙</span> tAct <span class="skolem">f2</span> <span class="skolem">α2</span> <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> tAct <span class="skolem">f1</span> <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">p</span> <span class="main">∙</span> tAct <span class="skolem">f2</span> <span class="skolem">α2</span> <span class="skolem">t2</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f1</span> <span class="main">=</span> <span class="skolem">f2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α1</span><span class="main">)</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">t1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">(</span>bn <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α2</span><span class="main">)</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α1</span><span class="main">)</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">α1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="skolem">q</span> <span class="main">(</span>bn <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α2</span><span class="main">)</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">α2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> t1 <span class="keyword2"><span class="keyword">and</span></span> t2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="skolem">t1</span> <span class="main">-</span> bn <span class="skolem">α1</span> <span class="main">=</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="skolem">t2</span> <span class="main">-</span> bn <span class="skolem">α2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Diff_eqvt alpha_set bn_eqvt permute_eq_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> t2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="skolem">t1</span> <span class="main">-</span> bn <span class="skolem">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="main">(</span><span class="main">-</span> <span class="free">p</span> <span class="main">+</span> <span class="skolem">q</span> <span class="main">+</span> <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_perm alphas<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> DiffI bn_eqvt mem_permute_iff permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">t2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> alpha_tAct.IH<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> permute_eqvt permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="free">p</span> <span class="main">∙</span> bn <span class="skolem">α1</span> <span class="main">=</span> bn <span class="skolem">α2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_set bn_eqvt permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> <span class="skolem">t1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">+</span> <span class="skolem">q</span> <span class="main">+</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="skolem">α1</span> <span class="main">-</span> bn <span class="skolem">α1</span> <span class="main">=</span> supp <span class="skolem">α2</span> <span class="main">-</span> bn <span class="skolem">α2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Diff_eqvt alpha_set bn_eqvt permute_eq_iff supp_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp <span class="skolem">α1</span> <span class="main">-</span> bn <span class="skolem">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">+</span> <span class="skolem">q</span> <span class="main">+</span> <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_perm alphas<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> DiffI bn_eqvt mem_permute_iff permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> supp_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">α1</span> <span class="main">=</span> <span class="skolem">α2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="free">p</span> <span class="main">∙</span> bn <span class="skolem">α1</span> <span class="main">=</span> bn <span class="skolem">α2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bn_eqvt calculation<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> <span class="skolem">α1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">+</span> <span class="skolem">q</span> <span class="main">+</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> <span class="skolem">α2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"tAct <span class="skolem">f1</span> <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="skolem">f2</span> <span class="skolem">α2</span> <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="FL_Formula-alpha_Tree_eqvt"><span class="command">lemma</span></span> alpha_Tree_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t2</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">p</span> <span class="main">∙</span> <span class="free">t2</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_Tree_eqvt'<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> alpha_Tree<span class="antiquote"><span class="antiquote">}</span></span></span></span> is an equivalence relation.›</span></span>

<span class="keyword1" id="FL_Formula-alpha_Tree_reflp"><span class="command">lemma</span></span> alpha_Tree_reflp<span class="main">:</span> <span class="quoted"><span class="quoted">"reflp alpha_Tree"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> reflpI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> Tree"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> tConj <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_tConj rel_bset.rep_eq rel_setI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> tNot <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_tNot<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> tPred <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_tPred<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> tAct <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> alpha_tAct alpha_refl<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FL_Formula-alpha_Tree_symp"><span class="command">lemma</span></span> alpha_Tree_symp<span class="main">:</span> <span class="quoted"><span class="quoted">"symp alpha_Tree"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sympI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> Tree"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alpha_Tree_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> tConj <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_bset_def rel_set_def<span class="main">)</span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tAct <span class="skolem">f1</span> <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="skolem">f2</span> <span class="skolem">α2</span> <span class="skolem">t2</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f1</span><span class="main">=</span><span class="skolem">f2</span> <span class="main">∧</span> <span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> <span class="skolem">t1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> <span class="skolem">α1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="skolem">p</span> <span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> <span class="skolem">α2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f1</span><span class="main">=</span><span class="skolem">f2</span> <span class="main">∧</span> <span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> <span class="skolem">t2</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> <span class="skolem">α2</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="main">(</span><span class="main">-</span><span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> <span class="skolem">α1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tAct.IH <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alpha_Tree_eqvt alpha_sym<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FL_Formula-alpha_Tree_transp"><span class="command">lemma</span></span> alpha_Tree_transp<span class="main">:</span> <span class="quoted"><span class="quoted">"transp alpha_Tree"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> transpI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> Tree"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">z</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">z</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">z</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alpha_Tree_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tConj <span class="skolem">tset_x</span> <span class="skolem">tset_y</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tset_z</span>
        <span class="keyword3"><span class="command">assume</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> tConj <span class="skolem">tset_z</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_bset <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="skolem">tset_x</span> <span class="skolem">tset_z</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> rel_bset.rep_eq rel_set_def Ball_def Bex_def
          <span class="keyword1"><span class="command">proof</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> set_bset <span class="skolem">tset_x</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">z'</span><span class="main">.</span> <span class="bound">z'</span> <span class="main">∈</span> set_bset <span class="skolem">tset_z</span> <span class="main">∧</span> <span class="bound">x'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="bound">z'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span> <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> set_bset <span class="skolem">tset_x</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">∈</span> set_bset <span class="skolem">tset_y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">y'</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rel_bset.rep_eq rel_set_def tConj.hyps<span class="main">)</span>
              <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z'</span> <span class="main">∈</span> set_bset <span class="skolem">tset_z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">z'</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_tConj rel_bset.rep_eq rel_set_def tConj.prems z<span class="main">)</span>
              <span class="keyword1"><span class="command">from</span></span> 1 2 3 5 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">z'</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tConj.IH<span class="main">)</span>
              <span class="keyword1"><span class="command">with</span></span> 4 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z'</span><span class="main">.</span> <span class="bound">z'</span> <span class="main">∈</span> set_bset <span class="skolem">tset_z</span> <span class="main">∧</span> <span class="skolem">x'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="bound">z'</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z'</span><span class="main">.</span> <span class="bound">z'</span> <span class="main">∈</span> set_bset <span class="skolem">tset_z</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> set_bset <span class="skolem">tset_x</span> <span class="main">∧</span> <span class="bound">x'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="bound">z'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z'</span> <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z'</span> <span class="main">∈</span> set_bset <span class="skolem">tset_z</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">∈</span> set_bset <span class="skolem">tset_y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">z'</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_tConj rel_bset.rep_eq rel_set_def tConj.prems z<span class="main">)</span>
              <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> set_bset <span class="skolem">tset_x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">y'</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rel_bset.rep_eq rel_set_def tConj.hyps<span class="main">)</span>
              <span class="keyword1"><span class="command">from</span></span> 4 2 5 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">z'</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tConj.IH<span class="main">)</span>
              <span class="keyword1"><span class="command">with</span></span> 4 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> set_bset <span class="skolem">tset_x</span> <span class="main">∧</span> <span class="bound">x'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">z'</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">with</span></span> z <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"tConj <span class="skolem">tset_x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">z</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> tConj.prems<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> tNot <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> tPred <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tAct <span class="skolem">f1</span> <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="skolem">f2</span> <span class="skolem">α2</span> <span class="skolem">t2</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">t</span>
      <span class="keyword3"><span class="command">assume</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> tAct <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f1</span><span class="main">=</span><span class="skolem">f2</span> <span class="main">∧</span> <span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> <span class="skolem">t1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> <span class="skolem">α1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="skolem">p</span> <span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> <span class="skolem">α2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> tAct.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f2</span><span class="main">=</span><span class="skolem">f</span> <span class="main">∧</span> <span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> <span class="skolem">t2</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">(</span>bn <span class="skolem">α</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> <span class="skolem">α2</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="skolem">q</span> <span class="main">(</span>bn <span class="skolem">α</span><span class="main">,</span> <span class="skolem">α</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> tAct.prems z <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f1</span><span class="main">=</span><span class="skolem">f</span> <span class="main">∧</span> <span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> <span class="skolem">t1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">+</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>bn <span class="skolem">α</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="skolem">t1</span> <span class="main">-</span> bn <span class="skolem">α1</span> <span class="main">=</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="skolem">t</span> <span class="main">-</span> bn <span class="skolem">α</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_set<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="skolem">t1</span> <span class="main">-</span> bn <span class="skolem">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">+</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_set fresh_star_plus<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q</span> <span class="main">+</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">t</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> 2 <span class="keyword2"><span class="keyword">and</span></span> tAct.IH <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alpha_Tree_eqvt alpha_set permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> permute_plus<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q</span> <span class="main">+</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∙</span> bn <span class="skolem">α1</span> <span class="main">=</span> bn <span class="skolem">α</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_set permute_plus<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f1</span><span class="main">=</span><span class="skolem">f</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_set<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> <span class="skolem">α1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="main">(</span><span class="skolem">q</span> <span class="main">+</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>bn <span class="skolem">α</span><span class="main">,</span> <span class="skolem">α</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> alpha_trans<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> permute_plus<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"tAct <span class="skolem">f1</span> <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">z</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> z <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> tAct.prems<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FL_Formula-alpha_Tree_equivp"><span class="command">lemma</span></span> alpha_Tree_equivp<span class="main">:</span> <span class="quoted"><span class="quoted">"equivp alpha_Tree"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> equivpI alpha_Tree_reflp alpha_Tree_symp alpha_Tree_transp<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹$\alpha$-equivalent trees have the same support modulo $\alpha$-equivalence.›</span></span>

<span class="keyword1" id="FL_Formula-alpha_Tree_supp_rel"><span class="command">lemma</span></span> alpha_Tree_supp_rel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t1</span> <span class="main">=</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alpha_Tree_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tConj <span class="skolem">tset1</span> <span class="skolem">tset2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> rel_bset <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟷</span> rel_bset <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="bound">y</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> alpha_Tree_symp bset.rel_symp sympE<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">from</span></span> tConj.hyps <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_bset <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">tset1</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">tset2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_tConj alpha_Tree_eqvt permute_Tree_tConj<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_bset <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">tset1</span><span class="main">)</span> <span class="skolem">tset1</span> <span class="main">⟷</span> rel_bset <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">tset2</span><span class="main">)</span> <span class="skolem">tset2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span> alpha_Tree_transp bset.rel_transp sym tConj.hyps transpE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_rel_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> tNot <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_rel_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tAct <span class="skolem">f1</span> <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="skolem">f2</span> <span class="skolem">α2</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tAct <span class="skolem">f1</span> <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="skolem">f2</span> <span class="skolem">α2</span> <span class="skolem">t2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tAct.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> tAct <span class="skolem">f1</span> <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="skolem">f1</span> <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="main">⟷</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> tAct <span class="skolem">f2</span> <span class="skolem">α2</span> <span class="skolem">t2</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="skolem">f2</span> <span class="skolem">α2</span> <span class="skolem">t2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alpha_Tree_eqvt alpha_Tree_symp alpha_Tree_transp sympE transpE<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_rel_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> tAct<span class="antiquote"><span class="antiquote">}</span></span></span></span> preserves $\alpha$-equivalence.›</span></span>

<span class="keyword1" id="FL_Formula-alpha_Tree_tAct"><span class="command">lemma</span></span> alpha_Tree_tAct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="free">α</span><span class="main">,</span> <span class="free">t1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span>bn <span class="free">α</span><span class="main">,</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_Tree_supp_rel alpha_set fresh_star_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="free">α</span><span class="main">,</span> <span class="free">α</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="main">0</span> <span class="main">(</span>bn <span class="free">α</span><span class="main">,</span> <span class="free">α</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> alpha_refl<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following lemmas describe the support modulo $\alpha$-equivalence.›</span></span>

<span class="keyword1" id="FL_Formula-supp_rel_tNot"><span class="command">lemma</span></span> supp_rel_tNot <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>tNot <span class="free">t</span><span class="main">)</span> <span class="main">=</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> supp_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="FL_Formula-supp_rel_tPred"><span class="command">lemma</span></span> supp_rel_tPred <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>tPred <span class="free">f</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">f</span> <span class="main">∪</span> supp <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> supp_rel_def supp_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_imp_eq Collect_neg_eq<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The support modulo $\alpha$-equivalence of~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"tAct <span class="free"><span class="free">α</span></span> <span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not easily described:
when~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> has infinite support (modulo $\alpha$-equivalence), the support (modulo
$\alpha$-equivalence) of~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"tAct <span class="free"><span class="free">α</span></span> <span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> may still contain names in~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"bn <span class="free"><span class="free">α</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. This
incongruity is avoided when~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> has finite support modulo $\alpha$-equivalence.›</span></span>

<span class="keyword1" id="FL_Formula-infinite_mono"><span class="command">lemma</span></span> infinite_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">T</span><span class="main">)</span> <span class="main">⟹</span> infinite <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> infinite_super subsetI<span class="main">)</span>

<span class="keyword1" id="FL_Formula-supp_rel_tAct"><span class="command">lemma</span></span> supp_rel_tAct <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">f</span> <span class="main">∪</span> <span class="main">(</span>supp <span class="free">α</span> <span class="main">∪</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span> <span class="main">-</span> bn <span class="free">α</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"supp <span class="free">f</span> <span class="main">∪</span> <span class="main">(</span>supp <span class="free">α</span> <span class="main">∪</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span> <span class="main">-</span> bn <span class="free">α</span><span class="main">)</span> <span class="main">⊆</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> supp <span class="free">f</span> <span class="main">∪</span> <span class="main">(</span>supp <span class="free">α</span> <span class="main">∪</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span> <span class="main">-</span> bn <span class="free">α</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> x1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> supp <span class="free">f</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> x1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">f</span> <span class="main">≠</span> <span class="free">f</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span><span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">f</span> <span class="main">≠</span> <span class="free">f</span><span class="main">}</span> <span class="main">-</span> supp <span class="free">f</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_supp<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">f</span> <span class="main">≠</span> <span class="free">f</span><span class="main">}</span> <span class="main">-</span> supp <span class="free">f</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> b1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">f</span> <span class="main">≠</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> supp <span class="free">f</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sort_of <span class="skolem">x</span> <span class="main">=</span> sort_of <span class="skolem">b</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> swap_different_sorts <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> supp <span class="free">f</span> <span class="main">≠</span> supp <span class="free">f</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> b2 x1 <span class="keyword1"><span class="command">using</span></span> swap_set_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> infinite_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> supp_rel_def <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> x1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> supp <span class="free">α</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> bn <span class="free">α</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> x1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span> <span class="main">≠</span> <span class="free">α</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span><span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span> <span class="main">≠</span> <span class="free">α</span><span class="main">}</span> <span class="main">-</span> supp <span class="free">α</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_supp<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span> <span class="main">≠</span> <span class="free">α</span><span class="main">}</span> <span class="main">-</span> supp <span class="free">α</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> b1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span> <span class="main">≠</span> <span class="free">α</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> supp <span class="free">α</span> <span class="main">-</span> bn <span class="free">α</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">from</span></span> b1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sort_of <span class="skolem">x</span> <span class="main">=</span> sort_of <span class="skolem">b</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> swap_different_sorts <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span>supp <span class="free">α</span> <span class="main">-</span> bn <span class="free">α</span><span class="main">)</span> <span class="main">≠</span> supp <span class="free">α</span> <span class="main">-</span> bn <span class="free">α</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> b2 x1 x2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> swap_set_in<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set Diff_eqvt bn_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> infinite_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> supp_rel_def <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> x1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> bn <span class="free">α</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> x1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> supp_rel_def <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span><span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t</span><span class="main">}</span> <span class="main">-</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t</span><span class="main">}</span> <span class="main">-</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> b1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span> <span class="main">-</span> bn <span class="free">α</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">from</span></span> b1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span> <span class="main">≠</span> <span class="free">t</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_Tree_reflp reflpE<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sort_of <span class="skolem">x</span> <span class="main">=</span> sort_of <span class="skolem">b</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> swap_different_sorts <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span> <span class="main">-</span> bn <span class="free">α</span><span class="main">)</span> <span class="main">≠</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span> <span class="main">-</span> bn <span class="free">α</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> b2 x1 x2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> swap_set_in<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span> <span class="main">-</span> bn <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span><span class="main">)</span> <span class="main">≠</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span> <span class="main">-</span> bn <span class="free">α</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Diff_eqvt bn_eqvt<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> infinite_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> supp_rel_def <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">f</span> <span class="main">∪</span> <span class="main">(</span>supp <span class="free">α</span> <span class="main">∪</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span> <span class="main">-</span> bn <span class="free">α</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> supp_rel_def <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">f</span> <span class="main">≠</span> <span class="free">f</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span> <span class="main">≠</span> <span class="free">α</span> <span class="main">∨</span> <span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> alpha_Tree_tAct <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">f</span> <span class="main">≠</span> <span class="free">f</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span> <span class="main">≠</span> <span class="free">α</span> <span class="main">∨</span> <span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> infinite_mono mem_Collect_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">f</span> <span class="main">≠</span> <span class="free">f</span><span class="main">}</span> <span class="main">∨</span> infinite <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span> <span class="main">≠</span> <span class="free">α</span><span class="main">}</span> <span class="main">∨</span> infinite <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> finite_Collect_disjI<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> supp <span class="free">f</span> <span class="main">∪</span> supp <span class="free">α</span> <span class="main">∪</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_def supp_rel_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> bn <span class="free">α</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∉</span> supp <span class="free">f</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"*"</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> b0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> supp <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> supp <span class="free">α</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> UnCI finite_UnI finite_supp infinite_mono mem_Collect_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span> <span class="main">-</span> bn <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span><span class="main">)</span> <span class="main">=</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span> <span class="main">-</span> bn <span class="free">α</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"**"</span> <span class="keyword2"><span class="keyword">and</span></span> b3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Diff_eqvt Diff_iff alpha_Tree_eqvt' alpha_Tree_eqvt_aux bn_eqvt swap_set_not_in<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span> <span class="main">-</span> bn <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span><span class="main">)</span><span class="main">)</span> <span class="main">♯*</span> <span class="var">?p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"**"</span> <span class="keyword2"><span class="keyword">and</span></span> b3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_iff fresh_perm fresh_star_def swap_atom_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">∙</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> alpha_Tree_reflp reflpE <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">∙</span> bn <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span><span class="main">)</span> <span class="main">=</span> bn <span class="free">α</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bn_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span><span class="main">)</span> <span class="main">-</span> bn <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">α</span> <span class="main">-</span> bn <span class="free">α</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"**"</span> <span class="keyword2"><span class="keyword">and</span></span> b2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Diff_eqvt Diff_iff bn_eqvt supp_eqvt swap_set_not_in<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span><span class="main">)</span> <span class="main">-</span> bn <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span><span class="main">)</span><span class="main">)</span> <span class="main">♯*</span> <span class="var">?p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"**"</span> <span class="keyword2"><span class="keyword">and</span></span> b2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_def supp_perm<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Diff_iff swap_atom_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">∙</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span> <span class="main">=</span> <span class="free">α</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>bn <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="bound">p</span> <span class="main">(</span>bn <span class="free">α</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∧</span>
                           <span class="main">(</span>bn <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">α</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="bound">p</span> <span class="main">(</span>bn <span class="free">α</span><span class="main">,</span> <span class="free">α</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set.simps<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"**"</span> <span class="keyword2"><span class="keyword">and</span></span> b1
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_def swap_fresh_fresh<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="free">f</span> <span class="free">α</span> <span class="free">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> b0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> supp <span class="free">f</span> <span class="main">∪</span> <span class="main">(</span>supp <span class="free">α</span> <span class="main">∪</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="free">t</span> <span class="main">-</span> bn <span class="free">α</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define the type of (infinitely branching) trees quotiented by $\alpha$-equivalence.›</span></span>

<span class="comment1">(* FIXME: No map function defined. No relator found. *)</span>
<span class="keyword1"><span class="command">quotient_type</span></span>
  <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'eff</span><span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>pt<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">,</span><span class="tfree">'eff</span><span class="main">::</span>fs<span class="main">)</span> Tree"</span></span> <span class="main">/</span> <span class="quoted"><span class="quoted">"alpha_Tree"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> alpha_Tree_equivp<span class="main">)</span>

<span class="keyword1" id="FL_Formula-Tree"><span class="command">lemma</span></span> Tree<span class="hidden">⇩</span><sub>α</sub>_abs_rep <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"abs_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Quotient_Tree<span class="hidden">⇩</span><sub>α</sub> Quotient_abs_rep<span class="main">)</span>

<span class="keyword1" id="FL_Formula-Tree"><span class="command">lemma</span></span> Tree<span class="hidden">⇩</span><sub>α</sub>_rep_abs <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>abs_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">t</span><span class="main">)</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff Tree<span class="hidden">⇩</span><sub>α</sub>_abs_rep<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The permutation operation is lifted from trees.›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">pt</span><span class="main">,</span> <span class="quoted">bn</span><span class="main">,</span> <span class="quoted">fs</span><span class="main">)</span> <span class="quoted">pt</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">permute_Tree<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"perm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub>"</span></span>
    <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">permute</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> alpha_Tree_eqvt<span class="main">)</span>

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∙</span> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">metis</span> alpha_Tree_equivp equivp_reflp permute_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">::</span> <span class="quoted">perm</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">+</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">metis</span> alpha_Tree_equivp equivp_reflp permute_plus<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The abstraction function from trees to trees modulo $\alpha$-equivalence is equivariant. The
representation function is equivariant modulo $\alpha$-equivalence.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> permute_Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq <span class="main">[</span><span class="operator">eqvt</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span>

<span class="keyword1" id="FL_Formula-alpha_Tree_permute_rep_commute"><span class="command">lemma</span></span> alpha_Tree_permute_rep_commute <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff Tree<span class="hidden">⇩</span><sub>α</sub>_abs_rep permute_Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Constructors for trees modulo \texorpdfstring{$\alpha$}{alpha}-equivalence›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The constructors are lifted from trees.›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> Conj<span class="hidden">⇩</span><sub>α</sub> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'eff</span><span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>pt<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">,</span><span class="tfree">'eff</span><span class="main">::</span>fs<span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted">tConj</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="FL_Formula-map_bset_abs_rep_Tree"><span class="command">lemma</span></span> map_bset_abs_rep_Tree<span class="hidden">⇩</span><sub>α</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"map_bset abs_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Quotient_Tree<span class="hidden">⇩</span><sub>α</sub> Quotient_abs_rep bset_lifting.bset_quot_map<span class="main">)</span>

<span class="keyword1" id="FL_Formula-Conj"><span class="command">lemma</span></span> Conj<span class="hidden">⇩</span><sub>α</sub>_def'<span class="main">:</span> <span class="quoted"><span class="quoted">"Conj<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> abs_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>tConj <span class="main">(</span>map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Conj<span class="hidden">⇩</span><sub>α</sub>.abs_eq map_bset_abs_rep_Tree<span class="hidden">⇩</span><sub>α</sub><span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> Not<span class="hidden">⇩</span><sub>α</sub> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'eff</span><span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>pt<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">,</span><span class="tfree">'eff</span><span class="main">::</span>fs<span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted">tNot</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lift_definition</span></span> Pred<span class="hidden">⇩</span><sub>α</sub> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'eff</span> <span class="main">⇒</span> <span class="tfree">'pred</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>pt<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">,</span><span class="tfree">'eff</span><span class="main">::</span>fs<span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted">tPred</span>
<span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'eff</span> <span class="main">⇒</span> <span class="tfree">'act</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'eff</span><span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>pt<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">,</span><span class="tfree">'eff</span><span class="main">::</span>fs<span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted">tAct</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> alpha_Tree_tAct<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The lifted constructors are equivariant.›</span></span>

<span class="keyword1" id="FL_Formula-Conj"><span class="command">lemma</span></span> Conj<span class="hidden">⇩</span><sub>α</sub>_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Conj<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> Conj<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set_bset <span class="main">(</span>map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> imageE permute_bset.rep_eq permute_set_eq_image<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">∈</span> set_bset <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∙</span> rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> imageE map_bset.rep_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">∈</span> set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_permute_iff permute_bset.rep_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x'</span> <span class="main">∈</span> set_bset <span class="main">(</span>map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bset.set_map<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="var">?x'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_Tree_permute_rep_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x'</span><span class="main">∈</span>set_bset <span class="main">(</span>map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="bound">x'</span>"</span></span>
      <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set_bset <span class="main">(</span>map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> imageE map_bset.rep_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">∈</span> set_bset <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> imageE permute_bset.rep_eq permute_set_eq_image<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">∈</span> set_bset <span class="main">(</span>map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bset.set_map<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y'</span> <span class="main">∈</span> set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_permute_iff permute_bset.rep_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_Tree_permute_rep_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y'</span><span class="main">∈</span>set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span><span class="main">.</span> <span class="bound">y'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Conj<span class="hidden">⇩</span><sub>α</sub>_def' map_bset_eqvt rel_bset_def rel_set_def Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FL_Formula-Not"><span class="command">lemma</span></span> Not<span class="hidden">⇩</span><sub>α</sub>_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Not<span class="hidden">⇩</span><sub>α</sub> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> Not<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t<span class="hidden">⇩</span><sub>α</sub></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Not<span class="hidden">⇩</span><sub>α</sub>.abs_eq<span class="main">)</span>

<span class="keyword1" id="FL_Formula-Pred"><span class="command">lemma</span></span> Pred<span class="hidden">⇩</span><sub>α</sub>_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free">f</span> <span class="free">φ</span> <span class="main">=</span> Pred<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Pred<span class="hidden">⇩</span><sub>α</sub>.abs_eq<span class="main">)</span>

<span class="keyword1" id="FL_Formula-Act"><span class="command">lemma</span></span> Act<span class="hidden">⇩</span><sub>α</sub>_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">f</span> <span class="free">α</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">α</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t<span class="hidden">⇩</span><sub>α</sub></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Act<span class="hidden">⇩</span><sub>α</sub>.abs_eq<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The lifted constructors are injective (except for~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Act<span class="hidden">⇩</span><sub>α</sub><span class="antiquote"><span class="antiquote">}</span></span></span></span>).›</span></span>

<span class="keyword1" id="FL_Formula-Conj"><span class="command">lemma</span></span> Conj<span class="hidden">⇩</span><sub>α</sub>_eq_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Conj<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset1<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> Conj<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset2<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">⟷</span> <span class="free">tset1<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> <span class="free">tset2<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Conj<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset1<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> Conj<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset2<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tConj <span class="main">(</span>map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset1<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tConj <span class="main">(</span>map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset2<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Conj<span class="hidden">⇩</span><sub>α</sub>_def' Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_bset <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset1<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">(</span>map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset2<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> alpha_Tree.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">tset1<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> <span class="free">tset2<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Quotient_Tree<span class="hidden">⇩</span><sub>α</sub> Quotient_rel_abs2 bset_lifting.bset_quot_map map_bset_abs_rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">fact</span> arg_cong<span class="main">)</span>

<span class="keyword1" id="FL_Formula-Not"><span class="command">lemma</span></span> Not<span class="hidden">⇩</span><sub>α</sub>_eq_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Not<span class="hidden">⇩</span><sub>α</sub> <span class="free">t1<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> Not<span class="hidden">⇩</span><sub>α</sub> <span class="free">t2<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">⟷</span> <span class="free">t1<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> <span class="free">t2<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Not<span class="hidden">⇩</span><sub>α</sub> <span class="free">t1<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> Not<span class="hidden">⇩</span><sub>α</sub> <span class="free">t2<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tNot <span class="main">(</span>rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">t1<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tNot <span class="main">(</span>rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">t2<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Not<span class="hidden">⇩</span><sub>α</sub>.abs_eq Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff Tree<span class="hidden">⇩</span><sub>α</sub>_abs_rep<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">t1<span class="hidden">⇩</span><sub>α</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">t2<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> alpha_Tree.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">t1<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> <span class="free">t2<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff Tree<span class="hidden">⇩</span><sub>α</sub>_abs_rep<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">t1<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> <span class="free">t2<span class="hidden">⇩</span><sub>α</sub></span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Not<span class="hidden">⇩</span><sub>α</sub> <span class="free">t1<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> Not<span class="hidden">⇩</span><sub>α</sub> <span class="free">t2<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FL_Formula-Pred"><span class="command">lemma</span></span> Pred<span class="hidden">⇩</span><sub>α</sub>_eq_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free">f1</span> <span class="free">φ1</span> <span class="main">=</span> Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free">f2</span> <span class="free">φ2</span> <span class="main">⟷</span> <span class="free">f1</span> <span class="main">=</span> <span class="free">f2</span> <span class="main">∧</span> <span class="free">φ1</span> <span class="main">=</span> <span class="free">φ2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free">f1</span> <span class="free">φ1</span> <span class="main">=</span> Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free">f2</span> <span class="free">φ2</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>tPred <span class="free">f1</span> <span class="free">φ1</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> Tree<span class="main">)</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tPred <span class="free">f2</span> <span class="free">φ2</span>"</span></span>  <span class="comment1">― ‹note the unrelated type›</span> <span class="comment1">(* WHY? *)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pred<span class="hidden">⇩</span><sub>α</sub>.abs_eq Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f1</span> <span class="main">=</span> <span class="free">f2</span> <span class="main">∧</span> <span class="free">φ1</span> <span class="main">=</span> <span class="free">φ2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> alpha_Tree.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">f1</span> <span class="main">=</span> <span class="free">f2</span> <span class="main">∧</span> <span class="free">φ1</span> <span class="main">=</span> <span class="free">φ2</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free">f1</span> <span class="free">φ1</span> <span class="main">=</span> Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free">f2</span> <span class="free">φ2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FL_Formula-Act"><span class="command">lemma</span></span> Act<span class="hidden">⇩</span><sub>α</sub>_eq_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">f1</span> <span class="free">α1</span> <span class="free">t1</span> <span class="main">=</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">f2</span> <span class="free">α2</span> <span class="free">t2</span> <span class="main">⟷</span> tAct <span class="free">f1</span> <span class="free">α1</span> <span class="main">(</span>rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">t1</span><span class="main">)</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="free">f2</span> <span class="free">α2</span> <span class="main">(</span>rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">t2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act<span class="hidden">⇩</span><sub>α</sub>.abs_eq Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff Tree<span class="hidden">⇩</span><sub>α</sub>_abs_rep<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The lifted constructors are free (except for~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Act<span class="hidden">⇩</span><sub>α</sub><span class="antiquote"><span class="antiquote">}</span></span></span></span>).›</span></span>

<span class="keyword1" id="FL_Formula-Tree"><span class="command">lemma</span></span> Tree<span class="hidden">⇩</span><sub>α</sub>_free <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Conj<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">≠</span> Not<span class="hidden">⇩</span><sub>α</sub> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Conj<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">≠</span> Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free">f</span> <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Conj<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">≠</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">f</span> <span class="free">α</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Not<span class="hidden">⇩</span><sub>α</sub> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">≠</span> Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free">f</span> <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Not<span class="hidden">⇩</span><sub>α</sub> <span class="free">t1<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">≠</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">f</span> <span class="free">α</span> <span class="free">t2<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free">f1</span> <span class="free">φ</span> <span class="main">≠</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">f2</span> <span class="free">α</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Conj<span class="hidden">⇩</span><sub>α</sub>_def' Not<span class="hidden">⇩</span><sub>α</sub>_def Pred<span class="hidden">⇩</span><sub>α</sub>_def Act<span class="hidden">⇩</span><sub>α</sub>_def Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following lemmas describe the support of constructed trees modulo $\alpha$-equivalence.›</span></span>

<span class="keyword1" id="FL_Formula-supp_alpha_supp_rel"><span class="command">lemma</span></span> supp_alpha_supp_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> supp_def supp_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Collect_cong Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff Tree<span class="hidden">⇩</span><sub>α</sub>_abs_rep alpha_Tree_permute_rep_commute<span class="main">)</span>

<span class="keyword1" id="FL_Formula-supp_Conj"><span class="command">lemma</span></span> supp_Conj<span class="hidden">⇩</span><sub>α</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Conj<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">=</span> supp <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="FL_Formula-supp_Not"><span class="command">lemma</span></span> supp_Not<span class="hidden">⇩</span><sub>α</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Not<span class="hidden">⇩</span><sub>α</sub> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">=</span> supp <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="FL_Formula-supp_Pred"><span class="command">lemma</span></span> supp_Pred<span class="hidden">⇩</span><sub>α</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free">f</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">f</span> <span class="main">∪</span> supp <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_imp_eq Collect_neg_eq<span class="main">)</span>

<span class="keyword1" id="FL_Formula-supp_Act"><span class="command">lemma</span></span> supp_Act<span class="hidden">⇩</span><sub>α</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">f</span> <span class="free">α</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">=</span> supp <span class="free">f</span> <span class="main">∪</span> <span class="main">(</span>supp <span class="free">α</span> <span class="main">∪</span> supp <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">-</span> bn <span class="free">α</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act<span class="hidden">⇩</span><sub>α</sub>.abs_eq Tree<span class="hidden">⇩</span><sub>α</sub>_abs_rep Tree<span class="hidden">⇩</span><sub>α</sub>_rep_abs alpha_Tree_supp_rel supp_alpha_supp_rel supp_rel_tAct<span class="main">)</span> <span class="comment1">(* Patience *)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Induction over trees modulo \texorpdfstring{$\alpha$}{alpha}-equivalence›</span></span>

<span class="keyword1" id="FL_Formula-Tree"><span class="command">lemma</span></span> Tree<span class="hidden">⇩</span><sub>α</sub>_induct <span class="main">[</span><span class="operator">case_names</span> Conj<span class="hidden">⇩</span><sub>α</sub> Not<span class="hidden">⇩</span><sub>α</sub> Pred<span class="hidden">⇩</span><sub>α</sub> Act<span class="hidden">⇩</span><sub>α</sub> Env<span class="hidden">⇩</span><sub>α</sub><span class="main">,</span> <span class="operator">induct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">type</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> Tree<span class="hidden">⇩</span><sub>α</sub><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set_bset <span class="bound">tset<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Conj<span class="hidden">⇩</span><sub>α</sub> <span class="bound">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">.</span> <span class="free">P</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Not<span class="hidden">⇩</span><sub>α</sub> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">pred</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Pred<span class="hidden">⇩</span><sub>α</sub> <span class="bound">f</span> <span class="bound">pred</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">act</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">.</span> <span class="free">P</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Act<span class="hidden">⇩</span><sub>α</sub> <span class="bound">f</span> <span class="bound">act</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Tree<span class="hidden">⇩</span><sub>α</sub>.abs_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>abs_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tConj <span class="skolem">tset</span><span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?tset<span class="hidden">⇩</span><sub>α</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_bset abs_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="skolem">tset</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>tConj <span class="skolem">tset</span><span class="main">)</span> <span class="main">=</span> Conj<span class="hidden">⇩</span><sub>α</sub> <span class="var">?tset<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Conj<span class="hidden">⇩</span><sub>α</sub>.abs_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> tConj.IH <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> imageE map_bset.rep_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> tNot <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Not<span class="hidden">⇩</span><sub>α</sub>.abs_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> tPred <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pred<span class="hidden">⇩</span><sub>α</sub>.abs_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> tAct <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act<span class="hidden">⇩</span><sub>α</sub>.abs_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There is no (obvious) strong induction principle for trees modulo $\alpha$-equivalence: since
their support may be infinite, we may not be able to rename bound variables without also renaming
free variables.›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Hereditarily finitely supported trees›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We cannot obtain the type of infinitary formulas simply as the sub-type of all trees (modulo
$\alpha$-equivalence) that are finitely supported: since an infinite set of trees may be finitely
supported even though its members are not (and thus, would not be formulas), the sub-type of
\emph{all} finitely supported trees does not validate the induction principle that we desire for
formulas.

Instead, we define \emph{hereditarily} finitely supported trees. We require that environments and
state predicates are finitely supported.›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">hereditarily_fs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>fs<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">,</span><span class="tfree">'eff</span><span class="main">::</span>fs<span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  Conj<span class="hidden">⇩</span><sub>α</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free"><span class="bound"><span class="entity">tset<span class="hidden">⇩</span><sub>α</sub></span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">.</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">∈</span> set_bset <span class="free"><span class="bound"><span class="entity">tset<span class="hidden">⇩</span><sub>α</sub></span></span></span> <span class="main">⟹</span> <span class="free">hereditarily_fs</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">hereditarily_fs</span> <span class="main">(</span>Conj<span class="hidden">⇩</span><sub>α</sub> <span class="free"><span class="bound"><span class="entity">tset<span class="hidden">⇩</span><sub>α</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Not<span class="hidden">⇩</span><sub>α</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">hereditarily_fs</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>α</sub></span></span></span> <span class="main">⟹</span> <span class="free">hereditarily_fs</span> <span class="main">(</span>Not<span class="hidden">⇩</span><sub>α</sub> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>α</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Pred<span class="hidden">⇩</span><sub>α</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">hereditarily_fs</span> <span class="main">(</span>Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Act<span class="hidden">⇩</span><sub>α</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">hereditarily_fs</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>α</sub></span></span></span> <span class="main">⟹</span> <span class="free">hereditarily_fs</span> <span class="main">(</span>Act<span class="hidden">⇩</span><sub>α</sub> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>α</sub></span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> hereditarily_fs<span class="antiquote"><span class="antiquote">}</span></span></span></span> is equivariant.›</span></span>

<span class="keyword1" id="FL_Formula-hereditarily_fs_eqvt"><span class="command">lemma</span></span> hereditarily_fs_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> hereditarily_fs.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Conj<span class="hidden">⇩</span><sub>α</sub> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Conj<span class="hidden">⇩</span><sub>α</sub>_eqvt hereditarily_fs.Conj<span class="hidden">⇩</span><sub>α</sub> mem_permute_iff permute_finite permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> set_bset_eqvt supp_eqvt<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Not<span class="hidden">⇩</span><sub>α</sub> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Not<span class="hidden">⇩</span><sub>α</sub>_eqvt hereditarily_fs.Not<span class="hidden">⇩</span><sub>α</sub><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Pred<span class="hidden">⇩</span><sub>α</sub> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pred<span class="hidden">⇩</span><sub>α</sub>_eqvt hereditarily_fs.Pred<span class="hidden">⇩</span><sub>α</sub><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act<span class="hidden">⇩</span><sub>α</sub>_eqvt hereditarily_fs.Act<span class="hidden">⇩</span><sub>α</sub><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> hereditarily_fs<span class="antiquote"><span class="antiquote">}</span></span></span></span> is preserved under $\alpha$-renaming.›</span></span>

<span class="keyword1" id="FL_Formula-hereditarily_fs_alpha_renaming"><span class="command">lemma</span></span> hereditarily_fs_alpha_renaming<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">f</span> <span class="free">α</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">f'</span> <span class="free">α'</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub>'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">⟷</span> hereditarily_fs <span class="free">t<span class="hidden">⇩</span><sub>α</sub>'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="free">t<span class="hidden">⇩</span><sub>α</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Act<span class="hidden">⇩</span><sub>α</sub>_def Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff alphas<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff Tree<span class="hidden">⇩</span><sub>α</sub>_abs_rep hereditarily_fs_eqvt permute_Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="free">t<span class="hidden">⇩</span><sub>α</sub>'</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Act<span class="hidden">⇩</span><sub>α</sub>_def Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff alphas<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff Tree<span class="hidden">⇩</span><sub>α</sub>_abs_rep hereditarily_fs_eqvt permute_Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Hereditarily finitely supported trees have finite support.›</span></span>

<span class="keyword1" id="FL_Formula-hereditarily_fs_implies_finite_supp"><span class="command">lemma</span></span> hereditarily_fs_implies_finite_supp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> hereditarily_fs.induct<span class="main">)</span>  <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_supp<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Infinitary formulas›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now, infinitary formulas are simply the sub-type of hereditarily finitely supported trees.›</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span><span class="quoted">fs</span><span class="main">,</span><span class="tfree">'act</span><span class="main">::</span><span class="quoted">bn</span><span class="main">,</span><span class="tfree">'eff</span><span class="main">::</span><span class="quoted">fs</span><span class="main">)</span> formula <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">::</span><span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'eff</span><span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub><span class="main">.</span> hereditarily_fs <span class="bound">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hereditarily_fs.Pred<span class="hidden">⇩</span><sub>α</sub> mem_Collect_eq<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We set up Isabelle's lifting infrastructure so that we can lift definitions from the type of
trees modulo $\alpha$-equivalence to the sub-type of formulas.›</span></span>

<span class="comment1">(* FIXME: No relator found. *)</span>
<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_formula

<span class="keyword1" id="FL_Formula-Abs_formula_inverse"><span class="command">lemma</span></span> Abs_formula_inverse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Rep_formula <span class="main">(</span>Abs_formula <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Abs_formula_inverse mem_Collect_eq<span class="main">)</span>

<span class="keyword1" id="FL_Formula-Rep_formula'"><span class="command">lemma</span></span> Rep_formula' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="main">(</span>Rep_formula <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Rep_formula mem_Collect_eq<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we lift the permutation operation.›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> formula <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">fs</span><span class="main">,</span> <span class="quoted">bn</span><span class="main">,</span> <span class="quoted">fs</span><span class="main">)</span> <span class="quoted">pt</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">permute_formula</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"perm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> formula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> formula"</span></span>
    <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">permute</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> hereditarily_fs_eqvt<span class="main">)</span>

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The abstraction and representation functions for formulas are equivariant, and they preserve
support.›</span></span>

<span class="keyword1" id="FL_Formula-Abs_formula_eqvt"><span class="command">lemma</span></span> Abs_formula_eqvt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Abs_formula <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> Abs_formula <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms eq_onp_same_args permute_formula.abs_eq<span class="main">)</span>

<span class="keyword1" id="FL_Formula-supp_Abs_formula"><span class="command">lemma</span></span> supp_Abs_formula <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Abs_formula <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">=</span> supp <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted">perm</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> Abs_formula <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> Abs_formula <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Abs_formula_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hereditarily_fs_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> Abs_formula <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> Abs_formula <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">⟷</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Abs_formula_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> Rep_formula_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> permute_formula.rep_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>

<span class="keyword1" id="FL_Formula-supp_Rep_formula"><span class="command">lemma</span></span> supp_Rep_formula <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Rep_formula <span class="free">x</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Rep_formula' Rep_formula_inverse supp_Abs_formula<span class="main">)</span>

<span class="keyword1" id="FL_Formula-supp_map_bset_Rep_formula"><span class="command">lemma</span></span> supp_map_bset_Rep_formula <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>map_bset Rep_formula <span class="free">xset</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">xset</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eqvt <span class="main">(</span>map_bset Rep_formula<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eqvt_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>map_bset Rep_formula <span class="free">xset</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">xset</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> supp_fun_app_eqvt<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">atom</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span>map_bset Rep_formula<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bset.inj_map Rep_formula_inject injI<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">⟹</span> map_bset Rep_formula <span class="bound">x</span> <span class="main">≠</span> map_bset Rep_formula <span class="bound">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inj_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">xset</span> <span class="main">≠</span> <span class="free">xset</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> map_bset Rep_formula <span class="free">xset</span> <span class="main">≠</span> map_bset Rep_formula <span class="free">xset</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">⊆</span> <span class="var">?T</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="var">?S</span> <span class="main">⟹</span> infinite <span class="var">?T</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> infinite_super<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"supp <span class="free">xset</span> <span class="main">⊆</span> supp <span class="main">(</span>map_bset Rep_formula <span class="free">xset</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Formulas are in fact finitely supported.›</span></span>

<span class="keyword1"><span class="command">instance</span></span> formula <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">fs</span><span class="main">,</span> <span class="quoted">bn</span><span class="main">,</span> <span class="quoted">fs</span><span class="main">)</span> <span class="quoted">fs</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">metis</span> Rep_formula' hereditarily_fs_implies_finite_supp supp_Rep_formula<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Constructors for infinitary formulas›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We lift the constructors for trees (modulo $\alpha$-equivalence) to infinitary formulas.
Since~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Conj<span class="hidden">⇩</span><sub>α</sub><span class="antiquote"><span class="antiquote">}</span></span></span></span> does not necessarily yield a (hereditarily) finitely supported tree when
applied to a (potentially infinite) set of (hereditarily) finitely supported trees, we cannot use
Isabelle's {\bf lift\_definition} to define~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Conj</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Instead, theorems about terms of the
form~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Conj</span></span> <span class="free"><span class="free">xset</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> will usually carry an assumption that~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xset</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is finitely supported.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Conj</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'eff</span><span class="main">)</span> formula <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>fs<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">,</span><span class="tfree">'eff</span><span class="main">::</span>fs<span class="main">)</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Conj</span> <span class="free"><span class="bound"><span class="entity">xset</span></span></span> <span class="main">=</span> Abs_formula <span class="main">(</span>Conj<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>map_bset Rep_formula <span class="free"><span class="bound"><span class="entity">xset</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="FL_Formula-finite_supp_implies_hereditarily_fs_Conj"><span class="command">lemma</span></span> finite_supp_implies_hereditarily_fs_Conj<span class="hidden">⇩</span><sub>α</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="main">(</span>Conj<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>map_bset Rep_formula <span class="free">xset</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> hereditarily_fs.Conj<span class="hidden">⇩</span><sub>α</sub><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>map_bset Rep_formula <span class="free">xset</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> supp_map_bset_Rep_formula<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">∈</span> set_bset <span class="main">(</span>map_bset Rep_formula <span class="free">xset</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bset.set_map<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FL_Formula-Conj_rep_eq"><span class="command">lemma</span></span> Conj_rep_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Rep_formula <span class="main">(</span>Conj <span class="free">xset</span><span class="main">)</span> <span class="main">=</span> Conj<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>map_bset Rep_formula <span class="free">xset</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Conj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lift_definition</span></span> Not <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'eff</span><span class="main">)</span> formula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>fs<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">,</span><span class="tfree">'eff</span><span class="main">::</span>fs<span class="main">)</span> formula"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted">Not<span class="hidden">⇩</span><sub>α</sub></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> hereditarily_fs.Not<span class="hidden">⇩</span><sub>α</sub><span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> Pred <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'eff</span> <span class="main">⇒</span> <span class="tfree">'pred</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>fs<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">,</span><span class="tfree">'eff</span><span class="main">::</span>fs<span class="main">)</span> formula"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted">Pred<span class="hidden">⇩</span><sub>α</sub></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> hereditarily_fs.Pred<span class="hidden">⇩</span><sub>α</sub><span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> Act <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'eff</span> <span class="main">⇒</span> <span class="tfree">'act</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'eff</span><span class="main">)</span> formula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>fs<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">,</span><span class="tfree">'eff</span><span class="main">::</span>fs<span class="main">)</span> formula"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted">Act<span class="hidden">⇩</span><sub>α</sub></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> hereditarily_fs.Act<span class="hidden">⇩</span><sub>α</sub><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The lifted constructors are equivariant (in the case of~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Conj<span class="antiquote"><span class="antiquote">}</span></span></span></span>, on finitely supported
arguments).›</span></span>

<span class="keyword1" id="FL_Formula-Conj_eqvt"><span class="command">lemma</span></span> Conj_eqvt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Conj <span class="free">xset</span> <span class="main">=</span> Conj <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">xset</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Conj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="FL_Formula-Not_eqvt"><span class="command">lemma</span></span> Not_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Not <span class="free">x</span> <span class="main">=</span> Not <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="FL_Formula-Pred_eqvt"><span class="command">lemma</span></span> Pred_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Pred <span class="free">f</span> <span class="free">φ</span> <span class="main">=</span> Pred <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="FL_Formula-Act_eqvt"><span class="command">lemma</span></span> Act_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Act <span class="free">f</span> <span class="free">α</span> <span class="free">x</span> <span class="main">=</span> Act <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">α</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following lemmas describe the support of constructed formulas.›</span></span>

<span class="keyword1" id="FL_Formula-supp_Conj"><span class="command">lemma</span></span> supp_Conj <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Conj <span class="free">xset</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">xset</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Conj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="FL_Formula-supp_Not"><span class="command">lemma</span></span> supp_Not <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Not <span class="free">x</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Not.rep_eq supp_Not<span class="hidden">⇩</span><sub>α</sub> supp_Rep_formula<span class="main">)</span>

<span class="keyword1" id="FL_Formula-supp_Pred"><span class="command">lemma</span></span> supp_Pred <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Pred <span class="free">f</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">f</span> <span class="main">∪</span> supp <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pred.rep_eq supp_Pred<span class="hidden">⇩</span><sub>α</sub> supp_Rep_formula<span class="main">)</span>

<span class="keyword1" id="FL_Formula-supp_Act"><span class="command">lemma</span></span> supp_Act <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Act <span class="free">f</span> <span class="free">α</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">f</span> <span class="main">∪</span> <span class="main">(</span>supp <span class="free">α</span> <span class="main">∪</span> supp <span class="free">x</span> <span class="main">-</span> bn <span class="free">α</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act.rep_eq finite_supp supp_Act<span class="hidden">⇩</span><sub>α</sub> supp_Rep_formula<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The lifted constructors are injective (partially for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Act<span class="antiquote"><span class="antiquote">}</span></span></span></span>).›</span></span>

<span class="keyword1" id="FL_Formula-Conj_eq_iff"><span class="command">lemma</span></span> Conj_eq_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Conj <span class="free">xset1</span> <span class="main">=</span> Conj <span class="free">xset2</span> <span class="main">⟷</span> <span class="free">xset1</span> <span class="main">=</span> <span class="free">xset2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Conj<span class="hidden">⇩</span><sub>α</sub>_eq_iff Conj_rep_eq Rep_formula_inverse injI inj_eq bset.inj_map<span class="main">)</span>

<span class="keyword1" id="FL_Formula-Not_eq_iff"><span class="command">lemma</span></span> Not_eq_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Not <span class="free">x1</span> <span class="main">=</span> Not <span class="free">x2</span> <span class="main">⟷</span> <span class="free">x1</span> <span class="main">=</span> <span class="free">x2</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Not.rep_eq Not<span class="hidden">⇩</span><sub>α</sub>_eq_iff Rep_formula_inverse<span class="main">)</span>

<span class="keyword1" id="FL_Formula-Pred_eq_iff"><span class="command">lemma</span></span> Pred_eq_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Pred <span class="free">f1</span> <span class="free">φ1</span> <span class="main">=</span> Pred <span class="free">f2</span> <span class="free">φ2</span> <span class="main">⟷</span> <span class="free">f1</span> <span class="main">=</span> <span class="free">f2</span> <span class="main">∧</span> <span class="free">φ1</span> <span class="main">=</span> <span class="free">φ2</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pred.rep_eq Pred<span class="hidden">⇩</span><sub>α</sub>_eq_iff<span class="main">)</span>

<span class="keyword1" id="FL_Formula-Act_eq_iff"><span class="command">lemma</span></span> Act_eq_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"Act <span class="free">f1</span> <span class="free">α1</span> <span class="free">x1</span> <span class="main">=</span> Act <span class="free">f2</span> <span class="free">α2</span> <span class="free">x2</span> <span class="main">⟷</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">f1</span> <span class="free">α1</span> <span class="main">(</span>Rep_formula <span class="free">x1</span><span class="main">)</span> <span class="main">=</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">f2</span> <span class="free">α2</span> <span class="main">(</span>Rep_formula <span class="free">x2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act.rep_eq Rep_formula_inverse<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Helpful lemmas for dealing with equalities involving~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Act<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1" id="FL_Formula-Act_eq_iff_perm"><span class="command">lemma</span></span> Act_eq_iff_perm<span class="main">:</span> <span class="quoted"><span class="quoted">"Act <span class="free">f1</span> <span class="free">α1</span> <span class="free">x1</span> <span class="main">=</span> Act <span class="free">f2</span> <span class="free">α2</span> <span class="free">x2</span> <span class="main">⟷</span>
  <span class="free">f1</span> <span class="main">=</span> <span class="free">f2</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> supp <span class="free">x1</span> <span class="main">-</span> bn <span class="free">α1</span> <span class="main">=</span> supp <span class="free">x2</span> <span class="main">-</span> bn <span class="free">α2</span> <span class="main">∧</span> <span class="main">(</span>supp <span class="free">x1</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∙</span> <span class="free">x1</span> <span class="main">=</span> <span class="free">x2</span> <span class="main">∧</span> supp <span class="free">α1</span> <span class="main">-</span> bn <span class="free">α1</span> <span class="main">=</span> supp <span class="free">α2</span> <span class="main">-</span> bn <span class="free">α2</span> <span class="main">∧</span> <span class="main">(</span>supp <span class="free">α1</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∙</span> <span class="free">α1</span> <span class="main">=</span> <span class="free">α2</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">⟷</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?l</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f1</span> <span class="main">=</span> <span class="free">f2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act_eq_iff Act<span class="hidden">⇩</span><sub>α</sub>_eq_iff alpha_tAct<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> * <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> alpha<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="free">α1</span><span class="main">,</span> rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>Rep_formula <span class="free">x1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">(</span>bn <span class="free">α2</span><span class="main">,</span> rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>Rep_formula <span class="free">x2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="free">α1</span><span class="main">,</span> <span class="free">α1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="skolem">p</span> <span class="main">(</span>bn <span class="free">α2</span><span class="main">,</span> <span class="free">α2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act_eq_iff Act<span class="hidden">⇩</span><sub>α</sub>_eq_iff alpha_tAct<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> alpha <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="free">x1</span> <span class="main">-</span> bn <span class="free">α1</span> <span class="main">=</span> supp <span class="free">x2</span> <span class="main">-</span> bn <span class="free">α2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_set.simps supp_Rep_formula supp_alpha_supp_rel<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> alpha <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp <span class="free">x1</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_set.simps supp_Rep_formula supp_alpha_supp_rel<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> alpha <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="free">x1</span> <span class="main">=</span> <span class="free">x2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Rep_formula_eqvt Rep_formula_inject Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff Tree<span class="hidden">⇩</span><sub>α</sub>_abs_rep alpha_Tree_permute_rep_commute alpha_set.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="free">α1</span> <span class="main">-</span> bn <span class="free">α1</span> <span class="main">=</span> supp <span class="free">α2</span> <span class="main">-</span> bn <span class="free">α2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_set.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp <span class="free">α1</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_set.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="free">α1</span> <span class="main">=</span> <span class="free">α2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?r</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f1</span> <span class="main">=</span> <span class="free">f2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> * <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="free">x1</span> <span class="main">-</span> bn <span class="free">α1</span> <span class="main">=</span> supp <span class="free">x2</span> <span class="main">-</span> bn <span class="free">α2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp <span class="free">x1</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="free">x1</span> <span class="main">=</span> <span class="free">x2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="free">α1</span> <span class="main">-</span> bn <span class="free">α1</span> <span class="main">=</span> supp <span class="free">α2</span> <span class="main">-</span> bn <span class="free">α2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp <span class="free">α1</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="free">α1</span> <span class="main">=</span> <span class="free">α2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">from</span></span> 1 2 3 6 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="free">α1</span><span class="main">,</span> rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>Rep_formula <span class="free">x1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="main">(</span>supp_rel <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">(</span>bn <span class="free">α2</span><span class="main">,</span> rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>Rep_formula <span class="free">x2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Rep_formula_eqvt alpha_Tree_permute_rep_commute alpha_set.simps bn_eqvt supp_Rep_formula supp_alpha_supp_rel<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 4 5 6 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="free">α1</span><span class="main">,</span> <span class="free">α1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="skolem">p</span> <span class="main">(</span>bn <span class="free">α2</span><span class="main">,</span> <span class="free">α2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set.simps bn_eqvt<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Act <span class="free">f1</span> <span class="free">α1</span> <span class="free">x1</span> <span class="main">=</span> Act <span class="free">f2</span> <span class="free">α2</span> <span class="free">x2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act_eq_iff Act<span class="hidden">⇩</span><sub>α</sub>_eq_iff alpha_tAct<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FL_Formula-Act_eq_iff_perm_renaming"><span class="command">lemma</span></span> Act_eq_iff_perm_renaming<span class="main">:</span> <span class="quoted"><span class="quoted">"Act <span class="free">f1</span> <span class="free">α1</span> <span class="free">x1</span> <span class="main">=</span> Act <span class="free">f2</span> <span class="free">α2</span> <span class="free">x2</span> <span class="main">⟷</span>
  <span class="free">f1</span> <span class="main">=</span> <span class="free">f2</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> supp <span class="free">x1</span> <span class="main">-</span> bn <span class="free">α1</span> <span class="main">=</span> supp <span class="free">x2</span> <span class="main">-</span> bn <span class="free">α2</span> <span class="main">∧</span> <span class="main">(</span>supp <span class="free">x1</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∙</span> <span class="free">x1</span> <span class="main">=</span> <span class="free">x2</span> <span class="main">∧</span> supp <span class="free">α1</span> <span class="main">-</span> bn <span class="free">α1</span> <span class="main">=</span> supp <span class="free">α2</span> <span class="main">-</span> bn <span class="free">α2</span> <span class="main">∧</span> <span class="main">(</span>supp <span class="free">α1</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∙</span> <span class="free">α1</span> <span class="main">=</span> <span class="free">α2</span> <span class="main">∧</span> supp <span class="bound">p</span> <span class="main">⊆</span> bn <span class="free">α1</span> <span class="main">∪</span> <span class="bound">p</span> <span class="main">∙</span> bn <span class="free">α1</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">⟷</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f1</span> <span class="main">=</span> <span class="free">f2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act_eq_iff_perm<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?l</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="free">x1</span> <span class="main">-</span> bn <span class="free">α1</span> <span class="main">=</span> supp <span class="free">x2</span> <span class="main">-</span> bn <span class="free">α2</span> <span class="main">∧</span> <span class="main">(</span>supp <span class="free">x1</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">x1</span> <span class="main">=</span> <span class="free">x2</span> <span class="main">∧</span> supp <span class="free">α1</span> <span class="main">-</span> bn <span class="free">α1</span> <span class="main">=</span> supp <span class="free">α2</span> <span class="main">-</span> bn <span class="free">α2</span> <span class="main">∧</span> <span class="main">(</span>supp <span class="free">α1</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">α1</span> <span class="main">=</span> <span class="free">α2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act_eq_iff_perm<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> q_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">b</span><span class="main">∈</span>bn <span class="free">α1</span><span class="main">.</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="bound">b</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="bound">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> supp_q<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="skolem">q</span> <span class="main">⊆</span> bn <span class="free">α1</span> <span class="main">∪</span> <span class="skolem">p</span> <span class="main">∙</span> bn <span class="free">α1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> set_renaming_perm2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="skolem">q</span> <span class="main">⊆</span> supp <span class="skolem">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> supp <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> supp <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> bn <span class="free">α1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"*"</span> q_p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_Collect_eq supp_perm<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="skolem">p</span> <span class="main">∙</span> bn <span class="free">α1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"*"</span> supp_q <span class="keyword1"><span class="command">using</span></span> UnE subsetCE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">a</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_permute_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> fresh_def fresh_perm <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp <span class="free">x1</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp <span class="free">α1</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> fresh_def fresh_star_def subset_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> p <span class="keyword2"><span class="keyword">and</span></span> q_p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> supp <span class="free">α1</span> <span class="main">⟹</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="bound">a</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="bound">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> supp <span class="free">x1</span> <span class="main">⟹</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="bound">a</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="bound">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_iff fresh_perm fresh_star_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∙</span> <span class="free">α1</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">α1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∙</span> <span class="free">x1</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">x1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> supp_perm_perm_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> supp_q <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bn_eqvt<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Act_eq_iff_perm<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The lifted constructors are free (except for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Act<span class="antiquote"><span class="antiquote">}</span></span></span></span>).›</span></span>

<span class="keyword1" id="FL_Formula-Tree_free"><span class="command">lemma</span></span> Tree_free <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span> <span class="main">⟹</span> Conj <span class="free">xset</span> <span class="main">≠</span> Not <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span> <span class="main">⟹</span> Conj <span class="free">xset</span> <span class="main">≠</span> Pred <span class="free">f</span> <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span> <span class="main">⟹</span> Conj <span class="free">xset</span> <span class="main">≠</span> Act <span class="free">f</span> <span class="free">α</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Not <span class="free">x</span> <span class="main">≠</span> Pred <span class="free">f</span> <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Not <span class="free">x1</span> <span class="main">≠</span> Act <span class="free">f</span> <span class="free">α</span> <span class="free">x2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Pred <span class="free">f1</span> <span class="free">φ</span> <span class="main">≠</span> Act <span class="free">f2</span> <span class="free">α</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span> <span class="main">⟹</span> Conj <span class="free">xset</span> <span class="main">≠</span> Not <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Conj_rep_eq Not.rep_eq Tree<span class="hidden">⇩</span><sub>α</sub>_free<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span> <span class="main">⟹</span> Conj <span class="free">xset</span> <span class="main">≠</span> Pred <span class="free">f</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Conj_rep_eq Pred.rep_eq Tree<span class="hidden">⇩</span><sub>α</sub>_free<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span> <span class="main">⟹</span> Conj <span class="free">xset</span> <span class="main">≠</span> Act <span class="free">f</span> <span class="free">α</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Conj_rep_eq Act.rep_eq Tree<span class="hidden">⇩</span><sub>α</sub>_free<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Not <span class="free">x</span> <span class="main">≠</span> Pred <span class="free">f</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Not.rep_eq Pred.rep_eq Tree<span class="hidden">⇩</span><sub>α</sub>_free<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Not <span class="free">x1</span> <span class="main">≠</span> Act <span class="free">f</span> <span class="free">α</span> <span class="free">x2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Not.rep_eq Act.rep_eq Tree<span class="hidden">⇩</span><sub>α</sub>_free<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Pred <span class="free">f1</span> <span class="free">φ</span> <span class="main">≠</span> Act <span class="free">f2</span> <span class="free">α</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pred.rep_eq Act.rep_eq Tree<span class="hidden">⇩</span><sub>α</sub>_free<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹\texorpdfstring{$F/L$}{F/L}-formulas›</span></span>

<span class="keyword1"><span class="command">context</span></span> effect_nominal_ts
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The predicate~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">is_FL_formula</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> will characterise exactly those formulas in a particular
set~$A^{F/L}$.›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">is_FL_formula</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'effect</span> first <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'effect</span><span class="main">)</span> formula <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  Conj<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free"><span class="bound"><span class="entity">xset</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set_bset <span class="free"><span class="bound"><span class="entity">xset</span></span></span> <span class="main">⟹</span> <span class="free">is_FL_formula</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">is_FL_formula</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">(</span>Conj <span class="free"><span class="bound"><span class="entity">xset</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Not<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">is_FL_formula</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span> <span class="free">is_FL_formula</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Pred<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">⟹</span> <span class="free">is_FL_formula</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">(</span>Pred <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Act<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">⟹</span> bn <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">♯*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">is_FL_formula</span> <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span> <span class="free">is_FL_formula</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">(</span>Act <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">in_𝒜</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'effect</span><span class="main">)</span> formula <span class="main">⇒</span> <span class="tfree">'effect</span> first <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">∈</span> <span class="keyword1">𝒜[</span>_<span class="keyword1">]</span>"</span> <span class="main">[</span>51<span class="main">,</span>0<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">∈</span></span> <span class="keyword1"><span class="free">𝒜[</span></span><span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">≡</span> is_FL_formula <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> is_FL_formula.induct <span class="main">[</span><span class="operator">case_names</span> Conj Not Pred Act<span class="main">,</span> <span class="operator">induct</span> <span class="quasi_keyword">type</span><span class="main"><span class="main">:</span></span> formula<span class="main">]</span>

<span class="keyword1" id="FL_Formula-is_FL_formula_eqvt"><span class="command">lemma</span></span> is_FL_formula_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="keyword1">𝒜[</span><span class="free">F</span><span class="main">]</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">x</span> <span class="main">∈</span> <span class="keyword1">𝒜[</span><span class="free">p</span> <span class="main">∙</span> <span class="free">F</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> is_FL_formula.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">,</span> <span class="tfree">'effect</span><span class="main">)</span> formula <span class="keyword1">set[</span><span class="tfree">'a</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">F</span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="skolem">xset</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set_bset <span class="skolem">xset</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∙</span> <span class="bound">x</span> <span class="main">∈</span> <span class="keyword1">𝒜[</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">F</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">xset</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_finite supp_eqvt<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">xset</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="keyword1">𝒜[</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">F</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> imageE permute_set_eq_image set_bset_eqvt<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Conj <span class="skolem">xset</span> <span class="main">∈</span> <span class="keyword1">𝒜[</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">F</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Conj<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">F</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">,</span> <span class="tfree">'effect</span><span class="main">)</span> formula"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="keyword1">𝒜[</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">F</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Not <span class="skolem">x</span> <span class="main">∈</span> <span class="keyword1">𝒜[</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">F</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Not<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'effect</span> first"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">φ</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">F</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Pred <span class="skolem">f</span> <span class="skolem">φ</span> <span class="main">∈</span> <span class="keyword1">𝒜[</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">F</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Pred<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">F</span> <span class="skolem">α</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">,</span> <span class="tfree">'effect</span><span class="main">)</span> formula"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="keyword1">𝒜[</span><span class="free">p</span> <span class="main">∙</span> <span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Act <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="keyword1">𝒜[</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">F</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Act Act_eqvt L_eqvt' Pair_eqvt bn_eqvt fresh_star_permute_iff member_fs_set_permute_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Induction over infinitary formulas›</span></span>

<span class="comment1">(* Not needed yet for F/L-formulas, so not done. *)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Strong induction over infinitary formulas›</span></span>

<span class="comment1">(* Not needed yet for F/L-formulas, so not done. *)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="FL_Validity">
<div class="head">
<h1>Theory FL_Validity</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> FL_Validity
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#FL_Transition_System">FL_Transition_System</a>
  <a href="#FL_Formula">FL_Formula</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Validity With Effects›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following is needed to prove termination of~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">FL_validTree</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">alpha_Tree_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">alpha_Tree_rel</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="bound">y</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="FL_Validity-alpha_Tree_relI"><span class="command">lemma</span></span> alpha_Tree_relI <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> alpha_Tree_rel"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> alpha_Tree_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="FL_Validity-alpha_Tree_relE"><span class="command">lemma</span></span> alpha_Tree_relE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> alpha_Tree_rel"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">P</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> alpha_Tree_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="FL_Validity-wf_alpha_Tree_rel_hull_rel_Tree_wf"><span class="command">lemma</span></span> wf_alpha_Tree_rel_hull_rel_Tree_wf<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf <span class="main">(</span>alpha_Tree_rel <span class="keyword1">O</span> hull_rel <span class="keyword1">O</span> Tree_wf<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> wf_relcomp_compatible<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>hull_rel <span class="keyword1">O</span> Tree_wf<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree_wf_eqvt' wf_Tree_wf wf_hull_rel_relcomp<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>hull_rel <span class="keyword1">O</span> Tree_wf<span class="main">)</span> <span class="keyword1">O</span> alpha_Tree_rel <span class="main">⊆</span> alpha_Tree_rel <span class="keyword1">O</span> <span class="main">(</span>hull_rel <span class="keyword1">O</span> Tree_wf<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'g</span><span class="main">,</span> <span class="tfree">'h</span><span class="main">)</span> Tree <span class="main">×</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'g</span><span class="main">,</span> <span class="tfree">'h</span><span class="main">)</span> Tree"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span>hull_rel <span class="keyword1">O</span> Tree_wf<span class="main">)</span> <span class="keyword1">O</span> alpha_Tree_rel"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x1</span></span> <span class="skolem"><span class="skolem">x2</span></span> <span class="skolem"><span class="skolem">x3</span></span> <span class="skolem"><span class="skolem">x4</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span><span class="skolem">x4</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x1</span><span class="main">,</span><span class="skolem">x2</span><span class="main">)</span> <span class="main">∈</span> hull_rel"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x2</span><span class="main">,</span><span class="skolem">x3</span><span class="main">)</span> <span class="main">∈</span> Tree_wf"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x3</span><span class="main">,</span><span class="skolem">x4</span><span class="main">)</span> <span class="main">∈</span> alpha_Tree_rel"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x1</span><span class="main">,</span><span class="skolem">x4</span><span class="main">)</span> <span class="main">∈</span> alpha_Tree_rel <span class="keyword1">O</span> hull_rel <span class="keyword1">O</span> Tree_wf"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> 3 <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Tree_wf.induct<span class="main">)</span>
        <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> tConj<span class="antiquote">}</span></span>›</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">tset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'f</span><span class="main">,</span><span class="tfree">'g</span><span class="main">,</span><span class="tfree">'h</span><span class="main">)</span> Tree <span class="keyword1">set[</span><span class="tfree">'e</span><span class="main">]</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> set_bset <span class="skolem">tset</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x1</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> hull_rel"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ***<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>tConj <span class="skolem">tset</span><span class="main">,</span> <span class="skolem">x4</span><span class="main">)</span> <span class="main">∈</span> alpha_Tree_rel"</span></span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"**"</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> x1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> hull_rel.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"***"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tConj <span class="skolem">tset</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">x4</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> alpha_Tree_relE<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tset'</span></span> <span class="keyword2"><span class="keyword">where</span></span> x4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x4</span> <span class="main">=</span> tConj <span class="skolem">tset'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rel_bset <span class="keyword1">(=<span class="hidden">⇩</span><sub>α</sub>)</span> <span class="skolem">tset</span> <span class="skolem">tset'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x4</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"*"</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">∈</span> set_bset <span class="skolem">tset'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rel_bset.rep_eq rel_set_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> x1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">∈</span> alpha_Tree_rel"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff alpha_Tree_relI permute_Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">t'</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">∈</span> hull_rel"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hull_rel.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> x4 <span class="keyword2"><span class="keyword">and</span></span> t' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t'</span><span class="main">,</span> <span class="skolem">x4</span><span class="main">)</span> <span class="main">∈</span> Tree_wf"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Tree_wf.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x1</span><span class="main">,</span><span class="skolem">x4</span><span class="main">)</span> <span class="main">∈</span> alpha_Tree_rel <span class="keyword1">O</span> hull_rel <span class="keyword1">O</span> Tree_wf"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> tNot<span class="antiquote">}</span></span>›</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
        <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x1</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> hull_rel"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>tNot <span class="skolem">t</span><span class="main">,</span> <span class="skolem">x4</span><span class="main">)</span> <span class="main">∈</span> alpha_Tree_rel"</span></span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"*"</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> x1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> hull_rel.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"**"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tNot <span class="skolem">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">x4</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> alpha_Tree_relE<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> x4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x4</span> <span class="main">=</span> tNot <span class="skolem">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x4</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command">with</span></span> x1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">∈</span> alpha_Tree_rel"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff alpha_Tree_relI permute_Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq x1<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">t'</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">∈</span> hull_rel"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hull_rel.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> x4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t'</span><span class="main">,</span> <span class="skolem">x4</span><span class="main">)</span> <span class="main">∈</span> Tree_wf"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Tree_wf.intros<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x1</span><span class="main">,</span><span class="skolem">x4</span><span class="main">)</span> <span class="main">∈</span> alpha_Tree_rel <span class="keyword1">O</span> hull_rel <span class="keyword1">O</span> Tree_wf"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> tAct<span class="antiquote">}</span></span>›</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">t</span>
        <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x1</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> hull_rel"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>tAct <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">t</span><span class="main">,</span> <span class="skolem">x4</span><span class="main">)</span> <span class="main">∈</span> alpha_Tree_rel"</span></span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"*"</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> x1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> hull_rel.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"**"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tAct <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">x4</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> alpha_Tree_relE<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> x4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x4</span> <span class="main">=</span> tAct <span class="skolem">f</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∙</span> <span class="skolem">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x4</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> x1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="main">-</span><span class="skolem">q</span> <span class="main">∙</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">∈</span> alpha_Tree_rel"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff alpha_Tree_relI permute_Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="main">-</span><span class="skolem">q</span> <span class="main">∙</span> <span class="skolem">t'</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">∈</span> hull_rel"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hull_rel.simps permute_plus<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> x4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t'</span><span class="main">,</span> <span class="skolem">x4</span><span class="main">)</span> <span class="main">∈</span> Tree_wf"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Tree_wf.intros<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x1</span><span class="main">,</span><span class="skolem">x4</span><span class="main">)</span> <span class="main">∈</span> alpha_Tree_rel <span class="keyword1">O</span> hull_rel <span class="keyword1">O</span> Tree_wf"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> x <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> alpha_Tree_rel <span class="keyword1">O</span> hull_rel <span class="keyword1">O</span> Tree_wf"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FL_Validity-alpha_Tree_rel_relcomp_trivialI"><span class="command">lemma</span></span> alpha_Tree_rel_relcomp_trivialI <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> alpha_Tree_rel <span class="keyword1">O</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> alpha_Tree_rel_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff case_prodI mem_Collect_eq relcomp.relcompI<span class="main">)</span>

<span class="keyword1" id="FL_Validity-alpha_Tree_rel_relcompI"><span class="command">lemma</span></span> alpha_Tree_rel_relcompI <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x'</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> alpha_Tree_rel <span class="keyword1">O</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> alpha_Tree_rel_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> case_prodI mem_Collect_eq relcomp.relcompI<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Validity for infinitely branching trees›</span></span>

<span class="keyword1"><span class="command">context</span></span> effect_nominal_ts
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Since we defined formulas via a manual quotient construction, we also need to define
  validity via lifting from the underlying type of infinitely branching trees. We cannot use
  {\bf nominal\_function} because that generates proof obligations where, for formulas of the
  form~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Conj <span class="free"><span class="free">xset</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the assumption that~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xset</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> has finite support is missing.›</span></span>

  <span class="keyword1"><span class="command">declare</span></span> conj_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span>

  <span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">)</span> <span class="entity">FL_valid_Tree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'effect</span><span class="main">)</span> Tree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">FL_valid_Tree</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>tConj <span class="free"><span class="bound"><span class="entity">tset</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>set_bset <span class="free"><span class="bound"><span class="entity">tset</span></span></span><span class="main">.</span> <span class="free">FL_valid_Tree</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">FL_valid_Tree</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>tNot <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">¬</span> <span class="free">FL_valid_Tree</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">FL_valid_Tree</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>tPred <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main"><span class="free">⟨</span></span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main"><span class="free">⟩</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">FL_valid_Tree</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>tAct <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">α'</span> <span class="bound">t'</span> <span class="bound">P'</span><span class="main">.</span> tAct <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">α'</span> <span class="bound">t'</span> <span class="main">∧</span> <span class="main"><span class="free">⟨</span></span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main"><span class="free">⟩</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α'</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="free">FL_valid_Tree</span> <span class="bound">P'</span> <span class="bound">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inv_image <span class="main">(</span>alpha_Tree_rel <span class="keyword1">O</span> hull_rel <span class="keyword1">O</span> Tree_wf<span class="main">)</span> snd"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf <span class="var">?R</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wf_alpha_Tree_rel_hull_rel_Tree_wf wf_inv_image<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'state</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">tset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'effect</span><span class="main">)</span> Tree <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">t</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> set_bset <span class="skolem">tset</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">P</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">P</span><span class="main">,</span> tConj <span class="skolem">tset</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Tree_wf.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'state</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'effect</span><span class="main">)</span> Tree"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">P</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">P</span><span class="main">,</span> tNot <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Tree_wf.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P1</span> <span class="skolem">P2</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'state</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">f</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">α1</span> <span class="skolem">α2</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'effect</span><span class="main">)</span> Tree"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"tAct <span class="skolem">f</span> <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="skolem">f</span> <span class="skolem">α2</span> <span class="skolem">t2</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">t1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alphas<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> alpha_Tree_symp sympE<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">P2</span><span class="main">,</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">P1</span><span class="main">,</span> tAct <span class="skolem">f</span> <span class="skolem">α1</span> <span class="skolem">t1</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Tree_wf.intros<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> FL_valid_Tree<span class="antiquote"><span class="antiquote">}</span></span></span></span> is equivariant.›</span></span>

  <span class="keyword1" id="FL_Validity-FL_valid_Tree_eqvt'"><span class="command">lemma</span></span> FL_valid_Tree_eqvt'<span class="main">:</span> <span class="quoted"><span class="quoted">"FL_valid_Tree <span class="free">P</span> <span class="free">t</span> <span class="main">⟷</span> FL_valid_Tree <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> FL_valid_Tree.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">P</span> <span class="skolem">tset</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"FL_valid_Tree <span class="skolem">P</span> <span class="main">(</span>tConj <span class="skolem">tset</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="free">p</span> <span class="main">∙</span> set_bset <span class="skolem">tset</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"1.IH"</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"*"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FL_valid_Tree <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> imageE permute_set_eq_image FL_valid_Tree.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"FL_valid_Tree <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> tConj <span class="skolem">tset</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"FL_valid_Tree <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> tConj <span class="skolem">tset</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> set_bset <span class="skolem">tset</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"1.IH"</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"*"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FL_valid_Tree <span class="skolem">P</span> <span class="skolem">t</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_permute_iff permute_Tree_tConj set_bset_eqvt FL_valid_Tree.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"FL_valid_Tree <span class="skolem">P</span> <span class="main">(</span>tConj <span class="skolem">tset</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> effect_apply_eqvt' permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> satisfies_eqvt<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">P</span> <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">t</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"FL_valid_Tree <span class="skolem">P</span> <span class="main">(</span>tAct <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"tAct <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="skolem">f</span> <span class="skolem">α'</span> <span class="skolem">t'</span> <span class="main">∧</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span> <span class="main">∧</span> FL_valid_Tree <span class="skolem">P'</span> <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"4.IH"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FL_valid_Tree <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"*"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α'</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> transition_eqvt'<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"*"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> tAct <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α'</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_Tree_eqvt permute_Tree.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"FL_valid_Tree <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> tAct <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"FL_valid_Tree <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> tAct <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> tAct <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">f</span><span class="main">)</span> <span class="skolem">α'</span> <span class="skolem">t'</span> <span class="main">∧</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span> <span class="main">∧</span> FL_valid_Tree <span class="skolem">P'</span> <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"tAct <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="skolem">f</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α'</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_Tree_eqvt permute_Tree.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"*"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α'</span><span class="main">,</span> <span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> transition_eqvt'<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> <span class="quoted">"4.IH"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FL_valid_Tree <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"*"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"FL_valid_Tree <span class="skolem">P</span> <span class="main">(</span>tAct <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="FL_Validity-FL_valid_Tree_eqvt"><span class="command">lemma</span></span> FL_valid_Tree_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"FL_valid_Tree <span class="free">P</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FL_valid_Tree <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> FL_valid_Tree_eqvt'<span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹$\alpha$-equivalent trees validate the same states.›</span></span>

  <span class="keyword1" id="FL_Validity-alpha_Tree_FL_valid_Tree"><span class="command">lemma</span></span> alpha_Tree_FL_valid_Tree<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t2</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FL_valid_Tree <span class="free">P</span> <span class="free">t1</span> <span class="main">⟷</span> FL_valid_Tree <span class="free">P</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alpha_Tree_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> tConj <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> rel_bset.rep_eq rel_set_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tAct <span class="skolem">f1</span> <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="skolem">f2</span> <span class="skolem">α2</span> <span class="skolem">t2</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"FL_valid_Tree <span class="skolem">P</span> <span class="main">(</span>tAct <span class="skolem">f1</span> <span class="skolem">α1</span> <span class="skolem">t1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"tAct <span class="skolem">f1</span> <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="skolem">f1</span> <span class="skolem">α'</span> <span class="skolem">t'</span> <span class="main">∧</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f1</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span> <span class="main">∧</span> FL_valid_Tree <span class="skolem">P'</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> tAct.hyps <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tAct <span class="skolem">f1</span> <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="skolem">f2</span> <span class="skolem">α2</span> <span class="skolem">t2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> alpha_tAct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"FL_valid_Tree <span class="skolem">P</span> <span class="main">(</span>tAct <span class="skolem">f2</span> <span class="skolem">α2</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> tAct.hyps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff FL_valid_Tree.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"FL_valid_Tree <span class="skolem">P</span> <span class="main">(</span>tAct <span class="skolem">f2</span> <span class="skolem">α2</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"tAct <span class="skolem">f2</span> <span class="skolem">α2</span> <span class="skolem">t2</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="skolem">f2</span> <span class="skolem">α'</span> <span class="skolem">t'</span> <span class="main">∧</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f2</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span> <span class="main">∧</span> FL_valid_Tree <span class="skolem">P'</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> tAct.hyps <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tAct <span class="skolem">f1</span> <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="skolem">f2</span> <span class="skolem">α2</span> <span class="skolem">t2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> alpha_tAct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"FL_valid_Tree <span class="skolem">P</span> <span class="main">(</span>tAct <span class="skolem">f1</span> <span class="skolem">α1</span> <span class="skolem">t1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> tAct.hyps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff FL_valid_Tree.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>


  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Validity for trees modulo \texorpdfstring{$\alpha$}{alpha}-equivalence›</span></span>

  <span class="keyword1"><span class="command">lift_definition</span></span> FL_valid_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'effect</span><span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
    <span class="quoted">FL_valid_Tree</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> alpha_Tree_FL_valid_Tree<span class="main">)</span>

  <span class="keyword1" id="FL_Validity-FL_valid_Tree"><span class="command">lemma</span></span> FL_valid_Tree<span class="hidden">⇩</span><sub>α</sub>_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"FL_valid_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">P</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FL_valid_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">fact</span> FL_valid_Tree_eqvt<span class="main">)</span>

  <span class="keyword1" id="FL_Validity-FL_valid_Tree"><span class="command">lemma</span></span> FL_valid_Tree<span class="hidden">⇩</span><sub>α</sub>_Conj<span class="hidden">⇩</span><sub>α</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"FL_valid_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">P</span> <span class="main">(</span>Conj<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">∈</span>set_bset <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">.</span> FL_valid_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">P</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FL_valid_Tree <span class="free">P</span> <span class="main">(</span>rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>abs_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>tConj <span class="main">(</span>map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> FL_valid_Tree <span class="free">P</span> <span class="main">(</span>tConj <span class="main">(</span>map_bset rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree<span class="hidden">⇩</span><sub>α</sub>_rep_abs alpha_Tree_FL_valid_Tree<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FL_valid_Tree<span class="hidden">⇩</span><sub>α</sub>_def Conj<span class="hidden">⇩</span><sub>α</sub>_def map_bset.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="FL_Validity-FL_valid_Tree"><span class="command">lemma</span></span> FL_valid_Tree<span class="hidden">⇩</span><sub>α</sub>_Not<span class="hidden">⇩</span><sub>α</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"FL_valid_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">P</span> <span class="main">(</span>Not<span class="hidden">⇩</span><sub>α</sub> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">¬</span> FL_valid_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">P</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

  <span class="keyword1" id="FL_Validity-FL_valid_Tree"><span class="command">lemma</span></span> FL_valid_Tree<span class="hidden">⇩</span><sub>α</sub>_Pred<span class="hidden">⇩</span><sub>α</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"FL_valid_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">P</span> <span class="main">(</span>Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free">f</span> <span class="free">φ</span><span class="main">)</span> <span class="main">⟷</span> <span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">P</span> <span class="main"><span class="free">⊢</span></span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

  <span class="keyword1" id="FL_Validity-FL_valid_Tree"><span class="command">lemma</span></span> FL_valid_Tree<span class="hidden">⇩</span><sub>α</sub>_Act<span class="hidden">⇩</span><sub>α</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"FL_valid_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">P</span> <span class="main">(</span>Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">f</span> <span class="free">α</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">α'</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub>'</span> <span class="bound">P'</span><span class="main">.</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">f</span> <span class="free">α</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">f</span> <span class="bound">α'</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub>'</span> <span class="main">∧</span> <span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α'</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">∧</span> FL_valid_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="bound">P'</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub>'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"FL_valid_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">P</span> <span class="main">(</span>Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">f</span> <span class="free">α</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">f</span> <span class="free">α</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> abs_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>tAct <span class="free">f</span> <span class="free">α</span> <span class="main">(</span>rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act<span class="hidden">⇩</span><sub>α</sub>.abs_eq Tree<span class="hidden">⇩</span><sub>α</sub>_abs_rep<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">α'</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub>'</span> <span class="bound">P'</span><span class="main">.</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">f</span> <span class="free">α</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">f</span> <span class="bound">α'</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub>'</span> <span class="main">∧</span> <span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α'</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">∧</span> FL_valid_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="bound">P'</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act<span class="hidden">⇩</span><sub>α</sub>.abs_eq Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff FL_valid_Tree.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> FL_valid_Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">α'</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub>'</span> <span class="bound">P'</span><span class="main">.</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">f</span> <span class="free">α</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">f</span> <span class="bound">α'</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub>'</span> <span class="main">∧</span> <span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α'</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">∧</span> FL_valid_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="bound">P'</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">α'</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub>'</span><span class="main">.</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">f</span> <span class="bound">α'</span> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub>'</span> <span class="main">=</span> abs_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>tAct <span class="free">f</span> <span class="bound">α'</span> <span class="main">(</span>rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="bound">t<span class="hidden">⇩</span><sub>α</sub>'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act<span class="hidden">⇩</span><sub>α</sub>.abs_eq Tree<span class="hidden">⇩</span><sub>α</sub>_abs_rep<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"FL_valid_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">P</span> <span class="main">(</span>Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">f</span> <span class="free">α</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq_iff FL_valid_Tree.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> FL_valid_Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq FL_valid_Tree<span class="hidden">⇩</span><sub>α</sub>.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>


  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Validity for infinitary formulas›</span></span>

  <span class="keyword1"><span class="command">lift_definition</span></span> FL_valid <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'effect</span><span class="main">)</span> formula <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊨</span>"</span> 70<span class="main">)</span> <span class="keyword2"><span class="keyword">is</span></span>
    <span class="quoted">FL_valid_Tree<span class="hidden">⇩</span><sub>α</sub></span>
  <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1" id="FL_Validity-FL_valid_eqvt"><span class="command">lemma</span></span> FL_valid_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">⊨</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">metis</span> FL_valid_Tree<span class="hidden">⇩</span><sub>α</sub>_eqvt<span class="main">)</span>

  <span class="keyword1" id="FL_Validity-FL_valid_Conj"><span class="command">lemma</span></span> FL_valid_Conj <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Conj <span class="free">xset</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set_bset <span class="free">xset</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊨</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FL_valid_def Conj_def map_bset.rep_eq<span class="main">)</span>

  <span class="keyword1" id="FL_Validity-FL_valid_Not"><span class="command">lemma</span></span> FL_valid_Not <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Not <span class="free">x</span> <span class="main">⟷</span> <span class="main">¬</span> <span class="free">P</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

  <span class="keyword1" id="FL_Validity-FL_valid_Pred"><span class="command">lemma</span></span> FL_valid_Pred <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Pred <span class="free">f</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">P</span> <span class="main"><span class="free">⊢</span></span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

  <span class="keyword1" id="FL_Validity-FL_valid_Act"><span class="command">lemma</span></span> FL_valid_Act<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Act <span class="free">f</span> <span class="free">α</span> <span class="free">x</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">α'</span> <span class="bound">x'</span> <span class="bound">P'</span><span class="main">.</span> Act <span class="free">f</span> <span class="free">α</span> <span class="free">x</span> <span class="main">=</span> Act <span class="free">f</span> <span class="bound">α'</span> <span class="bound">x'</span> <span class="main">∧</span> <span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α'</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊨</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Act <span class="free">f</span> <span class="free">α</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Rep_formula <span class="main">(</span>Abs_formula <span class="main">(</span>Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">f</span> <span class="free">α</span> <span class="main">(</span>Rep_formula <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">f</span> <span class="free">α</span> <span class="main">(</span>Rep_formula <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act.rep_eq Rep_formula_inverse<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">α'</span> <span class="bound">x'</span> <span class="bound">P'</span><span class="main">.</span> Act <span class="free">f</span> <span class="free">α</span> <span class="free">x</span> <span class="main">=</span> Act <span class="free">f</span> <span class="bound">α'</span> <span class="bound">x'</span> <span class="main">∧</span> <span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α'</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊨</span> <span class="bound">x'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FL_valid_def Act_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Abs_formula_inverse Rep_formula' hereditarily_fs_alpha_renaming<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">α'</span> <span class="bound">x'</span> <span class="bound">P'</span><span class="main">.</span> Act <span class="free">f</span> <span class="free">α</span> <span class="free">x</span> <span class="main">=</span> Act <span class="free">f</span> <span class="bound">α'</span> <span class="bound">x'</span> <span class="main">∧</span> <span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α'</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊨</span> <span class="bound">x'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Act <span class="free">f</span> <span class="free">α</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act.rep_eq FL_valid.rep_eq FL_valid_Tree<span class="hidden">⇩</span><sub>α</sub>_Act<span class="hidden">⇩</span><sub>α</sub><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The binding names in the alpha-variant that witnesses validity may be chosen fresh for any
  finitely supported context.›</span></span>

  <span class="keyword1" id="FL_Validity-FL_valid_Act_strong"><span class="command">lemma</span></span> FL_valid_Act_strong<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Act <span class="free">f</span> <span class="free">α</span> <span class="free">x</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">α'</span> <span class="bound">x'</span> <span class="bound">P'</span><span class="main">.</span> Act <span class="free">f</span> <span class="free">α</span> <span class="free">x</span> <span class="main">=</span> Act <span class="free">f</span> <span class="bound">α'</span> <span class="bound">x'</span> <span class="main">∧</span> <span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α'</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊨</span> <span class="bound">x'</span> <span class="main">∧</span> bn <span class="bound">α'</span> <span class="main">♯*</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Act <span class="free">f</span> <span class="free">α</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Act <span class="free">f</span> <span class="free">α</span> <span class="free">x</span> <span class="main">=</span> Act <span class="free">f</span> <span class="skolem">α'</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> <span class="skolem">x'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> FL_valid_Act<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>bn <span class="skolem">α'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> bn_finite<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>supp <span class="free">X</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>supp <span class="skolem">x'</span> <span class="main">-</span> bn <span class="skolem">α'</span><span class="main">,</span> supp <span class="skolem">α'</span> <span class="main">-</span> bn <span class="skolem">α'</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_Pair finite_sets_supp finite_supp<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α'</span> <span class="main">♯*</span> <span class="main">(</span>supp <span class="skolem">x'</span> <span class="main">-</span> bn <span class="skolem">α'</span><span class="main">,</span> supp <span class="skolem">α'</span> <span class="main">-</span> bn <span class="skolem">α'</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atom_fresh_star_disjoint finite_supp fresh_star_Pair<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> fresh_X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> bn <span class="skolem">α'</span><span class="main">)</span> <span class="main">♯*</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh_p<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>supp <span class="skolem">x'</span> <span class="main">-</span> bn <span class="skolem">α'</span><span class="main">,</span> supp <span class="skolem">α'</span> <span class="main">-</span> bn <span class="skolem">α'</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> at_set_avoiding2<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> fresh_p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>supp <span class="skolem">x'</span> <span class="main">-</span> bn <span class="skolem">α'</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>supp <span class="skolem">α'</span> <span class="main">-</span> bn <span class="skolem">α'</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> fresh_Pair fresh_def fresh_star_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp <span class="skolem">x'</span> <span class="main">-</span> bn <span class="skolem">α'</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp <span class="skolem">α'</span> <span class="main">-</span> bn <span class="skolem">α'</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_supp supp_finite_atom_set<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">-</span> bn <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α'</span><span class="main">)</span> <span class="main">=</span> supp <span class="skolem">x'</span> <span class="main">-</span> bn <span class="skolem">α'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_eqvt atom_set_perm_eq bn_eqvt supp_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α'</span><span class="main">)</span> <span class="main">-</span> bn <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α'</span><span class="main">)</span> <span class="main">=</span> supp <span class="skolem">α'</span> <span class="main">-</span> bn <span class="skolem">α'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Diff_eqvt atom_set_perm_eq bn_eqvt supp_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Act <span class="free">f</span> <span class="skolem">α'</span> <span class="skolem">x'</span> <span class="main">=</span> Act <span class="free">f</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">x'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Act_eq_iff_perm<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α'</span><span class="main">,</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> abs_residual_pair_eqvt supp_perm_eq<span class="main">)</span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">α'</span> <span class="bound">x'</span> <span class="bound">P'</span><span class="main">.</span> Act <span class="free">f</span> <span class="free">α</span> <span class="free">x</span> <span class="main">=</span> Act <span class="free">f</span> <span class="bound">α'</span> <span class="bound">x'</span> <span class="main">∧</span> <span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α'</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊨</span> <span class="bound">x'</span> <span class="main">∧</span> bn <span class="bound">α'</span> <span class="main">♯*</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword2"><span class="keyword">and</span></span> trans <span class="keyword2"><span class="keyword">and</span></span> valid <span class="keyword2"><span class="keyword">and</span></span> fresh_X <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bn_eqvt FL_valid_eqvt<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">α'</span> <span class="bound">x'</span> <span class="bound">P'</span><span class="main">.</span> Act <span class="free">f</span> <span class="free">α</span> <span class="free">x</span> <span class="main">=</span> Act <span class="free">f</span> <span class="bound">α'</span> <span class="bound">x'</span> <span class="main">∧</span> <span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α'</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊨</span> <span class="bound">x'</span> <span class="main">∧</span> bn <span class="bound">α'</span> <span class="main">♯*</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Act <span class="free">f</span> <span class="free">α</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> FL_valid_Act<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="FL_Validity-FL_valid_Act_fresh"><span class="command">lemma</span></span> FL_valid_Act_fresh<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bn <span class="free">α</span> <span class="main">♯*</span> <span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Act <span class="free">f</span> <span class="free">α</span> <span class="free">x</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> <span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">α</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊨</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Act <span class="free">f</span> <span class="free">α</span> <span class="free">x</span>"</span></span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> finite_supp<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Act <span class="free">f</span> <span class="free">α</span> <span class="free">x</span> <span class="main">=</span> Act <span class="free">f</span> <span class="skolem">α'</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α'</span> <span class="main">♯*</span> <span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> FL_valid_Act_strong<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p_α<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">α'</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">α</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> supp_p<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="skolem">p</span> <span class="main">⊆</span> bn <span class="free">α</span> <span class="main">∪</span> <span class="skolem">p</span> <span class="main">∙</span> bn <span class="free">α</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act_eq_iff_perm_renaming<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> fresh <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="free">α</span> <span class="main">∪</span> <span class="skolem">p</span> <span class="main">∙</span> bn <span class="free">α</span><span class="main">)</span> <span class="main">♯*</span> <span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p_α <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bn_eqvt fresh_star_Un<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="skolem">p</span> <span class="main">♯*</span> <span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> supp_p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_star_def subset_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> p_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">P</span> <span class="main">=</span> <span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> perm_supp_eq supp_minus_perm<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> trans <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">α</span><span class="main">,</span><span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p_P p_α <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> transition_eqvt'<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> valid <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p_x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> FL_valid_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> <span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">α</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> <span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">α</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Act <span class="free">f</span> <span class="free">α</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> FL_valid_Act<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="FL_Logical_Equivalence">
<div class="head">
<h1>Theory FL_Logical_Equivalence</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> FL_Logical_Equivalence
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#FL_Validity">FL_Validity</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹(Strong) Logical Equivalence›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The definition of formulas is parametric in the index type, but from now on we want to work
with a fixed (sufficiently large) index type.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> indexed_effect_nominal_ts <span class="main">=</span> effect_nominal_ts <span class="quoted"><span class="free">satisfies</span></span> <span class="quoted"><span class="free">transition</span></span> <span class="quoted"><span class="free">effect_apply</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">satisfies</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span><span class="main">::</span>fs <span class="main">⇒</span> <span class="tfree">'pred</span><span class="main">::</span>fs <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊢</span>"</span> 70<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">transition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">,</span><span class="tfree">'state</span><span class="main">)</span> residual <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">→</span>"</span> 70<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">effect_apply</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'effect</span><span class="main">::</span>fs <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⟨</span>_<span class="keyword1">⟩</span>_"</span> <span class="main">[</span>0<span class="main">,</span>101<span class="main">]</span> 100<span class="main">)</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> card_idx_perm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV<span class="main">::</span>perm set<span class="main">|</span> <span class="keyword1">&lt;o</span> <span class="main">|</span>UNIV<span class="main">::</span><span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> card_idx_state<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV<span class="main">::</span><span class="tfree">'state</span> set<span class="main">|</span> <span class="keyword1">&lt;o</span> <span class="main">|</span>UNIV<span class="main">::</span><span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">FL_logically_equivalent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'effect</span> first <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">FL_logically_equivalent</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span>
       <span class="main">∀</span><span class="bound">x</span><span class="main">::</span><span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'effect</span><span class="main">)</span> formula<span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="keyword1">𝒜[</span><span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">]</span> <span class="main">⟶</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊨</span> <span class="bound">x</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">⊨</span> <span class="bound">x</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We could (but didn't need to) prove that this defines an equivariant equivalence relation.›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="FL_Bisimilarity_Implies_Equivalence">
<div class="head">
<h1>Theory FL_Bisimilarity_Implies_Equivalence</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> FL_Bisimilarity_Implies_Equivalence
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#FL_Logical_Equivalence">FL_Logical_Equivalence</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹\texorpdfstring{$F/L$}{F/L}-Bisimilarity Implies Logical Equivalence›</span></span>

<span class="keyword1"><span class="command">context</span></span> indexed_effect_nominal_ts
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="FL_Bisimilarity_Implies_Equivalence-FL_bisimilarity_implies_equivalence_Act"><span class="command">lemma</span></span> FL_bisimilarity_implies_equivalence_Act<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">F</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bn <span class="free">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="free">F</span><span class="main">,</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="keyword1">𝒜[</span><span class="free">L</span> <span class="main">(</span><span class="free">α</span><span class="main">,</span> <span class="free">F</span><span class="main">,</span> <span class="free">f</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∼⋅[</span><span class="free">L</span> <span class="main">(</span><span class="free">α</span><span class="main">,</span> <span class="free">F</span><span class="main">,</span> <span class="free">f</span><span class="main">)</span><span class="main">]</span> <span class="bound">Q</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="main">⊨</span> <span class="free">x</span> <span class="main">⟷</span> <span class="bound">Q</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∼⋅[</span><span class="free">F</span><span class="main">]</span> <span class="free">Q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Act <span class="free">f</span> <span class="free">α</span> <span class="free">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⊨</span> Act <span class="free">f</span> <span class="free">α</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">Q</span><span class="main">,</span> <span class="free">F</span><span class="main">,</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> finite_supp<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">⊨</span> Act <span class="free">f</span> <span class="free">α</span> <span class="free">x</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Act <span class="free">f</span> <span class="free">α</span> <span class="free">x</span> <span class="main">=</span> Act <span class="free">f</span> <span class="skolem">α'</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α'</span> <span class="main">♯*</span> <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">Q</span><span class="main">,</span> <span class="free">F</span><span class="main">,</span> <span class="free">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> FL_valid_Act_strong<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">∼⋅[</span><span class="free">F</span><span class="main">]</span> <span class="free">Q</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">F</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh <span class="keyword2"><span class="keyword">and</span></span> trans <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> trans'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="free">f</span><span class="main"><span class="free">⟩</span></span><span class="free">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">Q'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bisim'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">∼⋅[</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α'</span><span class="main">,</span><span class="free">F</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">]</span> <span class="skolem">Q'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> FL_bisimilar_simulation_step<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p_α<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">α'</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">α</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">x</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> fresh_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp <span class="free">x</span> <span class="main">-</span> bn <span class="free">α</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span> <span class="main">∧</span> <span class="main">(</span>supp <span class="free">α</span> <span class="main">-</span> bn <span class="free">α</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> supp_p<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="skolem">p</span> <span class="main">⊆</span> bn <span class="free">α</span> <span class="main">∪</span> <span class="skolem">p</span> <span class="main">∙</span> bn <span class="free">α</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act_eq_iff_perm_renaming<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> valid <span class="keyword2"><span class="keyword">and</span></span> p_x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> FL_valid_eqvt<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> fresh <span class="keyword2"><span class="keyword">and</span></span> p_α <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> bn <span class="free">α</span><span class="main">)</span> <span class="main">♯*</span> <span class="main">(</span><span class="free">F</span><span class="main">,</span> <span class="free">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bn_eqvt fresh_star_Pair<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹bn <span class="free">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="free">F</span><span class="main">,</span> <span class="free">f</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> supp_p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="free">F</span><span class="main">,</span> <span class="free">f</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> UnE fresh_def fresh_star_def subsetCE<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="free">F</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"supp <span class="free">f</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Un supp_Pair<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">with</span></span> bisim' <span class="keyword2"><span class="keyword">and</span></span> p_α <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">)</span> <span class="main">∼⋅[</span><span class="free">L</span> <span class="main">(</span><span class="free">α</span><span class="main">,</span> <span class="free">F</span><span class="main">,</span> <span class="free">f</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">Q'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> FL_bisimilar_eqvt L_eqvt' permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> supp_perm_eq<span class="main">)</span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">Q'</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∼⋅[</span><span class="free">L</span> <span class="main">(</span><span class="free">α</span><span class="main">,</span> <span class="free">F</span><span class="main">,</span> <span class="free">f</span><span class="main">)</span><span class="main">]</span> <span class="bound">Q</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="main">⊨</span> <span class="free">x</span> <span class="main">⟷</span> <span class="bound">Q</span> <span class="main">⊨</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword1"><span class="command">with</span></span> p_x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">⊨</span> <span class="skolem">x'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> FL_valid_eqvt<span class="main">)</span>

    <span class="keyword1"><span class="command">with</span></span> eq <span class="keyword2"><span class="keyword">and</span></span> trans' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⊨</span> Act <span class="free">f</span> <span class="free">α</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> FL_valid_Act <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">theorem</span></span> FL_bisimilarity_implies_equivalence<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∼⋅[</span><span class="free">F</span><span class="main">]</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FL_logically_equivalent <span class="free">F</span> <span class="free">P</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FL_logically_equivalent_def <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">,</span> <span class="tfree">'effect</span><span class="main">)</span> formula"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="keyword1">𝒜[</span><span class="free">F</span><span class="main">]</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">⊨</span> <span class="skolem">x</span> <span class="main">⟷</span> <span class="free">Q</span> <span class="main">⊨</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="keyword1">𝒜[</span><span class="free">F</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> <span class="skolem">x</span> <span class="main">⟷</span> <span class="free">Q</span> <span class="main">⊨</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">Q</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Conj <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> Not <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> Pred <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> FL_bisimilar_is_L_bisimulation is_L_bisimulation_def symp_def FL_valid_Pred<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> Act <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> FL_bisimilar_symp FL_bisimilarity_implies_equivalence_Act sympE<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="FL_Equivalence_Implies_Bisimilarity">
<div class="head">
<h1>Theory FL_Equivalence_Implies_Bisimilarity</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> FL_Equivalence_Implies_Bisimilarity
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#FL_Logical_Equivalence">FL_Logical_Equivalence</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Logical Equivalence Implies \texorpdfstring{$F/L$}{F/L}-Bisimilarity›</span></span>

<span class="keyword1"><span class="command">context</span></span> indexed_effect_nominal_ts
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_distinguishing_formula</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">,</span> <span class="tfree">'effect</span><span class="main">)</span> formula <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
    <span class="main">(</span><span class="quoted">"_ <span class="keyword1">distinguishes</span> _ <span class="keyword1">from</span> _"</span> <span class="main">[</span>100<span class="main">,</span>100<span class="main">,</span>100<span class="main">]</span> 100<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">distinguishes</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1"><span class="free">from</span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊨</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">⊨</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

  <span class="keyword1" id="FL_Equivalence_Implies_Bisimilarity-is_distinguishing_formula_eqvt"><span class="command">lemma</span></span> is_distinguishing_formula_eqvt <span class="comment1">(*[eqvt]*)</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">distinguishes</span> <span class="free">P</span> <span class="keyword1">from</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">distinguishes</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">from</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_distinguishing_formula_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> FL_valid_eqvt<span class="main">)</span>

  <span class="keyword1" id="FL_Equivalence_Implies_Bisimilarity-FL_equivalent_iff_not_distinguished"><span class="command">lemma</span></span> FL_equivalent_iff_not_distinguished<span class="main">:</span>
    <span class="quoted"><span class="quoted">"FL_logically_equivalent <span class="free">F</span> <span class="free">P</span> <span class="free">Q</span> <span class="main">⟷</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="keyword1">𝒜[</span><span class="free">F</span><span class="main">]</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">distinguishes</span> <span class="free">P</span> <span class="keyword1">from</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> FL_logically_equivalent_def Not is_distinguishing_formula_def FL_valid_Not<span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There exists a distinguishing formula for~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in~<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>𝒜[F]›</span></span></span></span> whose
    support is contained in~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"supp <span class="main"><span class="main">(</span></span><span class="free"><span class="free">F</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">P</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

  <span class="keyword1" id="FL_Equivalence_Implies_Bisimilarity-FL_distinguished_bounded_support"><span class="command">lemma</span></span> FL_distinguished_bounded_support<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="keyword1">𝒜[</span><span class="free">F</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">distinguishes</span> <span class="free">P</span> <span class="keyword1">from</span> <span class="free">Q</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="keyword1">𝒜[</span><span class="free">F</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"supp <span class="free">y</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="free">F</span><span class="main">,</span><span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="keyword1">distinguishes</span> <span class="free">P</span> <span class="keyword1">from</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">|</span><span class="bound">p</span><span class="main">.</span> supp <span class="main">(</span><span class="free">F</span><span class="main">,</span><span class="free">P</span><span class="main">)</span> <span class="main">♯*</span> <span class="bound">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="free">F</span><span class="main">,</span><span class="free">P</span><span class="main">)</span> <span class="keyword1">supports</span> <span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> supports_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
      <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> supp <span class="main">(</span><span class="free">F</span><span class="main">,</span><span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> supp <span class="main">(</span><span class="free">F</span><span class="main">,</span><span class="free">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?B</span> <span class="main">⊆</span> <span class="var">?B</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="free">F</span><span class="main">,</span><span class="free">P</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_set_def<span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="var">?q</span> <span class="main">∙</span> <span class="free">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> a <span class="keyword2"><span class="keyword">and</span></span> b <span class="keyword2"><span class="keyword">and</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="free">F</span><span class="main">,</span><span class="free">P</span><span class="main">)</span> <span class="main">♯*</span> <span class="var">?q</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_perm fresh_star_def fresh_star_plus swap_atom_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">⊆</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?B</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="free">F</span><span class="main">,</span><span class="free">P</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?q</span> <span class="main">∙</span> <span class="free">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> a <span class="keyword2"><span class="keyword">and</span></span> b <span class="keyword2"><span class="keyword">and</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="free">F</span><span class="main">,</span><span class="free">P</span><span class="main">)</span> <span class="main">♯*</span> <span class="var">?q</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_perm fresh_star_def fresh_star_plus swap_atom_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?B</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> mem_permute_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?B</span> <span class="main">=</span> <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> supp_B_subset_supp_P<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="var">?B</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="free">F</span><span class="main">,</span><span class="free">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> finite_supp supp_is_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> finite_supp_B<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="var">?B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_supp rev_finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="main">`</span> UNIV"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?B</span><span class="main">|</span> <span class="keyword1">≤o</span> <span class="main">|</span>UNIV <span class="main">::</span> perm set<span class="main">|</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> surj_imp_ordLeq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV <span class="main">::</span> perm set<span class="main">|</span> <span class="keyword1">&lt;o</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_idx_perm<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span> <span class="keyword1">≤o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cnotzero_UNIV ordLeq_csum2<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> card_B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?B</span><span class="main">|</span> <span class="keyword1">&lt;o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Conj <span class="main">(</span>Abs_bset <span class="var">?B</span><span class="main">)</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">,</span> <span class="tfree">'effect</span><span class="main">)</span> formula"</span></span>

    <span class="keyword1"><span class="command">from</span></span> finite_supp_B <span class="keyword2"><span class="keyword">and</span></span> card_B <span class="keyword2"><span class="keyword">and</span></span> supp_B_subset_supp_P <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="var">?y</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="free">F</span><span class="main">,</span><span class="free">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">∈</span> <span class="keyword1">𝒜[</span><span class="free">F</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> formula <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> finite_supp_B card_B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> set_bset <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> formula <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh_p<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="free">F</span><span class="main">,</span><span class="free">P</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> card_B <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> fresh_p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="free">F</span> <span class="main">=</span> <span class="free">F</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> fresh_star_Pair fresh_star_supp_conv perm_supp_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="keyword1">𝒜[</span><span class="free">F</span><span class="main">]</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> <span class="keyword1">𝒜[</span><span class="free">F</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> p_x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_FL_formula_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="keyword1">distinguishes</span> <span class="free">P</span> <span class="keyword1">from</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_distinguishing_formula_def <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="keyword1">distinguishes</span> <span class="free">P</span> <span class="keyword1">from</span> <span class="free">Q</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> <span class="var">?y</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_B finite_supp_B<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> is_distinguishing_formula_def fresh_star_Un supp_Pair supp_perm_eq FL_valid_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="keyword1">distinguishes</span> <span class="free">P</span> <span class="keyword1">from</span> <span class="free">Q</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">Q</span> <span class="main">⊨</span> <span class="var">?y</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_B finite_supp_B<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> is_distinguishing_formula_def permute_zero fresh_star_zero<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="FL_Equivalence_Implies_Bisimilarity-FL_equivalence_is_L_bisimulation"><span class="command">lemma</span></span> FL_equivalence_is_L_bisimulation<span class="main">:</span> <span class="quoted"><span class="quoted">"is_L_bisimulation FL_logically_equivalent"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">F</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"symp <span class="main">(</span>FL_logically_equivalent <span class="skolem">F</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sympI<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> FL_logically_equivalent_def<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">F</span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">f</span> <span class="skolem">φ</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"FL_logically_equivalent <span class="skolem">F</span> <span class="skolem">P</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> FL_logically_equivalent_def Pred FL_valid_Pred<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">F</span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">P'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"FL_logically_equivalent <span class="skolem">F</span> <span class="skolem">P</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="bound">Q'</span><span class="main">⟩</span> <span class="main">∧</span> FL_logically_equivalent <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="skolem">P'</span> <span class="bound">Q'</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">Q'</span><span class="main">.</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="bound">Q'</span><span class="main">⟩</span><span class="main">}</span>"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Q'</span><span class="main">∈</span><span class="var">?Q'</span><span class="main">.</span> <span class="main">¬</span> FL_logically_equivalent <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="skolem">P'</span> <span class="bound">Q'</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Q'</span><span class="main">∈</span><span class="var">?Q'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">,</span> <span class="tfree">'effect</span><span class="main">)</span> formula<span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="keyword1">𝒜[</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span><span class="main">]</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">distinguishes</span> <span class="skolem">P'</span> <span class="keyword1">from</span> <span class="bound">Q'</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> FL_equivalent_iff_not_distinguished<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Q'</span><span class="main">∈</span><span class="var">?Q'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">,</span> <span class="tfree">'effect</span><span class="main">)</span> formula<span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="keyword1">𝒜[</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span><span class="main">]</span> <span class="main">∧</span> supp <span class="bound">x</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">distinguishes</span> <span class="skolem">P'</span> <span class="keyword1">from</span> <span class="bound">Q'</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> FL_distinguished_bounded_support<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">,</span> <span class="tfree">'effect</span><span class="main">)</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
              *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Q'</span><span class="main">∈</span><span class="var">?Q'</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">Q'</span> <span class="main">∈</span> <span class="keyword1">𝒜[</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span><span class="main">]</span> <span class="main">∧</span> supp <span class="main">(</span><span class="skolem">g</span> <span class="bound">Q'</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">g</span> <span class="bound">Q'</span><span class="main">)</span> <span class="keyword1">distinguishes</span> <span class="skolem">P'</span> <span class="keyword1">from</span> <span class="bound">Q'</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="skolem">g</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> set_bounded_supp<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> finite_supp<span class="main"><span class="keyword3">,</span></span> <span class="operator">cut_tac</span> <span class="quoted">"*"</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> finite_supp_image<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span><span class="skolem">g</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> finite_supp rev_finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="skolem">g</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">|</span> <span class="keyword1">≤o</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'state</span> set<span class="main">|</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_of_UNIV card_of_image ordLeq_transitive<span class="main">)</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'state</span> set<span class="main">|</span> <span class="keyword1">&lt;o</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_idx_state<span class="main">)</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span> <span class="keyword1">≤o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cnotzero_UNIV ordLeq_csum2<span class="main">)</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> card_image<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="skolem">g</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">|</span> <span class="keyword1">&lt;o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Conj <span class="main">(</span>Abs_bset <span class="main">(</span><span class="skolem">g</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">)</span><span class="main">)</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">,</span> <span class="tfree">'effect</span><span class="main">)</span> formula"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Act <span class="skolem">f</span> <span class="skolem">α</span> <span class="var">?y</span> <span class="main">∈</span> <span class="keyword1">𝒜[</span><span class="skolem">F</span><span class="main">]</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span>
                <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">F</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> fresh_star_Pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Conj <span class="main">(</span>Abs_bset <span class="main">(</span><span class="skolem">g</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">𝒜[</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span><span class="main">]</span>"</span></span>
                  <span class="keyword1"><span class="command">proof</span></span>
                    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>Abs_bset <span class="main">(</span><span class="skolem">g</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">)</span> <span class="main">::</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> formula <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> finite_supp_image card_image <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command">next</span></span>
                    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span>
                    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> set_bset <span class="main">(</span>Abs_bset <span class="main">(</span><span class="skolem">g</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">)</span> <span class="main">::</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> formula <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="skolem">g</span> <span class="skolem">Q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">Q'</span><span class="main">⟩</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> card_image <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"*"</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> <span class="keyword1">𝒜[</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span><span class="main">]</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> mem_Collect_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊨</span> Act <span class="skolem">f</span> <span class="skolem">α</span> <span class="var">?y</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> FL_valid_Act <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword1"><span class="command">{</span></span>
                  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q'</span>
                  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">Q'</span><span class="main">⟩</span>"</span></span>
                  <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"*"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> <span class="skolem">g</span> <span class="skolem">Q'</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_distinguishing_formula_def mem_Collect_eq<span class="main">)</span>
                <span class="keyword1"><span class="command">}</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> <span class="var">?y</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_supp_image card_image<span class="main">)</span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">Q</span> <span class="main">⊨</span> Act <span class="skolem">f</span> <span class="skolem">α</span> <span class="var">?y</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⊨</span> Act <span class="skolem">f</span> <span class="skolem">α</span> <span class="var">?y</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">Q'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">⊨</span> <span class="var">?y</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_star_Pair FL_valid_Act_fresh<span class="main">)</span>
                <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Q''</span><span class="main">.</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="bound">Q''</span><span class="main">⟩</span> <span class="main">⟶</span> <span class="skolem">Q'</span> <span class="main">⊨</span> <span class="skolem">g</span> <span class="bound">Q''</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_supp_image card_image<span class="main">)</span>
                <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"*"</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
                  <span class="keyword1"><span class="command">using</span></span> is_distinguishing_formula_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹FL_logically_equivalent <span class="skolem">F</span> <span class="skolem">P</span> <span class="skolem">Q</span>›</span></span> FL_logically_equivalent_def<span class="main">)</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_L_bisimulation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">theorem</span></span> FL_equivalence_implies_bisimilarity<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"FL_logically_equivalent <span class="free">F</span> <span class="free">P</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∼⋅[</span><span class="free">F</span><span class="main">]</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> FL_bisimilar_def FL_equivalence_is_L_bisimulation<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="L_Transform">
<div class="head">
<h1>Theory L_Transform</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> L_Transform
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Validity">Validity</a>
  <a href="#Bisimilarity_Implies_Equivalence">Bisimilarity_Implies_Equivalence</a>
  <a href="#FL_Equivalence_Implies_Bisimilarity">FL_Equivalence_Implies_Bisimilarity</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹\texorpdfstring{$L$}{L}-Transform›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹States›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The intuition is that states of kind~<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>AC›</span></span></span></span> can perform ordinary actions, and states of
kind~<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>EF›</span></span></span></span> can commit effects.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'effect</span><span class="main">)</span> L_state <span class="main">=</span>
    AC <span class="quoted"><span class="quoted">"<span class="tfree">'effect</span> <span class="main">×</span> <span class="tfree">'effect</span> fs_set <span class="main">×</span> <span class="tfree">'state</span>"</span></span>
  <span class="main">|</span> EF <span class="quoted"><span class="quoted">"<span class="tfree">'effect</span> fs_set <span class="main">×</span> <span class="tfree">'state</span>"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> L_state <span class="main">::</span> <span class="main">(</span><span class="quoted">pt</span><span class="main">,</span><span class="quoted">pt</span><span class="main">)</span> <span class="quoted">pt</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">permute_L_state</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"perm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> L_state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> L_state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="main">(</span>AC <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> AC <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="main">(</span>EF <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> EF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> L_state"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> L_state"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">+</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">declare</span></span> permute_L_state.simps <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span>

<span class="keyword1" id="L_Transform-supp_AC"><span class="command">lemma</span></span> supp_AC <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>AC <span class="free">x</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="L_Transform-supp_EF"><span class="command">lemma</span></span> supp_EF <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>EF <span class="free">x</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">instantiation</span></span> L_state <span class="main">::</span> <span class="main">(</span><span class="quoted">fs</span><span class="main">,</span><span class="quoted">fs</span><span class="main">)</span> <span class="quoted">fs</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> L_state"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_supp<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Actions and binding names›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'effect</span><span class="main">)</span> L_action <span class="main">=</span>
    Act <span class="tfree"><span class="quoted"><span class="tfree">'act</span></span></span>
  <span class="main">|</span> Eff <span class="tfree"><span class="quoted"><span class="tfree">'effect</span></span></span>

<span class="keyword1"><span class="command">instantiation</span></span> L_action <span class="main">::</span> <span class="main">(</span><span class="quoted">pt</span><span class="main">,</span><span class="quoted">pt</span><span class="main">)</span> <span class="quoted">pt</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">permute_L_action</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"perm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> L_action <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> L_action"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="main">(</span>Act <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span> <span class="main">=</span> Act <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="main">(</span>Eff <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> Eff <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> L_action"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> L_action"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">+</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">declare</span></span> permute_L_action.simps <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span>

<span class="keyword1" id="L_Transform-supp_Act"><span class="command">lemma</span></span> supp_Act <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Act <span class="free">α</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">α</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="L_Transform-supp_Eff"><span class="command">lemma</span></span> supp_Eff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Eff <span class="free">f</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">instantiation</span></span> L_action <span class="main">::</span> <span class="main">(</span><span class="quoted">fs</span><span class="main">,</span><span class="quoted">fs</span><span class="main">)</span> <span class="quoted">fs</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> L_action"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_supp<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> L_action <span class="main">::</span> <span class="main">(</span><span class="quoted">bn</span><span class="main">,</span><span class="quoted">fs</span><span class="main">)</span> <span class="quoted">bn</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">bn_L_action</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> L_action <span class="main">⇒</span> atom set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">bn_L_action</span> <span class="main">(</span>Act <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span> <span class="main">=</span> bn <span class="free"><span class="bound"><span class="entity">α</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bn_L_action</span> <span class="main">(</span>Eff <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> L_action"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> bn <span class="skolem">α</span> <span class="main">=</span> bn <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">α</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bn_eqvt<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> L_action"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>bn <span class="skolem">α</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">α</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bn_finite<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Satisfaction›</span></span>

<span class="keyword1"><span class="command">context</span></span> effect_nominal_ts
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">L_satisfies</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'effect</span><span class="main">)</span> L_state <span class="main">⇒</span> <span class="tfree">'pred</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊢<span class="hidden">⇩</span><sub>L</sub></span>"</span> 70<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"AC <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"EF <span class="main"><span class="bound"><span class="entity">_</span></span></span>       <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">⟷</span> False"</span></span>

  <span class="keyword1" id="L_Transform-L_satisfies_eqvt"><span class="command">lemma</span></span> L_satisfies_eqvt<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">P<span class="hidden">⇩</span><sub>L</sub></span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>AC <span class="skolem">fFP</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>snd <span class="skolem">fFP</span><span class="main">)</span> <span class="main"><span class="free">⊢</span></span> <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L_satisfies.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prod.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>snd <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">fFP</span><span class="main">)</span><span class="main">)</span> <span class="main"><span class="free">⊢</span></span> <span class="free">p</span> <span class="main">∙</span> <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> satisfies_eqvt snd_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> AC <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L_satisfies.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> permute_L_state.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prod.collapse<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> EF
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transitions›</span></span>

<span class="keyword1"><span class="command">context</span></span> effect_nominal_ts
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">L_transition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'effect</span><span class="main">)</span> L_state <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'effect</span><span class="main">)</span> L_action<span class="main">,</span> <span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'effect</span><span class="main">)</span> L_state<span class="main">)</span> residual <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span>"</span> 70<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"AC <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="free"><span class="bound"><span class="entity">αP'</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">α</span> <span class="bound">P'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">αP'</span></span></span> <span class="main">=</span> <span class="main">⟨</span>Act <span class="bound">α</span><span class="main">,</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="bound">α</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">,</span> <span class="bound">P'</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∧</span> bn <span class="bound">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="comment1">― ‹note the freshness condition›</span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"EF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="free"><span class="bound"><span class="entity">αP'</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">αP'</span></span></span> <span class="main">=</span> <span class="main">⟨</span>Eff <span class="bound">f</span><span class="main">,</span> AC <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="bound">f</span><span class="main"><span class="free">⟩</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="L_Transform-L_transition_eqvt"><span class="command">lemma</span></span> L_transition_eqvt<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">α<span class="hidden">⇩</span><sub>L</sub>P<span class="hidden">⇩</span><sub>L</sub>'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">α<span class="hidden">⇩</span><sub>L</sub>P<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">P<span class="hidden">⇩</span><sub>L</sub></span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> AC
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">F</span> <span class="skolem">P</span>
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> AC <span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> αP'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α<span class="hidden">⇩</span><sub>L</sub>P<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="main">=</span> <span class="main">⟨</span>Act <span class="skolem">α</span><span class="main">,</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">)</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> trans <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transition_eqvt'<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> αP' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="free">α<span class="hidden">⇩</span><sub>L</sub>P<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="main">=</span> <span class="main">⟨</span>Act <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span><span class="main">,</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">F</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">f</span><span class="main">)</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L_eqvt'<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> fresh <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">♯*</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">F</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">f</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bn_eqvt fresh_star_Pair fresh_star_permute_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="free">P<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">p</span> <span class="main">∙</span> <span class="free">α<span class="hidden">⇩</span><sub>L</sub>P<span class="hidden">⇩</span><sub>L</sub>'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"*"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">with</span></span> AC <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> EF
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">F</span> <span class="skolem">P</span>
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> EF <span class="main">(</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">α<span class="hidden">⇩</span><sub>L</sub>P<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="main">=</span> <span class="main">⟨</span>Eff <span class="skolem">f</span><span class="main">,</span> AC <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">f</span><span class="main">)</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="free">α<span class="hidden">⇩</span><sub>L</sub>P<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="main">=</span> <span class="main">⟨</span>Eff <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">f</span><span class="main">)</span><span class="main">,</span> AC <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">f</span><span class="main">,</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="free">P<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">p</span> <span class="main">∙</span> <span class="free">α<span class="hidden">⇩</span><sub>L</sub>P<span class="hidden">⇩</span><sub>L</sub>'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"*"</span> L_transition.simps<span class="main">(</span>2<span class="main">)</span> Pair_eqvt permute_L_state.simps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">with</span></span> EF <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The binding names in the alpha-variant that witnesses the $L$-transition may be chosen fresh
  for any finitely supported context.›</span></span>

  <span class="keyword1" id="L_Transform-L_transition_AC_strong"><span class="command">lemma</span></span> L_transition_AC_strong<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">X</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"AC <span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">F</span><span class="main">,</span><span class="free">P</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⟨</span><span class="free">α<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span><span class="free">P<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">⟩</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">α</span> <span class="bound">P'</span><span class="main">.</span> <span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="main">⟨</span><span class="free">α<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span><span class="free">P<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span>Act <span class="bound">α</span><span class="main">,</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="bound">α</span><span class="main">,</span><span class="free">F</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">,</span> <span class="bound">P'</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∧</span> bn <span class="bound">α</span> <span class="main">♯*</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹AC <span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">F</span><span class="main">,</span><span class="free">P</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⟨</span><span class="free">α<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span><span class="free">P<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">⟩</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> transition<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> alpha<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">α<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span><span class="free">P<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span>Act <span class="skolem">α</span><span class="main">,</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="free">F</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">)</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="free">F</span><span class="main">,</span><span class="free">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L_transition.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Act</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Act <span class="skolem">α</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'effect</span><span class="main">)</span> L_action"</span></span> <span class="comment1">― ‹the type annotation prevents a type that is too polymorphic and doesn't fix~<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted"><span class="tfree">'effect</span></span><span class="antiquote">}</span></span>›</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>bn <span class="skolem">α</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> bn_finite<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>supp <span class="free">X</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span><span class="main">⟨</span><span class="var">?Act</span><span class="main">,</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="free">F</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">)</span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span><span class="main">,</span> <span class="free">F</span><span class="main">,</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_Diff finite_UnI finite_supp supp_Pair supp_abs_residual_pair<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> fresh <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?Act</span><span class="main">,</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="free">F</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">)</span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span><span class="main">,</span> <span class="free">F</span><span class="main">,</span> <span class="free">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_def supp_Pair supp_abs_residual_pair<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> fresh_X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> bn <span class="skolem">α</span><span class="main">)</span> <span class="main">♯*</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="main">⟨</span><span class="var">?Act</span><span class="main">,</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="free">F</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">)</span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span><span class="main">,</span> <span class="free">F</span><span class="main">,</span> <span class="free">f</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> at_set_avoiding2<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">⟨</span><span class="var">?Act</span><span class="main">,</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="free">F</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">)</span><span class="main">⟩</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="free">F</span><span class="main">,</span><span class="free">f</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_star_Un supp_Pair<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="main">⟨</span><span class="var">?Act</span><span class="main">,</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="free">F</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">)</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="var">?Act</span><span class="main">,</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="free">F</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">)</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="main">(</span><span class="free">F</span><span class="main">,</span><span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">F</span><span class="main">,</span><span class="free">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> supp_perm_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Act <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span><span class="main">,</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">,</span> <span class="free">F</span><span class="main">,</span> <span class="free">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">)</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="var">?Act</span><span class="main">,</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="free">F</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">)</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">,</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> permute_L_action.simps<span class="main">(</span>1<span class="main">)</span> permute_L_state.simps<span class="main">(</span>2<span class="main">)</span> abs_residual_pair_eqvt L_eqvt' Pair_eqvt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">α</span> <span class="bound">P'</span><span class="main">.</span> <span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="main">⟨</span><span class="free">α<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span><span class="free">P<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span>Act <span class="bound">α</span><span class="main">,</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="bound">α</span><span class="main">,</span><span class="free">F</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">,</span> <span class="bound">P'</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∧</span> bn <span class="bound">α</span> <span class="main">♯*</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> transition <span class="keyword2"><span class="keyword">and</span></span> alpha <span class="keyword2"><span class="keyword">and</span></span> fresh_X <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bn_eqvt<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">(* bn α ♯* (F,f) is required for the ⟵ implication as well as for the ⟶ implication;
     additionally bn α ♯* P is required for the ⟶ implication. *)</span>

  <span class="keyword1" id="L_Transform-L_transition_AC_fresh"><span class="command">lemma</span></span> L_transition_AC_fresh<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bn <span class="free">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="free">F</span><span class="main">,</span><span class="free">f</span><span class="main">,</span><span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"AC <span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">F</span><span class="main">,</span><span class="free">P</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⟨</span>Act <span class="free">α</span><span class="main">,</span> <span class="free">P<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">⟩</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> <span class="free">P<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="main">=</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="free">α</span><span class="main">,</span><span class="free">F</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">,</span> <span class="bound">P'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">α</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"AC <span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">F</span><span class="main">,</span><span class="free">P</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⟨</span>Act <span class="free">α</span><span class="main">,</span> <span class="free">P<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span><span class="free">F</span><span class="main">,</span><span class="free">f</span><span class="main">,</span><span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> finite_supp<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Act <span class="free">α</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'effect</span><span class="main">)</span> L_action<span class="main">,</span> <span class="free">P<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span>Act <span class="skolem">α'</span><span class="main">,</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α'</span><span class="main">,</span><span class="free">F</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">)</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α'</span> <span class="main">♯*</span> <span class="main">(</span><span class="free">F</span><span class="main">,</span><span class="free">f</span><span class="main">,</span><span class="free">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> L_transition_AC_strong <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="main">(</span>Act <span class="free">α</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'effect</span><span class="main">)</span> L_action<span class="main">,</span> <span class="free">P<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Act <span class="skolem">α'</span><span class="main">,</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α'</span><span class="main">,</span><span class="free">F</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> supp_p<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="skolem">p</span> <span class="main">⊆</span> bn <span class="main">(</span>Act <span class="free">α</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'effect</span><span class="main">)</span> L_action<span class="main">)</span> <span class="main">∪</span> <span class="skolem">p</span> <span class="main">∙</span> bn <span class="main">(</span>Act <span class="free">α</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'effect</span><span class="main">)</span> L_action<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> residual_eq_iff_perm_renaming <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> p_α<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="free">α</span> <span class="main">=</span> <span class="skolem">α'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_P<span class="hidden">⇩</span><sub>L</sub>'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="free">P<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="main">=</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α'</span><span class="main">,</span><span class="free">F</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

    <span class="keyword1"><span class="command">from</span></span> supp_p <span class="keyword2"><span class="keyword">and</span></span> p_α <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> fresh <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="skolem">p</span> <span class="main">♯*</span> <span class="main">(</span><span class="free">F</span><span class="main">,</span> <span class="free">f</span><span class="main">,</span> <span class="free">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bn_eqvt fresh_star_def<span class="main">)</span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> p_F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="free">F</span> <span class="main">=</span> <span class="free">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="free">P</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Pair perm_supp_eq<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> p_P<span class="hidden">⇩</span><sub>L</sub>' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="main">=</span> <span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α'</span><span class="main">,</span><span class="free">F</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="main">=</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="free">α</span><span class="main">,</span><span class="free">F</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">,</span> <span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p_α p_F p_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> trans <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">α</span><span class="main">,</span> <span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p_P <span class="keyword2"><span class="keyword">and</span></span> p_α <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> transition_eqvt'<span class="main">)</span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> <span class="free">P<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="main">=</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="free">α</span><span class="main">,</span><span class="free">F</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">,</span> <span class="bound">P'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">α</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> <span class="free">P<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="main">=</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="free">α</span><span class="main">,</span><span class="free">F</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">,</span> <span class="bound">P'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">α</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn <span class="free">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="free">F</span><span class="main">,</span><span class="free">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Pair<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"AC <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">F</span><span class="main">,</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⟨</span>Act <span class="free">α</span><span class="main">,</span> <span class="free">P<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> L_transition.simps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Translation of \texorpdfstring{$F/L$}{F/L}-formulas into formulas without effects›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Since we defined formulas via a manual quotient construction, we also need to define the
$L$-transform via lifting from the underlying type of infinitely branching trees. As before, we
cannot use {\bf nominal\_function} because that generates proof obligations where, for formulas
of the form~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Conj <span class="free"><span class="free">xset</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the assumption that~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xset</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> has finite support is missing.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following auxiliary function returns trees (modulo $\alpha$-equivalence) rather than
formulas. This allows us to prove equivariance for \emph{all} argument trees, without an assumption
that they are (hereditarily) finitely supported. Further below--after this auxiliary function has
been lifted to $F/L$-formulas as arguments--we derive a version that returns formulas.›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">L_transform_Tree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>fs<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">,</span><span class="tfree">'eff</span><span class="main">::</span>fs<span class="main">)</span> Tree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'eff</span><span class="main">)</span> L_action<span class="main">)</span> Formula.Tree<span class="hidden">⇩</span><sub>α</sub>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">L_transform_Tree</span> <span class="main">(</span>tConj <span class="free"><span class="bound"><span class="entity">tset</span></span></span><span class="main">)</span> <span class="main">=</span> Formula.Conj<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>map_bset <span class="free">L_transform_Tree</span> <span class="free"><span class="bound"><span class="entity">tset</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">L_transform_Tree</span> <span class="main">(</span>tNot <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> Formula.Not<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span><span class="free">L_transform_Tree</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">L_transform_Tree</span> <span class="main">(</span>tPred <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> Formula.Act<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>Eff <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">L_transform_Tree</span> <span class="main">(</span>tAct <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> Formula.Act<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>Eff <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.Act<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>Act <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">L_transform_Tree</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="L_Transform-L_transform_Tree_eqvt"><span class="command">lemma</span></span> L_transform_Tree_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> L_transform_Tree <span class="free">t</span> <span class="main">=</span> L_transform_Tree <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tConj <span class="skolem">tset</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> bset.map_cong0 map_bset_eqvt permute_fun_def permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> L_transform_Tree<span class="antiquote"><span class="antiquote">}</span></span></span></span> respects $\alpha$-equivalence.›</span></span>

<span class="keyword1" id="L_Transform-alpha_Tree_L_transform_Tree"><span class="command">lemma</span></span> alpha_Tree_L_transform_Tree<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"alpha_Tree <span class="free">t1</span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"L_transform_Tree <span class="free">t1</span> <span class="main">=</span> L_transform_Tree <span class="free">t2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alpha_Tree_induct'<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>alpha_tConj <span class="skolem">tset1</span> <span class="skolem">tset2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_bset <span class="main">(=)</span> <span class="main">(</span>map_bset L_transform_Tree <span class="skolem">tset1</span><span class="main">)</span> <span class="main">(</span>map_bset L_transform_Tree <span class="skolem">tset2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bset.rel_map<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> bset.rel_map<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> bset.rel_mono_strong<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bset.rel_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>alpha_tAct <span class="skolem">f1</span> <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="skolem">f2</span> <span class="skolem">α2</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹alpha_Tree <span class="main">(</span>FL_Formula.Tree.tAct <span class="skolem">f1</span> <span class="skolem">α1</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">(</span>FL_Formula.Tree.tAct <span class="skolem">f2</span> <span class="skolem">α2</span> <span class="skolem">t2</span><span class="main">)</span>›</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> <span class="skolem">t1</span><span class="main">)</span> <span class="keyword1">≈set</span> alpha_Tree <span class="main">(</span>supp_rel alpha_Tree<span class="main">)</span> <span class="skolem">p</span> <span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> <span class="skolem">α1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="skolem">p</span> <span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> <span class="skolem">α2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f1</span> <span class="main">=</span> <span class="skolem">f2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp_rel alpha_Tree <span class="skolem">t1</span> <span class="main">-</span> bn <span class="skolem">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> alpha<span class="main">:</span> <span class="quoted"><span class="quoted">"alpha_Tree <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">t1</span><span class="main">)</span> <span class="skolem">t2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> bn <span class="skolem">α1</span> <span class="main">=</span> bn <span class="skolem">α2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> alpha_tAct.IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp_rel Formula.alpha_Tree <span class="main">(</span>Formula.rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>L_transform_Tree <span class="skolem">t1</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> supp_rel alpha_Tree <span class="skolem">t1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> infinite_mono Formula.alpha_Tree_permute_rep_commute L_transform_Tree_eqvt mem_Collect_eq subsetI supp_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> fresh <span class="keyword1"><span class="command">have</span></span> fresh'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp_rel Formula.alpha_Tree <span class="main">(</span>Formula.rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>L_transform_Tree <span class="skolem">t1</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> bn <span class="skolem">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> DiffD1 DiffD2 DiffI fresh_star_def subsetCE<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> alpha <span class="keyword1"><span class="command">have</span></span> alpha'<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.alpha_Tree <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> Formula.rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>L_transform_Tree <span class="skolem">t1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Formula.rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>L_transform_Tree <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> alpha_tAct.IH<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Formula.alpha_Tree_permute_rep_commute L_transform_Tree_eqvt<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> fresh' alpha' eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp_rel Formula.alpha_Tree <span class="main">(</span>Formula.rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>L_transform_Tree <span class="skolem">t1</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> bn <span class="skolem">α1</span> <span class="main">=</span> supp_rel Formula.alpha_Tree <span class="main">(</span>Formula.rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>L_transform_Tree <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> bn <span class="skolem">α2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> Diff_eqvt Formula.alpha_Tree_eqvt' Formula.alpha_Tree_eqvt_aux Formula.alpha_Tree_supp_rel atom_set_perm_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> Formula.rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>L_transform_Tree <span class="skolem">t1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">≈set</span> Formula.alpha_Tree <span class="main">(</span>supp_rel Formula.alpha_Tree<span class="main">)</span> <span class="skolem">p</span> <span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> Formula.rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>L_transform_Tree <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ** <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> Act <span class="skolem">α1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="skolem">p</span> <span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> Act <span class="skolem">α2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> L_Transform.supp_Act alpha_set permute_L_action.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.Act<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>Act <span class="skolem">α1</span><span class="main">)</span> <span class="main">(</span>L_transform_Tree <span class="skolem">t1</span><span class="main">)</span> <span class="main">=</span> Formula.Act<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>Act <span class="skolem">α2</span><span class="main">)</span> <span class="main">(</span>L_transform_Tree <span class="skolem">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Formula.Act<span class="hidden">⇩</span><sub>α</sub>_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f1</span> <span class="main">=</span> <span class="skolem">f2</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹$L$-transform for trees modulo $\alpha$-equivalence.›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> L_transform_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>fs<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">,</span><span class="tfree">'eff</span><span class="main">::</span>fs<span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'eff</span><span class="main">)</span> L_action<span class="main">)</span> Formula.Tree<span class="hidden">⇩</span><sub>α</sub>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
    <span class="quoted">L_transform_Tree</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> alpha_Tree_L_transform_Tree<span class="main">)</span>

<span class="keyword1" id="L_Transform-L_transform_Tree"><span class="command">lemma</span></span> L_transform_Tree<span class="hidden">⇩</span><sub>α</sub>_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> L_transform_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> L_transform_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="L_Transform-L_transform_Tree"><span class="command">lemma</span></span> L_transform_Tree<span class="hidden">⇩</span><sub>α</sub>_Conj<span class="hidden">⇩</span><sub>α</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"L_transform_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>Conj<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">=</span> Formula.Conj<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>map_bset L_transform_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Conj<span class="hidden">⇩</span><sub>α</sub>_def' L_transform_Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> L_transform_Tree<span class="hidden">⇩</span><sub>α</sub>.rep_eq bset.map_comp bset.map_cong0 comp_apply<span class="main">)</span>

<span class="keyword1" id="L_Transform-L_transform_Tree"><span class="command">lemma</span></span> L_transform_Tree<span class="hidden">⇩</span><sub>α</sub>_Not<span class="hidden">⇩</span><sub>α</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"L_transform_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>Not<span class="hidden">⇩</span><sub>α</sub> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">=</span> Formula.Not<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>L_transform_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="L_Transform-L_transform_Tree"><span class="command">lemma</span></span> L_transform_Tree<span class="hidden">⇩</span><sub>α</sub>_Pred<span class="hidden">⇩</span><sub>α</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"L_transform_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free">f</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> Formula.Act<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>Eff <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Formula.Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="L_Transform-L_transform_Tree"><span class="command">lemma</span></span> L_transform_Tree<span class="hidden">⇩</span><sub>α</sub>_Act<span class="hidden">⇩</span><sub>α</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"L_transform_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">f</span> <span class="free">α</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">=</span> Formula.Act<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>Eff <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Formula.Act<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>Act <span class="free">α</span><span class="main">)</span> <span class="main">(</span>L_transform_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="L_Transform-finite_supp_map_bset_L_transform_Tree"><span class="command">lemma</span></span> finite_supp_map_bset_L_transform_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>map_bset L_transform_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eqvt map_bset"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eqvt L_transform_Tree<span class="hidden">⇩</span><sub>α</sub>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvtI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>map_bset L_transform_Tree<span class="hidden">⇩</span><sub>α</sub><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> supp_fun_eqvt supp_fun_app_eqvt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>map_bset L_transform_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> supp_fun_app <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>map_bset L_transform_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="L_Transform-L_transform_Tree"><span class="command">lemma</span></span> L_transform_Tree<span class="hidden">⇩</span><sub>α</sub>_preserves_hereditarily_fs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Formula.hereditarily_fs <span class="main">(</span>L_transform_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> hereditarily_fs.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Conj<span class="hidden">⇩</span><sub>α</sub> <span class="skolem">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Formula.hereditarily_fs.Conj<span class="hidden">⇩</span><sub>α</sub><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> imageE map_bset.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Not<span class="hidden">⇩</span><sub>α</sub> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Formula.hereditarily_fs.Not<span class="hidden">⇩</span><sub>α</sub><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pred<span class="hidden">⇩</span><sub>α</sub> <span class="skolem">f</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Formula.hereditarily_fs.Act<span class="hidden">⇩</span><sub>α</sub> Formula.hereditarily_fs.Pred<span class="hidden">⇩</span><sub>α</sub><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Act<span class="hidden">⇩</span><sub>α</sub> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">f</span> <span class="skolem">α</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Formula.hereditarily_fs.Act<span class="hidden">⇩</span><sub>α</sub><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹$L$-transform for $F/L$-formulas.›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> L_transform_formula <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>fs<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">,</span><span class="tfree">'eff</span><span class="main">::</span>fs<span class="main">)</span> formula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'eff</span><span class="main">)</span> L_action<span class="main">)</span> Formula.Tree<span class="hidden">⇩</span><sub>α</sub>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
    <span class="quoted">L_transform_Tree<span class="hidden">⇩</span><sub>α</sub></span>
  <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="L_Transform-L_transform_formula_eqvt"><span class="command">lemma</span></span> L_transform_formula_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> L_transform_formula <span class="free">x</span> <span class="main">=</span> L_transform_formula <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="L_Transform-L_transform_formula_Conj"><span class="command">lemma</span></span> L_transform_formula_Conj <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"L_transform_formula <span class="main">(</span>Conj <span class="free">xset</span><span class="main">)</span> <span class="main">=</span> Formula.Conj<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>map_bset L_transform_formula <span class="free">xset</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Conj_def L_transform_formula_def bset.map_comp map_fun_def<span class="main">)</span>

<span class="keyword1" id="L_Transform-L_transform_formula_Not"><span class="command">lemma</span></span> L_transform_formula_Not <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"L_transform_formula <span class="main">(</span>Not <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Formula.Not<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>L_transform_formula <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="L_Transform-L_transform_formula_Pred"><span class="command">lemma</span></span> L_transform_formula_Pred <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"L_transform_formula <span class="main">(</span>Pred <span class="free">f</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> Formula.Act<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>Eff <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Formula.Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="L_Transform-L_transform_formula_Act"><span class="command">lemma</span></span> L_transform_formula_Act <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"L_transform_formula <span class="main">(</span>FL_Formula.Act <span class="free">f</span> <span class="free">α</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Formula.Act<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>Eff <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Formula.Act<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>Act <span class="free">α</span><span class="main">)</span> <span class="main">(</span>L_transform_formula <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="L_Transform-L_transform_formula_hereditarily_fs"><span class="command">lemma</span></span> L_transform_formula_hereditarily_fs <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.hereditarily_fs <span class="main">(</span>L_transform_formula <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">fact</span> L_transform_Tree<span class="hidden">⇩</span><sub>α</sub>_preserves_hereditarily_fs<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally, we define the proper $L$-transform, which returns formulas instead of trees.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">L_transform</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>fs<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">,</span><span class="tfree">'eff</span><span class="main">::</span>fs<span class="main">)</span> formula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'eff</span><span class="main">)</span> L_action<span class="main">)</span> Formula.formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">L_transform</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Formula.Abs_formula <span class="main">(</span>L_transform_formula <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="L_Transform-L_transform_eqvt"><span class="command">lemma</span></span> L_transform_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> L_transform <span class="free">x</span> <span class="main">=</span> L_transform <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> L_transform_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="L_Transform-finite_supp_map_bset_L_transform"><span class="command">lemma</span></span> finite_supp_map_bset_L_transform <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>map_bset L_transform <span class="free">xset</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eqvt map_bset"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eqvt L_transform"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvtI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>map_bset L_transform<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> supp_fun_eqvt supp_fun_app_eqvt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>map_bset L_transform <span class="free">xset</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">xset</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> supp_fun_app <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>map_bset L_transform <span class="free">xset</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="L_Transform-L_transform_Conj"><span class="command">lemma</span></span> L_transform_Conj <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"L_transform <span class="main">(</span>Conj <span class="free">xset</span><span class="main">)</span> <span class="main">=</span> Formula.Conj <span class="main">(</span>map_bset L_transform <span class="free">xset</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> L_transform_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Formula.Conj_def bset.map_comp o_def<span class="main">)</span>

<span class="keyword1" id="L_Transform-L_transform_Not"><span class="command">lemma</span></span> L_transform_Not <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"L_transform <span class="main">(</span>Not <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Formula.Not <span class="main">(</span>L_transform <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> L_transform_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Formula.Not_def<span class="main">)</span>

<span class="keyword1" id="L_Transform-L_transform_Pred"><span class="command">lemma</span></span> L_transform_Pred <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"L_transform <span class="main">(</span>Pred <span class="free">f</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> Formula.Act <span class="main">(</span>Eff <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Formula.Pred <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> L_transform_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Formula.Act_def Formula.Pred_def Formula.hereditarily_fs.Pred<span class="hidden">⇩</span><sub>α</sub><span class="main">)</span>

<span class="keyword1" id="L_Transform-L_transform_Act"><span class="command">lemma</span></span> L_transform_Act <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"L_transform <span class="main">(</span>FL_Formula.Act <span class="free">f</span> <span class="free">α</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Formula.Act <span class="main">(</span>Eff <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Formula.Act <span class="main">(</span>Act <span class="free">α</span><span class="main">)</span> <span class="main">(</span>L_transform <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> L_transform_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Formula.Act_def Formula.hereditarily_fs.Act<span class="hidden">⇩</span><sub>α</sub><span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> effect_nominal_ts
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">interpretation</span></span> L_transform<span class="main">:</span> nominal_ts <span class="quoted"><span class="quoted">"<span class="keyword1">(⊢<span class="hidden">⇩</span><sub>L</sub>)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(→<span class="hidden">⇩</span><sub>L</sub>)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">fact</span> L_satisfies_eqvt<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> L_transition_eqvt<span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The $L$-transform preserves satisfaction of formulas in the following sense:›</span></span>

  <span class="keyword1"><span class="command">theorem</span></span> FL_valid_iff_valid_L_transform<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'effect</span><span class="main">)</span> formula<span class="main">)</span> <span class="main">∈</span> <span class="keyword1">𝒜[</span><span class="free">F</span><span class="main">]</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FL_valid <span class="free">P</span> <span class="free">x</span> <span class="main">⟷</span> L_transform.valid <span class="main">(</span>EF <span class="main">(</span><span class="free">F</span><span class="main">,</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L_transform <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Conj <span class="skolem">xset</span> <span class="skolem">F</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> imageE map_bset.rep_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_bset.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Not <span class="skolem">F</span> <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pred <span class="skolem">f</span> <span class="skolem">F</span> <span class="skolem">φ</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?φ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula.Pred <span class="skolem">φ</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'effect</span><span class="main">)</span> L_action<span class="main">)</span> Formula.formula"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"FL_valid <span class="skolem">P</span> <span class="main">(</span>Pred <span class="skolem">f</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"L_transform.valid <span class="main">(</span>AC <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span><span class="main">)</span><span class="main">)</span> <span class="var">?φ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L_transform.valid_Act<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">F</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"EF <span class="main">(</span><span class="skolem">F</span><span class="main">,</span> <span class="skolem">P</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⟨</span>Eff <span class="skolem">f</span><span class="main">,</span> AC <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L_transition.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"L_transform.valid <span class="main">(</span>EF <span class="main">(</span><span class="skolem">F</span><span class="main">,</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L_transform <span class="main">(</span>Pred <span class="skolem">f</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> L_transform.valid_Act <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"L_transform.valid <span class="main">(</span>EF <span class="main">(</span><span class="skolem">F</span><span class="main">,</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L_transform <span class="main">(</span>Pred <span class="skolem">f</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"EF <span class="main">(</span><span class="skolem">F</span><span class="main">,</span> <span class="skolem">P</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⟨</span>Eff <span class="skolem">f</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"L_transform.valid <span class="skolem">P'</span> <span class="var">?φ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> bn_L_action.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> empty_iff fresh_star_def L_transform.valid_Act_fresh L_transform.valid_Pred L_transition.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> trans <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">=</span> AC <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> residual_empty_bn_eq_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> valid <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"FL_valid <span class="skolem">P</span> <span class="main">(</span>Pred <span class="skolem">f</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Act <span class="skolem">f</span> <span class="skolem">F</span> <span class="skolem">α</span> <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"FL_valid <span class="skolem">P</span> <span class="main">(</span>FL_Formula.Act <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"FL_Formula.Act <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">x</span> <span class="main">=</span> FL_Formula.Act <span class="skolem">f</span> <span class="skolem">α'</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"FL_valid <span class="skolem">P'</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α'</span> <span class="main">♯*</span> <span class="main">(</span><span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> FL_valid_Act_strong finite_supp<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_α<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span> <span class="main">=</span> <span class="skolem">α'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> supp_p<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="skolem">p</span> <span class="main">⊆</span> bn <span class="skolem">α</span> <span class="main">∪</span> bn <span class="skolem">α'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bn_eqvt FL_Formula.Act_eq_iff_perm_renaming<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> supp_p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Pair fresh_star_def supp_Pair fresh_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">F</span> <span class="main">=</span> <span class="skolem">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">f</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> supp_perm_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

      <span class="keyword1"><span class="command">from</span></span> valid <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FL_valid <span class="main">(</span><span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> p_x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> FL_valid_eqvt permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"L_transform.valid <span class="main">(</span>EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span><span class="main">,</span> <span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L_transform <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Act.hyps<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"L_transform.valid <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span><span class="main">,</span> <span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> L_transform <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> L_transform.valid_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"L_transform.valid <span class="main">(</span>EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α'</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L_transform <span class="skolem">x'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> p_x <span class="keyword2"><span class="keyword">and</span></span> p_α <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">F</span> <span class="main">=</span> <span class="skolem">F</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">f</span> <span class="main">=</span> <span class="skolem">f</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"L_transform.valid <span class="main">(</span>AC <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Formula.Act <span class="main">(</span>Act <span class="skolem">α'</span><span class="main">)</span> <span class="main">(</span>L_transform <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> trans fresh L_transform.valid_Act <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">F</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"L_transform.valid <span class="main">(</span>EF <span class="main">(</span><span class="skolem">F</span><span class="main">,</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L_transform <span class="main">(</span>FL_Formula.Act <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> L_transform.valid_Act <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"L_transform.valid <span class="main">(</span>EF <span class="main">(</span><span class="skolem">F</span><span class="main">,</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L_transform <span class="main">(</span>FL_Formula.Act <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

      <span class="comment1">― ‹rename~<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"bn <span class="skolem">α</span>"</span><span class="antiquote">}</span></span> to avoid~<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">(</span><span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">,</span> <span class="skolem">P</span><span class="main">)</span>"</span><span class="antiquote">}</span></span>, without touching~<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">F</span></span><span class="antiquote">}</span></span> or~<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"FL_Formula.Act <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">x</span>"</span><span class="antiquote">}</span></span>›</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> bn <span class="skolem">α</span><span class="main">)</span> <span class="main">♯*</span> <span class="main">(</span><span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">,</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="skolem">F</span><span class="main">,</span> FL_Formula.Act <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> at_set_avoiding2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"bn <span class="skolem"><span class="skolem">α</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">F</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">f</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">P</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">F</span></span><span class="main"><span class="main">,</span></span> FL_Formula.Act <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="skolem"><span class="skolem">x</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> exE<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>bn <span class="skolem">α</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> bn_finite<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span><span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">,</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> finite_supp<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span><span class="skolem">F</span><span class="main">,</span> FL_Formula.Act <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_supp<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="skolem">F</span><span class="main">,</span> FL_Formula.Act <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Pair fresh_star_def fresh_def supp_Pair<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="skolem">F</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Act_fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>FL_Formula.Act <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Pair fresh_star_def supp_Pair<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹supp <span class="skolem">F</span> <span class="main">♯*</span> <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">F</span> <span class="main">=</span> <span class="skolem">F</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> supp_perm_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Act_fresh <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">f</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fresh_star_Un supp_perm_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">from</span></span> Act_fresh <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"FL_Formula.Act <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">x</span> <span class="main">=</span> FL_Formula.Act <span class="skolem">f</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> FL_Formula.Act_eq_iff_perm FL_Formula.Act_eqvt supp_perm_eq<span class="main">)</span>

      <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"EF <span class="main">(</span><span class="skolem">F</span><span class="main">,</span> <span class="skolem">P</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⟨</span>Eff <span class="skolem">f</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"L_transform.valid <span class="skolem">P'</span> <span class="main">(</span>Formula.Act <span class="main">(</span>Act <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L_transform <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> L_transform_Act <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L_transform.valid_Act_fresh bn_L_action.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> empty_iff fresh_star_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> trans <span class="keyword1"><span class="command">have</span></span> P'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">=</span> AC <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> residual_empty_bn_eq_iff<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> supp_f_P<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="skolem">f</span> <span class="main">∪</span> supp <span class="skolem">P</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> effect_apply_eqvt supp_fun_app supp_fun_app_eqvt <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn <span class="main">(</span>Act <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span><span class="main">)</span> <span class="main">♯*</span> AC <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bn_eqvt fresh_star_def fresh_def supp_Pair<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> valid <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P''</span></span> <span class="keyword2"><span class="keyword">where</span></span> trans'<span class="main">:</span> <span class="quoted"><span class="quoted">"AC <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⟨</span>Act <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span><span class="main">,</span><span class="skolem">P''</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> valid'<span class="main">:</span> <span class="quoted"><span class="quoted">"L_transform.valid <span class="skolem">P''</span> <span class="main">(</span>L_transform <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> P' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L_transform.valid_Act_fresh<span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> supp_f_P <span class="keyword2"><span class="keyword">and</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">♯*</span> <span class="main">(</span><span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bn_eqvt fresh_star_def fresh_def supp_Pair<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> trans' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> P''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P''</span> <span class="main">=</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L_transition_AC_fresh<span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> valid' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"L_transform.valid <span class="main">(</span><span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P''</span><span class="main">)</span> <span class="main">(</span>L_transform <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> L_transform.valid_eqvt L_transform_eqvt permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> P'' <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">F</span> <span class="main">=</span> <span class="skolem">F</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">f</span> <span class="main">=</span> <span class="skolem">f</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"L_transform.valid <span class="main">(</span>EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span><span class="main">,</span> <span class="main">-</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L_transform <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> pemute_minus_self permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FL_valid <span class="skolem">P'</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Act.hyps<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> FL_valid_eqvt permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

      <span class="keyword1"><span class="command">with</span></span> trans'' <span class="keyword2"><span class="keyword">and</span></span> eq <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"FL_valid <span class="skolem">P</span> <span class="main">(</span>FL_Formula.Act <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> FL_valid_Act<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Bisimilarity in the \texorpdfstring{$L$}{L}-transform›</span></span>

<span class="keyword1"><span class="command">context</span></span> effect_nominal_ts
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="comment1">(* Not quite sure why this is needed again? *)</span>
  <span class="keyword1"><span class="command">interpretation</span></span> L_transform<span class="main">:</span> nominal_ts <span class="quoted"><span class="quoted">"<span class="keyword1">(⊢<span class="hidden">⇩</span><sub>L</sub>)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(→<span class="hidden">⇩</span><sub>L</sub>)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">fact</span> L_satisfies_eqvt<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> L_transition_eqvt<span class="main">)</span>

  <span class="keyword1"><span class="command">notation</span></span> L_transform.bisimilar <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">∼⋅<span class="hidden">⇩</span><sub>L</sub></span>"</span> 100<span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹$F/L$-bisimilarity is equivalent to bisimilarity in the $L$-transform.›</span></span>

  <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">L_bisimilar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'effect</span><span class="main">)</span> L_state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'effect</span><span class="main">)</span> L_state <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∼⋅[</span><span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">⟹</span> <span class="free">L_bisimilar</span> <span class="main">(</span>EF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>EF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∼⋅[</span><span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">⟹</span> <span class="free">L_bisimilar</span> <span class="main">(</span>AC <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main"><span class="free">⟩</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>AC <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main"><span class="free">⟩</span></span><span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="L_Transform-L_bisimilar_is_L_transform_bisimulation"><span class="command">lemma</span></span> L_bisimilar_is_L_transform_bisimulation<span class="main">:</span> <span class="quoted"><span class="quoted">"L_transform.is_bisimulation L_bisimilar"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> L_transform.is_bisimulation_def
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"symp L_bisimilar"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> FL_bisimilar_symp L_bisimilar.cases L_bisimilar.intros symp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">Q<span class="hidden">⇩</span><sub>L</sub></span><span class="main">.</span> L_bisimilar <span class="bound">P<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">Q<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span><span class="main">.</span> <span class="bound">P<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">φ</span> <span class="main">⟶</span> <span class="bound">Q<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">φ</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> FL_bisimilar_is_L_bisimulation L_bisimilar.simps is_L_bisimulation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">Q<span class="hidden">⇩</span><sub>L</sub></span><span class="main">.</span> L_bisimilar <span class="bound">P<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">Q<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">α<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">P<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">.</span> bn <span class="bound">α<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">♯*</span> <span class="bound">Q<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⟶</span> <span class="bound">P<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⟨</span><span class="bound">α<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span><span class="bound">P<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">⟩</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Q<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">.</span> <span class="bound">Q<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⟨</span><span class="bound">α<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span><span class="bound">Q<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">⟩</span> <span class="main">∧</span> L_bisimilar <span class="bound">P<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="bound">Q<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">α<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>L</sub>'</span>
        <span class="keyword3"><span class="command">assume</span></span> L_bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"L_bisimilar <span class="skolem">P<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh<span class="hidden">⇩</span><sub>L</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">♯*</span> <span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="hidden">⇩</span><sub>L</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⟨</span><span class="skolem">α<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span><span class="skolem">P<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">⟩</span>"</span></span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⟨</span><span class="skolem">α<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span><span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"L_bisimilar <span class="skolem">P<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub>'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> L_bisim <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> L_bisimilar.cases<span class="main">)</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">F</span> <span class="skolem">Q</span>
            <span class="keyword3"><span class="command">assume</span></span> P<span class="hidden">⇩</span><sub>L</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> EF <span class="main">(</span><span class="skolem">F</span><span class="main">,</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Q<span class="hidden">⇩</span><sub>L</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> EF <span class="main">(</span><span class="skolem">F</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∼⋅[</span><span class="skolem">F</span><span class="main">]</span> <span class="skolem">Q</span>"</span></span>
            <span class="keyword1"><span class="command">from</span></span> P<span class="hidden">⇩</span><sub>L</sub> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="hidden">⇩</span><sub>L</sub> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> effect<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> α<span class="hidden">⇩</span><sub>L</sub>P<span class="hidden">⇩</span><sub>L</sub>'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">α<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span><span class="skolem">P<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span>Eff <span class="skolem">f</span><span class="main">,</span> AC <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> L_transition.simps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">from</span></span> Q<span class="hidden">⇩</span><sub>L</sub> <span class="keyword2"><span class="keyword">and</span></span> effect <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⟨</span>Eff <span class="skolem">f</span><span class="main">,</span> AC <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> L_transition.simps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> bisim <span class="keyword2"><span class="keyword">and</span></span> effect <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"L_bisimilar <span class="main">(</span>AC <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>AC <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> L_bisimilar.intros<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> α<span class="hidden">⇩</span><sub>L</sub>P<span class="hidden">⇩</span><sub>L</sub>' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">α<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> Eff <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="main">=</span> AC <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bn_L_action.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> residual_empty_bn_eq_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">thesis</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">Q<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">.</span> <span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⟨</span><span class="skolem">α<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span><span class="bound">Q<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">⟩</span> <span class="main">⟹</span> L_bisimilar <span class="skolem">P<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="bound">Q<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="main">⟹</span> <span class="skolem">thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">F</span> <span class="skolem">Q</span> <span class="skolem">f</span>
            <span class="keyword3"><span class="command">assume</span></span> P<span class="hidden">⇩</span><sub>L</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> AC <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Q<span class="hidden">⇩</span><sub>L</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> AC <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∼⋅[</span><span class="skolem">F</span><span class="main">]</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> effect<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">F</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> finite_supp<span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> P<span class="hidden">⇩</span><sub>L</sub> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="hidden">⇩</span><sub>L</sub> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> trans_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> α<span class="hidden">⇩</span><sub>L</sub>P<span class="hidden">⇩</span><sub>L</sub>'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">α<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span><span class="skolem">P<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span>Act <span class="skolem">α</span><span class="main">,</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">)</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L_transition_AC_strong<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> bisim <span class="keyword2"><span class="keyword">and</span></span> effect <span class="keyword2"><span class="keyword">and</span></span> fresh <span class="keyword2"><span class="keyword">and</span></span> trans_P <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> trans_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">Q'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bisim'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">∼⋅[</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span><span class="main">]</span> <span class="skolem">Q'</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> FL_bisimilar_simulation_step<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> fresh <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> fresh_PairD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fresh_star_def<span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> Q<span class="hidden">⇩</span><sub>L</sub> <span class="keyword2"><span class="keyword">and</span></span> trans_Q <span class="keyword1"><span class="command">have</span></span> trans_Q<span class="hidden">⇩</span><sub>L</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⟨</span>Act <span class="skolem">α</span><span class="main">,</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">Q'</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L_transition.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

            <span class="keyword1"><span class="command">from</span></span> α<span class="hidden">⇩</span><sub>L</sub>P<span class="hidden">⇩</span><sub>L</sub>' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">α<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span><span class="skolem">P<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="main">(</span>Act <span class="skolem">α</span><span class="main">,</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> supp_p<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="skolem">p</span> <span class="main">⊆</span> bn <span class="skolem">α</span> <span class="main">∪</span> bn <span class="skolem">α<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> bn_L_action.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> residual_eq_iff_perm_renaming<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> supp_p <span class="keyword2"><span class="keyword">and</span></span> fresh <span class="keyword2"><span class="keyword">and</span></span> fresh<span class="hidden">⇩</span><sub>L</sub> <span class="keyword2"><span class="keyword">and</span></span> Q<span class="hidden">⇩</span><sub>L</sub> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="skolem">p</span> <span class="main">♯*</span> <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> fresh_star_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Un_iff fresh_Pair fresh_def subsetCE supp_AC<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> p_fQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span> <span class="main">=</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_Ff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="main">(</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def perm_supp_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command">from</span></span> p <span class="keyword2"><span class="keyword">and</span></span> p_Ff <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">α<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> Act <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="main">=</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Q<span class="hidden">⇩</span><sub>L</sub> <span class="keyword2"><span class="keyword">and</span></span> p_fQ <span class="keyword2"><span class="keyword">and</span></span> p_Ff <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> <span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">with</span></span> trans_Q<span class="hidden">⇩</span><sub>L</sub> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">p</span> <span class="main">∙</span> <span class="main">⟨</span>Act <span class="skolem">α</span><span class="main">,</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">Q'</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L_transform.transition_eqvt<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⟨</span>Act <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span><span class="main">,</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">Q'</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> p_Ff <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> p_Ff <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">F</span> <span class="main">=</span> <span class="skolem">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">f</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command">with</span></span> bisim' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">)</span> <span class="main">∼⋅[</span><span class="free">L</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">Q'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> FL_bisimilar_eqvt L_eqvt'<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"L_bisimilar <span class="main">(</span>EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">Q'</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L_bisimilar.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="skolem">thesis</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">Q<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">.</span> <span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⟨</span><span class="skolem">α<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span><span class="bound">Q<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">⟩</span> <span class="main">⟹</span> L_bisimilar <span class="skolem">P<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="bound">Q<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="main">⟹</span> <span class="skolem">thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">.</span> <span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⟨</span><span class="skolem">α<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span><span class="bound">Q<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">⟩</span> <span class="main">∧</span> L_bisimilar <span class="skolem">P<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="bound">Q<span class="hidden">⇩</span><sub>L</sub>'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">∧</span> <span class="var">?T</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">invL_FL_bisimilar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'effect</span> first <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">invL_FL_bisimilar</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> EF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="keyword1">∼⋅<span class="hidden">⇩</span><sub>L</sub></span> EF<span class="main">(</span><span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="L_Transform-invL_FL_bisimilar_is_L_bisimulation"><span class="command">lemma</span></span> invL_FL_bisimilar_is_L_bisimulation<span class="main">:</span> <span class="quoted"><span class="quoted">"is_L_bisimulation invL_FL_bisimilar"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_L_bisimulation_def
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">F</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"symp <span class="main">(</span>invL_FL_bisimilar <span class="skolem">F</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L_transform.bisimilar_symp invL_FL_bisimilar_def symp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> invL_FL_bisimilar <span class="skolem">F</span> <span class="bound">P</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">F</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span><span class="main">.</span> <span class="main"><span class="free">⟨</span></span><span class="bound">f</span><span class="main"><span class="free">⟩</span></span><span class="bound">P</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span> <span class="main">⟶</span> <span class="main"><span class="free">⟨</span></span><span class="bound">f</span><span class="main"><span class="free">⟩</span></span><span class="bound">Q</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">f</span> <span class="skolem">φ</span>
        <span class="keyword3"><span class="command">assume</span></span> bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"invL_FL_bisimilar <span class="skolem">F</span> <span class="skolem">P</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> effect<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> satisfies<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> bisim <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"EF <span class="main">(</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">P</span><span class="main">)</span> <span class="keyword1">∼⋅<span class="hidden">⇩</span><sub>L</sub></span> EF <span class="main">(</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">Q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> invL_FL_bisimilar_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn <span class="main">(</span>Eff <span class="skolem">f</span><span class="main">)</span> <span class="main">♯*</span> EF <span class="main">(</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">Q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> effect <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"EF <span class="main">(</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">P</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⟨</span>Eff <span class="skolem">f</span><span class="main">,</span> AC <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L_transition.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"EF <span class="main">(</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">Q</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⟨</span>Eff <span class="skolem">f</span><span class="main">,</span> <span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> L_bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"AC <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span><span class="main">)</span> <span class="keyword1">∼⋅<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub>'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L_transform.bisimilar_simulation_step<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> trans <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Eff <span class="skolem">f</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'effect</span><span class="main">)</span> L_action<span class="main">,</span> <span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span>Eff <span class="skolem">f'</span><span class="main">,</span> AC <span class="main">(</span><span class="skolem">f'</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f'</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L_transition.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Q<span class="hidden">⇩</span><sub>L</sub>'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="main">=</span> AC <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L_action.inject<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> bn_L_action.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> residual_empty_bn_eq_iff<span class="main">)</span>

        <span class="keyword1"><span class="command">from</span></span> satisfies <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"AC <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">φ</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L_satisfies.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> L_bisim <span class="keyword2"><span class="keyword">and</span></span> Q<span class="hidden">⇩</span><sub>L</sub>' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"AC <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">φ</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L_transform.bisimilar_is_bisimulation L_transform.is_bisimulation_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L_satisfies.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> invL_FL_bisimilar <span class="skolem">F</span> <span class="bound">P</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">F</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">α</span> <span class="bound">P'</span><span class="main">.</span> bn <span class="bound">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="bound">f</span><span class="main"><span class="free">⟩</span></span><span class="bound">Q</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main"><span class="free">⟨</span></span><span class="bound">f</span><span class="main"><span class="free">⟩</span></span><span class="bound">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="main"><span class="free">⟨</span></span><span class="bound">f</span><span class="main"><span class="free">⟩</span></span><span class="bound">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">Q'</span><span class="main">⟩</span> <span class="main">∧</span> invL_FL_bisimilar <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="bound">α</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span><span class="main">)</span> <span class="bound">P'</span> <span class="bound">Q'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">f</span> <span class="skolem">α</span> <span class="skolem">P'</span>
        <span class="keyword3"><span class="command">assume</span></span> bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"invL_FL_bisimilar <span class="skolem">F</span> <span class="skolem">P</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> effect<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> bisim <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"EF <span class="main">(</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">P</span><span class="main">)</span> <span class="keyword1">∼⋅<span class="hidden">⇩</span><sub>L</sub></span> EF <span class="main">(</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">Q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> invL_FL_bisimilar_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn <span class="main">(</span>Eff <span class="skolem">f</span><span class="main">)</span> <span class="main">♯*</span> EF <span class="main">(</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">Q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> effect <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"EF <span class="main">(</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">P</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⟨</span>Eff <span class="skolem">f</span><span class="main">,</span> AC <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L_transition.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> trans<span class="hidden">⇩</span><sub>L</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"EF <span class="main">(</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">Q</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⟨</span>Eff <span class="skolem">f</span><span class="main">,</span> <span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> L_bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"AC <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span><span class="main">)</span> <span class="keyword1">∼⋅<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub>'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L_transform.bisimilar_simulation_step<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> trans<span class="hidden">⇩</span><sub>L</sub> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Eff <span class="skolem">f</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'effect</span><span class="main">)</span> L_action<span class="main">,</span> <span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span>Eff <span class="skolem">f'</span><span class="main">,</span> AC <span class="main">(</span><span class="skolem">f'</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f'</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L_transition.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Q<span class="hidden">⇩</span><sub>L</sub>'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="main">=</span> AC <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L_action.inject<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> bn_L_action.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> residual_empty_bn_eq_iff<span class="main">)</span>

        <span class="keyword1"><span class="command">from</span></span> L_bisim <span class="keyword2"><span class="keyword">and</span></span> Q<span class="hidden">⇩</span><sub>L</sub>' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"AC <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span><span class="main">)</span> <span class="keyword1">∼⋅<span class="hidden">⇩</span><sub>L</sub></span> AC <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> fresh <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn <span class="main">(</span>Act <span class="skolem">α</span><span class="main">)</span> <span class="main">♯*</span> AC <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_def fresh_star_def supp_Pair<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> fresh <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Pair<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> trans <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"AC <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">P</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⟨</span>Act <span class="skolem">α</span><span class="main">,</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L_transition.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub>''</span></span> <span class="keyword2"><span class="keyword">where</span></span> trans<span class="hidden">⇩</span><sub>L</sub>'<span class="main">:</span> <span class="quoted"><span class="quoted">"AC <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⟨</span>Act <span class="skolem">α</span><span class="main">,</span> <span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub>''</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> L_bisim'<span class="main">:</span> <span class="quoted"><span class="quoted">"EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">)</span> <span class="keyword1">∼⋅<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub>''</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L_transform.bisimilar_simulation_step<span class="main">)</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> finite_supp<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> trans<span class="hidden">⇩</span><sub>L</sub>' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> trans'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">Q'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> alpha<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Act <span class="skolem">α</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'effect</span><span class="main">)</span> L_action<span class="main">,</span> <span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub>''</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span>Act <span class="skolem">α'</span><span class="main">,</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">Q'</span><span class="main">)</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh'<span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α'</span> <span class="main">♯*</span> <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L_transition_AC_strong<span class="main">)</span>

        <span class="keyword1"><span class="command">from</span></span> alpha <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Act <span class="skolem">α</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'effect</span><span class="main">)</span> L_action<span class="main">,</span> <span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub>''</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="main">(</span>Act <span class="skolem">α'</span><span class="main">,</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">Q'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> supp_p<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="skolem">p</span> <span class="main">⊆</span> bn <span class="skolem">α</span> <span class="main">∪</span> bn <span class="skolem">α'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_commute bn_L_action.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> residual_eq_iff_perm_renaming<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> supp_p <span class="keyword2"><span class="keyword">and</span></span> fresh <span class="keyword2"><span class="keyword">and</span></span> fresh' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="skolem">p</span> <span class="main">♯*</span> <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> fresh_star_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Un_iff subsetCE<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> p_fQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span> <span class="main">=</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">F</span> <span class="main">=</span> <span class="skolem">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">f</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def perm_supp_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">from</span></span> p <span class="keyword2"><span class="keyword">and</span></span> p_F <span class="keyword2"><span class="keyword">and</span></span> p_f <span class="keyword1"><span class="command">have</span></span> p_α'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α'</span> <span class="main">=</span> <span class="skolem">α</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Q<span class="hidden">⇩</span><sub>L</sub>''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q<span class="hidden">⇩</span><sub>L</sub>''</span> <span class="main">=</span> EF <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α'</span><span class="main">,</span> <span class="skolem">F</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span><span class="main">,</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">Q'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">from</span></span> trans' <span class="keyword2"><span class="keyword">and</span></span> p_fQ <span class="keyword2"><span class="keyword">and</span></span> p_α' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">Q'</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> transition_eqvt'<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> L_bisim' <span class="keyword2"><span class="keyword">and</span></span> Q<span class="hidden">⇩</span><sub>L</sub>'' <span class="keyword2"><span class="keyword">and</span></span> p_α' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"invL_FL_bisimilar <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="skolem">P'</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">Q'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> invL_FL_bisimilar_def<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">f</span><span class="main"><span class="free">⟩</span></span><span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="bound">Q'</span><span class="main">⟩</span> <span class="main">∧</span> invL_FL_bisimilar <span class="main">(</span><span class="free">L</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">F</span><span class="main">,</span><span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="skolem">P'</span> <span class="bound">Q'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">∧</span> <span class="var">?S</span> <span class="main">∧</span> <span class="var">?T</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">theorem</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∼⋅[</span><span class="free">F</span><span class="main">]</span> <span class="free">Q</span> <span class="main">⟷</span> EF <span class="main">(</span><span class="free">F</span><span class="main">,</span><span class="free">P</span><span class="main">)</span> <span class="keyword1">∼⋅<span class="hidden">⇩</span><sub>L</sub></span> EF<span class="main">(</span><span class="free">F</span><span class="main">,</span><span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∼⋅[</span><span class="free">F</span><span class="main">]</span> <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"L_bisimilar <span class="main">(</span>EF <span class="main">(</span><span class="free">F</span><span class="main">,</span><span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>EF <span class="main">(</span><span class="free">F</span><span class="main">,</span><span class="free">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L_bisimilar.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"EF <span class="main">(</span><span class="free">F</span><span class="main">,</span><span class="free">P</span><span class="main">)</span> <span class="keyword1">∼⋅<span class="hidden">⇩</span><sub>L</sub></span> EF<span class="main">(</span><span class="free">F</span><span class="main">,</span><span class="free">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L_bisimilar_is_L_transform_bisimulation L_transform.bisimilar_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"EF <span class="main">(</span><span class="free">F</span><span class="main">,</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">∼⋅<span class="hidden">⇩</span><sub>L</sub></span> EF <span class="main">(</span><span class="free">F</span><span class="main">,</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"invL_FL_bisimilar <span class="free">F</span> <span class="free">P</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> invL_FL_bisimilar_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∼⋅[</span><span class="free">F</span><span class="main">]</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> invL_FL_bisimilar_is_L_bisimulation FL_bisimilar_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following (alternative) proof of the ``$\leftarrow$'' direction of this equivalence,
namely that bisimilarity in the $L$-transform implies $F/L$-bisimilarity, uses the fact that the
$L$-transform preserves satisfaction of formulas, together with the fact that bisimilarity (in the
$L$-transform) implies logical equivalence. However, since we proved the latter in the context of
indexed nominal transition systems, this proof requires an indexed nominal transition system with
effects where, additionally, the cardinality of the state set of the $L$-transform is bounded. We
could re-organize our formalization to remove this assumption: the proof of
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> indexed_nominal_ts.bisimilarity_implies_equivalence<span class="antiquote"><span class="antiquote">}</span></span></span></span> does not actually make use of the
cardinality assumptions provided by indexed nominal transition systems.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> L_transform_indexed_effect_nominal_ts <span class="main">=</span> indexed_effect_nominal_ts <span class="quoted"><span class="free">L</span></span> <span class="quoted"><span class="free">satisfies</span></span> <span class="quoted"><span class="free">transition</span></span> <span class="quoted"><span class="free">effect_apply</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">L</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'effect</span><span class="main">::</span>fs<span class="main">)</span> fs_set <span class="main">×</span> <span class="tfree">'effect</span> <span class="main">⇒</span> <span class="tfree">'effect</span> fs_set"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">satisfies</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span><span class="main">::</span>fs <span class="main">⇒</span> <span class="tfree">'pred</span><span class="main">::</span>fs <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊢</span>"</span> 70<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">transition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'state</span><span class="main">)</span> residual <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">→</span>"</span> 70<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">effect_apply</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'effect</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⟨</span>_<span class="keyword1">⟩</span>_"</span> <span class="main">[</span>0<span class="main">,</span>101<span class="main">]</span> 100<span class="main">)</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> card_idx_L_transform_state<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV<span class="main">::</span><span class="main">(</span><span class="tfree">'state</span><span class="main">,</span> <span class="tfree">'effect</span><span class="main">)</span> L_state set<span class="main">|</span> <span class="keyword1">&lt;o</span> <span class="main">|</span>UNIV<span class="main">::</span><span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">interpretation</span></span> L_transform<span class="main">:</span> indexed_nominal_ts <span class="quoted"><span class="quoted">"<span class="keyword1">(⊢<span class="hidden">⇩</span><sub>L</sub>)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(→<span class="hidden">⇩</span><sub>L</sub>)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">fact</span> L_satisfies_eqvt<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> L_transition_eqvt<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> card_idx_perm<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> card_idx_L_transform_state<span class="main">)</span>

  <span class="keyword1"><span class="command">notation</span></span> L_transform.bisimilar <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">∼⋅<span class="hidden">⇩</span><sub>L</sub></span>"</span> 100<span class="main">)</span>

  <span class="keyword1"><span class="command">theorem</span></span> <span class="quoted"><span class="quoted">"EF <span class="main">(</span><span class="free">F</span><span class="main">,</span><span class="free">P</span><span class="main">)</span> <span class="keyword1">∼⋅<span class="hidden">⇩</span><sub>L</sub></span> EF<span class="main">(</span><span class="free">F</span><span class="main">,</span><span class="free">Q</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">∼⋅[</span><span class="free">F</span><span class="main">]</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"EF <span class="main">(</span><span class="free">F</span><span class="main">,</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">∼⋅<span class="hidden">⇩</span><sub>L</sub></span> EF <span class="main">(</span><span class="free">F</span><span class="main">,</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"L_transform.logically_equivalent <span class="main">(</span>EF <span class="main">(</span><span class="free">F</span><span class="main">,</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>EF <span class="main">(</span><span class="free">F</span><span class="main">,</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> L_transform.bisimilarity_implies_equivalence<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> FL_valid_iff_valid_L_transform <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FL_logically_equivalent <span class="free">F</span> <span class="free">P</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> FL_logically_equivalent_def L_transform.logically_equivalent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∼⋅[</span><span class="free">F</span><span class="main">]</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> FL_equivalence_implies_bisimilarity<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Weak_Transition_System">
<div class="head">
<h1>Theory Weak_Transition_System</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Weak_Transition_System
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Transition_System">Transition_System</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Nominal Transition Systems and Bisimulations with Unobservable Transitions›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Nominal transition systems with unobservable transitions›</span></span>

<span class="keyword1"><span class="command">locale</span></span> weak_nominal_ts <span class="main">=</span> nominal_ts <span class="quoted"><span class="free">satisfies</span></span> <span class="quoted"><span class="free">transition</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">satisfies</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span><span class="main">::</span>fs <span class="main">⇒</span> <span class="tfree">'pred</span><span class="main">::</span>fs <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊢</span>"</span> 70<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">transition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">,</span><span class="tfree">'state</span><span class="main">)</span> residual <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">→</span>"</span> 70<span class="main">)</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">τ</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'act</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tau_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="free">τ</span> <span class="main">=</span> <span class="free">τ</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Weak_Transition_System-bn_tau_empty"><span class="command">lemma</span></span> bn_tau_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="free">τ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bn_eqvt bn_finite tau_eqvt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eqvt_def supp_finite_atom_set supp_fun_eqvt<span class="main">)</span>

  <span class="keyword1" id="Weak_Transition_System-bn_tau_fresh"><span class="command">lemma</span></span> bn_tau_fresh <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="free">τ</span> <span class="main">♯*</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def<span class="main">)</span>

  <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">tau_transition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⇒</span>"</span> 70<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
    tau_refl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>
  <span class="main">|</span> tau_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">τ</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span><span class="main">⟩</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">P''</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">P''</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">observable_transition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'act</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword3">/ </span><span class="keyword1">⇒{</span>_<span class="keyword1">}</span><span class="keyword3">/ </span>_"</span> <span class="main">[</span>70<span class="main">,</span> 70<span class="main">,</span> 71<span class="main">]</span> 71<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">⇒{</span></span><span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">Q</span> <span class="bound">Q'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⇒</span> <span class="bound">Q</span> <span class="main">∧</span> <span class="bound">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">,</span> <span class="bound">Q'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="bound">Q'</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">weak_transition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'act</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword3">/ </span><span class="keyword1">⇒⟨</span>_<span class="keyword1">⟩</span><span class="keyword3">/ </span>_"</span> <span class="main">[</span>70<span class="main">,</span> 70<span class="main">,</span> 71<span class="main">]</span> 71<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">⇒⟨</span></span><span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main"><span class="free">⟩</span></span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">=</span> <span class="free">τ</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⇒{</span><span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">}</span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The transition relations defined above are equivariant.›</span></span>

  <span class="keyword1" id="Weak_Transition_System-tau_transition_eqvt"><span class="command">lemma</span></span> tau_transition_eqvt <span class="comment1">(*[eqvt]*)</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒</span> <span class="free">P'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="free">P</span> <span class="main">⇒</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">P'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tau_refl <span class="skolem">P</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> tau_transition.tau_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tau_step <span class="skolem">P</span> <span class="skolem">P'</span> <span class="skolem">P''</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">τ</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">τ</span><span class="main">,</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> tau_eqvt transition_eqvt' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∙</span> <span class="skolem">P'</span> <span class="main">⇒</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">P''</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> tau_transition.tau_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Weak_Transition_System-observable_transition_eqvt"><span class="command">lemma</span></span> observable_transition_eqvt <span class="comment1">(*[eqvt]*)</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒{</span><span class="free">α</span><span class="main">}</span> <span class="free">P'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="free">P</span> <span class="main">⇒{</span><span class="free">p</span> <span class="main">∙</span> <span class="free">α</span><span class="main">}</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">P'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> observable_transition_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> transition_eqvt' tau_transition_eqvt<span class="main">)</span>

  <span class="keyword1" id="Weak_Transition_System-weak_transition_eqvt"><span class="command">lemma</span></span> weak_transition_eqvt <span class="comment1">(*[eqvt]*)</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒⟨</span><span class="free">α</span><span class="main">⟩</span> <span class="free">P'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="free">P</span> <span class="main">⇒⟨</span><span class="free">p</span> <span class="main">∙</span> <span class="free">α</span><span class="main">⟩</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">P'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> weak_transition_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> observable_transition_eqvt permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tau_eqvt tau_transition_eqvt<span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Additional lemmas about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> tau_transition<span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> observable_transition<span class="antiquote"><span class="antiquote">}</span></span></span></span> and
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> weak_transition<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

  <span class="keyword1" id="Weak_Transition_System-tau_transition_trans"><span class="command">lemma</span></span> tau_transition_trans<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⇒</span> <span class="free">R</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tau_step<span class="main">)</span>

  <span class="keyword1" id="Weak_Transition_System-observable_transitionI"><span class="command">lemma</span></span> observable_transitionI<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">α</span><span class="main">,</span> <span class="free">Q'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q'</span> <span class="main">⇒</span> <span class="free">P'</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒{</span><span class="free">α</span><span class="main">}</span> <span class="free">P'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms observable_transition_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1" id="Weak_Transition_System-observable_transition_stepI"><span class="command">lemma</span></span> observable_transition_stepI <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">α</span><span class="main">,</span> <span class="free">P'</span><span class="main">⟩</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒{</span><span class="free">α</span><span class="main">}</span> <span class="free">P'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms observable_transitionI tau_refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1" id="Weak_Transition_System-observable_tau_transition"><span class="command">lemma</span></span> observable_tau_transition<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒{</span><span class="free">τ</span><span class="main">}</span> <span class="free">P'</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒</span> <span class="free">P'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">⇒{</span><span class="free">τ</span><span class="main">}</span> <span class="free">P'</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">τ</span><span class="main">,</span> <span class="skolem">Q'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">⇒</span> <span class="free">P'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> observable_transition_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tau_step tau_transition_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Weak_Transition_System-weak_transition_tau_iff"><span class="command">lemma</span></span> weak_transition_tau_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒⟨</span><span class="free">τ</span><span class="main">⟩</span> <span class="free">P'</span> <span class="main">⟷</span> <span class="free">P</span> <span class="main">⇒</span> <span class="free">P'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weak_transition_def<span class="main">)</span>

  <span class="keyword1" id="Weak_Transition_System-weak_transition_not_tau_iff"><span class="command">lemma</span></span> weak_transition_not_tau_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">≠</span> <span class="free">τ</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒⟨</span><span class="free">α</span><span class="main">⟩</span> <span class="free">P'</span> <span class="main">⟷</span> <span class="free">P</span> <span class="main">⇒{</span><span class="free">α</span><span class="main">}</span> <span class="free">P'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weak_transition_def<span class="main">)</span>

  <span class="keyword1" id="Weak_Transition_System-weak_transition_stepI"><span class="command">lemma</span></span> weak_transition_stepI <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒{</span><span class="free">α</span><span class="main">}</span> <span class="free">P'</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒⟨</span><span class="free">α</span><span class="main">⟩</span> <span class="free">P'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">=</span> <span class="free">τ</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> observable_tau_transition<span class="main">)</span>

  <span class="keyword1" id="Weak_Transition_System-weak_transition_weakI"><span class="command">lemma</span></span> weak_transition_weakI<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⇒⟨</span><span class="free">α</span><span class="main">⟩</span> <span class="free">Q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q'</span> <span class="main">⇒</span> <span class="free">P'</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒⟨</span><span class="free">α</span><span class="main">⟩</span> <span class="free">P'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">=</span> <span class="free">τ</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tau_transition_trans weak_transition_tau_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> observable_transition_def tau_transition_trans weak_transition_not_tau_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Weak bisimulations›</span></span>

<span class="keyword1"><span class="command">context</span></span> weak_nominal_ts
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_weak_bisimulation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">is_weak_bisimulation</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span>
      symp <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∧</span>
      <span class="comment1">― ‹weak static implication›</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span> <span class="bound">φ</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">P</span> <span class="bound">Q</span> <span class="main">∧</span> <span class="bound">P</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="bound">Q</span> <span class="main">⇒</span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">P</span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="bound">Q'</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="comment1">― ‹weak simulation›</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">P</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">α</span> <span class="bound">P'</span><span class="main">.</span> bn <span class="bound">α</span> <span class="main">♯*</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="bound">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="bound">Q</span> <span class="main">⇒⟨</span><span class="bound">α</span><span class="main">⟩</span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">P'</span> <span class="bound">Q'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">weakly_bisimilar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≈⋅</span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">≈⋅</span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">R</span><span class="main">.</span> is_weak_bisimulation <span class="bound">R</span> <span class="main">∧</span> <span class="bound">R</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> weakly_bisimilar<span class="antiquote"><span class="antiquote">}</span></span></span></span> is an equivariant equivalence relation.›</span></span>

  <span class="keyword1" id="Weak_Transition_System-is_weak_bisimulation_eqvt"><span class="command">lemma</span></span> is_weak_bisimulation_eqvt <span class="comment1">(*[eqvt]*)</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_weak_bisimulation <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_weak_bisimulation <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_weak_bisimulation_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"symp <span class="free">R</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span> <span class="bound">φ</span><span class="main">.</span> <span class="free">R</span> <span class="bound">P</span> <span class="bound">Q</span> <span class="main">∧</span> <span class="bound">P</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="bound">Q</span> <span class="main">⇒</span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">P</span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="bound">Q'</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="free">R</span> <span class="bound">P</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">α</span> <span class="bound">P'</span><span class="main">.</span> bn <span class="bound">α</span> <span class="main">♯*</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="bound">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="bound">Q</span> <span class="main">⇒⟨</span><span class="bound">α</span><span class="main">⟩</span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">P'</span> <span class="bound">Q'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"symp <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> symp_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span> <span class="bound">φ</span><span class="main">.</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span> <span class="bound">P</span> <span class="bound">Q</span> <span class="main">∧</span> <span class="bound">P</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="bound">Q</span> <span class="main">⇒</span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span> <span class="bound">P</span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="bound">Q'</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">φ</span>
        <span class="keyword3"><span class="command">assume</span></span> pR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> phi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> pR <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_lambda permute_bool_def unpermute_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> phi <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P</span><span class="main">)</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> satisfies_eqvt<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q</span> <span class="main">⇒</span> <span class="skolem">Q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">Q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ***<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⇒</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tau_transition_eqvt<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ** <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span> <span class="skolem">P</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_lambda permute_bool_def unpermute_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> *** <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q'</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> satisfies_eqvt<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="skolem">Q</span> <span class="main">⇒</span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span> <span class="skolem">P</span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="bound">Q'</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span> <span class="bound">P</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">α</span> <span class="bound">P'</span><span class="main">.</span> bn <span class="bound">α</span> <span class="main">♯*</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="bound">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="bound">Q</span> <span class="main">⇒⟨</span><span class="bound">α</span><span class="main">⟩</span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span> <span class="bound">P'</span> <span class="bound">Q'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?U</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">α</span> <span class="skolem">P'</span>
        <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ***<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_lambda permute_bool_def unpermute_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">♯*</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ** <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bn_eqvt fresh_star_permute_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">,</span> <span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> *** <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> transition_eqvt'<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q</span> <span class="main">⇒⟨</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">⟩</span> <span class="skolem">Q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">)</span> <span class="skolem">Q'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">from</span></span> T <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⇒⟨</span><span class="skolem">α</span><span class="main">⟩</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> weak_transition_eqvt<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> R <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span> <span class="skolem">P'</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eqvt_apply eqvt_lambda permute_bool_def unpermute_def<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="skolem">Q</span> <span class="main">⇒⟨</span><span class="skolem">α</span><span class="main">⟩</span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">R</span><span class="main">)</span> <span class="skolem">P'</span> <span class="bound">Q'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">∧</span> <span class="var">?T</span> <span class="main">∧</span> <span class="var">?U</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Weak_Transition_System-weakly_bisimilar_eqvt"><span class="command">lemma</span></span> weakly_bisimilar_eqvt <span class="comment1">(*[eqvt]*)</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≈⋅</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">≈⋅</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"is_weak_bisimulation <span class="skolem">R</span> <span class="main">∧</span> <span class="skolem">R</span> <span class="free">P</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> weakly_bisimilar_def <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_weak_bisimulation <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">R</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_weak_bisimulation_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"*"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eqvt_apply permute_boolI<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">≈⋅</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> weakly_bisimilar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Weak_Transition_System-weakly_bisimilar_reflp"><span class="command">lemma</span></span> weakly_bisimilar_reflp<span class="main">:</span> <span class="quoted"><span class="quoted">"reflp weakly_bisimilar"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> reflpI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_weak_bisimulation <span class="main">(=)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_weak_bisimulation_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> symp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≈⋅</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> weakly_bisimilar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Weak_Transition_System-weakly_bisimilar_symp"><span class="command">lemma</span></span> weakly_bisimilar_symp<span class="main">:</span> <span class="quoted"><span class="quoted">"symp weakly_bisimilar"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sympI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≈⋅</span> <span class="skolem">Q</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"is_weak_bisimulation <span class="skolem">R</span> <span class="main">∧</span> <span class="skolem">R</span> <span class="skolem">P</span> <span class="skolem">Q</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> weakly_bisimilar_def <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="skolem">Q</span> <span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_weak_bisimulation_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> symp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"*"</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">≈⋅</span> <span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> weakly_bisimilar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Weak_Transition_System-weakly_bisimilar_is_weak_bisimulation"><span class="command">lemma</span></span> weakly_bisimilar_is_weak_bisimulation<span class="main">:</span> <span class="quoted"><span class="quoted">"is_weak_bisimulation weakly_bisimilar"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_weak_bisimulation_def <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"symp <span class="main">(≈⋅)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> weakly_bisimilar_symp<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span> <span class="bound">φ</span><span class="main">.</span> <span class="bound">P</span> <span class="main">≈⋅</span> <span class="bound">Q</span> <span class="main">∧</span> <span class="bound">P</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="bound">Q</span> <span class="main">⇒</span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="bound">P</span> <span class="main">≈⋅</span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="bound">Q'</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="bound">P</span> <span class="main">≈⋅</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">α</span> <span class="bound">P'</span><span class="main">.</span> bn <span class="bound">α</span> <span class="main">♯*</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="bound">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="bound">Q</span> <span class="main">⇒⟨</span><span class="bound">α</span><span class="main">⟩</span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">≈⋅</span> <span class="bound">Q'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_weak_bisimulation_def weakly_bisimilar_def<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Weak_Transition_System-weakly_bisimilar_tau_simulation_step"><span class="command">lemma</span></span> weakly_bisimilar_tau_simulation_step<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≈⋅</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒</span> <span class="free">P'</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">Q'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⇒</span> <span class="free">Q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">≈⋅</span> <span class="free">Q'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">⇒</span> <span class="free">P'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">≈⋅</span> <span class="free">Q</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Q</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tau_refl <span class="skolem">P</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tau_transition.tau_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tau_step <span class="skolem">P</span> <span class="skolem">P''</span> <span class="skolem">P'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">τ</span><span class="main">,</span><span class="skolem">P''</span><span class="main">⟩</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">≈⋅</span> <span class="skolem">Q</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⇒</span> <span class="skolem">Q''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P''</span> <span class="main">≈⋅</span> <span class="skolem">Q''</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bn_tau_fresh is_weak_bisimulation_def weak_transition_def weakly_bisimilar_is_weak_bisimulation<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> tau_step.hyps<span class="main">(</span>3<span class="main">)</span> tau_step.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tau_transition_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Weak_Transition_System-weakly_bisimilar_weak_simulation_step"><span class="command">lemma</span></span> weakly_bisimilar_weak_simulation_step<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≈⋅</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bn <span class="free">α</span> <span class="main">♯*</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒⟨</span><span class="free">α</span><span class="main">⟩</span> <span class="free">P'</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">Q'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⇒⟨</span><span class="free">α</span><span class="main">⟩</span> <span class="free">Q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">≈⋅</span> <span class="free">Q'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">=</span> <span class="free">τ</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">≈⋅</span> <span class="free">Q</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">⇒⟨</span><span class="free">α</span><span class="main">⟩</span> <span class="free">P'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> weak_transition_tau_iff weakly_bisimilar_tau_simulation_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">⇒⟨</span><span class="free">α</span><span class="main">⟩</span> <span class="free">P'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒{</span><span class="free">α</span><span class="main">}</span> <span class="free">P'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P1</span></span> <span class="skolem"><span class="skolem">P2</span></span> <span class="keyword2"><span class="keyword">where</span></span> tauP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒</span> <span class="skolem">P1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P1</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">α</span><span class="main">,</span><span class="skolem">P2</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tauP2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P2</span> <span class="main">⇒</span> <span class="free">P'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> observable_transition_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">≈⋅</span> <span class="free">Q</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> tauP <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q1</span></span> <span class="keyword2"><span class="keyword">where</span></span> tauQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⇒</span> <span class="skolem">Q1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> P1Q1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P1</span> <span class="main">≈⋅</span> <span class="skolem">Q1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> weakly_bisimilar_tau_simulation_step<span class="main">)</span>

    <span class="comment1">― ‹rename~<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">⟨</span><span class="free">α</span><span class="main">,</span><span class="skolem">P2</span><span class="main">⟩</span>"</span><span class="antiquote">}</span></span> to avoid~<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">Q1</span></span><span class="antiquote">}</span></span>, without touching~<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">Q</span></span><span class="antiquote">}</span></span>›</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> bn <span class="free">α</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">Q1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="main">⟨</span><span class="free">α</span><span class="main">,</span><span class="skolem">P2</span><span class="main">⟩</span><span class="main">,</span> <span class="free">Q</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> at_set_avoiding2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"bn <span class="free"><span class="free">α</span></span>"</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Q1</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">⟨</span></span><span class="free"><span class="free">α</span></span><span class="main"><span class="main">,</span></span><span class="skolem"><span class="skolem">P2</span></span><span class="main"><span class="main">⟩</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">Q</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> exE<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>bn <span class="free">α</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> bn_finite<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="skolem">Q1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> finite_supp<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span><span class="main">⟨</span><span class="free">α</span><span class="main">,</span><span class="skolem">P2</span><span class="main">⟩</span><span class="main">,</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_supp supp_Pair<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bn <span class="free">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="main">⟨</span><span class="free">α</span><span class="main">,</span><span class="skolem">P2</span><span class="main">⟩</span><span class="main">,</span> <span class="free">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹bn <span class="free">α</span> <span class="main">♯*</span> <span class="free">Q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Pair<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">⟨</span><span class="free">α</span><span class="main">,</span><span class="skolem">P2</span><span class="main">⟩</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="free">Q</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Un supp_Pair<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">from</span></span> 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">α</span><span class="main">,</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P2</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">α</span><span class="main">,</span><span class="skolem">P2</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> supp_perm_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q2</span></span> <span class="keyword2"><span class="keyword">where</span></span> trans'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q1</span> <span class="main">⇒⟨</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">α</span><span class="main">⟩</span> <span class="skolem">Q2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> P2Q2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P2</span><span class="main">)</span> <span class="main">≈⋅</span> <span class="skolem">Q2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> P1Q1 trans 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> weakly_bisimilar_is_weak_bisimulation bn_eqvt is_weak_bisimulation_def<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> tauP2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P2</span> <span class="main">⇒</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">P'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> tau_transition_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> P2Q2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> tauQ2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q2</span> <span class="main">⇒</span> <span class="skolem">Q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> P'Q'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">P'</span><span class="main">)</span> <span class="main">≈⋅</span> <span class="skolem">Q'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> weakly_bisimilar_tau_simulation_step<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> tauQ <span class="keyword2"><span class="keyword">and</span></span> trans' <span class="keyword2"><span class="keyword">and</span></span> tauQ2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⇒⟨</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">α</span><span class="main">⟩</span> <span class="skolem">Q'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> weak_transition_weakI<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> 4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⇒⟨</span><span class="free">α</span><span class="main">⟩</span> <span class="main">(</span><span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">Q'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> supp_perm_eq weak_transition_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> P'Q' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">≈⋅</span> <span class="main">(</span><span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">Q'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> weakly_bisimilar_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Weak_Transition_System-weakly_bisimilar_transp"><span class="command">lemma</span></span> weakly_bisimilar_transp<span class="main">:</span> <span class="quoted"><span class="quoted">"transp weakly_bisimilar"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> transpI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">R</span>
    <span class="keyword3"><span class="command">assume</span></span> PQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≈⋅</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> QR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">≈⋅</span> <span class="skolem">R</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?bisim</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"weakly_bisimilar <span class="keyword1">OO</span> weakly_bisimilar"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"symp <span class="var">?bisim</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sympI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">R</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bisim</span> <span class="skolem">P</span> <span class="skolem">R</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≈⋅</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">≈⋅</span> <span class="skolem">R</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">≈⋅</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">≈⋅</span> <span class="skolem">P</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> weakly_bisimilar_symp sympE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bisim</span> <span class="skolem">R</span> <span class="skolem">P</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span> <span class="bound">φ</span><span class="main">.</span> <span class="var">?bisim</span> <span class="bound">P</span> <span class="bound">Q</span> <span class="main">∧</span> <span class="bound">P</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="bound">Q</span> <span class="main">⇒</span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="var">?bisim</span> <span class="bound">P</span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="bound">Q'</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">φ</span> <span class="skolem">R</span>
        <span class="keyword3"><span class="command">assume</span></span> phi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> PR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≈⋅</span> <span class="skolem">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> RQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">≈⋅</span> <span class="skolem">Q</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> PR <span class="keyword2"><span class="keyword">and</span></span> phi <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">⇒</span> <span class="skolem">R'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≈⋅</span> <span class="skolem">R'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R'</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> weakly_bisimilar_is_weak_bisimulation is_weak_bisimulation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">from</span></span> RQ <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">R</span> <span class="main">⇒</span> <span class="skolem">R'</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⇒</span> <span class="skolem">Q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R'</span> <span class="main">≈⋅</span> <span class="skolem">Q'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> weakly_bisimilar_tau_simulation_step<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">R'</span> <span class="main">≈⋅</span> <span class="skolem">Q'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> * <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">⇒</span> <span class="skolem">Q''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R'</span> <span class="main">≈⋅</span> <span class="skolem">Q''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q''</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> weakly_bisimilar_is_weak_bisimulation is_weak_bisimulation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Q</span> <span class="main">⇒</span> <span class="skolem">Q'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Q'</span> <span class="main">⇒</span> <span class="skolem">Q''</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⇒</span> <span class="skolem">Q''</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> tau_transition_trans<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">≈⋅</span> <span class="skolem">R'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">R'</span> <span class="main">≈⋅</span> <span class="skolem">Q''</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bisim</span> <span class="skolem">P</span> <span class="skolem">Q''</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="skolem">Q</span> <span class="main">⇒</span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="var">?bisim</span> <span class="skolem">P</span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="bound">Q'</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="var">?bisim</span> <span class="bound">P</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">α</span> <span class="bound">P'</span><span class="main">.</span> bn <span class="bound">α</span> <span class="main">♯*</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="bound">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="bound">Q</span> <span class="main">⇒⟨</span><span class="bound">α</span><span class="main">⟩</span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="var">?bisim</span> <span class="bound">P'</span> <span class="bound">Q'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">R</span> <span class="skolem">α</span> <span class="skolem">P'</span>
        <span class="keyword3"><span class="command">assume</span></span> PR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≈⋅</span> <span class="skolem">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> RQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">≈⋅</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
        <span class="comment1">― ‹rename~<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span><span class="antiquote">}</span></span> to avoid~<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">R</span></span><span class="antiquote">}</span></span>, without touching~<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">Q</span></span><span class="antiquote">}</span></span>›</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> bn <span class="skolem">α</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> at_set_avoiding2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"bn <span class="skolem"><span class="skolem">α</span></span>"</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">R</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">⟨</span></span><span class="skolem"><span class="skolem">α</span></span><span class="main"><span class="main">,</span></span><span class="skolem"><span class="skolem">P'</span></span><span class="main"><span class="main">⟩</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">Q</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> exE<span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>bn <span class="skolem">α</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> bn_finite<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="skolem">R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> finite_supp<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span><span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_supp supp_Pair<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="main">(</span><span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh fresh_star_Pair<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="skolem">Q</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Un supp_Pair<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">from</span></span> 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">,</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> supp_perm_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">with</span></span> trans <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pR'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">⇒⟨</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">⟩</span> <span class="skolem">pR'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">)</span> <span class="main">≈⋅</span> <span class="skolem">pR'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> PR 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bn_eqvt weakly_bisimilar_is_weak_bisimulation is_weak_bisimulation_def<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> fresh <span class="keyword2"><span class="keyword">and</span></span> 4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">Q</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bn_eqvt fresh_star_permute_iff supp_perm_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pQ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⇒⟨</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">⟩</span> <span class="skolem">pQ'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 8<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pR'</span> <span class="main">≈⋅</span> <span class="skolem">pQ'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> RQ 5 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> weakly_bisimilar_weak_simulation_step<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> 7 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⇒⟨</span><span class="skolem">α</span><span class="main">⟩</span> <span class="main">(</span><span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">pQ'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> supp_perm_eq weak_transition_eqvt<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 6 <span class="keyword2"><span class="keyword">and</span></span> 8 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bisim</span> <span class="skolem">P'</span> <span class="main">(</span><span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">pQ'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> weakly_bisimilar_eqvt permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> relcompp.simps<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="skolem">Q</span> <span class="main">⇒⟨</span><span class="skolem">α</span><span class="main">⟩</span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="var">?bisim</span> <span class="skolem">P'</span> <span class="bound">Q'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_weak_bisimulation <span class="var">?bisim</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_weak_bisimulation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bisim</span> <span class="skolem">P</span> <span class="skolem">R</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> PQ QR <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≈⋅</span> <span class="skolem">R</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> weakly_bisimilar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Weak_Transition_System-weakly_bisimilar_equivp"><span class="command">lemma</span></span> weakly_bisimilar_equivp<span class="main">:</span> <span class="quoted"><span class="quoted">"equivp weakly_bisimilar"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> weakly_bisimilar_reflp weakly_bisimilar_symp weakly_bisimilar_transp equivp_reflp_symp_transp<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Weak_Formula">
<div class="head">
<h1>Theory Weak_Formula</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Weak_Formula
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Weak_Transition_System">Weak_Transition_System</a>
  <a href="#Disjunction">Disjunction</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Weak Formulas›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lemmas about \texorpdfstring{$\alpha$}{alpha}-equivalence involving \texorpdfstring{$\tau$}{tau}›</span></span>

<span class="keyword1"><span class="command">context</span></span> weak_nominal_ts
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Weak_Formula-Act_tau_eq_iff"><span class="command">lemma</span></span> Act_tau_eq_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"Act <span class="free">τ</span> <span class="free">x1</span> <span class="main">=</span> Act <span class="free">α</span> <span class="free">x2</span> <span class="main">⟷</span> <span class="free">α</span> <span class="main">=</span> <span class="free">τ</span> <span class="main">∧</span> <span class="free">x2</span> <span class="main">=</span> <span class="free">x1</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">⟷</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p_α<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="free">τ</span> <span class="main">=</span> <span class="free">α</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="free">x1</span> <span class="main">=</span> <span class="free">x2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp <span class="free">x1</span> <span class="main">-</span> bn <span class="free">τ</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act_eq_iff_perm<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> p_α <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">=</span> <span class="free">τ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tau_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> fresh <span class="keyword2"><span class="keyword">and</span></span> p_x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x2</span> <span class="main">=</span> <span class="free">x1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_perm_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Weak action modality›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The definition of (strong) formulas is parametric in the index type, but from now on we
want to work with a fixed (sufficiently large) index type.

Also, we use~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">τ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in our definition of weak formulas.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> indexed_weak_nominal_ts <span class="main">=</span> weak_nominal_ts <span class="quoted"><span class="free">satisfies</span></span> <span class="quoted"><span class="free">transition</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">satisfies</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span><span class="main">::</span>fs <span class="main">⇒</span> <span class="tfree">'pred</span><span class="main">::</span>fs <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊢</span>"</span> 70<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">transition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">,</span><span class="tfree">'state</span><span class="main">)</span> residual <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">→</span>"</span> 70<span class="main">)</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> card_idx_perm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV<span class="main">::</span>perm set<span class="main">|</span> <span class="keyword1">&lt;o</span> <span class="main">|</span>UNIV<span class="main">::</span><span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> card_idx_state<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV<span class="main">::</span><span class="tfree">'state</span> set<span class="main">|</span> <span class="keyword1">&lt;o</span> <span class="main">|</span>UNIV<span class="main">::</span><span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> card_idx_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV<span class="main">::</span>nat set<span class="main">|</span> <span class="keyword1">&lt;o</span> <span class="main">|</span>UNIV<span class="main">::</span><span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The assumption <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> card_idx_nat<span class="antiquote"><span class="antiquote">}</span></span></span></span> is redundant: it is already implied by
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> card_idx_perm<span class="antiquote"><span class="antiquote">}</span></span></span></span>.  A formal proof of this fact is left for future work.›</span></span>

  <span class="keyword1" id="Weak_Formula-card_idx_nat'"><span class="command">lemma</span></span> card_idx_nat' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV<span class="main">::</span>nat set<span class="main">|</span> <span class="keyword1">&lt;o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV<span class="main">::</span><span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">note</span></span> card_idx_nat
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span> <span class="keyword1">≤o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cnotzero_UNIV ordLeq_csum2<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">tau_steps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>fs<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">)</span> formula <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">)</span> formula"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">tau_steps</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">0</span>       <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tau_steps</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> Act <span class="free">τ</span> <span class="main">(</span><span class="free">tau_steps</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="Weak_Formula-tau_steps_eqvt"><span class="command">lemma</span></span> tau_steps_eqvt <span class="comment1">(*[eqvt]*)</span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> tau_steps <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> tau_steps <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_nat_def tau_eqvt<span class="main">)</span>

  <span class="keyword1" id="Weak_Formula-tau_steps_eqvt'"><span class="command">lemma</span></span> tau_steps_eqvt' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> tau_steps <span class="free">x</span> <span class="main">=</span> tau_steps <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_fun_def<span class="main">)</span>

  <span class="keyword1" id="Weak_Formula-tau_steps_eqvt_raw"><span class="command">lemma</span></span> tau_steps_eqvt_raw <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> tau_steps <span class="main">=</span> tau_steps"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_fun_def<span class="main">)</span>

  <span class="keyword1" id="Weak_Formula-tau_steps_add"><span class="command">lemma</span></span> tau_steps_add <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"tau_steps <span class="main">(</span>tau_steps <span class="free">x</span> <span class="free">m</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> tau_steps <span class="free">x</span> <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1" id="Weak_Formula-tau_steps_not_self"><span class="command">lemma</span></span> tau_steps_not_self<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> tau_steps <span class="free">x</span> <span class="free">n</span> <span class="main">⟷</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> tau_steps <span class="free">x</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Act <span class="free">τ</span> <span class="main">(</span>tau_steps <span class="skolem">x</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Act <span class="skolem">α</span> <span class="skolem">x</span><span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> tau_steps <span class="main">(</span>Act <span class="free">τ</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">n</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act_tau_eq_iff<span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> Act.hyps <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_Suc tau_steps.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tau_steps_add<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> tau_steps <span class="free">x</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">weak_tau_modality</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>fs<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">)</span> formula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">)</span> formula"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">weak_tau_modality</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> Disj <span class="main">(</span>map_bset <span class="main">(</span>tau_steps <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Abs_bset UNIV<span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="Weak_Formula-finite_supp_map_bset_tau_steps"><span class="command">lemma</span></span> finite_supp_map_bset_tau_steps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>map_bset <span class="main">(</span>tau_steps <span class="free">x</span><span class="main">)</span> <span class="main">(</span>Abs_bset UNIV <span class="main">::</span> nat <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eqvt map_bset"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eqvt tau_steps"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvtI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>map_bset <span class="main">(</span>tau_steps <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> supp_fun_eqvt supp_fun_app supp_fun_app_eqvt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Abs_bset UNIV <span class="main">::</span> nat <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvtI supp_fun_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>map_bset <span class="main">(</span>tau_steps <span class="free">x</span><span class="main">)</span> <span class="main">(</span>Abs_bset UNIV <span class="main">::</span> nat <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> supp_fun_app <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_subset finite_supp<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Weak_Formula-weak_tau_modality_eqvt"><span class="command">lemma</span></span> weak_tau_modality_eqvt <span class="comment1">(*[eqvt]*)</span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> weak_tau_modality <span class="free">x</span> <span class="main">=</span> weak_tau_modality <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> weak_tau_modality_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_bset_eqvt<span class="main">)</span>

  <span class="keyword1" id="Weak_Formula-weak_tau_modality_eq_iff"><span class="command">lemma</span></span> weak_tau_modality_eq_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"weak_tau_modality <span class="free">x</span> <span class="main">=</span> weak_tau_modality <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"weak_tau_modality <span class="free">x</span> <span class="main">=</span> weak_tau_modality <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_bset <span class="main">(</span>tau_steps <span class="free">x</span><span class="main">)</span> <span class="main">(</span>Abs_bset UNIV <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> map_bset <span class="main">(</span>tau_steps <span class="free">y</span><span class="main">)</span> <span class="main">(</span>Abs_bset UNIV<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> weak_tau_modality_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> card_idx_nat' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span>tau_steps <span class="free">x</span><span class="main">)</span> <span class="main">=</span> range <span class="main">(</span>tau_steps <span class="free">y</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">=</span> <span class="var">?Y</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Abs_bset_inverse' map_bset.rep_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> range <span class="main">(</span>tau_steps <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> range <span class="main">(</span>tau_steps <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> range_eqI tau_steps.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nx</span></span> <span class="skolem"><span class="skolem">ny</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> tau_steps <span class="free">y</span> <span class="skolem">nx</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> tau_steps <span class="free">x</span> <span class="skolem">ny</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ny</span> <span class="main">+</span> <span class="skolem">nx</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tau_steps_not_self<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> x <span class="keyword2"><span class="keyword">and</span></span> y <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"weak_tau_modality <span class="free">x</span> <span class="main">=</span> weak_tau_modality <span class="free">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Weak_Formula-supp_weak_tau_modality"><span class="command">lemma</span></span> supp_weak_tau_modality <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"supp <span class="main">(</span>weak_tau_modality <span class="free">x</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Weak_Formula-Act_weak_tau_modality_eq_iff"><span class="command">lemma</span></span> Act_weak_tau_modality_eq_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"Act <span class="free">α1</span> <span class="main">(</span>weak_tau_modality <span class="free">x1</span><span class="main">)</span> <span class="main">=</span> Act <span class="free">α2</span> <span class="main">(</span>weak_tau_modality <span class="free">x2</span><span class="main">)</span> <span class="main">⟷</span> Act <span class="free">α1</span> <span class="free">x1</span> <span class="main">=</span> Act <span class="free">α2</span> <span class="free">x2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Act_eq_iff_perm<span class="main">)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">weak_action_modality</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'act</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>fs<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">)</span> formula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">)</span> formula"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⟨⟨</span>_<span class="keyword1">⟩⟩</span>_"</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨⟨</span></span><span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main"><span class="free">⟩⟩</span></span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">=</span> <span class="free">τ</span> <span class="keyword1">then</span> weak_tau_modality <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> weak_tau_modality <span class="main">(</span>Act <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">(</span>weak_tau_modality <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="Weak_Formula-weak_action_modality_eqvt"><span class="command">lemma</span></span> weak_action_modality_eqvt <span class="comment1">(*[eqvt]*)</span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="main">(</span><span class="main">⟨⟨</span><span class="free">α</span><span class="main">⟩⟩</span><span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨⟨</span><span class="free">p</span> <span class="main">∙</span> <span class="free">α</span><span class="main">⟩⟩</span><span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tau_eqvt weak_action_modality_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1" id="Weak_Formula-weak_action_modality_tau"><span class="command">lemma</span></span> weak_action_modality_tau<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨⟨</span><span class="free">τ</span><span class="main">⟩⟩</span><span class="free">x</span><span class="main">)</span> <span class="main">=</span> weak_tau_modality <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> weak_action_modality_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Weak_Formula-weak_action_modality_not_tau"><span class="command">lemma</span></span> weak_action_modality_not_tau<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">≠</span> <span class="free">τ</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨⟨</span><span class="free">α</span><span class="main">⟩⟩</span><span class="free">x</span><span class="main">)</span> <span class="main">=</span> weak_tau_modality <span class="main">(</span>Act <span class="free">α</span> <span class="main">(</span>weak_tau_modality <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> weak_action_modality_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Equality is modulo $\alpha$-equivalence.›</span></span>
    
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Note that the converse of the following lemma does not hold. For instance,
  for~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">α</span></span> <span class="main"><span class="main">≠</span></span> <span class="free"><span class="free">τ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> we have <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">⟨⟨</span></span><span class="free"><span class="free">τ</span></span><span class="main"><span class="main">⟩⟩</span></span><span class="main"><span class="main">(</span></span>Act <span class="free"><span class="free">α</span></span> <span class="main"><span class="main">(</span></span>weak_tau_modality <span class="free"><span class="free">x</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">⟨⟨</span></span><span class="free"><span class="free">α</span></span><span class="main"><span class="main">⟩⟩</span></span><span class="free"><span class="free">x</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by definition,
  but clearly not <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">"Act <span class="free"><span class="free">τ</span></span> <span class="main"><span class="main">(</span></span>Act <span class="free"><span class="free">α</span></span> <span class="main"><span class="main">(</span></span>weak_tau_modality <span class="free"><span class="free">x</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> Act <span class="free"><span class="free">α</span></span> <span class="free"><span class="free">x</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

  <span class="keyword1" id="Weak_Formula-weak_action_modality_eq"><span class="command">lemma</span></span> weak_action_modality_eq<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Act <span class="free">α1</span> <span class="free">x1</span> <span class="main">=</span> Act <span class="free">α2</span> <span class="free">x2</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨⟨</span><span class="free">α1</span><span class="main">⟩⟩</span><span class="free">x1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⟨⟨</span><span class="free">α2</span><span class="main">⟩⟩</span><span class="free">x2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">α1</span> <span class="main">=</span> <span class="free">τ</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">α2</span> <span class="main">=</span> <span class="free">α1</span> <span class="main">∧</span> <span class="free">x2</span> <span class="main">=</span> <span class="free">x1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act_tau_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="free">x1</span> <span class="main">-</span> bn <span class="free">α1</span> <span class="main">=</span> supp <span class="free">x2</span> <span class="main">-</span> bn <span class="free">α2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp <span class="free">x1</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="free">x1</span> <span class="main">=</span> <span class="free">x2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="free">α1</span> <span class="main">-</span> bn <span class="free">α1</span> <span class="main">=</span> supp <span class="free">α2</span> <span class="main">-</span> bn <span class="free">α2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp <span class="free">α1</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="free">α1</span> <span class="main">=</span> <span class="free">α2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act_eq_iff_perm<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>weak_tau_modality <span class="free">x1</span><span class="main">)</span> <span class="main">-</span> bn <span class="free">α1</span> <span class="main">=</span> supp <span class="main">(</span>weak_tau_modality <span class="free">x2</span><span class="main">)</span> <span class="main">-</span> bn <span class="free">α2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> supp_weak_tau_modality<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp <span class="main">(</span>weak_tau_modality <span class="free">x1</span><span class="main">)</span> <span class="main">-</span> bn <span class="free">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> supp_weak_tau_modality<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> weak_tau_modality <span class="free">x1</span> <span class="main">=</span> weak_tau_modality <span class="free">x2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> weak_tau_modality_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Act <span class="free">α1</span> <span class="main">(</span>weak_tau_modality <span class="free">x1</span><span class="main">)</span> <span class="main">=</span> Act <span class="free">α2</span> <span class="main">(</span>weak_tau_modality <span class="free">x2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword2"><span class="keyword">and</span></span> 5 <span class="keyword2"><span class="keyword">and</span></span> 6 <span class="keyword2"><span class="keyword">and</span></span> Act_eq_iff_perm <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">α1</span> <span class="main">≠</span> <span class="free">τ</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">α2</span> <span class="main">≠</span> <span class="free">τ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act_tau_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">α1</span> <span class="main">≠</span> <span class="free">τ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weak_action_modality_not_tau<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>


  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Weak formulas›</span></span>

  <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">weak_formula</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>fs<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">)</span> formula <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span>
      wf_Conj<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free"><span class="bound"><span class="entity">xset</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set_bset <span class="free"><span class="bound"><span class="entity">xset</span></span></span> <span class="main">⟹</span> <span class="free">weak_formula</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">weak_formula</span> <span class="main">(</span>Conj <span class="free"><span class="bound"><span class="entity">xset</span></span></span><span class="main">)</span>"</span></span>
    <span class="main">|</span> wf_Not<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">weak_formula</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span> <span class="free">weak_formula</span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
    <span class="main">|</span> wf_Act<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">weak_formula</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span> <span class="free">weak_formula</span> <span class="main">(</span><span class="main">⟨⟨</span><span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">⟩⟩</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
    <span class="main">|</span> wf_Pred<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">weak_formula</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span> <span class="free">weak_formula</span> <span class="main">(</span><span class="main">⟨⟨</span><span class="free">τ</span><span class="main">⟩⟩</span><span class="main">(</span>Conj <span class="main">(</span>binsert <span class="main">(</span>Pred <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>bsingleton <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="Weak_Formula-finite_supp_wf_Pred"><span class="command">lemma</span></span> finite_supp_wf_Pred <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>binsert <span class="main">(</span>Pred <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>bsingleton <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>bsingleton <span class="free">x</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvtI supp_fun_app_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eqvt binsert"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvtI<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>binsert <span class="main">(</span>Pred <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>bsingleton <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">φ</span> <span class="main">∪</span> supp <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> supp_fun_app supp_fun_app_eqvt <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_UnI finite_supp rev_finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> weak_formula<span class="antiquote"><span class="antiquote">}</span></span></span></span> is equivariant.›</span></span>

  <span class="keyword1" id="Weak_Formula-weak_formula_eqvt"><span class="command">lemma</span></span> weak_formula_eqvt <span class="comment1">(*[eqvt]*)</span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"weak_formula <span class="free">x</span> <span class="main">⟹</span> weak_formula <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> weak_formula.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>wf_Conj <span class="skolem">xset</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> imageE permute_finite permute_set_eq_image set_bset_eqvt supp_eqvt weak_formula.wf_Conj<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>wf_Not <span class="skolem">x</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weak_formula.wf_Not<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>wf_Act <span class="skolem">x</span> <span class="skolem">α</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weak_formula.wf_Act<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>wf_Pred <span class="skolem">x</span> <span class="skolem">φ</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tau_eqvt weak_formula.wf_Pred<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Weak_Validity">
<div class="head">
<h1>Theory Weak_Validity</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Weak_Validity
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Weak_Formula">Weak_Formula</a>
  <a href="#Validity">Validity</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Weak Validity›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Weak formulas are a subset of (strong) formulas, and the definition of validity is simply
taken from the latter.  Here we prove some useful lemmas about the validity of weak modalities.
These are similar to corresponding lemmas about the validity of the (strong) action modality.›</span></span>

<span class="keyword1"><span class="command">context</span></span> indexed_weak_nominal_ts
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Weak_Validity-valid_weak_tau_modality_iff_tau_steps"><span class="command">lemma</span></span> valid_weak_tau_modality_iff_tau_steps<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> weak_tau_modality <span class="free">x</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊨</span> tau_steps <span class="free">x</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> weak_tau_modality_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_bset.rep_eq<span class="main">)</span>

  <span class="keyword1" id="Weak_Validity-tau_steps_iff_tau_transition"><span class="command">lemma</span></span> tau_steps_iff_tau_transition<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊨</span> tau_steps <span class="free">x</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⇒</span> <span class="bound">P'</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊨</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊨</span> tau_steps <span class="free">x</span> <span class="bound">n</span>"</span></span>      
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> tau_steps <span class="free">x</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⇒</span> <span class="bound">P'</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 0
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> tau_refl<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">τ</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> tau_steps <span class="free">x</span> <span class="skolem">n</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_Act_fresh<span class="main"><span class="main">[</span></span><span class="operator">OF</span> bn_tau_fresh<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> Suc.hyps <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> tau_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⇒</span> <span class="bound">P'</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒</span> <span class="skolem">P'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊨</span> tau_steps <span class="free">x</span> <span class="bound">n</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tau_refl <span class="skolem">P</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊨</span> tau_steps <span class="free">x</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tau_step <span class="skolem">P</span> <span class="skolem">P'</span> <span class="skolem">P''</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> tau_steps <span class="free">x</span> <span class="skolem">n</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">τ</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊨</span> tau_steps <span class="free">x</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_Act_fresh<span class="main"><span class="main">[</span></span><span class="operator">OF</span> bn_tau_fresh<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
      <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Weak_Validity-valid_weak_tau_modality"><span class="command">lemma</span></span> valid_weak_tau_modality<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> weak_tau_modality <span class="free">x</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⇒</span> <span class="bound">P'</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊨</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> valid_weak_tau_modality_iff_tau_steps tau_steps_iff_tau_transition<span class="main">)</span>

  <span class="keyword1" id="Weak_Validity-valid_weak_action_modality"><span class="command">lemma</span></span> valid_weak_action_modality<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> <span class="main">(</span><span class="main">⟨⟨</span><span class="free">α</span><span class="main">⟩⟩</span><span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">α'</span> <span class="bound">x'</span> <span class="bound">P'</span><span class="main">.</span> Act <span class="free">α</span> <span class="free">x</span> <span class="main">=</span> Act <span class="bound">α'</span> <span class="bound">x'</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">⇒⟨</span><span class="bound">α'</span><span class="main">⟩</span> <span class="bound">P'</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊨</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">⟷</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">=</span> <span class="free">τ</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">α</span> <span class="main">=</span> <span class="free">τ</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒</span> <span class="skolem">P'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> valid_weak_tau_modality weak_action_modality_tau<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> trans <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒⟨</span><span class="free">τ</span><span class="main">⟩</span> <span class="skolem">P'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">α</span> <span class="main">=</span> <span class="free">τ</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> valid <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Act <span class="free">α</span> <span class="free">x</span> <span class="main">=</span> Act <span class="skolem">α'</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒⟨</span><span class="skolem">α'</span><span class="main">⟩</span> <span class="skolem">P'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> <span class="skolem">x'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">α'</span> <span class="main">=</span> <span class="free">τ</span> <span class="main">∧</span> <span class="skolem">x'</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">α</span> <span class="main">=</span> <span class="free">τ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> trans <span class="keyword2"><span class="keyword">and</span></span> valid <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒</span> <span class="skolem">P'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">α</span> <span class="main">=</span> <span class="free">τ</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> valid_weak_tau_modality weak_action_modality_tau<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">α</span> <span class="main">≠</span> <span class="free">τ</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⊨</span> Act <span class="free">α</span> <span class="main">(</span>weak_tau_modality <span class="free">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> valid_weak_tau_modality weak_action_modality_not_tau<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> valid <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Act <span class="free">α</span> <span class="main">(</span>weak_tau_modality <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Act <span class="skolem">α'</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">Q'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> valid'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">⊨</span> <span class="skolem">x'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> valid_Act<span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p_α<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">α'</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">α</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> weak_tau_modality <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act_eq_iff_perm<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Act <span class="free">α</span> <span class="free">x</span> <span class="main">=</span> Act <span class="skolem">α'</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Act_weak_tau_modality_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> valid' <span class="keyword2"><span class="keyword">and</span></span> p_x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">⊨</span> weak_tau_modality <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> trans''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">⇒</span> <span class="skolem">P'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> valid''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> valid_weak_tau_modality<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> trans <span class="keyword2"><span class="keyword">and</span></span> trans' <span class="keyword2"><span class="keyword">and</span></span> trans'' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒⟨</span><span class="skolem">α'</span><span class="main">⟩</span> <span class="skolem">P'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> observable_transitionI weak_transition_stepI<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Act <span class="free">α</span> <span class="free">x</span> <span class="main">=</span> Act <span class="skolem">α'</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒⟨</span><span class="skolem">α'</span><span class="main">⟩</span> <span class="skolem">P'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> <span class="skolem">x'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">α</span> <span class="main">≠</span> <span class="free">τ</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> α'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">α'</span> <span class="main">≠</span> <span class="free">τ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act_tau_eq_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> trans <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> trans'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">Q'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans'''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">⇒</span> <span class="skolem">P'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> observable_transition_def weak_transition_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> trans''' <span class="keyword2"><span class="keyword">and</span></span> valid <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">⊨</span> weak_tau_modality <span class="skolem">x'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> valid_weak_tau_modality<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> trans'' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⊨</span> Act <span class="skolem">α'</span> <span class="main">(</span>weak_tau_modality <span class="skolem">x'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> valid_Act<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> trans' <span class="keyword2"><span class="keyword">and</span></span> α' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> <span class="main">⟨⟨</span><span class="skolem">α'</span><span class="main">⟩⟩</span><span class="skolem">x'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> valid_weak_tau_modality weak_action_modality_not_tau<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨⟨</span><span class="free">α</span><span class="main">⟩⟩</span><span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⟨⟨</span><span class="skolem">α'</span><span class="main">⟩⟩</span><span class="skolem">x'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> weak_action_modality_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The binding names in the alpha-variant that witnesses validity may be chosen fresh for any
  finitely supported context.›</span></span>

  <span class="keyword1" id="Weak_Validity-valid_weak_action_modality_strong"><span class="command">lemma</span></span> valid_weak_action_modality_strong<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> <span class="main">(</span><span class="main">⟨⟨</span><span class="free">α</span><span class="main">⟩⟩</span><span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">α'</span> <span class="bound">x'</span> <span class="bound">P'</span><span class="main">.</span> Act <span class="free">α</span> <span class="free">x</span> <span class="main">=</span> Act <span class="bound">α'</span> <span class="bound">x'</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">⇒⟨</span><span class="bound">α'</span><span class="main">⟩</span> <span class="bound">P'</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊨</span> <span class="bound">x'</span> <span class="main">∧</span> bn <span class="bound">α'</span> <span class="main">♯*</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> <span class="main">⟨⟨</span><span class="free">α</span><span class="main">⟩⟩</span><span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Act <span class="free">α</span> <span class="free">x</span> <span class="main">=</span> Act <span class="skolem">α'</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒⟨</span><span class="skolem">α'</span><span class="main">⟩</span> <span class="skolem">P'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> <span class="skolem">x'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> valid_weak_action_modality<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">α'</span> <span class="bound">x'</span> <span class="bound">P'</span><span class="main">.</span> Act <span class="free">α</span> <span class="free">x</span> <span class="main">=</span> Act <span class="bound">α'</span> <span class="bound">x'</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">⇒⟨</span><span class="bound">α'</span><span class="main">⟩</span> <span class="bound">P'</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊨</span> <span class="bound">x'</span> <span class="main">∧</span> bn <span class="bound">α'</span> <span class="main">♯*</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">α'</span> <span class="main">=</span> <span class="free">τ</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword2"><span class="keyword">and</span></span> trans <span class="keyword2"><span class="keyword">and</span></span> valid <span class="keyword2"><span class="keyword">and</span></span> bn_tau_fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> trans <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> trans'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span> <span class="skolem">Q'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans'''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">⇒</span> <span class="skolem">P'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> weak_transition_def observable_transition_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>bn <span class="skolem">α'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> bn_finite<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>supp <span class="free">X</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>Act <span class="skolem">α'</span> <span class="skolem">x'</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">Q'</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_Diff finite_UnI finite_supp supp_Pair supp_abs_residual_pair<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α'</span> <span class="main">♯*</span> <span class="main">(</span>Act <span class="skolem">α'</span> <span class="skolem">x'</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">Q'</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_def supp_Pair supp_abs_residual_pair<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> fresh_X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> bn <span class="skolem">α'</span><span class="main">)</span> <span class="main">♯*</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Act <span class="skolem">α'</span> <span class="skolem">x'</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">Q'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> at_set_avoiding2<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Act <span class="skolem">α'</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">Q'</span><span class="main">⟩</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_star_Un supp_Pair<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"Act <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">=</span> Act <span class="skolem">α'</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α'</span><span class="main">,</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">Q'</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">Q'</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act_eqvt supp_perm_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> abs_residual_pair_eqvt supp_perm_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> trans' <span class="keyword2"><span class="keyword">and</span></span> trans'' <span class="keyword2"><span class="keyword">and</span></span> trans''' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒⟨</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α'</span><span class="main">⟩</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> observable_transitionI tau_transition_eqvt weak_transition_stepI<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword2"><span class="keyword">and</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> valid <span class="keyword2"><span class="keyword">and</span></span> fresh_X <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bn_eqvt valid_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">α'</span> <span class="bound">x'</span> <span class="bound">P'</span><span class="main">.</span> Act <span class="free">α</span> <span class="free">x</span> <span class="main">=</span> Act <span class="bound">α'</span> <span class="bound">x'</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">⇒⟨</span><span class="bound">α'</span><span class="main">⟩</span> <span class="bound">P'</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊨</span> <span class="bound">x'</span> <span class="main">∧</span> bn <span class="bound">α'</span> <span class="main">♯*</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> <span class="main">⟨⟨</span><span class="free">α</span><span class="main">⟩⟩</span><span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> valid_weak_action_modality<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Weak_Validity-valid_weak_action_modality_fresh"><span class="command">lemma</span></span> valid_weak_action_modality_fresh<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bn <span class="free">α</span> <span class="main">♯*</span> <span class="free">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> <span class="main">(</span><span class="main">⟨⟨</span><span class="free">α</span><span class="main">⟩⟩</span><span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⇒⟨</span><span class="free">α</span><span class="main">⟩</span> <span class="bound">P'</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊨</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> <span class="main">⟨⟨</span><span class="free">α</span><span class="main">⟩⟩</span><span class="free">x</span>"</span></span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> finite_supp<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Act <span class="free">α</span> <span class="free">x</span> <span class="main">=</span> Act <span class="skolem">α'</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒⟨</span><span class="skolem">α'</span><span class="main">⟩</span> <span class="skolem">P'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α'</span> <span class="main">♯*</span> <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> valid_weak_action_modality_strong<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p_α<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">α'</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">α</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> supp_p<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="skolem">p</span> <span class="main">⊆</span> bn <span class="free">α</span> <span class="main">∪</span> <span class="skolem">p</span> <span class="main">∙</span> bn <span class="free">α</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act_eq_iff_perm_renaming<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> fresh <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="free">α</span> <span class="main">∪</span> <span class="skolem">p</span> <span class="main">∙</span> bn <span class="free">α</span><span class="main">)</span> <span class="main">♯*</span> <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p_α <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bn_eqvt fresh_star_Un<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="skolem">p</span> <span class="main">♯*</span> <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> supp_p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_star_def subset_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> p_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">P</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> perm_supp_eq supp_minus_perm<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> trans <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒⟨</span><span class="free">α</span><span class="main">⟩</span> <span class="main">(</span><span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p_P p_α <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> weak_transition_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> valid <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p_x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> valid_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⇒⟨</span><span class="free">α</span><span class="main">⟩</span> <span class="bound">P'</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⇒⟨</span><span class="free">α</span><span class="main">⟩</span> <span class="bound">P'</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> <span class="main">⟨⟨</span><span class="free">α</span><span class="main">⟩⟩</span><span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> valid_weak_action_modality<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Weak_Logical_Equivalence">
<div class="head">
<h1>Theory Weak_Logical_Equivalence</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Weak_Logical_Equivalence
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Weak_Formula">Weak_Formula</a>
  <a href="#Weak_Validity">Weak_Validity</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Weak Logical Equivalence›</span></span>

<span class="keyword1"><span class="command">context</span></span> indexed_weak_nominal_ts
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Two states are weakly logically equivalent if they validate the same weak formulas.›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">weakly_logically_equivalent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">weakly_logically_equivalent</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">::</span><span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">)</span> formula<span class="main">.</span> weak_formula <span class="bound">x</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊨</span> <span class="bound">x</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">⊨</span> <span class="bound">x</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">notation</span></span> weakly_logically_equivalent <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≡⋅</span>"</span> 50<span class="main">)</span>

  <span class="keyword1" id="Weak_Logical_Equivalence-weakly_logically_equivalent_eqvt"><span class="command">lemma</span></span> weakly_logically_equivalent_eqvt<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≡⋅</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="free">P</span> <span class="main">≡⋅</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> weakly_logically_equivalent_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">,</span><span class="tfree">'act</span><span class="main">)</span> formula"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"weak_formula <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"weak_formula <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="free">P</span> <span class="main">⊨</span> <span class="skolem">x</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">Q</span> <span class="main">⊨</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> weakly_logically_equivalent_def permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> valid_eqvt<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Weak_Bisimilarity_Implies_Equivalence">
<div class="head">
<h1>Theory Weak_Bisimilarity_Implies_Equivalence</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Weak_Bisimilarity_Implies_Equivalence
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Weak_Logical_Equivalence">Weak_Logical_Equivalence</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Weak Bisimilarity Implies Weak Logical Equivalence›</span></span>

<span class="keyword1"><span class="command">context</span></span> indexed_weak_nominal_ts
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Weak_Bisimilarity_Implies_Equivalence-weak_bisimilarity_implies_weak_equivalence_Act"><span class="command">lemma</span></span> weak_bisimilarity_implies_weak_equivalence_Act<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="bound">P</span> <span class="main">≈⋅</span> <span class="bound">Q</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="main">⊨</span> <span class="free">x</span> <span class="main">⟷</span> <span class="bound">Q</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≈⋅</span> <span class="free">Q</span>"</span></span>
    <span class="comment1">― ‹not needed: and <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">prop</span> <span class="quoted">"weak_formula <span class="free">x</span>"</span><span class="antiquote">}</span></span>›</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> <span class="main">⟨⟨</span><span class="free">α</span><span class="main">⟩⟩</span><span class="free">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⊨</span> <span class="main">⟨⟨</span><span class="free">α</span><span class="main">⟩⟩</span><span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> finite_supp<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">⊨</span> <span class="main">⟨⟨</span><span class="free">α</span><span class="main">⟩⟩</span><span class="free">x</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Act <span class="free">α</span> <span class="free">x</span> <span class="main">=</span> Act <span class="skolem">α'</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒⟨</span><span class="skolem">α'</span><span class="main">⟩</span> <span class="skolem">P'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α'</span> <span class="main">♯*</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> valid_weak_action_modality_strong<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">≈⋅</span> <span class="free">Q</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh <span class="keyword2"><span class="keyword">and</span></span> trans <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> trans'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⇒⟨</span><span class="skolem">α'</span><span class="main">⟩</span> <span class="skolem">Q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bisim'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">≈⋅</span> <span class="skolem">Q'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> weakly_bisimilar_weak_simulation_step<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> px<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act_eq_iff_perm<span class="main">)</span>

    <span class="keyword1"><span class="command">with</span></span> valid <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> valid_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> bisim' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span><span class="main">)</span> <span class="main">≈⋅</span> <span class="main">(</span><span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">Q'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> weakly_bisimilar_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">Q'</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="bound">P</span> <span class="main">≈⋅</span> <span class="bound">Q</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="main">⊨</span> <span class="free">x</span> <span class="main">⟷</span> <span class="bound">Q</span> <span class="main">⊨</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">with</span></span> px <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">⊨</span> <span class="skolem">x'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> valid_eqvt<span class="main">)</span>

    <span class="keyword1"><span class="command">with</span></span> eq <span class="keyword2"><span class="keyword">and</span></span> trans' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⊨</span> <span class="main">⟨⟨</span><span class="free">α</span><span class="main">⟩⟩</span><span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> valid_weak_action_modality <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Weak_Bisimilarity_Implies_Equivalence-weak_bisimilarity_implies_weak_equivalence_Pred"><span class="command">lemma</span></span> weak_bisimilarity_implies_weak_equivalence_Pred<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="bound">P</span> <span class="main">≈⋅</span> <span class="bound">Q</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="main">⊨</span> <span class="free">x</span> <span class="main">⟷</span> <span class="bound">Q</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≈⋅</span> <span class="free">Q</span>"</span></span>
    <span class="comment1">― ‹not needed: and <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">prop</span> <span class="quoted">"weak_formula <span class="free">x</span>"</span><span class="antiquote">}</span></span>›</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> <span class="main">⟨⟨</span><span class="free">τ</span><span class="main">⟩⟩</span><span class="main">(</span>Conj <span class="main">(</span>binsert <span class="main">(</span>Pred <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>bsingleton <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⊨</span> <span class="main">⟨⟨</span><span class="free">τ</span><span class="main">⟩⟩</span><span class="main">(</span>Conj <span class="main">(</span>binsert <span class="main">(</span>Pred <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>bsingleton <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Conj <span class="main">(</span>binsert <span class="main">(</span>Pred <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>bsingleton <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">⊨</span> <span class="main">⟨⟨</span><span class="free">τ</span><span class="main">⟩⟩</span><span class="var">?c</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒</span> <span class="skolem">P'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> <span class="var">?c</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid_weak_action_modality <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn <span class="free">τ</span>  <span class="main">♯*</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">≈⋅</span> <span class="free">Q</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> trans'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⇒</span> <span class="skolem">Q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bisim'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">≈⋅</span> <span class="skolem">Q'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> weakly_bisimilar_weak_simulation_step weak_transition_tau_iff<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> valid <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main"><span class="free">⊢</span></span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binsert.rep_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">from</span></span> bisim' <span class="keyword2"><span class="keyword">and</span></span> * <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q''</span></span> <span class="keyword2"><span class="keyword">where</span></span> trans''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">⇒</span> <span class="skolem">Q''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bisim''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">≈⋅</span> <span class="skolem">Q''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ***<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q''</span> <span class="main"><span class="free">⊢</span></span> <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_weak_bisimulation_def weakly_bisimilar_is_weak_bisimulation<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> bisim'' <span class="keyword2"><span class="keyword">and</span></span> ** <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q''</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="bound">P</span> <span class="main">≈⋅</span> <span class="bound">Q</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="main">⊨</span> <span class="free">x</span> <span class="main">⟷</span> <span class="bound">Q</span> <span class="main">⊨</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">with</span></span> *** <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q''</span> <span class="main">⊨</span> <span class="var">?c</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binsert.rep_eq<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> trans' <span class="keyword2"><span class="keyword">and</span></span> trans'' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⇒⟨</span><span class="free">τ</span><span class="main">⟩</span> <span class="skolem">Q''</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tau_transition_trans weak_transition_tau_iff<span class="main">)</span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⊨</span> <span class="main">⟨⟨</span><span class="free">τ</span><span class="main">⟩⟩</span><span class="var">?c</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> valid_weak_action_modality <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">theorem</span></span> weak_bisimilarity_implies_weak_equivalence<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≈⋅</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≡⋅</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">)</span> formula"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"weak_formula <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="bound">P</span> <span class="main">≈⋅</span> <span class="bound">Q</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="main">⊨</span> <span class="skolem">x</span> <span class="main">⟷</span> <span class="bound">Q</span> <span class="main">⊨</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> weak_formula.induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>wf_Conj <span class="skolem">xset</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>wf_Not <span class="skolem">x</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>wf_Act <span class="skolem">x</span> <span class="skolem">α</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> weakly_bisimilar_symp weak_bisimilarity_implies_weak_equivalence_Act sympE<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>wf_Pred <span class="skolem">x</span> <span class="skolem">φ</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> weakly_bisimilar_symp weak_bisimilarity_implies_weak_equivalence_Pred sympE<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> weakly_logically_equivalent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Weak_Equivalence_Implies_Bisimilarity">
<div class="head">
<h1>Theory Weak_Equivalence_Implies_Bisimilarity</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Weak_Equivalence_Implies_Bisimilarity
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Weak_Logical_Equivalence">Weak_Logical_Equivalence</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Weak Logical Equivalence Implies Weak Bisimilarity›</span></span>

<span class="keyword1"><span class="command">context</span></span> indexed_weak_nominal_ts
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_distinguishing_formula</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">)</span> formula <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
    <span class="main">(</span><span class="quoted">"_ <span class="keyword1">distinguishes</span> _ <span class="keyword1">from</span> _"</span> <span class="main">[</span>100<span class="main">,</span>100<span class="main">,</span>100<span class="main">]</span> 100<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">distinguishes</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1"><span class="free">from</span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊨</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">⊨</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

  <span class="keyword1" id="Weak_Equivalence_Implies_Bisimilarity-is_distinguishing_formula_eqvt"><span class="command">lemma</span></span> is_distinguishing_formula_eqvt <span class="comment1">(*[eqvt]*)</span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">distinguishes</span> <span class="free">P</span> <span class="keyword1">from</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">distinguishes</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">from</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_distinguishing_formula_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> valid_eqvt<span class="main">)</span>

  <span class="keyword1" id="Weak_Equivalence_Implies_Bisimilarity-weakly_equivalent_iff_not_distinguished"><span class="command">lemma</span></span> weakly_equivalent_iff_not_distinguished<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">≡⋅</span> <span class="free">Q</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> weak_formula <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">distinguishes</span> <span class="free">P</span> <span class="keyword1">from</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> is_distinguishing_formula_def weakly_logically_equivalent_def valid_Not wf_Not<span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There exists a distinguishing weak formula for~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> whose support is
  contained in~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"supp <span class="free"><span class="free">P</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

  <span class="keyword1" id="Weak_Equivalence_Implies_Bisimilarity-distinguished_bounded_support"><span class="command">lemma</span></span> distinguished_bounded_support<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"weak_formula <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">distinguishes</span> <span class="free">P</span> <span class="keyword1">from</span> <span class="free">Q</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"weak_formula <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"supp <span class="free">y</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="keyword1">distinguishes</span> <span class="free">P</span> <span class="keyword1">from</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">|</span><span class="bound">p</span><span class="main">.</span> supp <span class="free">P</span> <span class="main">♯*</span> <span class="bound">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="free">P</span> <span class="keyword1">supports</span> <span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> supports_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
      <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> supp <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> supp <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?B</span> <span class="main">⊆</span> <span class="var">?B</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="free">P</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_set_def<span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="var">?q</span> <span class="main">∙</span> <span class="free">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> a <span class="keyword2"><span class="keyword">and</span></span> b <span class="keyword2"><span class="keyword">and</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="free">P</span> <span class="main">♯*</span> <span class="var">?q</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_perm fresh_star_def fresh_star_plus swap_atom_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">⊆</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?B</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="free">P</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?q</span> <span class="main">∙</span> <span class="free">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> a <span class="keyword2"><span class="keyword">and</span></span> b <span class="keyword2"><span class="keyword">and</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="free">P</span> <span class="main">♯*</span> <span class="var">?q</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_perm fresh_star_def fresh_star_plus swap_atom_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?B</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> mem_permute_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?B</span> <span class="main">=</span> <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> supp_B_subset_supp_P<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="var">?B</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> finite_supp supp_is_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> finite_supp_B<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="var">?B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_supp rev_finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="main">`</span> UNIV"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?B</span><span class="main">|</span> <span class="keyword1">≤o</span> <span class="main">|</span>UNIV <span class="main">::</span> perm set<span class="main">|</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> surj_imp_ordLeq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV <span class="main">::</span> perm set<span class="main">|</span> <span class="keyword1">&lt;o</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_idx_perm<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span> <span class="keyword1">≤o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cnotzero_UNIV ordLeq_csum2<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> card_B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?B</span><span class="main">|</span> <span class="keyword1">&lt;o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Conj <span class="main">(</span>Abs_bset <span class="var">?B</span><span class="main">)</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">)</span> formula"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"weak_formula <span class="var">?y</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> finite_supp_B card_B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> set_bset <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> card_B <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Abs_bset_inverse mem_Collect_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"weak_formula <span class="skolem">x'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹weak_formula <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> weak_formula_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> finite_supp_B <span class="keyword2"><span class="keyword">and</span></span> card_B <span class="keyword2"><span class="keyword">and</span></span> supp_B_subset_supp_P <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="var">?y</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="keyword1">distinguishes</span> <span class="free">P</span> <span class="keyword1">from</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_distinguishing_formula_def <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> <span class="var">?y</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_B finite_supp_B<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> is_distinguishing_formula_def supp_perm_eq valid_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">Q</span> <span class="main">⊨</span> <span class="var">?y</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_B finite_supp_B<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> is_distinguishing_formula_def permute_zero fresh_star_zero<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Weak_Equivalence_Implies_Bisimilarity-weak_equivalence_is_weak_bisimulation"><span class="command">lemma</span></span> weak_equivalence_is_weak_bisimulation<span class="main">:</span> <span class="quoted"><span class="quoted">"is_weak_bisimulation weakly_logically_equivalent"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"symp weakly_logically_equivalent"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> weakly_logically_equivalent_def sympI<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>  <span class="comment1">― ‹weak static implication›</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">φ</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≡⋅</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="skolem">Q</span> <span class="main">⇒</span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="skolem">P</span> <span class="main">≡⋅</span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="bound">Q'</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">Q'</span><span class="main">.</span> <span class="skolem">Q</span> <span class="main">⇒</span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="bound">Q'</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span><span class="main">}</span>"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Q'</span><span class="main">∈</span><span class="var">?Q'</span><span class="main">.</span> <span class="main">¬</span> <span class="skolem">P</span> <span class="main">≡⋅</span> <span class="bound">Q'</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Q'</span><span class="main">∈</span><span class="var">?Q'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">)</span> formula<span class="main">.</span> weak_formula <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">distinguishes</span> <span class="skolem">P</span> <span class="keyword1">from</span> <span class="bound">Q'</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> weakly_equivalent_iff_not_distinguished<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Q'</span><span class="main">∈</span><span class="var">?Q'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">)</span> formula<span class="main">.</span> weak_formula <span class="bound">x</span> <span class="main">∧</span> supp <span class="bound">x</span> <span class="main">⊆</span> supp <span class="skolem">P</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">distinguishes</span> <span class="skolem">P</span> <span class="keyword1">from</span> <span class="bound">Q'</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distinguished_bounded_support<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">)</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
              *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Q'</span><span class="main">∈</span><span class="var">?Q'</span><span class="main">.</span> weak_formula <span class="main">(</span><span class="skolem">f</span> <span class="bound">Q'</span><span class="main">)</span> <span class="main">∧</span> supp <span class="main">(</span><span class="skolem">f</span> <span class="bound">Q'</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="skolem">P</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">Q'</span><span class="main">)</span> <span class="keyword1">distinguishes</span> <span class="skolem">P</span> <span class="keyword1">from</span> <span class="bound">Q'</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="skolem">P</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> set_bounded_supp<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> finite_supp<span class="main"><span class="keyword3">,</span></span> <span class="operator">cut_tac</span> <span class="quoted">"*"</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> finite_supp_image<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> finite_supp rev_finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="skolem">f</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">|</span> <span class="keyword1">≤o</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'state</span> set<span class="main">|</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> card_of_UNIV card_of_image ordLeq_transitive <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'state</span> set<span class="main">|</span> <span class="keyword1">&lt;o</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_idx_state<span class="main">)</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span> <span class="keyword1">≤o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cnotzero_UNIV ordLeq_csum2<span class="main">)</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> card_image<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="skolem">f</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">|</span> <span class="keyword1">&lt;o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Conj <span class="main">(</span>Abs_bset <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">)</span><span class="main">)</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">)</span> formula"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"weak_formula <span class="var">?y</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>Abs_bset <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">)</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> finite_supp_image card_image <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_bset <span class="main">(</span>Abs_bset <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">)</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">with</span></span> card_image <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">∈</span> <span class="var">?Q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">Q'</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> Abs_bset_inverse imageE set_bset set_bset_to_set_bset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"weak_formula <span class="skolem">x</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"*"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
              <span class="keyword1"><span class="command">qed</span></span>

            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?z</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨⟨</span><span class="free">τ</span><span class="main">⟩⟩</span><span class="main">(</span>Conj <span class="main">(</span>binsert <span class="main">(</span>Pred <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span>bsingleton <span class="var">?y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"weak_formula <span class="var">?z</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> <span class="quoted"><span class="quoted">‹weak_formula <span class="var">?y</span>›</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊨</span> <span class="var">?z</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⇒⟨</span><span class="free">τ</span><span class="main">⟩</span> <span class="skolem">P</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">moreover</span></span>
                <span class="keyword1"><span class="command">{</span></span>
                  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q'</span>
                  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⇒</span> <span class="skolem">Q'</span> <span class="main">∧</span> <span class="skolem">Q'</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>"</span></span>
                  <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"*"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊨</span> <span class="skolem">f</span> <span class="skolem">Q'</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_distinguishing_formula_def mem_Collect_eq<span class="main">)</span>
                <span class="keyword1"><span class="command">}</span></span>
                <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊨</span> Conj <span class="main">(</span>binsert <span class="main">(</span>Pred <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span>bsingleton <span class="var">?y</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binsert.rep_eq finite_supp_image card_image<span class="main">)</span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                  <span class="keyword1"><span class="command">using</span></span> valid_weak_action_modality <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">Q</span> <span class="main">⊨</span> <span class="var">?z</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⊨</span> <span class="var">?z</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⇒</span> <span class="skolem">Q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">⊨</span> Conj <span class="main">(</span>binsert <span class="main">(</span>Pred <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span>bsingleton <span class="var">?y</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> valid_weak_action_modality <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">⊨</span> <span class="var">?y</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binsert.rep_eq finite_supp_image card_image<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
                <span class="keyword1"><span class="command">from</span></span> 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Q''</span><span class="main">.</span> <span class="skolem">Q</span> <span class="main">⇒</span> <span class="bound">Q''</span> <span class="main">∧</span> <span class="bound">Q''</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span> <span class="main">⟶</span> <span class="skolem">Q'</span> <span class="main">⊨</span> <span class="skolem">f</span> <span class="bound">Q''</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_supp_image card_image<span class="main">)</span>
                <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> 2 <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"*"</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
                  <span class="keyword1"><span class="command">using</span></span> is_distinguishing_formula_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">≡⋅</span> <span class="skolem">Q</span>›</span></span> weakly_logically_equivalent_def<span class="main">)</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>  <span class="comment1">― ‹weak simulation›</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">α</span> <span class="skolem">P'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≡⋅</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="skolem">Q</span> <span class="main">⇒⟨</span><span class="skolem">α</span><span class="main">⟩</span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="skolem">P'</span> <span class="main">≡⋅</span> <span class="bound">Q'</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">Q'</span><span class="main">.</span> <span class="skolem">Q</span> <span class="main">⇒⟨</span><span class="skolem">α</span><span class="main">⟩</span> <span class="bound">Q'</span><span class="main">}</span>"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Q'</span><span class="main">∈</span><span class="var">?Q'</span><span class="main">.</span> <span class="main">¬</span> <span class="skolem">P'</span> <span class="main">≡⋅</span> <span class="bound">Q'</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Q'</span><span class="main">∈</span><span class="var">?Q'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">)</span> formula<span class="main">.</span> weak_formula <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">distinguishes</span> <span class="skolem">P'</span> <span class="keyword1">from</span> <span class="bound">Q'</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> weakly_equivalent_iff_not_distinguished<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Q'</span><span class="main">∈</span><span class="var">?Q'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">)</span> formula<span class="main">.</span> weak_formula <span class="bound">x</span> <span class="main">∧</span> supp <span class="bound">x</span> <span class="main">⊆</span> supp <span class="skolem">P'</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">distinguishes</span> <span class="skolem">P'</span> <span class="keyword1">from</span> <span class="bound">Q'</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distinguished_bounded_support<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">)</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
              *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Q'</span><span class="main">∈</span><span class="var">?Q'</span><span class="main">.</span> weak_formula <span class="main">(</span><span class="skolem">f</span> <span class="bound">Q'</span><span class="main">)</span> <span class="main">∧</span> supp <span class="main">(</span><span class="skolem">f</span> <span class="bound">Q'</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="skolem">P'</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">Q'</span><span class="main">)</span> <span class="keyword1">distinguishes</span> <span class="skolem">P'</span> <span class="keyword1">from</span> <span class="bound">Q'</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="skolem">P'</span> <span class="keyword1">supports</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> supports_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
                <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
                <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> supp <span class="skolem">P'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> supp <span class="skolem">P'</span>"</span></span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">f</span> <span class="main">`</span> <span class="var">?Q'</span>"</span></span>
                <span class="keyword1"><span class="command">proof</span></span>
                  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
                  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">f</span> <span class="skolem">Q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⇒⟨</span><span class="skolem">α</span><span class="main">⟩</span> <span class="skolem">Q'</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> imageE image_eqvt mem_Collect_eq permute_set_eq_image<span class="main">)</span>
                  <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"*"</span> <span class="keyword2"><span class="keyword">and</span></span> a <span class="keyword2"><span class="keyword">and</span></span> b <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> supp <span class="main">(</span><span class="skolem">f</span> <span class="skolem">Q'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> supp <span class="main">(</span><span class="skolem">f</span> <span class="skolem">Q'</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">Q'</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_perm fresh_star_def supp_perm_eq swap_atom<span class="main">)</span>
                  <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">f</span> <span class="main">`</span> <span class="var">?Q'</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">qed</span></span>
                <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">`</span> <span class="var">?Q'</span> <span class="main">⊆</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">proof</span></span>
                  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
                  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">f</span> <span class="main">`</span> <span class="var">?Q'</span>"</span></span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">Q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⇒⟨</span><span class="skolem">α</span><span class="main">⟩</span> <span class="skolem">Q'</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"*"</span> <span class="keyword2"><span class="keyword">and</span></span> a <span class="keyword2"><span class="keyword">and</span></span> b <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> supp <span class="main">(</span><span class="skolem">f</span> <span class="skolem">Q'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> supp <span class="main">(</span><span class="skolem">f</span> <span class="skolem">Q'</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">f</span> <span class="skolem">Q'</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_perm fresh_star_def supp_perm_eq swap_atom<span class="main">)</span>
                  <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">using</span></span> mem_permute_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">qed</span></span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">`</span> <span class="var">?Q'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> supp_image_subset_supp_P'<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="skolem">P'</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> finite_supp supp_is_subset<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> finite_supp_image<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> finite_supp rev_finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="skolem">f</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">|</span> <span class="keyword1">≤o</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'state</span> set<span class="main">|</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_of_UNIV card_of_image ordLeq_transitive<span class="main">)</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'state</span> set<span class="main">|</span> <span class="keyword1">&lt;o</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_idx_state<span class="main">)</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span> <span class="keyword1">≤o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cnotzero_UNIV ordLeq_csum2<span class="main">)</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> card_image<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="skolem">f</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">|</span> <span class="keyword1">&lt;o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Conj <span class="main">(</span>Abs_bset <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">)</span><span class="main">)</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">)</span> formula"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"weak_formula <span class="main">(</span><span class="main">⟨⟨</span><span class="skolem">α</span><span class="main">⟩⟩</span><span class="var">?y</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>Abs_bset <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">)</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> finite_supp_image card_image <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_bset <span class="main">(</span>Abs_bset <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="var">?Q'</span><span class="main">)</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">with</span></span> card_image <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">∈</span> <span class="var">?Q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">Q'</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> Abs_bset_inverse imageE set_bset set_bset_to_set_bset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"weak_formula <span class="skolem">x</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"*"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊨</span> <span class="main">⟨⟨</span><span class="skolem">α</span><span class="main">⟩⟩</span><span class="var">?y</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> valid_weak_action_modality <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⇒⟨</span><span class="skolem">α</span><span class="main">⟩</span> <span class="skolem">P'</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword1"><span class="command">{</span></span>
                  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q'</span>
                  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⇒⟨</span><span class="skolem">α</span><span class="main">⟩</span> <span class="skolem">Q'</span>"</span></span>
                  <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"*"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> <span class="skolem">f</span> <span class="skolem">Q'</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_distinguishing_formula_def mem_Collect_eq<span class="main">)</span>
                <span class="keyword1"><span class="command">}</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> <span class="var">?y</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_supp_image card_image<span class="main">)</span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">Q</span> <span class="main">⊨</span> <span class="main">⟨⟨</span><span class="skolem">α</span><span class="main">⟩⟩</span><span class="var">?y</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⊨</span> <span class="main">⟨⟨</span><span class="skolem">α</span><span class="main">⟩⟩</span><span class="var">?y</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⇒⟨</span><span class="skolem">α</span><span class="main">⟩</span> <span class="skolem">Q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">⊨</span> <span class="var">?y</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="skolem">Q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> valid_weak_action_modality_fresh<span class="main">)</span>
                <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Q''</span><span class="main">.</span> <span class="skolem">Q</span> <span class="main">⇒⟨</span><span class="skolem">α</span><span class="main">⟩</span> <span class="bound">Q''</span> <span class="main">⟶</span> <span class="skolem">Q'</span> <span class="main">⊨</span> <span class="skolem">f</span> <span class="bound">Q''</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_supp_image card_image<span class="main">)</span>
                <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"*"</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
                  <span class="keyword1"><span class="command">using</span></span> is_distinguishing_formula_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">≡⋅</span> <span class="skolem">Q</span>›</span></span> weakly_logically_equivalent_def<span class="main">)</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_weak_bisimulation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">theorem</span></span> weak_equivalence_implies_weak_bisimilarity<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≡⋅</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≈⋅</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> weakly_bisimilar_def weak_equivalence_is_weak_bisimulation<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Weak_Expressive_Completeness">
<div class="head">
<h1>Theory Weak_Expressive_Completeness</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Weak_Expressive_Completeness
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Weak_Bisimilarity_Implies_Equivalence">Weak_Bisimilarity_Implies_Equivalence</a>
  <a href="#Weak_Equivalence_Implies_Bisimilarity">Weak_Equivalence_Implies_Bisimilarity</a>
  <a href="#Disjunction">Disjunction</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Weak Expressive Completeness›</span></span>

<span class="keyword1"><span class="command">context</span></span> indexed_weak_nominal_ts
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Distinguishing weak formulas›</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lemma \emph{distinguished\_bounded\_support} only shows the existence of a distinguishing
    weak formula, without stating what this formula looks like. We now define an explicit function
    that returns a distinguishing weak formula, in a way that this function is equivariant (on pairs
    of non-weakly-equivalent states).

    Note that this definition uses Hilbert's choice operator~$\varepsilon$, which is not necessarily
    equivariant. This is immediately remedied by a hull construction.›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">distinguishing_weak_formula</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">)</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">distinguishing_weak_formula</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> Conj <span class="main">(</span>Abs_bset <span class="main">{</span><span class="main">-</span><span class="bound">p</span> <span class="main">∙</span> <span class="main">(</span><span class="main">ϵ</span><span class="bound">x</span><span class="main">.</span> weak_formula <span class="bound">x</span> <span class="main">∧</span> supp <span class="bound">x</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">distinguishes</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="keyword1">from</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">p</span><span class="main">.</span> True<span class="main">}</span><span class="main">)</span>"</span></span>

  <span class="comment1">― ‹just an auxiliary lemma that will be useful further below›</span>
  <span class="keyword1" id="Weak_Expressive_Completeness-distinguishing_weak_formula_card_aux"><span class="command">lemma</span></span> distinguishing_weak_formula_card_aux<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="main">{</span><span class="main">-</span><span class="bound">p</span> <span class="main">∙</span> <span class="main">(</span><span class="main">ϵ</span><span class="bound">x</span><span class="main">.</span> weak_formula <span class="bound">x</span> <span class="main">∧</span> supp <span class="bound">x</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">distinguishes</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">from</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">p</span><span class="main">.</span> True<span class="main">}</span><span class="main">|</span> <span class="keyword1">&lt;o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?some</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="main">ϵ</span><span class="bound">x</span><span class="main">.</span> weak_formula <span class="bound">x</span> <span class="main">∧</span> supp <span class="bound">x</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">distinguishes</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">from</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">-</span><span class="bound">p</span> <span class="main">∙</span> <span class="var">?some</span> <span class="bound">p</span><span class="main">|</span><span class="bound">p</span><span class="main">.</span> True<span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">-</span><span class="bound">p</span> <span class="main">∙</span> <span class="var">?some</span> <span class="bound">p</span><span class="main">)</span> <span class="main">`</span> UNIV"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?B</span><span class="main">|</span> <span class="keyword1">≤o</span> <span class="main">|</span>UNIV <span class="main">::</span> perm set<span class="main">|</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> surj_imp_ordLeq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV <span class="main">::</span> perm set<span class="main">|</span> <span class="keyword1">&lt;o</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_idx_perm<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span> <span class="keyword1">≤o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cnotzero_UNIV ordLeq_csum2<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">― ‹just an auxiliary lemma that will be useful further below›</span>
  <span class="keyword1" id="Weak_Expressive_Completeness-distinguishing_weak_formula_supp_aux"><span class="command">lemma</span></span> distinguishing_weak_formula_supp_aux<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="main">≡⋅</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Abs_bset <span class="main">{</span><span class="main">-</span><span class="bound">p</span> <span class="main">∙</span> <span class="main">(</span><span class="main">ϵ</span><span class="bound">x</span><span class="main">.</span> weak_formula <span class="bound">x</span> <span class="main">∧</span> supp <span class="bound">x</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">distinguishes</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">from</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">p</span><span class="main">.</span> True<span class="main">}</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?some</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="main">ϵ</span><span class="bound">x</span><span class="main">.</span> weak_formula <span class="bound">x</span> <span class="main">∧</span> supp <span class="bound">x</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">distinguishes</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">from</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">-</span><span class="bound">p</span> <span class="main">∙</span> <span class="var">?some</span> <span class="bound">p</span><span class="main">|</span><span class="bound">p</span><span class="main">.</span> True<span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">P</span> <span class="main">≡⋅</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> weakly_logically_equivalent_eqvt permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="var">?some</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> distinguished_bounded_support <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> weakly_equivalent_iff_not_distinguished someI_ex<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> supp_some <span class="main">=</span> this

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="var">?some</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> supp_some <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="skolem">x</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> permute_boolE subset_eqvt supp_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> <span class="quoted">"*"</span> <span class="main">=</span> this
    <span class="keyword1"><span class="command">have</span></span> supp_B<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="var">?B</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> set_bounded_supp<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> finite_supp<span class="main"><span class="keyword3">,</span></span> <span class="operator">cut_tac</span> <span class="quoted">"*"</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> supp_B <span class="keyword2"><span class="keyword">and</span></span> distinguishing_weak_formula_card_aux <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> supp_Abs_bset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Weak_Expressive_Completeness-distinguishing_weak_formula_eqvt"><span class="command">lemma</span></span> distinguishing_weak_formula_eqvt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="main">≡⋅</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> distinguishing_weak_formula <span class="free">P</span> <span class="free">Q</span> <span class="main">=</span> distinguishing_weak_formula <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?some</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="main">ϵ</span><span class="bound">x</span><span class="main">.</span> weak_formula <span class="bound">x</span> <span class="main">∧</span> supp <span class="bound">x</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">distinguishes</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">from</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">-</span><span class="bound">p</span> <span class="main">∙</span> <span class="var">?some</span> <span class="bound">p</span><span class="main">|</span><span class="bound">p</span><span class="main">.</span> True<span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> distinguishing_weak_formula_supp_aux<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_supp rev_finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> distinguishing_weak_formula_card_aux <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Conj <span class="main">(</span>Abs_bset <span class="var">?B</span><span class="main">)</span> <span class="main">=</span> Conj <span class="main">(</span>Abs_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="var">?B</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?some'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p'</span><span class="main">.</span> <span class="main">(</span><span class="main">ϵ</span><span class="bound">x</span><span class="main">.</span> weak_formula <span class="bound">x</span> <span class="main">∧</span> supp <span class="bound">x</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="bound">p'</span> <span class="main">∙</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">distinguishes</span> <span class="main">(</span><span class="bound">p'</span> <span class="main">∙</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">from</span> <span class="main">(</span><span class="bound">p'</span> <span class="main">∙</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">-</span><span class="bound">p'</span> <span class="main">∙</span> <span class="var">?some'</span> <span class="bound">p'</span><span class="main">|</span><span class="bound">p'</span><span class="main">.</span> True<span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="var">?B</span> <span class="main">=</span> <span class="var">?B'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">px</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">px</span> <span class="main">∈</span> <span class="free">p</span> <span class="main">∙</span> <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">px</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> image_iff permute_set_eq_image<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">-</span><span class="skolem">p'</span> <span class="main">∙</span> <span class="var">?some</span> <span class="skolem">p'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">px</span> <span class="main">=</span> <span class="main">-</span><span class="main">(</span><span class="skolem">p'</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?some'</span> <span class="main">(</span><span class="skolem">p'</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">px</span> <span class="main">∈</span> <span class="var">?B'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="var">?B</span> <span class="main">⊆</span> <span class="var">?B'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?B'</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">-</span><span class="skolem">p'</span> <span class="main">∙</span> <span class="var">?some'</span> <span class="skolem">p'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∙</span> <span class="main">-</span><span class="main">(</span><span class="skolem">p'</span> <span class="main">+</span> <span class="free">p</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?some</span> <span class="main">(</span><span class="skolem">p'</span> <span class="main">+</span> <span class="free">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.inverse_distrib_swap<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">p</span> <span class="main">∙</span> <span class="var">?B</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> mem_permute_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B'</span> <span class="main">⊆</span> <span class="free">p</span> <span class="main">∙</span> <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"*"</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> distinguishing_weak_formula_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Weak_Expressive_Completeness-supp_distinguishing_weak_formula"><span class="command">lemma</span></span> supp_distinguishing_weak_formula<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="main">≡⋅</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>distinguishing_weak_formula <span class="free">P</span> <span class="free">Q</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?some</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="main">ϵ</span><span class="bound">x</span><span class="main">.</span> weak_formula <span class="bound">x</span> <span class="main">∧</span> supp <span class="bound">x</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">distinguishes</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">from</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">-</span> <span class="bound">p</span> <span class="main">∙</span> <span class="var">?some</span> <span class="bound">p</span><span class="main">|</span><span class="bound">p</span><span class="main">.</span> True<span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> distinguishing_weak_formula_supp_aux<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_supp rev_finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> distinguishing_weak_formula_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Weak_Expressive_Completeness-distinguishing_weak_formula_distinguishes"><span class="command">lemma</span></span> distinguishing_weak_formula_distinguishes<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="main">≡⋅</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>distinguishing_weak_formula <span class="free">P</span> <span class="free">Q</span><span class="main">)</span> <span class="keyword1">distinguishes</span> <span class="free">P</span> <span class="keyword1">from</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?some</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="main">ϵ</span><span class="bound">x</span><span class="main">.</span> weak_formula <span class="bound">x</span> <span class="main">∧</span> supp <span class="bound">x</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">distinguishes</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">from</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">-</span> <span class="bound">p</span> <span class="main">∙</span> <span class="var">?some</span> <span class="bound">p</span><span class="main">|</span><span class="bound">p</span><span class="main">.</span> True<span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">≡⋅</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> weakly_logically_equivalent_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?some</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">distinguishes</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">from</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> distinguished_bounded_support weakly_equivalent_iff_not_distinguished someI_ex<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> some_distinguishes <span class="main">=</span> this

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P'</span>
      <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> distinguishing_weak_formula_supp_aux<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> finite_supp rev_finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> distinguishing_weak_formula_card_aux <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> distinguishing_weak_formula <span class="free">P</span> <span class="free">Q</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="var">?B</span><span class="main">.</span> <span class="skolem">P'</span> <span class="main">⊨</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> distinguishing_weak_formula_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> valid_distinguishing_formula <span class="main">=</span> this

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> <span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="var">?some</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> is_distinguishing_formula_def permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> some_distinguishes valid_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> distinguishing_weak_formula <span class="free">P</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid_distinguishing_formula <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">Q</span> <span class="main">⊨</span> distinguishing_weak_formula <span class="free">P</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid_distinguishing_formula <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> is_distinguishing_formula_def mem_Collect_eq permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> some_distinguishes valid_eqvt<span class="main">)</span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>distinguishing_weak_formula <span class="free">P</span> <span class="free">Q</span><span class="main">)</span> <span class="keyword1">distinguishes</span> <span class="free">P</span> <span class="keyword1">from</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> is_distinguishing_formula_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Weak_Expressive_Completeness-distinguishing_weak_formula_is_weak"><span class="command">lemma</span></span> distinguishing_weak_formula_is_weak<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="main">≡⋅</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"weak_formula <span class="main">(</span>distinguishing_weak_formula <span class="free">P</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?some</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="main">ϵ</span><span class="bound">x</span><span class="main">.</span> weak_formula <span class="bound">x</span> <span class="main">∧</span> supp <span class="bound">x</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">distinguishes</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">from</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">-</span> <span class="bound">p</span> <span class="main">∙</span> <span class="var">?some</span> <span class="bound">p</span><span class="main">|</span><span class="bound">p</span><span class="main">.</span> True<span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> distinguishing_weak_formula_supp_aux<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_supp rev_finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_bset <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="var">?B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> distinguishing_weak_formula_card_aux Abs_bset_inverse' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="var">?some</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">≡⋅</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> weakly_logically_equivalent_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"weak_formula <span class="main">(</span><span class="var">?some</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> distinguished_bounded_support weakly_equivalent_iff_not_distinguished someI_ex<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"weak_formula <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> distinguishing_weak_formula_def <span class="keyword1"><span class="command">using</span></span> wf_Conj <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>


  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Characteristic weak formulas›</span></span>
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A \emph{characteristic weak formula} for a state~$P$ is valid for (exactly) those states
    that are weakly bisimilar to~$P$.›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">characteristic_weak_formula</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="tfree">'act</span><span class="main">)</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">characteristic_weak_formula</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> Conj <span class="main">(</span>Abs_bset <span class="main">{</span>distinguishing_weak_formula <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">Q</span><span class="main">|</span><span class="bound">Q</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡⋅</span> <span class="bound">Q</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>

  <span class="comment1">― ‹just an auxiliary lemma that will be useful further below›</span>
  <span class="keyword1" id="Weak_Expressive_Completeness-characteristic_weak_formula_card_aux"><span class="command">lemma</span></span> characteristic_weak_formula_card_aux<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="main">{</span>distinguishing_weak_formula <span class="free">P</span> <span class="bound">Q</span><span class="main">|</span><span class="bound">Q</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="main">≡⋅</span> <span class="bound">Q</span><span class="main">)</span><span class="main">}</span><span class="main">|</span> <span class="keyword1">&lt;o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>distinguishing_weak_formula <span class="free">P</span> <span class="bound">Q</span><span class="main">|</span><span class="bound">Q</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="main">≡⋅</span> <span class="bound">Q</span><span class="main">)</span><span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">⊆</span> <span class="main">(</span>distinguishing_weak_formula <span class="free">P</span><span class="main">)</span> <span class="main">`</span> UNIV"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?B</span><span class="main">|</span> <span class="keyword1">≤o</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'state</span> set<span class="main">|</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> surj_imp_ordLeq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'state</span> set<span class="main">|</span> <span class="keyword1">&lt;o</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_idx_state<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span> <span class="keyword1">≤o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cnotzero_UNIV ordLeq_csum2<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">― ‹just an auxiliary lemma that will be useful further below›</span>
  <span class="keyword1" id="Weak_Expressive_Completeness-characteristic_weak_formula_supp_aux"><span class="command">lemma</span></span> characteristic_weak_formula_supp_aux<span class="main">:</span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Abs_bset <span class="main">{</span>distinguishing_weak_formula <span class="free">P</span> <span class="bound">Q</span><span class="main">|</span><span class="bound">Q</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="main">≡⋅</span> <span class="bound">Q</span><span class="main">)</span><span class="main">}</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>distinguishing_weak_formula <span class="free">P</span> <span class="bound">Q</span><span class="main">|</span><span class="bound">Q</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="main">≡⋅</span> <span class="bound">Q</span><span class="main">)</span><span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> distinguishing_weak_formula <span class="free">P</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="main">≡⋅</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> supp_distinguishing_weak_formula <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="skolem">x</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> <span class="quoted">"*"</span> <span class="main">=</span> this
    <span class="keyword1"><span class="command">have</span></span> supp_B<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="var">?B</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> set_bounded_supp<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> finite_supp<span class="main"><span class="keyword3">,</span></span> <span class="operator">cut_tac</span> <span class="quoted">"*"</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> supp_B <span class="keyword2"><span class="keyword">and</span></span> characteristic_weak_formula_card_aux <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> supp_Abs_bset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Weak_Expressive_Completeness-characteristic_weak_formula_eqvt"><span class="command">lemma</span></span> characteristic_weak_formula_eqvt <span class="comment1">(*[eqvt]*)</span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> characteristic_weak_formula <span class="free">P</span> <span class="main">=</span> characteristic_weak_formula <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>distinguishing_weak_formula <span class="free">P</span> <span class="bound">Q</span><span class="main">|</span><span class="bound">Q</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="main">≡⋅</span> <span class="bound">Q</span><span class="main">)</span><span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> characteristic_weak_formula_supp_aux<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_supp rev_finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> characteristic_weak_formula_card_aux <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Conj <span class="main">(</span>Abs_bset <span class="var">?B</span><span class="main">)</span> <span class="main">=</span> Conj <span class="main">(</span>Abs_bset <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="var">?B</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>distinguishing_weak_formula <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="bound">Q</span><span class="main">|</span><span class="bound">Q</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">≡⋅</span> <span class="bound">Q</span><span class="main">)</span><span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="var">?B</span> <span class="main">=</span> <span class="var">?B'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">px</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">px</span> <span class="main">∈</span> <span class="free">p</span> <span class="main">∙</span> <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">px</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∙</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> image_iff permute_set_eq_image<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> distinguishing_weak_formula <span class="free">P</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="main">≡⋅</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">px</span> <span class="main">=</span> distinguishing_weak_formula <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">≡⋅</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> weakly_logically_equivalent_eqvt permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">px</span> <span class="main">∈</span> <span class="var">?B'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="var">?B</span> <span class="main">⊆</span> <span class="var">?B'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?B'</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> distinguishing_weak_formula <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">≡⋅</span> <span class="skolem">Q</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="main">≡⋅</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> weakly_logically_equivalent_eqvt permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∙</span> distinguishing_weak_formula <span class="free">P</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">p</span> <span class="main">∙</span> <span class="var">?B</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> mem_permute_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B'</span> <span class="main">⊆</span> <span class="free">p</span> <span class="main">∙</span> <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"*"</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> characteristic_weak_formula_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Weak_Expressive_Completeness-characteristic_weak_formula_eqvt_raw"><span class="command">lemma</span></span> characteristic_weak_formula_eqvt_raw <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> characteristic_weak_formula <span class="main">=</span> characteristic_weak_formula"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_fun_def<span class="main">)</span>

  <span class="keyword1" id="Weak_Expressive_Completeness-characteristic_weak_formula_is_weak"><span class="command">lemma</span></span> characteristic_weak_formula_is_weak<span class="main">:</span>
    <span class="quoted"><span class="quoted">"weak_formula <span class="main">(</span>characteristic_weak_formula <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>distinguishing_weak_formula <span class="free">P</span> <span class="bound">Q</span><span class="main">|</span><span class="bound">Q</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="main">≡⋅</span> <span class="bound">Q</span><span class="main">)</span><span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> characteristic_weak_formula_supp_aux<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_supp rev_finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_bset <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="var">?B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> characteristic_weak_formula_card_aux Abs_bset_inverse' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"weak_formula <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> distinguishing_weak_formula_is_weak <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> characteristic_weak_formula_def <span class="keyword1"><span class="command">using</span></span> wf_Conj <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Weak_Expressive_Completeness-characteristic_weak_formula_is_characteristic'"><span class="command">lemma</span></span> characteristic_weak_formula_is_characteristic'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⊨</span> characteristic_weak_formula <span class="free">P</span> <span class="main">⟷</span> <span class="free">P</span> <span class="main">≡⋅</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>distinguishing_weak_formula <span class="free">P</span> <span class="bound">Q</span><span class="main">|</span><span class="bound">Q</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="main">≡⋅</span> <span class="bound">Q</span><span class="main">)</span><span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P'</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">P</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> characteristic_weak_formula_supp_aux<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> finite_supp rev_finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> characteristic_weak_formula_card_aux <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> characteristic_weak_formula <span class="free">P</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="var">?B</span><span class="main">.</span> <span class="skolem">P'</span> <span class="main">⊨</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> characteristic_weak_formula_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> valid_characteristic_formula <span class="main">=</span> this

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⊨</span> characteristic_weak_formula <span class="free">P</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≡⋅</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="main">≡⋅</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"*"</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> distinguishing_weak_formula_distinguishes is_distinguishing_formula_def valid_characteristic_formula <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≡⋅</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> characteristic_weak_formula <span class="free">P</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> distinguishing_weak_formula_distinguishes is_distinguishing_formula_def valid_characteristic_formula <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⊨</span> characteristic_weak_formula <span class="free">P</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> weakly_logically_equivalent_def characteristic_weak_formula_is_weak <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Weak_Expressive_Completeness-characteristic_weak_formula_is_characteristic"><span class="command">lemma</span></span> characteristic_weak_formula_is_characteristic<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⊨</span> characteristic_weak_formula <span class="free">P</span> <span class="main">⟷</span> <span class="free">P</span> <span class="main">≈⋅</span> <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> characteristic_weak_formula_is_characteristic' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> weak_bisimilarity_implies_weak_equivalence weak_equivalence_implies_weak_bisimilarity<span class="main">)</span>


  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Weak expressive completeness›</span></span>
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Every finitely supported set of states that is closed under weak bisimulation can be
    described by a weak formula; namely, by a disjunction of characteristic weak formulas.›</span></span>

  <span class="keyword1"><span class="command">theorem</span></span> weak_expressive_completeness<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="main">≈⋅</span> <span class="bound">Q</span> <span class="main">⟹</span> <span class="bound">Q</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Disj <span class="main">(</span>Abs_bset <span class="main">(</span>characteristic_weak_formula <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">P</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"weak_formula <span class="main">(</span>Disj <span class="main">(</span>Abs_bset <span class="main">(</span>characteristic_weak_formula <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"characteristic_weak_formula <span class="main">`</span> <span class="free">S</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">⊆</span> characteristic_weak_formula <span class="main">`</span> UNIV"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?B</span><span class="main">|</span> <span class="keyword1">≤o</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'state</span> set<span class="main">|</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> surj_imp_ordLeq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'state</span> set<span class="main">|</span> <span class="keyword1">&lt;o</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_idx_state<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span> <span class="keyword1">≤o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cnotzero_UNIV ordLeq_csum2<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> card_B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?B</span><span class="main">|</span> <span class="keyword1">&lt;o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eqvt image"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eqvt characteristic_weak_formula"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvtI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> supp_B<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="var">?B</span> <span class="main">⊆</span> supp <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> supp_fun_eqvt supp_fun_app supp_fun_app_eqvt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> card_B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> supp_Abs_bset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>supp <span class="free">S</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_supp rev_finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">with</span></span> card_B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Disj <span class="main">(</span>Abs_bset <span class="main">(</span>characteristic_weak_formula <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="var">?B</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊨</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="main">≈⋅</span> <span class="bound">Q</span> <span class="main">⟹</span> <span class="bound">Q</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Disj <span class="main">(</span>Abs_bset <span class="main">(</span>characteristic_weak_formula <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">P</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> characteristic_weak_formula_is_characteristic characteristic_weak_formula_is_characteristic' weakly_logically_equivalent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

    <span class="comment1">― ‹it remains to show that the disjunction is a weak formula›</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eqvt Formula.Not"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvtI<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> supp_B <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹eqvt image›</span></span> <span class="keyword1"><span class="command">have</span></span> supp_Not_B<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Formula.Not <span class="main">`</span> <span class="var">?B</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> supp_fun_eqvt supp_fun_app supp_fun_app_eqvt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>Formula.Not <span class="main">`</span> <span class="var">?B</span><span class="main">|</span> <span class="keyword1">≤o</span> <span class="main">|</span><span class="var">?B</span><span class="main">|</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> card_B
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> card_not_B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span>Formula.Not <span class="main">`</span> <span class="var">?B</span><span class="main">|</span> <span class="keyword1">&lt;o</span> natLeq <span class="keyword1">+c</span> <span class="main">|</span>UNIV <span class="main">::</span> <span class="tfree">'idx</span> set<span class="main">|</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

    <span class="keyword1"><span class="command">with</span></span> supp_Not_B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Abs_bset <span class="main">(</span>Formula.Not <span class="main">`</span> <span class="var">?B</span><span class="main">)</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> supp_Abs_bset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>supp <span class="free">S</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>Abs_bset <span class="main">(</span>Formula.Not <span class="main">`</span> <span class="var">?B</span><span class="main">)</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_supp rev_finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> Formula.Not <span class="main">`</span> <span class="var">?B</span> <span class="main">⟹</span> weak_formula <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> characteristic_weak_formula_is_weak wf_Not <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> card_B <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"map_bset Formula.Not <span class="main">(</span>Abs_bset <span class="var">?B</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Abs_bset <span class="main">(</span>Formula.Not <span class="main">`</span> <span class="var">?B</span><span class="main">)</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> map_bset.abs_eq<span class="main">[</span><span class="operator">unfolded</span> eq_onp_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> card_not_B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_bset <span class="main">(</span>Abs_bset <span class="main">(</span>Formula.Not <span class="main">`</span> <span class="var">?B</span><span class="main">)</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">set[</span><span class="tfree">'idx</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> Formula.Not <span class="main">`</span> <span class="var">?B</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"weak_formula <span class="main">(</span>Disj <span class="main">(</span>Abs_bset <span class="main">(</span>characteristic_weak_formula <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Disj_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wf_Conj wf_Not<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="S_Transform">
<div class="head">
<h1>Theory S_Transform</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> S_Transform
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Bisimilarity_Implies_Equivalence">Bisimilarity_Implies_Equivalence</a>
  <a href="#Equivalence_Implies_Bisimilarity">Equivalence_Implies_Bisimilarity</a>
  <a href="#Weak_Bisimilarity_Implies_Equivalence">Weak_Bisimilarity_Implies_Equivalence</a>
  <a href="#Weak_Equivalence_Implies_Bisimilarity">Weak_Equivalence_Implies_Bisimilarity</a>
  <a href="#Weak_Expressive_Completeness">Weak_Expressive_Completeness</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹\texorpdfstring{$S$}{S}-Transform: State Predicates as Actions›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Actions and binding names›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">)</span> S_action <span class="main">=</span>
    Act <span class="tfree"><span class="quoted"><span class="tfree">'act</span></span></span>
  <span class="main">|</span> Pred <span class="tfree"><span class="quoted"><span class="tfree">'pred</span></span></span>

<span class="keyword1"><span class="command">instantiation</span></span> S_action <span class="main">::</span> <span class="main">(</span><span class="quoted">pt</span><span class="main">,</span><span class="quoted">pt</span><span class="main">)</span> <span class="quoted">pt</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">permute_S_action</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"perm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> S_action <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> S_action"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="main">(</span>Act <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span> <span class="main">=</span> Act <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="main">(</span>Pred <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> Pred <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> S_action"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> S_action"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">+</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">declare</span></span> permute_S_action.simps <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span>

<span class="keyword1" id="S_Transform-supp_Act"><span class="command">lemma</span></span> supp_Act <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Act <span class="free">α</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">α</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="S_Transform-supp_Pred"><span class="command">lemma</span></span> supp_Pred <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Pred <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">instantiation</span></span> S_action <span class="main">::</span> <span class="main">(</span><span class="quoted">fs</span><span class="main">,</span><span class="quoted">fs</span><span class="main">)</span> <span class="quoted">fs</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> S_action"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_supp<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> S_action <span class="main">::</span> <span class="main">(</span><span class="quoted">bn</span><span class="main">,</span><span class="quoted">fs</span><span class="main">)</span> <span class="quoted">bn</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">bn_S_action</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> S_action <span class="main">⇒</span> atom set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">bn_S_action</span> <span class="main">(</span>Act <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span> <span class="main">=</span> bn <span class="free"><span class="bound"><span class="entity">α</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bn_S_action</span> <span class="main">(</span>Pred <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> S_action"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> bn <span class="skolem">α</span> <span class="main">=</span> bn <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">α</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bn_eqvt<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> S_action"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>bn <span class="skolem">α</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">α</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bn_finite<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Satisfaction›</span></span>

<span class="keyword1"><span class="command">context</span></span> nominal_ts
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Here our formalization differs from the informal presentation, where the $S$-transform does
  not have any predicates. In Isabelle/HOL, there are no empty types; we use type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">unit</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  instead. However, it is clear from the following definition of the satisfaction relation that the
  single element of this type is not actually used in any meaningful way.›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">S_satisfies</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> unit <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊢<span class="hidden">⇩</span><sub>S</sub></span>"</span> 70<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>S</sub></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">⟷</span> False"</span></span>

  <span class="keyword1" id="S_Transform-S_satisfies_eqvt"><span class="command">lemma</span></span> S_satisfies_eqvt<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_satisfies_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transitions›</span></span>

<span class="keyword1"><span class="command">context</span></span> nominal_ts
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">S_transition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">)</span> S_action<span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> residual <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">→<span class="hidden">⇩</span><sub>S</sub></span>"</span> 70<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
    Act<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">P'</span></span></span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>S</sub></span></span> <span class="main">⟨</span>Act <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">P'</span></span></span><span class="main">⟩</span>"</span></span>
  <span class="main">|</span> Pred<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>S</sub></span></span> <span class="main">⟨</span>Pred <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">⟩</span>"</span></span>

  <span class="keyword1" id="S_Transform-S_transition_eqvt"><span class="command">lemma</span></span> S_transition_eqvt<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">α<span class="hidden">⇩</span><sub>S</sub>P'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">α<span class="hidden">⇩</span><sub>S</sub>P'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_transition.Act transition_eqvt'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_transition.Pred satisfies_eqvt<span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If there is an $S$-transition, there is an ordinary transition with the same residual---it
  is not necessary to consider alpha-variants.›</span></span>

  <span class="keyword1" id="S_Transform-S_transition_cases"><span class="command">lemma</span></span> S_transition_cases <span class="main">[</span><span class="operator">case_names</span> Act Pred<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">⟨</span><span class="free">α<span class="hidden">⇩</span><sub>S</sub></span><span class="main">,</span><span class="free">P'</span><span class="main">⟩</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">α</span><span class="main">.</span> <span class="free">α<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">=</span> Act <span class="bound">α</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="free">P'</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">R</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span><span class="main">.</span> <span class="free">α<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">=</span> Pred <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P'</span> <span class="main">=</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">R</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">R</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> S_transition.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Act <span class="skolem">α'</span> <span class="skolem">P''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Act</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Act <span class="main">::</span> <span class="tfree">'act</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">)</span> S_action"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="free">α<span class="hidden">⇩</span><sub>S</sub></span><span class="main">,</span><span class="free">P'</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span>Act <span class="skolem">α'</span><span class="main">,</span><span class="skolem">P''</span><span class="main">⟩</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">α<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">=</span> Act <span class="skolem">α</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> bn_S_action.elims residual_empty_bn_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="free">α<span class="hidden">⇩</span><sub>S</sub></span><span class="main">,</span><span class="free">P'</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span>Act <span class="skolem">α'</span><span class="main">,</span><span class="skolem">P''</span><span class="main">⟩</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="var">?Act</span> <span class="skolem">α</span><span class="main">,</span> <span class="free">P'</span><span class="main">)</span> <span class="main">-</span> bn <span class="main">(</span><span class="var">?Act</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">=</span> supp <span class="main">(</span><span class="var">?Act</span> <span class="skolem">α'</span><span class="main">,</span> <span class="skolem">P''</span><span class="main">)</span> <span class="main">-</span> bn <span class="main">(</span><span class="var">?Act</span> <span class="skolem">α'</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp <span class="main">(</span><span class="var">?Act</span> <span class="skolem">α</span><span class="main">,</span> <span class="free">P'</span><span class="main">)</span> <span class="main">-</span> bn <span class="main">(</span><span class="var">?Act</span> <span class="skolem">α</span><span class="main">)</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="main">(</span><span class="var">?Act</span> <span class="skolem">α</span><span class="main">,</span> <span class="free">P'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?Act</span> <span class="skolem">α'</span><span class="main">,</span> <span class="skolem">P''</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> bn <span class="main">(</span><span class="var">?Act</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">=</span> bn <span class="main">(</span><span class="var">?Act</span> <span class="skolem">α'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> residual_eq_iff_perm<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="skolem">α</span><span class="main">,</span> <span class="free">P'</span><span class="main">)</span> <span class="main">-</span> bn <span class="skolem">α</span> <span class="main">=</span> supp <span class="main">(</span><span class="skolem">α'</span><span class="main">,</span> <span class="skolem">P''</span><span class="main">)</span> <span class="main">-</span> bn <span class="skolem">α'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp <span class="main">(</span><span class="skolem">α</span><span class="main">,</span> <span class="free">P'</span><span class="main">)</span> <span class="main">-</span> bn <span class="skolem">α</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="main">(</span><span class="skolem">α</span><span class="main">,</span> <span class="free">P'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">α'</span><span class="main">,</span> <span class="skolem">P''</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> bn <span class="skolem">α</span> <span class="main">=</span> bn <span class="skolem">α'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_Pair<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="free">P'</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">P''</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> residual_eq_iff_perm<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">α<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">=</span> Act <span class="skolem">α</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">P''</span><span class="main">⟩</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">R</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">α</span><span class="main">.</span> <span class="free">α<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">=</span> Act <span class="bound">α</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="free">P'</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pred <span class="skolem">φ</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="free">α<span class="hidden">⇩</span><sub>S</sub></span><span class="main">,</span><span class="free">P'</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span>Pred <span class="skolem">φ</span><span class="main">,</span><span class="free">P</span><span class="main">⟩</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">α<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">=</span> Pred <span class="skolem">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bn_S_action.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> residual_empty_bn_eq_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">R</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">φ</span><span class="main">.</span> <span class="free">α<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">=</span> Pred <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P'</span> <span class="main">=</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="S_Transform-S_transition_Act_iff"><span class="command">lemma</span></span> S_transition_Act_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">⟨</span>Act <span class="free">α</span><span class="main">,</span><span class="free">P'</span><span class="main">⟩</span> <span class="main">⟷</span> <span class="free">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="free">α</span><span class="main">,</span><span class="free">P'</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> S_transition.Act S_transition_cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1" id="S_Transform-S_transition_Pred_iff"><span class="command">lemma</span></span> S_transition_Pred_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">⟨</span>Pred <span class="free">φ</span><span class="main">,</span><span class="free">P'</span><span class="main">⟩</span> <span class="main">⟷</span> <span class="free">P'</span> <span class="main">=</span> <span class="free">P</span> <span class="main">∧</span> <span class="free">P</span> <span class="main"><span class="free">⊢</span></span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> S_transition.Pred S_transition_cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Strong Bisimilarity in the \texorpdfstring{$S$}{S}-transform›</span></span>

<span class="keyword1"><span class="command">context</span></span> nominal_ts
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">interpretation</span></span> S_transform<span class="main">:</span> nominal_ts <span class="quoted"><span class="quoted">"<span class="keyword1">(⊢<span class="hidden">⇩</span><sub>S</sub>)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(→<span class="hidden">⇩</span><sub>S</sub>)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">fact</span> S_satisfies_eqvt<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> S_transition_eqvt<span class="main">)</span>

  <span class="keyword1"><span class="command">no_notation</span></span> S_satisfies <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊢<span class="hidden">⇩</span><sub>S</sub></span>"</span> 70<span class="main">)</span> <span class="comment1">― ‹denotes <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> S_transform.S_satisfies<span class="antiquote">}</span></span> instead›</span>

  <span class="keyword1"><span class="command">notation</span></span> S_transform.bisimilar <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">∼⋅<span class="hidden">⇩</span><sub>S</sub></span>"</span> 100<span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Bisimilarity is equivalent to bisimilarity in the $S$-transform.›</span></span>

  <span class="keyword1" id="S_Transform-bisimilar_is_S_transform_bisimulation"><span class="command">lemma</span></span> bisimilar_is_S_transform_bisimulation<span class="main">:</span> <span class="quoted"><span class="quoted">"S_transform.is_bisimulation bisimilar"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> S_transform.is_bisimulation_def
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"symp bisimilar"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> bisimilar_symp<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∼⋅</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span><span class="main">.</span> <span class="bound">P</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">φ</span> <span class="main">⟶</span> <span class="bound">Q</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">φ</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_transform.S_satisfies_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∼⋅</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">α<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">P'</span><span class="main">.</span> bn <span class="bound">α<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">♯*</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="bound">P</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">⟨</span><span class="bound">α<span class="hidden">⇩</span><sub>S</sub></span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="bound">Q</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">⟨</span><span class="bound">α<span class="hidden">⇩</span><sub>S</sub></span><span class="main">,</span><span class="bound">Q'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">∼⋅</span> <span class="bound">Q'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">α<span class="hidden">⇩</span><sub>S</sub></span> <span class="skolem">P'</span>
        <span class="keyword3"><span class="command">assume</span></span> bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∼⋅</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh<span class="hidden">⇩</span><sub>S</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">♯*</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="hidden">⇩</span><sub>S</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">⟨</span><span class="skolem">α<span class="hidden">⇩</span><sub>S</sub></span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">⟨</span><span class="skolem">α<span class="hidden">⇩</span><sub>S</sub></span><span class="main">,</span><span class="skolem">Q'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">∼⋅</span> <span class="skolem">Q'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> trans<span class="hidden">⇩</span><sub>S</sub> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> S_transition_cases<span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Act <span class="skolem">α</span><span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">α<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">=</span> Act <span class="skolem">α</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh<span class="hidden">⇩</span><sub>S</sub> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="skolem">Q</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">with</span></span> bisim <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> transQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">Q'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bisim'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">∼⋅</span> <span class="skolem">Q'</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bisimilar_simulation_step<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">α<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">=</span> Act <span class="skolem">α</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> transQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">⟨</span><span class="skolem">α<span class="hidden">⇩</span><sub>S</sub></span><span class="main">,</span><span class="skolem">Q'</span><span class="main">⟩</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_transition.Act<span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> bisim' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">thesis</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">Q'</span><span class="main">.</span> <span class="skolem">Q</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">⟨</span><span class="skolem">α<span class="hidden">⇩</span><sub>S</sub></span><span class="main">,</span><span class="bound">Q'</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="skolem">P'</span> <span class="main">∼⋅</span> <span class="bound">Q'</span> <span class="main">⟹</span> <span class="skolem">thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pred <span class="skolem">φ</span><span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> bisim <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_bisimulation_def bisimilar_is_bisimulation<span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">α<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">=</span> Pred <span class="skolem">φ</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">⟨</span><span class="skolem">α<span class="hidden">⇩</span><sub>S</sub></span><span class="main">,</span><span class="skolem">Q</span><span class="main">⟩</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_transition.Pred<span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> bisim <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">P'</span> <span class="main">=</span> <span class="skolem">P</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">thesis</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">Q'</span><span class="main">.</span> <span class="skolem">Q</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">⟨</span><span class="skolem">α<span class="hidden">⇩</span><sub>S</sub></span><span class="main">,</span><span class="bound">Q'</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="skolem">P'</span> <span class="main">∼⋅</span> <span class="bound">Q'</span> <span class="main">⟹</span> <span class="skolem">thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="skolem">Q</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">⟨</span><span class="skolem">α<span class="hidden">⇩</span><sub>S</sub></span><span class="main">,</span><span class="bound">Q'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="skolem">P'</span> <span class="main">∼⋅</span> <span class="bound">Q'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">∧</span> <span class="var">?T</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="S_Transform-S_transform_bisimilar_is_bisimulation"><span class="command">lemma</span></span> S_transform_bisimilar_is_bisimulation<span class="main">:</span> <span class="quoted"><span class="quoted">"is_bisimulation S_transform.bisimilar"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_bisimulation_def
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"symp S_transform.bisimilar"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> S_transform.bisimilar_symp<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="bound">P</span> <span class="keyword1">∼⋅<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span><span class="main">.</span> <span class="bound">P</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span> <span class="main">⟶</span> <span class="bound">Q</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">φ</span>
      <span class="keyword3"><span class="command">assume</span></span> bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="keyword1">∼⋅<span class="hidden">⇩</span><sub>S</sub></span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> valid <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">⟨</span>Pred <span class="skolem">φ</span><span class="main">,</span><span class="skolem">P</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> S_transition.Pred<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn <span class="main">(</span>Pred <span class="skolem">φ</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">Q</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> trans'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">⟨</span>Pred <span class="skolem">φ</span><span class="main">,</span><span class="skolem">Q'</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bisim <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> S_transform.bisimilar_simulation_step<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> trans' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> S_transition_Pred_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="bound">P</span> <span class="keyword1">∼⋅<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">α</span> <span class="bound">P'</span><span class="main">.</span> bn <span class="bound">α</span> <span class="main">♯*</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="bound">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="bound">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">Q'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="keyword1">∼⋅<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">Q'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">α</span> <span class="skolem">P'</span>
        <span class="keyword3"><span class="command">assume</span></span> bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="keyword1">∼⋅<span class="hidden">⇩</span><sub>S</sub></span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> trans <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">⟨</span>Act <span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> S_transition.Act<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> bisim <span class="keyword2"><span class="keyword">and</span></span> fresh <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> trans'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">⟨</span>Act <span class="skolem">α</span><span class="main">,</span><span class="skolem">Q'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bisim'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="keyword1">∼⋅<span class="hidden">⇩</span><sub>S</sub></span> <span class="skolem">Q'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> S_transform.bisimilar_simulation_step bn_S_action.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> trans' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">Q'</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> S_transition_Act_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> bisim' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="skolem">Q</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="bound">Q'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="skolem">P'</span> <span class="keyword1">∼⋅<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">Q'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">∧</span> <span class="var">?T</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">theorem</span></span> S_transform_bisimilar_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">∼⋅<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Q</span> <span class="main">⟷</span> <span class="free">P</span> <span class="main">∼⋅</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">∼⋅<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∼⋅</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> S_transform_bisimilar_is_bisimulation bisimilar_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∼⋅</span> <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">∼⋅<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> S_transform.bisimilar_def bisimilar_is_S_transform_bisimulation<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Weak Bisimilarity in the \texorpdfstring{$S$}{S}-transform›</span></span>

<span class="keyword1"><span class="command">context</span></span> weak_nominal_ts
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="S_Transform-weakly_bisimilar_tau_transition_weakly_bisimilar"><span class="command">lemma</span></span> weakly_bisimilar_tau_transition_weakly_bisimilar<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≈⋅</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⇒</span> <span class="free">R</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">≈⋅</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?bisim</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">S</span> <span class="bound">T</span><span class="main">.</span> <span class="bound">S</span> <span class="main">≈⋅</span> <span class="bound">T</span> <span class="main">∨</span> <span class="main">{</span><span class="bound">S</span><span class="main">,</span><span class="bound">T</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">Q</span><span class="main">,</span><span class="free">R</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_weak_bisimulation <span class="var">?bisim</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_weak_bisimulation_def
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"symp <span class="var">?bisim</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> weakly_bisimilar_symp <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_commute symp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">S</span> <span class="bound">T</span> <span class="bound">φ</span><span class="main">.</span> <span class="var">?bisim</span> <span class="bound">S</span> <span class="bound">T</span> <span class="main">∧</span> <span class="bound">S</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">T'</span><span class="main">.</span> <span class="bound">T</span> <span class="main">⇒</span> <span class="bound">T'</span> <span class="main">∧</span> <span class="var">?bisim</span> <span class="bound">S</span> <span class="bound">T'</span> <span class="main">∧</span> <span class="bound">T'</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="skolem">T</span> <span class="skolem">φ</span>
        <span class="keyword3"><span class="command">assume</span></span> bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?bisim</span> <span class="skolem">S</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> bisim <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">T'</span><span class="main">.</span> <span class="skolem">T</span> <span class="main">⇒</span> <span class="bound">T'</span> <span class="main">∧</span> <span class="var">?bisim</span> <span class="skolem">S</span> <span class="bound">T'</span> <span class="main">∧</span> <span class="bound">T'</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">≈⋅</span> <span class="skolem">T</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> valid <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_weak_bisimulation_def weakly_bisimilar_is_weak_bisimulation<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">S</span><span class="main">,</span> <span class="skolem">T</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">Q</span><span class="main">,</span> <span class="free">R</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="free">Q</span> <span class="main">∧</span> <span class="skolem">T</span> <span class="main">=</span> <span class="free">R</span> <span class="main">∨</span> <span class="skolem">T</span> <span class="main">=</span> <span class="free">Q</span> <span class="main">∧</span> <span class="skolem">S</span> <span class="main">=</span> <span class="free">R</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> doubleton_eq_iff<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="free">Q</span> <span class="main">∧</span> <span class="skolem">T</span> <span class="main">=</span> <span class="free">R</span>"</span></span>
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">⇒</span> <span class="free">Q</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">≈⋅</span> <span class="free">R</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> valid <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_weak_bisimulation_def tau_transition_trans weakly_bisimilar_is_weak_bisimulation weakly_bisimilar_tau_simulation_step<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> <span class="free">Q</span> <span class="main">∧</span> <span class="skolem">S</span> <span class="main">=</span> <span class="free">R</span>"</span></span>
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Q</span> <span class="main">⇒</span> <span class="free">R</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> valid <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> reflpE weakly_bisimilar_reflp<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">S</span> <span class="bound">T</span><span class="main">.</span> <span class="var">?bisim</span> <span class="bound">S</span> <span class="bound">T</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">α</span> <span class="bound">S'</span><span class="main">.</span> bn <span class="bound">α</span> <span class="main">♯*</span> <span class="bound">T</span> <span class="main">⟶</span> <span class="bound">S</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">S'</span><span class="main">⟩</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">T'</span><span class="main">.</span> <span class="bound">T</span> <span class="main">⇒⟨</span><span class="bound">α</span><span class="main">⟩</span> <span class="bound">T'</span> <span class="main">∧</span> <span class="var">?bisim</span> <span class="bound">S'</span> <span class="bound">T'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="skolem">T</span> <span class="skolem">α</span> <span class="skolem">S'</span>
        <span class="keyword3"><span class="command">assume</span></span> bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?bisim</span> <span class="skolem">S</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">S'</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> bisim <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">T'</span><span class="main">.</span> <span class="skolem">T</span> <span class="main">⇒⟨</span><span class="skolem">α</span><span class="main">⟩</span> <span class="bound">T'</span> <span class="main">∧</span> <span class="var">?bisim</span> <span class="skolem">S'</span> <span class="bound">T'</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">≈⋅</span> <span class="skolem">T</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> fresh <span class="keyword2"><span class="keyword">and</span></span> trans <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_weak_bisimulation_def weakly_bisimilar_is_weak_bisimulation<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">S</span><span class="main">,</span> <span class="skolem">T</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">Q</span><span class="main">,</span> <span class="free">R</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="free">Q</span> <span class="main">∧</span> <span class="skolem">T</span> <span class="main">=</span> <span class="free">R</span> <span class="main">∨</span> <span class="skolem">T</span> <span class="main">=</span> <span class="free">Q</span> <span class="main">∧</span> <span class="skolem">S</span> <span class="main">=</span> <span class="free">R</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> doubleton_eq_iff<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="free">Q</span> <span class="main">∧</span> <span class="skolem">T</span> <span class="main">=</span> <span class="free">R</span>"</span></span>
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">⇒</span> <span class="free">Q</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">≈⋅</span> <span class="free">R</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh <span class="keyword2"><span class="keyword">and</span></span> trans <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> observable_transition_stepI tau_refl weak_transition_stepI weak_transition_weakI weakly_bisimilar_weak_simulation_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> <span class="free">Q</span> <span class="main">∧</span> <span class="skolem">S</span> <span class="main">=</span> <span class="free">R</span>"</span></span>
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Q</span> <span class="main">⇒</span> <span class="free">R</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> observable_transition_stepI reflpE tau_refl weak_transition_stepI weak_transition_weakI weakly_bisimilar_reflp<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">∧</span> <span class="var">?T</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> weakly_bisimilar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">notation</span></span> S_satisfies <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊢<span class="hidden">⇩</span><sub>S</sub></span>"</span> 70<span class="main">)</span>

  <span class="keyword1"><span class="command">interpretation</span></span> S_transform<span class="main">:</span> weak_nominal_ts <span class="quoted"><span class="quoted">"<span class="keyword1">(⊢<span class="hidden">⇩</span><sub>S</sub>)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(→<span class="hidden">⇩</span><sub>S</sub>)</span>"</span></span> <span class="quoted"><span class="quoted">"Act <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">fact</span> S_satisfies_eqvt<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> S_transition_eqvt<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tau_eqvt<span class="main">)</span>

  <span class="keyword1"><span class="command">no_notation</span></span> S_satisfies <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊢<span class="hidden">⇩</span><sub>S</sub></span>"</span> 70<span class="main">)</span> <span class="comment1">― ‹denotes <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> S_transform.S_satisfies<span class="antiquote">}</span></span> instead›</span>

  <span class="keyword1"><span class="command">notation</span></span> S_transform.tau_transition <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⇒<span class="hidden">⇩</span><sub>S</sub></span>"</span> 70<span class="main">)</span>
  <span class="keyword1"><span class="command">notation</span></span> S_transform.observable_transition <span class="main">(</span><span class="quoted">"_<span class="keyword3">/ </span><span class="keyword1">⇒{</span>_<span class="keyword1">}<span class="hidden">⇩</span><sub>S</sub></span><span class="keyword3">/ </span>_"</span> <span class="main">[</span>70<span class="main">,</span> 70<span class="main">,</span> 71<span class="main">]</span> 71<span class="main">)</span>
  <span class="keyword1"><span class="command">notation</span></span> S_transform.weak_transition <span class="main">(</span><span class="quoted">"_<span class="keyword3">/ </span><span class="keyword1">⇒⟨</span>_<span class="keyword1">⟩<span class="hidden">⇩</span><sub>S</sub></span><span class="keyword3">/ </span>_"</span> <span class="main">[</span>70<span class="main">,</span> 70<span class="main">,</span> 71<span class="main">]</span> 71<span class="main">)</span>
  <span class="keyword1"><span class="command">notation</span></span> S_transform.weakly_bisimilar <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≈⋅<span class="hidden">⇩</span><sub>S</sub></span>"</span> 100<span class="main">)</span>

  <span class="keyword1" id="S_Transform-S_transform_tau_transition_iff"><span class="command">lemma</span></span> S_transform_tau_transition_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">P'</span> <span class="main">⟷</span> <span class="free">P</span> <span class="main">⇒</span> <span class="free">P'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">P'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒</span> <span class="free">P'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> S_transition_Act_iff tau_step<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒</span> <span class="free">P'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">P'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> S_transform.tau_transition.simps S_transition.Act<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="S_Transform-S_transform_observable_transition_iff"><span class="command">lemma</span></span> S_transform_observable_transition_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒{</span>Act <span class="free">α</span><span class="keyword1">}<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">P'</span> <span class="main">⟷</span> <span class="free">P</span> <span class="main">⇒{</span><span class="free">α</span><span class="main">}</span> <span class="free">P'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> S_transform.observable_transition_def observable_transition_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> S_transform_tau_transition_iff S_transition_Act_iff<span class="main">)</span>

  <span class="keyword1" id="S_Transform-S_transform_weak_transition_iff"><span class="command">lemma</span></span> S_transform_weak_transition_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇒⟨</span>Act <span class="free">α</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">P'</span> <span class="main">⟷</span> <span class="free">P</span> <span class="main">⇒⟨</span><span class="free">α</span><span class="main">⟩</span> <span class="free">P'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_transform_observable_transition_iff S_transform_tau_transition_iff weak_transition_def<span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Weak bisimilarity is equivalent to weak bisimilarity in the $S$-transform.›</span></span>

  <span class="keyword1" id="S_Transform-weakly_bisimilar_is_S_transform_weak_bisimulation"><span class="command">lemma</span></span> weakly_bisimilar_is_S_transform_weak_bisimulation<span class="main">:</span> <span class="quoted"><span class="quoted">"S_transform.is_weak_bisimulation weakly_bisimilar"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> S_transform.is_weak_bisimulation_def
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"symp weakly_bisimilar"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> weakly_bisimilar_symp<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span> <span class="bound">φ</span><span class="main">.</span> <span class="bound">P</span> <span class="main">≈⋅</span> <span class="bound">Q</span> <span class="main">∧</span> <span class="bound">P</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">φ</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="bound">Q</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="bound">P</span> <span class="main">≈⋅</span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="bound">Q'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">φ</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_transform.S_satisfies_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="bound">P</span> <span class="main">≈⋅</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">α<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">P'</span><span class="main">.</span> bn <span class="bound">α<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">♯*</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="bound">P</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">⟨</span><span class="bound">α<span class="hidden">⇩</span><sub>S</sub></span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="bound">Q</span> <span class="main">⇒⟨</span><span class="bound">α<span class="hidden">⇩</span><sub>S</sub></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">≈⋅</span> <span class="bound">Q'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">α<span class="hidden">⇩</span><sub>S</sub></span> <span class="skolem">P'</span>
        <span class="keyword3"><span class="command">assume</span></span> bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≈⋅</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh<span class="hidden">⇩</span><sub>S</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">♯*</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="hidden">⇩</span><sub>S</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">⟨</span><span class="skolem">α<span class="hidden">⇩</span><sub>S</sub></span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⇒⟨</span><span class="skolem">α<span class="hidden">⇩</span><sub>S</sub></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>S</sub></span> <span class="skolem">Q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">≈⋅</span> <span class="skolem">Q'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> trans<span class="hidden">⇩</span><sub>S</sub> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> S_transition_cases<span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Act <span class="skolem">α</span><span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">α<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">=</span> Act <span class="skolem">α</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh<span class="hidden">⇩</span><sub>S</sub> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="skolem">Q</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">with</span></span> bisim <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> transQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⇒⟨</span><span class="skolem">α</span><span class="main">⟩</span> <span class="skolem">Q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bisim'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">≈⋅</span> <span class="skolem">Q'</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_weak_bisimulation_def weakly_bisimilar_is_weak_bisimulation<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">α<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">=</span> Act <span class="skolem">α</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> transQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⇒⟨</span><span class="skolem">α<span class="hidden">⇩</span><sub>S</sub></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>S</sub></span> <span class="skolem">Q'</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> S_transform_weak_transition_iff<span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> bisim' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">thesis</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">Q'</span><span class="main">.</span> <span class="skolem">Q</span> <span class="main">⇒⟨</span><span class="skolem">α<span class="hidden">⇩</span><sub>S</sub></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">Q'</span> <span class="main">⟹</span> <span class="skolem">P'</span> <span class="main">≈⋅</span> <span class="bound">Q'</span> <span class="main">⟹</span> <span class="skolem">thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pred <span class="skolem">φ</span><span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> bisim <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⇒</span> <span class="skolem">Q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≈⋅</span> <span class="skolem">Q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_weak_bisimulation_def weakly_bisimilar_is_weak_bisimulation<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Q</span> <span class="main">⇒</span> <span class="skolem">Q'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>S</sub></span> <span class="skolem">Q'</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> S_transform_tau_transition_iff<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Q'</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">⟨</span>Pred <span class="skolem">φ</span><span class="main">,</span><span class="skolem">Q'</span><span class="main">⟩</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_transition.Pred<span class="main">)</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⇒⟨</span><span class="skolem">α<span class="hidden">⇩</span><sub>S</sub></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>S</sub></span> <span class="skolem">Q'</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">α<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">=</span> Pred <span class="skolem">φ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> S_transform.observable_transitionI S_transform.tau_refl S_transform.weak_transition_stepI<span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">P'</span> <span class="main">=</span> <span class="skolem">P</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">≈⋅</span> <span class="skolem">Q'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">thesis</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">Q'</span><span class="main">.</span> <span class="skolem">Q</span> <span class="main">⇒⟨</span><span class="skolem">α<span class="hidden">⇩</span><sub>S</sub></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">Q'</span> <span class="main">⟹</span> <span class="skolem">P'</span> <span class="main">≈⋅</span> <span class="bound">Q'</span> <span class="main">⟹</span> <span class="skolem">thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="skolem">Q</span> <span class="main">⇒⟨</span><span class="skolem">α<span class="hidden">⇩</span><sub>S</sub></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="skolem">P'</span> <span class="main">≈⋅</span> <span class="bound">Q'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">∧</span> <span class="var">?T</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="S_Transform-S_transform_weakly_bisimilar_is_weak_bisimulation"><span class="command">lemma</span></span> S_transform_weakly_bisimilar_is_weak_bisimulation<span class="main">:</span> <span class="quoted"><span class="quoted">"is_weak_bisimulation S_transform.weakly_bisimilar"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_weak_bisimulation_def
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"symp S_transform.weakly_bisimilar"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> S_transform.weakly_bisimilar_symp<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span> <span class="bound">φ</span><span class="main">.</span> <span class="bound">P</span> <span class="keyword1">≈⋅<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">Q</span> <span class="main">∧</span> <span class="bound">P</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="bound">Q</span> <span class="main">⇒</span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="bound">P</span> <span class="keyword1">≈⋅<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="bound">Q'</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">φ</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">φ</span>
      <span class="keyword3"><span class="command">assume</span></span> bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="keyword1">≈⋅<span class="hidden">⇩</span><sub>S</sub></span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> valid <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⇒⟨</span>Pred <span class="skolem">φ</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>S</sub></span> <span class="skolem">P</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_transition.Pred<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn <span class="main">(</span>Pred <span class="skolem">φ</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">Q</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q''</span></span> <span class="keyword2"><span class="keyword">where</span></span> trans'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⇒⟨</span>Pred <span class="skolem">φ</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>S</sub></span> <span class="skolem">Q''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bisim'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="keyword1">≈⋅<span class="hidden">⇩</span><sub>S</sub></span> <span class="skolem">Q''</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bisim <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> S_transform.weakly_bisimilar_weak_simulation_step<span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> trans' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="skolem"><span class="skolem">Q<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> trans<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>S</sub></span> <span class="skolem">Q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">⟨</span>Pred <span class="skolem">φ</span><span class="main">,</span> <span class="skolem">Q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="hidden">⇩</span><sub>3</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>S</sub></span> <span class="skolem">Q''</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_transform.observable_transition_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> trans<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">Q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> S_transition_Pred_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> trans<span class="hidden">⇩</span><sub>1</sub> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="hidden">⇩</span><sub>3</sub> <span class="keyword2"><span class="keyword">and</span></span> eq <span class="keyword2"><span class="keyword">and</span></span> bisim <span class="keyword2"><span class="keyword">and</span></span> bisim' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="keyword1">≈⋅<span class="hidden">⇩</span><sub>S</sub></span> <span class="skolem">Q'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> S_transform.weakly_bisimilar_equivp S_transform.weakly_bisimilar_tau_transition_weakly_bisimilar equivp_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> trans<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⇒</span> <span class="skolem">Q'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> S_transform_tau_transition_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="skolem">Q</span> <span class="main">⇒</span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="skolem">P</span> <span class="keyword1">≈⋅<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="bound">Q'</span> <span class="main"><span class="free">⊢</span></span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="bound">P</span> <span class="keyword1">≈⋅<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">α</span> <span class="bound">P'</span><span class="main">.</span> bn <span class="bound">α</span> <span class="main">♯*</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="bound">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="bound">α</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟩</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="bound">Q</span> <span class="main">⇒⟨</span><span class="bound">α</span><span class="main">⟩</span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="keyword1">≈⋅<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">Q'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">α</span> <span class="skolem">P'</span>
        <span class="keyword3"><span class="command">assume</span></span> bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="keyword1">≈⋅<span class="hidden">⇩</span><sub>S</sub></span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α</span> <span class="main">♯*</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> trans <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">⟨</span>Act <span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> S_transition.Act<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> bisim <span class="keyword2"><span class="keyword">and</span></span> fresh <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> trans'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⇒⟨</span>Act <span class="skolem">α</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>S</sub></span> <span class="skolem">Q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bisim'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="keyword1">≈⋅<span class="hidden">⇩</span><sub>S</sub></span> <span class="skolem">Q'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> S_transform.is_weak_bisimulation_def S_transform.weakly_bisimilar_is_weak_bisimulation bn_S_action.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> trans' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⇒⟨</span><span class="skolem">α</span><span class="main">⟩</span> <span class="skolem">Q'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> S_transform_weak_transition_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> bisim' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q'</span><span class="main">.</span> <span class="skolem">Q</span> <span class="main">⇒⟨</span><span class="skolem">α</span><span class="main">⟩</span> <span class="bound">Q'</span> <span class="main">∧</span> <span class="skolem">P'</span> <span class="keyword1">≈⋅<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">Q'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">∧</span> <span class="var">?T</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">theorem</span></span> S_transform_weakly_bisimilar_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">≈⋅<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Q</span> <span class="main">⟷</span> <span class="free">P</span> <span class="main">≈⋅</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">≈⋅<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≈⋅</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> S_transform_weakly_bisimilar_is_weak_bisimulation weakly_bisimilar_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≈⋅</span> <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">≈⋅<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> S_transform.weakly_bisimilar_def weakly_bisimilar_is_S_transform_weak_bisimulation<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Translation of (strong) formulas into formulas without predicates›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Since we defined formulas via a manual quotient construction, we also need to define the
$S$-transform via lifting from the underlying type of infinitely branching trees. As before, we
cannot use {\bf nominal\_function} because that generates proof obligations where, for formulas
of the form~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Conj <span class="free"><span class="free">xset</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the assumption that~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xset</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> has finite support is missing.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following auxiliary function returns trees (modulo $\alpha$-equivalence) rather than
formulas. This allows us to prove equivariance for \emph{all} argument trees, without an assumption
that they are (hereditarily) finitely supported. Further below--after this auxiliary function has
been lifted to (strong) formulas as arguments--we derive a version that returns formulas.›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">S_transform_Tree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>fs<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">)</span> Tree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> unit<span class="main">,</span> <span class="main">(</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">)</span> S_action<span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">S_transform_Tree</span> <span class="main">(</span>tConj <span class="free"><span class="bound"><span class="entity">tset</span></span></span><span class="main">)</span> <span class="main">=</span> Conj<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>map_bset <span class="free">S_transform_Tree</span> <span class="free"><span class="bound"><span class="entity">tset</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S_transform_Tree</span> <span class="main">(</span>tNot <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> Not<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span><span class="free">S_transform_Tree</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S_transform_Tree</span> <span class="main">(</span>tPred <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>S_action.Pred <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>Conj<span class="hidden">⇩</span><sub>α</sub> bempty<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S_transform_Tree</span> <span class="main">(</span>tAct <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>S_action.Act <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">S_transform_Tree</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="S_Transform-S_transform_Tree_eqvt"><span class="command">lemma</span></span> S_transform_Tree_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> S_transform_Tree <span class="free">t</span> <span class="main">=</span> S_transform_Tree <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tConj <span class="skolem">tset</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> bset.map_cong0 map_bset_eqvt permute_fun_def permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> S_transform_Tree<span class="antiquote"><span class="antiquote">}</span></span></span></span> respects $\alpha$-equivalence.›</span></span>

<span class="keyword1" id="S_Transform-alpha_Tree_S_transform_Tree"><span class="command">lemma</span></span> alpha_Tree_S_transform_Tree<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"S_transform_Tree <span class="free">t1</span> <span class="main">=</span> S_transform_Tree <span class="free">t2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alpha_Tree_induct'<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>alpha_tConj <span class="skolem">tset1</span> <span class="skolem">tset2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_bset <span class="main">(=)</span> <span class="main">(</span>map_bset S_transform_Tree <span class="skolem">tset1</span><span class="main">)</span> <span class="main">(</span>map_bset S_transform_Tree <span class="skolem">tset2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bset.rel_map<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> bset.rel_map<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> bset.rel_mono_strong<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bset.rel_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>alpha_tAct <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="skolem">α2</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹tAct <span class="skolem">α1</span> <span class="skolem">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> tAct <span class="skolem">α2</span> <span class="skolem">t2</span>›</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> <span class="skolem">t1</span><span class="main">)</span> <span class="keyword1">≈set</span> alpha_Tree <span class="main">(</span>supp_rel alpha_Tree<span class="main">)</span> <span class="skolem">p</span> <span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> <span class="skolem">α1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="skolem">p</span> <span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> <span class="skolem">α2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp_rel alpha_Tree <span class="skolem">t1</span> <span class="main">-</span> bn <span class="skolem">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> alpha<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">t1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">t2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> bn <span class="skolem">α1</span> <span class="main">=</span> bn <span class="skolem">α2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> alpha_tAct.IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp_rel alpha_Tree <span class="main">(</span>rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>S_transform_Tree <span class="skolem">t1</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> supp_rel alpha_Tree <span class="skolem">t1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> infinite_mono alpha_Tree_permute_rep_commute S_transform_Tree_eqvt mem_Collect_eq subsetI supp_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> fresh <span class="keyword1"><span class="command">have</span></span> fresh'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp_rel alpha_Tree <span class="main">(</span>rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>S_transform_Tree <span class="skolem">t1</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> bn <span class="skolem">α1</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> DiffD1 DiffD2 DiffI fresh_star_def subsetCE<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> alpha <span class="keyword1"><span class="command">have</span></span> alpha'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>S_transform_Tree <span class="skolem">t1</span><span class="main">)</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>α</sub></span> rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>S_transform_Tree <span class="skolem">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> alpha_tAct.IH<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_Tree_permute_rep_commute S_transform_Tree_eqvt<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> fresh' alpha' eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp_rel alpha_Tree <span class="main">(</span>rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>S_transform_Tree <span class="skolem">t1</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> bn <span class="skolem">α1</span> <span class="main">=</span> supp_rel alpha_Tree <span class="main">(</span>rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>S_transform_Tree <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> bn <span class="skolem">α2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> Diff_eqvt alpha_Tree_eqvt' alpha_Tree_eqvt_aux alpha_Tree_supp_rel atom_set_perm_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>S_transform_Tree <span class="skolem">t1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">≈set</span> alpha_Tree <span class="main">(</span>supp_rel alpha_Tree<span class="main">)</span> <span class="skolem">p</span> <span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> rep_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>S_transform_Tree <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_set<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ** <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bn <span class="skolem">α1</span><span class="main">,</span> S_action.Act <span class="skolem">α1</span><span class="main">)</span> <span class="keyword1">≈set</span> <span class="main">(=)</span> supp <span class="skolem">p</span> <span class="main">(</span>bn <span class="skolem">α2</span><span class="main">,</span> S_action.Act <span class="skolem">α2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> S_Transform.supp_Act alpha_set permute_S_action.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Act<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>S_action.Act <span class="skolem">α1</span><span class="main">)</span> <span class="main">(</span>S_transform_Tree <span class="skolem">t1</span><span class="main">)</span> <span class="main">=</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>S_action.Act <span class="skolem">α2</span><span class="main">)</span> <span class="main">(</span>S_transform_Tree <span class="skolem">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Act<span class="hidden">⇩</span><sub>α</sub>_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹$S$-transform for trees modulo $\alpha$-equivalence.›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> S_transform_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>fs<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> unit<span class="main">,</span> <span class="main">(</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">)</span> S_action<span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
    <span class="quoted">S_transform_Tree</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> alpha_Tree_S_transform_Tree<span class="main">)</span>

<span class="keyword1" id="S_Transform-S_transform_Tree"><span class="command">lemma</span></span> S_transform_Tree<span class="hidden">⇩</span><sub>α</sub>_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> S_transform_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">=</span> S_transform_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="S_Transform-S_transform_Tree"><span class="command">lemma</span></span> S_transform_Tree<span class="hidden">⇩</span><sub>α</sub>_Conj<span class="hidden">⇩</span><sub>α</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"S_transform_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>Conj<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">=</span> Conj<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>map_bset S_transform_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Conj<span class="hidden">⇩</span><sub>α</sub>_def' S_transform_Tree<span class="hidden">⇩</span><sub>α</sub>.abs_eq<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> S_transform_Tree<span class="hidden">⇩</span><sub>α</sub>.rep_eq bset.map_comp bset.map_cong0 comp_apply<span class="main">)</span>

<span class="keyword1" id="S_Transform-S_transform_Tree"><span class="command">lemma</span></span> S_transform_Tree<span class="hidden">⇩</span><sub>α</sub>_Not<span class="hidden">⇩</span><sub>α</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"S_transform_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>Not<span class="hidden">⇩</span><sub>α</sub> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">=</span> Not<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>S_transform_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="S_Transform-S_transform_Tree"><span class="command">lemma</span></span> S_transform_Tree<span class="hidden">⇩</span><sub>α</sub>_Pred<span class="hidden">⇩</span><sub>α</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"S_transform_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>Pred<span class="hidden">⇩</span><sub>α</sub> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>S_action.Pred <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>Conj<span class="hidden">⇩</span><sub>α</sub> bempty<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="S_Transform-S_transform_Tree"><span class="command">lemma</span></span> S_transform_Tree<span class="hidden">⇩</span><sub>α</sub>_Act<span class="hidden">⇩</span><sub>α</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"S_transform_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>Act<span class="hidden">⇩</span><sub>α</sub> <span class="free">α</span> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">=</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>S_action.Act <span class="free">α</span><span class="main">)</span> <span class="main">(</span>S_transform_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="S_Transform-finite_supp_map_bset_S_transform_Tree"><span class="command">lemma</span></span> finite_supp_map_bset_S_transform_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>map_bset S_transform_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eqvt map_bset"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eqvt S_transform_Tree<span class="hidden">⇩</span><sub>α</sub>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvtI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>map_bset S_transform_Tree<span class="hidden">⇩</span><sub>α</sub><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> supp_fun_eqvt supp_fun_app_eqvt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>map_bset S_transform_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> supp_fun_app <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>map_bset S_transform_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="S_Transform-S_transform_Tree"><span class="command">lemma</span></span> S_transform_Tree<span class="hidden">⇩</span><sub>α</sub>_preserves_hereditarily_fs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="main">(</span>S_transform_Tree<span class="hidden">⇩</span><sub>α</sub> <span class="free">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> hereditarily_fs.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Conj<span class="hidden">⇩</span><sub>α</sub> <span class="skolem">tset<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> hereditarily_fs.Conj<span class="hidden">⇩</span><sub>α</sub><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> imageE map_bset.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Not<span class="hidden">⇩</span><sub>α</sub> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hereditarily_fs.Not<span class="hidden">⇩</span><sub>α</sub><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pred<span class="hidden">⇩</span><sub>α</sub> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp bempty<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvtI supp_fun_eqvt<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> hereditarily_fs.Act<span class="hidden">⇩</span><sub>α</sub> finite_supp_implies_hereditarily_fs_Conj<span class="hidden">⇩</span><sub>α</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Act<span class="hidden">⇩</span><sub>α</sub> <span class="skolem">t<span class="hidden">⇩</span><sub>α</sub></span> <span class="skolem">α</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Formula.hereditarily_fs.Act<span class="hidden">⇩</span><sub>α</sub><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹$S$-transform for (strong) formulas.›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> S_transform_formula <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>fs<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">)</span> formula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> unit<span class="main">,</span> <span class="main">(</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">)</span> S_action<span class="main">)</span> Tree<span class="hidden">⇩</span><sub>α</sub>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
    <span class="quoted">S_transform_Tree<span class="hidden">⇩</span><sub>α</sub></span>
  <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="S_Transform-S_transform_formula_eqvt"><span class="command">lemma</span></span> S_transform_formula_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> S_transform_formula <span class="free">x</span> <span class="main">=</span> S_transform_formula <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="S_Transform-S_transform_formula_Conj"><span class="command">lemma</span></span> S_transform_formula_Conj <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"S_transform_formula <span class="main">(</span>Conj <span class="free">xset</span><span class="main">)</span> <span class="main">=</span> Conj<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>map_bset S_transform_formula <span class="free">xset</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Conj_def S_transform_formula_def bset.map_comp map_fun_def<span class="main">)</span>

<span class="keyword1" id="S_Transform-S_transform_formula_Not"><span class="command">lemma</span></span> S_transform_formula_Not <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"S_transform_formula <span class="main">(</span>Not <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Not<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>S_transform_formula <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="S_Transform-S_transform_formula_Pred"><span class="command">lemma</span></span> S_transform_formula_Pred <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"S_transform_formula <span class="main">(</span>Formula.Pred <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> Act<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>S_action.Pred <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>Conj<span class="hidden">⇩</span><sub>α</sub> bempty<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="S_Transform-S_transform_formula_Act"><span class="command">lemma</span></span> S_transform_formula_Act <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"S_transform_formula <span class="main">(</span>Formula.Act <span class="free">α</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Formula.Act<span class="hidden">⇩</span><sub>α</sub> <span class="main">(</span>S_action.Act <span class="free">α</span><span class="main">)</span> <span class="main">(</span>S_transform_formula <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="S_Transform-S_transform_formula_hereditarily_fs"><span class="command">lemma</span></span> S_transform_formula_hereditarily_fs <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hereditarily_fs <span class="main">(</span>S_transform_formula <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">fact</span> S_transform_Tree<span class="hidden">⇩</span><sub>α</sub>_preserves_hereditarily_fs<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally, we define the proper $S$-transform, which returns formulas instead of trees.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">S_transform</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">::</span>fs<span class="main">,</span><span class="tfree">'act</span><span class="main">::</span>bn<span class="main">)</span> formula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> unit<span class="main">,</span> <span class="main">(</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">)</span> S_action<span class="main">)</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">S_transform</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Abs_formula <span class="main">(</span>S_transform_formula <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="S_Transform-S_transform_eqvt"><span class="command">lemma</span></span> S_transform_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> S_transform <span class="free">x</span> <span class="main">=</span> S_transform <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> S_transform_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="S_Transform-finite_supp_map_bset_S_transform"><span class="command">lemma</span></span> finite_supp_map_bset_S_transform <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>map_bset S_transform <span class="free">xset</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eqvt map_bset"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eqvt S_transform"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvtI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>map_bset S_transform<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> supp_fun_eqvt supp_fun_app_eqvt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>map_bset S_transform <span class="free">xset</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">xset</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> supp_fun_app <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>map_bset S_transform <span class="free">xset</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="S_Transform-S_transform_Conj"><span class="command">lemma</span></span> S_transform_Conj <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">xset</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"S_transform <span class="main">(</span>Conj <span class="free">xset</span><span class="main">)</span> <span class="main">=</span> Conj <span class="main">(</span>map_bset S_transform <span class="free">xset</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> S_transform_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Conj_def bset.map_comp o_def<span class="main">)</span>

<span class="keyword1" id="S_Transform-S_transform_Not"><span class="command">lemma</span></span> S_transform_Not <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"S_transform <span class="main">(</span>Not <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Not <span class="main">(</span>S_transform <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> S_transform_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Not.abs_eq eq_onp_same_args<span class="main">)</span>

<span class="keyword1" id="S_Transform-S_transform_Pred"><span class="command">lemma</span></span> S_transform_Pred <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"S_transform <span class="main">(</span>Formula.Pred <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> Formula.Act <span class="main">(</span>S_action.Pred <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>Conj bempty<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> S_transform_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Formula.Act_def Conj_rep_eq eqvtI supp_fun_eqvt<span class="main">)</span>

<span class="keyword1" id="S_Transform-S_transform_Act"><span class="command">lemma</span></span> S_transform_Act <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"S_transform <span class="main">(</span>Formula.Act <span class="free">α</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Formula.Act <span class="main">(</span>S_action.Act <span class="free">α</span><span class="main">)</span> <span class="main">(</span>S_transform <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> S_transform_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Formula.Act_def<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> nominal_ts
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="S_Transform-valid_Conj_bempty"><span class="command">lemma</span></span> valid_Conj_bempty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> Conj bempty"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bempty.rep_eq eqvtI supp_fun_eqvt<span class="main">)</span>

  <span class="keyword1"><span class="command">notation</span></span> S_satisfies <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊢<span class="hidden">⇩</span><sub>S</sub></span>"</span> 70<span class="main">)</span>

  <span class="keyword1"><span class="command">interpretation</span></span> S_transform<span class="main">:</span> nominal_ts <span class="quoted"><span class="quoted">"<span class="keyword1">(⊢<span class="hidden">⇩</span><sub>S</sub>)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(→<span class="hidden">⇩</span><sub>S</sub>)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">fact</span> S_satisfies_eqvt<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> S_transition_eqvt<span class="main">)</span>

  <span class="keyword1"><span class="command">notation</span></span> S_transform.valid <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>S</sub></span>"</span> 70<span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The $S$-transform preserves satisfaction of formulas in the following sense:›</span></span>

  <span class="keyword1"><span class="command">theorem</span></span> valid_iff_valid_S_transform<span class="main">:</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊨</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">P</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>S</sub></span> S_transform <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Conj <span class="skolem">xset</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> imageE map_bset.rep_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_bset.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Not <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pred <span class="skolem">φ</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?φ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula.Pred <span class="skolem">φ</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'idx</span><span class="main">,</span> <span class="tfree">'pred</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">)</span> S_action<span class="main">)</span> formula"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn <span class="main">(</span>S_action.Pred <span class="skolem">φ</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'act</span><span class="main">,</span><span class="tfree">'pred</span><span class="main">)</span> S_action<span class="main">)</span> <span class="main">♯*</span> <span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_transform.valid_Act_fresh S_transition_Pred_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Act <span class="skolem">α</span> <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊨</span> Formula.Act <span class="skolem">α</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.Act <span class="skolem">α</span> <span class="skolem">x</span> <span class="main">=</span> Formula.Act <span class="skolem">α'</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">α'</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> <span class="skolem">x'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> valid_Act<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_α<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span> <span class="main">=</span> <span class="skolem">α'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Act_eq_iff_perm<span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> valid <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span> <span class="main">⊨</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> p_x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> valid_eqvt permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>S</sub></span> S_transform <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Act.hyps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>S</sub></span> S_transform <span class="skolem">x'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> p_x S_transform.valid_eqvt S_transform_eqvt permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

      <span class="keyword1"><span class="command">with</span></span> eq <span class="keyword2"><span class="keyword">and</span></span> trans <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>S</sub></span> S_transform <span class="main">(</span>Formula.Act <span class="skolem">α</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> S_transform.valid_Act S_transition.Act <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>S</sub></span> S_transform <span class="main">(</span>Formula.Act <span class="skolem">α</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>

      <span class="comment1">― ‹rename~<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"bn <span class="skolem">α</span>"</span><span class="antiquote">}</span></span> to avoid~<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="skolem">P</span>"</span><span class="antiquote">}</span></span>, without touching~<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Formula.Act <span class="skolem">α</span> <span class="skolem">x</span>"</span><span class="antiquote">}</span></span>›</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> bn <span class="skolem">α</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Formula.Act <span class="skolem">α</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> at_set_avoiding2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"bn <span class="skolem"><span class="skolem">α</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">P</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Formula.Act <span class="skolem"><span class="skolem">α</span></span> <span class="skolem"><span class="skolem">x</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> exE<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>bn <span class="skolem">α</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> bn_finite<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> finite_supp<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span>Formula.Act <span class="skolem">α</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> finite_supp<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bn <span class="skolem">α</span> <span class="main">♯*</span> Formula.Act <span class="skolem">α</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.Act <span class="skolem">α</span> <span class="skolem">x</span> <span class="main">=</span> Formula.Act <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> supp_perm_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

      <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>S</sub></span> Formula.Act <span class="main">(</span>S_action.Act <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>S_transform <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">⟨</span>S_action.Act <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">)</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>S</sub></span> S_transform <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> S_transform.valid_Act_fresh bn_S_action.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> bn_eqvt<span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> valid <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>S</sub></span> S_transform <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> S_transform.valid_eqvt S_transform_eqvt permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">P'</span> <span class="main">⊨</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Act.hyps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊨</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> valid_eqvt<span class="main">)</span>

      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> trans <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main"><span class="free">→</span></span> <span class="main">⟨</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">α</span><span class="main">,</span><span class="skolem">P'</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> S_transition_Act_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊨</span> Formula.Act <span class="skolem">α</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> eq valid_Act <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> indexed_nominal_ts
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following (alternative) proof of the ``$\rightarrow$'' direction of theorem
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> S_transform_bisimilar_iff<span class="antiquote"><span class="antiquote">}</span></span></span></span>, namely that bisimilarity in the $S$-transform implies
  bisimilarity in the original transition system, uses the fact that the $S$-transform(ation)
  preserves satisfaction of formulas, together with the fact that bisimilarity (in the
  $S$-transform) implies logical equivalence, and equivalence (in the original transition system)
  implies bisimilarity. However, since we proved the latter in the context of indexed nominal
  transition systems, this proof requires an indexed nominal transition system.›</span></span>

  <span class="keyword1"><span class="command">interpretation</span></span> S_transform<span class="main">:</span> indexed_nominal_ts <span class="quoted"><span class="quoted">"<span class="keyword1">(⊢<span class="hidden">⇩</span><sub>S</sub>)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(→<span class="hidden">⇩</span><sub>S</sub>)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">fact</span> S_satisfies_eqvt<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> S_transition_eqvt<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> card_idx_perm<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> card_idx_state<span class="main">)</span>

  <span class="keyword1"><span class="command">notation</span></span> S_transform.bisimilar <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">∼⋅<span class="hidden">⇩</span><sub>S</sub></span>"</span> 100<span class="main">)</span>

  <span class="keyword1"><span class="command">theorem</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">∼⋅<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Q</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">∼⋅</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">∼⋅<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S_transform.logically_equivalent <span class="free">P</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> S_transform.bisimilarity_implies_equivalence<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> valid_iff_valid_S_transform <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"logically_equivalent <span class="free">P</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> logically_equivalent_def S_transform.logically_equivalent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∼⋅</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> equivalence_implies_bisimilarity<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Translation of weak formulas into formulas without predicates›</span></span>

<span class="keyword1"><span class="command">context</span></span> indexed_weak_nominal_ts
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">notation</span></span> S_satisfies <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊢<span class="hidden">⇩</span><sub>S</sub></span>"</span> 70<span class="main">)</span>

  <span class="keyword1"><span class="command">interpretation</span></span> S_transform<span class="main">:</span> indexed_weak_nominal_ts <span class="quoted"><span class="quoted">"S_action.Act <span class="free">τ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(⊢<span class="hidden">⇩</span><sub>S</sub>)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(→<span class="hidden">⇩</span><sub>S</sub>)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">fact</span> S_satisfies_eqvt<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> S_transition_eqvt<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tau_eqvt<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> card_idx_perm<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> card_idx_state<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> card_idx_nat<span class="main">)</span>

  <span class="keyword1"><span class="command">notation</span></span> S_transform.valid <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>S</sub></span>"</span> 70<span class="main">)</span>
  <span class="keyword1"><span class="command">notation</span></span> S_transform.weakly_bisimilar <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≈⋅<span class="hidden">⇩</span><sub>S</sub></span>"</span> 100<span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The $S$-transform of a weak formula is not necessarily a weak formula. However, the image of
    all weak formulas under the $S$-transform is adequate for weak bisimilarity.›</span></span>

  <span class="keyword1"><span class="command">corollary</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">≈⋅<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Q</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> weak_formula <span class="bound">x</span> <span class="main">⟶</span> <span class="free">P</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>S</sub></span> S_transform <span class="bound">x</span> <span class="main">⟷</span> <span class="free">Q</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>S</sub></span> S_transform <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> valid_iff_valid_S_transform weak_bisimilarity_implies_weak_equivalence weak_equivalence_implies_weak_bisimilarity S_transform_weakly_bisimilar_iff weakly_logically_equivalent_def<span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For every weak formula, there is an equivalent weak formula over the $S$-transform.›</span></span>

  <span class="keyword1"><span class="command">corollary</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"weak_formula <span class="free">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"S_transform.weak_formula <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">⊨</span> <span class="free">x</span> <span class="main">⟷</span> <span class="bound">P</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">⊨</span> <span class="free">x</span><span class="main">}</span>"</span></span>

    <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="var">?S</span></span><span class="antiquote">}</span></span> is finitely supported›</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="free">x</span> <span class="keyword1">supports</span> <span class="var">?S</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> supports_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
      <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> supp <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> supp <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span>
        <span class="keyword1"><span class="command">from</span></span> a <span class="keyword2"><span class="keyword">and</span></span> b <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_def swap_fresh_fresh<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">P</span> <span class="main">⊨</span> <span class="free">x</span> <span class="main">⟷</span> <span class="skolem">P</span> <span class="main">⊨</span> <span class="free">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_swap_cancel valid_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> this
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">⇌</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?S</span> <span class="main">=</span> <span class="var">?S</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> mem_Collect_eq mem_permute_iff permute_swap_cancel <span class="quoted">"*"</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_eqvt permute_fun_def <span class="quoted">"*"</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="var">?S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_supp supports_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="var">?S</span></span><span class="antiquote">}</span></span> is closed under weak bisimilarity›</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="keyword1">≈⋅<span class="hidden">⇩</span><sub>S</sub></span> <span class="skolem">Q</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹weak_formula <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> S_transform_weakly_bisimilar_iff weak_bisimilarity_implies_weak_equivalence weakly_logically_equivalent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> S_transform.weak_expressive_completeness that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> mem_Collect_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>