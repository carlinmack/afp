<div id="Lib">
<div class="head">
<h1>Theory Lib</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright 2014, NICTA
 *
 * This software may be distributed and modified according to the terms of
 * the BSD 2-Clause license. Note that NO WARRANTY is provided.
 * See "LICENSE_BSD2.txt" for details.
 *
 * @TAG(NICTA_BSD)
 *)</span>

<span class="comment1">(*
   Miscellaneous library definitions and lemmas.
*)</span>

<span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">"Library"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lib
<span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* FIXME: eliminate *)</span>
<span class="keyword1" id="Lib-hd_map_simp"><span class="command">lemma</span></span> hd_map_simp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> hd <span class="main">(</span>map <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="main">(</span>hd <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hd_map<span class="main">)</span>

<span class="keyword1" id="Lib-tl_map_simp"><span class="command">lemma</span></span> tl_map_simp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"tl <span class="main">(</span>map <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> map <span class="free">a</span> <span class="main">(</span>tl <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">b</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>

<span class="comment1">(* FIXME: could be added to Set.thy *)</span>
<span class="keyword1" id="Lib-Collect_eq"><span class="command">lemma</span></span> Collect_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">}</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(* FIXME: move next to HOL.iff_allI *)</span>
<span class="keyword1" id="Lib-iff_impI"><span class="command">lemma</span></span> iff_impI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">P</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">=</span> <span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="main">⟶</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span> <span class="main">⟶</span> <span class="free">R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">fun_app</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">$</span>"</span> 10<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">$</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> fun_app_def <span class="main">[</span><span class="operator">iff</span><span class="main">]</span>

<span class="keyword1" id="Lib-fun_app_cong"><span class="command">lemma</span></span> fun_app_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f'</span> <span class="free">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f'</span> <span class="main">$</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Lib-fun_app_apply_cong"><span class="command">lemma</span></span> fun_app_apply_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> <span class="free">f'</span> <span class="free">x'</span> <span class="free">y'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="free">f'</span> <span class="main">$</span> <span class="free">x'</span><span class="main">)</span> <span class="free">y'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Lib-if_apply_cong"><span class="command">lemma</span></span> if_apply_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">=</span> <span class="free">P'</span><span class="main">;</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x'</span><span class="main">;</span> <span class="free">P'</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x'</span> <span class="main">=</span> <span class="free">f'</span> <span class="free">x'</span><span class="main">;</span> <span class="main">¬</span> <span class="free">P'</span> <span class="main">⟹</span> <span class="free">g</span> <span class="free">x'</span> <span class="main">=</span> <span class="free">g'</span> <span class="free">x'</span> <span class="main">⟧</span>
     <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="keyword1">else</span> <span class="free">g</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">P'</span> <span class="keyword1">then</span> <span class="free">f'</span> <span class="keyword1">else</span> <span class="free">g'</span><span class="main">)</span> <span class="free">x'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Lib-case_prod_apply_cong"><span class="command">lemma</span></span> case_prod_apply_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">f</span> <span class="main">(</span>fst <span class="free">p</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">p</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="free">f'</span> <span class="main">(</span>fst <span class="free">p'</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">p'</span><span class="main">)</span> <span class="free">s'</span> <span class="main">⟧</span> <span class="main">⟹</span> case_prod <span class="free">f</span> <span class="free">p</span> <span class="free">s</span> <span class="main">=</span> case_prod <span class="free">f'</span> <span class="free">p'</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">pred_conj</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">and</span>"</span> 35<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pred_conj</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">x</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">pred_disj</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">or</span>"</span> 30<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pred_disj</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">x</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">pred_neg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">not</span> _"</span> <span class="main">[</span>40<span class="main">]</span> 40<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pred_neg</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">zipWith</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'c</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">zipWith</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">≡</span> map <span class="main">(</span>case_prod <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">delete</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">delete</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">delete</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">delete</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">find</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> <span class="free">find</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">swp</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">y</span> <span class="bound">x</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="main">(</span>nonexhaustive<span class="main">)</span>
  <span class="entity">theRight</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">theRight</span> <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="main">(</span>nonexhaustive<span class="main">)</span>
  <span class="entity">theLeft</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">theLeft</span> <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">isLeft</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Inl <span class="bound">y</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">isRight</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Inr <span class="bound">y</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">const</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1" id="Lib-tranclD2"><span class="command">lemma</span></span> tranclD2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">∧</span> <span class="main">(</span><span class="bound">z</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> tranclE<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Lib-linorder_min_same1"><span class="command">lemma</span></span> linorder_min_same1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>min <span class="free">y</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> min_def linorder_not_less<span class="main">)</span>

<span class="keyword1" id="Lib-linorder_min_same2"><span class="command">lemma</span></span> linorder_min_same2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>min <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> min_def linorder_not_le<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A combinator for pairing up well-formed relations.
        The divisor function splits the population in halves,
        with the True half greater than the False half, and
        the supplied relations control the order within the halves.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">wf_sum</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_sum</span> <span class="free"><span class="bound"><span class="entity">divisor</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">≡</span>
     <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">divisor</span></span></span> <span class="bound">x</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">divisor</span></span></span> <span class="bound">y</span><span class="main">}</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span>
   <span class="main">∪</span>  <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">divisor</span></span></span> <span class="bound">x</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">divisor</span></span></span> <span class="bound">y</span><span class="main">}</span>
   <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">divisor</span></span></span> <span class="bound">x</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">divisor</span></span></span> <span class="bound">y</span><span class="main">}</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Lib-wf_sum_wf"><span class="command">lemma</span></span> wf_sum_wf<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> wf <span class="free">r</span><span class="main">;</span> wf <span class="free">r'</span> <span class="main">⟧</span> <span class="main">⟹</span> wf <span class="main">(</span>wf_sum <span class="free">divisor</span> <span class="free">r</span> <span class="free">r'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_sum_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Un<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_Int2<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_subset
             <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"measure <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> If <span class="main"><span class="main">(</span></span><span class="free"><span class="free">divisor</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">1</span></span> <span class="main"><span class="main">0</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_Int2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">abbreviation</span></span><span class="main">(</span>input<span class="main">)</span>
 <span class="quoted"><span class="quoted">"<span class="free">option_map</span> <span class="main">==</span> map_option"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> option_map_def <span class="main">=</span> map_option_case

<span class="keyword1" id="Lib-False_implies_equals"><span class="command">lemma</span></span> False_implies_equals <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>False <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="keyword1">PROP</span> <span class="free">Q</span><span class="main">)</span> <span class="main">≡</span> <span class="keyword1">PROP</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> equal_intr_rule<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> meta_mp<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Lib-split_paired_Ball"><span class="command">lemma</span></span> split_paired_Ball<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Lib-split_paired_Bex"><span class="command">lemma</span></span> split_paired_Bex<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="OptionMonad">
<div class="head">
<h1>Theory OptionMonad</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright 2014, NICTA
 *
 * This software may be distributed and modified according to the terms of
 * the BSD 2-Clause license. Note that NO WARRANTY is provided.
 * See "LICENSE_BSD2.txt" for details.
 *
 * @TAG(NICTA_BSD)
 *)</span>
<span class="comment1">(*
 * Contributions by:
 *   2012 Lars Noschinski &lt;noschinl@in.tum.de&gt;
 *     Option monad while loop formalisation.
 *)</span>

<span class="keyword1"><span class="command">theory</span></span> OptionMonad
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Lib">Lib</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> lookup <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Similar to map_option but the second function returns option as well›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">opt_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> lookup <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> lookup"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">|&gt;</span>"</span> 54<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">|&gt;</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">x</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">x</span>"</span></span>

<span class="keyword1" id="OptionMonad-opt_map_cong"><span class="command">lemma</span></span> opt_map_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f'</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">v</span> <span class="bound">s</span><span class="main">.</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">⟹</span> <span class="free">g</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">g'</span> <span class="bound">v</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">|&gt;</span> <span class="free">g</span> <span class="main">=</span> <span class="free">f'</span> <span class="main">|&gt;</span> <span class="free">g'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> opt_map_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="OptionMonad-in_opt_map_eq"><span class="command">lemma</span></span> in_opt_map_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="main">|&gt;</span> <span class="free">g</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v'</span><span class="main">.</span> <span class="free">f</span> <span class="free">s</span> <span class="main">=</span> Some <span class="bound">v'</span> <span class="main">∧</span> <span class="free">g</span> <span class="bound">v'</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> opt_map_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="OptionMonad-opt_mapE"><span class="command">lemma</span></span> opt_mapE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">f</span> <span class="main">|&gt;</span> <span class="free">g</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">v'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">f</span> <span class="free">s</span> <span class="main">=</span> Some <span class="bound">v'</span><span class="main">;</span> <span class="free">g</span> <span class="bound">v'</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_opt_map_eq<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">obind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> lookup <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> lookup<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> lookup"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">|&gt;&gt;</span>"</span> 53<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">|&gt;&gt;</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">x</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">x</span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ofail</span> <span class="main">=</span> K None"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">oreturn</span> <span class="main">=</span> K <span class="keyword1">o</span> Some"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">oassert</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1">then</span> oreturn <span class="main">()</span> <span class="keyword1">else</span> ofail"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If the result can be an exception.
  Corresponding bindE would be analogous to lifting in NonDetMonad.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">oreturnOk</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> K <span class="main">(</span>Some <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">othrow</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> K <span class="main">(</span>Some <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">oguard</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="bound">s</span> <span class="keyword1">then</span> Some <span class="main">()</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ocondition</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">s</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="bound">s</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">oskip</span> <span class="main">≡</span> oreturn <span class="main">()</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Monad laws›</span></span>
<span class="keyword1" id="OptionMonad-oreturn_bind"><span class="command">lemma</span></span> oreturn_bind <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>oreturn <span class="free">x</span> <span class="main">|&gt;&gt;</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> oreturn_def obind_def K_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

<span class="keyword1" id="OptionMonad-obind_return"><span class="command">lemma</span></span> obind_return <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="main">|&gt;&gt;</span> oreturn<span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> oreturn_def obind_def K_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
 
<span class="keyword1" id="OptionMonad-obind_assoc"><span class="command">lemma</span></span> obind_assoc<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="main">|&gt;&gt;</span> <span class="free">f</span><span class="main">)</span> <span class="main">|&gt;&gt;</span> <span class="free">g</span>  <span class="main">=</span>  <span class="free">m</span> <span class="main">|&gt;&gt;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">|&gt;&gt;</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> oreturn_def obind_def K_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Binding fail›</span></span>

<span class="keyword1" id="OptionMonad-obind_fail"><span class="command">lemma</span></span> obind_fail <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">|&gt;&gt;</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> ofail<span class="main">)</span> <span class="main">=</span> ofail"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ofail_def obind_def K_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="OptionMonad-ofail_bind"><span class="command">lemma</span></span> ofail_bind <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ofail <span class="main">|&gt;&gt;</span> <span class="free">m</span> <span class="main">=</span> ofail"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ofail_def obind_def K_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Function package setup›</span></span>
<span class="keyword1" id="OptionMonad-opt_bind_cong"><span class="command">lemma</span></span> opt_bind_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f'</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">v</span> <span class="bound">s</span><span class="main">.</span> <span class="free">f'</span> <span class="bound">s</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">⟹</span> <span class="free">g</span> <span class="bound">v</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">g'</span> <span class="bound">v</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">|&gt;&gt;</span> <span class="free">g</span> <span class="main">=</span> <span class="free">f'</span> <span class="main">|&gt;&gt;</span> <span class="free">g'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obind_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="OptionMonad-opt_bind_cong_apply"><span class="command">lemma</span></span> opt_bind_cong_apply <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">f</span> <span class="free">s</span> <span class="main">=</span> <span class="free">f'</span> <span class="free">s</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="free">f'</span> <span class="free">s</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">⟹</span> <span class="free">g</span> <span class="bound">v</span> <span class="free">s</span> <span class="main">=</span> <span class="free">g'</span> <span class="bound">v</span> <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="main">|&gt;&gt;</span> <span class="free">g</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">f'</span> <span class="main">|&gt;&gt;</span> <span class="free">g'</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obind_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="OptionMonad-oassert_bind_cong"><span class="command">lemma</span></span> oassert_bind_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">=</span> <span class="free">P'</span><span class="main">;</span> <span class="free">P'</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">=</span> <span class="free">m'</span> <span class="main">⟧</span> <span class="main">⟹</span> oassert <span class="free">P</span> <span class="main">|&gt;&gt;</span> <span class="free">m</span> <span class="main">=</span> oassert <span class="free">P'</span> <span class="main">|&gt;&gt;</span> <span class="free">m'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> oassert_def<span class="main">)</span>

<span class="keyword1" id="OptionMonad-oassert_bind_cong_apply"><span class="command">lemma</span></span> oassert_bind_cong_apply <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">=</span> <span class="free">P'</span><span class="main">;</span> <span class="free">P'</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">()</span> <span class="free">s</span> <span class="main">=</span> <span class="free">m'</span> <span class="main">()</span> <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>oassert <span class="free">P</span> <span class="main">|&gt;&gt;</span> <span class="free">m</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span>oassert <span class="free">P'</span> <span class="main">|&gt;&gt;</span> <span class="free">m'</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> oassert_def<span class="main">)</span>

<span class="keyword1" id="OptionMonad-oreturn_bind_cong"><span class="command">lemma</span></span> oreturn_bind_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x'</span><span class="main">;</span> <span class="free">m</span> <span class="free">x'</span> <span class="main">=</span> <span class="free">m'</span> <span class="free">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> oreturn <span class="free">x</span> <span class="main">|&gt;&gt;</span> <span class="free">m</span> <span class="main">=</span> oreturn <span class="free">x'</span> <span class="main">|&gt;&gt;</span> <span class="free">m'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="OptionMonad-oreturn_bind_cong_apply"><span class="command">lemma</span></span> oreturn_bind_cong_apply <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x'</span><span class="main">;</span> <span class="free">m</span> <span class="free">x'</span> <span class="free">s</span> <span class="main">=</span> <span class="free">m'</span> <span class="free">x'</span> <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>oreturn <span class="free">x</span> <span class="main">|&gt;&gt;</span> <span class="free">m</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span>oreturn <span class="free">x'</span> <span class="main">|&gt;&gt;</span> <span class="free">m'</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="OptionMonad-oreturn_bind_cong2"><span class="command">lemma</span></span> oreturn_bind_cong2 <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x'</span><span class="main">;</span> <span class="free">m</span> <span class="free">x'</span> <span class="main">=</span> <span class="free">m'</span> <span class="free">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>oreturn <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">|&gt;&gt;</span> <span class="free">m</span> <span class="main">=</span> <span class="main">(</span>oreturn <span class="main">$</span> <span class="free">x'</span><span class="main">)</span> <span class="main">|&gt;&gt;</span> <span class="free">m'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="OptionMonad-oreturn_bind_cong2_apply"><span class="command">lemma</span></span> oreturn_bind_cong2_apply <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x'</span><span class="main">;</span> <span class="free">m</span> <span class="free">x'</span> <span class="free">s</span> <span class="main">=</span> <span class="free">m'</span> <span class="free">x'</span> <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span>oreturn <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">|&gt;&gt;</span> <span class="free">m</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>oreturn <span class="main">$</span> <span class="free">x'</span><span class="main">)</span> <span class="main">|&gt;&gt;</span> <span class="free">m'</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="OptionMonad-ocondition_cong"><span class="command">lemma</span></span> ocondition_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">c</span> <span class="main">=</span> <span class="free">c'</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">c'</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">l</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">l'</span> <span class="bound">s</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span><span class="free">c'</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">r</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">r'</span> <span class="bound">s</span><span class="main">⟧</span>
  <span class="main">⟹</span> ocondition <span class="free">c</span> <span class="free">l</span> <span class="free">r</span> <span class="main">=</span> ocondition <span class="free">c'</span> <span class="free">l'</span> <span class="free">r'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ocondition_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Decomposition›</span></span>

<span class="keyword1" id="OptionMonad-ocondition_K_true"><span class="command">lemma</span></span> ocondition_K_true <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ocondition <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="free">T</span> <span class="free">F</span> <span class="main">=</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ocondition_def<span class="main">)</span>

<span class="keyword1" id="OptionMonad-ocondition_K_false"><span class="command">lemma</span></span> ocondition_K_false <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ocondition <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span> <span class="free">T</span> <span class="free">F</span> <span class="main">=</span> <span class="free">F</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ocondition_def<span class="main">)</span>

<span class="keyword1" id="OptionMonad-ocondition_False"><span class="command">lemma</span></span> ocondition_False<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> ocondition <span class="free">P</span> <span class="free">L</span> <span class="free">R</span> <span class="main">=</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ocondition_def<span class="main">)</span>

<span class="keyword1" id="OptionMonad-ocondition_True"><span class="command">lemma</span></span> ocondition_True<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> ocondition <span class="free">P</span> <span class="free">L</span> <span class="free">R</span> <span class="main">=</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ocondition_def<span class="main">)</span>

<span class="keyword1" id="OptionMonad-in_oreturn"><span class="command">lemma</span></span> in_oreturn <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>oreturn <span class="free">x</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">v</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> oreturn_def K_def<span class="main">)</span>

<span class="keyword1" id="OptionMonad-oreturnE"><span class="command">lemma</span></span> oreturnE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>oreturn <span class="free">x</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">;</span> <span class="free">v</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">x</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="OptionMonad-in_ofail"><span class="command">lemma</span></span> in_ofail <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ofail <span class="free">s</span> <span class="main">≠</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ofail_def K_def<span class="main">)</span>

<span class="keyword1" id="OptionMonad-ofailE"><span class="command">lemma</span></span> ofailE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ofail <span class="free">s</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="OptionMonad-in_oassert_eq"><span class="command">lemma</span></span> in_oassert_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>oassert <span class="free">P</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> oassert_def<span class="main">)</span>

<span class="keyword1" id="OptionMonad-oassertE"><span class="command">lemma</span></span> oassertE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> oassert <span class="free">P</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">;</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="OptionMonad-in_obind_eq"><span class="command">lemma</span></span> in_obind_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="main">|&gt;&gt;</span> <span class="free">g</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v'</span><span class="main">.</span> <span class="free">f</span> <span class="free">s</span> <span class="main">=</span> Some <span class="bound">v'</span> <span class="main">∧</span> <span class="free">g</span> <span class="bound">v'</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obind_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="OptionMonad-obindE"><span class="command">lemma</span></span> obindE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">f</span> <span class="main">|&gt;&gt;</span> <span class="free">g</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">;</span> 
     <span class="main">⋀</span><span class="bound">v'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">f</span> <span class="free">s</span> <span class="main">=</span> Some <span class="bound">v'</span><span class="main">;</span> <span class="free">g</span> <span class="bound">v'</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_obind_eq<span class="main">)</span>

<span class="keyword1" id="OptionMonad-in_othrow_eq"><span class="command">lemma</span></span> in_othrow_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>othrow <span class="free">e</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">v</span> <span class="main">=</span> Inl <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> othrow_def K_def<span class="main">)</span> 

<span class="keyword1" id="OptionMonad-othrowE"><span class="command">lemma</span></span> othrowE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>othrow <span class="free">e</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">;</span> <span class="free">v</span> <span class="main">=</span> Inl <span class="free">e</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Inl <span class="free">e</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="OptionMonad-in_oreturnOk_eq"><span class="command">lemma</span></span> in_oreturnOk_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>oreturnOk <span class="free">x</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">v</span> <span class="main">=</span> Inr <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> oreturnOk_def K_def<span class="main">)</span> 

<span class="keyword1" id="OptionMonad-oreturnOkE"><span class="command">lemma</span></span> oreturnOkE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>oreturnOk <span class="free">x</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">;</span> <span class="free">v</span> <span class="main">=</span> Inr <span class="free">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Inr <span class="free">x</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> omonadE <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span></span></span></span><span class="main">]</span> <span class="main">=</span>
  opt_mapE obindE oreturnE ofailE othrowE oreturnOkE oassertE

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹"While" loops over option monad.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This is an inductive definition of a while loop over the plain option monad
  (without passing through a state)
›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">option_while'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> option rel"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">C</span> <span class="entity">B</span>
<span class="keyword2"><span class="keyword">where</span></span>
    final<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">C</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟹</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">option_while'</span> <span class="free">C</span> <span class="free">B</span>"</span></span>
  <span class="main">|</span> fail<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">C</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span> <span class="free">B</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> None <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> None<span class="main">)</span> <span class="main">∈</span> <span class="free">option_while'</span> <span class="free">C</span> <span class="free">B</span>"</span></span>
  <span class="main">|</span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">C</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span>  <span class="free">B</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">;</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sr''</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">option_while'</span> <span class="free">C</span> <span class="free">B</span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sr''</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">option_while'</span> <span class="free">C</span> <span class="free">B</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">option_while</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> option_while' <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
      <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> option_while' <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1" id="OptionMonad-option_while'_inj"><span class="command">lemma</span></span> option_while'_inj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> option_while' <span class="free">C</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s''</span><span class="main">)</span> <span class="main">∈</span> option_while' <span class="free">C</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">=</span> <span class="free">s''</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> option_while'.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> option_while'.cases<span class="main">)</span>

<span class="keyword1" id="OptionMonad-option_while'_inj_step"><span class="command">lemma</span></span> option_while'_inj_step<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">C</span> <span class="free">s</span><span class="main">;</span> <span class="free">B</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">s'</span><span class="main">;</span> <span class="main">(</span>Some <span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> option_while' <span class="free">C</span> <span class="free">B</span> <span class="main">;</span> <span class="main">(</span>Some <span class="free">s'</span><span class="main">,</span> <span class="free">t'</span><span class="main">)</span> <span class="main">∈</span> option_while' <span class="free">C</span> <span class="free">B</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option_while'.step option_while'_inj<span class="main">)</span>

<span class="keyword1" id="OptionMonad-option_while'_THE"><span class="command">lemma</span></span> option_while'_THE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="free">r</span><span class="main">,</span> <span class="free">sr'</span><span class="main">)</span> <span class="main">∈</span> option_while' <span class="free">C</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span>Some <span class="free">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> option_while' <span class="free">C</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">sr'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> option_while'_inj<span class="main">)</span>

<span class="keyword1" id="OptionMonad-option_while_simps"><span class="command">lemma</span></span> option_while_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">C</span> <span class="free">s</span> <span class="main">⟹</span> option_while <span class="free">C</span> <span class="free">B</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">B</span> <span class="free">s</span> <span class="main">=</span> None <span class="main">⟹</span> option_while <span class="free">C</span> <span class="free">B</span> <span class="free">s</span> <span class="main">=</span> None"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">B</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">s'</span> <span class="main">⟹</span> option_while <span class="free">C</span> <span class="free">B</span> <span class="free">s</span> <span class="main">=</span> option_while <span class="free">C</span> <span class="free">B</span> <span class="free">s'</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="free">s</span><span class="main">,</span> <span class="free">ss'</span><span class="main">)</span> <span class="main">∈</span> option_while' <span class="free">C</span> <span class="free">B</span> <span class="main">⟹</span> option_while <span class="free">C</span> <span class="free">B</span> <span class="free">s</span> <span class="main">=</span> <span class="free">ss'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> option_while'_inj_step<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">s'</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option_while_def option_while'_THE
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> option_while'.intros
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> option_while'_inj
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> option_while'.cases<span class="main">)</span>

<span class="keyword1" id="OptionMonad-option_while_rule"><span class="command">lemma</span></span> option_while_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"option_while <span class="free">C</span> <span class="free">B</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> istep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">C</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">B</span> <span class="bound">s</span> <span class="main">=</span> Some <span class="bound">s'</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s'</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">C</span> <span class="free">s'</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ss</span> <span class="skolem">ss'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ss</span><span class="main">,</span> <span class="skolem">ss'</span><span class="main">)</span> <span class="main">∈</span> option_while' <span class="free">C</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> Some <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss'</span> <span class="main">=</span> Some <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="free">s</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> istep<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option_while_def option_while'_THE <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="OptionMonad-option_while'_term"><span class="command">lemma</span></span> option_while'_term<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> step_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">I</span> <span class="bound">r</span><span class="main">;</span> <span class="free">C</span> <span class="bound">r</span><span class="main">;</span> <span class="free">B</span> <span class="bound">r</span> <span class="main">=</span> Some <span class="bound">r'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">r'</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> step_I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">I</span> <span class="bound">r</span><span class="main">;</span> <span class="free">C</span> <span class="bound">r</span><span class="main">;</span> <span class="free">B</span> <span class="bound">r</span> <span class="main">=</span> Some <span class="bound">r'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">r'</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">sr'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="free">r</span><span class="main">,</span> <span class="free">sr'</span><span class="main">)</span> <span class="main">∈</span> option_while' <span class="free">C</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="skolem">r</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bool.exhaust<span class="main"><span class="main">[</span></span><span class="operator">case_product</span> option.exhaust<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>True_Some <span class="skolem">r'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r'</span><span class="main">,</span><span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="skolem">r'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> less step_less step_I<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sr'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="skolem">r'</span><span class="main">,</span> <span class="skolem">sr'</span><span class="main">)</span> <span class="main">∈</span> option_while' <span class="free">C</span> <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">rule</span> less<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="skolem">r</span><span class="main">,</span> <span class="skolem">sr'</span><span class="main">)</span> <span class="main">∈</span> option_while' <span class="free">C</span> <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True_Some <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> option_while'.intros<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> option_while'.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="OptionMonad-option_while_rule'"><span class="command">lemma</span></span> option_while_rule'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"option_while <span class="free">C</span> <span class="free">B</span> <span class="free">s</span> <span class="main">=</span> <span class="free">ss'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">(</span>Some <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">C</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">(</span>Some <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">B</span> <span class="bound">s</span> <span class="main">=</span> Some <span class="bound">s'</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">C</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">(</span>Some <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">B</span> <span class="bound">s</span> <span class="main">=</span> Some <span class="bound">s'</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">(</span>Some <span class="bound">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> final<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">C</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">(</span>Some <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">B</span> <span class="bound">s</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="free">I</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">ss'</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">ss'</span> <span class="keyword1">of</span> Some <span class="bound">s'</span> <span class="main">⇒</span> <span class="main">¬</span> <span class="free">C</span> <span class="bound">s'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> Some <span class="free">s</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ss1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="free">s</span><span class="main">,</span> <span class="skolem">ss1'</span><span class="main">)</span> <span class="main">∈</span> option_while' <span class="free">C</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>2<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> option_while'_term<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ss</span><span class="main">,</span> <span class="free">ss'</span><span class="main">)</span> <span class="main">∈</span> option_while' <span class="free">C</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹option_while <span class="free">C</span> <span class="free">B</span> <span class="free">s</span> <span class="main">=</span> <span class="free">ss'</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option_while_simps ss_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ss'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">s'</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> * ss_def <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> step<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> None <span class="keyword1"><span class="command">with</span></span> * ss_def <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> step final<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Lift <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">option_while</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="tfree"><span class="tfree">'a</span></span><span class="main"><span class="main">,</span></span><span class="tfree"><span class="tfree">'s</span></span><span class="main"><span class="main">)</span></span> lookup"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> monad›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">owhile</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> lookup<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> lookup"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">owhile</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> option_while <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1" id="OptionMonad-owhile_unroll"><span class="command">lemma</span></span> owhile_unroll<span class="main">:</span>
  <span class="quoted"><span class="quoted">"owhile <span class="free">C</span> <span class="free">B</span> <span class="free">r</span> <span class="main">=</span> ocondition <span class="main">(</span><span class="free">C</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="free">r</span> <span class="main">|&gt;&gt;</span> owhile <span class="free">C</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span>oreturn <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ocondition_def obind_def oreturn_def owhile_def
           option_while_simps K_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹rule for terminating loops›</span></span>

<span class="keyword1" id="OptionMonad-owhile_rule"><span class="command">lemma</span></span> owhile_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">r</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">I</span> <span class="bound">r</span> <span class="free">s</span><span class="main">;</span> <span class="free">C</span> <span class="bound">r</span> <span class="free">s</span><span class="main">;</span> <span class="free">B</span> <span class="bound">r</span> <span class="free">s</span> <span class="main">=</span> Some <span class="bound">r'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">r'</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">I</span> <span class="bound">r</span> <span class="free">s</span><span class="main">;</span> <span class="free">C</span> <span class="bound">r</span> <span class="free">s</span><span class="main">;</span> <span class="free">B</span> <span class="bound">r</span> <span class="free">s</span> <span class="main">=</span> Some <span class="bound">r'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">r'</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fail<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">I</span> <span class="bound">r</span> <span class="free">s</span><span class="main">;</span> <span class="free">C</span> <span class="bound">r</span> <span class="free">s</span><span class="main">;</span> <span class="free">B</span> <span class="bound">r</span> <span class="free">s</span> <span class="main">=</span> None<span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> None"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> final<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="main">⟦</span><span class="free">I</span> <span class="bound">r</span> <span class="free">s</span><span class="main">;</span> <span class="main">¬</span><span class="free">C</span> <span class="bound">r</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">(</span>Some <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">(</span>owhile <span class="free">C</span> <span class="free">B</span> <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rs'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"owhile <span class="free">C</span> <span class="free">B</span> <span class="free">r</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="var">?rs'</span> <span class="keyword1">of</span> Some <span class="bound">r</span> <span class="main">⇒</span> <span class="free">I</span> <span class="bound">r</span> <span class="free">s</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free">Q</span> None<span class="main">)</span>
      <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="var">?rs'</span> <span class="keyword1">of</span> Some <span class="bound">r'</span> <span class="main">⇒</span> <span class="main">¬</span> <span class="free">C</span> <span class="bound">r'</span> <span class="free">s</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> option_while_rule'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">r</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="free"><span class="free"><span class="free">B</span></span></span> <span class="bound"><span class="bound"><span class="bound">r</span></span></span> <span class="free"><span class="free"><span class="free">s</span></span></span>"</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> s<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">r</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹wf <span class="main">_</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> owhile_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> final <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="NonDetMonad">
<div class="head">
<h1>Theory NonDetMonad</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright 2014, NICTA
 *
 * This software may be distributed and modified according to the terms of
 * the BSD 2-Clause license. Note that NO WARRANTY is provided.
 * See "LICENSE_BSD2.txt" for details.
 *
 * @TAG(NICTA_BSD)
 *)</span>

<span class="comment1">(* 
   Nondeterministic state and error monads with failure in Isabelle.
*)</span>

<span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">"Nondeterministic State Monad with Failure"</span></span>

<span class="keyword1"><span class="command">theory</span></span> NonDetMonad
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="#Lib">../Lib</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  \label{c:monads}

  State monads are used extensively in the seL4 specification. They are
  defined below.
›</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"The Monad"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The basic type of the nondeterministic state monad with failure is
  very similar to the normal state monad. Instead of a pair consisting
  of result and new state, we return a set of these pairs coupled with
  a failure flag. Each element in the set is a potential result of the
  computation. The flag is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> True<span class="antiquote"><span class="antiquote">}</span></span></span></span> if there is an execution path
  in the computation that may have failed. Conversely, if the flag is
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> False<span class="antiquote"><span class="antiquote">}</span></span></span></span>, none of the computations resulting in the returned
  set can have failed.›</span></span> 
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> nondet_monad <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> set <span class="main">×</span> bool"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The definition of fundamental monad functions <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>return›</span></span></span></span> and
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>bind›</span></span></span></span>. The monad function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>return x›</span></span></span></span> does not change 
  the  state, does not fail, and returns <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span>.
›</span></span> 
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">return</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> nondet_monad"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">return</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">}</span><span class="main">,</span>False<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The monad function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>bind f g›</span></span></span></span>, also written <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f &gt;&gt;= g›</span></span></span></span>,
  is the execution of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> followed by the execution of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>g›</span></span></span></span>.
  The function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>g›</span></span></span></span> takes the result value \emph{and} the result
  state of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span> as parameter. The definition says that the result of
  the combined operation is the union of the set of sets that is created
  by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>g›</span></span></span></span> applied to the result sets of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span>. The combined
  operation may have failed, if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span> may have failed or <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>g›</span></span></span></span> may
  have failed on any of the results of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">bind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> nondet_monad <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> nondet_monad<span class="main">)</span> <span class="main">⇒</span> 
           <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> nondet_monad"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">&gt;&gt;=</span>"</span> 60<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bind</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>fst <span class="main">`</span> case_prod <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">`</span> fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
                   True <span class="main">∈</span> snd <span class="main">`</span> case_prod <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">`</span> fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span><span class="main">)</span> <span class="main">∨</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Sometimes it is convenient to write <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>bind›</span></span></span></span> in reverse order.
›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span><span class="main">(</span>input<span class="main">)</span>
  <span class="entity">bind_rev</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> nondet_monad<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> nondet_monad <span class="main">⇒</span> 
               <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> nondet_monad"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">=&lt;&lt;</span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main"><span class="free">=&lt;&lt;</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">&gt;&gt;=</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The basic accessor functions of the state monad. <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>get›</span></span></span></span> returns
  the current state as result, does not fail, and does not change the state.
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>put s›</span></span></span></span> returns nothing (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">unit</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>), changes the current state
  to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s›</span></span></span></span> and does not fail.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">get</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'s</span><span class="main">)</span> nondet_monad"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">get</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">}</span><span class="main">,</span> False<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">put</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> unit<span class="main">)</span> nondet_monad"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">put</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="main">()</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">}</span><span class="main">,</span> False<span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Nondeterminism"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Basic nondeterministic functions. <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>select A›</span></span></span></span> chooses an element 
  of the set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span>, does not change the state, and does not fail
  (even if the set is empty). <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f ⊓ g›</span></span></span></span> executes <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span> or
  executes <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>g›</span></span></span></span>. It retuns the union of results of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span> and
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>g›</span></span></span></span>, and may have failed if either may have failed.  
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">select</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> nondet_monad"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">select</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">×</span> <span class="main">{</span><span class="bound">s</span><span class="main">}</span><span class="main">,</span> False<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">alternative</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> nondet_monad <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> nondet_monad <span class="main">⇒</span> 
                  <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> nondet_monad"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊓</span>"</span> 20<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">⊓</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span>fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span><span class="main">)</span> <span class="main">∪</span> fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">,</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span><span class="main">)</span> <span class="main">∨</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A variant of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>select›</span></span></span></span> that takes a pair. The first component
  is a set as in normal <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>select›</span></span></span></span>, the second component indicates
  whether the execution failed. This is useful to lift monads between
  different state spaces.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">select_f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">×</span> bool  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> nondet_monad"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">select_f</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">×</span> <span class="main">{</span><span class="bound">s</span><span class="main">}</span><span class="main">,</span> snd <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>select_state›</span></span></span></span> takes a relationship between
  states, and outputs nondeterministically a state
  related to the input state.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">state_select</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> unit<span class="main">)</span> nondet_monad"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">state_select</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">}</span><span class="main">,</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Failure"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The monad function that always fails. Returns an empty set of
results and sets the failure flag.›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">fail</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> nondet_monad"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">fail</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span> True<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Assertions: fail if the property <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span> is not true›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">assert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> unit<span class="main">)</span> nondet_monad"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">assert</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1">then</span> return <span class="main">()</span> <span class="keyword1">else</span> fail"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Fail if the value is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> None<span class="antiquote"><span class="antiquote">}</span></span></span></span>, 
  return result <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Some <span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">assert_opt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> nondet_monad"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">assert_opt</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> fail <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> return <span class="bound">v</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An assertion that also can introspect the current state.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">state_assert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> unit<span class="main">)</span> nondet_monad"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">state_assert</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> get <span class="main">&gt;&gt;=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> assert <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Generic functions on top of the state monad"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Apply a function to the current state and return the result
without changing the state.›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">gets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> nondet_monad"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">gets</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> get <span class="main">&gt;&gt;=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Modify the current state using the function passed in.›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">modify</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> unit<span class="main">)</span> nondet_monad"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">modify</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> get <span class="main">&gt;&gt;=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> put <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="NonDetMonad-simpler_gets_def"><span class="command">lemma</span></span> simpler_gets_def<span class="main">:</span> <span class="quoted"><span class="quoted">"gets <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span><span class="main">,</span> False<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gets_def return_def bind_def get_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="NonDetMonad-simpler_modify_def"><span class="command">lemma</span></span> simpler_modify_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"modify <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span><span class="main">,</span> False<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> modify_def bind_def get_def put_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Execute the given monad when the condition is true, 
  return <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>()›</span></span></span></span> otherwise.›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted">"<span class="entity">when</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> unit<span class="main">)</span> nondet_monad <span class="main">⇒</span> 
           <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> unit<span class="main">)</span> nondet_monad"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">when</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">else</span> return <span class="main">()</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Execute the given monad unless the condition is true, 
  return <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>()›</span></span></span></span> otherwise.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">unless</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> unit<span class="main">)</span> nondet_monad <span class="main">⇒</span> 
            <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> unit<span class="main">)</span> nondet_monad"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">unless</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> when <span class="main">(</span><span class="main">¬</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Perform a test on the current state, performing the left monad if
  the result is true or the right monad if the result is false.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">condition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'r</span><span class="main">)</span> nondet_monad <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'r</span><span class="main">)</span> nondet_monad <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'r</span><span class="main">)</span> nondet_monad"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">condition</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="bound">s</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span>
  condition  <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">condition</span> <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">//</span>  <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">//</span>  <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">)</span>"</span> <span class="main">[</span>1000<span class="main">,</span>1000<span class="main">,</span>1000<span class="main">]</span> 1000<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Apply an option valued function to the current state, fail 
if it returns <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> None<span class="antiquote"><span class="antiquote">}</span></span></span></span>, return <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> if it returns 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Some <span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.  
›</span></span> 
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">gets_the</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> nondet_monad"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">gets_the</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> gets <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">&gt;&gt;=</span> assert_opt"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Monad Laws›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A more expanded definition of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>bind›</span></span></span></span>›</span></span>
<span class="keyword1" id="NonDetMonad-bind_def'"><span class="command">lemma</span></span> bind_def'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">&gt;&gt;=</span> <span class="free">g</span><span class="main">)</span> <span class="main">≡</span>
       <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">r''</span><span class="main">,</span> <span class="bound">s''</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="main">(</span><span class="bound">r'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">r''</span><span class="main">,</span> <span class="bound">s''</span><span class="main">)</span> <span class="main">∈</span> fst <span class="main">(</span><span class="free">g</span> <span class="bound">r'</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">}</span><span class="main">,</span>
                     snd <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">r'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">g</span> <span class="bound">r'</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eq_reflection<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_def split_def Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Each monad satisfies at least the following three laws.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">return</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is absorbed at the left of a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">bind</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, 
  applying the return value directly:›</span></span> 
<span class="keyword1" id="NonDetMonad-return_bind"><span class="command">lemma</span></span> return_bind <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>return <span class="free">x</span> <span class="main">&gt;&gt;=</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> return_def bind_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">return</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is absorbed on the right of a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">bind</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span> 
<span class="keyword1" id="NonDetMonad-bind_return"><span class="command">lemma</span></span> bind_return <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="main">&gt;&gt;=</span> return<span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_def return_def split_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
 
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">bind</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is associative›</span></span>
<span class="keyword1" id="NonDetMonad-bind_assoc"><span class="command">lemma</span></span> bind_assoc<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> nondet_monad"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> nondet_monad"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> nondet_monad"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="main">&gt;&gt;=</span> <span class="free">f</span><span class="main">)</span> <span class="main">&gt;&gt;=</span> <span class="free">g</span>  <span class="main">=</span>  <span class="free">m</span> <span class="main">&gt;&gt;=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">&gt;&gt;=</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> bind_def Let_def split_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_image_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Adding Exceptions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="tfree"><span class="tfree">'s</span></span><span class="main"><span class="main">,</span></span><span class="tfree"><span class="tfree">'a</span></span><span class="main"><span class="main">)</span></span> nondet_monad"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> gives us nondeterminism and
  failure. We now extend this monad with exceptional return values
  that abort normal execution, but can be handled explicitly.
  We use the sum type to indicate exceptions. 

  In <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="tfree"><span class="tfree">'s</span></span><span class="main"><span class="main">,</span></span> <span class="tfree"><span class="tfree">'e</span></span> <span class="main"><span class="main">+</span></span> <span class="tfree"><span class="tfree">'a</span></span><span class="main"><span class="main">)</span></span> nondet_monad"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the state,
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'e</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is an exception, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a normal return value.

  This new type itself forms a monad again. Since type classes in 
  Isabelle are not powerful enough to express the class of monads,
  we provide new names for the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">return</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">bind</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> functions
  in this monad. We call them <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>returnOk›</span></span></span></span> (for normal return values)
  and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>bindE›</span></span></span></span> (for composition). We also define <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>throwError›</span></span></span></span>
  to return an exceptional value.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">returnOk</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'a</span><span class="main">)</span> nondet_monad"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">returnOk</span> <span class="main">≡</span> return <span class="keyword1">o</span> Inr"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">throwError</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'e</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'a</span><span class="main">)</span> nondet_monad"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">throwError</span> <span class="main">≡</span> return <span class="keyword1">o</span> Inl"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Lifting a function over the exception type: if the input is an
  exception, return that exception; otherwise continue execution.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">lift</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">)</span> nondet_monad<span class="main">)</span> <span class="main">⇒</span> 
           <span class="tfree">'e</span> <span class="main">+</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">)</span> nondet_monad"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">of</span> Inl <span class="bound">e</span> <span class="main">⇒</span> throwError <span class="bound">e</span>
                      <span class="main">|</span> Inr <span class="bound">v'</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">v'</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The definition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">bind</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in the exception monad (new
  name <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>bindE›</span></span></span></span>): the same as normal <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">bind</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, but 
  the right-hand side is skipped if the left-hand side
  produced an exception.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">bindE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'a</span><span class="main">)</span> nondet_monad <span class="main">⇒</span> 
            <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">)</span> nondet_monad<span class="main">)</span> <span class="main">⇒</span> 
            <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">)</span> nondet_monad"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">&gt;&gt;=E</span>"</span> 60<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bindE</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> bind <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>lift <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Lifting a normal nondeterministic monad into the 
  exception monad is achieved by always returning its
  result as normal result and never throwing an exception.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">liftE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> nondet_monad <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">+</span><span class="tfree">'a</span><span class="main">)</span> nondet_monad"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">liftE</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">&gt;&gt;=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> return <span class="main">(</span>Inr <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Since the underlying type and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>return›</span></span></span></span> function changed, 
  we need new definitions for when and unless:
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">whenE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e</span> <span class="main">+</span> unit<span class="main">)</span> nondet_monad <span class="main">⇒</span> 
            <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e</span> <span class="main">+</span> unit<span class="main">)</span> nondet_monad"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">whenE</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">else</span> returnOk <span class="main">()</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">unlessE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e</span> <span class="main">+</span> unit<span class="main">)</span> nondet_monad <span class="main">⇒</span> 
            <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e</span> <span class="main">+</span> unit<span class="main">)</span> nondet_monad"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">unlessE</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1">then</span> returnOk <span class="main">()</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Throwing an exception when the parameter is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">None</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, otherwise
  returning <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Some <span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">throw_opt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'e</span> <span class="main">⇒</span> <span class="tfree">'a</span> option <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'a</span><span class="main">)</span> nondet_monad"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">throw_opt</span> <span class="free"><span class="bound"><span class="entity">ex</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> 
  <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> throwError <span class="free"><span class="bound"><span class="entity">ex</span></span></span> <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> returnOk <span class="bound">v</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Failure in the exception monad is redefined in the same way
  as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> whenE<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> unlessE<span class="antiquote"><span class="antiquote">}</span></span></span></span>, with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">returnOk</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  instead of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">return</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span> 
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">assertE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'e</span> <span class="main">+</span> unit<span class="main">)</span> nondet_monad"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">assertE</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1">then</span> returnOk <span class="main">()</span> <span class="keyword1">else</span> fail"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Monad Laws for the Exception Monad"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹More direct definition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> liftE<span class="antiquote"><span class="antiquote">}</span></span></span></span>:›</span></span>
<span class="keyword1" id="NonDetMonad-liftE_def2"><span class="command">lemma</span></span> liftE_def2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"liftE <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>Inr <span class="bound">v</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">,</span> snd <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> liftE_def return_def split_def bind_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Left <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> returnOk<span class="antiquote"><span class="antiquote">}</span></span></span></span> absorbtion over <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">bindE</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:›</span></span>
<span class="keyword1" id="NonDetMonad-returnOk_bindE"><span class="command">lemma</span></span> returnOk_bindE <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>returnOk <span class="free">x</span> <span class="keyword1">&gt;&gt;=E</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> bindE_def return_def returnOk_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="NonDetMonad-lift_return"><span class="command">lemma</span></span> lift_return <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lift <span class="main">(</span>return <span class="main">∘</span> Inr<span class="main">)</span> <span class="main">=</span> return"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
     <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lift_def throwError_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Right <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> returnOk<span class="antiquote"><span class="antiquote">}</span></span></span></span> absorbtion over <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">bindE</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:›</span></span>
<span class="keyword1" id="NonDetMonad-bindE_returnOk"><span class="command">lemma</span></span> bindE_returnOk <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="keyword1">&gt;&gt;=E</span> returnOk<span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bindE_def returnOk_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Associativity of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> bindE<span class="antiquote"><span class="antiquote">}</span></span></span></span>:›</span></span>
<span class="keyword1" id="NonDetMonad-bindE_assoc"><span class="command">lemma</span></span> bindE_assoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="keyword1">&gt;&gt;=E</span> <span class="free">f</span><span class="main">)</span> <span class="keyword1">&gt;&gt;=E</span> <span class="free">g</span> <span class="main">=</span> <span class="free">m</span> <span class="keyword1">&gt;&gt;=E</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">&gt;&gt;=E</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bindE_def bind_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">m</span></span> <span class="main"><span class="main">&gt;&gt;=</span></span> <span class="bound"><span class="bound">x</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lift_def throwError_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> returnOk<span class="antiquote"><span class="antiquote">}</span></span></span></span> could also be defined via <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> liftE<span class="antiquote"><span class="antiquote">}</span></span></span></span>:›</span></span>
<span class="keyword1" id="NonDetMonad-returnOk_liftE"><span class="command">lemma</span></span> returnOk_liftE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"returnOk <span class="free">x</span> <span class="main">=</span> liftE <span class="main">(</span>return <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> liftE_def returnOk_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Execution after throwing an exception is skipped:›</span></span>
<span class="keyword1" id="NonDetMonad-throwError_bindE"><span class="command">lemma</span></span> throwError_bindE <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>throwError <span class="free">E</span> <span class="keyword1">&gt;&gt;=E</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> throwError <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bindE_def bind_def throwError_def lift_def return_def<span class="main">)</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Syntax"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This section defines traditional Haskell-like do-syntax 
  for the state monad in Isabelle.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Syntax for the Nondeterministic State Monad"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We use <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>K_bind›</span></span></span></span> to syntactically indicate the 
  case where the return argument of the left side of a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">bind</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  is ignored›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  K_bind_def <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">K_bind</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span>"</span></span>

<span class="keyword1"><span class="command">nonterminal</span></span>
  dobinds <span class="keyword2"><span class="keyword">and</span></span> dobind <span class="keyword2"><span class="keyword">and</span></span> nobind

<span class="keyword1"><span class="command">syntax</span></span> <span class="main">(</span>ASCII<span class="main">)</span>
  <span class="quoted">"_dobind"</span>    <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>pttrn<span class="main">,</span> <span class="tfree">'a</span><span class="main">]</span> <span class="main">=&gt;</span> dobind"</span></span>             <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_ <span class="keyword1">&lt;-</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> 10<span class="main">)</span>
<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_dobind"</span>    <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>pttrn<span class="main">,</span> <span class="tfree">'a</span><span class="main">]</span> <span class="main">=&gt;</span> dobind"</span></span>             <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_ <span class="keyword1">←</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> 10<span class="main">)</span>
  <span class="quoted">""</span>           <span class="main">::</span> <span class="quoted"><span class="quoted">"dobind <span class="main">=&gt;</span> dobinds"</span></span>                 <span class="main">(</span><span class="quoted">"_"</span><span class="main">)</span>
  <span class="quoted">"_nobind"</span>    <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">=&gt;</span> dobind"</span></span>                      <span class="main">(</span><span class="quoted">"_"</span><span class="main">)</span>
  <span class="quoted">"_dobinds"</span>   <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>dobind<span class="main">,</span> dobinds<span class="main">]</span> <span class="main">=&gt;</span> dobinds"</span></span>      <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">;</span><span class="keyword3">//</span><span class="keyword3">(</span>_<span class="keyword3">)</span>"</span><span class="main">)</span>

  <span class="quoted">"_do"</span>        <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>dobinds<span class="main">,</span> <span class="tfree">'a</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="tfree">'a</span>"</span></span>               <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">do</span> <span class="keyword3">(</span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">;</span><span class="keyword3">//</span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">)</span><span class="keyword3">//</span><span class="keyword1">od</span><span class="keyword3">)</span>"</span> 100<span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"_do <span class="main">(</span>_dobinds <span class="free">b</span> <span class="free">bs</span><span class="main">)</span> <span class="free">e</span>"</span>  <span class="main">==</span> <span class="quoted">"_do <span class="free">b</span> <span class="main">(</span>_do <span class="free">bs</span> <span class="free">e</span><span class="main">)</span>"</span>
  <span class="quoted">"_do <span class="main">(</span>_nobind <span class="free">b</span><span class="main">)</span> <span class="free">e</span>"</span>      <span class="main">==</span> <span class="quoted">"<span class="free">b</span> <span class="main">&gt;&gt;=</span> <span class="main">(</span><span class="keyword1">CONST</span> K_bind <span class="free">e</span><span class="main">)</span>"</span>
  <span class="quoted">"<span class="keyword1">do</span> <span class="free">x</span> <span class="main">&lt;-</span> <span class="free">a</span><span class="main">;</span> <span class="free">e</span> <span class="keyword1">od</span>"</span>        <span class="main">==</span> <span class="quoted">"<span class="free">a</span> <span class="main">&gt;&gt;=</span> <span class="main">(</span><span class="main">λ</span><span class="free">x</span><span class="main">.</span> <span class="free">e</span><span class="main">)</span>"</span>  

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Syntax examples:›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="bound">x</span> <span class="main">←</span> return <span class="main">1</span><span class="main">;</span> 
          return <span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span><span class="main">;</span> 
          return <span class="bound">x</span> 
       <span class="keyword1">od</span> <span class="main">=</span> 
       return <span class="main">1</span> <span class="main">&gt;&gt;=</span> 
       <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> return <span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">&gt;&gt;=</span> 
            K_bind <span class="main">(</span>return <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="bound">x</span> <span class="main">←</span> return <span class="main">1</span><span class="main">;</span> 
          return <span class="numeral">2</span><span class="main">;</span> 
          return <span class="bound">x</span> 
       <span class="keyword1">od</span> <span class="main">=</span> return <span class="main">1</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Syntax for the Exception Monad"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Since the exception monad is a different type, we
  need to syntactically distinguish it in the syntax.
  We use <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>doE›</span></span></span></span>/<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>odE›</span></span></span></span> for this, but can re-use
  most of the productions from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>do›</span></span></span></span>/<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>od›</span></span></span></span>
  above.
›</span></span>

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_doE"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>dobinds<span class="main">,</span> <span class="tfree">'a</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="tfree">'a</span>"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">doE</span> <span class="keyword3">(</span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">;</span><span class="keyword3">//</span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">)</span><span class="keyword3">//</span><span class="keyword1">odE</span><span class="keyword3">)</span>"</span> 100<span class="main">)</span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"_doE <span class="main">(</span>_dobinds <span class="free">b</span> <span class="free">bs</span><span class="main">)</span> <span class="free">e</span>"</span>  <span class="main">==</span> <span class="quoted">"_doE <span class="free">b</span> <span class="main">(</span>_doE <span class="free">bs</span> <span class="free">e</span><span class="main">)</span>"</span>
  <span class="quoted">"_doE <span class="main">(</span>_nobind <span class="free">b</span><span class="main">)</span> <span class="free">e</span>"</span>      <span class="main">==</span> <span class="quoted">"<span class="free">b</span> <span class="keyword1">&gt;&gt;=E</span> <span class="main">(</span><span class="keyword1">CONST</span> K_bind <span class="free">e</span><span class="main">)</span>"</span>
  <span class="quoted">"<span class="keyword1">doE</span> <span class="free">x</span> <span class="main">&lt;-</span> <span class="free">a</span><span class="main">;</span> <span class="free">e</span> <span class="keyword1">odE</span>"</span>       <span class="main">==</span> <span class="quoted">"<span class="free">a</span> <span class="keyword1">&gt;&gt;=E</span> <span class="main">(</span><span class="main">λ</span><span class="free">x</span><span class="main">.</span> <span class="free">e</span><span class="main">)</span>"</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Syntax examples:›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">doE</span> <span class="bound">x</span> <span class="main">←</span> returnOk <span class="main">1</span><span class="main">;</span> 
           returnOk <span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span><span class="main">;</span> 
           returnOk <span class="bound">x</span> 
       <span class="keyword1">odE</span> <span class="main">=</span>
       returnOk <span class="main">1</span> <span class="keyword1">&gt;&gt;=E</span> 
       <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> returnOk <span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span> <span class="keyword1">&gt;&gt;=E</span> 
            K_bind <span class="main">(</span>returnOk <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">doE</span> <span class="bound">x</span> <span class="main">←</span> returnOk <span class="main">1</span><span class="main">;</span> 
           returnOk <span class="numeral">2</span><span class="main">;</span> 
           returnOk <span class="bound">x</span> 
       <span class="keyword1">odE</span> <span class="main">=</span> returnOk <span class="main">1</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>



<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Library of Monadic Functions and Combinators"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lifting a normal function into the monad type:›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">liftM</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> nondet_monad <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> nondet_monad"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">liftM</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="bound">x</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">;</span> return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">od</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The same for the exception monad:›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">liftME</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'e</span><span class="main">+</span><span class="tfree">'a</span><span class="main">)</span> nondet_monad <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'e</span><span class="main">+</span><span class="tfree">'b</span><span class="main">)</span> nondet_monad"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">liftME</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="keyword1">doE</span> <span class="bound">x</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">;</span> returnOk <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">odE</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Run a sequence of monads from left to right, ignoring return values.›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">sequence_x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> nondet_monad list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> unit<span class="main">)</span> nondet_monad"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sequence_x</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> foldr <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&gt;&gt;=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span>return <span class="main">()</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Map a monadic function over a list by applying it to each element
  of the list from left to right, ignoring return values.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">mapM_x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> nondet_monad<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> unit<span class="main">)</span> nondet_monad"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mapM_x</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> sequence_x <span class="main">(</span>map <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Map a monadic function with two parameters over two lists,
  going through both lists simultaneously, left to right, ignoring
  return values.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">zipWithM_x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> nondet_monad<span class="main">)</span> <span class="main">⇒</span> 
                 <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> unit<span class="main">)</span> nondet_monad"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">zipWithM_x</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">≡</span> sequence_x <span class="main">(</span>zipWith <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The same three functions as above, but returning a list of
return values instead of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>unit›</span></span></span></span>›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">sequence</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> nondet_monad list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span> list<span class="main">)</span> nondet_monad"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sequence</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="bound">mcons</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&gt;&gt;=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">q</span> <span class="main">&gt;&gt;=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> return <span class="main">(</span><span class="bound">x</span><span class="main">#</span><span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                 <span class="keyword1">in</span> foldr <span class="bound">mcons</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span>return <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">mapM</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> nondet_monad<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'b</span> list<span class="main">)</span> nondet_monad"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mapM</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> sequence <span class="main">(</span>map <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">zipWithM</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> nondet_monad<span class="main">)</span> <span class="main">⇒</span> 
                 <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'c</span> list<span class="main">)</span> nondet_monad"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">zipWithM</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">≡</span> sequence <span class="main">(</span>zipWith <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">foldM</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> nondet_monad<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> nondet_monad"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">foldM</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> foldr <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">&gt;&gt;=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span>return <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> "</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The sequence and map functions above for the exception monad,
with and without lists of return value›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">sequenceE_x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">+</span><span class="tfree">'a</span><span class="main">)</span> nondet_monad list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">+</span>unit<span class="main">)</span> nondet_monad"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sequenceE_x</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> foldr <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="keyword1">doE</span> <span class="main"><span class="bound">_</span></span> <span class="main">&lt;-</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">y</span> <span class="keyword1">odE</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span>returnOk <span class="main">()</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">mapME_x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'e</span><span class="main">+</span><span class="tfree">'b</span><span class="main">)</span> nondet_monad<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> 
              <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'e</span><span class="main">+</span>unit<span class="main">)</span> nondet_monad"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mapME_x</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> sequenceE_x <span class="main">(</span>map <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">sequenceE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">+</span><span class="tfree">'a</span><span class="main">)</span> nondet_monad list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">+</span><span class="tfree">'a</span> list<span class="main">)</span> nondet_monad"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sequenceE</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="bound">mcons</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">p</span> <span class="keyword1">&gt;&gt;=E</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">q</span> <span class="keyword1">&gt;&gt;=E</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> returnOk <span class="main">(</span><span class="bound">x</span><span class="main">#</span><span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                 <span class="keyword1">in</span> foldr <span class="bound">mcons</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span>returnOk <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">mapME</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'e</span><span class="main">+</span><span class="tfree">'b</span><span class="main">)</span> nondet_monad<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> 
              <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'e</span><span class="main">+</span><span class="tfree">'b</span> list<span class="main">)</span> nondet_monad"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mapME</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> sequenceE <span class="main">(</span>map <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Filtering a list using a monadic function as predicate:›</span></span>
<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">filterM</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> bool<span class="main">)</span> nondet_monad<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span> list<span class="main">)</span> nondet_monad"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">filterM</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">[]</span>       <span class="main">=</span> return <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">filterM</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span>
     <span class="bound">b</span>  <span class="main">&lt;-</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
     <span class="bound">ys</span> <span class="main">&lt;-</span> <span class="free">filterM</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span> 
     return <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="bound">ys</span><span class="main">)</span> <span class="keyword1">else</span> <span class="bound">ys</span><span class="main">)</span>
   <span class="keyword1">od</span>"</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Catching and Handling Exceptions"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Turning an exception monad into a normal state monad
  by catching and handling any potential exceptions:
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">catch</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'a</span><span class="main">)</span> nondet_monad <span class="main">⇒</span>
            <span class="main">(</span><span class="tfree">'e</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> nondet_monad<span class="main">)</span> <span class="main">⇒</span>
            <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> nondet_monad"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&lt;catch&gt;</span>"</span> 10<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1"><span class="free">&lt;catch&gt;</span></span> <span class="free"><span class="bound"><span class="entity">handler</span></span></span> <span class="main">≡</span>
     <span class="keyword1">do</span> <span class="bound">x</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span>
        <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span>
          Inr <span class="bound">b</span> <span class="main">⇒</span> return <span class="bound">b</span>
        <span class="main">|</span> Inl <span class="bound">e</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">handler</span></span></span> <span class="bound">e</span>
     <span class="keyword1">od</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Handling exceptions, but staying in the exception monad.
  The handler may throw a type of exceptions different from
  the left side.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">handleE'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e1</span> <span class="main">+</span> <span class="tfree">'a</span><span class="main">)</span> nondet_monad <span class="main">⇒</span>
               <span class="main">(</span><span class="tfree">'e1</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e2</span> <span class="main">+</span> <span class="tfree">'a</span><span class="main">)</span> nondet_monad<span class="main">)</span> <span class="main">⇒</span>
               <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e2</span> <span class="main">+</span> <span class="tfree">'a</span><span class="main">)</span> nondet_monad"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&lt;handle2&gt;</span>"</span> 10<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1"><span class="free">&lt;handle2&gt;</span></span> <span class="free"><span class="bound"><span class="entity">handler</span></span></span> <span class="main">≡</span>
   <span class="keyword1">do</span>
      <span class="bound">v</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span>
      <span class="keyword1">case</span> <span class="bound">v</span> <span class="keyword1">of</span>
        Inl <span class="bound">e</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">handler</span></span></span> <span class="bound">e</span>
      <span class="main">|</span> Inr <span class="bound">v'</span> <span class="main">⇒</span> return <span class="main">(</span>Inr <span class="bound">v'</span><span class="main">)</span>
   <span class="keyword1">od</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A type restriction of the above that is used more commonly in
  practice: the exception handle (potentially) throws exception
  of the same type as the left-hand side.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">handleE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'x</span> <span class="main">+</span> <span class="tfree">'a</span><span class="main">)</span> nondet_monad <span class="main">⇒</span> 
              <span class="main">(</span><span class="tfree">'x</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'x</span> <span class="main">+</span> <span class="tfree">'a</span><span class="main">)</span> nondet_monad<span class="main">)</span> <span class="main">⇒</span> 
              <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'x</span> <span class="main">+</span> <span class="tfree">'a</span><span class="main">)</span> nondet_monad"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&lt;handle&gt;</span>"</span> 10<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">handleE</span> <span class="main">≡</span> handleE'"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Handling exceptions, and additionally providing a continuation
  if the left-hand side throws no exception:
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">handle_elseE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'a</span><span class="main">)</span> nondet_monad <span class="main">⇒</span>
                   <span class="main">(</span><span class="tfree">'e</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'ee</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">)</span> nondet_monad<span class="main">)</span> <span class="main">⇒</span>
                   <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'ee</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">)</span> nondet_monad<span class="main">)</span> <span class="main">⇒</span>
                   <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'ee</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">)</span> nondet_monad"</span></span>
  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">&lt;handle&gt;</span> _ <span class="keyword1">&lt;else&gt;</span> _"</span> 10<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1"><span class="free">&lt;handle&gt;</span></span> <span class="free"><span class="bound"><span class="entity">handler</span></span></span> <span class="keyword1"><span class="free">&lt;else&gt;</span></span> <span class="free"><span class="bound"><span class="entity">continue</span></span></span> <span class="main">≡</span>
   <span class="keyword1">do</span> <span class="bound">v</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span>
   <span class="keyword1">case</span> <span class="bound">v</span> <span class="keyword1">of</span> Inl <span class="bound">e</span>  <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">handler</span></span></span> <span class="bound">e</span>
           <span class="main">|</span> Inr <span class="bound">v'</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">continue</span></span></span> <span class="bound">v'</span>
   <span class="keyword1">od</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Loops"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Loops are handled using the following inductive predicate;
  non-termination is represented using the failure flag of the
  monad.
›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">whileLoop_results</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'r</span><span class="main">)</span> nondet_monad<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="tfree">'r</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> option<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'r</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> option<span class="main">)</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">C</span> <span class="entity">B</span>
<span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">¬</span> <span class="free">C</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">,</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">whileLoop_results</span> <span class="free">C</span> <span class="free">B</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">C</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span> snd <span class="main">(</span><span class="free">B</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">,</span> None<span class="main">)</span> <span class="main">∈</span> <span class="free">whileLoop_results</span> <span class="free">C</span> <span class="free">B</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">C</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">∈</span> fst <span class="main">(</span><span class="free">B</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">;</span> <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">whileLoop_results</span> <span class="free">C</span> <span class="free">B</span>  <span class="main">⟧</span>
       <span class="main">⟹</span> <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">whileLoop_results</span> <span class="free">C</span> <span class="free">B</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> whileLoop_results_cases_valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="free">x</span><span class="main">,</span> Some <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> whileLoop_results <span class="free">C</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> whileLoop_results_cases_fail<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="free">x</span><span class="main">,</span> None<span class="main">)</span> <span class="main">∈</span> whileLoop_results <span class="free">C</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">inductive_simps</span></span> whileLoop_results_simps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> whileLoop_results <span class="free">C</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">inductive_simps</span></span> whileLoop_results_simps_valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="free">x</span><span class="main">,</span> Some <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> whileLoop_results <span class="free">C</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">inductive_simps</span></span> whileLoop_results_simps_start_fail <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>None<span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> whileLoop_results <span class="free">C</span> <span class="free">B</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">whileLoop_terminates</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'r</span><span class="main">)</span> nondet_monad<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'r</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">C</span> <span class="entity">B</span>
<span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">C</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free">whileLoop_terminates</span> <span class="free">C</span> <span class="free">B</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">C</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span> <span class="main">∀</span><span class="main">(</span><span class="bound">r'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> fst <span class="main">(</span><span class="free">B</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">.</span> <span class="free">whileLoop_terminates</span> <span class="free">C</span> <span class="free">B</span> <span class="bound">r'</span> <span class="bound">s'</span> <span class="main">⟧</span>
        <span class="main">⟹</span> <span class="free">whileLoop_terminates</span> <span class="free">C</span> <span class="free">B</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> whileLoop_terminates_cases<span class="main">:</span> <span class="quoted"><span class="quoted">"whileLoop_terminates <span class="free">C</span> <span class="free">B</span> <span class="free">r</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">inductive_simps</span></span> whileLoop_terminates_simps<span class="main">:</span> <span class="quoted"><span class="quoted">"whileLoop_terminates <span class="free">C</span> <span class="free">B</span> <span class="free">r</span> <span class="free">s</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">whileLoop</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span>
     <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">r'</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>Some <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">,</span> Some <span class="main">(</span><span class="bound">r'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> whileLoop_results <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">}</span><span class="main">,</span>
        <span class="main">(</span>Some <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">,</span> None<span class="main">)</span> <span class="main">∈</span> whileLoop_results <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="main">¬</span> whileLoop_terminates <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="bound">r</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span>
  whileLoop  <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">whileLoop</span> <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">//</span>  <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">)</span>"</span> <span class="main">[</span>1000<span class="main">,</span> 1000<span class="main">]</span> 1000<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">whileLoopE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'r</span><span class="main">)</span> nondet_monad<span class="main">)</span>
      <span class="main">⇒</span> <span class="tfree">'r</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'r</span><span class="main">)</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> set <span class="main">×</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">whileLoopE</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">body</span></span></span> <span class="main">≡</span>
      <span class="main">λ</span><span class="bound">r</span><span class="main">.</span> whileLoop <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">r</span> <span class="keyword1">of</span> Inr <span class="bound">v</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="bound">v</span> <span class="bound">s</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span><span class="main">)</span> <span class="main">(</span>lift <span class="free"><span class="bound"><span class="entity">body</span></span></span><span class="main">)</span> <span class="main">(</span>Inr <span class="bound">r</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span>
  whileLoopE  <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">whileLoopE</span> <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">//</span>  <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">)</span>"</span> <span class="main">[</span>1000<span class="main">,</span> 1000<span class="main">]</span> 1000<span class="main">)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Hoare Logic"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Validity"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This section defines a Hoare logic for partial correctness for
  the nondeterministic state monad as well as the exception monad.
  The logic talks only about the behaviour part of the monad and ignores
  the failure flag.

  The logic is defined semantically. Rules work directly on the
  validity predicate.

  In the nondeterministic state monad, validity is a triple of precondition,
  monad, and postcondition. The precondition is a function from state to 
  bool (a state predicate), the postcondition is a function from return value
  to state to bool. A triple is valid if for all states that satisfy the
  precondition, all result values and result states that are returned by
  the monad satisfy the postcondition. Note that if the computation returns
  the empty set, the triple is trivially valid. This means <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"assert <span class="free"><span class="free">P</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
  does not require us to prove that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> holds, but rather allows us
  to assume <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>! Proving non-failure is done via separate predicate and
  calculus (see below).
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">valid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> nondet_monad <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> 
  <span class="main">(</span><span class="quoted">"<span class="keyword1">⦃</span>_<span class="keyword1">⦄</span><span class="keyword3">/ </span>_ <span class="keyword3">/</span><span class="keyword1">⦃</span>_<span class="keyword1">⦄</span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main"><span class="free">⦄</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">⦄</span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">r</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Validity for the exception monad is similar and build on the standard 
  validity above. Instead of one postcondition, we have two: one for
  normal and one for exceptional results.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">validE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">)</span> nondet_monad <span class="main">⇒</span> 
             <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> 
             <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> 
<span class="main">(</span><span class="quoted">"<span class="keyword1">⦃</span>_<span class="keyword1">⦄</span><span class="keyword3">/ </span>_ <span class="keyword3">/</span><span class="keyword3">(</span><span class="keyword1">⦃</span>_<span class="keyword1">⦄,</span><span class="keyword3">/ </span><span class="keyword1">⦃</span>_<span class="keyword1">⦄</span><span class="keyword3">)</span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main"><span class="free">⦄</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">⦄,</span></span><span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main"><span class="free">⦄</span></span> <span class="main">≡</span> <span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">⦄</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⦃</span> <span class="main">λ</span><span class="bound">v</span> <span class="bound">s</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">v</span> <span class="keyword1">of</span> Inr <span class="bound">r</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">r</span> <span class="bound">s</span> <span class="main">|</span> Inl <span class="bound">e</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="bound">e</span> <span class="bound">s</span> <span class="main">⦄</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following two instantiations are convenient to separate reasoning
  for exceptional and normal case.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">validE_R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'a</span><span class="main">)</span> nondet_monad <span class="main">⇒</span> 
               <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
   <span class="main">(</span><span class="quoted">"<span class="keyword1">⦃</span>_<span class="keyword1">⦄</span><span class="keyword3">/ </span>_ <span class="keyword3">/</span><span class="keyword1">⦃</span>_<span class="keyword1">⦄,</span> <span class="keyword1">-</span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main"><span class="free">⦄</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">⦄,</span></span><span class="main"><span class="free">-</span></span> <span class="main">≡</span> validE <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> True<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">validE_E</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span>  <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'a</span><span class="main">)</span> nondet_monad <span class="main">⇒</span> 
               <span class="main">(</span><span class="tfree">'e</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
   <span class="main">(</span><span class="quoted">"<span class="keyword1">⦃</span>_<span class="keyword1">⦄</span><span class="keyword3">/ </span>_ <span class="keyword3">/</span><span class="keyword1">-,</span> <span class="keyword1">⦃</span>_<span class="keyword1">⦄</span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main"><span class="free">⦄</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">-,</span></span><span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">⦄</span></span> <span class="main">≡</span> validE <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> True<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Abbreviations for trivial preconditions:›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span><span class="main">(</span>input<span class="main">)</span>
  <span class="entity">top</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⊤</span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊤</span></span> <span class="main">≡</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span><span class="main">(</span>input<span class="main">)</span>
  <span class="entity">bottom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⊥</span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊥</span></span> <span class="main">≡</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> False"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Abbreviations for trivial postconditions (taking two arguments):›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span><span class="main">(</span>input<span class="main">)</span>
  <span class="entity">toptop</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⊤⊤</span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊤⊤</span></span> <span class="main">≡</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span><span class="main">(</span>input<span class="main">)</span>
  <span class="entity">botbot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⊥⊥</span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊥⊥</span></span> <span class="main">≡</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Lifting <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>∧›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>∨›</span></span></span></span> over two arguments. 
  Lifting <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>∧›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>∨›</span></span></span></span> over one argument is already
  defined (written <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>and›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>or›</span></span></span></span>).
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">bipred_conj</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">And</span>"</span> 96<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bipred_conj</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">bipred_disj</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">Or</span>"</span> 91<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bipred_disj</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Determinism"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A monad of type <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>nondet_monad›</span></span></span></span> is deterministic iff it
returns exactly one state and result and does not fail›</span></span> 
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">det</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'s</span><span class="main">)</span> nondet_monad <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">det</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="bound">r</span><span class="main">}</span><span class="main">,</span>False<span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A deterministic <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>nondet_monad›</span></span></span></span> can be turned
  into a normal state monad:›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">the_run_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> nondet_monad <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'s</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">the_run_state</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">THE</span> <span class="bound">s'</span><span class="main">.</span> fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s'</span><span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Non-Failure"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  With the failure flag, we can formulate non-failure separately
  from validity. A monad <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m›</span></span></span></span> does not fail under precondition
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span>, if for no start state in that precondition it sets
  the failure flag.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">no_fail</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> nondet_monad <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">no_fail</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="main">(</span>snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  It is often desired to prove non-failure and a Hoare triple
  simultaneously, as the reasoning is often similar. The following
  definitions allow such reasoning to take place.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">validNF</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> nondet_monad <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
      <span class="main">(</span><span class="quoted">"<span class="keyword1">⦃</span>_<span class="keyword1">⦄</span><span class="keyword3">/ </span>_ <span class="keyword3">/</span><span class="keyword1">⦃</span>_<span class="keyword1">⦄!</span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">validNF</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> valid <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">∧</span> no_fail <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">validE_NF</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">)</span> nondet_monad <span class="main">⇒</span>
             <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span>
             <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="quoted">"<span class="keyword1">⦃</span>_<span class="keyword1">⦄</span><span class="keyword3">/ </span>_ <span class="keyword3">/</span><span class="keyword3">(</span><span class="keyword1">⦃</span>_<span class="keyword1">⦄,</span><span class="keyword3">/ </span><span class="keyword1">⦃</span>_<span class="keyword1">⦄!</span><span class="keyword3">)</span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">validE_NF</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">≡</span> validE <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">∧</span> no_fail <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1" id="NonDetMonad-validE_NF_alt_def"><span class="command">lemma</span></span> validE_NF_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⦃</span> <span class="free">P</span> <span class="main">⦄</span> <span class="free">B</span> <span class="main">⦃</span> <span class="free">Q</span> <span class="main">⦄,</span><span class="main">⦃</span> <span class="free">E</span> <span class="main">⦄!</span> <span class="main">=</span> <span class="main">⦃</span> <span class="free">P</span> <span class="main">⦄</span> <span class="free">B</span> <span class="main">⦃</span> <span class="main">λ</span><span class="bound">v</span> <span class="bound">s</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">v</span> <span class="keyword1">of</span> Inl <span class="bound">e</span> <span class="main">⇒</span> <span class="free">E</span> <span class="bound">e</span> <span class="bound">s</span> <span class="main">|</span> Inr <span class="bound">r</span> <span class="main">⇒</span> <span class="free">Q</span> <span class="bound">r</span> <span class="bound">s</span> <span class="main">⦄!</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> validE_NF_def validE_def validNF_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Usually, well-formed monads constructed from the primitives
  above will have the following property: if they return an
  empty set of results, they will have the failure flag set.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">empty_fail</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> nondet_monad <span class="main">⇒</span> bool"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">empty_fail</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">s</span><span class="main">.</span> fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟶</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">s</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Useful in forcing otherwise unknown executions to have
  the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> empty_fail<span class="antiquote"><span class="antiquote">}</span></span></span></span> property.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">mk_ef</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">×</span> bool <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">×</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mk_ef</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> fst <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> snd <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Basic exception reasoning"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following predicates <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>no_throw›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>no_return›</span></span></span></span> allow
  reasoning that functions in the exception monad either do
  no throw an exception or never return normally.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">no_throw</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">⦃</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⦄</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⦃</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True <span class="main">⦄,</span><span class="main">⦃</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False <span class="main">⦄</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">no_return</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">⦃</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⦄</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⦃</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">⦄,</span><span class="main">⦃</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True <span class="main">⦄</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="NonDetMonadLemmas">
<div class="head">
<h1>Theory NonDetMonadLemmas</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright 2014, NICTA
 *
 * This software may be distributed and modified according to the terms of
 * the BSD 2-Clause license. Note that NO WARRANTY is provided.
 * See "LICENSE_BSD2.txt" for details.
 *
 * @TAG(NICTA_BSD)
 *)</span>

<span class="keyword1"><span class="command">theory</span></span> NonDetMonadLemmas
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#NonDetMonad">NonDetMonad</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"General Lemmas Regarding the Nondeterministic State Monad"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Congruence Rules for the Function Package"</span></span>

<span class="keyword1" id="NonDetMonadLemmas-bind_cong"><span class="command">lemma</span></span> bind_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f'</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">v</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> fst <span class="main">(</span><span class="free">f'</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">g</span> <span class="bound">v</span> <span class="bound">s'</span> <span class="main">=</span> <span class="free">g'</span> <span class="bound">v</span> <span class="bound">s'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">&gt;&gt;=</span> <span class="free">g</span> <span class="main">=</span> <span class="free">f'</span> <span class="main">&gt;&gt;=</span> <span class="free">g'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bind_def Let_def split_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_image_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="NonDetMonadLemmas-bind_apply_cong"><span class="command">lemma</span></span> bind_apply_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">f</span> <span class="free">s</span> <span class="main">=</span> <span class="free">f'</span> <span class="free">s'</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">rv</span> <span class="bound">st</span><span class="main">.</span> <span class="main">(</span><span class="bound">rv</span><span class="main">,</span> <span class="bound">st</span><span class="main">)</span> <span class="main">∈</span> fst <span class="main">(</span><span class="free">f'</span> <span class="free">s'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">g</span> <span class="bound">rv</span> <span class="bound">st</span> <span class="main">=</span> <span class="free">g'</span> <span class="bound">rv</span> <span class="bound">st</span> <span class="main">⟧</span>
       <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="main">&gt;&gt;=</span> <span class="free">g</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">f'</span> <span class="main">&gt;&gt;=</span> <span class="free">g'</span><span class="main">)</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> SUP_cong <span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_image_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="NonDetMonadLemmas-bindE_cong"><span class="command">lemma</span></span> bindE_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">M</span> <span class="main">=</span> <span class="free">M'</span> <span class="main">;</span> <span class="main">⋀</span><span class="bound">v</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">(</span>Inr <span class="bound">v</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> fst <span class="main">(</span><span class="free">M'</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">N</span> <span class="bound">v</span> <span class="bound">s'</span> <span class="main">=</span> <span class="free">N'</span> <span class="bound">v</span> <span class="bound">s'</span> <span class="main">⟧</span> <span class="main">⟹</span> bindE <span class="free">M</span> <span class="free">N</span> <span class="main">=</span> bindE <span class="free">M'</span> <span class="free">N'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bindE_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bind_cong<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> lift_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">v</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="NonDetMonadLemmas-bindE_apply_cong"><span class="command">lemma</span></span> bindE_apply_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">f</span> <span class="free">s</span> <span class="main">=</span> <span class="free">f'</span> <span class="free">s'</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">rv</span> <span class="bound">st</span><span class="main">.</span> <span class="main">(</span>Inr <span class="bound">rv</span><span class="main">,</span> <span class="bound">st</span><span class="main">)</span> <span class="main">∈</span> fst <span class="main">(</span><span class="free">f'</span> <span class="free">s'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">g</span> <span class="bound">rv</span> <span class="bound">st</span> <span class="main">=</span> <span class="free">g'</span> <span class="bound">rv</span> <span class="bound">st</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">&gt;&gt;=E</span> <span class="free">g</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">f'</span> <span class="keyword1">&gt;&gt;=E</span> <span class="free">g'</span><span class="main">)</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bindE_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bind_apply_cong<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">rv</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lift_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="NonDetMonadLemmas-K_bind_apply_cong"><span class="command">lemma</span></span> K_bind_apply_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">f</span> <span class="free">st</span> <span class="main">=</span> <span class="free">f'</span> <span class="free">st'</span> <span class="main">⟧</span> <span class="main">⟹</span> K_bind <span class="free">f</span> <span class="free">arg</span> <span class="free">st</span> <span class="main">=</span> K_bind <span class="free">f'</span> <span class="free">arg'</span> <span class="free">st'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="NonDetMonadLemmas-when_apply_cong"><span class="command">lemma</span></span> when_apply_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">C</span> <span class="main">=</span> <span class="free">C'</span><span class="main">;</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s'</span><span class="main">;</span> <span class="free">C'</span> <span class="main">⟹</span> <span class="free">m</span> <span class="free">s'</span> <span class="main">=</span> <span class="free">m'</span> <span class="free">s'</span> <span class="main">⟧</span> <span class="main">⟹</span> whenE <span class="free">C</span> <span class="free">m</span> <span class="free">s</span> <span class="main">=</span> whenE <span class="free">C'</span> <span class="free">m'</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> whenE_def<span class="main">)</span>

<span class="keyword1" id="NonDetMonadLemmas-unless_apply_cong"><span class="command">lemma</span></span> unless_apply_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">C</span> <span class="main">=</span> <span class="free">C'</span><span class="main">;</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s'</span><span class="main">;</span> <span class="main">¬</span> <span class="free">C'</span> <span class="main">⟹</span> <span class="free">m</span> <span class="free">s'</span> <span class="main">=</span> <span class="free">m'</span> <span class="free">s'</span> <span class="main">⟧</span> <span class="main">⟹</span> unlessE <span class="free">C</span> <span class="free">m</span> <span class="free">s</span> <span class="main">=</span> unlessE <span class="free">C'</span> <span class="free">m'</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unlessE_def<span class="main">)</span>

<span class="keyword1" id="NonDetMonadLemmas-whenE_apply_cong"><span class="command">lemma</span></span> whenE_apply_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">C</span> <span class="main">=</span> <span class="free">C'</span><span class="main">;</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s'</span><span class="main">;</span> <span class="free">C'</span> <span class="main">⟹</span> <span class="free">m</span> <span class="free">s'</span> <span class="main">=</span> <span class="free">m'</span> <span class="free">s'</span> <span class="main">⟧</span> <span class="main">⟹</span> whenE <span class="free">C</span> <span class="free">m</span> <span class="free">s</span> <span class="main">=</span> whenE <span class="free">C'</span> <span class="free">m'</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> whenE_def<span class="main">)</span>

<span class="keyword1" id="NonDetMonadLemmas-unlessE_apply_cong"><span class="command">lemma</span></span> unlessE_apply_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">C</span> <span class="main">=</span> <span class="free">C'</span><span class="main">;</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s'</span><span class="main">;</span> <span class="main">¬</span> <span class="free">C'</span> <span class="main">⟹</span> <span class="free">m</span> <span class="free">s'</span> <span class="main">=</span> <span class="free">m'</span> <span class="free">s'</span> <span class="main">⟧</span> <span class="main">⟹</span> unlessE <span class="free">C</span> <span class="free">m</span> <span class="free">s</span> <span class="main">=</span> unlessE <span class="free">C'</span> <span class="free">m'</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unlessE_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Simplifying Monads"</span></span>

<span class="keyword1" id="NonDetMonadLemmas-nested_bind"><span class="command">lemma</span></span> nested_bind <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="bound">x</span> <span class="main">&lt;-</span> <span class="keyword1">do</span> <span class="bound">y</span> <span class="main">&lt;-</span> <span class="free">f</span><span class="main">;</span> return <span class="main">(</span><span class="free">g</span> <span class="bound">y</span><span class="main">)</span> <span class="keyword1">od</span><span class="main">;</span> <span class="free">h</span> <span class="bound">x</span> <span class="keyword1">od</span> <span class="main">=</span>
   <span class="keyword1">do</span> <span class="bound">y</span> <span class="main">&lt;-</span> <span class="free">f</span><span class="main">;</span> <span class="free">h</span> <span class="main">(</span><span class="free">g</span> <span class="bound">y</span><span class="main">)</span> <span class="keyword1">od</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def split_def return_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="NonDetMonadLemmas-fail_bind"><span class="command">lemma</span></span> fail_bind <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fail <span class="main">&gt;&gt;=</span> <span class="free">f</span> <span class="main">=</span> fail"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_def fail_def<span class="main">)</span>

<span class="keyword1" id="NonDetMonadLemmas-fail_bindE"><span class="command">lemma</span></span> fail_bindE <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fail <span class="keyword1">&gt;&gt;=E</span> <span class="free">f</span> <span class="main">=</span> fail"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bindE_def bind_def fail_def<span class="main">)</span>

<span class="keyword1" id="NonDetMonadLemmas-assert_False"><span class="command">lemma</span></span> assert_False <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"assert False <span class="main">&gt;&gt;=</span> <span class="free">f</span> <span class="main">=</span> fail"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assert_def<span class="main">)</span>

<span class="keyword1" id="NonDetMonadLemmas-assert_True"><span class="command">lemma</span></span> assert_True <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"assert True <span class="main">&gt;&gt;=</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span> <span class="main">()</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assert_def<span class="main">)</span>

<span class="keyword1" id="NonDetMonadLemmas-assertE_False"><span class="command">lemma</span></span> assertE_False <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"assertE False <span class="keyword1">&gt;&gt;=E</span> <span class="free">f</span> <span class="main">=</span> fail"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assertE_def<span class="main">)</span>

<span class="keyword1" id="NonDetMonadLemmas-assertE_True"><span class="command">lemma</span></span> assertE_True <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"assertE True <span class="keyword1">&gt;&gt;=E</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span> <span class="main">()</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assertE_def<span class="main">)</span>

<span class="keyword1" id="NonDetMonadLemmas-when_False_bind"><span class="command">lemma</span></span> when_False_bind <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"when False <span class="free">g</span> <span class="main">&gt;&gt;=</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span> <span class="main">()</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> when_def bind_def return_def<span class="main">)</span>

<span class="keyword1" id="NonDetMonadLemmas-when_True_bind"><span class="command">lemma</span></span> when_True_bind <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"when True <span class="free">g</span> <span class="main">&gt;&gt;=</span> <span class="free">f</span> <span class="main">=</span> <span class="free">g</span> <span class="main">&gt;&gt;=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> when_def bind_def return_def<span class="main">)</span>

<span class="keyword1" id="NonDetMonadLemmas-whenE_False_bind"><span class="command">lemma</span></span> whenE_False_bind <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"whenE False <span class="free">g</span> <span class="keyword1">&gt;&gt;=E</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span> <span class="main">()</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> whenE_def bindE_def returnOk_def lift_def<span class="main">)</span>

<span class="keyword1" id="NonDetMonadLemmas-whenE_True_bind"><span class="command">lemma</span></span> whenE_True_bind <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"whenE True <span class="free">g</span> <span class="keyword1">&gt;&gt;=E</span> <span class="free">f</span> <span class="main">=</span> <span class="free">g</span> <span class="keyword1">&gt;&gt;=E</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> whenE_def bindE_def returnOk_def lift_def<span class="main">)</span>

<span class="keyword1" id="NonDetMonadLemmas-when_True"><span class="command">lemma</span></span> when_True <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"when True <span class="free">X</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> when_def<span class="main">)</span>

<span class="keyword1" id="NonDetMonadLemmas-when_False"><span class="command">lemma</span></span> when_False <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"when False <span class="free">X</span> <span class="main">=</span> return <span class="main">()</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> when_def<span class="main">)</span>

<span class="keyword1" id="NonDetMonadLemmas-unless_False"><span class="command">lemma</span></span> unless_False <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"unless False <span class="free">X</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unless_def<span class="main">)</span>

<span class="keyword1" id="NonDetMonadLemmas-unless_True"><span class="command">lemma</span></span> unless_True <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"unless True <span class="free">X</span> <span class="main">=</span> return <span class="main">()</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unless_def<span class="main">)</span>

<span class="keyword1" id="NonDetMonadLemmas-unlessE_whenE"><span class="command">lemma</span></span> unlessE_whenE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"unlessE <span class="free">P</span> <span class="main">=</span> whenE <span class="main">(</span><span class="main">~</span><span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unlessE_def whenE_def<span class="main">)</span>

<span class="keyword1" id="NonDetMonadLemmas-unless_when"><span class="command">lemma</span></span> unless_when<span class="main">:</span>
  <span class="quoted"><span class="quoted">"unless <span class="free">P</span> <span class="main">=</span> when <span class="main">(</span><span class="main">~</span><span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unless_def when_def<span class="main">)</span>

<span class="keyword1" id="NonDetMonadLemmas-gets_to_return"><span class="command">lemma</span></span> gets_to_return <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"gets <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> return <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gets_def put_def get_def bind_def return_def<span class="main">)</span>

<span class="keyword1" id="NonDetMonadLemmas-assert_opt_Some"><span class="command">lemma</span></span> assert_opt_Some<span class="main">:</span>
  <span class="quoted"><span class="quoted">"assert_opt <span class="main">(</span>Some <span class="free">x</span><span class="main">)</span> <span class="main">=</span> return <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assert_opt_def<span class="main">)</span>

<span class="keyword1" id="NonDetMonadLemmas-assertE_liftE"><span class="command">lemma</span></span> assertE_liftE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"assertE <span class="free">P</span> <span class="main">=</span> liftE <span class="main">(</span>assert <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assertE_def assert_def liftE_def returnOk_def<span class="main">)</span>

<span class="keyword1" id="NonDetMonadLemmas-liftE_handleE'"><span class="command">lemma</span></span> liftE_handleE' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>liftE <span class="free">a</span><span class="main">)</span> <span class="keyword1">&lt;handle2&gt;</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> liftE <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> liftE_def handleE'_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="NonDetMonadLemmas-liftE_handleE"><span class="command">lemma</span></span> liftE_handleE <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>liftE <span class="free">a</span><span class="main">)</span> <span class="keyword1">&lt;handle&gt;</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> liftE <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> handleE_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="NonDetMonadLemmas-condition_split"><span class="command">lemma</span></span> condition_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>condition <span class="free">C</span> <span class="free">a</span> <span class="free">b</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">C</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="free">a</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="free">C</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="free">b</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> condition_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="NonDetMonadLemmas-condition_split_asm"><span class="command">lemma</span></span> condition_split_asm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>condition <span class="free">C</span> <span class="free">a</span> <span class="free">b</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="free">C</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">P</span> <span class="main">(</span><span class="free">a</span> <span class="free">s</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span> <span class="free">C</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">P</span> <span class="main">(</span><span class="free">b</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> condition_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> condition_splits <span class="main">=</span> condition_split condition_split_asm

<span class="keyword1" id="NonDetMonadLemmas-condition_true_triv"><span class="command">lemma</span></span> condition_true_triv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"condition <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="free">A</span> <span class="free">B</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> condition_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="NonDetMonadLemmas-condition_false_triv"><span class="command">lemma</span></span> condition_false_triv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"condition <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span> <span class="free">A</span> <span class="free">B</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> condition_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="NonDetMonadLemmas-condition_true"><span class="command">lemma</span></span> condition_true<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> condition <span class="free">P</span> <span class="free">A</span> <span class="free">B</span> <span class="free">s</span> <span class="main">=</span> <span class="free">A</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> condition_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="NonDetMonadLemmas-condition_false"><span class="command">lemma</span></span> condition_false<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">¬</span> <span class="free">P</span> <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> condition <span class="free">P</span> <span class="free">A</span> <span class="free">B</span> <span class="free">s</span> <span class="main">=</span> <span class="free">B</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> condition_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Low-level monadic reasoning"</span></span>

<span class="keyword1" id="NonDetMonadLemmas-monad_eqI"><span class="command">lemma</span></span> monad_eqI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">r</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> fst <span class="main">(</span><span class="free">A</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> fst <span class="main">(</span><span class="free">B</span> <span class="bound">s</span><span class="main">)</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">r</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> fst <span class="main">(</span><span class="free">B</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> fst <span class="main">(</span><span class="free">A</span> <span class="bound">s</span><span class="main">)</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> snd <span class="main">(</span><span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">B</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">(</span><span class="free">A</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> nondet_monad<span class="main">)</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> set_eqI prod_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="NonDetMonadLemmas-monad_state_eqI"><span class="command">lemma</span></span> monad_state_eqI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">r</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> fst <span class="main">(</span><span class="free">A</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> fst <span class="main">(</span><span class="free">B</span> <span class="free">s'</span><span class="main">)</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">r</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> fst <span class="main">(</span><span class="free">B</span> <span class="free">s'</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> fst <span class="main">(</span><span class="free">A</span> <span class="free">s</span><span class="main">)</span><span class="main">;</span>
     snd <span class="main">(</span><span class="free">A</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">B</span> <span class="free">s'</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">(</span><span class="free">A</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> nondet_monad<span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="free">B</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> set_eqI prod_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"General whileLoop reasoning"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">whileLoop_terminatesE</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span>
     whileLoop_terminates <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">r</span> <span class="keyword1">of</span> Inr <span class="bound">v</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="bound">v</span> <span class="bound">s</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span> <span class="main">(</span>lift <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">(</span>Inr <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="NonDetMonadLemmas-whileLoop_cond_fail"><span class="command">lemma</span></span> whileLoop_cond_fail<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">¬</span> <span class="free">C</span> <span class="free">x</span> <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>whileLoop <span class="free">C</span> <span class="free">B</span> <span class="free">x</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>return <span class="free">x</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> return_def whileLoop_def
       <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> whileLoop_results.intros
              whileLoop_terminates.intros
       <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> whileLoop_results.cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="NonDetMonadLemmas-whileLoopE_cond_fail"><span class="command">lemma</span></span> whileLoopE_cond_fail<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">¬</span> <span class="free">C</span> <span class="free">x</span> <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>whileLoopE <span class="free">C</span> <span class="free">B</span> <span class="free">x</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>returnOk <span class="free">x</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> whileLoopE_def returnOk_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> whileLoop_cond_fail<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="NonDetMonadLemmas-whileLoop_results_simps_no_move"><span class="command">lemma</span></span> whileLoop_results_simps_no_move <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>Some <span class="free">x</span><span class="main">,</span> Some <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> whileLoop_results <span class="free">C</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> <span class="free">C</span> <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?LHS</span> <span class="free">x</span> <span class="main">=</span> <span class="var">?RHS</span> <span class="free">x</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?LHS</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">a</span><span class="main">.</span> Some <span class="free">x</span> <span class="main">=</span> Some <span class="bound">a</span><span class="main">)</span> <span class="main">⟶</span> <span class="var">?RHS</span> <span class="main">(</span>the <span class="main">(</span>Some <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> whileLoop_results.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?RHS</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?RHS</span> <span class="free">x</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?LHS</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surjective_pairing whileLoop_results.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="NonDetMonadLemmas-whileLoop_unroll"><span class="command">lemma</span></span> whileLoop_unroll<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>whileLoop <span class="free">C</span> <span class="free">B</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span>  <span class="main">(</span><span class="main">(</span>condition <span class="main">(</span><span class="free">C</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="free">r</span> <span class="main">&gt;&gt;=</span> <span class="main">(</span>whileLoop <span class="free">C</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>return <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?LHS</span> <span class="free">r</span> <span class="main">=</span> <span class="var">?RHS</span> <span class="free">r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> cond_fail<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="main">¬</span> <span class="free">C</span> <span class="bound">r</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="var">?LHS</span> <span class="bound">r</span> <span class="bound">s</span> <span class="main">=</span> <span class="var">?RHS</span> <span class="bound">r</span> <span class="bound">s</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> whileLoop_cond_fail<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> condition_def bind_def return_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> cond_pass<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="free">C</span> <span class="bound">r</span> <span class="bound">s</span> <span class="main">⟹</span> whileLoop <span class="free">C</span> <span class="free">B</span> <span class="bound">r</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span> <span class="bound">r</span> <span class="main">&gt;&gt;=</span> <span class="main">(</span>whileLoop <span class="free">C</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> monad_state_eqI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> whileLoop_def bind_def split_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> whileLoop_results_simps_valid<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> whileLoop_def bind_def split_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> whileLoop_results.simps<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> whileLoop_def bind_def split_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> whileLoop_results.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> whileLoop_terminates.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cond_fail cond_pass condition_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="NonDetMonadLemmas-whileLoop_unroll'"><span class="command">lemma</span></span> whileLoop_unroll'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>whileLoop <span class="free">C</span> <span class="free">B</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>condition <span class="main">(</span><span class="free">C</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>return <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;&gt;=</span> <span class="main">(</span>whileLoop <span class="free">C</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> whileLoop_unroll<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> condition_def bind_def return_def split_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> whileLoop_cond_fail<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> return_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="NonDetMonadLemmas-whileLoopE_unroll"><span class="command">lemma</span></span> whileLoopE_unroll<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>whileLoopE <span class="free">C</span> <span class="free">B</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span>  <span class="main">(</span><span class="main">(</span>condition <span class="main">(</span><span class="free">C</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="free">r</span> <span class="keyword1">&gt;&gt;=E</span> <span class="main">(</span>whileLoopE <span class="free">C</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>returnOk <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> whileLoopE_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> whileLoop_unroll<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> whileLoopE_def bindE_def returnOk_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> condition_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="free">B</span> <span class="free">r</span> <span class="main">&gt;&gt;=</span> <span class="bound">a</span><span class="main">)</span> <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> arg_cong<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> whileLoop_unroll<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> condition_false<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> throwError_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="NonDetMonadLemmas-whileLoopE_unroll'"><span class="command">lemma</span></span> whileLoopE_unroll'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>whileLoopE <span class="free">C</span> <span class="free">B</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span>  <span class="main">(</span><span class="main">(</span>condition <span class="main">(</span><span class="free">C</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>returnOk <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">&gt;&gt;=E</span> <span class="main">(</span>whileLoopE <span class="free">C</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> whileLoopE_unroll<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> condition_def bindE_def bind_def returnOk_def return_def lift_def split_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> whileLoopE_cond_fail<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> returnOk_def return_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* These lemmas are useful to apply to rules to convert valid rules into
 * a format suitable for wp. *)</span>

<span class="keyword1" id="NonDetMonadLemmas-valid_make_schematic_post"><span class="command">lemma</span></span> valid_make_schematic_post<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">s0</span><span class="main">.</span> <span class="main">⦃</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s0</span> <span class="bound">s</span> <span class="main">⦄</span> <span class="free">f</span> <span class="main">⦃</span> <span class="main">λ</span><span class="bound">rv</span> <span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s0</span> <span class="bound">rv</span> <span class="bound">s</span> <span class="main">⦄</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">⦃</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s0</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s0</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">rv</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s0</span> <span class="bound">rv</span> <span class="bound">s'</span> <span class="main">⟶</span> <span class="free">Q'</span> <span class="bound">rv</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⦄</span> <span class="free">f</span> <span class="main">⦃</span> <span class="free">Q'</span> <span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_def no_fail_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1" id="NonDetMonadLemmas-validNF_make_schematic_post"><span class="command">lemma</span></span> validNF_make_schematic_post<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">s0</span><span class="main">.</span> <span class="main">⦃</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s0</span> <span class="bound">s</span> <span class="main">⦄</span> <span class="free">f</span> <span class="main">⦃</span> <span class="main">λ</span><span class="bound">rv</span> <span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s0</span> <span class="bound">rv</span> <span class="bound">s</span> <span class="main">⦄!</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">⦃</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s0</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s0</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">rv</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s0</span> <span class="bound">rv</span> <span class="bound">s'</span> <span class="main">⟶</span> <span class="free">Q'</span> <span class="bound">rv</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⦄</span> <span class="free">f</span> <span class="main">⦃</span> <span class="free">Q'</span> <span class="main">⦄!</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_def validNF_def no_fail_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1" id="NonDetMonadLemmas-validE_make_schematic_post"><span class="command">lemma</span></span> validE_make_schematic_post<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">s0</span><span class="main">.</span> <span class="main">⦃</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s0</span> <span class="bound">s</span> <span class="main">⦄</span> <span class="free">f</span> <span class="main">⦃</span> <span class="main">λ</span><span class="bound">rv</span> <span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s0</span> <span class="bound">rv</span> <span class="bound">s</span> <span class="main">⦄,</span> <span class="main">⦃</span> <span class="main">λ</span><span class="bound">rv</span> <span class="bound">s</span><span class="main">.</span> <span class="free">E</span> <span class="bound">s0</span> <span class="bound">rv</span> <span class="bound">s</span> <span class="main">⦄</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">⦃</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s0</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s0</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">rv</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s0</span> <span class="bound">rv</span> <span class="bound">s'</span> <span class="main">⟶</span> <span class="free">Q'</span> <span class="bound">rv</span> <span class="bound">s'</span><span class="main">)</span>
        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">rv</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">E</span> <span class="bound">s0</span> <span class="bound">rv</span> <span class="bound">s'</span> <span class="main">⟶</span> <span class="free">E'</span> <span class="bound">rv</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⦄</span> <span class="free">f</span> <span class="main">⦃</span> <span class="free">Q'</span> <span class="main">⦄,</span> <span class="main">⦃</span> <span class="free">E'</span> <span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> validE_def valid_def no_fail_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits sum.splits<span class="main">)</span>

<span class="keyword1" id="NonDetMonadLemmas-validE_NF_make_schematic_post"><span class="command">lemma</span></span> validE_NF_make_schematic_post<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">s0</span><span class="main">.</span> <span class="main">⦃</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s0</span> <span class="bound">s</span> <span class="main">⦄</span> <span class="free">f</span> <span class="main">⦃</span> <span class="main">λ</span><span class="bound">rv</span> <span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s0</span> <span class="bound">rv</span> <span class="bound">s</span> <span class="main">⦄,</span> <span class="main">⦃</span> <span class="main">λ</span><span class="bound">rv</span> <span class="bound">s</span><span class="main">.</span> <span class="free">E</span> <span class="bound">s0</span> <span class="bound">rv</span> <span class="bound">s</span> <span class="main">⦄!</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">⦃</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s0</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s0</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">rv</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s0</span> <span class="bound">rv</span> <span class="bound">s'</span> <span class="main">⟶</span> <span class="free">Q'</span> <span class="bound">rv</span> <span class="bound">s'</span><span class="main">)</span>
        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">rv</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">E</span> <span class="bound">s0</span> <span class="bound">rv</span> <span class="bound">s'</span> <span class="main">⟶</span> <span class="free">E'</span> <span class="bound">rv</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⦄</span> <span class="free">f</span> <span class="main">⦃</span> <span class="free">Q'</span> <span class="main">⦄,</span> <span class="main">⦃</span> <span class="free">E'</span> <span class="main">⦄!</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> validE_NF_def validE_def valid_def no_fail_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits sum.splits<span class="main">)</span>

<span class="keyword1" id="NonDetMonadLemmas-validNF_conjD1"><span class="command">lemma</span></span> validNF_conjD1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span> <span class="free">P</span> <span class="main">⦄</span> <span class="free">f</span> <span class="main">⦃</span> <span class="main">λ</span><span class="bound">rv</span> <span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">rv</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">Q'</span> <span class="bound">rv</span> <span class="bound">s</span> <span class="main">⦄!</span> <span class="main">⟹</span> <span class="main">⦃</span> <span class="free">P</span> <span class="main">⦄</span> <span class="free">f</span> <span class="main">⦃</span> <span class="free">Q</span> <span class="main">⦄!</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> validNF_def valid_def no_fail_def<span class="main">)</span>

<span class="keyword1" id="NonDetMonadLemmas-validNF_conjD2"><span class="command">lemma</span></span> validNF_conjD2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span> <span class="free">P</span> <span class="main">⦄</span> <span class="free">f</span> <span class="main">⦃</span> <span class="main">λ</span><span class="bound">rv</span> <span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">rv</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">Q'</span> <span class="bound">rv</span> <span class="bound">s</span> <span class="main">⦄!</span> <span class="main">⟹</span> <span class="main">⦃</span> <span class="free">P</span> <span class="main">⦄</span> <span class="free">f</span> <span class="main">⦃</span> <span class="free">Q'</span> <span class="main">⦄!</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> validNF_def valid_def no_fail_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="OptionMonadND">
<div class="head">
<h1>Theory OptionMonadND</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright 2014, NICTA
 *
 * This software may be distributed and modified according to the terms of
 * the BSD 2-Clause license. Note that NO WARRANTY is provided.
 * See "LICENSE_BSD2.txt" for details.
 *
 * @TAG(NICTA_BSD)
 *)</span>

<span class="comment1">(* Option monad syntax plus the connection between the option monad and the nondet monad *)</span>

<span class="keyword1"><span class="command">theory</span></span> OptionMonadND
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#OptionMonad">OptionMonad</a>
  <span class="quoted">"<a href="#NonDetMonadLemmas">wp/NonDetMonadLemmas</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* FIXME: better concrete syntax? *)</span>
<span class="comment1">(* Syntax defined here so we can reuse NonDetMonad definitions *)</span>
<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_doO"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>dobinds<span class="main">,</span> <span class="tfree">'a</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="tfree">'a</span>"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">DO</span> <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">;</span><span class="keyword3">//</span>   <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">//</span><span class="keyword1">OD</span><span class="keyword3">)</span>"</span> 100<span class="main">)</span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"_doO <span class="main">(</span>_dobinds <span class="free">b</span> <span class="free">bs</span><span class="main">)</span> <span class="free">e</span>"</span> <span class="main">==</span> <span class="quoted">"_doO <span class="free">b</span> <span class="main">(</span>_doO <span class="free">bs</span> <span class="free">e</span><span class="main">)</span>"</span>
  <span class="quoted">"_doO <span class="main">(</span>_nobind <span class="free">b</span><span class="main">)</span> <span class="free">e</span>"</span>     <span class="main">==</span> <span class="quoted">"<span class="free">b</span> <span class="main">|&gt;&gt;</span> <span class="main">(</span><span class="keyword1">CONST</span> K_bind <span class="free">e</span><span class="main">)</span>"</span>
  <span class="quoted">"<span class="keyword1">DO</span> <span class="free">x</span> <span class="main">&lt;-</span> <span class="free">a</span><span class="main">;</span> <span class="free">e</span> <span class="keyword1">OD</span>"</span>        <span class="main">==</span> <span class="quoted">"<span class="free">a</span> <span class="main">|&gt;&gt;</span> <span class="main">(</span><span class="main">λ</span><span class="free">x</span><span class="main">.</span> <span class="free">e</span><span class="main">)</span>"</span>


<span class="keyword1"><span class="command">definition</span></span>
 <span class="entity">ogets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> option<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">ogets</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">ocatch</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="main">(</span><span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'a</span><span class="main">)</span><span class="main">)</span> lookup <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> lookup<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> lookup"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&lt;ocatch&gt;</span>"</span> 10<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1"><span class="free">&lt;ocatch&gt;</span></span> <span class="free"><span class="bound"><span class="entity">handler</span></span></span> <span class="main">≡</span>
     <span class="keyword1">DO</span> <span class="bound">x</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span>
        <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span>
          Inr <span class="bound">b</span> <span class="main">⇒</span> oreturn <span class="bound">b</span>
        <span class="main">|</span> Inl <span class="bound">e</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">handler</span></span></span> <span class="bound">e</span>
     <span class="keyword1">OD</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">odrop</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'a</span><span class="main">)</span> lookup <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> lookup"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">odrop</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span>
     <span class="keyword1">DO</span> <span class="bound">x</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span>
        <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span>
          Inr <span class="bound">b</span> <span class="main">⇒</span> oreturn <span class="bound">b</span>
        <span class="main">|</span> Inl <span class="bound">e</span> <span class="main">⇒</span> ofail
     <span class="keyword1">OD</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">osequence_x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> lookup list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> unit<span class="main">)</span> lookup"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">osequence_x</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> foldr <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="keyword1">DO</span> <span class="main"><span class="bound">_</span></span> <span class="main">&lt;-</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">y</span> <span class="keyword1">OD</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span>oreturn <span class="main">()</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">osequence</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> lookup list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span> list<span class="main">)</span> lookup"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">osequence</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="bound">mcons</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">p</span> <span class="main">|&gt;&gt;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">q</span> <span class="main">|&gt;&gt;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> oreturn <span class="main">(</span><span class="bound">x</span><span class="main">#</span><span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                 <span class="keyword1">in</span> foldr <span class="bound">mcons</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span>oreturn <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">omap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> lookup<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'b</span> list<span class="main">)</span> lookup"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">omap</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> osequence <span class="main">(</span>map <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">opt_cons</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">o#</span>"</span> 65<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">opt_cons</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">|</span> Some <span class="bound">x'</span> <span class="main">⇒</span> <span class="bound">x'</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> monad_simps <span class="main">=</span>
  gets_the_def bind_def assert_def assert_opt_def 
  simpler_gets_def fail_def return_def

<span class="keyword1" id="OptionMonadND-gets_the_opt_map"><span class="command">lemma</span></span> gets_the_opt_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gets_the <span class="main">(</span><span class="free">f</span> <span class="main">|&gt;</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="bound">x</span> <span class="main">←</span> gets_the <span class="free">f</span><span class="main">;</span> assert_opt <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">od</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monad_simps opt_map_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="OptionMonadND-gets_the_opt_o"><span class="command">lemma</span></span> gets_the_opt_o<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gets_the <span class="main">(</span><span class="free">f</span> <span class="main">|&gt;</span> Some <span class="keyword1">o</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="bound">x</span> <span class="main">←</span> gets_the <span class="free">f</span><span class="main">;</span> return <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">od</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gets_the_opt_map assert_opt_Some<span class="main">)</span>

<span class="keyword1" id="OptionMonadND-gets_the_obind"><span class="command">lemma</span></span> gets_the_obind<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gets_the <span class="main">(</span><span class="free">f</span> <span class="main">|&gt;&gt;</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> gets_the <span class="free">f</span> <span class="main">&gt;&gt;=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> gets_the <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monad_simps obind_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="OptionMonadND-gets_the_return"><span class="command">lemma</span></span> gets_the_return<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gets_the <span class="main">(</span>oreturn <span class="free">x</span><span class="main">)</span> <span class="main">=</span> return <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monad_simps oreturn_def K_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadND-gets_the_fail"><span class="command">lemma</span></span> gets_the_fail<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gets_the ofail <span class="main">=</span> fail"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monad_simps ofail_def K_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadND-gets_the_returnOk"><span class="command">lemma</span></span> gets_the_returnOk<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gets_the <span class="main">(</span>oreturnOk <span class="free">x</span><span class="main">)</span> <span class="main">=</span> returnOk <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monad_simps K_def oreturnOk_def returnOk_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadND-gets_the_throwError"><span class="command">lemma</span></span> gets_the_throwError<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gets_the <span class="main">(</span>othrow <span class="free">e</span><span class="main">)</span> <span class="main">=</span> throwError <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monad_simps othrow_def throwError_def K_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadND-gets_the_assert"><span class="command">lemma</span></span> gets_the_assert<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gets_the <span class="main">(</span>oassert <span class="free">P</span><span class="main">)</span> <span class="main">=</span> assert <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> oassert_def assert_def gets_the_fail gets_the_return<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> omonad_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span>
  gets_the_opt_map assert_opt_Some gets_the_obind
  gets_the_return gets_the_fail gets_the_returnOk
  gets_the_throwError gets_the_assert



<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Relation between option monad loops and non-deterministic monad loops."</span></span>

<span class="comment1">(* Option monad whileLoop formalisation thanks to Lars Noschinski &lt;noschinl@in.tum.de&gt;. *)</span>

<span class="keyword1" id="OptionMonadND-gets_the_conv"><span class="command">lemma</span></span> gets_the_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>gets_the <span class="free">B</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">B</span> <span class="free">s</span> <span class="keyword1">of</span> Some <span class="bound">r'</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">r'</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span><span class="main">}</span><span class="main">,</span> False<span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span> True<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gets_the_def gets_def get_def bind_def return_def fail_def assert_opt_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="OptionMonadND-gets_the_loop_terminates"><span class="command">lemma</span></span> gets_the_loop_terminates<span class="main">:</span>
  <span class="quoted"><span class="quoted">"whileLoop_terminates <span class="free">C</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> gets_the <span class="main">(</span><span class="free">B</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span> <span class="free">s</span>
    <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">rs'</span><span class="main">.</span> <span class="main">(</span>Some <span class="free">r</span><span class="main">,</span> <span class="bound">rs'</span><span class="main">)</span> <span class="main">∈</span> option_while' <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">C</span> <span class="bound">a</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">B</span> <span class="bound">a</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> whileLoop_terminates.induct<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> 1 2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="skolem">r</span> <span class="skolem">s</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gets_the_conv <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> option_while'.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> option_while'.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">rs'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="free">r</span><span class="main">,</span> <span class="skolem">rs'</span><span class="main">)</span> <span class="main">∈</span> option_while' <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">C</span> <span class="bound">a</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">B</span> <span class="bound">a</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"whileLoop_terminates <span class="free">C</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> gets_the <span class="main">(</span><span class="free">B</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span>Some <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> whileLoop_terminates.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gets_the_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="OptionMonadND-gets_the_whileLoop"><span class="command">lemma</span></span> gets_the_whileLoop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">C</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"whileLoop <span class="free">C</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> gets_the <span class="main">(</span><span class="free">B</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> gets_the <span class="main">(</span>owhile <span class="free">C</span> <span class="free">B</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">r'</span> <span class="skolem">s'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="main">(</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span><span class="main">,</span> Some <span class="main">(</span><span class="skolem">r'</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> whileLoop_results <span class="free">C</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> gets_the <span class="main">(</span><span class="free">B</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">s'</span> <span class="main">∧</span> <span class="main">(</span>Some <span class="skolem">r</span><span class="main">,</span> Some <span class="skolem">r'</span><span class="main">)</span> <span class="main">∈</span> option_while' <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">C</span> <span class="bound">a</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">B</span> <span class="bound">a</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span><span class="skolem">r'</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> option_while'.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gets_the_conv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> wl'_Inl <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="main">(</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span><span class="main">,</span> None<span class="main">)</span> <span class="main">∈</span> whileLoop_results <span class="free">C</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> gets_the <span class="main">(</span><span class="free">B</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="skolem">r</span><span class="main">,</span> None<span class="main">)</span> <span class="main">∈</span> option_while' <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">C</span> <span class="bound">a</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">B</span> <span class="bound">a</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"None <span class="main">::</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> option<span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> option_while'.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gets_the_conv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> wl'_Inr <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">r'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="skolem">r</span><span class="main">,</span> Some <span class="skolem">r'</span><span class="main">)</span> <span class="main">∈</span> option_while' <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">C</span> <span class="bound">a</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">B</span> <span class="bound">a</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="main">(</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span><span class="main">,</span> Some <span class="main">(</span><span class="skolem">r'</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> whileLoop_results <span class="free">C</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> gets_the <span class="main">(</span><span class="free">B</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"Some <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"Some <span class="skolem">r'</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> whileLoop_results.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gets_the_conv<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> option_while'_Some <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="skolem">r</span><span class="main">,</span> None<span class="main">)</span> <span class="main">∈</span> option_while' <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">C</span> <span class="bound">a</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">B</span> <span class="bound">a</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="main">(</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span><span class="main">,</span> None<span class="main">)</span> <span class="main">∈</span> whileLoop_results <span class="free">C</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> gets_the <span class="main">(</span><span class="free">B</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"Some <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"None <span class="main">::</span> <span class="tfree">'a</span> option"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> whileLoop_results.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gets_the_conv<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> option_while'_None <span class="main">=</span> this

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> owhile <span class="free">C</span> <span class="free">B</span> <span class="free">r</span> <span class="bound">s</span> <span class="main">=</span> None
      <span class="main">⟹</span> whileLoop <span class="free">C</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> gets_the <span class="main">(</span><span class="free">B</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span> True<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> whileLoop_def owhile_def option_while_def option_while'_THE gets_the_loop_terminates
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> option_while'_None wl'_Inl option_while'_inj<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">r'</span><span class="main">.</span> owhile <span class="free">C</span> <span class="free">B</span> <span class="free">r</span> <span class="bound">s</span> <span class="main">=</span> Some <span class="bound">r'</span>
      <span class="main">⟹</span> whileLoop <span class="free">C</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> gets_the <span class="main">(</span><span class="free">B</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">r'</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span><span class="main">,</span> False<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> whileLoop_def owhile_def option_while_def option_while'_THE gets_the_loop_terminates
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wl'_Inl wl'_Inr option_while'_inj <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> option_while'_Some<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff gets_the_conv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="WP">
<div class="head">
<h1>Theory WP</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright 2014, NICTA
 *
 * This software may be distributed and modified according to the terms of
 * the BSD 2-Clause license. Note that NO WARRANTY is provided.
 * See "LICENSE_BSD2.txt" for details.
 *
 * @TAG(NICTA_BSD)
 *)</span>

<span class="keyword1"><span class="command">theory</span></span> WP
<span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">triple_judgement</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">triple_judgement</span> <span class="free"><span class="bound"><span class="entity">pre</span></span></span> <span class="free"><span class="bound"><span class="entity">body</span></span></span> <span class="free"><span class="bound"><span class="entity">property</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">pre</span></span></span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">property</span></span></span> <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">body</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">postcondition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> set<span class="main">)</span>
            <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">postcondition</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">rv</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">rv</span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">postconditions</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">postconditions</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹WP-method.ML›</span>

<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">wp_warn_unused</span> <span class="main"><span class="main">=</span></span> <span class="quasi_keyword">false</span><span class="main">]</span><span class="main">]</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="entity">WeakestPre.setup</span>

<span class="keyword1"><span class="command">method_setup</span></span> wp <span class="main">=</span> <span class="quoted">‹<span class="entity">WeakestPre.apply_rules_args</span> false›</span>
  <span class="quoted">"applies weakest precondition rules"</span>

<span class="keyword1"><span class="command">method_setup</span></span> wp_once <span class="main">=</span> <span class="quoted">‹<span class="entity">WeakestPre.apply_once_args</span> false›</span>
  <span class="quoted">"applies one weakest precondition rule"</span>

<span class="keyword1"><span class="command">method_setup</span></span> wp_trace <span class="main">=</span> <span class="quoted">‹<span class="entity">WeakestPre.apply_rules_args</span> true›</span>
  <span class="quoted">"applies weakest precondition rules with tracing"</span>

<span class="keyword1"><span class="command">method_setup</span></span> wp_once_trace <span class="main">=</span> <span class="quoted">‹<span class="entity">WeakestPre.apply_once_args</span> true›</span>
  <span class="quoted">"applies one weakest precondition rule with tracing"</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/WP-method.ML">
<div class="head">
<h1>File ‹WP-method.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright 2014, NICTA
 *
 * This software may be distributed and modified according to the terms of
 * the BSD 2-Clause license. Note that NO WARRANTY is provided.
 * See "LICENSE_BSD2.txt" for details.
 *
 * @TAG(NICTA_BSD)
 *)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">WP</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">wp_rules</span> <span class="main">=</span> <span class="main">{</span>trips<span class="main">:</span> thm list * <span class="main">(</span>theory <span class="main">-&gt;</span> term <span class="main">-&gt;</span> term<span class="main">)</span><span class="main">,</span>
    rules<span class="main">:</span> <span class="main">(</span>int * thm<span class="main">)</span> Net.net * int * <span class="main">(</span>int * thm<span class="main">)</span> list<span class="main">,</span>
    splits<span class="main">:</span> thm list<span class="main">,</span> combs<span class="main">:</span> thm list<span class="main">,</span> unsafe_rules<span class="main">:</span> thm list<span class="main">}</span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">val</span></span> debug_get<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">wp_rules</span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">val</span></span> derived_rule<span class="main">:</span> thm <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> thm list<span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> get_combined_rules'<span class="main">:</span> thm list <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> thm list<span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> get_combined_rules<span class="main">:</span> thm list <span class="main">-&gt;</span> thm list <span class="main">-&gt;</span> thm list<span class="main">;</span>

  <span class="keyword1"><span class="keyword">val</span></span> get_rules<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm list <span class="main">-&gt;</span> <span class="entity">wp_rules</span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">val</span></span> apply_rules_tac_n<span class="main">:</span> bool <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm list <span class="main">-&gt;</span> thm list Unsynchronized.ref
                      <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic<span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> apply_rules_tac<span class="main">:</span> bool <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm list <span class="main">-&gt;</span> thm list Unsynchronized.ref
                    <span class="main">-&gt;</span> tactic<span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> apply_rules_args<span class="main">:</span> bool <span class="main">-&gt;</span> <span class="main">(</span><span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">Method.method</span><span class="main">)</span> context_parser<span class="main">;</span>

  <span class="keyword1"><span class="keyword">val</span></span> apply_once_tac<span class="main">:</span> bool <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm list <span class="main">-&gt;</span> thm list Unsynchronized.ref
                   <span class="main">-&gt;</span> tactic<span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> apply_once_args<span class="main">:</span> bool <span class="main">-&gt;</span> <span class="main">(</span><span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">Method.method</span><span class="main">)</span> context_parser<span class="main">;</span>

  <span class="keyword1"><span class="keyword">val</span></span> setup<span class="main">:</span> theory <span class="main">-&gt;</span> theory<span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> warn_unused<span class="main">:</span> bool Config.T

  <span class="keyword1"><span class="keyword">val</span></span> wp_add<span class="main">:</span> Thm.attribute<span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> wp_del<span class="main">:</span> Thm.attribute<span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> splits_add<span class="main">:</span> Thm.attribute<span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> splits_del<span class="main">:</span> Thm.attribute<span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> combs_add<span class="main">:</span> Thm.attribute<span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> combs_del<span class="main">:</span> Thm.attribute<span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> wp_unsafe_add<span class="main">:</span> Thm.attribute<span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> wp_unsafe_del<span class="main">:</span> Thm.attribute<span class="main">;</span>
<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">WeakestPre</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">wp_rules</span> <span class="main">=</span> <span class="main">{</span>trips<span class="main">:</span> thm list * <span class="main">(</span>theory <span class="main">-&gt;</span> term <span class="main">-&gt;</span> term<span class="main">)</span><span class="main">,</span>
    rules<span class="main">:</span> <span class="main">(</span>int * thm<span class="main">)</span> Net.net * int * <span class="main">(</span>int * thm<span class="main">)</span> list<span class="main">,</span>
    splits<span class="main">:</span> thm list<span class="main">,</span> combs<span class="main">:</span> thm list<span class="main">,</span> unsafe_rules<span class="main">:</span> thm list<span class="main">}</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">accum_last_occurence'</span> <span class="main">[</span><span class="main">]</span> <span class="main">_</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> Termtab.empty<span class="main">)</span>
  <span class="main">|</span> <span class="entity">accum_last_occurence'</span> <span class="main">(</span><span class="main">(</span><span class="entity">t</span><span class="main">,</span> <span class="entity">v</span><span class="main">)</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="entity">tt1</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tm</span> <span class="main">=</span> Thm.prop_of <span class="entity">t</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tt2</span> <span class="main">=</span> Termtab.insert_list <span class="main">(</span>K false<span class="main">)</span> <span class="main">(</span><span class="entity">tm</span><span class="main">,</span> <span class="entity">v</span><span class="main">)</span> <span class="entity">tt1</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">ts'</span><span class="main">,</span> <span class="entity">tt3</span><span class="main">)</span> <span class="main">=</span> <span class="entity">accum_last_occurence'</span> <span class="entity">ts</span> <span class="entity">tt2</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">case</span></span> Termtab.lookup <span class="entity">tt3</span> <span class="entity">tm</span> <span class="keyword2"><span class="keyword">of</span></span>
        NONE <span class="main">=&gt;</span> <span class="main">(</span><span class="main">(</span><span class="entity">t</span><span class="main">,</span> Termtab.lookup_list <span class="entity">tt2</span> <span class="entity">tm</span><span class="main">)</span>  :: <span class="entity">ts'</span><span class="main">,</span>
                    Termtab.update <span class="main">(</span><span class="entity">tm</span><span class="main">,</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span> <span class="entity">tt3</span><span class="main">)</span>
      <span class="main">|</span> SOME <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">ts'</span><span class="main">,</span> <span class="entity">tt3</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">accum_last_occurence</span> <span class="entity">ts</span> <span class="main">=</span>
        fst <span class="main">(</span><span class="entity">accum_last_occurence'</span> <span class="entity">ts</span> Termtab.empty<span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">flat_last_occurence</span> <span class="entity">ts</span> <span class="main">=</span>
  map fst <span class="main">(</span><span class="entity">accum_last_occurence</span> <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">v</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">v</span><span class="main">,</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">ts</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_rules</span> <span class="main">(</span><span class="entity">trips</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="entity">others</span><span class="main">)</span> <span class="main">=</span>
  rev <span class="main">(</span>order_list <span class="main">(</span>Net.entries <span class="entity">trips</span> @ <span class="entity">others</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_key</span> <span class="entity">trip_conv</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t'</span> <span class="main">=</span> Thm.concl_of <span class="entity">t</span> |&gt; <span class="entity">trip_conv</span> <span class="main">(</span>Thm.theory_of_thm <span class="entity">t</span><span class="main">)</span>
        |&gt; Envir.beta_eta_contract<span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">t'</span> <span class="keyword2"><span class="keyword">of</span></span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Trueprop<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $
      <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> triple_judgement<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">_</span> $ <span class="entity">f</span> $ <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> SOME <span class="entity">f</span>
    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> NONE <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_rule_inner</span> <span class="entity">trip_conv</span> <span class="entity">t</span> <span class="main">(</span><span class="entity">trips</span><span class="main">,</span> <span class="entity">n</span><span class="main">,</span> <span class="entity">others</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">get_key</span> <span class="entity">trip_conv</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
      SOME <span class="entity">k</span> <span class="main">=&gt;</span> <span class="main">(</span>Net.insert_term <span class="main">(</span>K false<span class="main">)</span>
                 <span class="main">(</span><span class="entity">k</span><span class="main">,</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="entity">trips</span><span class="main">,</span> <span class="entity">n</span> + <span class="inner_numeral">1</span><span class="main">,</span> <span class="entity">others</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">trips</span><span class="main">,</span> <span class="entity">n</span> + <span class="inner_numeral">1</span><span class="main">,</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span> :: <span class="entity">others</span><span class="main">)</span>
  <span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">del_rule_inner</span> <span class="entity">trip_conv</span> <span class="entity">t</span> <span class="main">(</span><span class="entity">trips</span><span class="main">,</span> <span class="entity">n</span><span class="main">,</span> <span class="entity">others</span><span class="main">)</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">get_key</span> <span class="entity">trip_conv</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
      SOME <span class="entity">k</span> <span class="main">=&gt;</span> <span class="main">(</span>Net.delete_term_safe <span class="main">(</span>Thm.eq_thm_prop o apply2 snd<span class="main">)</span>
                 <span class="main">(</span><span class="entity">k</span><span class="main">,</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="entity">trips</span><span class="main">,</span> <span class="entity">n</span><span class="main">,</span> <span class="entity">others</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">trips</span><span class="main">,</span> <span class="entity">n</span><span class="main">,</span> remove <span class="main">(</span>Thm.eq_thm_prop o apply2 snd<span class="main">)</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span> <span class="entity">others</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">no_rules</span> <span class="main">=</span> <span class="main">(</span>Net.empty<span class="main">,</span> <span class="inner_numeral">0</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_rules</span> <span class="entity">trip_conv</span> <span class="entity">rules</span> <span class="main">=</span> fold_rev <span class="main">(</span><span class="entity">add_rule_inner</span> <span class="entity">trip_conv</span><span class="main">)</span> <span class="entity">rules</span> <span class="entity">no_rules</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_trip_conv</span> <span class="entity">trips</span> <span class="entity">thy</span> <span class="main">=</span> Pattern.rewrite_term <span class="entity">thy</span>
    <span class="main">(</span>map <span class="main">(</span>Thm.concl_of #&gt; <span class="entity">HOLogic.dest_Trueprop</span> #&gt; <span class="entity">HOLogic.dest_eq</span><span class="main">)</span> <span class="entity">trips</span><span class="main">)</span> <span class="main">[</span><span class="main">]</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rules_merge</span> <span class="main">(</span><span class="entity">wp_rules</span><span class="main">,</span> <span class="entity">wp_rules'</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">trips</span> <span class="main">=</span> Thm.merge_thms <span class="main">(</span>fst <span class="main">(</span><span class="main">#</span>trips <span class="entity">wp_rules</span><span class="main">)</span><span class="main">,</span> fst <span class="main">(</span><span class="main">#</span>trips <span class="entity">wp_rules'</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">trip_conv</span> <span class="main">=</span> <span class="entity">mk_trip_conv</span> <span class="entity">trips</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rules</span> <span class="main">=</span> <span class="entity">flat_last_occurence</span> <span class="main">(</span><span class="entity">dest_rules</span> <span class="main">(</span><span class="main">#</span>rules <span class="entity">wp_rules</span><span class="main">)</span> @ <span class="entity">dest_rules</span> <span class="main">(</span><span class="main">#</span>rules <span class="entity">wp_rules'</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="main">{</span>trips <span class="main">=</span> <span class="main">(</span><span class="entity">trips</span><span class="main">,</span> <span class="entity">trip_conv</span><span class="main">)</span><span class="main">,</span>
        rules <span class="main">=</span> <span class="entity">mk_rules</span> <span class="entity">trip_conv</span> <span class="entity">rules</span><span class="main">,</span>
        splits <span class="main">=</span> Thm.merge_thms <span class="main">(</span><span class="main">#</span>splits <span class="entity">wp_rules</span><span class="main">,</span> <span class="main">#</span>splits <span class="entity">wp_rules'</span><span class="main">)</span><span class="main">,</span>
        combs <span class="main">=</span> Thm.merge_thms <span class="main">(</span><span class="main">#</span>combs <span class="entity">wp_rules</span><span class="main">,</span> <span class="main">#</span>combs <span class="entity">wp_rules'</span><span class="main">)</span><span class="main">,</span>
        unsafe_rules <span class="main">=</span> Thm.merge_thms <span class="main">(</span><span class="main">#</span>unsafe_rules <span class="entity">wp_rules</span><span class="main">,</span> <span class="main">#</span>unsafe_rules <span class="entity">wp_rules'</span><span class="main">)</span><span class="main">}</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">WPData</span> <span class="main">=</span> Generic_Data
<span class="main">(</span><span class="keyword2"><span class="keyword">struct</span></span>
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> <span class="entity">wp_rules</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty</span> <span class="main">=</span> <span class="main">{</span>trips <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> K I<span class="main">)</span><span class="main">,</span> rules <span class="main">=</span> <span class="entity">no_rules</span><span class="main">,</span>
      splits <span class="main">=</span> <span class="main">[</span><span class="main">]</span><span class="main">,</span> combs <span class="main">=</span> <span class="main">[</span><span class="main">]</span><span class="main">,</span> unsafe_rules <span class="main">=</span> <span class="main">[</span><span class="main">]</span><span class="main">}</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">extend</span> <span class="main">=</span> I<span class="main">;</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">merge</span> <span class="main">=</span> <span class="entity">rules_merge</span><span class="main">;</span>
<span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">derived_rule</span> <span class="entity">rule</span> <span class="entity">combinator</span> <span class="main">=</span>
  <span class="main">[</span><span class="entity">rule</span> RSN <span class="main">(</span><span class="inner_numeral">1</span><span class="main">,</span> <span class="entity">combinator</span><span class="main">)</span><span class="main">]</span> <span class="keyword3"><span class="keyword">handle</span></span> THM <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_combined_rules'</span> <span class="entity">combs'</span> <span class="entity">rule</span> <span class="main">=</span>
  <span class="entity">rule</span> :: <span class="main">(</span>List.concat <span class="main">(</span>map <span class="main">(</span><span class="entity">derived_rule</span> <span class="entity">rule</span><span class="main">)</span> <span class="entity">combs'</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_combined_rules</span> <span class="entity">rules'</span> <span class="entity">combs'</span> <span class="main">=</span>
  List.concat <span class="main">(</span>map <span class="main">(</span><span class="entity">get_combined_rules'</span> <span class="entity">combs'</span><span class="main">)</span> <span class="entity">rules'</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_rule</span> <span class="entity">rule</span> <span class="entity">rs</span> <span class="main">=</span>
    <span class="main">{</span>trips <span class="main">=</span> <span class="main">#</span>trips <span class="entity">rs</span><span class="main">,</span>
      rules <span class="main">=</span> <span class="entity">add_rule_inner</span> <span class="main">(</span>snd <span class="main">(</span><span class="main">#</span>trips <span class="entity">rs</span><span class="main">)</span><span class="main">)</span> <span class="entity">rule</span> <span class="main">(</span><span class="main">#</span>rules <span class="entity">rs</span><span class="main">)</span><span class="main">,</span>
      splits <span class="main">=</span> <span class="main">#</span>splits <span class="entity">rs</span><span class="main">,</span> combs <span class="main">=</span> <span class="main">#</span>combs <span class="entity">rs</span><span class="main">,</span>
      unsafe_rules <span class="main">=</span> <span class="main">#</span>unsafe_rules <span class="entity">rs</span><span class="main">}</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">del_rule</span> <span class="entity">rule</span> <span class="entity">rs</span> <span class="main">=</span>
    <span class="main">{</span>trips <span class="main">=</span> <span class="main">#</span>trips <span class="entity">rs</span><span class="main">,</span>
      rules <span class="main">=</span> <span class="entity">del_rule_inner</span> <span class="main">(</span>snd <span class="main">(</span><span class="main">#</span>trips <span class="entity">rs</span><span class="main">)</span><span class="main">)</span> <span class="entity">rule</span> <span class="main">(</span><span class="main">#</span>rules <span class="entity">rs</span><span class="main">)</span><span class="main">,</span>
      splits <span class="main">=</span> <span class="main">#</span>splits <span class="entity">rs</span><span class="main">,</span> combs <span class="main">=</span> <span class="main">#</span>combs <span class="entity">rs</span><span class="main">,</span>
      unsafe_rules <span class="main">=</span> <span class="main">#</span>unsafe_rules <span class="entity">rs</span><span class="main">}</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_trip</span> <span class="entity">rule</span> <span class="main">(</span><span class="entity">rs</span> <span class="main">:</span> <span class="entity">wp_rules</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">trips</span> <span class="main">=</span> Thm.add_thm <span class="entity">rule</span> <span class="main">(</span>fst <span class="main">(</span><span class="main">#</span>trips <span class="entity">rs</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">trip_conv</span> <span class="main">=</span> <span class="entity">mk_trip_conv</span> <span class="entity">trips</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="main">{</span>trips <span class="main">=</span> <span class="main">(</span><span class="entity">trips</span><span class="main">,</span> <span class="entity">trip_conv</span><span class="main">)</span><span class="main">,</span>
      rules <span class="main">=</span> <span class="entity">mk_rules</span> <span class="entity">trip_conv</span> <span class="main">(</span><span class="entity">dest_rules</span> <span class="main">(</span><span class="main">#</span>rules <span class="entity">rs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      splits <span class="main">=</span> <span class="main">#</span>splits <span class="entity">rs</span><span class="main">,</span> combs <span class="main">=</span> <span class="main">#</span>combs <span class="entity">rs</span><span class="main">,</span>
      unsafe_rules <span class="main">=</span> <span class="main">#</span>unsafe_rules <span class="entity">rs</span><span class="main">}</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">del_trip</span> <span class="entity">rule</span> <span class="main">(</span><span class="entity">rs</span> <span class="main">:</span> <span class="entity">wp_rules</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">trips</span> <span class="main">=</span> Thm.del_thm <span class="entity">rule</span> <span class="main">(</span>fst <span class="main">(</span><span class="main">#</span>trips <span class="entity">rs</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">trip_conv</span> <span class="main">=</span> <span class="entity">mk_trip_conv</span> <span class="entity">trips</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="main">{</span>trips <span class="main">=</span> <span class="main">(</span><span class="entity">trips</span><span class="main">,</span> <span class="entity">trip_conv</span><span class="main">)</span><span class="main">,</span>
      rules <span class="main">=</span> <span class="entity">mk_rules</span> <span class="entity">trip_conv</span> <span class="main">(</span><span class="entity">dest_rules</span> <span class="main">(</span><span class="main">#</span>rules <span class="entity">rs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      splits <span class="main">=</span> <span class="main">#</span>splits <span class="entity">rs</span><span class="main">,</span> combs <span class="main">=</span> <span class="main">#</span>combs <span class="entity">rs</span><span class="main">,</span>
      unsafe_rules <span class="main">=</span> <span class="main">#</span>unsafe_rules <span class="entity">rs</span><span class="main">}</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_split</span> <span class="entity">rule</span> <span class="main">(</span><span class="entity">rs</span> <span class="main">:</span> <span class="entity">wp_rules</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">{</span>trips <span class="main">=</span> <span class="main">#</span>trips <span class="entity">rs</span><span class="main">,</span> rules <span class="main">=</span> <span class="main">#</span>rules <span class="entity">rs</span><span class="main">,</span>
      splits <span class="main">=</span> Thm.add_thm <span class="entity">rule</span> <span class="main">(</span><span class="main">#</span>splits <span class="entity">rs</span><span class="main">)</span><span class="main">,</span> combs <span class="main">=</span> <span class="main">#</span>combs <span class="entity">rs</span><span class="main">,</span>
      unsafe_rules <span class="main">=</span> <span class="main">#</span>unsafe_rules <span class="entity">rs</span><span class="main">}</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_comb</span> <span class="entity">rule</span> <span class="main">(</span><span class="entity">rs</span> <span class="main">:</span> <span class="entity">wp_rules</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">{</span>trips <span class="main">=</span> <span class="main">#</span>trips <span class="entity">rs</span><span class="main">,</span> rules <span class="main">=</span> <span class="main">#</span>rules <span class="entity">rs</span><span class="main">,</span>
      splits <span class="main">=</span> <span class="main">#</span>splits <span class="entity">rs</span><span class="main">,</span> combs <span class="main">=</span> Thm.add_thm <span class="entity">rule</span> <span class="main">(</span><span class="main">#</span>combs <span class="entity">rs</span><span class="main">)</span><span class="main">,</span>
      unsafe_rules <span class="main">=</span> <span class="main">#</span>unsafe_rules <span class="entity">rs</span><span class="main">}</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">del_split</span> <span class="entity">rule</span> <span class="entity">rs</span> <span class="main">=</span>
    <span class="main">{</span>trips <span class="main">=</span> <span class="main">#</span>trips <span class="entity">rs</span><span class="main">,</span> rules <span class="main">=</span> <span class="main">#</span>rules <span class="entity">rs</span><span class="main">,</span>
      splits <span class="main">=</span> Thm.del_thm <span class="entity">rule</span> <span class="main">(</span><span class="main">#</span>splits <span class="entity">rs</span><span class="main">)</span><span class="main">,</span> combs <span class="main">=</span> <span class="main">#</span>combs <span class="entity">rs</span><span class="main">,</span>
      unsafe_rules <span class="main">=</span> <span class="main">#</span>unsafe_rules <span class="entity">rs</span><span class="main">}</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">del_comb</span> <span class="entity">rule</span> <span class="entity">rs</span> <span class="main">=</span>
    <span class="main">{</span>trips <span class="main">=</span> <span class="main">#</span>trips <span class="entity">rs</span><span class="main">,</span> rules <span class="main">=</span> <span class="main">#</span>rules <span class="entity">rs</span><span class="main">,</span>
      splits <span class="main">=</span> <span class="main">#</span>splits <span class="entity">rs</span><span class="main">,</span> combs <span class="main">=</span> Thm.del_thm <span class="entity">rule</span> <span class="main">(</span><span class="main">#</span>combs <span class="entity">rs</span><span class="main">)</span><span class="main">,</span>
      unsafe_rules <span class="main">=</span> <span class="main">#</span>unsafe_rules <span class="entity">rs</span><span class="main">}</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_unsafe_rule</span> <span class="entity">rule</span> <span class="entity">rs</span> <span class="main">=</span>
    <span class="main">{</span>trips <span class="main">=</span> <span class="main">#</span>trips <span class="entity">rs</span><span class="main">,</span> rules <span class="main">=</span> <span class="main">#</span>rules <span class="entity">rs</span><span class="main">,</span>
      splits <span class="main">=</span> <span class="main">#</span>splits <span class="entity">rs</span><span class="main">,</span> combs <span class="main">=</span> <span class="main">#</span>combs <span class="entity">rs</span><span class="main">,</span>
      unsafe_rules <span class="main">=</span> Thm.add_thm <span class="entity">rule</span> <span class="main">(</span><span class="main">#</span>unsafe_rules <span class="entity">rs</span><span class="main">)</span><span class="main">}</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">del_unsafe_rule</span> <span class="entity">rule</span> <span class="entity">rs</span> <span class="main">=</span>
    <span class="main">{</span>trips <span class="main">=</span> <span class="main">#</span>trips <span class="entity">rs</span><span class="main">,</span> rules <span class="main">=</span> <span class="main">#</span>rules <span class="entity">rs</span><span class="main">,</span>
      splits <span class="main">=</span> <span class="main">#</span>splits <span class="entity">rs</span><span class="main">,</span> combs <span class="main">=</span> <span class="main">#</span>combs <span class="entity">rs</span><span class="main">,</span>
      unsafe_rules <span class="main">=</span> Thm.del_thm <span class="entity">rule</span> <span class="main">(</span><span class="main">#</span>unsafe_rules <span class="entity">rs</span><span class="main">)</span><span class="main">}</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_att</span> <span class="entity">m</span> <span class="main">=</span> Thm.declaration_attribute <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">context</span> <span class="main">=&gt;</span>
    WPData.map <span class="main">(</span><span class="entity">m</span> <span class="entity">thm</span><span class="main">)</span> <span class="entity">context</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">wp_add</span> <span class="main">=</span> <span class="entity">gen_att</span> <span class="entity">add_rule</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">wp_del</span> <span class="main">=</span> <span class="entity">gen_att</span> <span class="entity">del_rule</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">trip_add</span> <span class="main">=</span> <span class="entity">gen_att</span> <span class="entity">add_trip</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">trip_del</span> <span class="main">=</span> <span class="entity">gen_att</span> <span class="entity">del_trip</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">splits_add</span> <span class="main">=</span> <span class="entity">gen_att</span> <span class="entity">add_split</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">splits_del</span> <span class="main">=</span> <span class="entity">gen_att</span> <span class="entity">del_split</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">combs_add</span> <span class="main">=</span> <span class="entity">gen_att</span> <span class="entity">add_comb</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">combs_del</span> <span class="main">=</span> <span class="entity">gen_att</span> <span class="entity">del_comb</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">wp_unsafe_add</span> <span class="main">=</span> <span class="entity">gen_att</span> <span class="entity">add_unsafe_rule</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">wp_unsafe_del</span> <span class="main">=</span> <span class="entity">gen_att</span> <span class="entity">del_unsafe_rule</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">setup</span> <span class="main">=</span>
      <span class="entity">Attrib.setup</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> "wp"<span class="antiquote">}</span></span></span>
          <span class="main">(</span><span class="entity">Attrib.add_del</span> <span class="entity">wp_add</span> <span class="entity">wp_del</span><span class="main">)</span>
          <span class="inner_quoted">"monadic weakest precondition rules"</span>
      #&gt; <span class="entity">Attrib.setup</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> "wp_trip"<span class="antiquote">}</span></span></span>
          <span class="main">(</span><span class="entity">Attrib.add_del</span> <span class="entity">trip_add</span> <span class="entity">trip_del</span><span class="main">)</span>
          <span class="inner_quoted">"monadic triple conversion rules"</span>
      #&gt; <span class="entity">Attrib.setup</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> "wp_split"<span class="antiquote">}</span></span></span>
          <span class="main">(</span><span class="entity">Attrib.add_del</span> <span class="entity">splits_add</span> <span class="entity">splits_del</span><span class="main">)</span>
          <span class="inner_quoted">"monadic split rules"</span>
      #&gt; <span class="entity">Attrib.setup</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> "wp_comb"<span class="antiquote">}</span></span></span>
          <span class="main">(</span><span class="entity">Attrib.add_del</span> <span class="entity">combs_add</span> <span class="entity">combs_del</span><span class="main">)</span>
          <span class="inner_quoted">"monadic combination rules"</span>
      #&gt; <span class="entity">Attrib.setup</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> "wp_unsafe"<span class="antiquote">}</span></span></span>
          <span class="main">(</span><span class="entity">Attrib.add_del</span> <span class="entity">wp_unsafe_add</span> <span class="entity">wp_unsafe_del</span><span class="main">)</span>
          <span class="inner_quoted">"unsafe monadic weakest precondition rules"</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">debug_get</span> <span class="entity">ctxt</span> <span class="main">=</span> WPData.get <span class="main">(</span>Context.Proof <span class="entity">ctxt</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_rules</span> <span class="entity">ctxt</span> <span class="entity">extras</span> <span class="main">=</span> fold_rev <span class="entity">add_rule</span> <span class="entity">extras</span> <span class="main">(</span><span class="entity">debug_get</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">append_used_rule</span> <span class="entity">rule</span> <span class="entity">used_rules</span> <span class="main">=</span> <span class="entity">used_rules</span> := !<span class="entity">used_rules</span> @ <span class="main">[</span><span class="entity">rule</span><span class="main">]</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_extra_rule</span> <span class="entity">rule</span> <span class="entity">extra_rules</span> <span class="main">=</span> <span class="entity">extra_rules</span> := !<span class="entity">extra_rules</span> @ <span class="main">[</span><span class="entity">rule</span><span class="main">]</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">resolve_ruleset_tac</span> <span class="entity">ctxt</span> <span class="entity">rs</span> <span class="entity">used_rules_ref</span> <span class="entity">n</span> <span class="entity">t</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">append_rule</span> <span class="entity">rule</span> <span class="entity">thm</span> <span class="main">=</span> Seq.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">append_used_rule</span> <span class="entity">rule</span> <span class="entity">used_rules_ref</span><span class="main">;</span> <span class="entity">thm</span><span class="main">)</span><span class="main">)</span> <span class="entity">thm</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rtac</span> <span class="entity">th</span> <span class="main">=</span> resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">th</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">case</span></span>
    Thm.cprem_of <span class="entity">t</span> <span class="entity">n</span> |&gt; Thm.term_of |&gt; snd <span class="main">(</span><span class="main">#</span>trips <span class="entity">rs</span><span class="main">)</span> <span class="main">(</span>Thm.theory_of_thm <span class="entity">t</span><span class="main">)</span>
        |&gt; Envir.beta_eta_contract |&gt; Logic.strip_assums_concl
     <span class="keyword3"><span class="keyword">handle</span></span> THM <span class="main">_</span> <span class="main">=&gt;</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> True<span class="antiquote">}</span></span>
  <span class="keyword2"><span class="keyword">of</span></span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Trueprop<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $
      <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> triple_judgement<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">_</span> $ <span class="entity">f</span> $ <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ts</span> <span class="main">=</span> Net.unify_term <span class="main">(</span><span class="main">#</span><span class="inner_numeral">1</span> <span class="main">(</span><span class="main">#</span>rules <span class="entity">rs</span><span class="main">)</span><span class="main">)</span> <span class="entity">f</span> |&gt; order_list |&gt; rev<span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">combapps</span> <span class="main">=</span> Seq.maps <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">combapp</span> <span class="main">=&gt;</span> Seq.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">combapp'</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">combapp</span><span class="main">,</span> <span class="entity">combapp'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">rtac</span> <span class="entity">combapp</span> <span class="entity">n</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span>
                                <span class="main">(</span>Seq.of_list <span class="main">(</span><span class="main">#</span>combs <span class="entity">rs</span><span class="main">)</span><span class="main">)</span> |&gt; Seq.list_of |&gt; Seq.of_list<span class="main">;</span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">per_rule_tac</span> <span class="entity">t</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="entity">append_rule</span> <span class="entity">t</span> <span class="main">(</span><span class="entity">rtac</span> <span class="entity">t</span> <span class="entity">n</span> <span class="entity">thm</span><span class="main">)</span><span class="main">)</span> ORELSE
                             <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> Seq.maps <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">combapp</span> <span class="main">=&gt;</span> <span class="entity">append_rule</span> <span class="entity">t</span>
                                        <span class="main">(</span><span class="entity">append_rule</span> <span class="main">(</span><span class="main">#</span><span class="inner_numeral">1</span> <span class="entity">combapp</span><span class="main">)</span> <span class="main">(</span><span class="entity">rtac</span> <span class="entity">t</span> <span class="entity">n</span> <span class="main">(</span><span class="main">#</span><span class="inner_numeral">2</span> <span class="entity">combapp</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">combapps</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword2"><span class="keyword">in</span></span> FIRST <span class="main">(</span>map <span class="entity">per_rule_tac</span> <span class="entity">ts</span><span class="main">)</span> ORELSE
         FIRST <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">split</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="entity">append_rule</span> <span class="entity">split</span> <span class="main">(</span><span class="entity">rtac</span> <span class="entity">split</span> <span class="entity">n</span> <span class="entity">thm</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">#</span>splits <span class="entity">rs</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span> <span class="entity">t</span>
    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> FIRST <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">rule</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="entity">append_rule</span> <span class="entity">rule</span> <span class="main">(</span><span class="entity">rtac</span> <span class="entity">rule</span> <span class="entity">n</span> <span class="entity">thm</span><span class="main">)</span><span class="main">)</span>
                      <span class="main">(</span>map snd <span class="main">(</span><span class="main">#</span><span class="inner_numeral">3</span> <span class="main">(</span><span class="main">#</span>rules <span class="entity">rs</span><span class="main">)</span><span class="main">)</span> @ <span class="main">#</span>splits <span class="entity">rs</span><span class="main">)</span><span class="main">)</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pretty_rule</span> <span class="entity">ctxt</span> <span class="entity">rule</span> <span class="main">=</span>
  Pretty.big_list <span class="main">(</span>Thm.get_name_hint <span class="entity">rule</span><span class="main">)</span> <span class="main">[</span>Thm.pretty_thm <span class="entity">ctxt</span> <span class="entity">rule</span><span class="main">]</span>
           |&gt; Pretty.string_of<span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">trace_used_thms</span> false <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> Seq.empty
  <span class="main">|</span> <span class="entity">trace_used_thms</span> true <span class="entity">used_rules</span> <span class="entity">ctxt</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">used_thms</span> <span class="main">=</span> !<span class="entity">used_rules</span>
      <span class="keyword2"><span class="keyword">in</span></span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">rule</span> <span class="main">=&gt;</span> tracing <span class="main">(</span><span class="entity">pretty_rule</span> <span class="entity">ctxt</span> <span class="entity">rule</span><span class="main">)</span><span class="main">)</span> <span class="entity">used_thms</span>
        |&gt; Seq.of_list <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">warn_unused</span> <span class="main">=</span> <span class="entity">Attrib.setup_config_bool</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> wp_warn_unused<span class="antiquote">}</span></span></span> <span class="main">(</span>K false<span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">warn_unused_thms</span> <span class="entity">ctxt</span> <span class="entity">thms</span> <span class="entity">extra_rules</span> <span class="entity">used_rules</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> Config.get <span class="entity">ctxt</span> <span class="entity">warn_unused</span>
  <span class="keyword2"><span class="keyword">then</span></span>
    <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">used_thms</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">rule</span> <span class="main">=&gt;</span> Thm.get_name_hint <span class="entity">rule</span><span class="main">)</span> <span class="main">(</span>!<span class="entity">used_rules</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">unused_thms</span> <span class="main">=</span> map Thm.get_name_hint <span class="main">(</span>!<span class="entity">extra_rules</span> @ <span class="entity">thms</span><span class="main">)</span> |&gt; subtract <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="entity">used_thms</span>
    <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span>null <span class="entity">unused_thms</span><span class="main">)</span>
       <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_quoted">"Unused theorems: "</span> ^ commas_quote <span class="entity">unused_thms</span> |&gt; warning
       <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">warn_unsafe_thms</span> <span class="entity">unsafe_thms</span> <span class="entity">n</span> <span class="entity">ctxt</span> <span class="entity">t</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">used_rules</span> <span class="main">=</span> Unsynchronized.ref <span class="main">[</span><span class="main">]</span> <span class="main">:</span> thm list Unsynchronized.ref<span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">useful_unsafe_thms</span> <span class="main">=</span>
          filter <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">rule</span> <span class="main">=&gt;</span>
            <span class="main">(</span>is_some o SINGLE <span class="main">(</span>
              <span class="entity">resolve_ruleset_tac</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">get_rules</span> <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">rule</span><span class="main">]</span><span class="main">)</span> <span class="entity">used_rules</span> <span class="entity">n</span><span class="main">)</span><span class="main">)</span> <span class="entity">t</span><span class="main">)</span> <span class="entity">unsafe_thms</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">unsafe_thm_names</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">rule</span> <span class="main">=&gt;</span> Thm.get_name_hint <span class="entity">rule</span><span class="main">)</span> <span class="entity">useful_unsafe_thms</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span>null <span class="entity">unsafe_thm_names</span><span class="main">)</span>
     <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_quoted">"Unsafe theorems that could be used: "</span> ^ commas_quote <span class="entity">unsafe_thm_names</span> |&gt; warning
     <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">apply_rules_tac_n</span> <span class="entity">trace</span> <span class="entity">ctxt</span> <span class="entity">extras</span> <span class="entity">extras_ref</span> <span class="entity">n</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">let</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rules</span> <span class="main">=</span> <span class="entity">get_rules</span> <span class="entity">ctxt</span> <span class="entity">extras</span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">used_rules</span> <span class="main">=</span> Unsynchronized.ref <span class="main">[</span><span class="main">]</span> <span class="main">:</span> thm list Unsynchronized.ref
<span class="keyword2"><span class="keyword">in</span></span>
  <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">t</span> <span class="main">=&gt;</span> Seq.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">warn_unused_thms</span> <span class="entity">ctxt</span> <span class="entity">extras</span> <span class="entity">extras_ref</span> <span class="entity">used_rules</span><span class="main">;</span>
                               <span class="entity">trace_used_thms</span> <span class="entity">trace</span> <span class="entity">used_rules</span> <span class="entity">ctxt</span><span class="main">;</span> <span class="entity">thm</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>CHANGED <span class="main">(</span>REPEAT_DETERM <span class="main">(</span><span class="entity">resolve_ruleset_tac</span> <span class="entity">ctxt</span> <span class="entity">rules</span> <span class="entity">used_rules</span> <span class="entity">n</span><span class="main">)</span><span class="main">)</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span> THEN_ELSE
  <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">t</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">warn_unsafe_thms</span> <span class="main">(</span><span class="main">#</span>unsafe_rules <span class="entity">rules</span><span class="main">)</span> <span class="entity">n</span> <span class="entity">ctxt</span> <span class="entity">t</span><span class="main">;</span> all_tac <span class="entity">t</span><span class="main">)</span><span class="main">,</span>
  <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">t</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">warn_unsafe_thms</span> <span class="main">(</span><span class="main">#</span>unsafe_rules <span class="entity">rules</span><span class="main">)</span> <span class="entity">n</span> <span class="entity">ctxt</span> <span class="entity">t</span><span class="main">;</span> no_tac <span class="entity">t</span><span class="main">)</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">apply_rules_tac</span> <span class="entity">trace</span> <span class="entity">ctxt</span> <span class="entity">extras</span> <span class="entity">extras_ref</span> <span class="main">=</span> <span class="entity">apply_rules_tac_n</span> <span class="entity">trace</span> <span class="entity">ctxt</span> <span class="entity">extras</span> <span class="entity">extras_ref</span> <span class="inner_numeral">1</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">apply_once_tac</span> <span class="entity">trace</span> <span class="entity">ctxt</span> <span class="entity">extras</span> <span class="entity">extras_ref</span> <span class="entity">t</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">used_rules</span> <span class="main">=</span> Unsynchronized.ref <span class="main">[</span><span class="main">]</span> <span class="main">:</span> thm list Unsynchronized.ref<span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span> Seq.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">warn_unused_thms</span> <span class="entity">ctxt</span> <span class="entity">extras</span> <span class="entity">extras_ref</span> <span class="entity">used_rules</span><span class="main">;</span>
                         <span class="entity">trace_used_thms</span> <span class="entity">trace</span> <span class="entity">used_rules</span> <span class="entity">ctxt</span><span class="main">;</span> <span class="entity">thm</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="entity">resolve_ruleset_tac</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">get_rules</span> <span class="entity">ctxt</span> <span class="entity">extras</span><span class="main">)</span> <span class="entity">used_rules</span> <span class="inner_numeral">1</span> <span class="entity">t</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">clear_rules</span> <span class="main">(</span><span class="main">{</span><span class="entity">combs</span><span class="main">,</span> rules<span class="main">=</span><span class="main">_</span><span class="main">,</span> <span class="entity">trips</span><span class="main">,</span> <span class="entity">splits</span><span class="main">,</span> <span class="entity">unsafe_rules</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">{</span>combs<span class="main">=</span><span class="entity">combs</span><span class="main">,</span> rules<span class="main">=</span><span class="entity">no_rules</span><span class="main">,</span> trips<span class="main">=</span><span class="entity">trips</span><span class="main">,</span> splits<span class="main">=</span><span class="entity">splits</span><span class="main">,</span> unsafe_rules<span class="main">=</span><span class="entity">unsafe_rules</span><span class="main">}</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">wp_modifiers</span> <span class="entity">extras_ref</span> <span class="main">=</span>
 <span class="main">[</span>Args.add -- Args.colon &gt;&gt; K <span class="main">(</span>I<span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">att</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">add_extra_rule</span> <span class="main">(</span><span class="main">#</span><span class="inner_numeral">2</span> <span class="entity">att</span><span class="main">)</span> <span class="entity">extras_ref</span><span class="main">;</span> <span class="entity">wp_add</span> <span class="entity">att</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
  Args.del -- Args.colon &gt;&gt; K <span class="main">(</span>I<span class="main">,</span> <span class="entity">wp_del</span><span class="main">)</span><span class="main">,</span>
  Args.$$$ <span class="inner_quoted">"comb"</span> -- Args.colon &gt;&gt; K <span class="main">(</span>I<span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">att</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">add_extra_rule</span> <span class="main">(</span><span class="main">#</span><span class="inner_numeral">2</span> <span class="entity">att</span><span class="main">)</span> <span class="entity">extras_ref</span><span class="main">;</span> <span class="entity">combs_add</span> <span class="entity">att</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
  Args.$$$ <span class="inner_quoted">"comb"</span> -- Args.add -- Args.colon &gt;&gt; K <span class="main">(</span>I<span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">att</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">add_extra_rule</span> <span class="main">(</span><span class="main">#</span><span class="inner_numeral">2</span> <span class="entity">att</span><span class="main">)</span> <span class="entity">extras_ref</span><span class="main">;</span> <span class="entity">combs_add</span> <span class="entity">att</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
  Args.$$$ <span class="inner_quoted">"comb"</span> -- Args.del -- Args.colon &gt;&gt; K <span class="main">(</span>I<span class="main">,</span> <span class="entity">combs_del</span><span class="main">)</span><span class="main">,</span>
  Args.$$$ <span class="inner_quoted">"only"</span> -- Args.colon
    &gt;&gt; K <span class="main">(</span>Context.proof_map <span class="main">(</span>WPData.map <span class="entity">clear_rules</span><span class="main">)</span><span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">att</span> <span class="main">=&gt;</span>
                               <span class="main">(</span><span class="entity">add_extra_rule</span> <span class="main">(</span><span class="main">#</span><span class="inner_numeral">2</span> <span class="entity">att</span><span class="main">)</span> <span class="entity">extras_ref</span><span class="main">;</span> <span class="entity">wp_add</span> <span class="entity">att</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">has_colon</span> <span class="entity">xs</span> <span class="main">=</span> exists <span class="main">(</span>Token.keyword_with <span class="main">(</span>curry <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="inner_quoted">":"</span><span class="main">)</span><span class="main">)</span> <span class="entity">xs</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">if_colon</span> <span class="entity">scan1</span> <span class="entity">scan2</span> <span class="entity">xs</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">has_colon</span> <span class="main">(</span>snd <span class="entity">xs</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">scan1</span> <span class="entity">xs</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">scan2</span> <span class="entity">xs</span><span class="main">;</span>

<span class="comment1">(* FIXME: It would be nice if we could just use Method.sections, but to maintain
   compatability we require that the order of thms in each section is reversed. *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">thms</span> <span class="entity">ss</span> <span class="main">=</span> Scan.repeat <span class="main">(</span>Scan.unless <span class="main">(</span>Scan.lift <span class="main">(</span>Scan.first <span class="entity">ss</span><span class="main">)</span><span class="main">)</span> <span class="entity">Attrib.multi_thm</span><span class="main">)</span> &gt;&gt; flat<span class="main">;</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">app</span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span> <span class="entity">att</span><span class="main">)</span> <span class="entity">ths</span> <span class="entity">context</span> <span class="main">=</span> fold_map <span class="main">(</span>Thm.apply_attribute <span class="entity">att</span><span class="main">)</span> <span class="entity">ths</span> <span class="main">(</span>Context.map_proof <span class="entity">f</span> <span class="entity">context</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">section</span> <span class="entity">ss</span> <span class="main">=</span> Scan.depend <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">context</span> <span class="main">=&gt;</span> <span class="main">(</span>Scan.first <span class="entity">ss</span> -- Scan.pass <span class="entity">context</span> <span class="main">(</span><span class="entity">thms</span> <span class="entity">ss</span><span class="main">)</span><span class="main">)</span> :|--
  <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">m</span><span class="main">,</span> <span class="entity">ths</span><span class="main">)</span> <span class="main">=&gt;</span> Scan.succeed <span class="main">(</span>swap <span class="main">(</span><span class="entity">app</span> <span class="entity">m</span> <span class="main">(</span>rev <span class="entity">ths</span><span class="main">)</span> <span class="entity">context</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sections</span> <span class="entity">ss</span> <span class="main">=</span> Scan.repeat <span class="main">(</span><span class="entity">section</span> <span class="entity">ss</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">apply_rules_args</span> <span class="entity">trace</span> <span class="entity">xs</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">extras_ref</span> <span class="main">=</span> Unsynchronized.ref <span class="main">[</span><span class="main">]</span> <span class="main">:</span> thm list Unsynchronized.ref<span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">if_colon</span>
    <span class="main">(</span><span class="entity">sections</span> <span class="main">(</span><span class="entity">wp_modifiers</span> <span class="entity">extras_ref</span><span class="main">)</span> &gt;&gt;
      K <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD</span> <span class="main">(</span><span class="entity">apply_rules_tac</span> <span class="entity">trace</span> <span class="entity">ctxt</span> <span class="main">[</span><span class="main">]</span> <span class="entity">extras_ref</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="entity">Attrib.thms</span> &gt;&gt; curry <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">extras</span><span class="main">,</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="main">=&gt;</span>
      <span class="entity">Method.SIMPLE_METHOD</span> <span class="main">(</span>
        <span class="entity">apply_rules_tac</span> <span class="entity">trace</span> <span class="entity">ctxt</span> <span class="entity">extras</span> <span class="entity">extras_ref</span>
      <span class="main">)</span>
    <span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span> <span class="entity">xs</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">apply_once_args</span> <span class="entity">trace</span> <span class="entity">xs</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">extras_ref</span> <span class="main">=</span> Unsynchronized.ref <span class="main">[</span><span class="main">]</span> <span class="main">:</span> thm list Unsynchronized.ref<span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">if_colon</span>
    <span class="main">(</span><span class="entity">sections</span> <span class="main">(</span><span class="entity">wp_modifiers</span> <span class="entity">extras_ref</span><span class="main">)</span> &gt;&gt;
      K <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD</span> <span class="main">(</span><span class="entity">apply_once_tac</span> <span class="entity">trace</span> <span class="entity">ctxt</span> <span class="main">[</span><span class="main">]</span> <span class="entity">extras_ref</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="entity">Attrib.thms</span> &gt;&gt; curry <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">extras</span><span class="main">,</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="main">=&gt;</span>
      <span class="entity">Method.SIMPLE_METHOD</span> <span class="main">(</span>
        <span class="entity">apply_once_tac</span> <span class="entity">trace</span> <span class="entity">ctxt</span> <span class="entity">extras</span> <span class="entity">extras_ref</span>
      <span class="main">)</span>
    <span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span> <span class="entity">xs</span><span class="main">;</span>

<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">WeakestPreInst</span> <span class="main">:</span> <span class="entity">WP</span> <span class="main">=</span> WeakestPre<span class="main">;</span>
</pre>
</div><div id="OptionMonadWP">
<div class="head">
<h1>Theory OptionMonadWP</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright 2014, NICTA
 *
 * This software may be distributed and modified according to the terms of
 * the BSD 2-Clause license. Note that NO WARRANTY is provided.
 * See "LICENSE_BSD2.txt" for details.
 *
 * @TAG(NICTA_BSD)
 *)</span>

<span class="comment1">(*
Hoare reasoning and WP (weakest-precondition) generator rules for the option monad.

This list is almost certainly incomplete; add rules here as they are needed.
*)</span>

<span class="keyword1"><span class="command">theory</span></span> OptionMonadWP
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#OptionMonadND">OptionMonadND</a>
  <span class="quoted">"<a href="#WP">wp/WP</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> K_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="comment1">(* Hoare triples.
   TODO: design a sensible syntax for them. *)</span>

<span class="comment1">(* Partial correctness. *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ovalid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ovalid</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">r</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span> <span class="main">=</span> Some <span class="bound">r</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">r</span> <span class="bound">s</span>"</span></span>
<span class="comment1">(* Total correctness. *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ovalidNF</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ovalidNF</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span> <span class="main">≠</span> None <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span> <span class="main">=</span> Some <span class="bound">r</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">r</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">(* Termination. *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">no_ofail</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">no_ofail</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span> <span class="main">≠</span> None"</span></span>

<span class="comment1">(*
This rule lets us apply ovalidNF machinery for proving no_ofail.
However, we ought to eventually write working wp rules for no_ofail (see below).
*)</span>
<span class="keyword1" id="OptionMonadWP-no_ofail_is_ovalidNF"><span class="command">lemma</span></span> no_ofail_is_ovalidNF<span class="main">:</span> <span class="quoted"><span class="quoted">"no_ofail <span class="free">P</span> <span class="free">f</span> <span class="main">≡</span> ovalidNF <span class="free">P</span> <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_ofail_def ovalidNF_def<span class="main">)</span>
<span class="keyword1" id="OptionMonadWP-ovalidNF_combine"><span class="command">lemma</span></span> ovalidNF_combine<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> ovalid <span class="free">P</span> <span class="free">f</span> <span class="free">Q</span><span class="main">;</span> no_ofail <span class="free">P</span> <span class="free">f</span> <span class="main">⟧</span> <span class="main">⟹</span> ovalidNF <span class="free">P</span> <span class="free">f</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ovalidNF_def ovalid_def no_ofail_def<span class="main">)</span>


<span class="comment1">(* Annotating programs with loop invariant and measure. *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">owhile_inv</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span>
   <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">owhile_inv</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> owhile <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>  

<span class="keyword1"><span class="command">lemmas</span></span> owhile_add_inv <span class="main">=</span> owhile_inv_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>


<span class="comment1">(* WP rules for ovalid. *)</span>
<span class="keyword1" id="OptionMonadWP-obind_wp"><span class="command">lemma</span></span> obind_wp <span class="main">[</span><span class="operator">wp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> ovalid <span class="main">(</span><span class="free">R</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">r</span><span class="main">)</span> <span class="free">Q</span><span class="main">;</span> ovalid <span class="free">P</span> <span class="free">f</span> <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> ovalid <span class="free">P</span> <span class="main">(</span>obind <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ovalid_def obind_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-oreturn_wp"><span class="command">lemma</span></span> oreturn_wp <span class="main">[</span><span class="operator">wp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ovalid <span class="main">(</span><span class="free">P</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>oreturn <span class="free">x</span><span class="main">)</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ovalid_def oreturn_def K_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-ocondition_wp"><span class="command">lemma</span></span> ocondition_wp <span class="main">[</span><span class="operator">wp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> ovalid <span class="free">L</span> <span class="free">l</span> <span class="free">Q</span><span class="main">;</span> ovalid <span class="free">R</span> <span class="free">r</span> <span class="free">Q</span> <span class="main">⟧</span>
   <span class="main">⟹</span> ovalid <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">C</span> <span class="bound">s</span> <span class="keyword1">then</span> <span class="free">L</span> <span class="bound">s</span> <span class="keyword1">else</span> <span class="free">R</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>ocondition <span class="free">C</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ovalid_def ocondition_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-ofail_wp"><span class="command">lemma</span></span> ofail_wp <span class="main">[</span><span class="operator">wp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ovalid <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> ofail <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ovalid_def ofail_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-ovalid_K_bind_wp"><span class="command">lemma</span></span> ovalid_K_bind_wp <span class="main">[</span><span class="operator">wp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ovalid <span class="free">P</span> <span class="free">f</span> <span class="free">Q</span> <span class="main">⟹</span> ovalid <span class="free">P</span> <span class="main">(</span>K_bind <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="OptionMonadWP-ogets_wp"><span class="command">lemma</span></span> ogets_wp <span class="main">[</span><span class="operator">wp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ovalid <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>ogets <span class="free">f</span><span class="main">)</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ovalid_def ogets_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-oguard_wp"><span class="command">lemma</span></span> oguard_wp <span class="main">[</span><span class="operator">wp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ovalid <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">()</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>oguard <span class="free">f</span><span class="main">)</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ovalid_def oguard_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-oskip_wp"><span class="command">lemma</span></span> oskip_wp <span class="main">[</span><span class="operator">wp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ovalid <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="main">()</span> <span class="bound">s</span><span class="main">)</span> oskip <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ovalid_def oskip_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-ovalid_case_prod"><span class="command">lemma</span></span> ovalid_case_prod <span class="main">[</span><span class="operator">wp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> ovalid <span class="main">(</span><span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ovalid <span class="main">(</span><span class="keyword1">case</span> <span class="free">v</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">v</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">B</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ovalid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="OptionMonadWP-owhile_ovalid"><span class="command">lemma</span></span> owhile_ovalid <span class="main">[</span><span class="operator">wp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> ovalid <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">a</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="bound">a</span><span class="main">)</span> <span class="free">I</span><span class="main">;</span>
   <span class="main">⋀</span><span class="bound">a</span> <span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span><span class="free">I</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">;</span> <span class="main">¬</span> <span class="free">C</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">⟧</span>
  <span class="main">⟹</span> ovalid <span class="main">(</span><span class="free">I</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>owhile_inv <span class="free">C</span> <span class="free">B</span> <span class="free">a</span> <span class="free">I</span> <span class="free">M</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> owhile_inv_def owhile_def ovalid_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule_tac</span> I <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">I</span> <span class="bound">a</span> <span class="improper">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> option_while_rule<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ovalid_property</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ovalid_property</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">f</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">.</span> Some <span class="bound">r</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">s</span> <span class="bound">f</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">r</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1" id="OptionMonadWP-ovalid_is_triple"><span class="command">lemma</span></span> ovalid_is_triple <span class="main">[</span><span class="operator">wp_trip</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ovalid <span class="free">P</span> <span class="free">f</span> <span class="free">Q</span> <span class="main">=</span> triple_judgement <span class="free">P</span> <span class="free">f</span> <span class="main">(</span>ovalid_property <span class="free">Q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> triple_judgement_def ovalid_def ovalid_property_def<span class="main">)</span>


<span class="keyword1" id="OptionMonadWP-ovalid_wp_comb1"><span class="command">lemma</span></span> ovalid_wp_comb1 <span class="main">[</span><span class="operator">wp_comb</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> ovalid <span class="free">P'</span> <span class="free">f</span> <span class="free">Q</span><span class="main">;</span> ovalid <span class="free">P</span> <span class="free">f</span> <span class="free">Q'</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">P'</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> ovalid <span class="free">P</span> <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">r</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">Q'</span> <span class="bound">r</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ovalid_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-ovalid_wp_comb2"><span class="command">lemma</span></span> ovalid_wp_comb2 <span class="main">[</span><span class="operator">wp_comb</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> ovalid <span class="free">P</span> <span class="free">f</span> <span class="free">Q</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P'</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> ovalid <span class="free">P'</span> <span class="free">f</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ovalid_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-ovalid_wp_comb3"><span class="command">lemma</span></span> ovalid_wp_comb3 <span class="main">[</span><span class="operator">wp_comb</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> ovalid <span class="free">P</span> <span class="free">f</span> <span class="free">Q</span><span class="main">;</span> ovalid <span class="free">P'</span> <span class="free">f</span> <span class="free">Q'</span> <span class="main">⟧</span> <span class="main">⟹</span> ovalid <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">P'</span> <span class="bound">s</span><span class="main">)</span> <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">r</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">Q'</span> <span class="bound">r</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ovalid_def<span class="main">)</span>



<span class="comment1">(* WP rules for ovalidNF. *)</span>
<span class="keyword1" id="OptionMonadWP-obind_NF_wp"><span class="command">lemma</span></span> obind_NF_wp <span class="main">[</span><span class="operator">wp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> ovalidNF <span class="main">(</span><span class="free">R</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">r</span><span class="main">)</span> <span class="free">Q</span><span class="main">;</span> ovalidNF <span class="free">P</span> <span class="free">f</span> <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> ovalidNF <span class="free">P</span> <span class="main">(</span>obind <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ovalidNF_def obind_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-oreturn_NF_wp"><span class="command">lemma</span></span> oreturn_NF_wp <span class="main">[</span><span class="operator">wp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ovalidNF <span class="main">(</span><span class="free">P</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>oreturn <span class="free">x</span><span class="main">)</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ovalidNF_def oreturn_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-ocondition_NF_wp"><span class="command">lemma</span></span> ocondition_NF_wp <span class="main">[</span><span class="operator">wp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> ovalidNF <span class="free">L</span> <span class="free">l</span> <span class="free">Q</span><span class="main">;</span> ovalidNF <span class="free">R</span> <span class="free">r</span> <span class="free">Q</span> <span class="main">⟧</span>
   <span class="main">⟹</span> ovalidNF <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">C</span> <span class="bound">s</span> <span class="keyword1">then</span> <span class="free">L</span> <span class="bound">s</span> <span class="keyword1">else</span> <span class="free">R</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>ocondition <span class="free">C</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ovalidNF_def ocondition_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-ofail_NF_wp"><span class="command">lemma</span></span> ofail_NF_wp <span class="main">[</span><span class="operator">wp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ovalidNF <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span> ofail <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ovalidNF_def ofail_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-ovalidNF_K_bind_wp"><span class="command">lemma</span></span> ovalidNF_K_bind_wp <span class="main">[</span><span class="operator">wp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ovalidNF <span class="free">P</span> <span class="free">f</span> <span class="free">Q</span> <span class="main">⟹</span> ovalidNF <span class="free">P</span> <span class="main">(</span>K_bind <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="OptionMonadWP-ogets_NF_wp"><span class="command">lemma</span></span> ogets_NF_wp <span class="main">[</span><span class="operator">wp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ovalidNF <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>ogets <span class="free">f</span><span class="main">)</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ovalidNF_def ogets_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-oguard_NF_wp"><span class="command">lemma</span></span> oguard_NF_wp <span class="main">[</span><span class="operator">wp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ovalidNF <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">()</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>oguard <span class="free">f</span><span class="main">)</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ovalidNF_def oguard_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-oskip_NF_wp"><span class="command">lemma</span></span> oskip_NF_wp <span class="main">[</span><span class="operator">wp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ovalidNF <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="main">()</span> <span class="bound">s</span><span class="main">)</span> oskip <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ovalidNF_def oskip_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-ovalid_NF_case_prod"><span class="command">lemma</span></span> ovalid_NF_case_prod <span class="main">[</span><span class="operator">wp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> ovalidNF <span class="main">(</span><span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ovalidNF <span class="main">(</span><span class="keyword1">case</span> <span class="free">v</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">v</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">B</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ovalidNF_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="OptionMonadWP-owhile_NF"><span class="command">lemma</span></span> owhile_NF <span class="main">[</span><span class="operator">wp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> ovalidNF <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">a</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="bound">a</span><span class="main">)</span> <span class="free">I</span><span class="main">;</span>
   <span class="main">⋀</span><span class="bound">a</span> <span class="bound">m</span><span class="main">.</span> ovalid <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">a</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">a</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">M</span> <span class="bound">a</span> <span class="bound">s</span> <span class="main">=</span> <span class="bound">m</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="free">M</span> <span class="bound">r</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="bound">m</span><span class="main">)</span><span class="main">;</span>
   <span class="main">⋀</span><span class="bound">a</span> <span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span><span class="free">I</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">;</span> <span class="main">¬</span> <span class="free">C</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">⟧</span>
  <span class="main">⟹</span> ovalidNF <span class="main">(</span><span class="free">I</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>owhile_inv <span class="free">C</span> <span class="free">B</span> <span class="free">a</span> <span class="free">I</span> <span class="free">M</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> owhile_inv_def ovalidNF_def ovalid_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> s<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> I <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">I</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> M <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">M</span> <span class="bound">r</span> <span class="improper">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> owhile_rule<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ovalidNF_property</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ovalidNF_property</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">f</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">s</span> <span class="bound">f</span> <span class="main">≠</span> None <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">.</span> Some <span class="bound">r</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">s</span> <span class="bound">f</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">r</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1" id="OptionMonadWP-ovalidNF_is_triple"><span class="command">lemma</span></span> ovalidNF_is_triple <span class="main">[</span><span class="operator">wp_trip</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ovalidNF <span class="free">P</span> <span class="free">f</span> <span class="free">Q</span> <span class="main">=</span> triple_judgement <span class="free">P</span> <span class="free">f</span> <span class="main">(</span>ovalidNF_property <span class="free">Q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> triple_judgement_def ovalidNF_def ovalidNF_property_def<span class="main">)</span>


<span class="keyword1" id="OptionMonadWP-ovalidNF_wp_comb1"><span class="command">lemma</span></span> ovalidNF_wp_comb1 <span class="main">[</span><span class="operator">wp_comb</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> ovalidNF <span class="free">P'</span> <span class="free">f</span> <span class="free">Q</span><span class="main">;</span> ovalidNF <span class="free">P</span> <span class="free">f</span> <span class="free">Q'</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">P'</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> ovalidNF <span class="free">P</span> <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">r</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">Q'</span> <span class="bound">r</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ovalidNF_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-ovalidNF_wp_comb2"><span class="command">lemma</span></span> ovalidNF_wp_comb2 <span class="main">[</span><span class="operator">wp_comb</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> ovalidNF <span class="free">P</span> <span class="free">f</span> <span class="free">Q</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P'</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> ovalidNF <span class="free">P'</span> <span class="free">f</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ovalidNF_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-ovalidNF_wp_comb3"><span class="command">lemma</span></span> ovalidNF_wp_comb3 <span class="main">[</span><span class="operator">wp_comb</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> ovalidNF <span class="free">P</span> <span class="free">f</span> <span class="free">Q</span><span class="main">;</span> ovalidNF <span class="free">P'</span> <span class="free">f</span> <span class="free">Q'</span> <span class="main">⟧</span> <span class="main">⟹</span> ovalidNF <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">P'</span> <span class="bound">s</span><span class="main">)</span> <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">r</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">Q'</span> <span class="bound">r</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ovalidNF_def<span class="main">)</span>



<span class="comment1">(* FIXME: WP rules for no_ofail, which might not be correct. *)</span>
<span class="keyword1" id="OptionMonadWP-no_ofail_ofail"><span class="command">lemma</span></span> no_ofail_ofail <span class="main">[</span><span class="operator">wp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"no_ofail <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span> ofail"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_ofail_def ofail_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-no_ofail_ogets"><span class="command">lemma</span></span> no_ofail_ogets <span class="main">[</span><span class="operator">wp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"no_ofail <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span>ogets <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_ofail_def ogets_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-no_ofail_obind"><span class="command">lemma</span></span> no_ofail_obind <span class="main">[</span><span class="operator">wp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> no_ofail <span class="main">(</span><span class="free">P</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">r</span><span class="main">)</span><span class="main">;</span> no_ofail <span class="free">Q</span> <span class="free">f</span><span class="main">;</span> ovalid <span class="free">Q</span> <span class="free">f</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> no_ofail <span class="free">Q</span> <span class="main">(</span>obind <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> no_ofail_def obind_def ovalid_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-no_ofail_K_bind"><span class="command">lemma</span></span> no_ofail_K_bind <span class="main">[</span><span class="operator">wp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"no_ofail <span class="free">P</span> <span class="free">f</span> <span class="main">⟹</span> no_ofail <span class="free">P</span> <span class="main">(</span>K_bind <span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="OptionMonadWP-no_ofail_oguard"><span class="command">lemma</span></span> no_ofail_oguard <span class="main">[</span><span class="operator">wp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"no_ofail <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>oguard <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> no_ofail_def oguard_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-no_ofail_ocondition"><span class="command">lemma</span></span> no_ofail_ocondition <span class="main">[</span><span class="operator">wp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> no_ofail <span class="free">L</span> <span class="free">l</span><span class="main">;</span> no_ofail <span class="free">R</span> <span class="free">r</span> <span class="main">⟧</span>
     <span class="main">⟹</span> no_ofail <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">C</span> <span class="bound">s</span> <span class="keyword1">then</span> <span class="free">L</span> <span class="bound">s</span> <span class="keyword1">else</span> <span class="free">R</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>ocondition <span class="free">C</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_ofail_def ocondition_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-no_ofail_oreturn"><span class="command">lemma</span></span> no_ofail_oreturn <span class="main">[</span><span class="operator">wp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"no_ofail <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span>oreturn <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_ofail_def oreturn_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-no_ofail_oskip"><span class="command">lemma</span></span> no_ofail_oskip <span class="main">[</span><span class="operator">wp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"no_ofail <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> oskip"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_ofail_def oskip_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-no_ofail_is_triple"><span class="command">lemma</span></span> no_ofail_is_triple <span class="main">[</span><span class="operator">wp_trip</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"no_ofail <span class="free">P</span> <span class="free">f</span> <span class="main">=</span> triple_judgement <span class="free">P</span> <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">s</span> <span class="main">≠</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> triple_judgement_def no_ofail_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-no_ofail_wp_comb1"><span class="command">lemma</span></span> no_ofail_wp_comb1 <span class="main">[</span><span class="operator">wp_comb</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> no_ofail <span class="free">P</span> <span class="free">f</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P'</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> no_ofail <span class="free">P'</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_ofail_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-no_ofail_wp_comb2"><span class="command">lemma</span></span> no_ofail_wp_comb2 <span class="main">[</span><span class="operator">wp_comb</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> no_ofail <span class="free">P</span> <span class="free">f</span><span class="main">;</span> no_ofail <span class="free">P'</span> <span class="free">f</span> <span class="main">⟧</span> <span class="main">⟹</span> no_ofail <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">P'</span> <span class="bound">s</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_ofail_def<span class="main">)</span>



<span class="comment1">(* Some extra lemmas for our predicates. *)</span>
<span class="keyword1" id="OptionMonadWP-ovalid_grab_asm"><span class="command">lemma</span></span> ovalid_grab_asm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">G</span> <span class="main">⟹</span> ovalid <span class="free">P</span> <span class="free">f</span> <span class="free">Q</span><span class="main">)</span> <span class="main">⟹</span> ovalid <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="free">f</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ovalid_def<span class="main">)</span>
<span class="keyword1" id="OptionMonadWP-ovalidNF_grab_asm"><span class="command">lemma</span></span> ovalidNF_grab_asm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">G</span> <span class="main">⟹</span> ovalidNF <span class="free">P</span> <span class="free">f</span> <span class="free">Q</span><span class="main">)</span> <span class="main">⟹</span> ovalidNF <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="free">f</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ovalidNF_def<span class="main">)</span>
<span class="keyword1" id="OptionMonadWP-no_ofail_grab_asm"><span class="command">lemma</span></span> no_ofail_grab_asm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">G</span> <span class="main">⟹</span> no_ofail <span class="free">P</span> <span class="free">f</span><span class="main">)</span> <span class="main">⟹</span> no_ofail <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_ofail_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-ovalid_assume_pre"><span class="command">lemma</span></span> ovalid_assume_pre<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟹</span> ovalid <span class="free">P</span> <span class="free">f</span> <span class="free">Q</span><span class="main">)</span> <span class="main">⟹</span> ovalid <span class="free">P</span> <span class="free">f</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ovalid_def<span class="main">)</span>
<span class="keyword1" id="OptionMonadWP-ovalidNF_assume_pre"><span class="command">lemma</span></span> ovalidNF_assume_pre<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟹</span> ovalidNF <span class="free">P</span> <span class="free">f</span> <span class="free">Q</span><span class="main">)</span> <span class="main">⟹</span> ovalidNF <span class="free">P</span> <span class="free">f</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ovalidNF_def<span class="main">)</span>
<span class="keyword1" id="OptionMonadWP-no_ofail_assume_pre"><span class="command">lemma</span></span> no_ofail_assume_pre<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟹</span> no_ofail <span class="free">P</span> <span class="free">f</span><span class="main">)</span> <span class="main">⟹</span> no_ofail <span class="free">P</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_ofail_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-ovalid_pre_imp"><span class="command">lemma</span></span> ovalid_pre_imp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P'</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">s</span><span class="main">;</span> ovalid <span class="free">P</span> <span class="free">f</span> <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> ovalid <span class="free">P'</span> <span class="free">f</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ovalid_def<span class="main">)</span>
<span class="keyword1" id="OptionMonadWP-ovalidNF_pre_imp"><span class="command">lemma</span></span> ovalidNF_pre_imp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P'</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">s</span><span class="main">;</span> ovalidNF <span class="free">P</span> <span class="free">f</span> <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> ovalidNF <span class="free">P'</span> <span class="free">f</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ovalidNF_def<span class="main">)</span>
<span class="keyword1" id="OptionMonadWP-no_ofail_pre_imp"><span class="command">lemma</span></span> no_ofail_pre_imp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P'</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">s</span><span class="main">;</span> no_ofail <span class="free">P</span> <span class="free">f</span> <span class="main">⟧</span> <span class="main">⟹</span> no_ofail <span class="free">P'</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_ofail_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-ovalid_post_imp"><span class="command">lemma</span></span> ovalid_post_imp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">r</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">Q'</span> <span class="bound">r</span> <span class="bound">s</span><span class="main">;</span> ovalid <span class="free">P</span> <span class="free">f</span> <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> ovalid <span class="free">P</span> <span class="free">f</span> <span class="free">Q'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ovalid_def<span class="main">)</span>
<span class="keyword1" id="OptionMonadWP-ovalidNF_post_imp"><span class="command">lemma</span></span> ovalidNF_post_imp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">r</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">Q'</span> <span class="bound">r</span> <span class="bound">s</span><span class="main">;</span> ovalidNF <span class="free">P</span> <span class="free">f</span> <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> ovalidNF <span class="free">P</span> <span class="free">f</span> <span class="free">Q'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ovalidNF_def<span class="main">)</span>

<span class="keyword1" id="OptionMonadWP-ovalid_post_imp_assuming_pre"><span class="command">lemma</span></span> ovalid_post_imp_assuming_pre<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">P</span> <span class="bound">s</span><span class="main">;</span> <span class="free">Q</span> <span class="bound">r</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q'</span> <span class="bound">r</span> <span class="bound">s</span><span class="main">;</span> ovalid <span class="free">P</span> <span class="free">f</span> <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> ovalid <span class="free">P</span> <span class="free">f</span> <span class="free">Q'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ovalid_def<span class="main">)</span>
<span class="keyword1" id="OptionMonadWP-ovalidNF_post_imp_assuming_pre"><span class="command">lemma</span></span> ovalidNF_post_imp_assuming_pre<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">P</span> <span class="bound">s</span><span class="main">;</span> <span class="free">Q</span> <span class="bound">r</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q'</span> <span class="bound">r</span> <span class="bound">s</span><span class="main">;</span> ovalidNF <span class="free">P</span> <span class="free">f</span> <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> ovalidNF <span class="free">P</span> <span class="free">f</span> <span class="free">Q'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ovalidNF_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Graph_Genus">
<div class="head">
<h1>Theory Graph_Genus</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Graph_Genus
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Combinatorics/Permutations.html">HOL-Combinatorics.Permutations</a>"</span>
  <a href="../../graph_theory/theories/#Graph_Theory">Graph_Theory.Graph_Theory</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Graph_Genus-nat_diff_mod_right"><span class="command">lemma</span></span> nat_diff_mod_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="free">c</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="keyword1">mod</span> <span class="free">c</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> b_mod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">mod</span> <span class="free">c</span> <span class="main">≤</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mod_less_eq_dividend linear not_le order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>int <span class="free">a</span> <span class="main">-</span> int <span class="free">b</span> <span class="keyword1">mod</span> int <span class="free">c</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zmod_int of_nat_diff <span class="dynamic"><span class="dynamic">mod_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> int <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="keyword1">mod</span> <span class="free">c</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms b_mod
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zmod_int <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> of_nat_diff <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graph_Genus-inj_on_f_imageI"><span class="command">lemma</span></span> inj_on_f_imageI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_image_eq_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_onI<span class="main">)</span>



<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Combinatorial Maps›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> bidirected_digraph<span class="main">)</span> has_dom_arev<span class="main">:</span>
  <span class="quoted"><span class="quoted">"has_dom <span class="free">arev</span> <span class="main">(</span>arcs <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> arev_dom <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_dom_def<span class="main">)</span>

<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'b</span> pre_map <span class="main">=</span>
  edge_rev <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  edge_succ <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">edge_pred</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> pre_map <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">edge_pred</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> inv <span class="main">(</span>edge_succ <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">locale</span></span> pre_digraph_map <span class="main">=</span> pre_digraph <span class="main">+</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">M</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> pre_map"</span></span>

<span class="keyword1"><span class="command">locale</span></span> digraph_map <span class="main">=</span> fin_digraph <span class="quoted"><span class="free">G</span></span>
  <span class="main">+</span> pre_digraph_map <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="free">M</span></span>
  <span class="main">+</span> bidirected_digraph <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="quoted">"edge_rev <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">G</span> <span class="free">M</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> edge_succ_permutes<span class="main">:</span> <span class="quoted"><span class="quoted">"edge_succ <span class="free">M</span> <span class="keyword1">permutes</span> arcs <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> edge_succ_cyclic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> verts <span class="free">G</span> <span class="main">⟹</span> out_arcs <span class="free">G</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> cyclic_on <span class="main">(</span>edge_succ <span class="free">M</span><span class="main">)</span> <span class="main">(</span>out_arcs <span class="free">G</span> <span class="bound">v</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> fin_digraph<span class="main">)</span> digraph_mapI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bidi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∉</span> arcs <span class="free">G</span> <span class="main">⟹</span> edge_rev <span class="free">M</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">a</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> arcs <span class="free">G</span> <span class="main">⟹</span> edge_rev <span class="free">M</span> <span class="bound">a</span> <span class="main">≠</span> <span class="bound">a</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> arcs <span class="free">G</span> <span class="main">⟹</span> edge_rev <span class="free">M</span> <span class="main">(</span>edge_rev <span class="free">M</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="bound">a</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> arcs <span class="free">G</span> <span class="main">⟹</span> tail <span class="free">G</span> <span class="main">(</span>edge_rev <span class="free">M</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> head <span class="free">G</span> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> edge_succ_permutes<span class="main">:</span> <span class="quoted"><span class="quoted">"edge_succ <span class="free">M</span> <span class="keyword1">permutes</span> arcs <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> edge_succ_cyclic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> verts <span class="free">G</span> <span class="main">⟹</span> out_arcs <span class="free">G</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> cyclic_on <span class="main">(</span>edge_succ <span class="free">M</span><span class="main">)</span> <span class="main">(</span>out_arcs <span class="free">G</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"digraph_map <span class="free">G</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> fin_digraph<span class="main">)</span> digraph_mapI_permutes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bidi<span class="main">:</span> <span class="quoted"><span class="quoted">"edge_rev <span class="free">M</span> <span class="keyword1">permutes</span> arcs <span class="free">G</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> arcs <span class="free">G</span> <span class="main">⟹</span> edge_rev <span class="free">M</span> <span class="bound">a</span> <span class="main">≠</span> <span class="bound">a</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> arcs <span class="free">G</span> <span class="main">⟹</span> edge_rev <span class="free">M</span> <span class="main">(</span>edge_rev <span class="free">M</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="bound">a</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> arcs <span class="free">G</span> <span class="main">⟹</span> tail <span class="free">G</span> <span class="main">(</span>edge_rev <span class="free">M</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> head <span class="free">G</span> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> edge_succ_permutes<span class="main">:</span> <span class="quoted"><span class="quoted">"edge_succ <span class="free">M</span> <span class="keyword1">permutes</span> arcs <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> edge_succ_cyclic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> verts <span class="free">G</span> <span class="main">⟹</span> out_arcs <span class="free">G</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> cyclic_on <span class="main">(</span>edge_succ <span class="free">M</span><span class="main">)</span> <span class="main">(</span>out_arcs <span class="free">G</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"digraph_map <span class="free">G</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> bidirected_digraph <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="quoted">"edge_rev <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bidi <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutes_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> edge_succ_permutes edge_succ_cyclic <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">context</span></span> digraph_map
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Graph_Genus-digraph_map"><span class="command">lemma</span></span> digraph_map<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"digraph_map <span class="free">G</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

  <span class="keyword1" id="Graph_Genus-permutation_edge_succ"><span class="command">lemma</span></span> permutation_edge_succ<span class="main">:</span> <span class="quoted"><span class="quoted">"permutation <span class="main">(</span>edge_succ <span class="free">M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> edge_succ_permutes finite_arcs permutation_permutes<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-edge_pred_succ"><span class="command">lemma</span></span> edge_pred_succ<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"edge_pred <span class="free">M</span> <span class="main">(</span>edge_succ <span class="free">M</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> edge_pred_def edge_succ_permutes permutes_inverses<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-edge_succ_pred"><span class="command">lemma</span></span> edge_succ_pred<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"edge_succ <span class="free">M</span> <span class="main">(</span>edge_pred <span class="free">M</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> edge_pred_def edge_succ_permutes permutes_inverses<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-edge_pred_permutes"><span class="command">lemma</span></span> edge_pred_permutes<span class="main">:</span> <span class="quoted"><span class="quoted">"edge_pred <span class="free">M</span> <span class="keyword1">permutes</span> arcs <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> edge_pred_def <span class="keyword1"><span class="command">using</span></span> edge_succ_permutes <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> permutes_inv<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-permutation_edge_pred"><span class="command">lemma</span></span> permutation_edge_pred<span class="main">:</span> <span class="quoted"><span class="quoted">"permutation <span class="main">(</span>edge_pred <span class="free">M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> edge_pred_permutes finite_arcs permutation_permutes<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-edge_succ_eq_iff"><span class="command">lemma</span></span> edge_succ_eq_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> edge_succ <span class="free">M</span> <span class="bound">x</span> <span class="main">=</span> edge_succ <span class="free">M</span> <span class="bound">y</span> <span class="main">⟷</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> edge_pred_succ<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-edge_rev_in_arcs"><span class="command">lemma</span></span> edge_rev_in_arcs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"edge_rev <span class="free">M</span> <span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> arev_arev arev_permutes_arcs permutes_not_in<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-edge_succ_in_arcs"><span class="command">lemma</span></span> edge_succ_in_arcs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"edge_succ <span class="free">M</span> <span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> edge_pred_succ edge_succ_permutes permutes_not_in<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-edge_pred_in_arcs"><span class="command">lemma</span></span> edge_pred_in_arcs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"edge_pred <span class="free">M</span> <span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> edge_succ_pred edge_pred_permutes permutes_not_in<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-tail_edge_succ"><span class="command">lemma</span></span> tail_edge_succ<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="main">(</span>edge_succ <span class="free">M</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> tail <span class="free">G</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="free">a</span> <span class="main">∈</span> verts <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"out_arcs <span class="free">G</span> <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cyclic_on <span class="main">(</span>edge_succ <span class="free">M</span><span class="main">)</span> <span class="main">(</span>out_arcs <span class="free">G</span> <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> edge_succ_cyclic<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> out_arcs <span class="free">G</span> <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"edge_succ <span class="free">M</span> <span class="free">a</span> <span class="main">∈</span> out_arcs <span class="free">G</span> <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cyclic_on_inI<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> arcs <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> edge_succ_permutes <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutes_not_in<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Graph_Genus-tail_edge_pred"><span class="command">lemma</span></span> tail_edge_pred<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="main">(</span>edge_pred <span class="free">M</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> tail <span class="free">G</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> edge_succ_pred tail_edge_succ<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-bij_edge_succ"><span class="command">lemma</span></span> bij_edge_succ<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="main">(</span>edge_succ <span class="free">M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> edge_succ_permutes <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutes_conv_has_dom<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-edge_pred_cyclic"><span class="command">lemma</span></span> edge_pred_cyclic<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> verts <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"out_arcs <span class="free">G</span> <span class="free">v</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cyclic_on <span class="main">(</span>edge_pred <span class="free">M</span><span class="main">)</span> <span class="main">(</span>out_arcs <span class="free">G</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> orb_a_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"orbit <span class="main">(</span>edge_succ <span class="free">M</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">=</span> out_arcs <span class="free">G</span> <span class="free">v</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> edge_succ_cyclic<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cyclic_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cyclic_on <span class="main">(</span>edge_pred <span class="free">M</span><span class="main">)</span> <span class="main">(</span>orbit <span class="main">(</span>edge_pred <span class="free">M</span><span class="main">)</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> permutation_edge_pred <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cyclic_on_orbit'<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"orbit <span class="main">(</span>edge_pred <span class="free">M</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">=</span> orbit <span class="main">(</span>edge_succ <span class="free">M</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> edge_pred_def <span class="keyword1"><span class="command">using</span></span> permutation_edge_succ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> orbit_inv_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cyclic_on <span class="main">(</span>edge_pred <span class="free">M</span><span class="main">)</span> <span class="main">(</span>out_arcs <span class="free">G</span> <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> orb_a_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pre_digraph_map<span class="main">)</span> <span class="entity">face_cycle_succ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">face_cycle_succ</span> <span class="main">≡</span> edge_succ <span class="free">M</span> <span class="keyword1">o</span> edge_rev <span class="free">M</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pre_digraph_map<span class="main">)</span> <span class="entity">face_cycle_pred</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">face_cycle_pred</span> <span class="main">≡</span> edge_rev <span class="free">M</span> <span class="keyword1">o</span> edge_pred <span class="free">M</span>"</span></span>

  <span class="keyword1" id="Graph_Genus-face_cycle_pred_succ"><span class="command">lemma</span></span> face_cycle_pred_succ<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"face_cycle_pred <span class="main">(</span>face_cycle_succ <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> face_cycle_pred_def face_cycle_succ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Graph_Genus-face_cycle_succ_pred"><span class="command">lemma</span></span> face_cycle_succ_pred<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"face_cycle_succ <span class="main">(</span>face_cycle_pred <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> face_cycle_pred_def face_cycle_succ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Graph_Genus-tail_face_cycle_succ"><span class="command">lemma</span></span> tail_face_cycle_succ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span> <span class="main">⟹</span> tail <span class="free">G</span> <span class="main">(</span>face_cycle_succ <span class="free">a</span><span class="main">)</span> <span class="main">=</span> head <span class="free">G</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> face_cycle_succ_def<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-funpow_prop"><span class="command">lemma</span></span> funpow_prop<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">P</span> <span class="bound">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">P</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-face_cycle_succ_no_arc"><span class="command">lemma</span></span> face_cycle_succ_no_arc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> arcs <span class="free">G</span> <span class="main">⟹</span> face_cycle_succ <span class="free">a</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> face_cycle_succ_def permutes_not_in<span class="main"><span class="main">[</span></span><span class="operator">OF</span> arev_permutes_arcs<span class="main"><span class="main">]</span></span>
      permutes_not_in<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edge_succ_permutes<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-funpow_face_cycle_succ_no_arc"><span class="command">lemma</span></span> funpow_face_cycle_succ_no_arc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> arcs <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>face_cycle_succ <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1" id="Graph_Genus-funpow_face_cycle_pred_no_arc"><span class="command">lemma</span></span> funpow_face_cycle_pred_no_arc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> arcs <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>face_cycle_pred <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> face_cycle_pred_def permutes_not_in<span class="main"><span class="main">[</span></span><span class="operator">OF</span> arev_permutes_arcs<span class="main"><span class="main">]</span></span>
      permutes_not_in<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edge_pred_permutes<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-face_cycle_succ_closed"><span class="command">lemma</span></span> face_cycle_succ_closed<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"face_cycle_succ <span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_apply edge_rev_in_arcs edge_succ_in_arcs face_cycle_succ_def<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-face_cycle_pred_closed"><span class="command">lemma</span></span> face_cycle_pred_closed<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"face_cycle_pred <span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> face_cycle_succ_closed face_cycle_succ_pred<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-face_cycle_succ_permutes"><span class="command">lemma</span></span> face_cycle_succ_permutes<span class="main">:</span>
    <span class="quoted"><span class="quoted">"face_cycle_succ <span class="keyword1">permutes</span> arcs <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> face_cycle_succ_def
    <span class="keyword1"><span class="command">using</span></span> arev_permutes_arcs edge_succ_permutes <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> permutes_compose<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-permutation_face_cycle_succ"><span class="command">lemma</span></span> permutation_face_cycle_succ<span class="main">:</span> <span class="quoted"><span class="quoted">"permutation face_cycle_succ"</span></span>
    <span class="keyword1"><span class="command">using</span></span> face_cycle_succ_permutes finite_arcs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permutation_permutes<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-bij_face_cycle_succ"><span class="command">lemma</span></span> bij_face_cycle_succ<span class="main">:</span> <span class="quoted"><span class="quoted">"bij face_cycle_succ"</span></span>
    <span class="keyword1"><span class="command">using</span></span> face_cycle_succ_permutes <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutes_conv_has_dom<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-face_cycle_pred_permutes"><span class="command">lemma</span></span> face_cycle_pred_permutes<span class="main">:</span>
    <span class="quoted"><span class="quoted">"face_cycle_pred <span class="keyword1">permutes</span> arcs <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> face_cycle_pred_def
    <span class="keyword1"><span class="command">using</span></span> edge_pred_permutes arev_permutes_arcs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> permutes_compose<span class="main">)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pre_digraph_map<span class="main">)</span> <span class="entity">face_cycle_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">face_cycle_set</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> orbit face_cycle_succ <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pre_digraph_map<span class="main">)</span> <span class="entity">face_cycle_sets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">face_cycle_sets</span> <span class="main">=</span> face_cycle_set <span class="main">`</span> arcs <span class="free">G</span>"</span></span>

  <span class="keyword1" id="Graph_Genus-face_cycle_set_altdef"><span class="command">lemma</span></span> face_cycle_set_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"face_cycle_set <span class="free">a</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span>face_cycle_succ <span class="main">^^</span> <span class="bound">n</span><span class="main">)</span> <span class="free">a</span> <span class="main">|</span> <span class="bound">n</span><span class="main">.</span> True<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> face_cycle_set_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> orbit_altdef_self_in permutation_self_in_orbit permutation_face_cycle_succ<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-face_cycle_set_self"><span class="command">lemma</span></span> face_cycle_set_self<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> face_cycle_set <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> face_cycle_set_def <span class="keyword1"><span class="command">using</span></span> permutation_face_cycle_succ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> permutation_self_in_orbit<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-empty_not_in_face_cycle_sets"><span class="command">lemma</span></span> empty_not_in_face_cycle_sets<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> face_cycle_sets"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> face_cycle_sets_def<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-finite_face_cycle_set"><span class="command">lemma</span></span> finite_face_cycle_set<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>face_cycle_set <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> face_cycle_set_self <span class="keyword1"><span class="command">unfolding</span></span> face_cycle_set_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_orbit<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-finite_face_cycle_sets"><span class="command">lemma</span></span> finite_face_cycle_sets<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite face_cycle_sets"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> face_cycle_sets_def<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-face_cycle_set_induct"><span class="command">lemma</span></span> face_cycle_set_induct<span class="main">[</span><span class="operator">case_names</span> base step<span class="main">,</span> <span class="operator">induct</span> <span class="quasi_keyword"><span class="quasi_keyword">set</span></span><span class="main"><span class="main"><span class="main">:</span></span></span> face_cycle_set<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> consume<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> face_cycle_set <span class="free">x</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ih_base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ih_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> face_cycle_set <span class="free">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>face_cycle_succ <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> consume <span class="keyword1"><span class="command">unfolding</span></span> face_cycle_set_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ih_step face_cycle_set_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ih_base <span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-face_cycle_succ_cyclic"><span class="command">lemma</span></span> face_cycle_succ_cyclic<span class="main">:</span>
    <span class="quoted"><span class="quoted">"cyclic_on face_cycle_succ <span class="main">(</span>face_cycle_set <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> face_cycle_set_def <span class="keyword1"><span class="command">using</span></span> permutation_face_cycle_succ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cyclic_on_orbit'<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-face_cycle_eq"><span class="command">lemma</span></span> face_cycle_eq<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> face_cycle_set <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"face_cycle_set <span class="free">b</span> <span class="main">=</span> face_cycle_set <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> face_cycle_set_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> orbit_swap orbit_trans permutation_face_cycle_succ permutation_self_in_orbit<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-face_cycle_succ_in_arcsI"><span class="command">lemma</span></span> face_cycle_succ_in_arcsI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> arcs <span class="free">G</span> <span class="main">⟹</span> face_cycle_succ <span class="bound">a</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> face_cycle_succ_def<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-face_cycle_succ_inI"><span class="command">lemma</span></span> face_cycle_succ_inI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> face_cycle_set <span class="bound">y</span> <span class="main">⟹</span> face_cycle_succ <span class="bound">x</span> <span class="main">∈</span> face_cycle_set <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> face_cycle_succ_cyclic cyclic_on_inI<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-face_cycle_succ_inD"><span class="command">lemma</span></span> face_cycle_succ_inD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> face_cycle_succ <span class="bound">x</span> <span class="main">∈</span> face_cycle_set <span class="bound">y</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> face_cycle_set <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> face_cycle_eq face_cycle_set_self face_cycle_succ_inI<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-face_cycle_set_parts"><span class="command">lemma</span></span> face_cycle_set_parts<span class="main">:</span>
    <span class="quoted"><span class="quoted">"face_cycle_set <span class="free">a</span> <span class="main">=</span> face_cycle_set <span class="free">b</span> <span class="main">∨</span> face_cycle_set <span class="free">a</span> <span class="main">∩</span> face_cycle_set <span class="free">b</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> disjoint_iff_not_equal face_cycle_eq<span class="main">)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">fc_equiv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">fc_equiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> face_cycle_set <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>

  <span class="keyword1" id="Graph_Genus-reflp_fc_equiv"><span class="command">lemma</span></span> reflp_fc_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"reflp fc_equiv"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reflpI<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fc_equiv_def<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-symp_fc_equiv"><span class="command">lemma</span></span> symp_fc_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"symp fc_equiv"</span></span>
    <span class="keyword1"><span class="command">using</span></span> face_cycle_set_parts
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sympI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fc_equiv_def<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-transp_fc_equiv"><span class="command">lemma</span></span> transp_fc_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"transp fc_equiv"</span></span>
    <span class="keyword1"><span class="command">using</span></span> face_cycle_set_parts
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> transpI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fc_equiv_def<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"equivp fc_equiv"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> equivpI reflp_fc_equiv symp_fc_equiv transp_fc_equiv<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-in_face_cycle_setD"><span class="command">lemma</span></span> in_face_cycle_setD<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> face_cycle_set <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> face_cycle_set_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> permutes_orbit_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> face_cycle_succ_permutes<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-in_face_cycle_setsD"><span class="command">lemma</span></span> in_face_cycle_setsD<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> face_cycle_sets"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊆</span> arcs <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> face_cycle_sets_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_face_cycle_setD<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pre_digraph<span class="main">)</span> <span class="entity">isolated_verts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">isolated_verts</span> <span class="main">≡</span> <span class="main">{</span><span class="bound"><span class="bound">v</span></span> <span class="main">∈</span> verts <span class="free">G</span><span class="main">.</span> out_arcs <span class="free">G</span> <span class="bound">v</span> <span class="main">=</span> <span class="main">{}</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pre_digraph_map<span class="main">)</span> <span class="entity">euler_char</span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">euler_char</span> <span class="main">≡</span> int <span class="main">(</span>card <span class="main">(</span>verts <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> int <span class="main">(</span>card <span class="main">(</span>arcs <span class="free">G</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> int <span class="main">(</span>card face_cycle_sets<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pre_digraph_map<span class="main">)</span> <span class="entity">euler_genus</span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">euler_genus</span> <span class="main">≡</span> <span class="main">(</span>int <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> card sccs<span class="main">)</span> <span class="main">-</span> int <span class="main">(</span>card isolated_verts<span class="main">)</span> <span class="main">-</span> euler_char<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">comb_planar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> pre_digraph <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">comb_planar</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">M</span><span class="main">.</span> digraph_map <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="bound">M</span> <span class="main">∧</span> pre_digraph_map.euler_genus <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="bound">M</span> <span class="main">=</span> <span class="main">0</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Number of isolated vertices is a graph invariant›</span></span>
<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">G</span> <span class="free">hom</span> <span class="keyword2"><span class="keyword">assumes</span></span> hom<span class="main">:</span> <span class="quoted"><span class="quoted">"pre_digraph.digraph_isomorphism <span class="free">G</span> <span class="free">hom</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">interpretation</span></span> wf_digraph <span class="quoted"><span class="free">G</span></span> <span class="keyword1"><span class="command">using</span></span> hom <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_digraph.digraph_isomorphism_def<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-isolated_verts_app_iso"><span class="command">lemma</span></span> isolated_verts_app_iso<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"pre_digraph.isolated_verts <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span> <span class="main">=</span> iso_verts <span class="free">hom</span> <span class="main">`</span> isolated_verts"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hom
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_digraph.isolated_verts_def iso_verts_tail inj_image_mem_iff out_arcs_app_iso_eq<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-card_isolated_verts_iso"><span class="command">lemma</span></span> card_isolated_verts_iso<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"card <span class="main">(</span>iso_verts <span class="free">hom</span> <span class="main">`</span> pre_digraph.isolated_verts <span class="free">G</span><span class="main">)</span> <span class="main">=</span> card isolated_verts"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> card_image<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> hom <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> digraph_isomorphism_inj_on_verts<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subset_inj_on<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> isolated_verts_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>



<span class="keyword1"><span class="command">context</span></span> digraph_map <span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Graph_Genus-face_cycle_succ_neq"><span class="command">lemma</span></span> face_cycle_succ_neq<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="free">a</span> <span class="main">≠</span> head <span class="free">G</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"face_cycle_succ <span class="free">a</span> <span class="main">≠</span> <span class="free">a</span> "</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"edge_rev <span class="free">M</span> <span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> edge_rev_in_arcs<span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cyclic_on <span class="main">(</span>edge_succ <span class="free">M</span><span class="main">)</span> <span class="main">(</span>out_arcs <span class="free">G</span> <span class="main">(</span>tail <span class="free">G</span> <span class="main">(</span>edge_rev <span class="free">M</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> edge_succ_cyclic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> tail_in_verts <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> out_arcs_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"edge_rev <span class="free">M</span> <span class="free">a</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"edge_succ <span class="free">M</span> <span class="main">(</span>edge_rev <span class="free">M</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>out_arcs <span class="free">G</span> <span class="main">(</span>tail <span class="free">G</span> <span class="main">(</span>edge_rev <span class="free">M</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cyclic_on_inI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹edge_rev <span class="free">M</span> <span class="free">a</span> <span class="main">∈</span> <span class="main">_</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="main">(</span>edge_succ <span class="free">M</span> <span class="main">(</span>edge_rev <span class="free">M</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> head <span class="free">G</span> <span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"edge_succ <span class="free">M</span> <span class="main">(</span>edge_rev <span class="free">M</span> <span class="free">a</span><span class="main">)</span> <span class="main">≠</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> face_cycle_succ_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Maps and Isomorphism›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pre_digraph<span class="main">)</span>
  <span class="quoted"><span class="quoted">"<span class="free">wrap_iso_arcs</span> <span class="free"><span class="bound"><span class="entity">hom</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> perm_restrict <span class="main">(</span>iso_arcs <span class="free"><span class="bound"><span class="entity">hom</span></span></span> <span class="keyword1">o</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">o</span> iso_arcs <span class="main">(</span>inv_iso <span class="free"><span class="bound"><span class="entity">hom</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>arcs <span class="main">(</span>app_iso <span class="free"><span class="bound"><span class="entity">hom</span></span></span> <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pre_digraph_map<span class="main">)</span> <span class="entity">map_iso</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'a2</span><span class="main">,</span><span class="tfree">'b2</span><span class="main">)</span> digraph_isomorphism <span class="main">⇒</span> <span class="tfree">'b2</span> pre_map"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_iso</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> 
  <span class="main">⦇</span> edge_rev <span class="main">=</span> wrap_iso_arcs <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>edge_rev <span class="free">M</span><span class="main">)</span>
  <span class="main">,</span> edge_succ <span class="main">=</span> wrap_iso_arcs <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>edge_succ <span class="free">M</span><span class="main">)</span>
  <span class="main">⦈</span>"</span></span>

<span class="keyword1" id="Graph_Genus-funcsetI_permutes"><span class="command">lemma</span></span> funcsetI_permutes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">permutes</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">→</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms funcsetI permutes_in_image<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">G</span> <span class="free">hom</span> <span class="keyword2"><span class="keyword">assumes</span></span> hom<span class="main">:</span> <span class="quoted"><span class="quoted">"pre_digraph.digraph_isomorphism <span class="free">G</span> <span class="free">hom</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">interpretation</span></span> wf_digraph <span class="quoted"><span class="free">G</span></span> <span class="keyword1"><span class="command">using</span></span> hom <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_digraph.digraph_isomorphism_def<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-wrap_iso_arcs_iso_arcs"><span class="command">lemma</span></span> wrap_iso_arcs_iso_arcs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wrap_iso_arcs <span class="free">hom</span> <span class="free">f</span> <span class="main">(</span>iso_arcs <span class="free">hom</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> iso_arcs <span class="free">hom</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms hom <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wrap_iso_arcs_def perm_restrict_def<span class="main">)</span>

  <span class="keyword1" id="Graph_Genus-inj_on_wrap_iso_arcs"><span class="command">lemma</span></span> inj_on_wrap_iso_arcs<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">F</span> <span class="main">⟹</span> has_dom <span class="bound">f</span> <span class="main">(</span>arcs <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> funcset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">⊆</span> arcs <span class="free">G</span> <span class="main">→</span> arcs <span class="free">G</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>wrap_iso_arcs <span class="free">hom</span><span class="main">)</span> <span class="free">F</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">g</span> <span class="keyword3"><span class="command">assume</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">F</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> <span class="free">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"wrap_iso_arcs <span class="free">hom</span> <span class="skolem">f</span> <span class="main">=</span> wrap_iso_arcs <span class="free">hom</span> <span class="skolem">g</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> arcs <span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> F dom <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_dom_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">g</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">x</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> F funcset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> digraph_isomorphism_inj_on_arcs<span class="main">[</span><span class="operator">OF</span> hom<span class="main">]</span> _
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"iso_arcs <span class="free">hom</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> iso_arcs <span class="free">hom</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">g</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inj_onD<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">g</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms hom  <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> arcs <span class="free">G</span>›</span></span> eq
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wrap_iso_arcs_def fun_eq_iff perm_restrict_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1" id="Graph_Genus-inj_on_wrap_iso_arcs_f"><span class="command">lemma</span></span> inj_on_wrap_iso_arcs_f<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> arcs <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">→</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">=</span> iso_arcs <span class="free">hom</span> <span class="main">`</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>wrap_iso_arcs <span class="free">hom</span> <span class="free">f</span><span class="main">)</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> in_hom_A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wia_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"wrap_iso_arcs <span class="free">hom</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> wrap_iso_arcs <span class="free">hom</span> <span class="free">f</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> in_hom_A <span class="quoted"><span class="quoted">‹<span class="free">B</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x0</span></span> <span class="keyword2"><span class="keyword">where</span></span> x0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> iso_arcs <span class="free">hom</span> <span class="skolem">x0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x0</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> in_hom_A <span class="quoted"><span class="quoted">‹<span class="free">B</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y0</span></span> <span class="keyword2"><span class="keyword">where</span></span> y0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> iso_arcs <span class="free">hom</span> <span class="skolem">y0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y0</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> arcs_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x0</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y0</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x0</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">y0</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x0 y0 <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊆</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>iso_arcs <span class="free">hom</span> <span class="keyword1">o</span> <span class="free">f</span> <span class="keyword1">o</span> iso_arcs <span class="main">(</span>inv_iso <span class="free">hom</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span>iso_arcs <span class="free">hom</span> <span class="keyword1">o</span> <span class="free">f</span> <span class="keyword1">o</span> iso_arcs <span class="main">(</span>inv_iso <span class="free">hom</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> in_hom_A wia_eq assms<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">B</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wrap_iso_arcs_def perm_restrict_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> hom assms digraph_isomorphism_inj_on_arcs<span class="main">[</span><span class="operator">OF</span> hom<span class="main">]</span> x0 y0 arcs_0 <span class="quoted"><span class="quoted">‹inj_on <span class="free">f</span> <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊆</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  inj_onD<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1" id="Graph_Genus-wrap_iso_arcs_in_funcsetI"><span class="command">lemma</span></span> wrap_iso_arcs_in_funcsetI<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> arcs <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">→</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wrap_iso_arcs <span class="free">hom</span> <span class="free">f</span> <span class="main">∈</span> iso_arcs <span class="free">hom</span> <span class="main">`</span> <span class="free">A</span>  <span class="main">→</span> iso_arcs <span class="free">hom</span> <span class="main">`</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> iso_arcs <span class="free">hom</span> <span class="main">`</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> iso_arcs <span class="free">hom</span> <span class="skolem">x0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x0</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x0</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wrap_iso_arcs <span class="free">hom</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">∈</span> iso_arcs <span class="free">hom</span> <span class="main">`</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x0</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> assms hom <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wrap_iso_arcs_def perm_restrict_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1" id="Graph_Genus-wrap_iso_arcs_permutes"><span class="command">lemma</span></span> wrap_iso_arcs_permutes<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> arcs <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">permutes</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wrap_iso_arcs <span class="free">hom</span> <span class="free">f</span> <span class="keyword1">permutes</span> <span class="main">(</span>iso_arcs <span class="free">hom</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> iso_arcs <span class="free">hom</span> <span class="main">`</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wrap_iso_arcs <span class="free">hom</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> iso_arcs <span class="free">hom</span> <span class="main">`</span> arcs <span class="free">G</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"iso_arcs <span class="main">(</span>inv_iso <span class="free">hom</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> arcs <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> A hom <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> arcs_app_iso image_eqI pre_digraph.iso_arcs_iso_inv<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>iso_arcs <span class="main">(</span>inv_iso <span class="free">hom</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>iso_arcs <span class="main">(</span>inv_iso <span class="free">hom</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="keyword1">permutes</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutes_not_in<span class="main">)</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> hom assms <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> arcs <span class="main">_</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wrap_iso_arcs_def perm_restrict_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> iso_arcs <span class="free">hom</span> <span class="main">`</span> arcs <span class="free">G</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wrap_iso_arcs_def perm_restrict_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> not_in_id <span class="main">=</span> this
  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">→</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> funcsetI_permutes<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> inj_on_wrap<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>wrap_iso_arcs <span class="free">hom</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>iso_arcs <span class="free">hom</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">→</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> inj_on_wrap_iso_arcs_f<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subset_inj_on permutes_inj<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> woa_in_fs<span class="main">:</span> <span class="quoted"><span class="quoted">"wrap_iso_arcs <span class="free">hom</span> <span class="free">f</span> <span class="main">∈</span> iso_arcs <span class="free">hom</span> <span class="main">`</span> <span class="free">A</span> <span class="main">→</span> iso_arcs <span class="free">hom</span> <span class="main">`</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">→</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> wrap_iso_arcs_in_funcsetI<span class="main">)</span>
  
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wrap_iso_arcs <span class="free">hom</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> wrap_iso_arcs <span class="free">hom</span> <span class="free">f</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> iso_arcs <span class="free">hom</span> <span class="main">`</span> <span class="free">A</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> iso_arcs <span class="free">hom</span> <span class="main">`</span> <span class="free">A</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> woa_in_fs inj_on_wrap <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> inj_onD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_in_id<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> uniqueD <span class="main">=</span> this
  
    <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="keyword1">permutes</span> <span class="free">A</span>›</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">note</span></span> not_in_id
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> wrap_iso_arcs <span class="free">hom</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> iso_arcs <span class="free">hom</span> <span class="main">`</span> <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y0</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"iso_arcs <span class="free">hom</span> <span class="skolem">y0</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="keyword1">permutes</span> <span class="free">A</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x0</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x0</span> <span class="main">=</span> <span class="skolem">y0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> permutes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> arcs <span class="free">G</span> <span class="main">⟹</span> iso_arcs <span class="free">hom</span> <span class="skolem">x0</span> <span class="main">=</span> iso_arcs <span class="free">hom</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">x0</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms hom <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> digraph_isomorphism_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> inj_onD<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wrap_iso_arcs <span class="free">hom</span> <span class="free">f</span> <span class="main">(</span>iso_arcs <span class="free">hom</span> <span class="skolem">x0</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">=</span> <span class="skolem">y</span>›</span></span> assms hom <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wrap_iso_arcs_def perm_restrict_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">metis</span> not_in_id<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> permutes_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> uniqueD<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> digraph_map<span class="main">)</span> digraph_map_isoI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"digraph_isomorphism <span class="free">hom</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"digraph_map <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span> <span class="main">(</span>map_iso <span class="free">hom</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> iG<span class="main">:</span> fin_digraph <span class="quoted"><span class="quoted">"app_iso <span class="free">hom</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fin_digraphI_app_iso<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iG.digraph_mapI_permutes<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"edge_rev <span class="main">(</span>map_iso <span class="free">hom</span><span class="main">)</span> <span class="keyword1">permutes</span> arcs <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> map_iso_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wrap_iso_arcs_permutes arev_permutes_arcs<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"edge_succ <span class="main">(</span>map_iso <span class="free">hom</span><span class="main">)</span> <span class="keyword1">permutes</span> arcs <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> map_iso_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wrap_iso_arcs_permutes edge_succ_permutes<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> arcs <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"tail <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span> <span class="main">(</span>edge_rev <span class="main">(</span>map_iso <span class="free">hom</span><span class="main">)</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> head <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> in_arcs_app_iso_cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_iso_def iso_verts_tail iso_verts_head<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"edge_rev <span class="main">(</span>map_iso <span class="free">hom</span><span class="main">)</span> <span class="main">(</span>edge_rev <span class="main">(</span>map_iso <span class="free">hom</span><span class="main">)</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> in_arcs_app_iso_cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_iso_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"edge_rev <span class="main">(</span>map_iso <span class="free">hom</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_iso_def arev_neq<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> verts <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> oa_hom<span class="main">:</span> <span class="quoted"><span class="quoted">"out_arcs <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v0</span> <span class="main">∈</span> verts <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> iso_verts <span class="free">hom</span> <span class="skolem">v0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> oa<span class="main">:</span> <span class="quoted"><span class="quoted">"out_arcs <span class="free">G</span> <span class="skolem">v0</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms oa_hom <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> out_arcs_def iso_verts_tail<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> cyclic_on_v0<span class="main">:</span> <span class="quoted"><span class="quoted">"cyclic_on <span class="main">(</span>edge_succ <span class="free">M</span><span class="main">)</span> <span class="main">(</span>out_arcs <span class="free">G</span> <span class="skolem">v0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> edge_succ_cyclic<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> oa_hom <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> out_arcs <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a0</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> iso_arcs <span class="free">hom</span> <span class="skolem">a0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a0</span> <span class="main">∈</span> out_arcs <span class="free">G</span> <span class="skolem">v0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v0</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iso_verts_tail<span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cyclic_on <span class="main">(</span>edge_succ <span class="main">(</span>map_iso <span class="free">hom</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>out_arcs <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> cyclic_on_singleI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> out_arcs <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"out_arcs <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">=</span> iso_arcs <span class="free">hom</span> <span class="main">`</span> out_arcs <span class="free">G</span> <span class="skolem">v0</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> out_arcs_app_iso_eq<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"out_arcs <span class="free">G</span> <span class="skolem">v0</span> <span class="main">=</span> orbit <span class="main">(</span>edge_succ <span class="free">M</span><span class="main">)</span> <span class="skolem">a0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> cyclic_on_v0 <span class="quoted"><span class="quoted">‹<span class="skolem">a0</span> <span class="main">∈</span> out_arcs <span class="free">G</span> <span class="skolem">v0</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cyclic_on_alldef <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"iso_arcs <span class="free">hom</span> <span class="main">`</span> <span class="main">…</span> <span class="main">=</span> orbit <span class="main">(</span>edge_succ <span class="main">(</span>map_iso <span class="free">hom</span><span class="main">)</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> orbit <span class="main">(</span>edge_succ <span class="free">M</span><span class="main">)</span> <span class="skolem">a0</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹out_arcs <span class="free">G</span> <span class="skolem">v0</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹out_arcs <span class="free">G</span> <span class="skolem">v0</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a0</span> <span class="main">∈</span> out_arcs <span class="free">G</span> <span class="skolem">v0</span>›</span></span> assms
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> orbit_inverse<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_iso_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"out_arcs <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">=</span> orbit <span class="main">(</span>edge_succ <span class="main">(</span>map_iso <span class="free">hom</span><span class="main">)</span><span class="main">)</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="List_Aux">
<div class="head">
<h1>Theory List_Aux</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> List_Aux
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../List-Index/List_Index.html">List-Index.List_Index</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary List Lemmas›</span></span>

<span class="keyword1" id="List_Aux-nth_rotate_conv_nth1_conv_nth"><span class="command">lemma</span></span> nth_rotate_conv_nth1_conv_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rotate1 <span class="free">xs</span> <span class="main">!</span> <span class="free">m</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="free">m</span> <span class="keyword1">mod</span> length <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> Cons.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> length <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="List_Aux-nth_rotate_conv_nth"><span class="command">lemma</span></span> nth_rotate_conv_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rotate <span class="free">n</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">m</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="main">(</span><span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">mod</span> length <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_rotate_conv_nth1_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="keyword1">mod</span> length <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span>Suc <span class="skolem">m</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="keyword1">mod</span> length <span class="free">xs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">n</span> <span class="keyword1">mod</span> length <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="keyword1">mod</span> length <span class="free">xs</span> <span class="main">=</span> <span class="skolem">n</span> <span class="keyword1">mod</span> length <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">.</span></span><span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_rotate_conv_nth1_conv_nth Suc.IH<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="List_Aux-not_nil_if_in_set"><span class="command">lemma</span></span> not_nil_if_in_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="List_Aux-length_fold_remove1_le"><span class="command">lemma</span></span> length_fold_remove1_le<span class="main">:</span>
 <span class="quoted"><span class="quoted">"length <span class="main">(</span>fold remove1 <span class="free">ys</span> <span class="free">xs</span><span class="main">)</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fold remove1 <span class="skolem">ys</span> <span class="main">(</span>remove1 <span class="skolem">y</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span>remove1 <span class="skolem">y</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> length <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_remove1<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="List_Aux-set_fold_remove1'"><span class="command">lemma</span></span> set_fold_remove1'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">-</span> set <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>fold remove1 <span class="free">ys</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="List_Aux-set_fold_remove1"><span class="command">lemma</span></span> set_fold_remove1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>fold remove1 <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> notin_set_remove1 subsetCE<span class="main">)</span>

<span class="keyword1" id="List_Aux-set_fold_remove1_distinct"><span class="command">lemma</span></span> set_fold_remove1_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>fold remove1 <span class="free">ys</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">-</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="List_Aux-distinct_fold_remove1"><span class="command">lemma</span></span> distinct_fold_remove1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>fold remove1 <span class="free">ys</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Executable_Permutations">
<div class="head">
<h1>Theory Executable_Permutations</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Permutations as Products of Disjoint Cycles›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Executable_Permutations
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Rewrite.html">HOL-Library.Rewrite</a>"</span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Combinatorics/Permutations.html">HOL-Combinatorics.Permutations</a>"</span>
  <a href="../../graph_theory/theories/#Auxiliary">Graph_Theory.Auxiliary</a>
  <a href="#List_Aux">List_Aux</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Cyclic Permutations›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">list_succ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list_succ</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="main">(</span><span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We demonstrate the functions on the following simple lemmas

  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">lemma</span></span> <span class="quoted"><span class="quoted">"list_succ <span class="main"><span class="main">[</span></span><span class="main"><span class="main">1</span></span> <span class="main"><span class="main">::</span></span> int<span class="main"><span class="main">,</span></span> <span class="numeral"><span class="numeral">2</span></span><span class="main"><span class="main">,</span></span> <span class="numeral"><span class="numeral">3</span></span><span class="main"><span class="main">]</span></span> <span class="main"><span class="main">1</span></span> <span class="main"><span class="main">=</span></span> <span class="numeral"><span class="numeral">2</span></span>"</span></span> <span class="keyword1"><span class="keyword"><span class="keyword1"><span class="keyword">by</span></span></span></span> <span class="operator"><span class="operator">code_simp</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">lemma</span></span> <span class="quoted"><span class="quoted">"list_succ <span class="main"><span class="main">[</span></span><span class="main"><span class="main">1</span></span> <span class="main"><span class="main">::</span></span> int<span class="main"><span class="main">,</span></span> <span class="numeral"><span class="numeral">2</span></span><span class="main"><span class="main">,</span></span> <span class="numeral"><span class="numeral">3</span></span><span class="main"><span class="main">]</span></span> <span class="numeral"><span class="numeral">2</span></span> <span class="main"><span class="main">=</span></span> <span class="numeral"><span class="numeral">3</span></span>"</span></span> <span class="keyword1"><span class="keyword"><span class="keyword1"><span class="keyword">by</span></span></span></span> <span class="operator"><span class="operator">code_simp</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">lemma</span></span> <span class="quoted"><span class="quoted">"list_succ <span class="main"><span class="main">[</span></span><span class="main"><span class="main">1</span></span> <span class="main"><span class="main">::</span></span> int<span class="main"><span class="main">,</span></span> <span class="numeral"><span class="numeral">2</span></span><span class="main"><span class="main">,</span></span> <span class="numeral"><span class="numeral">3</span></span><span class="main"><span class="main">]</span></span> <span class="numeral"><span class="numeral">3</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">1</span></span>"</span></span> <span class="keyword1"><span class="keyword"><span class="keyword1"><span class="keyword">by</span></span></span></span> <span class="operator"><span class="operator">code_simp</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
›</span></span>

<span class="keyword1" id="Executable_Permutations-list_succ_altdef"><span class="command">lemma</span></span> list_succ_altdef<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_succ <span class="free">xs</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> index <span class="free">xs</span> <span class="free">x</span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> length <span class="free">xs</span> <span class="keyword1">then</span> <span class="free">xs</span> <span class="main">!</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="keyword1">then</span> <span class="free">xs</span> <span class="main">!</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> index_le_size<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> list_succ_def index_less_size_conv<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-list_succ_Nil"><span class="command">lemma</span></span> list_succ_Nil<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_succ <span class="main">[]</span> <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_succ_def fun_eq_iff<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-list_succ_singleton"><span class="command">lemma</span></span> list_succ_singleton<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_succ <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> list_succ <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff list_succ_def<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-list_succ_short"><span class="command">lemma</span></span> list_succ_short<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_succ <span class="free">xs</span> <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">rename_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> y ys<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper">ys</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_succ_Nil list_succ_singleton<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-list_succ_simps"><span class="command">lemma</span></span> list_succ_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"index <span class="free">xs</span> <span class="free">x</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">⟹</span> list_succ <span class="free">xs</span> <span class="free">x</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="main">0</span>"</span></span>
  <span class="quoted"><span class="quoted">"index <span class="free">xs</span> <span class="free">x</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> list_succ <span class="free">xs</span> <span class="free">x</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="main">(</span>index <span class="free">xs</span> <span class="free">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">≤</span> index <span class="free">xs</span> <span class="free">x</span> <span class="main">⟹</span> list_succ <span class="free">xs</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_succ_altdef<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-list_succ_not_in"><span class="command">lemma</span></span> list_succ_not_in<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_succ <span class="free">xs</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_succ_def<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-list_succ_list_succ_rev"><span class="command">lemma</span></span> list_succ_list_succ_rev<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_succ <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>list_succ <span class="free">xs</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"index <span class="free">xs</span> <span class="free">x</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="main">(</span>index <span class="free">xs</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> index <span class="free">xs</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_succ_def index_rev index_nth_id rev_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"index <span class="free">xs</span> <span class="free">x</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> index <span class="free">xs</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> last_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_succ_def rev_nth index_rev index_nth_id last_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"index <span class="free">xs</span> <span class="free">x</span> <span class="main">≥</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> index_less less_irrefl<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_succ_def<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> discrete le_less not_less<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Executable_Permutations-inj_list_succ"><span class="command">lemma</span></span> inj_list_succ<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span> <span class="main">⟹</span> inj <span class="main">(</span>list_succ <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> injI list_succ_list_succ_rev<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-inv_list_succ_eq"><span class="command">lemma</span></span> inv_list_succ_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span> <span class="main">⟹</span> inv <span class="main">(</span>list_succ <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> list_succ <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distinct_rev inj_imp_inv_eq inj_list_succ list_succ_list_succ_rev<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-bij_list_succ"><span class="command">lemma</span></span> bij_list_succ<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span> <span class="main">⟹</span> bij <span class="main">(</span>list_succ <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bij_def inj_list_succ distinct_rev list_succ_list_succ_rev surj_def<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-list_succ_permutes"><span class="command">lemma</span></span> list_succ_permutes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_succ <span class="free">xs</span> <span class="keyword1">permutes</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutes_conv_has_dom bij_list_succ has_dom_def list_succ_def<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-permutation_list_succ"><span class="command">lemma</span></span> permutation_list_succ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"permutation <span class="main">(</span>list_succ <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> list_succ_permutes<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutation_permutes<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-list_succ_nth"><span class="command">lemma</span></span> list_succ_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_succ <span class="free">xs</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="free">n</span> <span class="keyword1">mod</span> length <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_succ_def index_nth_id<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-list_succ_last"><span class="command">lemma</span></span> list_succ_last<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_succ <span class="free">xs</span> <span class="main">(</span>last <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> hd <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_succ_def hd_conv_nth<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-list_succ_rotate1"><span class="command">lemma</span></span> list_succ_rotate1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_succ <span class="main">(</span>rotate1 <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> list_succ <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_succ <span class="main">(</span>rotate1 <span class="free">xs</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span> list_succ <span class="free">xs</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"index <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span> length <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_append<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span><span class="main">=</span><span class="main">[]</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_succ_def nth_append<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"index <span class="skolem">xs</span> <span class="skolem">y</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>list_succ_def index_append nth_append<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_lessI index_less_size_conv mod_self nth_Cons_0 nth_append nth_append_length<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="Executable_Permutations-list_succ_rotate"><span class="command">lemma</span></span> list_succ_rotate<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_succ <span class="main">(</span>rotate <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> list_succ <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Executable_Permutations-list_succ_in_conv"><span class="command">lemma</span></span> list_succ_in_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_succ <span class="free">xs</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_succ_def not_nil_if_in_set <span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-list_succ_in_conv1"><span class="command">lemma</span></span> list_succ_in_conv1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> set <span class="free">xs</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_succ <span class="free">xs</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms disjoint_iff_not_equal list_succ_in_conv list_succ_not_in<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-list_succ_commute"><span class="command">lemma</span></span> list_succ_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">∩</span> set <span class="free">ys</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_succ <span class="free">xs</span> <span class="main">(</span>list_succ <span class="free">ys</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> list_succ <span class="free">ys</span> <span class="main">(</span>list_succ <span class="free">xs</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> list_succ <span class="free">ys</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">ys</span> <span class="main">⟹</span> list_succ <span class="free">xs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> list_succ_not_in<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∪</span> set <span class="free">ys</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_succ_in_conv list_succ_not_in<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Arbitrary Permutations›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lists_succ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lists_succ</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lists_succ</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xss</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> list_succ <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free">lists_succ</span> <span class="free"><span class="bound"><span class="entity">xss</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">distincts</span> <span class="main">::</span>  <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">distincts</span> <span class="free"><span class="bound"><span class="entity">xss</span></span></span> <span class="main">≡</span> distinct <span class="free"><span class="bound"><span class="entity">xss</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">xss</span></span></span><span class="main">.</span> distinct <span class="bound">xs</span> <span class="main">∧</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">xss</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">ys</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">xss</span></span></span><span class="main">.</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="bound">ys</span> <span class="main">⟶</span> set <span class="bound">xs</span> <span class="main">∩</span> set <span class="bound">ys</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Executable_Permutations-distincts_distinct"><span class="command">lemma</span></span> distincts_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distincts <span class="free">xss</span> <span class="main">⟹</span> distinct <span class="free">xss</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distincts_def<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-distincts_Nil"><span class="command">lemma</span></span> distincts_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"distincts <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distincts_def<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-distincts_single"><span class="command">lemma</span></span> distincts_single<span class="main">:</span> <span class="quoted"><span class="quoted">"distincts <span class="main">[</span><span class="free">xs</span><span class="main">]</span> <span class="main">⟷</span> distinct <span class="free">xs</span> <span class="main">∧</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distincts_def<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-distincts_Cons"><span class="command">lemma</span></span> distincts_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"distincts <span class="main">(</span><span class="free">xs</span> <span class="main">#</span> <span class="free">xss</span><span class="main">)</span>
   <span class="main">⟷</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> distinct <span class="free">xs</span> <span class="main">∧</span> distincts <span class="free">xss</span> <span class="main">∧</span> <span class="main">(</span>set <span class="free">xs</span> <span class="main">∩</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">ys</span> <span class="main">∈</span> set <span class="free">xss</span><span class="main">.</span> set <span class="bound">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distincts_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">xs</span> <span class="main">#</span> <span class="free">xss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> disjoint_iff_not_equal distincts_distinct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> length_greater_0_conv nth_mem<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?R</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">xs</span> <span class="main">#</span> <span class="free">xss</span><span class="main">)</span><span class="main">.</span> distinct <span class="bound">xs</span> <span class="main">∧</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distincts_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?R</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs'</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">xs</span> <span class="main">#</span> <span class="free">xss</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">ys</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">xs</span> <span class="main">#</span> <span class="free">xss</span><span class="main">)</span><span class="main">.</span> <span class="bound">xs'</span> <span class="main">≠</span> <span class="bound">ys</span> <span class="main">⟶</span> set <span class="bound">xs'</span> <span class="main">∩</span> set <span class="bound">ys</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distincts_def<span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> distincts_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Executable_Permutations-distincts_Cons'"><span class="command">lemma</span></span> distincts_Cons'<span class="main">:</span> <span class="quoted"><span class="quoted">"distincts <span class="main">(</span><span class="free">xs</span> <span class="main">#</span> <span class="free">xss</span><span class="main">)</span>
   <span class="main">⟷</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> distinct <span class="free">xs</span> <span class="main">∧</span> distincts <span class="free">xss</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ys</span> <span class="main">∈</span> set <span class="free">xss</span><span class="main">.</span> set <span class="free">xs</span> <span class="main">∩</span> set <span class="bound">ys</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command">unfolding</span></span> distincts_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Executable_Permutations-distincts_rev"><span class="command">lemma</span></span> distincts_rev<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distincts <span class="main">(</span>map rev <span class="free">xss</span><span class="main">)</span> <span class="main">⟷</span> distincts <span class="free">xss</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distincts_def distinct_map<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-length_distincts"><span class="command">lemma</span></span> length_distincts<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distincts <span class="free">xss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xss</span> <span class="main">=</span> card <span class="main">(</span>set <span class="main">`</span> set <span class="free">xss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xss</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">xs</span> <span class="skolem">xss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">∉</span> set <span class="main">`</span> set <span class="skolem">xss</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> equals0I<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distincts_Cons disjoint_iff_not_equal <span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distincts_Cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Executable_Permutations-distincts_remove1"><span class="command">lemma</span></span> distincts_remove1<span class="main">:</span> <span class="quoted"><span class="quoted">"distincts <span class="free">xss</span> <span class="main">⟹</span> distincts <span class="main">(</span>remove1 <span class="free">xs</span> <span class="free">xss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distincts_def<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-distinct_Cons_remove1"><span class="command">lemma</span></span> distinct_Cons_remove1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> distinct <span class="main">(</span><span class="free">x</span> <span class="main">#</span> remove1 <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> distinct <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Executable_Permutations-set_Cons_remove1"><span class="command">lemma</span></span> set_Cons_remove1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> set <span class="main">(</span><span class="free">x</span> <span class="main">#</span> remove1 <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Executable_Permutations-distincts_Cons_remove1"><span class="command">lemma</span></span> distincts_Cons_remove1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> set <span class="free">xss</span> <span class="main">⟹</span> distincts <span class="main">(</span><span class="free">xs</span> <span class="main">#</span> remove1 <span class="free">xs</span> <span class="free">xss</span><span class="main">)</span> <span class="main">=</span> distincts <span class="free">xss</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> distinct_Cons_remove1 set_Cons_remove1 distincts_def<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-distincts_inj_on_set"><span class="command">lemma</span></span> distincts_inj_on_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distincts <span class="free">xss</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on set <span class="main">(</span>set <span class="free">xss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> assms distincts_def inf.idem set_empty<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-distincts_distinct_set"><span class="command">lemma</span></span> distincts_distinct_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distincts <span class="free">xss</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map set <span class="free">xss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distinct_map distincts_distinct distincts_inj_on_set<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-distincts_distinct_nth"><span class="command">lemma</span></span> distincts_distinct_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distincts <span class="free">xss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xss</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">xss</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distincts_def<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-lists_succ_not_in"><span class="command">lemma</span></span> lists_succ_not_in<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span><span class="main">∈</span>set <span class="free">xss</span><span class="main">.</span> set <span class="bound">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lists_succ <span class="free">xss</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xss</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_succ_not_in<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-lists_succ_in_conv"><span class="command">lemma</span></span> lists_succ_in_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lists_succ <span class="free">xss</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span><span class="main">∈</span>set <span class="free">xss</span><span class="main">.</span> set <span class="bound">xs</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span><span class="main">∈</span>set <span class="free">xss</span><span class="main">.</span> set <span class="bound">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xss</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_succ_in_conv lists_succ_not_in list_succ_not_in<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-lists_succ_in_conv1"><span class="command">lemma</span></span> lists_succ_in_conv1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span><span class="main">∈</span>set <span class="free">xss</span><span class="main">.</span> set <span class="bound">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lists_succ <span class="free">xss</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_iff assms emptyE lists_succ_in_conv lists_succ_not_in<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-lists_succ_Cons_pf"><span class="command">lemma</span></span> lists_succ_Cons_pf<span class="main">:</span> <span class="quoted"><span class="quoted">"lists_succ <span class="main">(</span><span class="free">xs</span> <span class="main">#</span> <span class="free">xss</span><span class="main">)</span> <span class="main">=</span> list_succ <span class="free">xs</span> <span class="keyword1">o</span> lists_succ <span class="free">xss</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Executable_Permutations-lists_succ_Nil_pf"><span class="command">lemma</span></span> lists_succ_Nil_pf<span class="main">:</span> <span class="quoted"><span class="quoted">"lists_succ <span class="main">[]</span> <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> lists_succ_simps_pf <span class="main">=</span> lists_succ_Cons_pf lists_succ_Nil_pf

<span class="keyword1" id="Executable_Permutations-lists_succ_permutes"><span class="command">lemma</span></span> lists_succ_permutes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distincts <span class="free">xss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lists_succ <span class="free">xss</span> <span class="keyword1">permutes</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span> <span class="main">∈</span> set <span class="free">xss</span><span class="main">.</span> set <span class="bound">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xss</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">xs</span> <span class="skolem">xss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_succ <span class="skolem">xs</span> <span class="keyword1">permutes</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> list_succ_permutes<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distincts_def in_set_member<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lists_succ <span class="skolem">xss</span> <span class="keyword1">permutes</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">ys</span> <span class="main">∈</span> set <span class="skolem">xss</span><span class="main">.</span> set <span class="bound">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons distincts_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lists_succ <span class="main">(</span><span class="skolem">xs</span> <span class="main">#</span> <span class="skolem">xss</span><span class="main">)</span> <span class="keyword1">permutes</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">ys</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">xs</span> <span class="main">#</span> <span class="skolem">xss</span><span class="main">)</span><span class="main">.</span> set <span class="bound">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lists_succ_Cons_pf <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> permutes_compose permutes_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Executable_Permutations-bij_lists_succ"><span class="command">lemma</span></span> bij_lists_succ<span class="main">:</span> <span class="quoted"><span class="quoted">"distincts <span class="free">xss</span> <span class="main">⟹</span> bij <span class="main">(</span>lists_succ <span class="free">xss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xss</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lists_succ_simps_pf bij_comp bij_list_succ distincts_Cons<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-lists_succ_snoc"><span class="command">lemma</span></span> lists_succ_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"lists_succ <span class="main">(</span><span class="free">xss</span> <span class="main">@</span> <span class="main">[</span><span class="free">xs</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> lists_succ <span class="free">xss</span> <span class="keyword1">o</span> list_succ <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xss</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Executable_Permutations-inv_lists_succ_eq"><span class="command">lemma</span></span> inv_lists_succ_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distincts <span class="free">xss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv <span class="main">(</span>lists_succ <span class="free">xss</span><span class="main">)</span> <span class="main">=</span> lists_succ <span class="main">(</span>rev <span class="main">(</span>map rev <span class="free">xss</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> inv <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="bound">f</span> <span class="main">(</span><span class="bound">g</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> inv <span class="main">(</span><span class="bound">f</span> <span class="keyword1">o</span> <span class="bound">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"lists_succ <span class="main">[]</span> <span class="main">=</span> id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xss</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> * ** lists_succ_snoc lists_succ_Cons_pf o_inv_distrib
      inv_list_succ_eq distincts_Cons bij_list_succ bij_lists_succ<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Executable_Permutations-lists_succ_remove1"><span class="command">lemma</span></span> lists_succ_remove1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distincts <span class="free">xss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> set <span class="free">xss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lists_succ <span class="main">(</span><span class="free">xs</span> <span class="main">#</span> remove1 <span class="free">xs</span> <span class="free">xss</span><span class="main">)</span> <span class="main">=</span> lists_succ <span class="free">xss</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xss</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">ys</span> <span class="skolem">xss</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> Cons.prems <span class="keyword1"><span class="command">have</span></span> inter<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">∩</span> set <span class="skolem">ys</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> set <span class="skolem">xss</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distincts_Cons<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> dists<span class="main">:</span>
        <span class="quoted"><span class="quoted">"distincts <span class="main">(</span><span class="free">xs</span> <span class="main">#</span> remove1 <span class="free">xs</span> <span class="skolem">xss</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"distincts <span class="main">(</span><span class="free">xs</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">#</span> remove1 <span class="free">xs</span> <span class="skolem">xss</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹distincts <span class="main">(</span><span class="skolem">ys</span> <span class="main">#</span> <span class="skolem">xss</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span> <span class="main">∈</span> set <span class="skolem">xss</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distincts_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_succ <span class="free">xs</span> <span class="main">∘</span> <span class="main">(</span>list_succ <span class="skolem">ys</span> <span class="main">∘</span> lists_succ <span class="main">(</span>remove1 <span class="free">xs</span> <span class="skolem">xss</span><span class="main">)</span><span class="main">)</span>
        <span class="main">=</span> list_succ <span class="skolem">ys</span> <span class="main">∘</span> <span class="main">(</span>list_succ <span class="free">xs</span> <span class="main">∘</span> lists_succ <span class="main">(</span>remove1 <span class="free">xs</span> <span class="skolem">xss</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> inter <span class="keyword1"><span class="command">unfolding</span></span> fun_eq_iff comp_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> list_succ_commute<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> list_succ <span class="skolem">ys</span> <span class="keyword1">o</span> <span class="main">(</span>lists_succ <span class="main">(</span><span class="free">xs</span> <span class="main">#</span> remove1 <span class="free">xs</span> <span class="skolem">xss</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dists <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lists_succ_Cons_pf distincts_Cons<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> list_succ <span class="skolem">ys</span> <span class="keyword1">o</span> lists_succ <span class="skolem">xss</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span> <span class="main">∈</span> set <span class="skolem">xss</span>›</span></span> <span class="quoted"><span class="quoted">‹distincts <span class="main">(</span><span class="skolem">ys</span> <span class="main">#</span> <span class="skolem">xss</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distincts_Cons Cons.hyps<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lists_succ <span class="main">(</span><span class="free">xs</span> <span class="main">#</span> remove1 <span class="free">xs</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">#</span> <span class="skolem">xss</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lists_succ <span class="main">(</span><span class="skolem">ys</span> <span class="main">#</span> <span class="skolem">xss</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons dists <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lists_succ_Cons_pf distincts_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Executable_Permutations-lists_succ_no_order"><span class="command">lemma</span></span> lists_succ_no_order<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distincts <span class="free">xss</span>"</span></span> <span class="quoted"><span class="quoted">"distincts <span class="free">yss</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xss</span> <span class="main">=</span> set <span class="free">yss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lists_succ <span class="free">xss</span> <span class="main">=</span> lists_succ <span class="free">yss</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">yss</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">xs</span> <span class="skolem">xss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∉</span> set <span class="skolem">xss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> set <span class="skolem">yss</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> distincts_distinct<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lists_succ <span class="skolem">xss</span> <span class="main">=</span> lists_succ <span class="main">(</span>remove1 <span class="skolem">xs</span> <span class="skolem">yss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">∉</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Cons.hyps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distincts_Cons distincts_remove1 distincts_distinct<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lists_succ <span class="main">(</span><span class="skolem">xs</span> <span class="main">#</span> <span class="skolem">xss</span><span class="main">)</span> <span class="main">=</span> lists_succ <span class="main">(</span><span class="skolem">xs</span> <span class="main">#</span> remove1 <span class="skolem">xs</span> <span class="skolem">yss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">∈</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lists_succ_Cons_pf distincts_Cons_remove1<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lists_succ_remove1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹List Orbits›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Computes the orbit of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> under <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">orbit_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">orbit_list</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> iterate <span class="main">0</span> <span class="main">(</span>funpow_dist1 <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>tailrec<span class="main">)</span>
  <span class="entity">orbit_list_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">orbit_list_impl</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">x'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">x'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> rev <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">orbit_list_impl</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span><span class="main">)</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> length_fold_remove1_le <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Computes the list of orbits›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">orbits_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">orbits_list</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">orbits_list</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span>
     orbit_list <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">orbits_list</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>fold remove1 <span class="main">(</span>orbit_list <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">orbits_list_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">orbits_list_impl</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">orbits_list_impl</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="bound">fc</span> <span class="main">=</span> orbit_list_impl <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">in</span> <span class="bound">fc</span> <span class="main">#</span> <span class="free">orbits_list_impl</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>fold remove1 <span class="bound">fc</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> orbit_list_impl.simps<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">sset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list list <span class="main">⇒</span> <span class="tfree">'a</span> set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sset</span> <span class="free"><span class="bound"><span class="entity">xss</span></span></span> <span class="main">≡</span> set <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">xss</span></span></span>"</span></span>

<span class="keyword1" id="Executable_Permutations-iterate_funpow_step"><span class="command">lemma</span></span> iterate_funpow_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> orbit <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"iterate <span class="main">0</span> <span class="main">(</span>funpow_dist1 <span class="free">f</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> iterate <span class="main">0</span> <span class="main">(</span>funpow_dist1 <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span> <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> orbit <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> orbit_step<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"iterate <span class="main">0</span> <span class="main">(</span>funpow_dist1 <span class="free">f</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> iterate <span class="main">1</span> <span class="main">(</span>funpow_dist1 <span class="free">f</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">f</span> <span class="free">x</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">#</span> <span class="var">?it</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> iterate_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">⌑</span></span></span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span>"</span></span></span></span> upt_conv_Cons<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?it</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="bound">n</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>map Suc <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>funpow_dist <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> iterate_def map_Suc_upt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>funpow_dist <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="free">y</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funpow_swap1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> iterate <span class="main">0</span> <span class="main">(</span>funpow_dist1 <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span> <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> iterate_def
    <span class="keyword1"><span class="command">unfolding</span></span> iterate_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funpow_dist_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Executable_Permutations-orbit_list_impl_conv"><span class="command">lemma</span></span> orbit_list_impl_conv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> orbit <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"orbit_list_impl <span class="free">f</span> <span class="free">y</span> <span class="free">acc</span> <span class="free">x</span> <span class="main">=</span> rev <span class="free">acc</span> <span class="main">@</span> iterate <span class="main">0</span> <span class="main">(</span>funpow_dist1 <span class="free">f</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="skolem">n</span><span class="main"><span class="main">≡</span></span><span class="quoted"><span class="quoted">"funpow_dist1 <span class="free">f</span> <span class="free">x</span> <span class="free">y</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">acc</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">x</span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> orbit_list_impl.simps<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def iterate_def funpow_dist_0<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> not_y <span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> y_in_succ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> orbit <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> orbit_step Suc.prems not_y<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"orbit_list_impl <span class="free">f</span> <span class="free">y</span> <span class="skolem">acc</span> <span class="skolem">x</span> <span class="main">=</span> orbit_list_impl <span class="free">f</span> <span class="free">y</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">acc</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> not_y <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> orbit_list_impl.simps<span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> rev <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">acc</span><span class="main">)</span> <span class="main">@</span> iterate <span class="main">0</span> <span class="main">(</span>funpow_dist1 <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span> <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?rev</span> <span class="main">@</span> <span class="var">?it</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Suc funpow_dist_step not_y y_in_succ<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> rev <span class="skolem">acc</span> <span class="main">@</span> iterate <span class="main">0</span> <span class="main">(</span>funpow_dist1 <span class="free">f</span> <span class="skolem">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> not_y Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iterate_funpow_step<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Executable_Permutations-orbit_list_conv_impl"><span class="command">lemma</span></span> orbit_list_conv_impl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> orbit <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"orbit_list <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> orbit_list_impl <span class="free">f</span> <span class="free">x</span> <span class="main">[]</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> orbit_list_impl_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> orbit_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1" id="Executable_Permutations-set_orbit_list"><span class="command">lemma</span></span> set_orbit_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> orbit <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>orbit_list <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> orbit <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> orbit_list_def orbit_conv_funpow_dist1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> set_iterate<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-set_orbit_list'"><span class="command">lemma</span></span> set_orbit_list'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"permutation <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>orbit_list <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> orbit <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutation_self_in_orbit set_orbit_list<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-distinct_orbit_list"><span class="command">lemma</span></span> distinct_orbit_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> orbit <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>orbit_list <span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> orbit_list_def iterate_def distinct_map inj_on_funpow_dist1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-distinct_orbit_list'"><span class="command">lemma</span></span> distinct_orbit_list'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"permutation <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>orbit_list <span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutation_self_in_orbit distinct_orbit_list<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-orbits_list_conv_impl"><span class="command">lemma</span></span> orbits_list_conv_impl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"permutation <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"orbits_list <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> orbits_list_impl <span class="free">f</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> less <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms less less_Suc_eq_le length_fold_remove1_le
      orbit_list_conv_impl permutation_self_in_orbit Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Executable_Permutations-orbit_list_not_nil"><span class="command">lemma</span></span> orbit_list_not_nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"orbit_list <span class="free">f</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> orbit_list_def<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-sset_orbits_list"><span class="command">lemma</span></span> sset_orbits_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"permutation <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sset <span class="main">(</span>orbits_list <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>orbit <span class="free">f</span><span class="main">)</span> <span class="main">`</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> less
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x'</span> <span class="skolem">xs'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs''</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fold remove1 <span class="main">(</span>orbit_list <span class="free">f</span> <span class="skolem">x'</span><span class="main">)</span> <span class="skolem">xs'</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"sset <span class="main">(</span>orbits_list <span class="free">f</span> <span class="var">?xs''</span><span class="main">)</span> <span class="main">=</span> orbit <span class="free">f</span> <span class="main">`</span> set <span class="var">?xs''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_Suc_eq_le length_fold_remove1_le less.hyps<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>orbit_list <span class="free">f</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">=</span> orbit <span class="free">f</span> <span class="skolem">x'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> set_orbit_list<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutation_self_in_orbit assms<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"orbit <span class="free">f</span> <span class="main">`</span> set <span class="main">(</span>fold remove1 <span class="main">(</span>orbit_list <span class="free">f</span> <span class="skolem">x'</span><span class="main">)</span> <span class="skolem">xs'</span><span class="main">)</span> <span class="main">⊆</span> orbit <span class="free">f</span> <span class="main">`</span> set <span class="skolem">xs'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> set_fold_remove1<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">xs'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"orbit <span class="free">f</span> <span class="main">`</span> set <span class="skolem">xs'</span> <span class="main">-</span> <span class="main">{</span>orbit <span class="free">f</span> <span class="skolem">x'</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">(</span>orbit <span class="free">f</span> <span class="main">`</span> set <span class="main">(</span>fold remove1 <span class="main">(</span>orbit_list <span class="free">f</span> <span class="skolem">x'</span><span class="main">)</span> <span class="skolem">xs'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⊆</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> orbit <span class="free">f</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="skolem">xs'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> orbit <span class="free">f</span> <span class="skolem">x'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">∈</span> <span class="var">?L</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">≠</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> orbit <span class="free">f</span> <span class="skolem">x'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms cyclic_on_orbit orbit_cyclic_eq3 permutation_permutes<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="main">(</span>fold remove1 <span class="main">(</span>orbit_list <span class="free">f</span> <span class="skolem">x'</span><span class="main">)</span> <span class="skolem">xs'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_fold_remove1' set_orbit_list permutation_self_in_orbit assms<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A B Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Relation to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">cyclic_on</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1" id="Executable_Permutations-list_succ_orbit_list"><span class="command">lemma</span></span> list_succ_orbit_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> orbit <span class="free">f</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> orbit <span class="free">f</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_succ <span class="main">(</span>orbit_list <span class="free">f</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>orbit_list <span class="free">f</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> set <span class="main">(</span>orbit_list <span class="free">f</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_orbit_list set_orbit_list<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>orbit_list <span class="free">f</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> orbit_list <span class="free">f</span> <span class="free">s</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="bound">i</span> <span class="keyword1">mod</span> length <span class="main">(</span>orbit_list <span class="free">f</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>orbit_list <span class="free">f</span> <span class="free">s</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> funpow_dist1_prop<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> orbit <span class="free">f</span> <span class="free">s</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> orbit_list_def funpow_mod_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_succ_def fun_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Executable_Permutations-list_succ_funpow_conv"><span class="command">lemma</span></span> list_succ_funpow_conv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>list_succ <span class="free">xs</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="main">(</span><span class="main">(</span>index <span class="free">xs</span> <span class="free">x</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">mod</span> length <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hd_conv_nth A index_nth_id list_succ_def <span class="dynamic"><span class="dynamic">mod_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Executable_Permutations-orbit_list_succ"><span class="command">lemma</span></span> orbit_list_succ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"orbit <span class="main">(</span>list_succ <span class="free">xs</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> set_eqI iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> orbit <span class="main">(</span>list_succ <span class="free">xs</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_succ_in_conv <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">xs</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="main">(</span><span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="bound">n</span><span class="main">)</span> <span class="keyword1">mod</span> length <span class="free">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">+</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> orbit <span class="main">(</span>list_succ <span class="free">xs</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> orbit_altdef_permutation permutation_list_succ list_succ_funpow_conv index_nth_id in_set_conv_nth<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Executable_Permutations-cyclic_on_list_succ"><span class="command">lemma</span></span> cyclic_on_list_succ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cyclic_on <span class="main">(</span>list_succ <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms last_in_set <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cyclic_on_def orbit_list_succ<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-obtain_orbit_list_func"><span class="command">lemma</span></span> obtain_orbit_list_func<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> orbit <span class="free">f</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> orbit <span class="free">f</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">xs</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> list_succ <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> orbit <span class="free">f</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">xs</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> list_succ <span class="main">(</span>orbit_list <span class="free">f</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_succ_orbit_list<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>orbit_list <span class="free">f</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> orbit <span class="free">f</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>orbit_list <span class="free">f</span> <span class="free">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_orbit_list distinct_orbit_list assms<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>orbit_list <span class="free">f</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> orbit_list_def iterate_def hd_map <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs</span><span class="main">.</span> <span class="free">f</span> <span class="main">=</span> list_succ <span class="bound">xs</span> <span class="main">∧</span> set <span class="bound">xs</span> <span class="main">=</span> orbit <span class="free">f</span> <span class="free">s</span> <span class="main">∧</span> distinct <span class="bound">xs</span> <span class="main">∧</span> hd <span class="bound">xs</span> <span class="main">=</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> that<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Executable_Permutations-cyclic_on_obtain_list_succ"><span class="command">lemma</span></span> cyclic_on_obtain_list_succ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cyclic_on <span class="free">f</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">xs</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> list_succ <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> orbit <span class="free">f</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> orbit <span class="free">f</span> <span class="skolem">s</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> orbit <span class="free">f</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cyclic_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> that obtain_orbit_list_func<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Executable_Permutations-cyclic_on_obtain_list_succ'"><span class="command">lemma</span></span> cyclic_on_obtain_list_succ'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cyclic_on <span class="free">f</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">permutes</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">xs</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> list_succ <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> permutes_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cyclic_on_obtain_list_succ<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-list_succ_unique"><span class="command">lemma</span></span> list_succ_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> orbit <span class="free">f</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> orbit <span class="free">f</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">xs</span><span class="main">.</span> <span class="free">f</span> <span class="main">=</span> list_succ <span class="bound">xs</span> <span class="main">∧</span> distinct <span class="bound">xs</span> <span class="main">∧</span> hd <span class="bound">xs</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> set <span class="bound">xs</span> <span class="main">=</span> orbit <span class="free">f</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> list_succ <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">xs</span> <span class="main">=</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">=</span> orbit <span class="free">f</span> <span class="free">s</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> obtain_orbit_list_func<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">zs</span>
    <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> list_succ <span class="skolem">zs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">zs</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">zs</span> <span class="main">=</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">zs</span> <span class="main">=</span> orbit <span class="free">f</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> orbit <span class="free">f</span> <span class="free">s</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="skolem">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="skolem">zs</span>›</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">xs</span> <span class="main">=</span> orbit <span class="free">f</span> <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">zs</span> <span class="main">=</span> orbit <span class="free">f</span> <span class="free">s</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> length <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distinct_card<span class="main">)</span>

    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">with</span></span> A xs <span class="quoted"><span class="quoted">‹<span class="skolem">zs</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_conv_nth nth_rotate_conv_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_succ <span class="skolem">zs</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> list_succ <span class="skolem">xs</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">!</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">=</span> list_succ <span class="skolem">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">=</span> list_succ <span class="skolem">zs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">n</span> <span class="main">&lt;</span> <span class="main">_</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>list_succ_nth len <span class="quoted"><span class="quoted">‹distinct <span class="skolem">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="skolem">zs</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> len nth_equalityI<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Executable_Permutations-distincts_orbits_list"><span class="command">lemma</span></span> distincts_orbits_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">as</span>"</span></span> <span class="quoted"><span class="quoted">"permutation <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distincts <span class="main">(</span>orbits_list <span class="free">f</span> <span class="free">as</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"length <span class="free">as</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> less
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">as</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?as'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fold remove1 <span class="main">(</span>orbit_list <span class="free">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">as'</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> Cons less.prems <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"distincts <span class="main">(</span>orbits_list <span class="free">f</span> <span class="main">(</span>fold remove1 <span class="main">(</span>orbit_list <span class="free">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">as'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> less<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distinct_fold_remove1 length_fold_remove1_le less_Suc_eq_le<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>orbit_list <span class="free">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∩</span> <span class="main">⋃</span><span class="main">(</span>sset <span class="main">(</span>orbits_list <span class="free">f</span> <span class="main">(</span>fold remove1 <span class="main">(</span>orbit_list <span class="free">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">as'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"orbit <span class="free">f</span> <span class="skolem">a</span> <span class="main">∩</span> set <span class="main">(</span>fold remove1 <span class="main">(</span>orbit_list <span class="free">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">as'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms less.prems Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_fold_remove1_distinct set_orbit_list'<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"orbit <span class="free">f</span> <span class="skolem">a</span> <span class="main">∩</span> <span class="main">⋃</span> <span class="main">(</span>orbit <span class="free">f</span> <span class="main">`</span> set <span class="main">(</span>fold remove1 <span class="main">(</span>orbit_list <span class="free">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">as'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cyclic_on_orbit disjoint_iff_not_equal permutation_self_in_orbit<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> orbit_cyclic_eq3 permutation_permutes<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_orbit_list' sset_orbits_list disjoint_iff_not_equal<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> A B assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distincts_Cons Cons distinct_orbit_list'<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Executable_Permutations-cyclic_on_lists_succ'"><span class="command">lemma</span></span> cyclic_on_lists_succ'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distincts <span class="free">xss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> sset <span class="free">xss</span> <span class="main">⟹</span> cyclic_on <span class="main">(</span>lists_succ <span class="free">xss</span><span class="main">)</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">xs</span> <span class="skolem">xss</span> <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> inter<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">∩</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">ys</span><span class="main">∈</span>set <span class="skolem">xss</span><span class="main">.</span> set <span class="bound">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distincts_Cons<span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> pcp<span class="main">[</span><span class="operator">OF</span> _ _ inter<span class="main">]</span> <span class="main">=</span> permutes_comp_preserves_cyclic1 permutes_comp_preserves_cyclic2
  <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cyclic_on <span class="main">(</span>lists_succ <span class="main">(</span><span class="skolem">xs</span> <span class="main">#</span> <span class="skolem">xss</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> set <span class="skolem">xs</span>"</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pcp <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cyclic_on_list_succ list_succ_permutes
        lists_succ_permutes lists_succ_Cons_pf distincts_Cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Executable_Permutations-cyclic_on_lists_succ"><span class="command">lemma</span></span> cyclic_on_lists_succ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distincts <span class="free">xss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> set <span class="free">xss</span> <span class="main">⟹</span> cyclic_on <span class="main">(</span>lists_succ <span class="free">xss</span><span class="main">)</span> <span class="main">(</span>set <span class="bound">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cyclic_on_lists_succ'<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-permutes_as_lists_succ"><span class="command">lemma</span></span> permutes_as_lists_succ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distincts <span class="free">xss</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ls_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> set <span class="free">xss</span> <span class="main">⟹</span> list_succ <span class="bound">xs</span> <span class="main">=</span> perm_restrict <span class="free">f</span> <span class="main">(</span>set <span class="bound">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">permutes</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>sset <span class="free">xss</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> lists_succ <span class="free">xss</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">xs</span> <span class="skolem">xss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sets</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">xss</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">ys</span> <span class="main">∈</span> set <span class="bound">xss</span><span class="main">.</span> set <span class="bound">ys</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distincts_Cons<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> f_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"perm_restrict <span class="skolem">f</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> list_succ <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> co_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"cyclic_on <span class="main">(</span>perm_restrict <span class="skolem">f</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> f_xs <span class="keyword1"><span class="command">using</span></span> xs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cyclic_on_list_succ<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> perm_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"perm_restrict <span class="skolem">f</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1">permutes</span> set <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> f_xs <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="skolem">xs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> list_succ_permutes<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> perm_xss<span class="main">:</span> <span class="quoted"><span class="quoted">"perm_restrict <span class="skolem">f</span> <span class="main">(</span><span class="var">?sets</span> <span class="skolem">xss</span><span class="main">)</span> <span class="keyword1">permutes</span> <span class="main">(</span><span class="var">?sets</span> <span class="skolem">xss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"perm_restrict <span class="skolem">f</span> <span class="main">(</span><span class="var">?sets</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">#</span> <span class="skolem">xss</span><span class="main">)</span> <span class="main">-</span> set <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1">permutes</span> <span class="main">(</span><span class="var">?sets</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">#</span> <span class="skolem">xss</span><span class="main">)</span> <span class="main">-</span> set <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons co_xs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> perm_restrict_diff_cyclic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cyclic_on_perm_restrict<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sets</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">#</span> <span class="skolem">xss</span><span class="main">)</span> <span class="main">-</span> set <span class="skolem">xs</span> <span class="main">=</span> <span class="var">?sets</span> <span class="skolem">xss</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distincts_Cons<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> f_xss<span class="main">:</span> <span class="quoted"><span class="quoted">"perm_restrict <span class="skolem">f</span> <span class="main">(</span><span class="var">?sets</span> <span class="skolem">xss</span><span class="main">)</span> <span class="main">=</span> lists_succ <span class="skolem">xss</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> set <span class="skolem">xss</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">xss</span><span class="main">.</span> set <span class="bound">x</span><span class="main">)</span> <span class="main">∩</span> set <span class="bound">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="bound">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> perm_xss Cons.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Cons.hyps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distincts_Cons perm_restrict_perm_restrict *<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> lists_succ <span class="main">(</span><span class="skolem">xs</span> <span class="main">#</span> <span class="skolem">xss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lists_succ_Cons_pf distincts_Cons f_xss<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
      perm_restrict_union perm_xs perm_xss<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Executable_Permutations-cyclic_on_obtain_lists_succ"><span class="command">lemma</span></span> cyclic_on_obtain_lists_succ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    permutes<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">permutes</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>sset <span class="free">css</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    dists<span class="main">:</span> <span class="quoted"><span class="quoted">"distincts <span class="free">css</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    cyclic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cs</span><span class="main">.</span> <span class="bound">cs</span> <span class="main">∈</span> set <span class="free">css</span> <span class="main">⟹</span> cyclic_on <span class="free">f</span> <span class="main">(</span>set <span class="bound">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">xss</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> lists_succ <span class="free">xss</span>"</span></span> <span class="quoted"><span class="quoted">"distincts <span class="free">xss</span>"</span></span> <span class="quoted"><span class="quoted">"map set <span class="free">xss</span> <span class="main">=</span> map set <span class="free">css</span>"</span></span> <span class="quoted"><span class="quoted">"map hd <span class="free">xss</span> <span class="main">=</span> map hd <span class="free">css</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fc</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">cs</span><span class="main">.</span> perm_restrict <span class="free">f</span> <span class="main">(</span>set <span class="bound">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">some_list</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">some_list</span> <span class="skolem">cs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">xs</span><span class="main">.</span> <span class="var">?fc</span> <span class="skolem">cs</span> <span class="main">=</span> list_succ <span class="bound">xs</span> <span class="main">∧</span> set <span class="bound">xs</span> <span class="main">=</span> set <span class="skolem">cs</span> <span class="main">∧</span> distinct <span class="bound">xs</span> <span class="main">∧</span> hd <span class="bound">xs</span> <span class="main">=</span> hd <span class="skolem">cs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">cs</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cs</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">∈</span> set <span class="free">css</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cyclic_on <span class="main">(</span><span class="var">?fc</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">cs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> set <span class="skolem">cs</span> <span class="main">⟹</span> <span class="var">?fc</span> <span class="skolem">cs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">cs</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cyclic dists <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cyclic_on_perm_restrict perm_restrict_def distincts_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">cs</span> <span class="main">∈</span> orbit <span class="main">(</span><span class="var">?fc</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">(</span>hd <span class="skolem">cs</span><span class="main">)</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> orbit <span class="main">(</span><span class="var">?fc</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">(</span>hd <span class="skolem">cs</span><span class="main">)</span> <span class="main">⟹</span> <span class="var">?fc</span> <span class="skolem">cs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">cs</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">cs</span> <span class="main">=</span> orbit <span class="main">(</span><span class="var">?fc</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">(</span>hd <span class="skolem">cs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cyclic_on_alldef<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs</span><span class="main">.</span> <span class="var">?fc</span> <span class="skolem">cs</span> <span class="main">=</span> list_succ <span class="bound">xs</span> <span class="main">∧</span> set <span class="bound">xs</span> <span class="main">=</span> set <span class="skolem">cs</span> <span class="main">∧</span> distinct <span class="bound">xs</span> <span class="main">∧</span> hd <span class="bound">xs</span> <span class="main">=</span> hd <span class="skolem">cs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> obtain_orbit_list_func<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fc</span> <span class="skolem">cs</span> <span class="main">=</span> list_succ <span class="main">(</span><span class="skolem">some_list</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">∧</span> set <span class="main">(</span><span class="skolem">some_list</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">cs</span> <span class="main">∧</span> distinct <span class="main">(</span><span class="skolem">some_list</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">∧</span> hd <span class="main">(</span><span class="skolem">some_list</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">=</span> hd <span class="skolem">cs</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> some_list_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI_ex<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fc</span> <span class="skolem">cs</span> <span class="main">=</span> list_succ <span class="main">(</span><span class="skolem">some_list</span> <span class="skolem">cs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">some_list</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="skolem">some_list</span> <span class="skolem">cs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span><span class="skolem">some_list</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">=</span> hd <span class="skolem">cs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> sl_cs  <span class="main">=</span> this

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cs</span><span class="main">.</span> <span class="bound">cs</span> <span class="main">∈</span> set <span class="free">css</span> <span class="main">⟹</span> <span class="bound">cs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dists <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distincts_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> some_list_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cs</span><span class="main">.</span> <span class="bound">cs</span> <span class="main">∈</span> set <span class="free">css</span> <span class="main">⟹</span> <span class="skolem">some_list</span> <span class="bound">cs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> set_empty sl_cs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> set<span class="main">:</span> <span class="quoted"><span class="quoted">"map set <span class="main">(</span>map <span class="skolem">some_list</span> <span class="free">css</span><span class="main">)</span> <span class="main">=</span> map set <span class="free">css</span>"</span></span> <span class="quoted"><span class="quoted">"map hd <span class="main">(</span>map <span class="skolem">some_list</span> <span class="free">css</span><span class="main">)</span> <span class="main">=</span> map hd <span class="free">css</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sl_cs<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_idI<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> distincts<span class="main">:</span> <span class="quoted"><span class="quoted">"distincts <span class="main">(</span>map <span class="skolem">some_list</span> <span class="free">css</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> c_dist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">xs</span><span class="main">∈</span>set <span class="free">css</span><span class="main">;</span> <span class="bound">ys</span><span class="main">∈</span>set <span class="free">css</span><span class="main">;</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="bound">ys</span><span class="main">⟧</span> <span class="main">⟹</span> set <span class="bound">xs</span> <span class="main">∩</span> set <span class="bound">ys</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dists <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distincts_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map <span class="skolem">some_list</span> <span class="free">css</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="skolem">some_list</span> <span class="main">(</span>set <span class="free">css</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sl_cs<span class="main">(</span>2<span class="main">)</span> c_dist <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> inj_onI<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> inf.idem set_empty<span class="main">)</span> 
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹distincts <span class="free">css</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distincts_distinct distinct_map<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span><span class="main">∈</span>set <span class="main">(</span>map <span class="skolem">some_list</span> <span class="free">css</span><span class="main">)</span><span class="main">.</span> distinct <span class="bound">xs</span> <span class="main">∧</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sl_cs<span class="main">(</span>3<span class="main">)</span> some_list_ne <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> c_dist <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">xs</span><span class="main">∈</span>set <span class="main">(</span>map <span class="skolem">some_list</span> <span class="free">css</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">ys</span><span class="main">∈</span>set <span class="main">(</span>map <span class="skolem">some_list</span> <span class="free">css</span><span class="main">)</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="bound">ys</span> <span class="main">⟶</span> set <span class="bound">xs</span> <span class="main">∩</span> set <span class="bound">ys</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sl_cs<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distincts_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> lists_succ <span class="main">(</span>map <span class="skolem">some_list</span> <span class="free">css</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> distincts
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> permutes_as_lists_succ<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="skolem">some_list</span> <span class="free">css</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_succ <span class="skolem">xs</span> <span class="main">=</span> perm_restrict <span class="free">f</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sl_cs<span class="main">(</span>1<span class="main">)</span> sl_cs<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span><span class="main">∈</span>set <span class="main">(</span>map <span class="skolem">some_list</span> <span class="free">css</span><span class="main">)</span><span class="main">.</span> set <span class="bound">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> S sl_cs<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> permutes <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">permutes</span> <span class="main">⋃</span><span class="main">(</span>sset <span class="main">(</span>map <span class="skolem">some_list</span> <span class="free">css</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> f distincts set  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Permutations of a List›</span></span>

<span class="keyword1" id="Executable_Permutations-length_remove1_less"><span class="command">lemma</span></span> length_remove1_less<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>remove1 <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_remove1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> length_remove1_less <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">permutations</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  permutations_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">permutations</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[</span><span class="main">[]</span><span class="main">]</span>"</span></span>
<span class="main">|</span> permutations_Cons<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">permutations</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">[</span><span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span><span class="main">.</span> y <span class="main">&lt;-</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> ys <span class="main">&lt;-</span> <span class="free">permutations</span> <span class="main">(</span>remove1 <span class="bound">y</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">]</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">declare</span></span> permutations_Cons<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The function above returns all permutations of a list. The function below computes
  only those which yield distinct cyclic permutation functions (cf. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">list_succ</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>).
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cyc_permutations</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cyc_permutations</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[</span><span class="main">[]</span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cyc_permutations</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span>Cons <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>permutations <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>



<span class="keyword1" id="Executable_Permutations-nil_in_permutations"><span class="command">lemma</span></span> nil_in_permutations<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> set <span class="main">(</span>permutations <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutations_Cons<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-permutations_not_nil"><span class="command">lemma</span></span> permutations_not_nil<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"permutations <span class="free">xs</span> <span class="main">=</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> map <span class="main">(</span><span class="main">(#)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>permutations <span class="main">(</span>remove1 <span class="bound">x</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutations_Cons<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-set_permutations_step"><span class="command">lemma</span></span> set_permutations_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>permutations <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> Cons <span class="bound">x</span> <span class="main">`</span> set <span class="main">(</span>permutations <span class="main">(</span>remove1 <span class="bound">x</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutations_Cons<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-in_set_permutations"><span class="command">lemma</span></span> in_set_permutations<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">∈</span> set <span class="main">(</span>permutations <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> distinct <span class="free">ys</span> <span class="main">∧</span> set <span class="free">xs</span> <span class="main">=</span> set <span class="free">ys</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟷</span> <span class="var">?R</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="skolem">xs</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">ys'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys'</span> <span class="main">∈</span> set <span class="main">(</span>permutations <span class="main">(</span>remove1 <span class="main">(</span>hd <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutations_not_nil<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">(</span>remove1 <span class="skolem">y</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">ys'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.prems Suc.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Suc.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_remove1<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="skolem">xs</span> <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="skolem">xs</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">ys'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys'</span> <span class="main">∈</span> set <span class="main">(</span>permutations <span class="main">(</span>remove1 <span class="skolem">y</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc <span class="quoted"><span class="quoted">‹<span class="var">?R</span> <span class="skolem">xs</span> <span class="skolem">ys</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Suc.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_remove1<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="skolem">xs</span> <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutations_not_nil<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Executable_Permutations-in_set_cyc_permutations"><span class="command">lemma</span></span> in_set_cyc_permutations<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">∈</span> set <span class="main">(</span>cyc_permutations <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> distinct <span class="free">ys</span> <span class="main">∧</span> set <span class="free">xs</span> <span class="main">=</span> set <span class="free">ys</span> <span class="main">∧</span> hd <span class="free">ys</span> <span class="main">=</span> hd <span class="free">xs</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟷</span> <span class="var">?R</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_permutations <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> imageI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Executable_Permutations-in_set_cyc_permutations_obtain"><span class="command">lemma</span></span> in_set_cyc_permutations_obtain<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">n</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"rotate <span class="free">n</span> <span class="free">ys</span> <span class="main">∈</span> set <span class="main">(</span>cyc_permutations <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rotate <span class="main">0</span> <span class="free">ys</span> <span class="main">∈</span> set <span class="main">(</span>cyc_permutations <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ys'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rotate <span class="main">(</span>index <span class="free">ys</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="var">?ys'</span> <span class="main">∧</span> set <span class="free">xs</span> <span class="main">=</span> set <span class="var">?ys'</span> <span class="main">∧</span> hd <span class="var">?ys'</span> <span class="main">=</span> hd <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_rotate_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="free">xs</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ys'</span> <span class="main">∈</span> set <span class="main">(</span>cyc_permutations <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> in_set_cyc_permutations<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Executable_Permutations-list_succ_set_cyc_permutations"><span class="command">lemma</span></span> list_succ_set_cyc_permutations<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_succ <span class="main">`</span> set <span class="main">(</span>cyc_permutations <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="keyword1">permutes</span> set <span class="free">xs</span> <span class="main">∧</span> cyclic_on <span class="bound">f</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> set_eqI iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ys</span><span class="main">.</span> set <span class="free">xs</span> <span class="main">=</span> set <span class="bound">ys</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="bound">ys</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_cyc_permutations list_succ_permutes cyclic_on_list_succ<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"list_succ <span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> cyclic_on_obtain_list_succ'<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> <span class="quoted"><span class="quoted">‹distinct <span class="free">xs</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"rotate <span class="skolem">n</span> <span class="skolem">ys</span> <span class="main">∈</span> set <span class="main">(</span>cyc_permutations <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> in_set_cyc_permutations_obtain<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_succ <span class="main">(</span>rotate <span class="skolem">n</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Enumerating Permutations from List Orbits›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cyc_permutationss</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list list <span class="main">⇒</span> <span class="tfree">'a</span> list list list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cyc_permutationss</span> <span class="main">=</span> product_lists <span class="keyword1">o</span> map cyc_permutations"</span></span>

<span class="keyword1" id="Executable_Permutations-cyc_permutationss_Nil"><span class="command">lemma</span></span> cyc_permutationss_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cyc_permutationss <span class="main">[]</span> <span class="main">=</span> <span class="main">[</span><span class="main">[]</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cyc_permutationss_def<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-in_set_cyc_permutationss"><span class="command">lemma</span></span> in_set_cyc_permutationss<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distincts <span class="free">xss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">yss</span> <span class="main">∈</span> set <span class="main">(</span>cyc_permutationss <span class="free">xss</span><span class="main">)</span> <span class="main">⟷</span> distincts <span class="free">yss</span> <span class="main">∧</span> map set <span class="free">xss</span> <span class="main">=</span> map set <span class="free">yss</span> <span class="main">∧</span> map hd <span class="free">xss</span> <span class="main">=</span> map hd <span class="free">yss</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="bound">ys</span><span class="main">)</span> <span class="free">yss</span> <span class="main">(</span>map cyc_permutations <span class="free">xss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">yss</span> <span class="main">=</span> length <span class="free">xss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_lengthD<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>sset <span class="free">xss</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>sset <span class="free">yss</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"distincts <span class="free">yss</span>"</span></span> <span class="quoted"><span class="quoted">"map set <span class="free">xss</span> <span class="main">=</span> map set <span class="free">yss</span>"</span></span> <span class="quoted"><span class="quoted">"map hd <span class="free">xss</span> <span class="main">=</span> map hd <span class="free">yss</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">yss</span></span> <span class="quoted"><span class="free">xss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distincts_Cons in_set_cyc_permutations<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> X <span class="main">=</span> this
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"distincts <span class="free">yss</span>"</span></span> <span class="quoted"><span class="quoted">"map set <span class="free">xss</span> <span class="main">=</span> map set <span class="free">yss</span>"</span></span> <span class="quoted"><span class="quoted">"map hd <span class="free">xss</span> <span class="main">=</span> map hd <span class="free">yss</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">yss</span> <span class="main">=</span> length <span class="free">xss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_eq_imp_length_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="bound">ys</span><span class="main">)</span> <span class="free">yss</span> <span class="main">(</span>map cyc_permutations <span class="free">xss</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">yss</span></span> <span class="quoted"><span class="free">xss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distincts_Cons in_set_cyc_permutations<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> Y <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cyc_permutationss_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> product_lists_set <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> X Y<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Executable_Permutations-lists_succ_set_cyc_permutationss"><span class="command">lemma</span></span> lists_succ_set_cyc_permutationss<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distincts <span class="free">xss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lists_succ <span class="main">`</span> set <span class="main">(</span>cyc_permutationss <span class="free">xss</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="keyword1">permutes</span> <span class="main">⋃</span><span class="main">(</span>sset <span class="free">xss</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">c</span> <span class="main">∈</span> sset <span class="free">xss</span><span class="main">.</span> cyclic_on <span class="bound">f</span> <span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> set_eqI iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yss</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yss</span> <span class="main">∈</span> set <span class="main">(</span>cyc_permutationss <span class="free">xss</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> lists_succ <span class="skolem">yss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> imageE<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">yss</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map set <span class="free">xss</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>map set <span class="skolem">yss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_cyc_permutationss<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sset <span class="free">xss</span> <span class="main">=</span> sset <span class="skolem">yss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_cyc_permutationss cyclic_on_lists_succ'<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> lists_succ_permutes<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1">permutes</span> <span class="main">⋃</span><span class="main">(</span>sset <span class="free">xss</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cs</span><span class="main">.</span> <span class="bound">cs</span> <span class="main">∈</span> set <span class="free">xss</span> <span class="main">⟹</span> cyclic_on <span class="skolem">f</span> <span class="main">(</span>set <span class="bound">cs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1<span class="main">)</span> refl assms this<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yss</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> lists_succ <span class="skolem">yss</span>"</span></span> <span class="quoted"><span class="quoted">"distincts <span class="skolem">yss</span>"</span></span> <span class="quoted"><span class="quoted">"map set <span class="skolem">yss</span> <span class="main">=</span> map set <span class="free">xss</span>"</span></span> <span class="quoted"><span class="quoted">"map hd <span class="skolem">yss</span> <span class="main">=</span> map hd <span class="free">xss</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cyclic_on_obtain_lists_succ<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> imageI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_cyc_permutationss<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lists of Permutations›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">permutationss</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list list <span class="main">⇒</span> <span class="tfree">'a</span> list list list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">permutationss</span> <span class="main">=</span> product_lists <span class="keyword1">o</span> map permutations"</span></span>

<span class="keyword1" id="Executable_Permutations-permutationss_Nil"><span class="command">lemma</span></span> permutationss_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"permutationss <span class="main">[]</span> <span class="main">=</span> <span class="main">[</span><span class="main">[]</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutationss_def<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-permutationss_Cons"><span class="command">lemma</span></span> permutationss_Cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"permutationss <span class="main">(</span><span class="free">xs</span> <span class="main">#</span> <span class="free">xss</span><span class="main">)</span> <span class="main">=</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> map <span class="main">(</span>Cons <span class="bound">ys</span><span class="main">)</span> <span class="main">(</span>permutationss <span class="free">xss</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>permutations <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutationss_def<span class="main">)</span>

<span class="keyword1" id="Executable_Permutations-in_set_permutationss"><span class="command">lemma</span></span> in_set_permutationss<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distincts <span class="free">xss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">yss</span> <span class="main">∈</span> set <span class="main">(</span>permutationss <span class="free">xss</span><span class="main">)</span> <span class="main">⟷</span> distincts <span class="free">yss</span> <span class="main">∧</span> map set <span class="free">xss</span> <span class="main">=</span> map set <span class="free">yss</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="bound">ys</span><span class="main">)</span> <span class="free">yss</span> <span class="main">(</span>map permutations <span class="free">xss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">yss</span> <span class="main">=</span> length <span class="free">xss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_lengthD<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>sset <span class="free">xss</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>sset <span class="free">yss</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"distincts <span class="free">yss</span>"</span></span> <span class="quoted"><span class="quoted">"map set <span class="free">xss</span> <span class="main">=</span> map set <span class="free">yss</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">yss</span></span> <span class="quoted"><span class="free">xss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distincts_Cons in_set_permutations<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> X <span class="main">=</span> this
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"distincts <span class="free">yss</span>"</span></span> <span class="quoted"><span class="quoted">"map set <span class="free">xss</span> <span class="main">=</span> map set <span class="free">yss</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">yss</span> <span class="main">=</span> length <span class="free">xss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_eq_imp_length_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="bound">ys</span><span class="main">)</span> <span class="free">yss</span> <span class="main">(</span>map permutations <span class="free">xss</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">yss</span></span> <span class="quoted"><span class="free">xss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_permutations distincts_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> Y <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> permutationss_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> product_lists_set <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> X Y<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Executable_Permutations-set_permutationss"><span class="command">lemma</span></span> set_permutationss<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distincts <span class="free">xss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>permutationss <span class="free">xss</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">yss</span><span class="main">.</span> distincts <span class="bound">yss</span> <span class="main">∧</span> map set <span class="free">xss</span> <span class="main">=</span> map set <span class="bound">yss</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> in_set_permutationss<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Executable_Permutations-permutationss_complete"><span class="command">lemma</span></span> permutationss_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distincts <span class="free">xss</span>"</span></span> <span class="quoted"><span class="quoted">"distincts <span class="free">yss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xss</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="main">`</span> set <span class="free">xss</span> <span class="main">=</span> set <span class="main">`</span> set <span class="free">yss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="free">yss</span> <span class="main">∈</span> set <span class="main">`</span> set <span class="main">(</span>permutationss <span class="free">xss</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xss</span> <span class="main">=</span> length <span class="free">yss</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_distincts<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹sset <span class="free">xss</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">yss'</span><span class="main">.</span> set <span class="bound">yss'</span> <span class="main">=</span> set <span class="free">yss</span> <span class="main">∧</span> map set <span class="bound">yss'</span> <span class="main">=</span> map set <span class="free">xss</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-2<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">yss</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">xs</span> <span class="skolem">xss</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹sset <span class="main">(</span><span class="skolem">xs</span> <span class="main">#</span> <span class="skolem">xss</span><span class="main">)</span> <span class="main">=</span> sset <span class="skolem">yss</span>›</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> set <span class="skolem">yss</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">=</span> set <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> imageE insertI1<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹distincts <span class="skolem">yss</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">∉</span> sset <span class="main">(</span>remove1 <span class="skolem">ys</span> <span class="skolem">yss</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distincts_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹distincts <span class="main">(</span><span class="skolem">xs</span> <span class="main">#</span> <span class="skolem">xss</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">∉</span> sset <span class="skolem">xss</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distincts_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sset <span class="skolem">xss</span> <span class="main">=</span> sset <span class="main">(</span>remove1 <span class="skolem">ys</span> <span class="skolem">yss</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹distincts <span class="skolem">yss</span>›</span></span> <span class="quoted"><span class="quoted">‹sset <span class="main">(</span><span class="skolem">xs</span> <span class="main">#</span> <span class="skolem">xss</span><span class="main">)</span> <span class="main">=</span> sset <span class="skolem">yss</span>›</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distincts_distinct <span class="quoted"><span class="quoted">‹set <span class="skolem">ys</span> <span class="main">=</span> set <span class="skolem">xs</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> Diff_insert_absorb <span class="quoted"><span class="quoted">‹<span class="skolem">ys</span> <span class="main">∈</span> set <span class="skolem">yss</span>›</span></span> image_insert insert_Diff rev_image_eqI<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ys</span> <span class="main">∈</span> set <span class="skolem">yss</span>›</span></span> image_eqI insert_Diff insert_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yss'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">yss'</span> <span class="main">=</span> set <span class="main">(</span>remove1 <span class="skolem">ys</span> <span class="skolem">yss</span><span class="main">)</span> <span class="main">∧</span> map set <span class="skolem">yss'</span> <span class="main">=</span> map set <span class="skolem">xss</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distincts_Cons distincts_remove1<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">ys</span> <span class="main">#</span> <span class="skolem">yss'</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">yss</span> <span class="main">∧</span> map set <span class="main">(</span><span class="skolem">ys</span> <span class="main">#</span> <span class="skolem">yss'</span><span class="main">)</span> <span class="main">=</span> map set <span class="main">(</span><span class="skolem">xs</span> <span class="main">#</span> <span class="skolem">xss</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ys set_remove1_eq <span class="quoted"><span class="quoted">‹distincts <span class="skolem">yss</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distincts_distinct<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yss'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">yss'</span> <span class="main">=</span> set <span class="free">yss</span>"</span></span> <span class="quoted"><span class="quoted">"map set <span class="skolem">yss'</span> <span class="main">=</span> map set <span class="free">xss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distincts <span class="skolem">yss'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹distincts <span class="free">xss</span>›</span></span> <span class="quoted"><span class="quoted">‹distincts <span class="free">yss</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> distincts_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹length <span class="free">xss</span> <span class="main">=</span> length <span class="free">yss</span>›</span></span> card_distinct distinct_card length_map<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">yss'</span> <span class="main">∈</span> set <span class="main">`</span> set <span class="main">(</span>permutationss <span class="free">xss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹distincts <span class="free">xss</span>›</span></span> <span class="quoted"><span class="quoted">‹map set <span class="skolem">yss'</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_permutationss<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">yss'</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Executable_Permutations-permutations_complete"><span class="command">lemma</span></span> permutations_complete<span class="main">:</span> <span class="comment1">(* could generalize with multi-sets *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">∈</span> set <span class="main">(</span>permutations <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc.hyps <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">ys'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys'</span> <span class="main">∈</span> set <span class="main">(</span>permutations <span class="main">(</span>remove1 <span class="skolem">y</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="quoted"><span class="quoted">‹Suc <span class="skolem">n</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Suc.hyps<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_remove1 <span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_permutations_step<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Digraph_Map_Impl">
<div class="head">
<h1>Theory Digraph_Map_Impl</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Digraph_Map_Impl
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Graph_Genus">Graph_Genus</a>
  <a href="#Executable_Permutations">Executable_Permutations</a>
  <span class="quoted">"<a href="../Transitive-Closure/Transitive_Closure_Impl.html">Transitive-Closure.Transitive_Closure_Impl</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Enumerating Maps›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">grouped_by_fst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">grouped_by_fst</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">=</span> <span class="bound">u</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span>remdups <span class="main">(</span>map fst <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">grouped_out_arcs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">grouped_out_arcs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">=</span> grouped_by_fst <span class="free"><span class="bound"><span class="entity">as</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">all_maps_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list list list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">all_maps_list</span> <span class="free"><span class="bound"><span class="entity">G_list</span></span></span> <span class="main">=</span> <span class="main">(</span>cyc_permutationss <span class="keyword1">o</span> grouped_out_arcs<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">G_list</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">list_digraph_ext</span> <span class="free"><span class="bound"><span class="entity">ext</span></span></span> <span class="free"><span class="bound"><span class="entity">G_list</span></span></span>  <span class="main">≡</span> <span class="main">⦇</span> pverts <span class="main">=</span> set <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">G_list</span></span></span><span class="main">)</span><span class="main">,</span> parcs <span class="main">=</span> set <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">G_list</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">…</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ext</span></span></span> <span class="main">⦈</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">list_digraph</span> <span class="main">≡</span> list_digraph_ext <span class="main">()</span>"</span></span>

<span class="keyword1"><span class="command">code_datatype</span></span> <span class="quoted">list_digraph_ext</span>


<span class="keyword1" id="Digraph_Map_Impl-list_digraph_simps"><span class="command">lemma</span></span> list_digraph_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pverts <span class="main">(</span>list_digraph <span class="free">G_list</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>fst <span class="free">G_list</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"parcs <span class="main">(</span>list_digraph <span class="free">G_list</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>snd <span class="free">G_list</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_digraph_ext_def<span class="main">)</span>



<span class="keyword1" id="Digraph_Map_Impl-union_grouped_by_fst"><span class="command">lemma</span></span> union_grouped_by_fst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span> <span class="main">∈</span> set <span class="main">(</span>grouped_by_fst <span class="free">ys</span><span class="main">)</span><span class="main">.</span> set <span class="bound">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> grouped_by_fst_def<span class="main">)</span>

<span class="keyword1" id="Digraph_Map_Impl-union_grouped_out_arcs"><span class="command">lemma</span></span> union_grouped_out_arcs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span> <span class="main">∈</span> set <span class="main">(</span>grouped_out_arcs <span class="free">G_list</span><span class="main">)</span><span class="main">.</span> set <span class="bound">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>snd <span class="free">G_list</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">G_list</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_grouped_by_fst<span class="main">)</span>

<span class="keyword1" id="Digraph_Map_Impl-nil_not_in_grouped_out_arcs"><span class="command">lemma</span></span> nil_not_in_grouped_out_arcs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∉</span> set <span class="main">(</span>grouped_out_arcs <span class="free">G_list</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">G_list</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> grouped_by_fst_def <span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> filter_empty_conv fst_conv<span class="main">)</span>

<span class="keyword1" id="Digraph_Map_Impl-set_grouped_out_arcs"><span class="command">lemma</span></span> set_grouped_out_arcs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pair_wf_digraph <span class="main">(</span>list_digraph <span class="free">G_list</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">`</span> set <span class="main">(</span>grouped_out_arcs <span class="free">G_list</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>out_arcs <span class="main">(</span>list_digraph <span class="free">G_list</span><span class="main">)</span> <span class="bound">v</span> <span class="main">|</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> pverts <span class="main">(</span>list_digraph <span class="free">G_list</span><span class="main">)</span> <span class="main">∧</span> out_arcs <span class="main">(</span>list_digraph <span class="free">G_list</span><span class="main">)</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> pair_wf_digraph <span class="quoted"><span class="quoted">"list_digraph <span class="free">G_list</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> remdups <span class="main">(</span>map fst <span class="main">(</span>snd <span class="free">G_list</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">vs</span> <span class="main">=</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> out_arcs <span class="main">(</span>list_digraph <span class="free">G_list</span><span class="main">)</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> out_arcs_def list_digraph_ext_def vs_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_image_eqI <span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> vs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">vs</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">v</span></span> <span class="main">∈</span> pverts <span class="main">(</span>list_digraph <span class="free">G_list</span><span class="main">)</span><span class="main">.</span> out_arcs <span class="main">(</span>list_digraph <span class="free">G_list</span><span class="main">)</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_arcsD1<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> goa<span class="main">:</span> <span class="quoted"><span class="quoted">"grouped_out_arcs <span class="free">G_list</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">=</span> <span class="bound">u</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">G_list</span><span class="main">)</span><span class="main">)</span> <span class="skolem">vs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">G_list</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> grouped_by_fst_def vs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> filter<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">=</span> <span class="bound">u</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">G_list</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> out_arcs <span class="main">(</span>list_digraph <span class="free">G_list</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_digraph_ext_def<span class="main">)</span>
    
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map set <span class="main">(</span>grouped_out_arcs <span class="free">G_list</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> goa filter vs<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Digraph_Map_Impl-distincts_grouped_by_fst"><span class="command">lemma</span></span> distincts_grouped_by_fst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distincts <span class="main">(</span>grouped_by_fst <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> list_eq_setD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">⟹</span> set <span class="bound">xs</span> <span class="main">=</span> set <span class="bound">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">=</span> <span class="bound">u</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">`</span> set <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span> <span class="main">(</span><span class="operator">drule</span> list_eq_setD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> grouped_by_fst_def distincts_def distinct_map filter_empty_conv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Digraph_Map_Impl-distincts_grouped_arcs"><span class="command">lemma</span></span> distincts_grouped_arcs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>snd <span class="free">G_list</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distincts <span class="main">(</span>grouped_out_arcs <span class="free">G_list</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">G_list</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distincts_grouped_by_fst<span class="main">)</span>

<span class="keyword1" id="Digraph_Map_Impl-distincts_in_all_maps_list"><span class="command">lemma</span></span> distincts_in_all_maps_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>snd <span class="free">X</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">xss</span> <span class="main">∈</span> set <span class="main">(</span>all_maps_list <span class="free">X</span><span class="main">)</span> <span class="main">⟹</span> distincts <span class="free">xss</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_maps_list_def distincts_grouped_arcs in_set_cyc_permutationss<span class="main">)</span>



<span class="keyword1"><span class="command">definition</span></span> <span class="entity">to_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> pre_map"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">to_map</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">⦇</span> edge_rev <span class="main">=</span> swap_in <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> edge_succ <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">to_map'</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">xss</span></span></span> <span class="main">≡</span> to_map <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span>lists_succ <span class="free"><span class="bound"><span class="entity">xss</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">all_maps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pair_pre_digraph <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> pre_map set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">all_maps</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> to_map <span class="main">(</span>arcs <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="keyword1">permutes</span> arcs <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> verts <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">.</span> out_arcs <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> cyclic_on <span class="bound">f</span> <span class="main">(</span>out_arcs <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">maps_all_maps_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> pre_map list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">maps_all_maps_list</span> <span class="free"><span class="bound"><span class="entity">G_list</span></span></span> <span class="main">=</span> map <span class="main">(</span>to_map <span class="main">(</span>set <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">G_list</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">o</span> lists_succ<span class="main">)</span> <span class="main">(</span>all_maps_list <span class="free"><span class="bound"><span class="entity">G_list</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pair_graph<span class="main">)</span> all_maps_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"all_maps <span class="free">G</span> <span class="main">=</span> <span class="main">{</span><span class="bound">M</span><span class="main">.</span> digraph_map <span class="free">G</span> <span class="bound">M</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> set_eqI iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">∈</span> all_maps <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"edge_rev <span class="skolem">M</span> <span class="main">=</span> swap_in <span class="main">(</span>arcs <span class="free">G</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"edge_succ <span class="skolem">M</span> <span class="keyword1">permutes</span> parcs <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_maps_def to_map_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"digraph_map <span class="free">G</span> <span class="skolem">M</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> digraph_mapI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> parcs <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"edge_rev <span class="skolem">M</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> swap_in_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> parcs <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"edge_rev <span class="skolem">M</span> <span class="main">(</span>edge_rev <span class="skolem">M</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>edge_rev <span class="skolem">M</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> snd <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"edge_rev <span class="skolem">M</span> <span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">a</span></span></span>"</span></span></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> arcs_symmetric <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> swap_in_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> no_loops<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"edge_succ <span class="skolem">M</span> <span class="keyword1">permutes</span> parcs <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> pverts <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"out_arcs <span class="main">(</span>with_proj <span class="free">G</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cyclic_on <span class="main">(</span>edge_succ <span class="skolem">M</span><span class="main">)</span> <span class="main">(</span>out_arcs <span class="main">(</span>with_proj <span class="free">G</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">unfolding</span></span> all_maps_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_map_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">M</span><span class="main">.</span> digraph_map <span class="free">G</span> <span class="bound">M</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">M</span><span class="main">.</span> digraph_map <span class="free">G</span> <span class="bound">M</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> M<span class="main">:</span> digraph_map <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="skolem">M</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> fst <span class="main">(</span>edge_rev <span class="skolem">M</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>swap_in <span class="main">(</span>arcs <span class="free">G</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> snd <span class="main">(</span>edge_rev <span class="skolem">M</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span>swap_in <span class="main">(</span>arcs <span class="free">G</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> M.tail_arev M.head_arev <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff swap_in_def M.arev_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"edge_rev <span class="skolem">M</span> <span class="main">=</span> swap_in <span class="main">(</span>arcs <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">∈</span> all_maps <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> M.edge_succ_permutes M.edge_succ_cyclic
    <span class="keyword1"><span class="command">unfolding</span></span> all_maps_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_map_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"edge_succ <span class="skolem">M</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Digraph_Map_Impl-set_maps_all_maps_list"><span class="command">lemma</span></span> set_maps_all_maps_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pair_wf_digraph <span class="main">(</span>list_digraph <span class="free">G_list</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>snd <span class="free">G_list</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"all_maps <span class="main">(</span>list_digraph <span class="free">G_list</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>maps_all_maps_list <span class="free">G_list</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"list_digraph <span class="free">G_list</span>"</span></span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>grouped_out_arcs <span class="free">G_list</span><span class="main">)</span><span class="main">.</span> cyclic_on <span class="skolem">f</span> <span class="main">(</span>set <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
        <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">`</span> set <span class="main">(</span>grouped_out_arcs <span class="free">G_list</span><span class="main">)</span><span class="main">.</span> cyclic_on <span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?all1</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">∈</span>pverts <span class="var">?G</span><span class="main">.</span> out_arcs <span class="var">?G</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> cyclic_on <span class="skolem">f</span> <span class="main">(</span>out_arcs <span class="var">?G</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?all2</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_grouped_out_arcs<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?all1</span> <span class="main">=</span> <span class="var">?all2</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> all_eq <span class="main">=</span> this

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lists_succ <span class="main">`</span> set <span class="main">(</span>all_maps_list <span class="free">G_list</span><span class="main">)</span>
      <span class="main">=</span> <span class="main">{</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="keyword1">permutes</span> arcs <span class="var">?G</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> pverts <span class="var">?G</span><span class="main">.</span> out_arcs <span class="var">?G</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> cyclic_on <span class="bound">f</span> <span class="main">(</span>out_arcs <span class="var">?G</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> all_maps_list_def <span class="keyword1"><span class="command">using</span></span> assms all_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lists_succ_set_cyc_permutationss distincts_grouped_arcs union_grouped_out_arcs list_digraph_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"lists_succ <span class="main">`</span> set <span class="main">(</span>all_maps_list <span class="free">G_list</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="keyword1">permutes</span> set <span class="main">(</span>snd <span class="free">G_list</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">∈</span>set <span class="main">(</span>fst <span class="free">G_list</span><span class="main">)</span><span class="main">.</span> out_arcs <span class="main">(</span>with_proj <span class="main">⦇</span>pverts <span class="main">=</span> set <span class="main">(</span>fst <span class="free">G_list</span><span class="main">)</span><span class="main">,</span> parcs <span class="main">=</span> set <span class="main">(</span>snd <span class="free">G_list</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> cyclic_on <span class="bound">f</span> <span class="main">(</span>out_arcs <span class="main">(</span>with_proj <span class="main">⦇</span>pverts <span class="main">=</span> set <span class="main">(</span>fst <span class="free">G_list</span><span class="main">)</span><span class="main">,</span> parcs <span class="main">=</span> set <span class="main">(</span>snd <span class="free">G_list</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maps_all_maps_list_def all_maps_def list_digraph_simps list_digraph_ext_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="bound">f</span> <span class="keyword1">permutes</span> set <span class="main">(</span>snd <span class="free">G_list</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="free">G_list</span><span class="main">)</span> <span class="main">⟶</span> out_arcs <span class="main">(</span>with_proj <span class="main">⦇</span>pverts <span class="main">=</span> set <span class="main">(</span>fst <span class="free">G_list</span><span class="main">)</span><span class="main">,</span> parcs <span class="main">=</span> set <span class="main">(</span>snd <span class="free">G_list</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span> <span class="bound">a</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> cyclic_on <span class="bound">f</span> <span class="main">(</span>out_arcs <span class="main">(</span>with_proj <span class="main">⦇</span>pverts <span class="main">=</span> set <span class="main">(</span>fst <span class="free">G_list</span><span class="main">)</span><span class="main">,</span> parcs <span class="main">=</span> set <span class="main">(</span>snd <span class="free">G_list</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="bound">f</span> <span class="main">∈</span> lists_succ <span class="main">`</span> set <span class="main">(</span>all_maps_list <span class="free">G_list</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maps_all_maps_list_def all_maps_def list_digraph_simps list_digraph_ext_def<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> ** <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Compute Face Cycles›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lists_fc_succ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lists_fc_succ</span> <span class="free"><span class="bound"><span class="entity">xss</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">sxss</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>sset <span class="free"><span class="bound"><span class="entity">xss</span></span></span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> lists_succ <span class="free"><span class="bound"><span class="entity">xss</span></span></span> <span class="main">(</span>swap_in <span class="bound">sxss</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> lists_digraph_map <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">G_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> list <span class="main">×</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">xss</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> digraph_map<span class="main">:</span> <span class="quoted"><span class="quoted">"digraph_map <span class="main">(</span>list_digraph <span class="free">G_list</span><span class="main">)</span> <span class="main">(</span>to_map' <span class="main">(</span>snd <span class="free">G_list</span><span class="main">)</span> <span class="free">xss</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> no_loops<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> parcs <span class="main">(</span>list_digraph <span class="free">G_list</span><span class="main">)</span> <span class="main">⟹</span> fst <span class="bound">a</span> <span class="main">≠</span> snd <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distincts_xss<span class="main">:</span> <span class="quoted"><span class="quoted">"distincts <span class="free">xss</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> parcs_xss<span class="main">:</span> <span class="quoted"><span class="quoted">"parcs <span class="main">(</span>list_digraph <span class="free">G_list</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>sset <span class="free">xss</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">≡</span> list_digraph <span class="free">G_list</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≡</span> to_map' <span class="main">(</span>snd <span class="free">G_list</span><span class="main">)</span> <span class="free">xss</span>"</span></span>

<span class="keyword1" id="Digraph_Map_Impl-edge_rev_simps"><span class="command">lemma</span></span> edge_rev_simps<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="main">∈</span> parcs G"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"edge_rev M <span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> to_map_def list_digraph_ext_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> swap_in_def to_map_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> lists_digraph_map <span class="main">⊆</span> digraph_map <span class="quoted">G</span> <span class="quoted">M</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> local.digraph_map<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> lists_digraph_map <span class="main">⊆</span> pair_graph <span class="quoted">G</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> parcs G"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> arcs G"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head G <span class="skolem">e</span> <span class="main">∈</span> verts G"</span></span> <span class="quoted"><span class="quoted">"tail G <span class="skolem">e</span> <span class="main">∈</span> verts G"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wellformed<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">e</span> <span class="main">∈</span> pverts G"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">e</span> <span class="main">∈</span> pverts G"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> parcs G"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">e</span> <span class="main">≠</span> snd <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> no_loops <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>pverts G<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>parcs G<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_digraph_ext_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> parcs G"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"edge_rev M <span class="main">(</span><span class="skolem">u</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> parcs G"</span></span>
      <span class="keyword1"><span class="command">using</span></span> edge_rev_in_arcs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> parcs G"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">u</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span> ›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edge_rev_simps<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"symmetric G"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> symmetric_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> symI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> lists_digraph_map <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lists_fcs</span> <span class="main">≡</span> orbits_list <span class="main">(</span>lists_fc_succ <span class="free">xss</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Digraph_Map_Impl-M_simps"><span class="command">lemma</span></span> M_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"edge_succ M <span class="main">=</span> lists_succ <span class="free">xss</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> to_map_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">G_list</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Digraph_Map_Impl-lists_fc_succ_permutes"><span class="command">lemma</span></span> lists_fc_succ_permutes<span class="main">:</span> <span class="quoted"><span class="quoted">"lists_fc_succ <span class="free">xss</span> <span class="keyword1">permutes</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>sset <span class="free">xss</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span>sset <span class="free">xss</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span>sset <span class="free">xss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sym_arcs <span class="keyword1"><span class="command">unfolding</span></span> parcs_xss<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> symmetric_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> symE<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"swap_in <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>sset <span class="free">xss</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">permutes</span> <span class="main">⋃</span><span class="main">(</span>sset <span class="free">xss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> distincts_xss
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutes_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> swap_in_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lists_succ <span class="free">xss</span> <span class="keyword1">permutes</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>sset <span class="free">xss</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lists_succ_permutes<span class="main">[</span><span class="operator">OF</span> distincts_xss<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lists_fc_succ <span class="free">xss</span> <span class="main">=</span> lists_succ <span class="free">xss</span> <span class="keyword1">o</span> swap_in <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>sset <span class="free">xss</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff lists_fc_succ_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permutes_compose<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Digraph_Map_Impl-permutation_lists_fc_succ"><span class="command">lemma</span></span> permutation_lists_fc_succ<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"permutation <span class="main">(</span>lists_fc_succ <span class="free">xss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lists_fc_succ_permutes <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutation_permutes<span class="main">)</span>

<span class="keyword1" id="Digraph_Map_Impl-face_cycle_succ_conv"><span class="command">lemma</span></span> face_cycle_succ_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"face_cycle_succ <span class="main">=</span> lists_fc_succ <span class="free">xss</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> parcs_xss <span class="keyword1"><span class="command">unfolding</span></span> face_cycle_succ_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff to_map_def lists_fc_succ_def swap_in_def list_digraph_ext_def<span class="main">)</span>

<span class="keyword1" id="Digraph_Map_Impl-sset_lists_fcs"><span class="command">lemma</span></span> sset_lists_fcs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sset <span class="main">(</span>lists_fcs <span class="free">as</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>face_cycle_set <span class="bound">a</span> <span class="main">|</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">as</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lists_fcs_def sset_orbits_list face_cycle_set_def face_cycle_succ_conv<span class="main">)</span>

<span class="keyword1" id="Digraph_Map_Impl-distincts_lists_fcs"><span class="command">lemma</span></span> distincts_lists_fcs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">as</span> <span class="main">⟹</span>distincts <span class="main">(</span>lists_fcs <span class="free">as</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lists_fcs_def distincts_orbits_list<span class="main">)</span>

<span class="keyword1" id="Digraph_Map_Impl-face_cycle_set_ss"><span class="command">lemma</span></span> face_cycle_set_ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> parcs G <span class="main">⟹</span> face_cycle_set <span class="free">a</span> <span class="main">⊆</span> parcs G"</span></span>
  <span class="keyword1"><span class="command">using</span></span> in_face_cycle_setD with_proj_simps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Digraph_Map_Impl-face_cycle_succ_neq"><span class="command">lemma</span></span> face_cycle_succ_neq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> parcs G"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"face_cycle_succ <span class="free">a</span> <span class="main">≠</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms no_loops <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> face_cycle_succ_neq<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Digraph_Map_Impl-card_face_cycle_sets_conv"><span class="command">lemma</span></span> card_face_cycle_sets_conv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>pre_digraph_map.face_cycle_sets G M<span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>lists_fcs <span class="main">(</span>remdups <span class="main">(</span>snd <span class="free">G_list</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> digraph_map <span class="quoted">G</span> <span class="quoted">M</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> digraph_map<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"face_cycle_sets <span class="main">=</span> <span class="main">{</span>face_cycle_set <span class="bound">a</span> <span class="main">|</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> parcs G<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> face_cycle_sets_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sset <span class="main">(</span>lists_fcs <span class="main">(</span>remdups <span class="main">(</span>snd <span class="free">G_list</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sset_lists_fcs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_digraph_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">…</span> <span class="main">=</span> length <span class="main">(</span>lists_fcs <span class="main">(</span>remdups <span class="main">(</span>snd <span class="free">G_list</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_image distincts_inj_on_set distinct_card distincts_distinct distincts_lists_fcs<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">gen_succ</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">as</span> <span class="bound">xs</span><span class="main">.</span> <span class="main">[</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span>a<span class="main">,</span>b<span class="main">)</span> <span class="main">&lt;-</span> <span class="bound">as</span><span class="main">,</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="bound">xs</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> RTLI<span class="main">:</span> set_access_gen <span class="quoted">set</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="bound">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> remdups <span class="main">(</span><span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"gen_succ"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gen_succ_def<span class="main">)</span>
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> gen_succ

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  It would suffice to check that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"set <span class="main"><span class="main">(</span></span>RTLI.rtrancl_i <span class="free"><span class="free">A</span></span> <span class="main"><span class="main">[</span></span><span class="free"><span class="free">u</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> set <span class="free"><span class="free">V</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. We don't do
  this here, since it makes the proof more complicated (and is not necessary for the graphs
  we care about
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sccs_verts_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span> set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sccs_verts_impl</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> set <span class="main">`</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> RTLI.rtrancl_i <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">`</span> set <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isolated_verts_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">isolated_verts_impl</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">=</span> <span class="main">[</span><span class="bound">v</span> <span class="main">←</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">e</span> <span class="main">∈</span> set <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">.</span> fst <span class="bound">e</span> <span class="main">=</span> <span class="bound">v</span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pair_graph_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pair_graph_impl</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">V</span><span class="main">,</span><span class="bound">A</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">A</span><span class="main">.</span> <span class="bound">u</span> <span class="main">≠</span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">∈</span> set <span class="bound">V</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> set <span class="bound">V</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">A</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">genus_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list list <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">genus_impl</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">V</span><span class="main">,</span><span class="bound">A</span><span class="main">)</span> <span class="main">⇒</span>
    <span class="main">(</span>int <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>card <span class="main">(</span>sccs_verts_impl <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> int <span class="main">(</span>length <span class="main">(</span>isolated_verts_impl <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">-</span> <span class="main">(</span>int <span class="main">(</span>length <span class="bound">V</span><span class="main">)</span> <span class="main">-</span> int <span class="main">(</span>length <span class="bound">A</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>
      <span class="main">+</span> int <span class="main">(</span>length <span class="main">(</span>orbits_list_impl <span class="main">(</span>lists_fc_succ <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">comb_planar_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">comb_planar_impl</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">V</span><span class="main">,</span><span class="bound">A</span><span class="main">)</span> <span class="main">⇒</span>
    <span class="keyword1">let</span> <span class="bound">i</span> <span class="main">=</span> int <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>card <span class="main">(</span>sccs_verts_impl <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> int <span class="main">(</span>length <span class="main">(</span>isolated_verts_impl <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">-</span> int <span class="main">(</span>length <span class="bound">V</span><span class="main">)</span> <span class="main">+</span> int <span class="main">(</span>length <span class="bound">A</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="main">∃</span><span class="bound">M</span><span class="main">∈</span>set <span class="main">(</span>all_maps_list <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> int <span class="main">(</span>length <span class="main">(</span>orbits_list_impl <span class="main">(</span>lists_fc_succ <span class="bound">M</span><span class="main">)</span> <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="comment1">(*
definition comb_planar_impl :: "'a list × ('a × 'a) list ⇒ bool" where
  "comb_planar_impl G ≡ ∃M∈set (all_maps_list G). genus_impl G M = 0"
*)</span>

<span class="keyword1" id="Digraph_Map_Impl-sccs_verts_impl_correct"><span class="command">lemma</span></span> sccs_verts_impl_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pair_pseudo_graph <span class="main">(</span>list_digraph <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pre_digraph.sccs_verts <span class="main">(</span>list_digraph <span class="free">G</span><span class="main">)</span> <span class="main">=</span> sccs_verts_impl <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> pair_pseudo_graph <span class="quoted"><span class="quoted">"list_digraph <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>set <span class="main">(</span>snd <span class="free">G</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="free">G</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_arcsD2 list_digraph_simps rtrancl.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RTLI.rtrancl_i <span class="main">(</span>snd <span class="free">G</span><span class="main">)</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">u</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub>list_digraph <span class="free">G</span></sub><span class="hidden">⇙</span> <span class="bound">v</span> <span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> RTLI.rtrancl_impl reachable_conv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_digraph_simps <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">∈</span> <span class="main">_</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> scc_of <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> scc_of_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> symmetric_reachable'<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"scc_of <span class="skolem">u</span> <span class="main">=</span> set <span class="main">(</span>RTLI.rtrancl_i <span class="main">(</span>snd <span class="free">G</span><span class="main">)</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pre_digraph.sccs_verts <span class="main">(</span>list_digraph <span class="free">G</span><span class="main">)</span> <span class="main">=</span> set <span class="main">`</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> RTLI.rtrancl_i <span class="main">(</span>snd <span class="free">G</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">`</span> set <span class="main">(</span>fst <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sccs_verts_conv_scc_of list_digraph_simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_image_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sccs_verts_impl_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Digraph_Map_Impl-isolated_verts_impl_correct"><span class="command">lemma</span></span> isolated_verts_impl_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pre_digraph.isolated_verts <span class="main">(</span>list_digraph <span class="free">G</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>isolated_verts_impl <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_digraph.isolated_verts_def isolated_verts_impl_def list_digraph_simps out_arcs_def<span class="main">)</span>

<span class="keyword1" id="Digraph_Map_Impl-pair_graph_impl_correct"><span class="command">lemma</span></span> pair_graph_impl_correct<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pair_graph <span class="main">(</span>list_digraph <span class="free">G</span><span class="main">)</span> <span class="main">=</span> pair_graph_impl <span class="free">G</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> pair_graph_def pair_digraph_def pair_fin_digraph_def pair_wf_digraph_def
    pair_fin_digraph_axioms_def pair_loopfree_digraph_def pair_loopfree_digraph_axioms_def
    pair_sym_digraph_def pair_sym_digraph_axioms_def pair_pseudo_graph_def
    pair_graph_impl_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pair_graph_impl_def list_digraph_simps symmetric_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> symI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> symD <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1" id="Digraph_Map_Impl-genus_impl_correct"><span class="command">lemma</span></span> genus_impl_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dist_V<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>fst <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dist_A<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>snd <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lists_digraph_map <span class="free">G</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pre_digraph_map.euler_genus <span class="main">(</span>list_digraph <span class="free">G</span><span class="main">)</span> <span class="main">(</span>to_map' <span class="main">(</span>snd <span class="free">G</span><span class="main">)</span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> genus_impl <span class="free">G</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> lists_digraph_map <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="free">M</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">V</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> G_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">V</span><span class="main">,</span><span class="skolem">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">G</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>isolated_verts_impl <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dist_V <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> isolated_verts_impl_def <span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> faces<span class="main">:</span> <span class="quoted"><span class="quoted">"card face_cycle_sets <span class="main">=</span> length <span class="main">(</span>orbits_list_impl <span class="main">(</span>lists_fc_succ <span class="free">M</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dist_A
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_face_cycle_sets_conv lists_fcs_def orbits_list_conv_impl distinct_remdups_id<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> pair_pseudo_graph dist_V dist_A
    <span class="keyword1"><span class="command">unfolding</span></span> euler_genus_def euler_char_def genus_impl_def card_sccs_verts<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sccs_verts_impl_correct isolated_verts_impl_correct
      distinct_card list_digraph_simps zdiv_int<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Digraph_Map_Impl-elems_all_maps_list"><span class="command">lemma</span></span> elems_all_maps_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> set <span class="main">(</span>all_maps_list <span class="free">G</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>snd <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>sset <span class="free">M</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>snd <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_maps_list_def in_set_cyc_permutationss distincts_grouped_arcs union_grouped_out_arcs<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">metis</span> set_map<span class="main">)</span>

<span class="keyword1" id="Digraph_Map_Impl-comb_planar_impl_altdef"><span class="command">lemma</span></span> comb_planar_impl_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"comb_planar_impl <span class="free">G</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">M</span><span class="main">∈</span>set <span class="main">(</span>all_maps_list <span class="free">G</span><span class="main">)</span><span class="main">.</span> genus_impl <span class="free">G</span> <span class="bound">M</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> comb_planar_impl_def Let_def genus_impl_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">G</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Digraph_Map_Impl-comb_planar_impl_correct"><span class="command">lemma</span></span> comb_planar_impl_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pair_graph <span class="main">(</span>list_digraph <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dist_V<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>fst <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dist_A<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>snd <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"comb_planar <span class="main">(</span>list_digraph <span class="free">G</span><span class="main">)</span> <span class="main">=</span> comb_planar_impl <span class="free">G</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> G<span class="main">:</span> pair_graph <span class="quoted"><span class="quoted">"list_digraph <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"list_digraph <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"all_maps <span class="main">(</span>list_digraph <span class="free">G</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>maps_all_maps_list <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> set_maps_all_maps_list<span class="main">)</span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_A<span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">V</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">V</span><span class="main">,</span><span class="skolem">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">G</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">∈</span> set <span class="main">(</span>all_maps_list <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"digraph_map <span class="main">(</span>list_digraph <span class="free">G</span><span class="main">)</span> <span class="main">(</span>to_map' <span class="main">(</span>snd <span class="free">G</span><span class="main">)</span> <span class="skolem">M</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">M</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> G.all_maps_correct <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> * maps_all_maps_list_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> G<span class="main">:</span> digraph_map <span class="quoted"><span class="quoted">"list_digraph <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"to_map' <span class="main">(</span>snd <span class="free">G</span><span class="main">)</span> <span class="skolem">M</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distincts <span class="skolem">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">M</span> <span class="main">∈</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> dist_A distincts_in_all_maps_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lists_digraph_map <span class="free">G</span> <span class="skolem">M</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> elems_all_maps_list<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">M</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="main">(</span>snd <span class="free">G</span><span class="main">)</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹distincts <span class="skolem">M</span>›</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> G.adj_not_same<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_digraph_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> ldm <span class="main">=</span> this

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"comb_planar <span class="var">?G</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">M</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">M</span><span class="main">.</span> digraph_map <span class="var">?G</span> <span class="bound">M</span><span class="main">}</span><span class="main">.</span> pre_digraph_map.euler_genus <span class="var">?G</span> <span class="bound">M</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> comb_planar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">M</span><span class="main">∈</span>set <span class="main">(</span>all_maps_list <span class="free">G</span><span class="main">)</span><span class="main">.</span> pre_digraph_map.euler_genus <span class="main">(</span>list_digraph <span class="free">G</span><span class="main">)</span>
      <span class="main">(</span>to_map <span class="main">(</span>set <span class="main">(</span>snd <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>lists_succ <span class="bound">M</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> comb_planar_def comb_planar_impl_def Let_def G.all_maps_correct<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      set_maps_all_maps_list<span class="main">[</span><span class="operator">OF</span> G.pair_wf_digraph dist_A<span class="main">]</span> maps_all_maps_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">M</span><span class="main">∈</span>set <span class="main">(</span>all_maps_list <span class="free">G</span><span class="main">)</span><span class="main">.</span> genus_impl <span class="free">G</span> <span class="bound">M</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ldm assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> genus_impl_correct<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> comb_planar_impl <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> comb_planar_impl_def genus_impl_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">G</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">V</span><span class="main">,</span><span class="skolem">A</span><span class="main">)</span>›</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Planar_Complete">
<div class="head">
<h1>Theory Planar_Complete</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Planar_Complete
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Digraph_Map_Impl">Digraph_Map_Impl</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Kuratowski Graphs are not Combinatorially Planar›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹A concrete K5 graph›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">c_K5_list</span> <span class="main">≡</span> <span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">..</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> x <span class="main">&lt;-</span> <span class="main">[</span><span class="main">0</span><span class="main">..</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span> y <span class="main">&lt;-</span> <span class="main">[</span><span class="main">0</span><span class="main">..</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">c_K5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int pair_pre_digraph"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">c_K5</span> <span class="main">≡</span> list_digraph c_K5_list"</span></span>

<span class="keyword1" id="Planar_Complete-c_K5_not_comb_planar"><span class="command">lemma</span></span> c_K5_not_comb_planar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>comb_planar c_K5"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> comb_planar_impl_correct<span class="main">)</span> <span class="operator">eval</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Planar_Complete-pverts_c_K5"><span class="command">lemma</span></span> pverts_c_K5<span class="main">:</span> <span class="quoted"><span class="quoted">"pverts c_K5 <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="numeral">4</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_K5_list_def list_digraph_ext_def<span class="main">)</span>

<span class="keyword1" id="Planar_Complete-parcs_c_K5"><span class="command">lemma</span></span> parcs_c_K5<span class="main">:</span> <span class="quoted"><span class="quoted">"parcs c_K5 <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="numeral">4</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="numeral">4</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">≠</span> <span class="bound">v</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> c_K5_list_def list_digraph_ext_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> c_K5_simps <span class="main">=</span> pverts_c_K5 parcs_c_K5

<span class="keyword1" id="Planar_Complete-complete_c_K5"><span class="command">lemma</span></span> complete_c_K5<span class="main">:</span> <span class="quoted"><span class="quoted">"K<span class="hidden">⇘</span><sub><span class="numeral">5</span></sub><span class="hidden">⇙</span> c_K5"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> K5<span class="main">:</span> pair_graph <span class="quoted">c_K5</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> complete_digraph_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> c_K5_simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹A concrete K33 graph›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">c_K33_list</span> <span class="main">≡</span> <span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">..</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> x <span class="main">&lt;-</span> <span class="main">[</span><span class="main">0</span><span class="main">..</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span> y <span class="main">&lt;-</span> <span class="main">[</span><span class="main">0</span><span class="main">..</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span> even <span class="bound">x</span> <span class="main">⟷</span> odd <span class="bound">y</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">c_K33</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int pair_pre_digraph"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">c_K33</span> <span class="main">≡</span> list_digraph c_K33_list"</span></span>

<span class="keyword1" id="Planar_Complete-c_K33_not_comb_planar"><span class="command">lemma</span></span> c_K33_not_comb_planar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>comb_planar c_K33"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> comb_planar_impl_correct<span class="main">)</span> <span class="operator">eval</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Planar_Complete-complete_c_K33"><span class="command">lemma</span></span> complete_c_K33<span class="main">:</span> <span class="quoted"><span class="quoted">"K<span class="hidden">⇘</span><sub><span class="numeral">3</span><span class="main">,</span><span class="numeral">3</span></sub><span class="hidden">⇙</span> c_K33"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> K33<span class="main">:</span> pair_graph <span class="quoted">c_K33</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> complete_bipartite_digraph_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="main"><span class="main">0</span></span><span class="main"><span class="main">,</span></span><span class="numeral"><span class="numeral">2</span></span><span class="main"><span class="main">,</span></span><span class="numeral"><span class="numeral">4</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="main"><span class="main">1</span></span><span class="main"><span class="main">,</span></span><span class="numeral"><span class="numeral">3</span></span><span class="main"><span class="main">,</span></span><span class="numeral"><span class="numeral">5</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> c_K33_list_def list_digraph_simps with_proj_simps
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">eval</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Generalization to arbitrary Kuratowski Graphs›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Number of Face Cycles is a Graph Invariant›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> digraph_map<span class="main">)</span> wrap_wrap_iso<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hom<span class="main">:</span> <span class="quoted"><span class="quoted">"digraph_isomorphism <span class="free">hom</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> arcs <span class="free">G</span> <span class="main">→</span> arcs <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> arcs <span class="free">G</span> <span class="main">→</span> arcs <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wrap_iso_arcs <span class="free">hom</span> <span class="free">f</span> <span class="main">(</span>wrap_iso_arcs <span class="free">hom</span> <span class="free">g</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> wrap_iso_arcs <span class="free">hom</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">g</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> arcs <span class="free">G</span> <span class="main">⟹</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> g <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> hom f <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> iso_arcs <span class="free">hom</span> <span class="main">`</span> arcs <span class="free">G</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wrap_iso_arcs_def perm_restrict_simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> digraph_map<span class="main">)</span> face_cycle_succ_iso<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hom<span class="main">:</span> <span class="quoted"><span class="quoted">"digraph_isomorphism <span class="free">hom</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> iso_arcs <span class="free">hom</span> <span class="main">`</span> arcs <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pre_digraph_map.face_cycle_succ <span class="main">(</span>map_iso <span class="free">hom</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> wrap_iso_arcs <span class="free">hom</span> face_cycle_succ <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pre_digraph_map.face_cycle_succ_def map_iso_def wrap_wrap_iso<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> digraph_map<span class="main">)</span> face_cycle_set_iso<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hom<span class="main">:</span> <span class="quoted"><span class="quoted">"digraph_isomorphism <span class="free">hom</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> iso_arcs <span class="free">hom</span> <span class="main">`</span> arcs <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pre_digraph_map.face_cycle_set <span class="main">(</span>map_iso <span class="free">hom</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> iso_arcs <span class="free">hom</span> <span class="main">`</span> face_cycle_set <span class="main">(</span>iso_arcs <span class="main">(</span>inv_iso <span class="free">hom</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> orbit face_cycle_succ <span class="bound">y</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> arcs <span class="free">G</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> arcs <span class="free">G</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> orbit face_cycle_succ <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> face_cycle_set_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_face_cycle_setD<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> pre_digraph_map.face_cycle_set_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> orbit_inverse <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"pre_digraph_map.face_cycle_succ <span class="main"><span class="main"><span class="main">(</span></span></span>map_iso <span class="free"><span class="free"><span class="free">hom</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> * face_cycle_succ_iso<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> digraph_map<span class="main">)</span> face_cycle_sets_iso<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hom<span class="main">:</span> <span class="quoted"><span class="quoted">"digraph_isomorphism <span class="free">hom</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pre_digraph_map.face_cycle_sets <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span> <span class="main">(</span>map_iso <span class="free">hom</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> iso_arcs <span class="free">hom</span> <span class="main">`</span> <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> face_cycle_sets"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_digraph_map.face_cycle_sets_def face_cycle_set_iso<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> face_cycle_set_iso <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_image_eqI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> digraph_map<span class="main">)</span> card_face_cycle_sets_iso<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hom<span class="main">:</span> <span class="quoted"><span class="quoted">"digraph_isomorphism <span class="free">hom</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>pre_digraph_map.face_cycle_sets <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span> <span class="main">(</span>map_iso <span class="free">hom</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> card face_cycle_sets"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">(`)</span> <span class="main">(</span>iso_arcs <span class="free">hom</span><span class="main">)</span><span class="main">)</span> face_cycle_sets"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inj_on_f_imageI digraph_isomorphism_inj_on_arcs hom in_face_cycle_setsD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> hom <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> face_cycle_sets_iso card_image<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Combinatorial planarity is a Graph Invariant›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> digraph_map<span class="main">)</span> euler_char_iso<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"digraph_isomorphism <span class="free">hom</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pre_digraph_map.euler_char <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span> <span class="main">(</span>map_iso <span class="free">hom</span><span class="main">)</span> <span class="main">=</span> euler_char"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_digraph_map.euler_char_def card_face_cycle_sets_iso<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> digraph_map<span class="main">)</span> euler_genus_iso<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"digraph_isomorphism <span class="free">hom</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pre_digraph_map.euler_genus <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span> <span class="main">(</span>map_iso <span class="free">hom</span><span class="main">)</span> <span class="main">=</span> euler_genus"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_digraph_map.euler_genus_def euler_char_iso<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> wf_digraph<span class="main">)</span> comb_planar_iso<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"digraph_isomorphism <span class="free">hom</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"comb_planar <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span> <span class="main">⟷</span> comb_planar <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"comb_planar <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"digraph_map <span class="free">G</span> <span class="skolem">M</span>"</span></span> <span class="quoted"><span class="quoted">"pre_digraph_map.euler_genus <span class="free">G</span> <span class="skolem">M</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comb_planar_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"digraph_map <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span> <span class="main">(</span>pre_digraph_map.map_iso <span class="free">G</span> <span class="skolem">M</span> <span class="free">hom</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"pre_digraph_map.euler_genus <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span> <span class="main">(</span>pre_digraph_map.map_iso <span class="free">G</span> <span class="skolem">M</span> <span class="free">hom</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> digraph_map.digraph_map_isoI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> digraph_map.euler_genus_iso<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"comb_planar <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comb_planar_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"app_iso <span class="free">hom</span> <span class="free">G</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"comb_planar <span class="var">?G</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"digraph_map <span class="var">?G</span> <span class="skolem">M</span>"</span></span>
      <span class="quoted"><span class="quoted">"pre_digraph_map.euler_genus <span class="var">?G</span> <span class="skolem">M</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comb_planar_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pre_digraph.digraph_isomorphism <span class="var">?G</span> <span class="main">(</span>inv_iso <span class="free">hom</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> digraph_isomorphism_invI<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"digraph_map <span class="main">(</span>app_iso <span class="main">(</span>inv_iso <span class="free">hom</span><span class="main">)</span> <span class="var">?G</span><span class="main">)</span> <span class="main">(</span>pre_digraph_map.map_iso <span class="var">?G</span> <span class="skolem">M</span> <span class="main">(</span>inv_iso <span class="free">hom</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"pre_digraph_map.euler_genus <span class="main">(</span>app_iso <span class="main">(</span>inv_iso <span class="free">hom</span><span class="main">)</span> <span class="var">?G</span><span class="main">)</span> <span class="main">(</span>pre_digraph_map.map_iso <span class="var">?G</span> <span class="skolem">M</span> <span class="main">(</span>inv_iso <span class="free">hom</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> digraph_map.digraph_map_isoI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> digraph_map.euler_genus_iso<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"comb_planar <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comb_planar_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Completeness is a Graph Invariant›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> loopfree_digraph<span class="main">)</span> loopfree_digraphI_app_iso<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"digraph_isomorphism <span class="free">hom</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"loopfree_digraph <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> iG<span class="main">:</span> wf_digraph <span class="quoted"><span class="quoted">"app_iso <span class="free">hom</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_digraphI_app_iso<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms digraph_isomorphism_inj_on_verts<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> iso_verts_tail iso_verts_head <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> inj_onD no_loops<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> nomulti_digraph<span class="main">)</span> nomulti_digraphI_app_iso<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"digraph_isomorphism <span class="free">hom</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nomulti_digraph <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> iG<span class="main">:</span> wf_digraph <span class="quoted"><span class="quoted">"app_iso <span class="free">hom</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_digraphI_app_iso<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> iso_verts_tail iso_verts_head arc_to_ends_def no_multi_arcs <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> inj_onD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pre_digraph<span class="main">)</span> symmetricI_app_iso<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"digraph_isomorphism <span class="free">hom</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"symmetric <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"symmetric <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"app_iso <span class="free">hom</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span>arcs_ends <span class="var">?G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> symI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">→</span><span class="hidden">⇘</span><sub><span class="var">?G</span></sub><span class="hidden">⇙</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> arcs <span class="var">?G</span>"</span></span> <span class="quoted"><span class="quoted">"tail <span class="var">?G</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"head <span class="var">?G</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a0</span></span> <span class="keyword2"><span class="keyword">where</span></span> a0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a0</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> iso_arcs <span class="free">hom</span> <span class="skolem">a0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹symmetric <span class="free">G</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b0</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="skolem">b0</span> <span class="main">=</span> head <span class="free">G</span> <span class="skolem">a0</span>"</span></span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="skolem">b0</span> <span class="main">=</span> tail <span class="free">G</span> <span class="skolem">a0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> symmetric_def arcs_ends_conv <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> symE<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> iso_arcs <span class="free">hom</span> <span class="skolem">b0</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> iso_arcs <span class="free">hom</span> <span class="main">`</span> arcs <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"tail <span class="var">?G</span> <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"head <span class="var">?G</span> <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a a0 assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> iso_verts_tail iso_verts_head<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">→</span><span class="hidden">⇘</span><sub><span class="var">?G</span></sub><span class="hidden">⇙</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_ends_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> symmetric_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> sym_digraph<span class="main">)</span> sym_digraphI_app_iso<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"digraph_isomorphism <span class="free">hom</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sym_digraph <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> iG<span class="main">:</span> wf_digraph <span class="quoted"><span class="quoted">"app_iso <span class="free">hom</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_digraphI_app_iso<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">intro</span> symmetricI_app_iso sym_arcs<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> graphI_app_iso<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"digraph_isomorphism <span class="free">hom</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"graph <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> iG<span class="main">:</span> fin_digraph <span class="quoted"><span class="quoted">"app_iso <span class="free">hom</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fin_digraphI_app_iso<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> iG<span class="main">:</span> loopfree_digraph <span class="quoted"><span class="quoted">"app_iso <span class="free">hom</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> loopfree_digraphI_app_iso<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> iG<span class="main">:</span> nomulti_digraph <span class="quoted"><span class="quoted">"app_iso <span class="free">hom</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nomulti_digraphI_app_iso<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> iG<span class="main">:</span> sym_digraph <span class="quoted"><span class="quoted">"app_iso <span class="free">hom</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym_digraphI_app_iso<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_locales</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> wf_digraph<span class="main">)</span> graph_app_iso_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"digraph_isomorphism <span class="free">hom</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"graph <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span> <span class="main">⟷</span> graph <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> app_iso_inv digraph_isomorphism_invI graph.graphI_app_iso<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pre_digraph<span class="main">)</span> arcs_ends_iso<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"digraph_isomorphism <span class="free">hom</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"arcs_ends <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>iso_verts <span class="free">hom</span> <span class="bound">u</span><span class="main">,</span> iso_verts <span class="free">hom</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> arcs_ends <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_ends_conv image_image iso_verts_tail iso_verts_head <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> image_cong<span class="main">)</span>

<span class="keyword1" id="Planar_Complete-inj_onI_pair"><span class="command">lemma</span></span> inj_onI_pair<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">×</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">u</span><span class="main">,</span> <span class="free">f</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> inj_onI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> inj_onD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> wf_digraph<span class="main">)</span> complete_digraph_iso<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"digraph_isomorphism <span class="free">hom</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"K<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> <span class="main">(</span>app_iso <span class="free">hom</span> <span class="free">G</span><span class="main">)</span> <span class="main">⟷</span> K<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> <span class="free">G</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> iG<span class="main">:</span> graph <span class="quoted"><span class="quoted">"app_iso <span class="free">hom</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> complete_digraph_def<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> iso_verts <span class="free">hom</span> <span class="main">`</span> verts <span class="free">G</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> iso_verts <span class="free">hom</span> <span class="main">`</span> verts <span class="free">G</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">≠</span> <span class="bound">v</span><span class="main">}</span>
        <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>iso_verts <span class="free">hom</span> <span class="bound">u</span><span class="main">,</span> iso_verts <span class="free">hom</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> verts <span class="free">G</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> verts <span class="free">G</span> <span class="main">∧</span> iso_verts <span class="free">hom</span> <span class="bound">u</span> <span class="main">≠</span> iso_verts <span class="free">hom</span> <span class="bound">v</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>iso_verts <span class="free">hom</span> <span class="bound">u</span><span class="main">,</span> iso_verts <span class="free">hom</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> verts <span class="free">G</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> verts <span class="free">G</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">≠</span> <span class="bound">v</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> digraph_isomorphism_inj_on_verts<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> inj_onD<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> X <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> verts <span class="free">G</span> <span class="main">×</span> verts <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>iso_verts <span class="free">hom</span> <span class="bound">u</span><span class="main">,</span> iso_verts <span class="free">hom</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A digraph_isomorphism_inj_on_verts<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> inj_onI_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> Y <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>arcs_ends <span class="free">G</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> verts <span class="free">G</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> verts <span class="free">G</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">≠</span> <span class="bound">v</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> verts <span class="free">G</span> <span class="main">×</span> verts <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> Y' <span class="main">=</span> Y<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="var">?L</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> complete_digraph_def X arcs_ends_iso graph_app_iso_eq inj_on_Un_image_eq_iff Y'<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> complete_digraph_def arcs_ends_iso graph_app_iso_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Conclusion›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pre_digraph<span class="main">)</span>
  <span class="entity">mk_iso</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> digraph_isomorphism"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mk_iso</span> <span class="free"><span class="bound"><span class="entity">fv</span></span></span> <span class="free"><span class="bound"><span class="entity">fa</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> iso_verts <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">fv</span></span></span><span class="main">,</span> iso_arcs <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">fa</span></span></span><span class="main">,</span>
    iso_head <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">fv</span></span></span> <span class="keyword1">o</span> head <span class="free">G</span> <span class="keyword1">o</span> the_inv_into <span class="main">(</span>arcs <span class="free">G</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">fa</span></span></span><span class="main">,</span>
    iso_tail <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">fv</span></span></span> <span class="keyword1">o</span> tail <span class="free">G</span> <span class="keyword1">o</span> the_inv_into <span class="main">(</span>arcs <span class="free">G</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">fa</span></span></span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pre_digraph<span class="main">)</span> mk_iso_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"iso_verts <span class="main">(</span>mk_iso <span class="free">fv</span> <span class="free">fa</span><span class="main">)</span> <span class="main">=</span> <span class="free">fv</span>"</span></span>
  <span class="quoted"><span class="quoted">"iso_arcs <span class="main">(</span>mk_iso <span class="free">fv</span> <span class="free">fa</span><span class="main">)</span> <span class="main">=</span> <span class="free">fa</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mk_iso_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> wf_digraph<span class="main">)</span> digraph_isomorphism_mk_iso<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">fv</span> <span class="main">(</span>verts <span class="free">G</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">fa</span> <span class="main">(</span>arcs <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"digraph_isomorphism <span class="main">(</span>mk_iso <span class="free">fv</span> <span class="free">fa</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> digraph_isomorphism_def mk_iso_def the_inv_into_f_f wf_digraph<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pairself</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">u</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">v</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Planar_Complete-inj_on_pairself"><span class="command">lemma</span></span> inj_on_pairself<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">×</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>pairself <span class="free">f</span><span class="main">)</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> pairself_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI_pair<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">mk_iso_nomulti</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> pre_digraph <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> pre_digraph <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> digraph_isomorphism"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mk_iso_nomulti</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="free"><span class="bound"><span class="entity">fv</span></span></span> <span class="main">≡</span> <span class="main">⦇</span>
    iso_verts <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">fv</span></span></span><span class="main">,</span>
    iso_arcs <span class="main">=</span> the_inv_into <span class="main">(</span>arcs <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">)</span> <span class="main">(</span>arc_to_ends <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">)</span> <span class="keyword1">o</span> pairself <span class="free"><span class="bound"><span class="entity">fv</span></span></span> <span class="keyword1">o</span> arc_to_ends <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">,</span>
    iso_head <span class="main">=</span> head <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">,</span>
    iso_tail <span class="main">=</span> tail <span class="free"><span class="bound"><span class="entity">H</span></span></span>
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pre_digraph<span class="main">)</span> mk_iso_simps_nomulti<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"iso_verts <span class="main">(</span>mk_iso_nomulti <span class="free">G</span> <span class="free">H</span> <span class="free">fv</span><span class="main">)</span> <span class="main">=</span> <span class="free">fv</span>"</span></span>
  <span class="quoted"><span class="quoted">"iso_head <span class="main">(</span>mk_iso_nomulti <span class="free">G</span> <span class="free">H</span> <span class="free">fv</span><span class="main">)</span> <span class="main">=</span> head <span class="free">H</span>"</span></span>
  <span class="quoted"><span class="quoted">"iso_tail <span class="main">(</span>mk_iso_nomulti <span class="free">G</span> <span class="free">H</span> <span class="free">fv</span><span class="main">)</span> <span class="main">=</span> tail <span class="free">H</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mk_iso_nomulti_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> nomulti_digraph<span class="main">)</span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nomulti_digraph <span class="free">H</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fv<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">fv</span> <span class="main">(</span>verts <span class="free">G</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"verts <span class="free">H</span> <span class="main">=</span> <span class="free">fv</span> <span class="main">`</span> verts <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> arcs_ends<span class="main">:</span> <span class="quoted"><span class="quoted">"arcs_ends <span class="free">H</span> <span class="main">=</span> pairself <span class="free">fv</span> <span class="main">`</span> arcs_ends <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> digraph_isomorphism_mk_iso_nomulti<span class="main">:</span> <span class="quoted"><span class="quoted">"digraph_isomorphism <span class="main">(</span>mk_iso_nomulti <span class="free">G</span> <span class="free">H</span> <span class="free">fv</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t_multi</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> ap_iso_mk_iso_nomulti_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"app_iso <span class="main">(</span>mk_iso_nomulti <span class="free">G</span> <span class="free">H</span> <span class="free">fv</span><span class="main">)</span> <span class="free">G</span> <span class="main">=</span> <span class="free">H</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t_app</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> digraph_iso_mk_iso_nomulti<span class="main">:</span> <span class="quoted"><span class="quoted">"digraph_iso <span class="free">G</span> <span class="free">H</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t_iso</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> H<span class="main">:</span> nomulti_digraph <span class="quoted"><span class="free">H</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fa</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"iso_arcs <span class="main">(</span>mk_iso_nomulti <span class="free">G</span> <span class="free">H</span> <span class="free">fv</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> fa<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="var">?fa</span> <span class="main">(</span>arcs <span class="free">G</span><span class="main">)</span> <span class="main">(</span>arcs <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span>arc_to_ends <span class="free">G</span><span class="main">)</span> <span class="main">(</span>arcs <span class="free">G</span><span class="main">)</span> <span class="main">(</span>arcs_ends <span class="free">G</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_betw_def inj_on_arc_to_ends arcs_ends_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span>pairself <span class="free">fv</span><span class="main">)</span> <span class="main">(</span>arcs_ends <span class="free">G</span><span class="main">)</span> <span class="main">(</span>arcs_ends <span class="free">H</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> arcs_ends <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_betw_def arcs_ends_def arc_to_ends_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fv inj_on_pairself<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="main">(</span>bij_betw_trans<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span>the_inv_into <span class="main">(</span>arcs <span class="free">H</span><span class="main">)</span> <span class="main">(</span>arc_to_ends <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>arcs_ends <span class="free">H</span><span class="main">)</span> <span class="main">(</span>arcs <span class="free">H</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_betw_def the_inv_into_into H.inj_on_arc_to_ends arcs_ends_def inj_on_the_inv_into<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="main">(</span>bij_betw_trans<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_iso_nomulti_def o_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pairself <span class="free">fv</span> <span class="main">(</span>arc_to_ends <span class="free">G</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> arcs_ends <span class="free">H</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> arcs_ends <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_ends_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pairself <span class="free">fv</span> <span class="main">(</span>arc_to_ends <span class="free">G</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> arc_to_ends <span class="free">H</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> arcs <span class="free">H</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_ends_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">fv</span> <span class="main">(</span>tail <span class="free">G</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> tail <span class="free">H</span> <span class="main">(</span><span class="var">?fa</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">fv</span> <span class="main">(</span>head <span class="free">G</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> head <span class="free">H</span> <span class="main">(</span><span class="var">?fa</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mk_iso_nomulti_def the_inv_into_f_f H.inj_on_arc_to_ends<span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pairself_def arc_to_ends_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?t_multi</span></span></span> <span class="var"><span class="quoted"><span class="var">?t_app</span></span></span> <span class="keyword1"><span class="command">using</span></span> fv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> digraph_isomorphism_def bij_betw_def wf_digraph<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?t_iso</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> digraph_iso_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Planar_Complete-complete_digraph_are_iso"><span class="command">lemma</span></span> complete_digraph_are_iso<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"K<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"K<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> <span class="free">H</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"digraph_iso <span class="free">G</span> <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> G<span class="main">:</span> graph <span class="quoted"><span class="free">G</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> complete_digraph_def<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> H<span class="main">:</span> graph <span class="quoted"><span class="free">H</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> complete_digraph_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>verts <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>verts <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> complete_digraph_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> G.finite_verts H.finite_verts <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fv</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">fv</span> <span class="main">(</span>verts <span class="free">G</span><span class="main">)</span> <span class="main">(</span>verts <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_same_card_bij<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fv<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="skolem">fv</span> <span class="main">(</span>verts <span class="free">G</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"verts <span class="free">H</span> <span class="main">=</span> <span class="skolem">fv</span> <span class="main">`</span> verts <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_betw_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arcs_ends <span class="free">H</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> verts <span class="free">H</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> verts <span class="free">H</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">≠</span> <span class="bound">v</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹K<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> <span class="free">H</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> complete_digraph_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pairself <span class="skolem">fv</span> <span class="main">`</span> <span class="main">{</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> verts <span class="free">G</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> verts <span class="free">G</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">≠</span> <span class="bound">v</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> set_eqI iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">fv</span> <span class="main">`</span> verts <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">fv</span> <span class="main">`</span> verts <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">x</span> <span class="main">≠</span> snd <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">fv</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">fv</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> verts <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> verts <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="skolem">x</span><span class="main">,</span> snd <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pairself_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pairself_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> inj_onD<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pairself <span class="skolem">fv</span> <span class="main">`</span> arcs_ends <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹K<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> <span class="free">G</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> complete_digraph_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>  <span class="keyword1"><span class="command">have</span></span> arcs_ends<span class="main">:</span> <span class="quoted"><span class="quoted">"arcs_ends <span class="free">H</span> <span class="main">=</span> pairself <span class="skolem">fv</span> <span class="main">`</span> arcs_ends <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> H.nomulti_digraph fv arcs_ends <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> G.digraph_iso_mk_iso_nomulti<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Planar_Complete-pairself_image_prod"><span class="command">lemma</span></span> pairself_image_prod<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pairself <span class="free">f</span> <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pairself_def<span class="main">)</span>

<span class="keyword1" id="Planar_Complete-complete_bipartite_digraph_are_iso"><span class="command">lemma</span></span> complete_bipartite_digraph_are_iso<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"K<span class="hidden">⇘</span><sub><span class="free">m</span><span class="main">,</span><span class="free">n</span></sub><span class="hidden">⇙</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"K<span class="hidden">⇘</span><sub><span class="free">m</span><span class="main">,</span><span class="free">n</span></sub><span class="hidden">⇙</span> <span class="free">H</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"digraph_iso <span class="free">G</span> <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> G<span class="main">:</span> graph <span class="quoted"><span class="free">G</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> complete_bipartite_digraph_def<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> H<span class="main">:</span> graph <span class="quoted"><span class="free">H</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> complete_bipartite_digraph_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">GU</span></span> <span class="skolem"><span class="skolem">GV</span></span> <span class="keyword2"><span class="keyword">where</span></span> G_parts<span class="main">:</span> <span class="quoted"><span class="quoted">"verts <span class="free">G</span> <span class="main">=</span> <span class="skolem">GU</span> <span class="main">∪</span> <span class="skolem">GV</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">GU</span> <span class="main">∩</span> <span class="skolem">GV</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="quoted"><span class="quoted">"card <span class="skolem">GU</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">GV</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"arcs_ends <span class="free">G</span> <span class="main">=</span> <span class="skolem">GU</span> <span class="main">×</span> <span class="skolem">GV</span> <span class="main">∪</span> <span class="skolem">GV</span> <span class="main">×</span> <span class="skolem">GU</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> complete_bipartite_digraph_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">HU</span></span> <span class="skolem"><span class="skolem">HV</span></span> <span class="keyword2"><span class="keyword">where</span></span> H_parts<span class="main">:</span> <span class="quoted"><span class="quoted">"verts <span class="free">H</span> <span class="main">=</span> <span class="skolem">HU</span> <span class="main">∪</span> <span class="skolem">HV</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">HU</span> <span class="main">∩</span> <span class="skolem">HV</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="quoted"><span class="quoted">"card <span class="skolem">HU</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">HV</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"arcs_ends <span class="free">H</span> <span class="main">=</span> <span class="skolem">HU</span> <span class="main">×</span> <span class="skolem">HV</span> <span class="main">∪</span> <span class="skolem">HV</span> <span class="main">×</span> <span class="skolem">HU</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> complete_bipartite_digraph_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">GU</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">GV</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">HU</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">HV</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> G_parts H_parts G.finite_verts H.finite_verts <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fv_U</span></span> <span class="keyword2"><span class="keyword">where</span></span> fv_U<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">fv_U</span> <span class="skolem">GU</span> <span class="skolem">HU</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹card <span class="skolem">GU</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹card <span class="skolem">HU</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">GU</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">HU</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_same_card_bij<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fv_V</span></span> <span class="keyword2"><span class="keyword">where</span></span> fv_V<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">fv_V</span> <span class="skolem">GV</span> <span class="skolem">HV</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹card <span class="skolem">GV</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹card <span class="skolem">HV</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">GV</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">HV</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_same_card_bij<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">fv</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fv</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">GU</span> <span class="keyword1">then</span> <span class="skolem">fv_U</span> <span class="skolem">x</span> <span class="keyword1">else</span> <span class="skolem">fv_V</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">GV</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> <span class="skolem">GU</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">GU</span> <span class="main">∩</span> <span class="skolem">GV</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> bij_fv_UV<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">fv</span> <span class="skolem">GU</span> <span class="skolem">HU</span>"</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">fv</span> <span class="skolem">GV</span> <span class="skolem">HV</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fv_U fv_V <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> bij_betw_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">fv</span> <span class="main">(</span>verts <span class="free">G</span><span class="main">)</span> <span class="main">(</span>verts <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹verts <span class="free">G</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹verts <span class="free">H</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">HU</span> <span class="main">∩</span> <span class="main">_</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_combine<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fv<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="skolem">fv</span> <span class="main">(</span>verts <span class="free">G</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"verts <span class="free">H</span> <span class="main">=</span> <span class="skolem">fv</span> <span class="main">`</span> verts <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_betw_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arcs_ends <span class="free">H</span> <span class="main">=</span> <span class="skolem">HU</span> <span class="main">×</span> <span class="skolem">HV</span> <span class="main">∪</span> <span class="skolem">HV</span> <span class="main">×</span> <span class="skolem">HU</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹K<span class="hidden">⇘</span><sub><span class="free">m</span><span class="main">,</span><span class="free">n</span></sub><span class="hidden">⇙</span> <span class="free">H</span>›</span></span> H_parts <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> complete_digraph_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pairself <span class="skolem">fv</span> <span class="main">`</span> <span class="main">(</span><span class="skolem">GU</span> <span class="main">×</span> <span class="skolem">GV</span> <span class="main">∪</span> <span class="skolem">GV</span> <span class="main">×</span> <span class="skolem">GU</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> set_eqI iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">fv</span> <span class="main">`</span> <span class="skolem">GU</span> <span class="main">∧</span> snd <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">fv</span> <span class="main">`</span> <span class="skolem">GV</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>fst <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">fv</span> <span class="main">`</span> <span class="skolem">GV</span> <span class="main">∧</span> snd <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">fv</span> <span class="main">`</span> <span class="skolem">GU</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bij_fv_UV <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_betw_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pairself_image_prod image_Un<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bij_fv_UV <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pairself_image_prod image_Un bij_betw_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pairself <span class="skolem">fv</span> <span class="main">`</span> arcs_ends <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹K<span class="hidden">⇘</span><sub><span class="free">m</span><span class="main">,</span><span class="free">n</span></sub><span class="hidden">⇙</span> <span class="free">G</span>›</span></span> G_parts <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> complete_bipartite_digraph_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> arcs_ends<span class="main">:</span> <span class="quoted"><span class="quoted">"arcs_ends <span class="free">H</span> <span class="main">=</span> pairself <span class="skolem">fv</span> <span class="main">`</span> arcs_ends <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> H.nomulti_digraph fv arcs_ends <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> G.digraph_iso_mk_iso_nomulti<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Planar_Complete-K5_not_comb_planar"><span class="command">lemma</span></span> K5_not_comb_planar<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"K<span class="hidden">⇘</span><sub><span class="numeral">5</span></sub><span class="hidden">⇙</span> <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>comb_planar <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> graph <span class="quoted"><span class="free">G</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> complete_digraph_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"digraph_iso <span class="free">G</span> c_K5"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms complete_c_K5 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> complete_digraph_are_iso<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">hom</span></span> <span class="keyword2"><span class="keyword">where</span></span> hom<span class="main">:</span> <span class="quoted"><span class="quoted">"digraph_isomorphism <span class="skolem">hom</span>"</span></span> <span class="quoted"><span class="quoted">"app_iso <span class="skolem">hom</span> <span class="free">G</span> <span class="main">=</span> c_K5"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> digraph_iso_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> c_K5_not_comb_planar comb_planar_iso <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Planar_Complete-K33_not_comb_planar"><span class="command">lemma</span></span> K33_not_comb_planar<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"K<span class="hidden">⇘</span><sub><span class="numeral">3</span><span class="main">,</span><span class="numeral">3</span></sub><span class="hidden">⇙</span> <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>comb_planar <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> graph <span class="quoted"><span class="free">G</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> complete_bipartite_digraph_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"digraph_iso <span class="free">G</span> c_K33"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms complete_c_K33 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> complete_bipartite_digraph_are_iso<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">hom</span></span> <span class="keyword2"><span class="keyword">where</span></span> hom<span class="main">:</span> <span class="quoted"><span class="quoted">"digraph_isomorphism <span class="skolem">hom</span>"</span></span> <span class="quoted"><span class="quoted">"app_iso <span class="skolem">hom</span> <span class="free">G</span> <span class="main">=</span> c_K33"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> digraph_iso_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> c_K33_not_comb_planar comb_planar_iso <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Reachablen">
<div class="head">
<h1>Theory Reachablen</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹$n$-step reachability›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Reachablen
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../graph_theory/theories/#Graph_Theory">Graph_Theory.Graph_Theory</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">ntrancl_onp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> rel <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">r</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
    ntrancl_on_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> <span class="free">F</span> <span class="main">⟹</span> <span class="free">ntrancl_onp</span> <span class="free">F</span> <span class="free">r</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
  <span class="main">|</span> ntrancl_on_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">ntrancl_onp</span> <span class="free">F</span> <span class="free">r</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> <span class="free">F</span> <span class="main">⟹</span> <span class="free">ntrancl_onp</span> <span class="free">F</span> <span class="free">r</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>

<span class="keyword1" id="Reachablen-ntrancl_onpD_rtrancl_on"><span class="command">lemma</span></span> ntrancl_onpD_rtrancl_on<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ntrancl_onp <span class="free">F</span> <span class="free">r</span> <span class="free">n</span> <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">∈</span> rtrancl_on <span class="free">F</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> converse_rtrancl_on_into_rtrancl_on<span class="main">)</span>

<span class="keyword1" id="Reachablen-rtrancl_onE_ntrancl_onp"><span class="command">lemma</span></span> rtrancl_onE_ntrancl_onp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">∈</span> rtrancl_on <span class="free">F</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">n</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"ntrancl_onp <span class="free">F</span> <span class="free">r</span> <span class="free">n</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">atomize_elim</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> ntrancl_onp <span class="free">F</span> <span class="free">r</span> <span class="bound">n</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
    <span class="keyword3"><span class="command">case</span></span> base
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ntrancl_onp <span class="free">F</span> <span class="free">r</span> <span class="main">0</span> <span class="free">b</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ntrancl_onp.intros<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">a</span> <span class="skolem">c</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">_</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"ntrancl_onp <span class="free">F</span> <span class="free">r</span> <span class="skolem">n</span> <span class="skolem">c</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ntrancl_onp <span class="free">F</span> <span class="free">r</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">a</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="free">F</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ntrancl_onp.intros<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Reachablen-rtrancl_on_conv_ntrancl_onp"><span class="command">lemma</span></span> rtrancl_on_conv_ntrancl_onp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">∈</span> rtrancl_on <span class="free">F</span> <span class="free">r</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> ntrancl_onp <span class="free">F</span> <span class="free">r</span> <span class="bound">n</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ntrancl_onpD_rtrancl_on rtrancl_onE_ntrancl_onp<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nreachable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> pre_digraph <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">→⇗</span>_<span class="keyword1">⇖</span>ı _"</span> <span class="main">[</span>100<span class="main">,</span>100<span class="main">]</span> 40<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nreachable</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> ntrancl_onp <span class="main">(</span>verts <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">(</span>arcs_ends <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> wf_digraph <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Reachablen-reachableE_nreachable"><span class="command">lemma</span></span> reachableE_nreachable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">n</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> →<span class="hidden">⇗</span><sup><span class="free">n</span></sup><span class="hidden">⇖</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> reachable_def nreachable_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rtrancl_onE_ntrancl_onp<span class="main">)</span>

<span class="keyword1" id="Reachablen-converse_nreachable_cases"><span class="command">lemma</span></span> converse_nreachable_cases<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword">pred</span></span><span class="main"><span class="main"><span class="main">:</span></span></span> nreachable<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> →<span class="hidden">⇗</span><sup><span class="free">n</span></sup><span class="hidden">⇖</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="main">(</span>ntrancl_on_0<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> verts <span class="free">G</span>"</span></span>
    <span class="main">|</span> <span class="main">(</span>ntrancl_on_Suc<span class="main">)</span> <span class="free">w</span> <span class="free">m</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">→</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> Suc <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> →<span class="hidden">⇗</span><sup><span class="free">m</span></sup><span class="hidden">⇖</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> nreachable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>

<span class="keyword1" id="Reachablen-converse_nreachable_induct"><span class="command">lemma</span></span> converse_nreachable_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> base step<span class="main">,</span> <span class="operator">induct</span> <span class="quasi_keyword"><span class="quasi_keyword">pred</span></span><span class="main"><span class="main"><span class="main">:</span></span></span> reachable<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> major<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> →<span class="hidden">⇗</span><sup><span class="free">n</span></sup><span class="hidden">⇖</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> cases<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> verts <span class="free">G</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">0</span> <span class="free">v</span>"</span></span>
       <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">→</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="bound">y</span><span class="main">;</span> <span class="bound">y</span> →<span class="hidden">⇗</span><sup><span class="bound">n</span></sup><span class="hidden">⇖</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="free">v</span><span class="main">;</span> <span class="free">P</span> <span class="bound">n</span> <span class="bound">y</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">n</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> nreachable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>

<span class="keyword1" id="Reachablen-converse_nreachable_induct_less"><span class="command">lemma</span></span> converse_nreachable_induct_less<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> base step<span class="main">,</span> <span class="operator">induct</span> <span class="quasi_keyword"><span class="quasi_keyword">pred</span></span><span class="main"><span class="main"><span class="main">:</span></span></span> reachable<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> major<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> →<span class="hidden">⇗</span><sup><span class="free">n</span></sup><span class="hidden">⇖</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> cases<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> verts <span class="free">G</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">0</span> <span class="free">v</span>"</span></span>
       <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">→</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="bound">y</span><span class="main">;</span> <span class="bound">y</span> →<span class="hidden">⇗</span><sup><span class="bound">n</span></sup><span class="hidden">⇖</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="free">v</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">z</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="main">≤</span> <span class="bound">n</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">z</span> →<span class="hidden">⇗</span><sup><span class="bound">m</span></sup><span class="hidden">⇖</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="free">v</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">m</span> <span class="bound">z</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">n</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">u</span> →<span class="hidden">⇗</span><sup><span class="bound">q</span></sup><span class="hidden">⇖</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="free">v</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">q</span> <span class="bound">u</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">with</span></span> less <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cases <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> converse_nreachable_cases<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">q'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> →<span class="hidden">⇗</span><sup><span class="skolem">q</span></sup><span class="hidden">⇖</span> <span class="free">v</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">→</span> <span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> →<span class="hidden">⇗</span><sup><span class="skolem">q'</span></sup><span class="hidden">⇖</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> converse_nreachable_cases<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> Suc less <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> less.IH cases<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> major <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Permutations_2">
<div class="head">
<h1>Theory Permutations_2</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Permutations_2
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Combinatorics/Permutations.html">HOL-Combinatorics.Permutations</a>"</span>
  <a href="../../graph_theory/theories/#Auxiliary">Graph_Theory.Auxiliary</a>
  <a href="#Executable_Permutations">Executable_Permutations</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Modifying Permutations›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">funswapid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span>"</span> 90<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">⇌<span class="hidden">⇩</span><sub>F</sub></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> Fun.swap <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> id"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">perm_swap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">perm_swap</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">o</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">o</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">perm_rem</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">perm_rem</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">o</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  An example:

  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">lemma</span></span> <span class="quoted"><span class="quoted">"perm_rem <span class="main"><span class="main">(</span></span><span class="numeral"><span class="numeral">2</span></span> <span class="main"><span class="main">::</span></span> nat<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>list_succ <span class="main"><span class="main">[</span></span><span class="main"><span class="main">1</span></span><span class="main"><span class="main">,</span></span><span class="numeral"><span class="numeral">2</span></span><span class="main"><span class="main">,</span></span><span class="numeral"><span class="numeral">3</span></span><span class="main"><span class="main">,</span></span><span class="numeral"><span class="numeral">4</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">x</span></span> <span class="main"><span class="main">=</span></span> list_succ <span class="main"><span class="main">[</span></span><span class="main"><span class="main">1</span></span><span class="main"><span class="main">,</span></span><span class="numeral"><span class="numeral">3</span></span><span class="main"><span class="main">,</span></span><span class="numeral"><span class="numeral">4</span></span><span class="main"><span class="main">]</span></span> <span class="free"><span class="free">x</span></span>"</span></span>
      <span class="keyword1"><span class="keyword"><span class="keyword1"><span class="keyword">by</span></span></span></span> <span class="main"><span class="main">(</span></span><span class="operator"><span class="operator">auto</span></span> <span class="quasi_keyword"><span class="quasi_keyword">simp</span></span><span class="main"><span class="main">:</span></span> perm_rem_def Fun.swap_def list_succ_def<span class="main"><span class="main">)</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
›</span></span>

<span class="keyword1" id="Permutations_2-perm_swap_id"><span class="command">lemma</span></span> perm_swap_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"perm_swap <span class="free">a</span> <span class="free">b</span> id <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> perm_swap_def<span class="main">)</span>
  
<span class="keyword1" id="Permutations_2-perm_rem_permutes"><span class="command">lemma</span></span> perm_rem_permutes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">permutes</span> <span class="free">S</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"perm_rem <span class="free">x</span> <span class="free">f</span> <span class="keyword1">permutes</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutes_def perm_rem_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> swap_id_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Permutations_2-perm_rem_same"><span class="command">lemma</span></span> perm_rem_same<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bij <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"perm_rem <span class="free">x</span> <span class="free">f</span> <span class="free">y</span> <span class="main">=</span> <span class="free">f</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> perm_rem_def swap_id_eq bij_iff<span class="main">)</span>

<span class="keyword1" id="Permutations_2-perm_rem_simps"><span class="command">lemma</span></span> perm_rem_simps<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bij <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟹</span> perm_rem <span class="free">x</span> <span class="free">f</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟹</span> perm_rem <span class="free">x</span> <span class="free">f</span> <span class="free">y</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">y</span> <span class="main">≠</span> <span class="free">x</span> <span class="main">⟹</span> perm_rem <span class="free">x</span> <span class="free">f</span> <span class="free">y</span> <span class="main">=</span> <span class="free">f</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> perm_rem_def <span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bij_iff id_apply swap_apply<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Permutations_2-bij_swap_compose"><span class="command">lemma</span></span> bij_swap_compose<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="main">(</span><span class="free">x</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">y</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span> <span class="main">⟷</span> bij <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UNIV_I bij_betw_comp_iff2 bij_betw_id bij_swap_iff subsetI<span class="main">)</span>

<span class="keyword1" id="Permutations_2-bij_perm_rem"><span class="command">lemma</span></span> bij_perm_rem<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="main">(</span>perm_rem <span class="free">x</span> <span class="free">f</span><span class="main">)</span> <span class="main">⟷</span> bij <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> perm_rem_def bij_swap_compose<span class="main">)</span>

<span class="keyword1" id="Permutations_2-perm_rem_conv"><span class="command">lemma</span></span> perm_rem_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> bij <span class="bound">f</span> <span class="main">⟹</span> perm_rem <span class="bound">x</span> <span class="bound">f</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="keyword1">then</span> <span class="bound">x</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">f</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="bound">f</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">y</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="bound">f</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> perm_rem_simps<span class="main">)</span>

<span class="keyword1" id="Permutations_2-perm_rem_commutes"><span class="command">lemma</span></span> perm_rem_commutes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bij <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"perm_rem <span class="free">a</span> <span class="main">(</span>perm_rem <span class="free">b</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> perm_rem <span class="free">b</span> <span class="main">(</span>perm_rem <span class="free">a</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> bij_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">⟷</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> perm_rem_conv bij_simp fun_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Permutations_2-perm_rem_id"><span class="command">lemma</span></span> perm_rem_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"perm_rem <span class="free">a</span> id <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> perm_rem_def<span class="main">)</span>

<span class="keyword1" id="Permutations_2-bij_eq_iff"><span class="command">lemma</span></span> bij_eq_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bij <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bij_iff<span class="main">)</span> 

<span class="keyword1" id="Permutations_2-swap_swap_id"><span class="command">lemma</span></span> swap_swap_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> swap_id_eq<span class="main">)</span>

<span class="keyword1" id="Permutations_2-in_funswapid_image_iff"><span class="command">lemma</span></span> in_funswapid_image_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">x</span> <span class="bound">S</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="bound">a</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">b</span><span class="main">)</span> <span class="main">`</span> <span class="bound">S</span> <span class="main">⟷</span> <span class="main">(</span><span class="bound">a</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">b</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bij_def bij_id bij_swap_iff inj_image_mem_iff swap_swap_id<span class="main">)</span>

<span class="keyword1" id="Permutations_2-perm_swap_comp"><span class="command">lemma</span></span> perm_swap_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"perm_swap <span class="free">a</span> <span class="free">b</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> perm_swap <span class="free">a</span> <span class="free">b</span> <span class="free">f</span> <span class="main">(</span>perm_swap <span class="free">a</span> <span class="free">b</span> <span class="free">g</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> perm_swap_def<span class="main">)</span>

<span class="keyword1" id="Permutations_2-bij_perm_swap_iff"><span class="command">lemma</span></span> bij_perm_swap_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="main">(</span>perm_swap <span class="free">a</span> <span class="free">b</span> <span class="free">f</span><span class="main">)</span> <span class="main">⟷</span> bij <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> perm_swap_def bij_swap_compose bij_comp comp_swap<span class="main">)</span>

<span class="keyword1" id="Permutations_2-funpow_perm_swap"><span class="command">lemma</span></span> funpow_perm_swap<span class="main">:</span> <span class="quoted"><span class="quoted">"perm_swap <span class="free">a</span> <span class="free">b</span> <span class="free">f</span> <span class="main">^^</span> <span class="free">n</span> <span class="main">=</span> perm_swap <span class="free">a</span> <span class="free">b</span> <span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> perm_swap_def fun_eq_iff<span class="main">)</span>

<span class="keyword1" id="Permutations_2-orbit_perm_swap"><span class="command">lemma</span></span> orbit_perm_swap<span class="main">:</span> <span class="quoted"><span class="quoted">"orbit <span class="main">(</span>perm_swap <span class="free">a</span> <span class="free">b</span> <span class="free">f</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">b</span><span class="main">)</span> <span class="main">`</span> orbit <span class="free">f</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">b</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> orbit_altdef funpow_perm_swap<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> perm_swap_def<span class="main">)</span>

<span class="keyword1" id="Permutations_2-has_dom_perm_swap"><span class="command">lemma</span></span> has_dom_perm_swap<span class="main">:</span> <span class="quoted"><span class="quoted">"has_dom <span class="main">(</span>perm_swap <span class="free">a</span> <span class="free">b</span> <span class="free">f</span><span class="main">)</span> <span class="free">S</span> <span class="main">=</span> has_dom <span class="free">f</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">b</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_dom_def perm_swap_def inj_image_mem_iff<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> image_iff swap_swap_id<span class="main">)</span>

<span class="keyword1" id="Permutations_2-perm_restrict_dom_subset"><span class="command">lemma</span></span> perm_restrict_dom_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"has_dom <span class="free">f</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"perm_restrict <span class="free">f</span> <span class="free">A</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_dom_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> perm_restrict_def fun_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Permutations_2-has_domD"><span class="command">lemma</span></span> has_domD<span class="main">:</span> <span class="quoted"><span class="quoted">"has_dom <span class="free">f</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_dom_def<span class="main">)</span>

<span class="keyword1" id="Permutations_2-has_domI"><span class="command">lemma</span></span> has_domI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> has_dom <span class="free">f</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_dom_def<span class="main">)</span>

<span class="keyword1" id="Permutations_2-perm_swap_permutes2"><span class="command">lemma</span></span> perm_swap_permutes2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">permutes</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">y</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"perm_swap <span class="free">x</span> <span class="free">y</span> <span class="free">f</span> <span class="keyword1">permutes</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> perm_swap_def permutes_conv_has_dom has_dom_perm_swap<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> perm_swap_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">metis</span> bij_swap_iff bij_swap_compose_bij comp_id comp_swap<span class="main">)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Cyclic Permutations›</span></span>

<span class="keyword1" id="Permutations_2-cyclic_on_perm_swap"><span class="command">lemma</span></span> cyclic_on_perm_swap<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cyclic_on <span class="free">f</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cyclic_on <span class="main">(</span>perm_swap <span class="free">x</span> <span class="free">y</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">y</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cyclic_on_image<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> perm_swap_def<span class="main">)</span>

<span class="keyword1" id="Permutations_2-orbit_perm_rem"><span class="command">lemma</span></span> orbit_perm_rem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bij <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"orbit <span class="main">(</span>perm_rem <span class="free">y</span> <span class="free">f</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> orbit <span class="free">f</span> <span class="free">x</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> set_eqI iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> perm_rem_conv bij_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> orbit.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> orbit <span class="free">f</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">z</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟶</span> <span class="skolem">z</span> <span class="main">∈</span> <span class="var">?L</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟶</span> <span class="free">f</span> <span class="skolem">z</span> <span class="main">∈</span> <span class="var">?L</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
      <span class="keyword3"><span class="command">case</span></span> base <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> orbit_eqI<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> perm_rem_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">z</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> orbit_eqI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> perm_rem_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">with</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Permutations_2-orbit_perm_rem_eq"><span class="command">lemma</span></span> orbit_perm_rem_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bij <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"orbit <span class="main">(</span>perm_rem <span class="free">y</span> <span class="free">f</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="keyword1">then</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span> <span class="keyword1">else</span> orbit <span class="free">f</span> <span class="free">x</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> orbit_eq_singleton_iff orbit_perm_rem perm_rem_simps<span class="main">)</span>

<span class="keyword1" id="Permutations_2-cyclic_on_perm_rem"><span class="command">lemma</span></span> cyclic_on_perm_rem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cyclic_on <span class="free">f</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"bij <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≠</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cyclic_on <span class="main">(</span>perm_rem <span class="free">x</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> cyclic_on_alldef<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cyclic_on_def orbit_perm_rem_eq<span class="main">)</span> <span class="operator">auto</span>



<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Planar_Subdivision">
<div class="head">
<h1>Theory Planar_Subdivision</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Planar_Subdivision
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Graph_Genus">Graph_Genus</a>
  <a href="#Reachablen">Reachablen</a>
  <a href="#Permutations_2">Permutations_2</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Combinatorial Planarity and Subdivisions›</span></span>

<span class="keyword1"><span class="command">locale</span></span> subdiv1_contr <span class="main">=</span> subdiv_step <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">HM</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H_map<span class="main">:</span> <span class="quoted"><span class="quoted">"digraph_map <span class="free">H</span> <span class="free">HM</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> edge_rev_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"edge_rev <span class="free">HM</span> <span class="main">=</span> <span class="free">rev_H</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> subdiv1_contr <span class="main">⊆</span> H<span class="main">:</span> digraph_map <span class="quoted"><span class="free">H</span></span> <span class="quoted"><span class="free">HM</span></span>
  <span class="keyword2"><span class="keyword">rewrites</span></span> <span class="quoted"><span class="quoted">"edge_rev <span class="free">HM</span> <span class="main">=</span> <span class="free">rev_H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> H_map edge_rev_conv<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> subdiv1_contr <span class="main">⊆</span> G<span class="main">:</span> fin_digraph <span class="quoted"><span class="free">G</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_G verts_G<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> subdiv1_contr <span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">GM</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> pre_map"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">GM</span> <span class="main">≡</span>
      <span class="main">⦇</span> edge_rev <span class="main">=</span> <span class="free">rev_G</span>
      <span class="main">,</span> edge_succ <span class="main">=</span> perm_swap <span class="free">uw</span> <span class="free">uv</span> <span class="main">(</span>perm_swap <span class="free">vw</span> vu <span class="main">(</span>fold perm_rem <span class="main">[</span>wu<span class="main">,</span> wv<span class="main">]</span> <span class="main">(</span>edge_succ <span class="free">HM</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">⦈</span>"</span></span>

  <span class="keyword1" id="Planar_Subdivision-edge_rev_GM"><span class="command">lemma</span></span> edge_rev_GM<span class="main">:</span>  <span class="quoted"><span class="quoted">"edge_rev GM <span class="main">=</span> <span class="free">rev_G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> GM_def<span class="main">)</span>

  <span class="keyword1" id="Planar_Subdivision-edge_succ_GM"><span class="command">lemma</span></span> edge_succ_GM<span class="main">:</span> <span class="quoted"><span class="quoted">"edge_succ GM <span class="main">=</span> perm_swap <span class="free">uw</span> <span class="free">uv</span> <span class="main">(</span>perm_swap <span class="free">vw</span> <span class="main">(</span><span class="free">rev_G</span> <span class="free">uv</span><span class="main">)</span> <span class="main">(</span>fold perm_rem <span class="main">[</span>wu<span class="main">,</span> wv<span class="main">]</span> <span class="main">(</span>edge_succ <span class="free">HM</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> GM_def<span class="main">)</span>

  <span class="keyword1" id="Planar_Subdivision-rev_H_eq_rev_G"><span class="command">lemma</span></span> rev_H_eq_rev_G<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> arcs <span class="free">G</span> <span class="main">-</span> <span class="main">{</span><span class="free">uv</span><span class="main">,</span>vu<span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">rev_H</span> <span class="free">x</span> <span class="main">=</span> <span class="free">rev_G</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"perm_restrict <span class="free">rev_H</span> <span class="main">(</span>arcs <span class="free">G</span><span class="main">)</span> <span class="main">=</span> perm_restrict <span class="free">rev_G</span> <span class="main">(</span>arcs <span class="free">H</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subdiv_step <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subdivision_step_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> arcs_H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> perm_restrict_def fun_eq_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subdivision-edge_succ_permutes"><span class="command">lemma</span></span> edge_succ_permutes<span class="main">:</span> <span class="quoted"><span class="quoted">"edge_succ GM <span class="keyword1">permutes</span> arcs <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arcs <span class="free">H</span> <span class="main">⊆</span> <span class="main">(</span><span class="free">vw</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">rev_G</span> <span class="free">uv</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">uw</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">uv</span><span class="main">)</span> <span class="main">`</span> arcs <span class="free">G</span> <span class="main">∪</span> <span class="main">{</span>wv<span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>wu<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subdiv_distinct_arcs in_arcs_G
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_H in_funswapid_image_iff swap_id_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"perm_swap <span class="free">uw</span> <span class="free">uv</span> <span class="main">(</span>perm_swap <span class="free">vw</span> <span class="main">(</span><span class="free">rev_G</span> <span class="free">uv</span><span class="main">)</span> <span class="main">(</span>perm_rem <span class="main">(</span>wv<span class="main">)</span> <span class="main">(</span>perm_rem <span class="main">(</span>wu<span class="main">)</span> <span class="main">(</span>edge_succ <span class="free">HM</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">permutes</span> arcs <span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> perm_rem_permutes perm_swap_permutes2 permutes_subset H.edge_succ_permutes<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> edge_succ_GM<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subdivision-out_arcs_empty"><span class="command">lemma</span></span> out_arcs_empty<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> verts <span class="free">G</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"out_arcs <span class="free">G</span> <span class="free">x</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> out_arcs <span class="free">H</span> <span class="free">x</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"out_arcs <span class="free">H</span> <span class="free">x</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> tail_eqI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> tail <span class="free">H</span> <span class="bound">a</span> <span class="main">=</span> tail <span class="free">G</span> <span class="bound">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> tail_eq<span class="main">)</span>

    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> out_arcs <span class="free">G</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> arcs <span class="free">H</span> <span class="main">⟹</span> <span class="skolem">a</span> <span class="main">≠</span> <span class="free">uv</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> arcs <span class="free">H</span> <span class="main">⟹</span> <span class="skolem">a</span> <span class="main">≠</span> vu"</span></span>
        <span class="keyword1"><span class="command">using</span></span> not_in_arcs_H <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">uw</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">uv</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">vw</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> vu<span class="main">)</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> out_arcs <span class="free">H</span> <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> subdiv_distinct_arcs in_arcs_H not_in_arcs_H
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_G <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> tail_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"out_arcs <span class="free">G</span> <span class="free">x</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> in_out_arcs_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"out_arcs <span class="free">G</span> <span class="free">x</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> tail_eqI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> tail <span class="free">H</span> <span class="bound">a</span> <span class="main">=</span> tail <span class="free">G</span> <span class="bound">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> tail_eq<span class="main">)</span>

    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> out_arcs <span class="free">H</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms not_in_verts_G <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">uw</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">uv</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">vw</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> vu<span class="main">)</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> out_arcs <span class="free">G</span> <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> subdiv_distinct_arcs in_arcs_G not_in_arcs_G
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_H <span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> swap_id_eq <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> tail_eqI<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"out_arcs <span class="free">H</span> <span class="free">x</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> in_out_arcs_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subdivision-cyclic_on_edge_succ"><span class="command">lemma</span></span> cyclic_on_edge_succ<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> verts <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"out_arcs <span class="free">G</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cyclic_on <span class="main">(</span>edge_succ GM<span class="main">)</span> <span class="main">(</span>out_arcs <span class="free">G</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> oa_Gx<span class="main">:</span> <span class="quoted"><span class="quoted">"out_arcs <span class="free">G</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">uw</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">uv</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">vw</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> vu<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>out_arcs <span class="free">H</span> <span class="free">x</span> <span class="main">-</span> <span class="main">{</span>wu<span class="main">}</span> <span class="main">-</span> <span class="main">{</span>wv<span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subdiv_distinct_arcs not_in_arcs_G in_arcs_G
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_funswapid_image_iff arcs_H swap_id_eq tail_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cyclic_on <span class="main">(</span>perm_swap <span class="free">uw</span> <span class="free">uv</span> <span class="main">(</span>perm_swap <span class="free">vw</span> <span class="main">(</span><span class="free">rev_G</span> <span class="free">uv</span><span class="main">)</span> <span class="main">(</span>perm_rem <span class="main">(</span>wv<span class="main">)</span> <span class="main">(</span>perm_rem <span class="main">(</span>wu<span class="main">)</span> <span class="main">(</span>edge_succ <span class="free">HM</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>out_arcs <span class="free">G</span> <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> oa_Gx
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> cyclic_on_perm_swap cyclic_on_perm_rem<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cyclic_on <span class="main">(</span>edge_succ <span class="free">HM</span><span class="main">)</span> <span class="main">(</span>out_arcs <span class="free">H</span> <span class="free">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> out_arcs_empty verts_H <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> H.edge_succ_cyclic<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bij <span class="main">(</span>edge_succ <span class="free">HM</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> H.bij_edge_succ<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bij <span class="main">(</span>perm_rem <span class="main">(</span>wu<span class="main">)</span> <span class="main">(</span>edge_succ <span class="free">HM</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> H.bij_edge_succ<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms not_in_verts_G <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wu <span class="main">∉</span> out_arcs <span class="free">H</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"wv <span class="main">∉</span> out_arcs <span class="free">H</span> <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arc_to_ends_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"out_arcs <span class="free">H</span> <span class="free">x</span> <span class="main">-</span> <span class="main">{</span>wu<span class="main">}</span> <span class="main">≠</span> <span class="main">{</span>wv<span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"out_arcs <span class="free">H</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">{</span>wu<span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edge_succ_GM<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subdivision-digraph_map_GM"><span class="command">lemma</span></span> digraph_map_GM<span class="main">:</span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"digraph_map <span class="free">G</span> GM"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> edge_rev_GM G.arev_dom edge_succ_permutes cyclic_on_edge_succ verts_G<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">sublocale</span></span> subdiv1_contr <span class="main">⊆</span> GM<span class="main">:</span> digraph_map <span class="quoted"><span class="free">G</span></span> <span class="quoted">GM</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> digraph_map_GM<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> subdiv1_contr <span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Planar_Subdivision-reachableGD"><span class="command">lemma</span></span> reachableGD<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub><span class="free">H</span></sub><span class="hidden">⇙</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
    <span class="keyword3"><span class="command">case</span></span> base <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> verts_H<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">x</span> <span class="skolem">z</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub><span class="free">H</span></sub><span class="hidden">⇙</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub><span class="free">H</span></sub><span class="hidden">⇙</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> adj_with_w <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">u</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">→</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="skolem">z</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> arcs <span class="free">H</span>"</span></span> <span class="quoted"><span class="quoted">"arc_to_ends <span class="free">H</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"tail <span class="free">H</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_H tail_eq head_eq arc_to_ends_def fun_eq_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">→</span><span class="hidden">⇘</span><sub><span class="free">H</span></sub><span class="hidden">⇙</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_ends_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_image_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> H.reachable_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">proj_verts_H</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">proj_verts_H</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free">w</span> <span class="keyword1">then</span> <span class="free">u</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

  <span class="keyword1" id="Planar_Subdivision-proj_verts_H_in_G"><span class="command">lemma</span></span> proj_verts_H_in_G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> verts <span class="free">H</span> <span class="main">⟹</span> proj_verts_H <span class="free">x</span> <span class="main">∈</span> verts <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> in_verts_G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_verts_H_def verts_H<span class="main">)</span>

  <span class="keyword1" id="Planar_Subdivision-dominatesHD"><span class="command">lemma</span></span> dominatesHD<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">→</span><span class="hidden">⇘</span><sub><span class="free">H</span></sub><span class="hidden">⇙</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"proj_verts_H <span class="free">x</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> proj_verts_H <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> X1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> arc_to_ends <span class="free">G</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">∉</span> arcs <span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> G.adj_in_verts<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> G.dominatesI not_in_verts_G<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> X2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> arc_to_ends <span class="free">G</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">∉</span> arcs <span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> G.adj_in_verts<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> G.dominatesI not_in_verts_G<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms subdiv_ate_H_rev subdiv_ate in_verts_G
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_ends_def arcs_H arc_to_ends_eq proj_verts_H_def G_reach <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> X1 X2<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subdivision-reachableHD"><span class="command">lemma</span></span> reachableHD<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> reach<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub><span class="free">H</span></sub><span class="hidden">⇙</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"proj_verts_H <span class="free">x</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> proj_verts_H <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> proj_verts_H_in_G G.reachable_trans dominatesHD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1" id="Planar_Subdivision-H_reach_conv"><span class="command">lemma</span></span> H_reach_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub><span class="free">H</span></sub><span class="hidden">⇙</span> <span class="bound">y</span> <span class="main">⟷</span> proj_verts_H <span class="bound">x</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> proj_verts_H <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> w_reach <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> reachableHD<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_verts_H_def verts_H <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> reachableGD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> H.reachable_trans<span class="main">)</span>

  <span class="keyword1" id="Planar_Subdivision-sccs_eq"><span class="command">lemma</span></span> sccs_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"G.sccs_verts <span class="main">=</span> <span class="main">(`)</span> proj_verts_H <span class="main">`</span> H.sccs_verts"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> set_eqI iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∉</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> G.sccs_verts_subsets not_in_verts_G <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> S_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"proj_verts_H <span class="main">`</span> proj_verts_H <span class="main">-`</span> <span class="skolem">S</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_verts_H_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> range_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"proj_verts_H <span class="main">-`</span> <span class="skolem">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">∈</span> <span class="var">?L</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">safe</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.sccs_verts_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">∈</span> <span class="var">?L</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"proj_verts_H <span class="main">-`</span> <span class="skolem">S</span> <span class="main">∈</span> H.sccs_verts"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.in_sccs_verts_conv_reachable H.in_sccs_verts_conv_reachable H_reach_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"proj_verts_H <span class="main">`</span> proj_verts_H <span class="main">-`</span> <span class="skolem">S</span> <span class="main">∈</span> <span class="main">(`)</span> proj_verts_H <span class="main">`</span> H.sccs_verts"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> imageI<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> S_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∉</span> proj_verts_H <span class="main">`</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">w</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">v</span> <span class="main">=</span> proj_verts_H <span class="bound">y</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∉</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_verts_H_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">∈</span> <span class="var">?R</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> not_in_verts_G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.reachable_in_verts G.in_sccs_verts_conv_reachable
        H.in_sccs_verts_conv_reachable H_reach_conv <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> X<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subdivision-inj_on_proj_verts_H"><span class="command">lemma</span></span> inj_on_proj_verts_H<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">(`)</span> proj_verts_H<span class="main">)</span> <span class="main">(</span>pre_digraph.sccs_verts <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="skolem">T</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> H.sccs_verts"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">∈</span> H.sccs_verts"</span></span> <span class="quoted"><span class="quoted">"proj_verts_H <span class="main">`</span> <span class="skolem">S</span> <span class="main">=</span> proj_verts_H <span class="main">`</span> <span class="skolem">T</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">w</span> <span class="main">∉</span> <span class="bound">x</span> <span class="main">⟹</span> proj_verts_H <span class="main">`</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_verts_H_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">≠</span> <span class="skolem">T</span> <span class="main">⟹</span> <span class="skolem">S</span> <span class="main">∩</span> <span class="skolem">T</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> H.in_sccs_verts_conv_reachable Int_iff empty_iff image_eqI proj_verts_H_def w_reach<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H.sccs_verts_disjoint<span class="main">[</span><span class="operator">OF</span> A<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subdivision-card_sccs_verts"><span class="command">lemma</span></span> card_sccs_verts<span class="main">:</span> <span class="quoted"><span class="quoted">"card G.sccs_verts <span class="main">=</span> card H.sccs_verts"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sccs_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_image inj_on_proj_verts_H<span class="main">)</span>

  <span class="keyword1" id="Planar_Subdivision-card_sccs_eq"><span class="command">lemma</span></span> card_sccs_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"card G.sccs <span class="main">=</span> card H.sccs"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_sccs_verts G.inj_on_verts_sccs H.inj_on_verts_sccs
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.sccs_verts_conv H.sccs_verts_conv card_image<span class="main">)</span>

  <span class="keyword1" id="Planar_Subdivision-isolated_verts_eq"><span class="command">lemma</span></span> isolated_verts_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"G.isolated_verts <span class="main">=</span> H.isolated_verts"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.isolated_verts_def H.isolated_verts_def verts_H out_arcs_w <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> out_arcs_empty<span class="main">)</span>

  <span class="keyword1" id="Planar_Subdivision-card_verts"><span class="command">lemma</span></span> card_verts<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>verts <span class="free">H</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>verts <span class="free">G</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> verts_H <span class="keyword1"><span class="command">using</span></span> not_in_verts_G <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Planar_Subdivision-card_arcs"><span class="command">lemma</span></span> card_arcs<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>arcs <span class="free">H</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>arcs <span class="free">G</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> arcs_H <span class="keyword1"><span class="command">using</span></span> not_in_arcs_G subdiv_distinct_arcs in_arcs_G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_insert_if<span class="main">)</span>

  <span class="keyword1" id="Planar_Subdivision-edge_succ_wu"><span class="command">lemma</span></span> edge_succ_wu<span class="main">:</span> <span class="quoted"><span class="quoted">"edge_succ <span class="free">HM</span> wu <span class="main">=</span> wv"</span></span>
    <span class="keyword1"><span class="command">using</span></span> out_arcs_w out_degree_w edge_succ_permutes H.edge_succ_cyclic<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> eq_on_cyclic_on_iff1<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"wu"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> verts_H out_degree_def<span class="main">)</span>

  <span class="keyword1" id="Planar_Subdivision-edge_succ_wv"><span class="command">lemma</span></span> edge_succ_wv<span class="main">:</span> <span class="quoted"><span class="quoted">"edge_succ <span class="free">HM</span> wv <span class="main">=</span> wu"</span></span>
    <span class="keyword1"><span class="command">using</span></span> out_arcs_w out_degree_w edge_succ_permutes H.edge_succ_cyclic<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> eq_on_cyclic_on_iff1<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"wv"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> verts_H out_degree_def<span class="main">)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> edge_succ_w <span class="main">=</span> edge_succ_wu edge_succ_wv

  <span class="keyword1" id="Planar_Subdivision-H_face_cycle_succ"><span class="command">lemma</span></span> H_face_cycle_succ<span class="main">:</span>
      <span class="quoted"><span class="quoted">"H.face_cycle_succ <span class="free">uw</span> <span class="main">=</span> wv"</span></span>
      <span class="quoted"><span class="quoted">"H.face_cycle_succ <span class="free">vw</span> <span class="main">=</span> wu"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> H.face_cycle_succ_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> edge_succ_w<span class="main">)</span>

  <span class="keyword1" id="Planar_Subdivision-H_edge_succ_tail_eqD"><span class="command">lemma</span></span> H_edge_succ_tail_eqD<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"edge_succ <span class="free">HM</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tail <span class="free">H</span> <span class="free">a</span> <span class="main">=</span> tail <span class="free">H</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms H.tail_edge_succ<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Planar_Subdivision-YYY"><span class="command">lemma</span></span> YYY<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>wu <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> wv<span class="main">)</span> <span class="main">(</span>edge_succ <span class="free">HM</span> <span class="free">vw</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>edge_succ <span class="free">HM</span> <span class="free">vw</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>wu <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> wv<span class="main">)</span> <span class="main">(</span>edge_succ <span class="free">HM</span> <span class="free">uw</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>edge_succ <span class="free">HM</span> <span class="free">uw</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> H.edge_succ_cyclic<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> subdiv_distinct_verts0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> swap_id_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> H_edge_succ_tail_eqD<span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Project arcs of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">H</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to corresponding arcs of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">G</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">proj_arcs_H</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">proj_arcs_H</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span>
      <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free">uw</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> wv <span class="keyword1">then</span> <span class="free">uv</span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free">vw</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> wu <span class="keyword1">then</span> vu
      <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Project arcs of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">G</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to corresponding arcs of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">H</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">proj_arcs_G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">proj_arcs_G</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span>
      <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free">uv</span> <span class="keyword1">then</span> <span class="free">uw</span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> vu <span class="keyword1">then</span> <span class="free">vw</span>
      <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

  <span class="keyword1" id="Planar_Subdivision-proj_arcs_H_simps"><span class="command">lemma</span></span> proj_arcs_H_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"proj_arcs_H <span class="free">uw</span> <span class="main">=</span> <span class="free">uv</span>"</span></span>
      <span class="quoted"><span class="quoted">"proj_arcs_H wv <span class="main">=</span> <span class="free">uv</span>"</span></span>
      <span class="quoted"><span class="quoted">"proj_arcs_H <span class="free">vw</span> <span class="main">=</span> vu"</span></span>
      <span class="quoted"><span class="quoted">"proj_arcs_H wu <span class="main">=</span> vu"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="main">{</span><span class="free">uw</span><span class="main">,</span><span class="free">vw</span><span class="main">,</span>wu<span class="main">,</span>wv<span class="main">}</span> <span class="main">⟹</span> proj_arcs_H <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span> <span class="main">⟹</span> proj_arcs_H <span class="free">a</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subdiv_distinct_arcs not_in_arcs_G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_arcs_H_def<span class="main">)</span>

  <span class="keyword1" id="Planar_Subdivision-proj_arcs_H_in_arcs_G"><span class="command">lemma</span></span> proj_arcs_H_in_arcs_G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">H</span> <span class="main">⟹</span> proj_arcs_H <span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subdiv_distinct_arcs in_arcs_G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_arcs_H_def arcs_H<span class="main">)</span>

  <span class="keyword1" id="Planar_Subdivision-proj_arcs_eq_swap"><span class="command">lemma</span></span> proj_arcs_eq_swap<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> <span class="main">{</span><span class="free">uv</span><span class="main">,</span>vu<span class="main">,</span>wu<span class="main">,</span>wv<span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"proj_arcs_H <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">uw</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">uv</span> <span class="keyword1">o</span> <span class="free">vw</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> vu<span class="main">)</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms subdiv_distinct_arcs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="free">uw</span><span class="main">,</span><span class="free">vw</span><span class="main">}</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1" id="Planar_Subdivision-proj_arcs_G_simps"><span class="command">lemma</span></span> proj_arcs_G_simps<span class="main">:</span>
      <span class="quoted"><span class="quoted">"proj_arcs_G <span class="free">uv</span> <span class="main">=</span> <span class="free">uw</span>"</span></span>
      <span class="quoted"><span class="quoted">"proj_arcs_G vu <span class="main">=</span> <span class="free">vw</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> <span class="main">{</span><span class="free">uv</span><span class="main">,</span>vu<span class="main">}</span> <span class="main">⟹</span> proj_arcs_G <span class="free">a</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subdiv_distinct_arcs not_in_arcs_G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> swap_id_eq proj_arcs_G_def<span class="main">)</span>

  <span class="keyword1" id="Planar_Subdivision-proj_arcs_G_in_arcs_H"><span class="command">lemma</span></span> proj_arcs_G_in_arcs_H<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"proj_arcs_G <span class="free">a</span> <span class="main">∈</span> arcs <span class="free">H</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms subdiv_distinct_arcs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_arcs_G_def arcs_H<span class="main">)</span>

  <span class="keyword1" id="Planar_Subdivision-proj_arcs_HG"><span class="command">lemma</span></span> proj_arcs_HG<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span> <span class="main">⟹</span> proj_arcs_H <span class="main">(</span>proj_arcs_G <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_arcs_G_def<span class="main">)</span>

  <span class="keyword1" id="Planar_Subdivision-fcs_proj_arcs_GH"><span class="command">lemma</span></span> fcs_proj_arcs_GH<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">H</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"H.face_cycle_set <span class="main">(</span>proj_arcs_G <span class="main">(</span>proj_arcs_H <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> H.face_cycle_set <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"H.face_cycle_set <span class="free">vw</span> <span class="main">=</span> H.face_cycle_set wu"</span></span> <span class="quoted"><span class="quoted">"H.face_cycle_set <span class="free">uw</span> <span class="main">=</span> H.face_cycle_set wv"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> H.face_cycle_set_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> H_face_cycle_succ<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
        self_in_orbit_step H.permutation_face_cycle_succ permutation_self_in_orbit<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms not_in_arcs_H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="free">uv</span><span class="main">,</span>vu<span class="main">,</span><span class="free">uw</span><span class="main">,</span>wu<span class="main">,</span><span class="free">vw</span><span class="main">,</span>wv<span class="main">}</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_arcs_G_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> 

  <span class="keyword1" id="Planar_Subdivision-H_face_cycle_succ_neq_uv"><span class="command">lemma</span></span> H_face_cycle_succ_neq_uv<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> <span class="main">{</span><span class="free">uv</span><span class="main">,</span>vu<span class="main">}</span> <span class="main">⟹</span> H.face_cycle_succ <span class="free">a</span> <span class="main">∉</span> <span class="main">{</span><span class="free">uv</span><span class="main">,</span>vu<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_in_arcs_H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">H</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> H.face_cycle_succ_in_arcsI<span class="main">)</span>

  <span class="keyword1" id="Planar_Subdivision-face_cycle_succ_choose_inter"><span class="command">lemma</span></span> face_cycle_succ_choose_inter<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">{</span>H.face_cycle_succ <span class="free">uw</span><span class="main">,</span> H.face_cycle_succ <span class="free">vw</span><span class="main">,</span> H.face_cycle_succ wu<span class="main">,</span> H.face_cycle_succ wv<span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="free">uv</span><span class="main">,</span>vu<span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subdiv_distinct_arcs H_face_cycle_succ_neq_uv <span class="keyword1"><span class="command">by</span></span> <span class="operator">safe</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

  <span class="keyword1" id="Planar_Subdivision-face_cycle_succ_choose_neq"><span class="command">lemma</span></span> face_cycle_succ_choose_neq<span class="main">:</span>
      <span class="quoted"><span class="quoted">"H.face_cycle_succ wu <span class="main">∉</span> <span class="main">{</span>wu<span class="main">,</span>wv<span class="main">}</span>"</span></span>
      <span class="quoted"><span class="quoted">"H.face_cycle_succ wv <span class="main">∉</span> <span class="main">{</span>wu<span class="main">,</span>wv<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subdiv_distinct_verts0 in_arcs_H
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> H.edge_rev_in_arcs <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> H.tail_face_cycle_succ<span class="main">)</span>

  <span class="keyword1" id="Planar_Subdivision-H_face_cycle_succ_G_not_in"><span class="command">lemma</span></span> H_face_cycle_succ_G_not_in<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"H.face_cycle_succ <span class="free">a</span> <span class="main">∉</span> <span class="main">{</span>wu<span class="main">,</span>wv<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="free">uv</span><span class="main">,</span>vu<span class="main">}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> subdiv_distinct_arcs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_H<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_H<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head <span class="free">H</span> <span class="free">a</span> <span class="main">≠</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> head_eq verts_G arcs_H <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> G.head_in_verts<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> H.tail_face_cycle_succ<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">H</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subdivision-face_cycle_succ_uv"><span class="command">lemma</span></span>
    face_cycle_succ_uv<span class="main">:</span> <span class="quoted"><span class="quoted">"GM.face_cycle_succ <span class="free">uv</span> <span class="main">=</span> proj_arcs_H <span class="main">(</span>H.face_cycle_succ wv<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    face_cycle_succ_vu<span class="main">:</span> <span class="quoted"><span class="quoted">"GM.face_cycle_succ vu <span class="main">=</span> proj_arcs_H <span class="main">(</span>H.face_cycle_succ wu<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> GM.face_cycle_succ_def edge_rev_GM edge_succ_GM
    <span class="keyword1"><span class="command">using</span></span> face_cycle_succ_choose_neq face_cycle_succ_choose_inter subdiv_distinct_arcs
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff perm_swap_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> perm_rem_def edge_succ_w H.face_cycle_succ_def YYY proj_arcs_H_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="Planar_Subdivision-face_cycle_succ_not_uv"><span class="command">lemma</span></span> face_cycle_succ_not_uv<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> <span class="main">{</span><span class="free">uv</span><span class="main">,</span>vu<span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"GM.face_cycle_succ <span class="free">a</span> <span class="main">=</span> proj_arcs_H <span class="main">(</span>H.face_cycle_succ <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"GM.face_cycle_succ <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">uw</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">uv</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">vw</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">rev_G</span> <span class="free">uv</span><span class="main">)</span> <span class="main">(</span>perm_rem <span class="main">(</span>wv<span class="main">)</span> <span class="main">(</span>perm_rem <span class="main">(</span>wu<span class="main">)</span> <span class="main">(</span>edge_succ <span class="free">HM</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">vw</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> vu<span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">uw</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">uv</span><span class="main">)</span> <span class="main">(</span><span class="free">rev_G</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> GM.face_cycle_succ_def perm_swap_def edge_succ_GM edge_rev_GM<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">vw</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> vu<span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">uw</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">uv</span><span class="main">)</span> <span class="main">(</span><span class="free">rev_G</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">rev_G</span> <span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms not_in_arcs_G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> swap_id_eq G.arev_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"perm_rem <span class="main">(</span>wv<span class="main">)</span> <span class="main">(</span>perm_rem <span class="main">(</span>wu<span class="main">)</span> <span class="main">(</span>edge_succ <span class="free">HM</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">rev_G</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> edge_succ <span class="free">HM</span> <span class="main">(</span><span class="free">rev_G</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> tail <span class="free">H</span> <span class="bound">a</span> <span class="main">≠</span> <span class="free">w</span> <span class="main">⟹</span> <span class="main">(</span>wu <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> wv<span class="main">)</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> swap_id_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head <span class="free">H</span> <span class="free">a</span> <span class="main">≠</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"tail <span class="free">H</span> <span class="main">(</span><span class="free">rev_G</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> head <span class="free">H</span> <span class="free">a</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tail_eq head_eq verts_G <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> G.head_in_verts<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>wu <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> wv<span class="main">)</span> <span class="main">(</span>edge_succ <span class="free">HM</span> <span class="main">(</span><span class="free">rev_G</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> edge_succ <span class="free">HM</span> <span class="main">(</span><span class="free">rev_G</span> <span class="free">a</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> *<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> perm_rem_def edge_succ_w<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"edge_succ <span class="free">HM</span> <span class="main">(</span><span class="free">rev_G</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> H.face_cycle_succ <span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> H.face_cycle_succ_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_H_eq_rev_G<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">uw</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">uv</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">vw</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">rev_G</span> <span class="free">uv</span><span class="main">)</span> <span class="main">(</span>H.face_cycle_succ <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> proj_arcs_H <span class="main">(</span>H.face_cycle_succ <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_H<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fcs_not_in<span class="main">:</span> <span class="quoted"><span class="quoted">"H.face_cycle_succ <span class="free">a</span> <span class="main">∉</span> <span class="main">{</span><span class="free">uv</span><span class="main">,</span> vu<span class="main">,</span> wu<span class="main">,</span> wv<span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms H_face_cycle_succ_G_not_in in_arcs_G not_in_arcs_H
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> G.arev_in_arcs <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> H.face_cycle_succ_closed<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> proj_arcs_eq_swap<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> G_face_cycle_succ <span class="main">=</span> face_cycle_succ_uv face_cycle_succ_vu face_cycle_succ_not_uv

  <span class="keyword1" id="Planar_Subdivision-in_G_fcs_in_H_fcs"><span class="command">lemma</span></span> in_G_fcs_in_H_fcs<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> GM.face_cycle_set <span class="free">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> proj_arcs_H <span class="main">`</span> H.face_cycle_set <span class="main">(</span>proj_arcs_G <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="main">_</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
    <span class="keyword3"><span class="command">case</span></span> base <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rev_image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"proj_arcs_G <span class="free"><span class="free"><span class="free">a</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span>›</span></span> proj_arcs_G_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">b</span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> H.face_cycle_set <span class="main">(</span>proj_arcs_G <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> arcs <span class="free">H</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> H.in_face_cycle_setD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_arcs_G_in_arcs_H<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="main">{</span><span class="free">uv</span><span class="main">,</span>vu<span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="main">{</span><span class="free">uw</span><span class="main">,</span>wu<span class="main">,</span><span class="free">vw</span><span class="main">,</span>wv<span class="main">}</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_H <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> H.in_face_cycle_setD<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"GM.face_cycle_succ <span class="main">(</span>proj_arcs_H <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span>proj_arcs_H <span class="main">(</span>H.face_cycle_succ <span class="skolem">x</span><span class="main">)</span><span class="main">,</span>
          proj_arcs_H <span class="main">(</span>H.face_cycle_succ <span class="main">(</span>H.face_cycle_succ <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">uw</span><span class="main">,</span><span class="free">vw</span><span class="main">,</span>wu<span class="main">,</span>wv<span class="main">}</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G_face_cycle_succ H_face_cycle_succ<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> GM.in_face_cycle_setD GM.face_cycle_set_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∈</span> arcs <span class="free">G</span>›</span></span> step<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> H.face_cycle_succ_inI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subdivision-in_H_fcs_in_G_fcs"><span class="command">lemma</span></span> in_H_fcs_in_G_fcs<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">H</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> H.face_cycle_set <span class="free">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> proj_arcs_H <span class="main">-`</span> GM.face_cycle_set <span class="main">(</span>proj_arcs_H <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="main">_</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
    <span class="keyword3"><span class="command">case</span></span> base <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> arcs <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">H</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> H.in_face_cycle_setD<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> <span class="main">{</span><span class="free">uv</span><span class="main">,</span>vu<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_H<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"proj_arcs_H <span class="main">(</span>H.face_cycle_succ <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> GM.face_cycle_succ <span class="main">(</span>proj_arcs_H <span class="skolem">y</span><span class="main">)</span>
        <span class="main">∨</span> proj_arcs_H <span class="main">(</span>H.face_cycle_succ <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> proj_arcs_H <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">uw</span><span class="main">,</span><span class="free">vw</span><span class="main">,</span>wv<span class="main">,</span>wu<span class="main">}</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H_face_cycle_succ G_face_cycle_succ arcs_G<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> step <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> GM.face_cycle_succ_inI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subdivision-G_fcs_eq"><span class="command">lemma</span></span> G_fcs_eq<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"GM.face_cycle_set <span class="free">a</span> <span class="main">=</span> proj_arcs_H <span class="main">`</span> H.face_cycle_set <span class="main">(</span>proj_arcs_G <span class="free">a</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_H_fcs_in_G_fcs<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> in_G_fcs_in_H_fcs<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_arcs_G_in_arcs_H proj_arcs_HG<span class="main">)</span>

  <span class="keyword1" id="Planar_Subdivision-H_fcs_eq"><span class="command">lemma</span></span> H_fcs_eq<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">H</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"proj_arcs_H <span class="main">`</span> H.face_cycle_set <span class="free">a</span> <span class="main">=</span> GM.face_cycle_set <span class="main">(</span>proj_arcs_H <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_H_fcs_in_G_fcs<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> in_G_fcs_in_H_fcs<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_arcs_H_in_arcs_G fcs_proj_arcs_GH<span class="main">)</span>

  <span class="keyword1" id="Planar_Subdivision-face_cycle_sets"><span class="command">lemma</span></span> face_cycle_sets<span class="main">:</span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"GM.face_cycle_sets <span class="main">=</span> <span class="main">(`)</span> proj_arcs_H <span class="main">`</span> H.face_cycle_sets"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> GM.face_cycle_sets_def H.face_cycle_sets_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> H_fcs_eq G_fcs_eq proj_arcs_G_in_arcs_H proj_arcs_H_in_arcs_G<span class="main">)</span>

  <span class="keyword1" id="Planar_Subdivision-inj_on_proj_arcs_H"><span class="command">lemma</span></span> inj_on_proj_arcs_H<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">(`)</span> proj_arcs_H<span class="main">)</span> H.face_cycle_sets"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="keyword3"><span class="command">assume</span></span> fcs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> H.face_cycle_sets"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> H.face_cycle_sets"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> pa_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"proj_arcs_H <span class="main">`</span> <span class="skolem">A</span> <span class="main">=</span> proj_arcs_H <span class="main">`</span> <span class="skolem">B</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> xw_iff_wy<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> H.face_cycle_sets <span class="main">⟹</span> <span class="free">uw</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">⟷</span> wv <span class="main">∈</span> <span class="bound">X</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> H.face_cycle_sets <span class="main">⟹</span> <span class="free">vw</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">⟷</span> wu <span class="main">∈</span> <span class="bound">X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> H_face_cycle_succ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H.face_cycle_sets_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> H.face_cycle_succ_inI <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> H.face_cycle_succ_inD<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> not_in_A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">uv</span> <span class="main">∉</span> <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"vu <span class="main">∉</span> <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> not_in_B<span class="main">:</span> <span class="quoted"><span class="quoted">"vu <span class="main">∉</span> <span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">uv</span> <span class="main">∉</span> <span class="skolem">B</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> fcs not_in_arcs_H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> H.in_face_cycle_setsD<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> proj_arcs_H <span class="main">-`</span> <span class="main">(</span>proj_arcs_H <span class="main">`</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">uv</span><span class="main">,</span>vu<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subdiv_distinct_arcs not_in_A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_arcs_H_def xw_iff_wy<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fcs<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> proj_arcs_H <span class="main">-`</span> <span class="main">(</span>proj_arcs_H <span class="main">`</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">uv</span><span class="main">,</span>vu<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pa_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subdiv_distinct_arcs not_in_B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_arcs_H_def xw_iff_wy<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fcs<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subdivision-card_face_cycle_sets"><span class="command">lemma</span></span> card_face_cycle_sets<span class="main">:</span> <span class="quoted"><span class="quoted">"card GM.face_cycle_sets <span class="main">=</span> card H.face_cycle_sets"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> face_cycle_sets <span class="keyword1"><span class="command">using</span></span> inj_on_proj_arcs_H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_image<span class="main">)</span>

  <span class="keyword1" id="Planar_Subdivision-euler_char_eq"><span class="command">lemma</span></span> euler_char_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"GM.euler_char <span class="main">=</span> H.euler_char"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> GM.euler_char_def H.euler_char_def card_verts card_arcs card_face_cycle_sets<span class="main">)</span>

  <span class="keyword1" id="Planar_Subdivision-euler_genus_eq"><span class="command">lemma</span></span> euler_genus_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"GM.euler_genus <span class="main">=</span> H.euler_genus"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> GM.euler_genus_def H.euler_genus_def euler_char_eq card_sccs_eq isolated_verts_eq<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Planar_Subdivision-subdivision_genus_same_rev"><span class="command">lemma</span></span> subdivision_genus_same_rev<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subdivision <span class="main">(</span><span class="free">G</span><span class="main">,</span> <span class="free">rev_G</span><span class="main">)</span> <span class="main">(</span><span class="free">H</span><span class="main">,</span> edge_rev <span class="free">HM</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"digraph_map <span class="free">H</span> <span class="free">HM</span>"</span></span> <span class="quoted"><span class="quoted">"pre_digraph_map.euler_genus <span class="free">H</span> <span class="free">HM</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">GM</span><span class="main">.</span> digraph_map <span class="free">G</span> <span class="bound">GM</span> <span class="main">∧</span> pre_digraph_map.euler_genus <span class="free">G</span> <span class="bound">GM</span> <span class="main">=</span> <span class="free">m</span> <span class="main">∧</span> edge_rev <span class="bound">GM</span> <span class="main">=</span> <span class="free">rev_G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="skolem">rev_H</span><span class="main"><span class="main">≡</span></span><span class="quoted"><span class="quoted">"edge_rev <span class="free">HM</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">HM</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> base <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>divide <span class="skolem">I</span> <span class="skolem">rev_I</span> <span class="skolem">H</span> <span class="skolem">u</span> <span class="skolem">v</span> <span class="skolem">w</span> <span class="skolem">uv</span> <span class="skolem">uw</span> <span class="skolem">vw</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> subdiv_step <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="skolem">rev_I</span></span> <span class="quoted"><span class="skolem">H</span></span> <span class="quoted"><span class="quoted">"edge_rev <span class="skolem">HM</span>"</span></span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="skolem">uv</span></span> <span class="quoted"><span class="skolem">uw</span></span> <span class="quoted"><span class="skolem">vw</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">interpret</span></span> H<span class="main">:</span> digraph_map <span class="quoted"><span class="skolem">H</span></span> <span class="quoted"><span class="skolem">HM</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹digraph_map <span class="skolem">H</span> <span class="skolem">HM</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">interpret</span></span> IH<span class="main">:</span> subdiv1_contr <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="skolem">rev_I</span></span> <span class="quoted"><span class="skolem">H</span></span> <span class="quoted"><span class="quoted">"edge_rev <span class="skolem">HM</span>"</span></span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="skolem">uv</span></span> <span class="quoted"><span class="skolem">uw</span></span> <span class="quoted"><span class="skolem">vw</span></span> <span class="quoted"><span class="skolem">HM</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> eulerI<span class="main">:</span> <span class="quoted"><span class="quoted">"IH.GM.euler_genus <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IH.euler_genus_eq divide<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> _ IH.digraph_map_GM <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> divide<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IH.edge_rev_GM<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Planar_Subdivision-subdivision_genus"><span class="command">lemma</span></span> subdivision_genus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subdivision <span class="main">(</span><span class="free">G</span><span class="main">,</span> <span class="free">rev_G</span><span class="main">)</span> <span class="main">(</span><span class="free">H</span><span class="main">,</span> <span class="free">rev_H</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"digraph_map <span class="free">H</span> <span class="free">HM</span>"</span></span> <span class="quoted"><span class="quoted">"pre_digraph_map.euler_genus <span class="free">H</span> <span class="free">HM</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">GM</span><span class="main">.</span> digraph_map <span class="free">G</span> <span class="bound">GM</span> <span class="main">∧</span> pre_digraph_map.euler_genus <span class="free">G</span> <span class="bound">GM</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> H<span class="main">:</span> digraph_map <span class="quoted"><span class="free">H</span></span> <span class="quoted"><span class="free">HM</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> subdivision_genus_same_rev subdivision_choose_rev assms H.bidirected_digraph <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Planar_Subdivision-subdivision_comb_planar"><span class="command">lemma</span></span> subdivision_comb_planar<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subdivision <span class="main">(</span><span class="free">G</span><span class="main">,</span> <span class="free">rev_G</span><span class="main">)</span> <span class="main">(</span><span class="free">H</span><span class="main">,</span> <span class="free">rev_H</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"comb_planar <span class="free">H</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"comb_planar <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> comb_planar_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subdivision_genus<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Planar_Subgraph">
<div class="head">
<h1>Theory Planar_Subgraph</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Planar_Subgraph
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Graph_Genus">Graph_Genus</a>
  <a href="#Permutations_2">Permutations_2</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/FuncSet.html">HOL-Library.FuncSet</a>"</span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Simps_Case_Conv.html">HOL-Library.Simps_Case_Conv</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Combinatorial Planarity and Subgraphs›</span></span>

<span class="keyword1" id="Planar_Subgraph-out_arcs_emptyD_dominates"><span class="command">lemma</span></span> out_arcs_emptyD_dominates<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"out_arcs <span class="free">G</span> <span class="free">x</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">x</span> <span class="main">→</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> out_arcs_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> wf_digraph<span class="main">)</span> reachable_refl_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">u</span> <span class="main">⟷</span> <span class="free">u</span> <span class="main">∈</span> verts <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> reachable_in_verts<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> digraph_map <span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Planar_Subgraph-face_cycle_set_succ"><span class="command">lemma</span></span> face_cycle_set_succ<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"face_cycle_set <span class="main">(</span>face_cycle_succ <span class="free">a</span><span class="main">)</span> <span class="main">=</span> face_cycle_set <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> face_cycle_eq face_cycle_set_self face_cycle_succ_inD<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-face_cycle_succ_funpow_in"><span class="command">lemma</span></span> face_cycle_succ_funpow_in<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>face_cycle_succ <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1" id="Planar_Subgraph-segment_face_cycle_x_x_eq"><span class="command">lemma</span></span> segment_face_cycle_x_x_eq<span class="main">:</span>
    <span class="quoted"><span class="quoted">"segment face_cycle_succ <span class="free">x</span> <span class="free">x</span> <span class="main">=</span> face_cycle_set <span class="free">x</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> face_cycle_set_def <span class="keyword1"><span class="command">using</span></span> face_cycle_succ_permutes finite_arcs permutation_permutes
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> segment_x_x_eq<span class="main">)</span> <span class="operator">blast</span>

  <span class="keyword1" id="Planar_Subgraph-fcs_x_eq_x"><span class="command">lemma</span></span> fcs_x_eq_x<span class="main">:</span> <span class="quoted"><span class="quoted">"face_cycle_succ <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟷</span> face_cycle_set <span class="free">x</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> face_cycle_set_def orbit_eq_singleton_iff <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> bidirected_digraph<span class="main">)</span> bidirected_digraph_del_arc<span class="main">:</span>
    <span class="quoted"><span class="quoted">"bidirected_digraph <span class="main">(</span>pre_digraph.del_arc <span class="main">(</span>pre_digraph.del_arc <span class="free">G</span> <span class="main">(</span><span class="free">arev</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>perm_restrict <span class="free">arev</span> <span class="main">(</span>arcs <span class="free">G</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span> <span class="main">,</span> <span class="free">arev</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> arcs <span class="main">(</span>pre_digraph.del_arc <span class="main">(</span>del_arc <span class="main">(</span><span class="free">arev</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">arev</span> <span class="skolem">b</span> <span class="main">≠</span> <span class="skolem">b</span> <span class="main">⟹</span> <span class="skolem">b</span> <span class="main">≠</span> <span class="free">arev</span> <span class="free">a</span> <span class="main">⟹</span> <span class="skolem">b</span> <span class="main">≠</span> <span class="free">a</span> <span class="main">⟹</span> perm_restrict <span class="free">arev</span> <span class="main">(</span>arcs <span class="free">G</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span> <span class="free">arev</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">arev</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bij_arev arev_dom <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> perm_restrict_simps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"perm_restrict <span class="free">arev</span> <span class="main">(</span>arcs <span class="free">G</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span> <span class="free">arev</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>perm_restrict <span class="free">arev</span> <span class="main">(</span>arcs <span class="free">G</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span> <span class="free">arev</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_digraph.del_arc_simps perm_restrict_simps arev_dom<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_digraph.del_arc_simps perm_restrict_simps arev_dom<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> bidirected_digraph<span class="main">)</span> bidirected_digraph_del_vert<span class="main">:</span> <span class="quoted"><span class="quoted">"bidirected_digraph <span class="main">(</span>del_vert <span class="free">u</span><span class="main">)</span> <span class="main">(</span>perm_restrict <span class="free">arev</span> <span class="main">(</span>arcs <span class="main">(</span>del_vert <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> del_vert_simps perm_restrict_simps arev_dom<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pre_digraph<span class="main">)</span> ends_del_arc<span class="main">:</span> <span class="quoted"><span class="quoted">"arc_to_ends <span class="main">(</span>del_arc <span class="free">u</span><span class="main">)</span> <span class="main">=</span> arc_to_ends <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> arc_to_ends_def fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pre_digraph<span class="main">)</span> dominates_arcsD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">→</span><span class="hidden">⇘</span><sub>del_arc <span class="free">u</span></sub><span class="hidden">⇙</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">→</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_ends_def ends_del_arc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> wf_digraph<span class="main">)</span> reachable_del_arcD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub>del_arc <span class="free">u</span></sub><span class="hidden">⇙</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> H<span class="main">:</span> wf_digraph <span class="quoted"><span class="quoted">"del_arc <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_digraph_del_arc<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dominates_arcsD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> adj_reachable_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> fin_digraph<span class="main">)</span> finite_isolated_verts<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite isolated_verts"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> isolated_verts_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> wf_digraph<span class="main">)</span> isolated_verts_in_sccs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> isolated_verts"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">∈</span> sccs_verts"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span>
    <span class="keyword1"><span class="command">using</span></span> that assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_ends_def arc_to_ends_def isolated_verts_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sccs_verts_def isolated_verts_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> digraph_map<span class="main">)</span> in_face_cycle_sets<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span> <span class="main">⟹</span> face_cycle_set <span class="free">a</span> <span class="main">∈</span> face_cycle_sets"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> face_cycle_sets_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> digraph_map<span class="main">)</span> heads_face_cycle_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="main">`</span> face_cycle_set <span class="free">a</span> <span class="main">=</span> tail <span class="free">G</span> <span class="main">`</span> face_cycle_set <span class="free">a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> set_eqI iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> face_cycle_set <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"face_cycle_succ <span class="skolem">b</span> <span class="main">∈</span> face_cycle_set <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="main">(</span>face_cycle_succ <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tail_face_cycle_succ face_cycle_succ_inI in_face_cycle_setD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> face_cycle_set <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> face_cycle_succ <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> face_cycle_succ_pred<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> face_cycle_set <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="skolem">c</span> <span class="main">=</span> <span class="skolem">u</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> face_cycle_succ_inD<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> assms face_cycle_succ_no_arc in_face_cycle_setD tail_face_cycle_succ<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pre_digraph<span class="main">)</span> casI_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> tail <span class="free">G</span> <span class="main">(</span>hd <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> head <span class="free">G</span> <span class="main">(</span>last <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">p</span> <span class="main">⟹</span> head <span class="free">G</span> <span class="main">(</span><span class="free">p</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> tail <span class="free">G</span> <span class="main">(</span><span class="free">p</span> <span class="main">!</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cas <span class="free">u</span> <span class="free">p</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cas <span class="main">(</span>head <span class="free">G</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">p</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>1-3<span class="main">)</span> Cons.prems<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> Cons.prems<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">i</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Cons<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> digraph_map<span class="main">)</span> obtain_trail_in_fcs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a0</span> <span class="main">∈</span> face_cycle_set <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">an</span> <span class="main">∈</span> face_cycle_set <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">p</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"trail <span class="main">(</span>tail <span class="free">G</span> <span class="free">a0</span><span class="main">)</span> <span class="free">p</span> <span class="main">(</span>head <span class="free">G</span> <span class="free">an</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">p</span> <span class="main">=</span> <span class="free">a0</span>"</span></span>  <span class="quoted"><span class="quoted">"last <span class="free">p</span> <span class="main">=</span> <span class="free">an</span>"</span></span>
    <span class="quoted"><span class="quoted">"set <span class="free">p</span> <span class="main">⊆</span> face_cycle_set <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> fcs_a<span class="main">:</span> <span class="quoted"><span class="quoted">"face_cycle_set <span class="free">a</span> <span class="main">=</span> orbit face_cycle_succ <span class="free">a0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms face_cycle_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> face_cycle_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a0</span> <span class="main">=</span> <span class="main">(</span>face_cycle_succ <span class="main">^^</span> <span class="main">0</span><span class="main">)</span> <span class="free">a0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">an</span> <span class="main">=</span> <span class="main">(</span>face_cycle_succ <span class="main">^^</span> funpow_dist face_cycle_succ <span class="free">a0</span> <span class="free">an</span><span class="main">)</span> <span class="free">a0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fcs_a funpow_dist_prop<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>face_cycle_succ <span class="main">^^</span> <span class="bound">n</span><span class="main">)</span> <span class="free">a0</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>funpow_dist face_cycle_succ <span class="free">a0</span> <span class="free">an</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> p_nth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">p</span> <span class="main">⟹</span> <span class="skolem">p</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">(</span>face_cycle_succ <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> <span class="free">a0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> P2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> P3<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">p</span> <span class="main">=</span> <span class="free">a0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a0</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p_def hd_map <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> P4<span class="main">:</span> <span class="quoted"><span class="quoted">"last <span class="skolem">p</span> <span class="main">=</span> <span class="free">an</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">an</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> P5<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">p</span> <span class="main">⊆</span> face_cycle_set <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> p_def fcs_a orbit_altdef_permutation<span class="main">[</span><span class="operator">OF</span> permutation_face_cycle_succ<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> P1<span class="main">:</span> <span class="quoted"><span class="quoted">"trail <span class="main">(</span>tail <span class="free">G</span> <span class="free">a0</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">(</span>head <span class="free">G</span> <span class="free">an</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">an</span> <span class="main">∈</span> orbit face_cycle_succ <span class="free">a0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fcs_a<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>face_cycle_succ <span class="main">^^</span> <span class="bound">n</span><span class="main">)</span> <span class="free">a0</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>funpow_dist face_cycle_succ <span class="free">a0</span> <span class="free">an</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inj_on_funpow_dist<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..</span>funpow_dist face_cycle_succ <span class="free">a0</span> <span class="free">an</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span>set <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>funpow_dist face_cycle_succ <span class="free">a0</span> <span class="free">an</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>face_cycle_succ <span class="main">^^</span> <span class="bound">n</span><span class="main">)</span> <span class="free">a0</span><span class="main">)</span> <span class="main">(</span>set <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>funpow_dist face_cycle_succ <span class="free">a0</span> <span class="free">an</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_map p_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a0</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> in_face_cycle_setD<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="free">a0</span> <span class="main">∈</span> verts <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">p</span> <span class="main">⊆</span> arcs <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P5
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> in_face_cycle_setD subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">p</span> <span class="main">⟹</span> <span class="skolem">p</span> <span class="main">!</span> Suc <span class="bound">i</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">p</span> <span class="main">⟹</span> head <span class="free">G</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> tail <span class="free">G</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">!</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p_nth tail_face_cycle_succ<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> P2 P3 P4 <span class="keyword1"><span class="command">unfolding</span></span> trail_def awalk_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> casI_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> P1 P2 P3 P4 P5 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> digraph_map<span class="main">)</span> obtain_trail_in_fcs'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> tail <span class="free">G</span> <span class="main">`</span> face_cycle_set <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> tail <span class="free">G</span> <span class="main">`</span> face_cycle_set <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">p</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"trail <span class="free">u</span> <span class="free">p</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">p</span> <span class="main">⊆</span> face_cycle_set <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="skolem">a0</span> <span class="main">=</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a0</span> <span class="main">∈</span> face_cycle_set <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">an</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="skolem">an</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">an</span> <span class="main">∈</span> face_cycle_set <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> heads_face_cycle_set<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"trail <span class="free">u</span> <span class="skolem">p</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">p</span> <span class="main">⊆</span> face_cycle_set <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> obtain_trail_in_fcs<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>




<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Deleting an isolated vertex›</span></span>

<span class="keyword1"><span class="command">locale</span></span> del_vert_props <span class="main">=</span> digraph_map <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">u</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> u_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> verts <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> u_isolated<span class="main">:</span> <span class="quoted"><span class="quoted">"out_arcs <span class="free">G</span> <span class="free">u</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Planar_Subgraph-u_isolated_in"><span class="command">lemma</span></span> u_isolated_in<span class="main">:</span> <span class="quoted"><span class="quoted">"in_arcs <span class="free">G</span> <span class="free">u</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> u_isolated <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_arcs_eq<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-arcs_dv"><span class="command">lemma</span></span> arcs_dv<span class="main">:</span> <span class="quoted"><span class="quoted">"arcs <span class="main">(</span>del_vert <span class="free">u</span><span class="main">)</span> <span class="main">=</span> arcs <span class="free">G</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> u_isolated u_isolated_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> del_vert_simps<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-out_arcs_dv"><span class="command">lemma</span></span> out_arcs_dv<span class="main">:</span> <span class="quoted"><span class="quoted">"out_arcs <span class="main">(</span>del_vert <span class="free">u</span><span class="main">)</span> <span class="main">=</span> out_arcs <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff arcs_dv tail_del_vert<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-digraph_map_del_vert"><span class="command">lemma</span></span> digraph_map_del_vert<span class="main">:</span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"digraph_map <span class="main">(</span>del_vert <span class="free">u</span><span class="main">)</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"perm_restrict <span class="main">(</span>edge_rev <span class="free">M</span><span class="main">)</span> <span class="main">(</span>arcs <span class="main">(</span>del_vert <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> edge_rev <span class="free">M</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> has_dom_arev arcs_dv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> perm_restrict_dom_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> H<span class="main">:</span> bidirected_digraph <span class="quoted"><span class="quoted">"del_vert <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"edge_rev <span class="free">M</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bidirected_digraph_del_vert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_dv edge_succ_permutes out_arcs_dv edge_succ_cyclic verts_del_vert<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> del_vert_props <span class="main">⊆</span> H<span class="main">:</span> digraph_map <span class="quoted"><span class="quoted">"del_vert <span class="free">u</span>"</span></span> <span class="quoted"><span class="free">M</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> digraph_map_del_vert<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> del_vert_props <span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Planar_Subgraph-card_verts_dv"><span class="command">lemma</span></span> card_verts_dv<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>verts <span class="free">G</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>card <span class="main">(</span>verts <span class="main">(</span>del_vert <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> verts_del_vert<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> card.remove<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> u_in<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-card_arcs_dv"><span class="command">lemma</span></span> card_arcs_dv<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>arcs <span class="main">(</span>del_vert <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>arcs <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> u_isolated <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> arcs_dv in_arcs_eq<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-isolated_verts_dv"><span class="command">lemma</span></span> isolated_verts_dv<span class="main">:</span> <span class="quoted"><span class="quoted">"H.isolated_verts <span class="main">=</span> isolated_verts <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> isolated_verts_def H.isolated_verts_def verts_del_vert out_arcs_dv<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-u_in_isolated_verts"><span class="command">lemma</span></span> u_in_isolated_verts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> isolated_verts"</span></span>
    <span class="keyword1"><span class="command">using</span></span> u_in u_isolated <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> isolated_verts_def<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-card_isolated_verts_dv"><span class="command">lemma</span></span> card_isolated_verts_dv<span class="main">:</span> <span class="quoted"><span class="quoted">"card isolated_verts <span class="main">=</span> Suc <span class="main">(</span>card H.isolated_verts<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> isolated_verts_dv<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> card.remove<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> u_in_isolated_verts<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-face_cycles_dv"><span class="command">lemma</span></span> face_cycles_dv<span class="main">:</span> <span class="quoted"><span class="quoted">"H.face_cycle_sets <span class="main">=</span> face_cycle_sets"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> H.face_cycle_sets_def face_cycle_sets_def arcs_dv <span class="keyword1"><span class="command">..</span></span>

  <span class="keyword1" id="Planar_Subgraph-euler_char_dv"><span class="command">lemma</span></span> euler_char_dv<span class="main">:</span> <span class="quoted"><span class="quoted">"euler_char <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> H.euler_char"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> euler_char_def H.euler_char_def card_arcs_dv card_verts_dv face_cycles_dv<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-adj_dv"><span class="command">lemma</span></span> adj_dv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">→</span><span class="hidden">⇘</span><sub>del_vert <span class="free">u</span></sub><span class="hidden">⇙</span> <span class="free">w</span> <span class="main">⟷</span> <span class="free">v</span> <span class="main">→</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_ends_def arcs_dv ends_del_vert<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-reachable_del_vertD"><span class="command">lemma</span></span> reachable_del_vertD<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub>del_vert <span class="free">u</span></sub><span class="hidden">⇙</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> verts_del_vert adj_dv <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> adj_reachable_trans<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-reachable_del_vertI"><span class="command">lemma</span></span> reachable_del_vertI<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="free">v</span> <span class="main">∨</span> <span class="free">u</span> <span class="main">≠</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub>del_vert <span class="free">u</span></sub><span class="hidden">⇙</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">→</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="skolem">y</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> in_arcs <span class="free">G</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> u_isolated in_arcs_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> step <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> adj_dv <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> H.adj_reachable_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> verts_del_vert<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-G_reach_conv"><span class="command">lemma</span></span> G_reach_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="free">w</span> <span class="main">⟷</span> <span class="free">v</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub>del_vert <span class="free">u</span></sub><span class="hidden">⇙</span> <span class="free">w</span> <span class="main">∨</span> <span class="main">(</span><span class="free">v</span> <span class="main">=</span> <span class="free">u</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">=</span> <span class="free">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> reachable_del_vertI reachable_del_vertD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> u_in<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-sccs_verts_dv"><span class="command">lemma</span></span> sccs_verts_dv<span class="main">:</span> <span class="quoted"><span class="quoted">"H.sccs_verts <span class="main">=</span> sccs_verts <span class="main">-</span> <span class="main">{</span><span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">S</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">S</span> <span class="main">∈</span> sccs_verts <span class="main">⟹</span> <span class="bound">S</span> <span class="main">∉</span> H.sccs_verts  <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">S</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> H.in_sccs_verts_conv_reachable in_sccs_verts_conv_reachable G_reach_conv<span class="main">)</span>
        <span class="main">(</span><span class="operator">meson</span> H.reachable_trans<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H.in_sccs_verts_conv_reachable in_sccs_verts_conv_reachable
        G_reach_conv H.reachable_refl_iff verts_del_vert<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-card_sccs_verts_dv"><span class="command">lemma</span></span> card_sccs_verts_dv<span class="main">:</span> <span class="quoted"><span class="quoted">"card sccs_verts <span class="main">=</span> Suc <span class="main">(</span>card H.sccs_verts<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sccs_verts_dv
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card.remove<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> isolated_verts_in_sccs u_in_isolated_verts finite_sccs_verts<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-card_sccs_dv"><span class="command">lemma</span></span> card_sccs_dv<span class="main">:</span> <span class="quoted"><span class="quoted">"card sccs <span class="main">=</span> Suc <span class="main">(</span>card H.sccs<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_sccs_verts_dv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_sccs_verts H.card_sccs_verts<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-euler_genus_eq"><span class="command">lemma</span></span> euler_genus_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"H.euler_genus <span class="main">=</span> euler_genus"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_digraph_map.euler_genus_def card_sccs_dv card_isolated_verts_dv euler_char_dv<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Deleting an arc pair›</span></span>

<span class="keyword1"><span class="command">locale</span></span> bidel_arc <span class="main">=</span> G<span class="main">:</span> digraph_map <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">a'</span> <span class="main">≡</span> edge_rev <span class="free">M</span> <span class="free">a</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">H</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> pre_digraph"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">≡</span> pre_digraph.del_arc <span class="main">(</span>pre_digraph.del_arc <span class="free">G</span> a'<span class="main">)</span> <span class="free">a</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">HM</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> pre_map"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">HM</span> <span class="main">=</span> 
      <span class="main">⦇</span> edge_rev <span class="main">=</span> perm_restrict <span class="main">(</span>edge_rev <span class="free">M</span><span class="main">)</span> <span class="main">(</span>arcs <span class="free">G</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span> a'<span class="main">}</span><span class="main">)</span>
      <span class="main">,</span> edge_succ <span class="main">=</span> perm_rem <span class="free">a</span> <span class="main">(</span>perm_rem a' <span class="main">(</span>edge_succ <span class="free">M</span><span class="main">)</span><span class="main">)</span>
      <span class="main">⦈</span>"</span></span>

  <span class="keyword1" id="Planar_Subgraph-verts_H"><span class="command">lemma</span></span>
    verts_H<span class="main">:</span> <span class="quoted"><span class="quoted">"verts H <span class="main">=</span> verts <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    arcs_H<span class="main">:</span>  <span class="quoted"><span class="quoted">"arcs H <span class="main">=</span> arcs <span class="free">G</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span> a'<span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    tail_H<span class="main">:</span> <span class="quoted"><span class="quoted">"tail H <span class="main">=</span> tail <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    head_H<span class="main">:</span> <span class="quoted"><span class="quoted">"head H <span class="main">=</span> head <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ends_H<span class="main">:</span> <span class="quoted"><span class="quoted">"arc_to_ends H <span class="main">=</span> arc_to_ends <span class="free">G</span>"</span></span><span class="keyword2"><span class="keyword">and</span></span>
    arcs_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">,</span>a'<span class="main">}</span> <span class="main">⊆</span> arcs <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ends_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">,</span> head <span class="free">G</span> <span class="free">a</span><span class="main">}</span> <span class="main">⊆</span> verts <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H_def pre_digraph.del_arc_simps a_in arc_to_ends_def<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-cyclic_on_edge_succ"><span class="command">lemma</span></span> cyclic_on_edge_succ<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> verts H"</span></span> <span class="quoted"><span class="quoted">"out_arcs H <span class="free">x</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cyclic_on <span class="main">(</span>edge_succ HM<span class="main">)</span> <span class="main">(</span>out_arcs H <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> oa_H<span class="main">:</span> <span class="quoted"><span class="quoted">"out_arcs H <span class="free">x</span> <span class="main">=</span> <span class="main">(</span>out_arcs <span class="free">G</span> <span class="free">x</span> <span class="main">-</span> <span class="main">{</span>a'<span class="main">}</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_H tail_H<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cyclic_on <span class="main">(</span>perm_rem <span class="free">a</span> <span class="main">(</span>perm_rem a' <span class="main">(</span>edge_succ <span class="free">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>out_arcs <span class="free">G</span> <span class="free">x</span> <span class="main">-</span> <span class="main">{</span>a'<span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cyclic_on_perm_rem G.edge_succ_cyclic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> oa_H G.bij_edge_succ G.edge_succ_cyclic<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HM_def oa_H<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-digraph_map"><span class="command">lemma</span></span> digraph_map<span class="main">:</span> <span class="quoted"><span class="quoted">"digraph_map H HM"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">interpret</span></span> fin_digraph <span class="quoted">H</span> <span class="keyword1"><span class="command">unfolding</span></span> H_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fin_digraph.fin_digraph_del_arc<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> G.fin_digraph_del_arc<span class="main">)</span>
    <span class="keyword1"><span class="command">interpret</span></span> bidirected_digraph <span class="quoted">H</span> <span class="quoted"><span class="quoted">"edge_rev HM"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> H_def
      <span class="keyword1"><span class="command">using</span></span> G.bidirected_digraph_del_arc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HM_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"insert a' <span class="main">(</span>insert <span class="free">a</span> <span class="main">(</span>arcs H<span class="main">)</span><span class="main">)</span> <span class="main">=</span> arcs <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_H<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"edge_succ HM <span class="keyword1">permutes</span> arcs H"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> HM_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> * <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> perm_rem_permutes G.edge_succ_permutes<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> verts H"</span></span> <span class="quoted"><span class="quoted">"out_arcs H <span class="skolem">v</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cyclic_on <span class="main">(</span>edge_succ HM<span class="main">)</span> <span class="main">(</span>out_arcs H <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cyclic_on_edge_succ<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-rev_H"><span class="command">lemma</span></span> rev_H<span class="main">:</span> <span class="quoted"><span class="quoted">"bidel_arc.H <span class="free">G</span> <span class="free">M</span> a' <span class="main">=</span> H"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?t1</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> rev_HM<span class="main">:</span> <span class="quoted"><span class="quoted">"bidel_arc.HM <span class="free">G</span> <span class="free">M</span> a' <span class="main">=</span> HM"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?t2</span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">interpret</span></span> rev<span class="main">:</span> bidel_arc <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quoted">a'</span> <span class="keyword1"><span class="command">using</span></span> a_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?t1</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pre_digraph.equality<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rev.verts_H verts_H rev.arcs_H arcs_H
        rev.tail_H tail_H rev.head_H head_H<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?t2</span></span></span> <span class="keyword1"><span class="command">using</span></span> G.edge_succ_permutes
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pre_map.equality<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HM_def rev.HM_def insert_commute
        perm_rem_commutes permutes_conv_has_dom<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> bidel_arc <span class="main">⊆</span> H<span class="main">:</span> digraph_map <span class="quoted">H</span> <span class="quoted">HM</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> digraph_map<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> bidel_arc <span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Planar_Subgraph-a_neq_a'"><span class="command">lemma</span></span> a_neq_a'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> a'"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> G.arev_neq a_in<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-arcs_G"><span class="command">lemma</span></span>
    arcs_G<span class="main">:</span> <span class="quoted"><span class="quoted">"arcs <span class="free">G</span> <span class="main">=</span> insert <span class="free">a</span> <span class="main">(</span>insert a' <span class="main">(</span>arcs H<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    arcs_not_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">,</span>a'<span class="main">}</span> <span class="main">∩</span> arcs H <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> arcs_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_H<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-card_arcs_da"><span class="command">lemma</span></span> card_arcs_da<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>arcs <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">+</span> card <span class="main">(</span>arcs H<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> arcs_G arcs_not_in a_neq_a' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_insert_if<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-cas_da"><span class="command">lemma</span></span> cas_da<span class="main">:</span> <span class="quoted"><span class="quoted">"H.cas <span class="main">=</span> G.cas"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">p</span> <span class="skolem">v</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"H.cas <span class="skolem">u</span> <span class="skolem">p</span> <span class="skolem">v</span> <span class="main">=</span> G.cas <span class="skolem">u</span> <span class="skolem">p</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tail_H head_H<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-reachable_daD"><span class="command">lemma</span></span> reachable_daD<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub>H</sub><span class="hidden">⇙</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> G.reachable_del_arcD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_digraph.reachable_del_arcD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> G.wf_digraph_del_arc<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> H_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>

  <span class="keyword1" id="Planar_Subgraph-not_G_isolated_a"><span class="command">lemma</span></span> not_G_isolated_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">,</span> head <span class="free">G</span> <span class="free">a</span><span class="main">}</span> <span class="main">∩</span> G.isolated_verts <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a_in G.in_arcs_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="free">a</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.isolated_verts_def<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-isolated_other_da"><span class="command">lemma</span></span> isolated_other_da<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∉</span> <span class="main">{</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">,</span> head <span class="free">G</span> <span class="free">a</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> H.isolated_verts <span class="main">⟷</span> <span class="free">u</span> <span class="main">∈</span> G.isolated_verts"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_digraph.isolated_verts_def verts_H arcs_H tail_H out_arcs_def<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-isolated_da_pre"><span class="command">lemma</span></span> isolated_da_pre<span class="main">:</span> <span class="quoted"><span class="quoted">"H.isolated_verts <span class="main">=</span> G.isolated_verts <span class="main">∪</span>
      <span class="main">(</span><span class="keyword1">if</span> tail <span class="free">G</span> <span class="free">a</span> <span class="main">∈</span> H.isolated_verts <span class="keyword1">then</span> <span class="main">{</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∪</span>
      <span class="main">(</span><span class="keyword1">if</span> head <span class="free">G</span> <span class="free">a</span> <span class="main">∈</span> H.isolated_verts <span class="keyword1">then</span> <span class="main">{</span>head <span class="free">G</span> <span class="free">a</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> set_eqI iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">,</span> head <span class="free">G</span> <span class="free">a</span><span class="main">}</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>isolated_other_da<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_G_isolated_a
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">,</span> head <span class="free">G</span> <span class="free">a</span><span class="main">}</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>isolated_other_da <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-card_isolated_verts_da0"><span class="command">lemma</span></span> card_isolated_verts_da0<span class="main">:</span>
    <span class="quoted"><span class="quoted">"card H.isolated_verts <span class="main">=</span> card G.isolated_verts <span class="main">+</span> card <span class="main">(</span><span class="main">{</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">,</span> head <span class="free">G</span> <span class="free">a</span><span class="main">}</span> <span class="main">∩</span> H.isolated_verts<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_G_isolated_a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> isolated_da_pre<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_insert_if G.finite_isolated_verts<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-segments_neq"><span class="command">lemma</span></span> segments_neq<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"segment G.face_cycle_succ a' <span class="free">a</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∨</span> segment G.face_cycle_succ <span class="free">a</span> a' <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"segment G.face_cycle_succ <span class="free">a</span> a' <span class="main">≠</span> segment G.face_cycle_succ a' <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> bij_fcs<span class="main">:</span> <span class="quoted"><span class="quoted">"bij G.face_cycle_succ"</span></span>
      <span class="keyword1"><span class="command">using</span></span> G.face_cycle_succ_permutes <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutes_conv_has_dom<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> segment_disj<span class="main">[</span><span class="operator">OF</span> a_neq_a' bij_fcs<span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-H_fcs_eq_G_fcs"><span class="command">lemma</span></span> H_fcs_eq_G_fcs<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">b</span><span class="main">,</span>G.face_cycle_succ <span class="free">b</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span>a'<span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"H.face_cycle_succ <span class="free">b</span> <span class="main">=</span> G.face_cycle_succ <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"edge_rev <span class="free">M</span> <span class="free">b</span> <span class="main">∉</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span>a'<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> G.arev_arev<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> G.face_cycle_succ_def H.face_cycle_succ_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HM_def perm_restrict_simps perm_rem_simps G.bij_edge_succ<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-face_cycle_set_other_da"><span class="command">lemma</span></span> face_cycle_set_other_da<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">,</span> a'<span class="main">}</span> <span class="main">∩</span> G.face_cycle_set <span class="free">b</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"H.face_cycle_set <span class="free">b</span> <span class="main">=</span> G.face_cycle_set <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> G.face_cycle_set <span class="free">b</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈</span> arcs <span class="free">G</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∉</span> G.face_cycle_set <span class="free">b</span> <span class="main">⟹</span> a' <span class="main">∉</span> G.face_cycle_set <span class="free">b</span>
        <span class="main">⟹</span> pre_digraph_map.face_cycle_succ HM <span class="bound">s</span> <span class="main">=</span> G.face_cycle_succ <span class="bound">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> H_fcs_eq_G_fcs<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.in_face_cycle_setD G.face_cycle_succ_inI<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> pre_digraph_map.face_cycle_set_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> orbit_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pre_digraph_map.face_cycle_set_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-in_face_cycle_set_other"><span class="command">lemma</span></span> in_face_cycle_set_other<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∈</span> G.face_cycle_sets"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">,</span> a'<span class="main">}</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∈</span> H.face_cycle_sets"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> G.face_cycle_set <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.face_cycle_sets_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> H.face_cycle_set <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> face_cycle_set_other_da<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> arcs H"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∈</span> arcs <span class="free">G</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_H<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H.face_cycle_sets_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-H_fcs_in_G_fcs"><span class="command">lemma</span></span> H_fcs_in_G_fcs<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> arcs H <span class="main">-</span> <span class="main">(</span>G.face_cycle_set <span class="free">a</span> <span class="main">∪</span> G.face_cycle_set a'<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"H.face_cycle_set <span class="free">b</span> <span class="main">∈</span> G.face_cycle_sets <span class="main">-</span> <span class="main">{</span>G.face_cycle_set <span class="free">a</span><span class="main">,</span> G.face_cycle_set a'<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"H.face_cycle_set <span class="free">b</span> <span class="main">=</span> G.face_cycle_set <span class="free">b</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> face_cycle_set_other_da<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_H G.face_cycle_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"G.face_cycle_set <span class="free">b</span> <span class="main">∉</span> <span class="main">{</span>G.face_cycle_set <span class="free">a</span><span class="main">,</span> G.face_cycle_set a'<span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> G.face_cycle_eq assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_H<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.face_cycle_sets_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-face_cycle_sets_da0"><span class="command">lemma</span></span> face_cycle_sets_da0<span class="main">:</span>
    <span class="quoted"><span class="quoted">"H.face_cycle_sets <span class="main">=</span> G.face_cycle_sets <span class="main">-</span> <span class="main">{</span>G.face_cycle_set <span class="free">a</span><span class="main">,</span> G.face_cycle_set a'<span class="main">}</span>
      <span class="main">∪</span> H.face_cycle_set <span class="main">`</span> <span class="main">(</span><span class="main">(</span>G.face_cycle_set <span class="free">a</span> <span class="main">∪</span> G.face_cycle_set a'<span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span>a'<span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> set_eqI iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> H.face_cycle_set <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> arcs H"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H.face_cycle_sets_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> arcs_not_in H_fcs_in_G_fcs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> G.face_cycle_set <span class="free">a</span> <span class="main">∪</span> G.face_cycle_set a'"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> G.face_cycle_sets <span class="main">-</span> <span class="main">{</span>G.face_cycle_set <span class="free">a</span><span class="main">,</span> G.face_cycle_set a'<span class="main">}</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∩</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span>a'<span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> G.face_cycle_set_parts <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.face_cycle_sets_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> in_face_cycle_set_other<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> H.face_cycle_set <span class="main">`</span> <span class="main">(</span><span class="main">(</span>G.face_cycle_set <span class="free">a</span> <span class="main">∪</span> G.face_cycle_set a'<span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span>a'<span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">∈</span> <span class="var">?R</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>G.face_cycle_set <span class="free">a</span> <span class="main">∪</span> G.face_cycle_set a'<span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span>a'<span class="main">}</span> <span class="main">⊆</span> arcs H"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_H <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> G.in_face_cycle_setD<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H.face_cycle_sets_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
    
  <span class="keyword1" id="Planar_Subgraph-card_fcs_aa'_le"><span class="command">lemma</span></span> card_fcs_aa'_le<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span>G.face_cycle_set <span class="free">a</span><span class="main">,</span> G.face_cycle_set a'<span class="main">}</span> <span class="main">≤</span> card G.face_cycle_sets"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.face_cycle_sets_def<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-card_face_cycle_sets_da0"><span class="command">lemma</span></span> card_face_cycle_sets_da0<span class="main">:</span>
    <span class="quoted"><span class="quoted">"card H.face_cycle_sets <span class="main">=</span> card G.face_cycle_sets <span class="main">-</span> card <span class="main">{</span>G.face_cycle_set <span class="free">a</span><span class="main">,</span> G.face_cycle_set a'<span class="main">}</span>
      <span class="main">+</span> card <span class="main">(</span>H.face_cycle_set <span class="main">`</span> <span class="main">(</span><span class="main">(</span>G.face_cycle_set <span class="free">a</span> <span class="main">∪</span> G.face_cycle_set a'<span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span>a'<span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> face_cycle_sets_inter<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>G.face_cycle_sets <span class="main">-</span> <span class="main">{</span>G.face_cycle_set <span class="free">a</span><span class="main">,</span> G.face_cycle_set a'<span class="main">}</span><span class="main">)</span> <span class="main">∩</span> H.face_cycle_set <span class="main">`</span> <span class="main">(</span><span class="main">(</span>G.face_cycle_set <span class="free">a</span> <span class="main">∪</span> G.face_cycle_set a'<span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span> a'<span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">∩</span> <span class="var">?R</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="skolem"><span class="skolem">P</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> <span class="var">?L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> <span class="var">?R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">x</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">∩</span> <span class="main">(</span>G.face_cycle_set <span class="free">a</span> <span class="main">∪</span> G.face_cycle_set a'<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">L</span> <span class="main">⟹</span> <span class="skolem">P</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">R</span> <span class="main">⟹</span> <span class="main">¬</span><span class="skolem">P</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> G.face_cycle_set_parts <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.face_cycle_sets_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">∩</span> <span class="skolem">R</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> L_def R_def <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> arcs_G
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_Diff_subset<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> card_Un_disjoint<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
        G.in_face_cycle_sets face_cycle_sets_da0<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">locale</span></span> bidel_arc_same_face <span class="main">=</span> bidel_arc <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> same_face<span class="main">:</span> <span class="quoted"><span class="quoted">"G.face_cycle_set a' <span class="main">=</span> G.face_cycle_set <span class="free">a</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1" id="Planar_Subgraph-a_in_o"><span class="command">lemma</span></span> a_in_o<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> orbit G.face_cycle_succ a'"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> G.face_cycle_set_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> same_face<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-segment_a'_a_in"><span class="command">lemma</span></span> segment_a'_a_in<span class="main">:</span> <span class="quoted"><span class="quoted">"segment G.face_cycle_succ a' <span class="free">a</span> <span class="main">⊆</span> arcs H"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?seg</span> <span class="main">⊆</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?seg</span> <span class="main">⊆</span> G.face_cycle_set a'"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.face_cycle_set_def segmentD_orbit<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"G.face_cycle_set a' <span class="main">⊆</span> arcs <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.face_cycle_set_altdef a_in<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> a_in_o <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_H a_in not_in_segment1 not_in_segment2<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-segment_a'_a_neD"><span class="command">lemma</span></span> segment_a'_a_neD<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"segment G.face_cycle_succ a' <span class="free">a</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"segment G.face_cycle_succ a' <span class="free">a</span> <span class="main">∈</span> H.face_cycle_sets"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?seg</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"G.face_cycle_succ a'"</span></span>

    <span class="keyword1"><span class="command">have</span></span> fcs_a_neq_a'<span class="main">:</span> <span class="quoted"><span class="quoted">"G.face_cycle_succ a' <span class="main">≠</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms segment1_empty<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> in_aG<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> segment G.face_cycle_succ a' <span class="free">a</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> arcs <span class="free">G</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span>a'<span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> not_in_segment1 not_in_segment2 segment_a'_a_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_H<span class="main">)</span>

    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> segment G.face_cycle_succ a' <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"G.face_cycle_succ <span class="skolem">x</span> <span class="main">≠</span> <span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"G.face_cycle_succ <span class="skolem">x</span> <span class="main">≠</span> a'"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
        <span class="keyword3"><span class="command">case</span></span> base <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> a_neq_a' G.face_cycle_set_self not_in_segment1 G.face_cycle_set_def same_face segment.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> step <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> a_in_o a_neq_a' not_in_segment1 segment.step<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">with</span></span> A B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">,</span> G.face_cycle_succ <span class="skolem">x</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span> a'<span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> not_in_segment1<span class="main">[</span><span class="operator">OF</span> a_in_o<span class="main">]</span> not_in_segment2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted">G.face_cycle_succ</span> <span class="quoted">a'</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command">with</span></span> in_aG <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"H.face_cycle_succ <span class="skolem">x</span> <span class="main">=</span> G.face_cycle_succ <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> H_fcs_eq_G_fcs<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> A<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> fcs_x_eq <span class="main">=</span> this

    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> segment G.face_cycle_succ a' <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"G.face_cycle_succ <span class="skolem">x</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"G.face_cycle_succ <span class="free">a</span> <span class="main">≠</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B in_aG<span class="main">[</span><span class="operator">OF</span> A<span class="main">]</span> G.bij_face_cycle_succ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_eq_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"edge_succ <span class="free">M</span> <span class="free">a</span> <span class="main">≠</span> edge_rev <span class="free">M</span> <span class="free">a</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> a_in_o G.arev_arev comp_apply G.face_cycle_succ_def not_in_segment1 segment.base<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"H.face_cycle_succ <span class="skolem">x</span> <span class="main">=</span> G.face_cycle_succ a'"</span></span>
        <span class="keyword1"><span class="command">using</span></span> in_aG<span class="main">[</span><span class="operator">OF</span> A<span class="main">]</span> B G.bij_edge_succ <span class="keyword1"><span class="command">unfolding</span></span> H.face_cycle_succ_def G.face_cycle_succ_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HM_def perm_restrict_simps perm_rem_conv G.arev_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> fcs_last_x_eq <span class="main">=</span> this

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"segment G.face_cycle_succ a' <span class="free">a</span> <span class="main">=</span> H.face_cycle_set <span class="var">?b</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> set_eqI iffI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> segment G.face_cycle_succ a' <span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> H.face_cycle_set <span class="var">?b</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
        <span class="keyword3"><span class="command">case</span></span> base <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">x</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fcs_x_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H.face_cycle_succ_inI<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> H.face_cycle_set <span class="var">?b</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> segment G.face_cycle_succ a' <span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
        <span class="keyword3"><span class="command">case</span></span> base <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> segment.base fcs_a_neq_a'<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">x</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fcs_a_neq_a'
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"G.face_cycle_succ <span class="skolem">x</span> <span class="main">=</span> <span class="free">a</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fcs_last_x_eq fcs_x_eq <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> segment.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> segment_a'_a_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>  H.face_cycle_sets_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-segment_a_a'_neD"><span class="command">lemma</span></span> segment_a_a'_neD<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"segment G.face_cycle_succ <span class="free">a</span> a' <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"segment G.face_cycle_succ <span class="free">a</span> a' <span class="main">∈</span> H.face_cycle_sets"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">interpret</span></span> rev<span class="main">:</span> bidel_arc_same_face <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quoted">a'</span>
      <span class="keyword1"><span class="command">using</span></span> a_in same_face <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rev.segment_a'_a_neD <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_H rev_HM<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-H_fcs_full"><span class="command">lemma</span></span> H_fcs_full<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">SS</span> <span class="main">⊆</span> H.face_cycle_sets"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"H.face_cycle_set <span class="main">`</span> <span class="main">(</span><span class="main">⋃</span><span class="free">SS</span><span class="main">)</span> <span class="main">=</span> <span class="free">SS</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
   
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⋃</span><span class="free">SS</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> <span class="free">SS</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> H.face_cycle_sets"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"H.face_cycle_set <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> H.face_cycle_set_parts <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H.face_cycle_sets_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"H.face_cycle_set <span class="skolem">x</span> <span class="main">∈</span> <span class="free">SS</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">∈</span> <span class="free">SS</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> <span class="free">SS</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> arcs H"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> H.face_cycle_set <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H.face_cycle_sets_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> H.face_cycle_set <span class="main">`</span> <span class="main">⋃</span><span class="free">SS</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">∈</span> <span class="free">SS</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-card_fcs_gt_0"><span class="command">lemma</span></span> card_fcs_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> card G.face_cycle_sets"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_gt_0_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> G.in_face_cycle_sets<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-card_face_cycle_sets_da'"><span class="command">lemma</span></span> card_face_cycle_sets_da'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"card H.face_cycle_sets <span class="main">=</span> card G.face_cycle_sets <span class="main">-</span> <span class="main">1</span>
      <span class="main">+</span> card <span class="main">(</span><span class="main">{</span>segment G.face_cycle_succ <span class="free">a</span> a'<span class="main">,</span> segment G.face_cycle_succ a' <span class="free">a</span><span class="main">,</span> <span class="main">{}</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"G.face_cycle_set <span class="free">a</span>
        <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span>a'<span class="main">}</span> <span class="main">∪</span> segment G.face_cycle_succ <span class="free">a</span> a' <span class="main">∪</span> segment G.face_cycle_succ a' <span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a_neq_a' same_face <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cyclic_split_segment<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.face_cycle_succ_cyclic<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"G.face_cycle_set <span class="free">a</span> <span class="main">∪</span> G.face_cycle_set a' <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span> a'<span class="main">}</span> <span class="main">=</span> segment G.face_cycle_succ <span class="free">a</span> a' <span class="main">∪</span> segment G.face_cycle_succ a' <span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> same_face G.face_cycle_set_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> not_in_segment1 not_in_segment2<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"H.face_cycle_set <span class="main">`</span> <span class="main">(</span>G.face_cycle_set <span class="free">a</span> <span class="main">∪</span> G.face_cycle_set a' <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span> a'<span class="main">}</span><span class="main">)</span>
        <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> segment G.face_cycle_succ <span class="free">a</span> a' <span class="main">≠</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">{</span>segment G.face_cycle_succ <span class="free">a</span> a'<span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>
        <span class="main">∪</span> <span class="main">(</span><span class="keyword1">if</span> segment G.face_cycle_succ a' <span class="free">a</span> <span class="main">≠</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">{</span>segment G.face_cycle_succ a' <span class="free">a</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> *
      <span class="keyword1"><span class="command">using</span></span> H_fcs_full<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>segment G.face_cycle_succ <span class="free">a</span> a'<span class="main">,</span> segment G.face_cycle_succ a' <span class="free">a</span><span class="main">}</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> H_fcs_full<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>segment G.face_cycle_succ <span class="free">a</span> a'<span class="main">}</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> H_fcs_full<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>segment G.face_cycle_succ a' <span class="free">a</span><span class="main">}</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> segment_a_a'_neD segment_a'_a_neD<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> card_face_cycle_sets_da0 ** <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> same_face card_insert_if<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> bidel_arc_diff_face <span class="main">=</span> bidel_arc <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> diff_face<span class="main">:</span> <span class="quoted"><span class="quoted">"G.face_cycle_set a' <span class="main">≠</span> G.face_cycle_set <span class="free">a</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≡</span> segment G.face_cycle_succ <span class="free">a</span> <span class="free">a</span> <span class="main">∪</span> segment G.face_cycle_succ a' a'"</span></span>

  <span class="keyword1" id="Planar_Subgraph-diff_face_not_in"><span class="command">lemma</span></span> diff_face_not_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> G.face_cycle_set a'"</span></span> <span class="quoted"><span class="quoted">"a' <span class="main">∉</span> G.face_cycle_set <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> diff_face G.face_cycle_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Planar_Subgraph-H_fcs_eq_for_a"><span class="command">lemma</span></span> H_fcs_eq_for_a<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> arcs H <span class="main">∩</span> G.face_cycle_set <span class="free">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"H.face_cycle_set <span class="free">b</span> <span class="main">=</span> S"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> set_eqI iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> arcs H"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> H.in_face_cycle_setD<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> G.face_cycle_set <span class="free">a</span> <span class="main">∪</span> G.face_cycle_set a'"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="var">?thesis</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"G.face_cycle_set <span class="skolem">c</span> <span class="main">∩</span> <span class="main">(</span>G.face_cycle_set <span class="free">a</span> <span class="main">∪</span> G.face_cycle_set a'<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> G.face_cycle_set_parts <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_H<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"G.face_cycle_set <span class="skolem">c</span> <span class="main">=</span> H.face_cycle_set <span class="skolem">c</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> arcs H›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> face_cycle_set_other_da<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_H<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> H.face_cycle_set <span class="free">b</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> <span class="var">?L</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> H.face_cycle_set_parts <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_def arcs_H G.segment_face_cycle_x_x_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_H<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> b_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> segment G.face_cycle_succ <span class="free">a</span> <span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> G.segment_face_cycle_x_x_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_H<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> fcs_a_neq_a<span class="main">:</span> <span class="quoted"><span class="quoted">"G.face_cycle_succ <span class="free">a</span> <span class="main">≠</span> <span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> G.segment_face_cycle_x_x_eq G.fcs_x_eq_x<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> split_seg<span class="main">:</span> <span class="quoted"><span class="quoted">"segment G.face_cycle_succ <span class="free">a</span> <span class="free">a</span> <span class="main">=</span> segment G.face_cycle_succ <span class="free">a</span> <span class="free">b</span> <span class="main">∪</span> <span class="main">{</span><span class="free">b</span><span class="main">}</span>
        <span class="main">∪</span> segment G.face_cycle_succ <span class="free">b</span> <span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> b_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> segment_split<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> a_in_orb_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> orbit G.face_cycle_succ <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> G.face_cycle_set_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> inv G.face_cycle_succ <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> c_succ<span class="main">:</span> <span class="quoted"><span class="quoted">"G.face_cycle_succ <span class="skolem">c</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> c_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> bij_inv_eq_iff permutation_bijective G.permutation_face_cycle_succ<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> c_in_aa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> segment G.face_cycle_succ <span class="free">a</span> <span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> G.segment_face_cycle_x_x_eq c_def <span class="keyword1"><span class="command">using</span></span> fcs_a_neq_a c_succ c_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> c_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="main">{</span><span class="free">b</span><span class="main">}</span> <span class="main">∪</span> segment G.face_cycle_succ <span class="free">b</span> <span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split_seg b_in c_succ c_in_aa
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> not_in_segment1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> segmentD_orbit<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> segment.intros<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> c_in_aa <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> arcs H"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> G.segment_face_cycle_x_x_eq
      <span class="keyword1"><span class="command">using</span></span> arcs_in c_succ diff_face <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_H G.face_cycle_eq<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">a'</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> b_in_L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> segment G.face_cycle_succ <span class="free">b</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
        <span class="keyword3"><span class="command">case</span></span> base <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> assms diff_face_not_in<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> H_fcs_eq_G_fcs<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_H <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> H.face_cycle_succ_inI G.face_cycle_succ_inI<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">x</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"G.face_cycle_succ <span class="skolem">x</span> <span class="main">∉</span> G.face_cycle_set <span class="free">a</span>  <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈</span> G.face_cycle_set <span class="free">a</span> <span class="main">⟹</span> False"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> G.face_cycle_eq G.face_cycle_succ_inI pre_digraph_map.face_cycle_set_def segmentD_orbit<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step assms H.in_face_cycle_setD arcs_H <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>G.face_cycle_succ <span class="skolem">x</span> <span class="main">∉</span> G.face_cycle_set <span class="free">a</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈</span> G.face_cycle_set <span class="free">a</span> <span class="main">⟹</span> False<span class="main">)</span> <span class="main">⟹</span> <span class="main">{</span><span class="skolem">x</span><span class="main">,</span> G.face_cycle_succ <span class="skolem">x</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span> a'<span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> assms diff_face_not_in<span class="main">(</span>2<span class="main">)</span>  H.in_face_cycle_setD arcs_H <span class="keyword1"><span class="command">by</span></span> <span class="operator">safe</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> step
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> H_fcs_eq_G_fcs<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span>  <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> H.face_cycle_succ_inI<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> sba_in_L <span class="main">=</span> this
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> segment G.face_cycle_succ a' a'"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> c_in <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b_in_L sba_in_L <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"G.face_cycle_succ a' <span class="main">≠</span> a'"</span></span>
          <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> G.segment_face_cycle_x_x_eq G.fcs_x_eq_x<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"G.face_cycle_succ a' <span class="main">=</span> H.face_cycle_succ <span class="skolem">c</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> a_neq_a' c_succ <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> arcs H›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> G.face_cycle_succ_def H.face_cycle_succ_def arcs_H
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HM_def perm_restrict_simps perm_rem_conv G.bij_edge_succ G.arev_eq_iff<span class="main">)</span>

        <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> H.face_cycle_set <span class="skolem">c</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
          <span class="keyword3"><span class="command">case</span></span> base <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> * H.face_cycle_succ_inI<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">x</span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span><span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> arcs H›</span></span> step.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_H <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> H.in_face_cycle_setD<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"G.face_cycle_succ <span class="skolem">x</span> <span class="main">≠</span> a' <span class="main">⟹</span>  <span class="main">{</span><span class="skolem">x</span><span class="main">,</span> G.face_cycle_succ <span class="skolem">x</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span> a'<span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>1<span class="main">)</span> diff_face_not_in<span class="main">(</span>1<span class="main">)</span> G.face_cycle_succ_inI G.segment_face_cycle_x_x_eq
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_in_segment2<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> H_fcs_eq_G_fcs<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> H.face_cycle_succ_inI<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"H.face_cycle_set <span class="skolem">c</span> <span class="main">=</span> <span class="var">?L</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> <span class="var">?L</span>›</span></span> H.face_cycle_set_parts <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> sa'a'_in_L <span class="main">=</span> this
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> segment G.face_cycle_succ <span class="free">a</span> <span class="free">b</span>"</span></span>

      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d_succ<span class="main">:</span> <span class="quoted"><span class="quoted">"H.face_cycle_succ <span class="skolem">d</span> <span class="main">=</span> G.face_cycle_succ <span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"G.face_cycle_succ a' <span class="main">=</span> a'"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">from</span></span> c_in <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b_in_L sba_in_L <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"H.face_cycle_succ <span class="skolem">c</span> <span class="main">=</span> G.face_cycle_succ <span class="free">a</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> fcs_a_neq_a c_succ  a_neq_a' True <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> arcs H›</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> G.face_cycle_succ_def H.face_cycle_succ_def arcs_H
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HM_def perm_restrict_simps arcs_H perm_rem_conv G.bij_edge_succ G.arev_eq_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False

        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> inv G.face_cycle_succ a'"</span></span>
        <span class="keyword1"><span class="command">have</span></span> d_succ<span class="main">:</span> <span class="quoted"><span class="quoted">"G.face_cycle_succ <span class="skolem">d</span> <span class="main">=</span> a'"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> d_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> bij_inv_eq_iff permutation_bijective G.permutation_face_cycle_succ<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> sa'a'_in_L False
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> DiffI d_succ empty_iff G.face_cycle_set_self G.face_cycle_set_succ insert_iff G.permutation_face_cycle_succ pre_digraph_map.face_cycle_set_def segment_x_x_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> arcs H"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> H.in_face_cycle_setD<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"H.face_cycle_succ <span class="skolem">d</span> <span class="main">=</span> G.face_cycle_succ <span class="free">a</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> fcs_a_neq_a a_neq_a' <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">∈</span> arcs H›</span></span> d_succ
          <span class="keyword1"><span class="command">unfolding</span></span> G.face_cycle_succ_def H.face_cycle_succ_def arcs_H
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HM_def perm_restrict_simps arcs_H perm_rem_conv G.bij_edge_succ G.arev_eq_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> arcs H"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">drule</span> H.in_face_cycle_setD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> H.face_cycle_set <span class="skolem">d</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
        <span class="keyword3"><span class="command">case</span></span> base <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> d_succ<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> H.face_cycle_succ_inI<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">x</span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">∈</span> arcs H›</span></span> arcs_H digraph_map.in_face_cycle_setD step.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">{</span><span class="skolem">x</span><span class="main">,</span> G.face_cycle_succ <span class="skolem">x</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span> a'<span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>2<span class="main">)</span> H.in_face_cycle_setD <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">∈</span> arcs H›</span></span> arcs_not_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> G.face_cycle_succ <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> b_in not_in_segment1 segment.step segmentD_orbit step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a' <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"a' <span class="main">≠</span> G.face_cycle_succ <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>1<span class="main">)</span> diff_face_not_in<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.face_cycle_set_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> segmentD_orbit <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> orbit.step<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> step
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> H_fcs_eq_G_fcs<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> H.face_cycle_succ_inI<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"H.face_cycle_set <span class="skolem">d</span> <span class="main">=</span> <span class="var">?L</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">∈</span> <span class="var">?L</span>›</span></span> H.face_cycle_set_parts <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?R</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_def split_seg <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-HJ_fcs_eq_for_a'"><span class="command">lemma</span></span> HJ_fcs_eq_for_a'<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> arcs H <span class="main">∩</span> G.face_cycle_set a'"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"H.face_cycle_set <span class="free">b</span> <span class="main">=</span> S"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">interpret</span></span> rev<span class="main">:</span> bidel_arc_diff_face <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quoted">a'</span>
      <span class="keyword1"><span class="command">using</span></span> arcs_in diff_face <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp_all</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rev.H_fcs_eq_for_a assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rev_H rev_HM S_def rev.S_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-card_face_cycle_sets_da'"><span class="command">lemma</span></span> card_face_cycle_sets_da'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"card H.face_cycle_sets <span class="main">=</span> card G.face_cycle_sets <span class="main">-</span> card <span class="main">{</span>G.face_cycle_set <span class="free">a</span><span class="main">,</span> G.face_cycle_set a'<span class="main">}</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> S <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S <span class="main">=</span> G.face_cycle_set <span class="free">a</span> <span class="main">∪</span> G.face_cycle_set a' <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span> a'<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">using</span></span> diff_face_not_in
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> segment_x_x_eq G.permutation_face_cycle_succ G.face_cycle_set_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> S"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> arcs H <span class="main">∩</span> <span class="main">(</span>G.face_cycle_set <span class="free">a</span> <span class="main">∪</span> G.face_cycle_set a' <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span> a'<span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹S <span class="main">=</span> <span class="main">_</span>›</span></span> arcs_H <span class="keyword1"><span class="command">using</span></span> a_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> G.in_face_cycle_setD<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"H.face_cycle_set <span class="skolem">x</span> <span class="main">=</span> S"</span></span> <span class="keyword1"><span class="command">using</span></span> H_fcs_eq_for_a HJ_fcs_eq_for_a' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"H.face_cycle_set <span class="main">`</span> S <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> S <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="main">{</span>S<span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_face_cycle_sets_da0<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">locale</span></span> bidel_arc_biconnected <span class="main">=</span> bidel_arc <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> reach_a<span class="main">:</span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="free">a</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub>H</sub><span class="hidden">⇙</span> head <span class="free">G</span> <span class="free">a</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Planar_Subgraph-reach_a'"><span class="command">lemma</span></span> reach_a'<span class="main">:</span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> a' <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub>H</sub><span class="hidden">⇙</span> head <span class="free">G</span> a'"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reach_a a_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> symmetric_reachable H.sym_arcs<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-tail_a'"><span class="command">lemma</span></span>
    tail_a'<span class="main">:</span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> a' <span class="main">=</span> head <span class="free">G</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    head_a'<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> a' <span class="main">=</span> tail <span class="free">G</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

  <span class="keyword1" id="Planar_Subgraph-reachable_daI"><span class="command">lemma</span></span> reachable_daI<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub>H</sub><span class="hidden">⇙</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span> <span class="bound">w</span><span class="main">.</span> <span class="bound">v</span> <span class="main">→</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="bound">w</span> <span class="main">⟹</span> <span class="bound">v</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub>H</sub><span class="hidden">⇙</span> <span class="bound">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> reach_a reach_a' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_ends_def ends_H arcs_G arc_to_ends_def tail_a'<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> verts_H <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> * H.reachable_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-reachable_da"><span class="command">lemma</span></span> reachable_da<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub>H</sub><span class="hidden">⇙</span> <span class="free">w</span> <span class="main">⟷</span> <span class="free">v</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> reachable_daD reachable_daI<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-sccs_verts_da"><span class="command">lemma</span></span> sccs_verts_da<span class="main">:</span> <span class="quoted"><span class="quoted">"H.sccs_verts <span class="main">=</span> G.sccs_verts"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.in_sccs_verts_conv_reachable H.in_sccs_verts_conv_reachable reachable_da<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-card_sccs_da"><span class="command">lemma</span></span> card_sccs_da<span class="main">:</span> <span class="quoted"><span class="quoted">"card H.sccs <span class="main">=</span> card G.sccs"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> G.card_sccs_verts<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> H.card_sccs_verts<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> sccs_verts_da<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">locale</span></span> bidel_arc_not_biconnected <span class="main">=</span> bidel_arc <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> not_reach_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>tail <span class="free">G</span> <span class="free">a</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub>H</sub><span class="hidden">⇙</span> head <span class="free">G</span> <span class="free">a</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Planar_Subgraph-H_awalkI"><span class="command">lemma</span></span> H_awalkI<span class="main">:</span> <span class="quoted"><span class="quoted">"G.awalk <span class="free">u</span> <span class="free">p</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span>a'<span class="main">}</span> <span class="main">∩</span> set <span class="free">p</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> H.awalk <span class="free">u</span> <span class="free">p</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_digraph.apath_def pre_digraph.awalk_def verts_H arcs_H cas_da<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-tail_neq_head"><span class="command">lemma</span></span> tail_neq_head<span class="main">:</span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="free">a</span> <span class="main">≠</span> head <span class="free">G</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_reach_a a_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> H.reachable_refl G.head_in_verts verts_H<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-scc_of_tail_neq_head"><span class="command">lemma</span></span> scc_of_tail_neq_head<span class="main">:</span> <span class="quoted"><span class="quoted">"H.scc_of <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span> <span class="main">≠</span> H.scc_of <span class="main">(</span>head <span class="free">G</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="free">a</span> <span class="main">∈</span> H.scc_of <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="free">a</span> <span class="main">∈</span> H.scc_of <span class="main">(</span>head <span class="free">G</span> <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ends_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H.in_scc_of_self verts_H<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> not_reach_a <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H.scc_of_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-scc_of_G_tail"><span class="command">lemma</span></span> scc_of_G_tail<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> G.scc_of <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"H.scc_of <span class="free">u</span> <span class="main">=</span> H.scc_of <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span> <span class="main">∨</span> H.scc_of <span class="free">u</span> <span class="main">=</span> H.scc_of <span class="main">(</span>head <span class="free">G</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> tail <span class="free">G</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.scc_of_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"G.apath <span class="free">u</span> <span class="skolem">p</span> <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.reachable_apath<span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="free">a</span> <span class="main">∈</span> set <span class="main">(</span>G.awalk_verts <span class="free">u</span> <span class="skolem">p</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> p <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">p'</span> <span class="main">@</span> <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"G.awalk <span class="main">(</span>head <span class="free">G</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> p'<span class="main">:</span> <span class="quoted"><span class="quoted">"G.awalk <span class="free">u</span> <span class="skolem">p'</span> <span class="main">(</span>head <span class="free">G</span> <span class="free">a</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> G.apath_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> G.awalk_decomp<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="free">a</span> <span class="main">∈</span> set <span class="main">(</span>tl <span class="main">(</span>G.awalk_verts <span class="main">(</span>head <span class="free">G</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> tail_neq_head
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> G.awalk_Nil_iff <span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> G.awalk_Cons_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> G.awalkE G.awalk_verts_non_Nil last_in_set<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="free">a</span> <span class="main">∉</span> set <span class="main">(</span>G.awalk_verts <span class="free">u</span> <span class="skolem">p'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> G.apath_decomp_disjoint<span class="main">[</span><span class="operator">OF</span> p<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p'</span></span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="free">a</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> p' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">,</span>a'<span class="main">}</span> <span class="main">∩</span> set <span class="skolem">p'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.set_awalk_verts G.apath_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> a_in imageI G.head_arev<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> p' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> G.apath_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> H.scc_ofI_awalk H.scc_of_eq H_awalkI<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">,</span>a'<span class="main">}</span> <span class="main">∩</span> set <span class="skolem">p</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.set_awalk_verts G.apath_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> a_in imageI G.tail_arev<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> p <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> G.apath_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> H.scc_ofI_awalk H.scc_of_eq H_awalkI<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-scc_of_other"><span class="command">lemma</span></span> scc_of_other<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∉</span> G.scc_of <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"H.scc_of <span class="free">u</span> <span class="main">=</span> G.scc_of <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> set_eqI iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> H.scc_of <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> G.scc_of <span class="free">u</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H.scc_of_def G.scc_of_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reachable_daD<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> G.scc_of <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"G.awalk <span class="free">u</span> <span class="skolem">p</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.scc_of_def G.reachable_awalk<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">,</span>a'<span class="main">}</span> <span class="main">∩</span> set <span class="skolem">p</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">u</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> tail <span class="free">G</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> G.scc_ofI_reachable<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="main">¬</span>G.awalk <span class="free">u</span> <span class="bound">p</span> <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> G.reachable_awalk<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="free">a</span> <span class="main">∉</span> set <span class="main">(</span>G.awalk_verts <span class="free">u</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> G.awalk_decomp<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> p <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.set_awalk_verts G.apath_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> a_in imageI G.head_arev<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"H.awalk <span class="free">u</span> <span class="skolem">p</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> H_awalkI<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> H.scc_of <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> H.scc_ofI_reachable' H.reachable_awalk<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-scc_of_tail_inter"><span class="command">lemma</span></span> scc_of_tail_inter<span class="main">:</span>
    <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="free">a</span> <span class="main">∈</span> G.scc_of <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span> <span class="main">∩</span> H.scc_of <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ends_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.in_scc_of_self H.in_scc_of_self verts_H<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-scc_of_head_inter"><span class="command">lemma</span></span> scc_of_head_inter<span class="main">:</span>
    <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="free">a</span> <span class="main">∈</span> G.scc_of <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span> <span class="main">∩</span> H.scc_of <span class="main">(</span>head <span class="free">G</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="free">a</span> <span class="main">→</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> head <span class="free">G</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="free">a</span> <span class="main">→</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> tail <span class="free">G</span> <span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> a_in G.in_arcs_imp_in_arcs_ends<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> a_in G.graph_symmetric G.in_arcs_imp_in_arcs_ends<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="free">a</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> head <span class="free">G</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="free">a</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> tail <span class="free">G</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ends_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.scc_of_def H.in_scc_of_self verts_H<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-G_scc_of_tail_not_in"><span class="command">lemma</span></span> G_scc_of_tail_not_in<span class="main">:</span> <span class="quoted"><span class="quoted">"G.scc_of <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span> <span class="main">∉</span> H.sccs_verts"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"G.scc_of <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> H.sccs_verts"</span></span>
    <span class="keyword1"><span class="command">from</span></span> A scc_of_tail_inter <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"G.scc_of <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> H.scc_of <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> H.scc_of_in_sccs_verts H.sccs_verts_disjoint a_in empty_iff G.tail_in_verts verts_H<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> A scc_of_head_inter <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"G.scc_of <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> H.scc_of <span class="main">(</span>head <span class="free">G</span> <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> H.scc_of_in_sccs_verts H.sccs_verts_disjoint a_in empty_iff G.head_in_verts verts_H<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> scc_of_tail_neq_head <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-H_scc_of_a_not_in"><span class="command">lemma</span></span> H_scc_of_a_not_in<span class="main">:</span>
    <span class="quoted"><span class="quoted">"H.scc_of <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span> <span class="main">∉</span> G.sccs_verts"</span></span> <span class="quoted"><span class="quoted">"H.scc_of <span class="main">(</span>head <span class="free">G</span> <span class="free">a</span><span class="main">)</span> <span class="main">∉</span> G.sccs_verts"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"H.scc_of <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> G.sccs_verts"</span></span>
    <span class="keyword1"><span class="command">with</span></span> scc_of_tail_inter <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"G.scc_of <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> H.scc_of <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> G.scc_of_in_sccs_verts G.sccs_verts_disjoint a_in empty_iff G.tail_in_verts<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> G_scc_of_tail_not_in <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> ends_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H.scc_of_in_sccs_verts verts_H<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"H.scc_of <span class="main">(</span>head <span class="free">G</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> G.sccs_verts"</span></span>
    <span class="keyword1"><span class="command">with</span></span> scc_of_head_inter <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"G.scc_of <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> H.scc_of <span class="main">(</span>head <span class="free">G</span> <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> G.scc_of_in_sccs_verts G.sccs_verts_disjoint a_in empty_iff G.tail_in_verts<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> G_scc_of_tail_not_in <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> ends_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H.scc_of_in_sccs_verts verts_H<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-scc_verts_da"><span class="command">lemma</span></span> scc_verts_da<span class="main">:</span>
    <span class="quoted"><span class="quoted">"H.sccs_verts <span class="main">=</span> <span class="main">(</span>G.sccs_verts <span class="main">-</span> <span class="main">{</span>G.scc_of <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span>H.scc_of <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span><span class="main">,</span> H.scc_of <span class="main">(</span>head <span class="free">G</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> set_eqI iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> verts <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> H.scc_of <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> verts_H H.sccs_verts_conv_scc_of<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"G.scc_of <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span> <span class="main">≠</span> H.scc_of <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">∈</span> <span class="var">?L</span>›</span></span> G_scc_of_tail_not_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> G.sccs_verts_conv_scc_of
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> G.scc_of <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> scc_of_G_tail scc_of_other<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> G.sccs_verts"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">∈</span> <span class="var">?R</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> verts <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> G.scc_of <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">≠</span> G.scc_of <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> H_scc_of_a_not_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.sccs_verts_conv_scc_of<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"G.scc_of <span class="skolem">u</span> <span class="main">∩</span> G.scc_of <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ends_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> G.sccs_verts_disjoint<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.scc_of_in_sccs_verts<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∉</span> G.scc_of <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> u <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> G.in_scc_of_self<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> u <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> scc_of_other
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H.sccs_verts_conv_scc_of verts_H G.sccs_verts_conv_scc_of<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">∈</span> <span class="var">?R</span>›</span></span> ends_in <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H.sccs_verts_conv_scc_of verts_H<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-card_sccs_da"><span class="command">lemma</span></span> card_sccs_da<span class="main">:</span> <span class="quoted"><span class="quoted">"card H.sccs <span class="main">=</span> Suc <span class="main">(</span>card G.sccs<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> H_scc_of_a_not_in ends_in
    <span class="keyword1"><span class="command">unfolding</span></span> G.card_sccs_verts<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> H.card_sccs_verts<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> scc_verts_da
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_insert_if G.finite_sccs_verts scc_of_tail_neq_head card_Suc_Diff1
      G.scc_of_in_sccs_verts <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> card_Diff_insert<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> bidel_arc_not_biconnected <span class="main">⊆</span> bidel_arc_same_face
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">note</span></span> a_in
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> a_in <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="free">a</span> <span class="main">∈</span> tail <span class="free">G</span> <span class="main">`</span> G.face_cycle_set <span class="free">a</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> G.heads_face_cycle_set<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="free">a</span> <span class="main">∈</span> tail <span class="free">G</span> <span class="main">`</span> G.face_cycle_set <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"G.trail <span class="main">(</span>head <span class="free">G</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">p</span> <span class="main">⊆</span> G.face_cycle_set <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> G.obtain_trail_in_fcs'<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">=</span> G.awalk_to_apath <span class="skolem">p</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> p'<span class="main">:</span> <span class="quoted"><span class="quoted">"G.apath <span class="main">(</span>head <span class="free">G</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">p'</span> <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">p'</span> <span class="main">⊆</span> G.face_cycle_set <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.trail_def p'_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> G.apath_awalk_to_apath G.awalk_to_apath_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">p'</span> <span class="main">⊆</span> arcs <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> G.in_face_cycle_setD<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>set <span class="skolem">p'</span> <span class="main">⊆</span> arcs H"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">p'</span> <span class="main">⊆</span> arcs H"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"H.awalk <span class="main">(</span>head <span class="free">G</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">p'</span> <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.apath_def arcs_H <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> H_awalkI<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> not_reach_a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> H.symmetric_reachable' H.reachable_awalk<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">p'</span> <span class="main">∩</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span>a'<span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">p'</span> <span class="main">⊆</span> arcs <span class="free">G</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_H<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="skolem">p'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> set <span class="skolem">p'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="free">a</span> <span class="main">∈</span> set <span class="main">(</span>tl <span class="main">(</span>G.awalk_verts <span class="main">(</span>head <span class="free">G</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">p'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹G.apath <span class="main">_</span> <span class="skolem">p'</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.set_awalk_verts G.apath_def G.awalk_Cons_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> imageI<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="free">a</span> <span class="main">∉</span> set <span class="main">(</span>tl <span class="main">(</span>G.awalk_verts <span class="main">(</span>head <span class="free">G</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">p'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹G.apath <span class="main">_</span> <span class="skolem">p'</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.apath_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a' <span class="main">∈</span> G.face_cycle_set <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"G.face_cycle_set a' <span class="main">=</span> G.face_cycle_set <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> G.face_cycle_set_parts <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">locale</span></span> bidel_arc_tail_conn <span class="main">=</span> bidel_arc <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> conn_tail<span class="main">:</span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="free">a</span> <span class="main">∉</span> H.isolated_verts"</span></span>

<span class="keyword1"><span class="command">locale</span></span> bidel_arc_head_conn <span class="main">=</span> bidel_arc <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> conn_head<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="free">a</span> <span class="main">∉</span> H.isolated_verts"</span></span>

<span class="keyword1"><span class="command">locale</span></span> bidel_arc_tail_isolated <span class="main">=</span> bidel_arc <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> isolated_tail<span class="main">:</span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="free">a</span> <span class="main">∈</span> H.isolated_verts"</span></span>
  
<span class="keyword1"><span class="command">locale</span></span> bidel_arc_head_isolated <span class="main">=</span> bidel_arc <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> isolated_head<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="free">a</span> <span class="main">∈</span> H.isolated_verts"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Planar_Subgraph-G_edge_succ_a'_no_loop"><span class="command">lemma</span></span> G_edge_succ_a'_no_loop<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> no_loop_a<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="free">a</span> <span class="main">≠</span> tail <span class="free">G</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> G_edge_succ_a'<span class="main">:</span> <span class="quoted"><span class="quoted">"edge_succ <span class="free">M</span> a' <span class="main">=</span> a'"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?t2</span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"out_arcs <span class="free">G</span> <span class="main">(</span>tail <span class="free">G</span> a'<span class="main">)</span> <span class="main">=</span> <span class="main">{</span>a'<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a_in isolated_head no_loop_a
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H.isolated_verts_def verts_H out_arcs_def arcs_H tail_H<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"edge_succ <span class="free">M</span> a' <span class="main">∈</span> <span class="main">{</span>a'<span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> G.edge_succ_cyclic<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> a'"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eq_on_cyclic_on_iff1<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"a'"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> * a_in a_neq_a' no_loop_a <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-G_face_cycle_succ_a_no_loop"><span class="command">lemma</span></span> G_face_cycle_succ_a_no_loop<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> no_loop_a<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="free">a</span> <span class="main">≠</span> tail <span class="free">G</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"G.face_cycle_succ <span class="free">a</span> <span class="main">=</span> a'"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.face_cycle_succ_def G_edge_succ_a'_no_loop<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>





<span class="keyword1"><span class="command">locale</span></span> bidel_arc_same_face_tail_conn <span class="main">=</span> bidel_arc_same_face <span class="main">+</span> bidel_arc_tail_conn
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">a_neigh</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">a_neigh</span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">b</span><span class="main">.</span> G.face_cycle_succ <span class="bound">b</span> <span class="main">=</span> <span class="free">a</span>"</span></span>

  <span class="keyword1" id="Planar_Subgraph-face_cycle_succ_a_neigh"><span class="command">lemma</span></span> face_cycle_succ_a_neigh<span class="main">:</span> <span class="quoted"><span class="quoted">"G.face_cycle_succ a_neigh <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span><span class="main">.</span> G.face_cycle_succ <span class="bound">b</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> G.face_cycle_succ_pred<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> a_neigh_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI_ex<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-a_neigh_in"><span class="command">lemma</span></span> a_neigh_in<span class="main">:</span> <span class="quoted"><span class="quoted">"a_neigh <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> face_cycle_succ_a_neigh G.face_cycle_succ_closed<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-a_neigh_neq_a"><span class="command">lemma</span></span> a_neigh_neq_a<span class="main">:</span> <span class="quoted"><span class="quoted">"a_neigh <span class="main">≠</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"a_neigh <span class="main">=</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"G.face_cycle_set <span class="free">a</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> face_cycle_succ_a_neigh <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> G.fcs_x_eq_x<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_neq_a' same_face G.face_cycle_set_self<span class="main">[</span><span class="operator">of</span> <span class="quoted">a'</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-a_neigh_neq_a'"><span class="command">lemma</span></span> a_neigh_neq_a'<span class="main">:</span> <span class="quoted"><span class="quoted">"a_neigh <span class="main">≠</span> a'"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"a_neigh <span class="main">=</span> a'"</span></span>

    <span class="keyword1"><span class="command">have</span></span> a_in_oa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> out_arcs <span class="free">G</span> <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> cyc<span class="main">:</span> <span class="quoted"><span class="quoted">"cyclic_on <span class="main">(</span>edge_succ <span class="free">M</span><span class="main">)</span> <span class="main">(</span>out_arcs <span class="free">G</span> <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> G.edge_succ_cyclic<span class="main">)</span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"G.face_cycle_succ a' <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> face_cycle_succ_a_neigh<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"edge_succ <span class="free">M</span> <span class="free">a</span> <span class="main">=</span> <span class="free">a</span> "</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.face_cycle_succ_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>out_arcs <span class="free">G</span> <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cyc a_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> eq_on_cyclic_on_iff1<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"out_arcs <span class="free">G</span> <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a_in_oa <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> in_out_arcs_conv <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> card_eq_SucD<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> conn_tail a_in
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H.isolated_verts_def arcs_H tail_H verts_H out_arcs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-edge_rev_a_neigh_neq"><span class="command">lemma</span></span> edge_rev_a_neigh_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"edge_rev <span class="free">M</span> a_neigh <span class="main">≠</span> a'"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> a_neigh_neq_a G.arev_arev<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-edge_succ_a_neq"><span class="command">lemma</span></span> edge_succ_a_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"edge_succ <span class="free">M</span> <span class="free">a</span> <span class="main">≠</span> a'"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"edge_succ <span class="free">M</span> <span class="free">a</span> <span class="main">=</span> a'"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"G.face_cycle_set a' <span class="main">=</span> <span class="main">{</span>a'<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> face_cycle_succ_a_neigh
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> G.arev_arev_raw G.face_cycle_succ_def G.fcs_x_eq_x a_in comp_apply singletonD<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_neq_a' same_face G.face_cycle_set_self<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-H_face_cycle_succ_a_neigh"><span class="command">lemma</span></span> H_face_cycle_succ_a_neigh<span class="main">:</span> <span class="quoted"><span class="quoted">"H.face_cycle_succ a_neigh <span class="main">=</span> G.face_cycle_succ a'"</span></span>
    <span class="keyword1"><span class="command">using</span></span> face_cycle_succ_a_neigh edge_succ_a_neq edge_rev_a_neigh_neq a_neigh_neq_a a_neigh_neq_a' a_neigh_in
    <span class="keyword1"><span class="command">unfolding</span></span> H.face_cycle_succ_def G.face_cycle_succ_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HM_def perm_restrict_simps perm_rem_conv G.bij_edge_succ<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-H_fcs_a_neigh"><span class="command">lemma</span></span> H_fcs_a_neigh<span class="main">:</span> <span class="quoted"><span class="quoted">"H.face_cycle_set a_neigh <span class="main">=</span> segment G.face_cycle_succ a' <span class="free">a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> funpow_dist1 G.face_cycle_succ a' <span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>G.face_cycle_succ <span class="main">^^</span> <span class="skolem">n</span><span class="main">)</span> a' <span class="main">∈</span> segment G.face_cycle_succ a' <span class="free">a</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a_in_o <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> segment_altdef<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>G.face_cycle_succ <span class="main">^^</span> <span class="skolem">n</span><span class="main">)</span> a' <span class="main">∉</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span>a'<span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>G.face_cycle_succ <span class="main">^^</span> <span class="skolem">n</span><span class="main">)</span> a' <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> not_in_segment1<span class="main">[</span><span class="operator">OF</span> a_in_o<span class="main">]</span> not_in_segment2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted">G.face_cycle_succ</span> <span class="quoted">a'</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> segment_altdef a_in_o<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> X <span class="main">=</span> this

    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> funpow_dist1 G.face_cycle_succ a' <span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>H.face_cycle_succ <span class="main">^^</span> <span class="skolem">n</span><span class="main">)</span> a_neigh <span class="main">=</span> <span class="main">(</span>G.face_cycle_succ <span class="main">^^</span> <span class="skolem">n</span><span class="main">)</span> a'"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">=</span><span class="main">0</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> H_face_cycle_succ_a_neigh<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>H.face_cycle_succ <span class="main">^^</span> <span class="skolem">n</span><span class="main">)</span> a_neigh <span class="main">=</span> <span class="main">(</span>G.face_cycle_succ <span class="main">^^</span> <span class="skolem">n</span><span class="main">)</span> a'"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> X<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem">n</span></span>"</span></span></span><span class="main">]</span> X<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">n</span></span></span></span><span class="main">]</span> False Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> H_fcs_eq_G_fcs<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> Y <span class="main">=</span> this

    <span class="keyword1"><span class="command">have</span></span> fcs_a'_neq_a<span class="main">:</span> <span class="quoted"><span class="quoted">"G.face_cycle_succ a' <span class="main">≠</span> <span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> a_neigh_neq_a' G.face_cycle_pred_succ face_cycle_succ_a_neigh<span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> set_eqI iffI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>

      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> funpow_dist1 G.face_cycle_succ a' <span class="free">a</span> <span class="main">-</span> <span class="main">1</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> b_in0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> orbit H.face_cycle_succ <span class="main">(</span>a_neigh<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∈</span> <span class="var">?L</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> H.face_cycle_set_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">m</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> a_neigh_neq_a' G.face_cycle_pred_succ G.face_cycle_set_def
          G.face_cycle_set_self G.face_cycle_set_succ face_cycle_succ_a_neigh funpow_dist_0_eq neq0_conv
          same_face<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> pos_dist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> funpow_dist1 H.face_cycle_succ a_neigh <span class="skolem">b</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m_def<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>G.face_cycle_succ <span class="main">^^</span> Suc <span class="skolem">m</span><span class="main">)</span> a' <span class="main">=</span> <span class="free">a</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a_in_o <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m_def funpow_dist1_prop <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> funpow.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>H.face_cycle_succ <span class="main">^^</span> <span class="skolem">m</span><span class="main">)</span> a_neigh <span class="main">=</span> a_neigh"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> G.face_cycle_succ <span class="main">(</span><span class="main">(</span>H.face_cycle_succ <span class="main">^^</span> <span class="skolem">m</span><span class="main">)</span> a_neigh<span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> * <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Y m_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> face_cycle_succ_a_neigh <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> G.face_cycle_pred_succ<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"funpow_dist1 H.face_cycle_succ a_neigh <span class="skolem">b</span> <span class="main">≤</span> <span class="skolem">m</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">m</span>›</span></span> b_in0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> funpow_dist1_le_self<span class="main">)</span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> funpow_dist1 G.face_cycle_succ a' <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> m_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> dist_less<span class="main">:</span> <span class="quoted"><span class="quoted">"funpow_dist1 H.face_cycle_succ a_neigh <span class="skolem">b</span>
          <span class="main">&lt;</span> funpow_dist1 G.face_cycle_succ a' <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="main">(</span>H.face_cycle_succ <span class="main">^^</span> funpow_dist1 H.face_cycle_succ a_neigh <span class="skolem">b</span><span class="main">)</span> a_neigh"</span></span>
        <span class="keyword1"><span class="command">using</span></span> b_in0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funpow_dist1_prop <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> funpow.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>G.face_cycle_succ <span class="main">^^</span> funpow_dist1 H.face_cycle_succ a_neigh <span class="skolem">b</span><span class="main">)</span> a'"</span></span>
        <span class="keyword1"><span class="command">using</span></span> pos_dist dist_less <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Y<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pos_dist dist_less <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> segment_altdef a_in_o <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> funpow.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Y
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> segment_altdef a_in_o H.face_cycle_set_altdef Suc_le_eq<span class="main">)</span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>





<span class="keyword1"><span class="command">locale</span></span> bidel_arc_isolated_loop <span class="main">=</span>
  bidel_arc_biconnected <span class="main">+</span> bidel_arc_tail_isolated
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Planar_Subgraph-loop_a"><span class="command">lemma</span></span> loop_a<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="free">a</span> <span class="main">=</span> tail <span class="free">G</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> isolated_tail reach_a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H.isolated_verts_def
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> H.converse_reachable_cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> out_arcs_emptyD_dominates<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> bidel_arc_isolated_loop <span class="main">⊆</span> bidel_arc_head_isolated
  <span class="keyword1"><span class="command">using</span></span> isolated_tail loop_a <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">context</span></span> bidel_arc_isolated_loop <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The edges <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">a</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">a'</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> form a loop on an otherwise isolated vertex ›</span></span>

  <span class="keyword1" id="Planar_Subgraph-card_isolated_verts_da"><span class="command">lemma</span></span> card_isolated_verts_da<span class="main">:</span> <span class="quoted"><span class="quoted">"card H.isolated_verts <span class="main">=</span> Suc <span class="main">(</span>card G.isolated_verts<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_isolated_verts_da0 isolated_tail<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-G_edge_succ_a"><span class="command">lemma</span></span>
    G_edge_succ_a<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"edge_succ <span class="free">M</span> <span class="free">a</span> <span class="main">=</span> a'"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?t1</span></span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    G_edge_succ_a'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"edge_succ <span class="free">M</span> a' <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?t2</span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"out_arcs <span class="free">G</span> <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span>a'<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a_in isolated_tail 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H.isolated_verts_def verts_H out_arcs_def arcs_H tail_H<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"edge_succ <span class="free">M</span> a' <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span>a'<span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"edge_succ <span class="free">M</span> a' <span class="main">≠</span> a'"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> G.edge_succ_cyclic<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> a'"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eq_on_cyclic_on_iff1<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"a'"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> * a_in a_neq_a' loop_a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"edge_succ <span class="free">M</span> <span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span>a'<span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"edge_succ <span class="free">M</span> <span class="free">a</span> <span class="main">≠</span> <span class="free">a</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> G.edge_succ_cyclic<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="free">a</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eq_on_cyclic_on_iff1<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> * a_in a_neq_a' loop_a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?t1</span></span></span> <span class="var"><span class="quoted"><span class="var">?t2</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-G_face_cycle_succ_a"><span class="command">lemma</span></span>
    G_face_cycle_succ_a<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"G.face_cycle_succ <span class="free">a</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    G_face_cycle_succ_a'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"G.face_cycle_succ a' <span class="main">=</span> a'"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.face_cycle_succ_def<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-G_face_cycle_set_a"><span class="command">lemma</span></span>
    G_face_cycle_set_a<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"G.face_cycle_set <span class="free">a</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    G_face_cycle_set_a'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"G.face_cycle_set a' <span class="main">=</span> <span class="main">{</span>a'<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> G.fcs_x_eq_x<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> bidel_arc_isolated_loop <span class="main">⊆</span> bidel_arc_diff_face
  <span class="keyword1"><span class="command">using</span></span> a_neq_a' <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> bidel_arc_isolated_loop <span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Planar_Subgraph-card_face_cycle_sets_da"><span class="command">lemma</span></span> card_face_cycle_sets_da<span class="main">:</span> <span class="quoted"><span class="quoted">"card G.face_cycle_sets <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="main">(</span>card H.face_cycle_sets<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> card_face_cycle_sets_da' <span class="keyword1"><span class="command">using</span></span> diff_face card_fcs_aa'_le
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_insert_if S_def G.segment_face_cycle_x_x_eq<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-euler_genus_da"><span class="command">lemma</span></span> euler_genus_da<span class="main">:</span> <span class="quoted"><span class="quoted">"H.euler_genus <span class="main">=</span> G.euler_genus"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> G.euler_genus_def H.euler_genus_def G.euler_char_def H.euler_char_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_isolated_verts_da verts_H card_arcs_da card_face_cycle_sets_da card_sccs_da<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> bidel_arc_two_isolated <span class="main">=</span>
  bidel_arc_not_biconnected <span class="main">+</span> bidel_arc_tail_isolated <span class="main">+</span> bidel_arc_head_isolated
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"tail <span class="free"><span class="free">G</span></span> <span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"head <span class="free"><span class="free">G</span></span> <span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> form an SCC with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">a</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">a'</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as the only arcs.›</span></span>

  <span class="keyword1" id="Planar_Subgraph-no_loop_a"><span class="command">lemma</span></span> no_loop_a<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="free">a</span> <span class="main">≠</span> tail <span class="free">G</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_reach_a a_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> verts_H<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-card_isolated_verts_da"><span class="command">lemma</span></span> card_isolated_verts_da<span class="main">:</span> <span class="quoted"><span class="quoted">"card H.isolated_verts <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="main">(</span>card G.isolated_verts<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> no_loop_a isolated_tail isolated_head <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_isolated_verts_da0 card_insert_if<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-G_edge_succ_a'"><span class="command">lemma</span></span> G_edge_succ_a'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"edge_succ <span class="free">M</span> a' <span class="main">=</span> a'"</span></span>
    <span class="keyword1"><span class="command">using</span></span> G_edge_succ_a'_no_loop no_loop_a <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Planar_Subgraph-G_edge_succ_a"><span class="command">lemma</span></span> G_edge_succ_a<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"edge_succ <span class="free">M</span> <span class="free">a</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"out_arcs <span class="free">G</span> <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a_in isolated_tail isolated_head no_loop_a
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H.isolated_verts_def verts_H out_arcs_def arcs_H tail_H<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"edge_succ <span class="free">M</span> <span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> G.edge_succ_cyclic<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="free">a</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eq_on_cyclic_on_iff1<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> * a_in a_neq_a' no_loop_a <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-G_face_cycle_succ_a"><span class="command">lemma</span></span>
    G_face_cycle_succ_a<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"G.face_cycle_succ <span class="free">a</span> <span class="main">=</span> a'"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    G_face_cycle_succ_a'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"G.face_cycle_succ a' <span class="main">=</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.face_cycle_succ_def<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-G_face_cycle_set_a"><span class="command">lemma</span></span>
    G_face_cycle_set_a<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"G.face_cycle_set <span class="free">a</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span>a'<span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?t1</span></span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    G_face_cycle_set_a'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"G.face_cycle_set a' <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span>a'<span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?t2</span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>G.face_cycle_succ <span class="main">^^</span> <span class="skolem">n</span><span class="main">)</span> <span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span>a'<span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>G.face_cycle_succ <span class="main">^^</span> <span class="skolem">n</span><span class="main">)</span> a' <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span>a'<span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?t1</span></span></span> <span class="var"><span class="quoted"><span class="var">?t2</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.face_cycle_set_altdef <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-card_face_cycle_sets_da"><span class="command">lemma</span></span> card_face_cycle_sets_da<span class="main">:</span> <span class="quoted"><span class="quoted">"card G.face_cycle_sets <span class="main">=</span> Suc <span class="main">(</span>card H.face_cycle_sets<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> card_face_cycle_sets_da0 <span class="keyword1"><span class="command">using</span></span> card_fcs_aa'_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Planar_Subgraph-euler_genus_da"><span class="command">lemma</span></span> euler_genus_da<span class="main">:</span> <span class="quoted"><span class="quoted">"H.euler_genus <span class="main">=</span> G.euler_genus"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> G.euler_genus_def H.euler_genus_def G.euler_char_def H.euler_char_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_isolated_verts_da verts_H card_arcs_da card_face_cycle_sets_da card_sccs_da<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> bidel_arc_tail_not_isol <span class="main">=</span> bidel_arc_not_biconnected <span class="main">+</span>
  bidel_arc_tail_conn

<span class="keyword1"><span class="command">sublocale</span></span> bidel_arc_tail_not_isol <span class="main">⊆</span> bidel_arc_same_face_tail_conn
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="keyword1"><span class="command">locale</span></span> bidel_arc_only_tail_not_isol <span class="main">=</span> bidel_arc_tail_not_isol <span class="main">+</span>
  bidel_arc_head_isolated

<span class="keyword1"><span class="command">context</span></span> bidel_arc_only_tail_not_isol
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Planar_Subgraph-card_isolated_verts_da"><span class="command">lemma</span></span> card_isolated_verts_da<span class="main">:</span> <span class="quoted"><span class="quoted">"card H.isolated_verts <span class="main">=</span> Suc <span class="main">(</span>card G.isolated_verts<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> isolated_head conn_tail <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_isolated_verts_da0<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-segment_a'_a_ne"><span class="command">lemma</span></span> segment_a'_a_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"segment G.face_cycle_succ a' <span class="free">a</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> H_fcs_a_neigh<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Planar_Subgraph-segment_a_a'_e"><span class="command">lemma</span></span> segment_a_a'_e<span class="main">:</span> <span class="quoted"><span class="quoted">"segment G.face_cycle_succ <span class="free">a</span> a' <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a' <span class="main">=</span> G.face_cycle_succ <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tail_neq_head
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> G_face_cycle_succ_a_no_loop<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> segment1_empty<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-card_face_cycle_sets_da"><span class="command">lemma</span></span> card_face_cycle_sets_da<span class="main">:</span> <span class="quoted"><span class="quoted">"card H.face_cycle_sets <span class="main">=</span> card G.face_cycle_sets"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> card_face_cycle_sets_da' <span class="keyword1"><span class="command">using</span></span> segment_a'_a_ne segment_a_a'_e card_fcs_gt_0
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_insert_if<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-euler_genus_da"><span class="command">lemma</span></span> euler_genus_da<span class="main">:</span> <span class="quoted"><span class="quoted">"H.euler_genus <span class="main">=</span> G.euler_genus"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> G.euler_genus_def H.euler_genus_def G.euler_char_def H.euler_char_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_isolated_verts_da verts_H card_arcs_da card_face_cycle_sets_da card_sccs_da<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> bidel_arc_only_head_not_isol <span class="main">=</span> bidel_arc_not_biconnected <span class="main">+</span>
  bidel_arc_head_conn <span class="main">+</span>
  bidel_arc_tail_isolated
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">interpretation</span></span> rev<span class="main">:</span> bidel_arc <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quoted">a'</span>
    <span class="keyword1"><span class="command">using</span></span> a_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">interpretation</span></span> rev<span class="main">:</span> bidel_arc_only_tail_not_isol <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quoted">a'</span>
    <span class="keyword1"><span class="command">using</span></span> a_in not_reach_a
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rev_H isolated_tail conn_head <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> H.symmetric_reachable'<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-euler_genus_da"><span class="command">lemma</span></span> euler_genus_da<span class="main">:</span> <span class="quoted"><span class="quoted">"H.euler_genus <span class="main">=</span> G.euler_genus"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rev.euler_genus_da <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_H rev_HM<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> bidel_arc_two_not_isol <span class="main">=</span> bidel_arc_tail_not_isol <span class="main">+</span>
  bidel_arc_head_conn
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Planar_Subgraph-isolated_verts_da"><span class="command">lemma</span></span> isolated_verts_da<span class="main">:</span> <span class="quoted"><span class="quoted">"H.isolated_verts <span class="main">=</span> G.isolated_verts"</span></span>
    <span class="keyword1"><span class="command">using</span></span> conn_head conn_tail <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> isolated_da_pre<span class="main">)</span> <span class="operator">simp</span>

  <span class="keyword1" id="Planar_Subgraph-segment_a'_a_ne'"><span class="command">lemma</span></span> segment_a'_a_ne'<span class="main">:</span> <span class="quoted"><span class="quoted">"segment G.face_cycle_succ a' <span class="free">a</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> H_fcs_a_neigh<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">interpretation</span></span> rev<span class="main">:</span> bidel_arc_tail_not_isol <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quoted">a'</span>
    <span class="keyword1"><span class="command">using</span></span> arcs_in not_reach_a rev_H conn_head
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> H.symmetric_reachable'<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-segment_a_a'_ne'"><span class="command">lemma</span></span> segment_a_a'_ne'<span class="main">:</span> <span class="quoted"><span class="quoted">"segment G.face_cycle_succ <span class="free">a</span> a' <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rev.H_fcs_a_neigh<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> rev_H rev_HM <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Planar_Subgraph-card_face_cycle_sets_da"><span class="command">lemma</span></span> card_face_cycle_sets_da<span class="main">:</span> <span class="quoted"><span class="quoted">"card H.face_cycle_sets <span class="main">=</span> Suc <span class="main">(</span>card G.face_cycle_sets<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> card_face_cycle_sets_da' <span class="keyword1"><span class="command">using</span></span> segment_a'_a_ne' segment_a_a'_ne' card_fcs_gt_0
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> segments_neq card_insert_if<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-euler_genus_da"><span class="command">lemma</span></span> euler_genus_da<span class="main">:</span> <span class="quoted"><span class="quoted">"H.euler_genus <span class="main">=</span> G.euler_genus"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> G.euler_genus_def H.euler_genus_def G.euler_char_def H.euler_char_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> isolated_verts_da verts_H card_arcs_da card_face_cycle_sets_da card_sccs_da<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> bidel_arc_biconnected_non_triv <span class="main">=</span> bidel_arc_biconnected <span class="main">+</span>
  bidel_arc_tail_conn

<span class="keyword1"><span class="command">sublocale</span></span> bidel_arc_biconnected_non_triv <span class="main">⊆</span> bidel_arc_head_conn
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> G.in_sccs_verts_conv_reachable G.symmetric_reachable'
    H.isolated_verts_in_sccs conn_tail empty_iff insert_iff reach_a reachable_daD sccs_verts_da<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> bidel_arc_biconnected_non_triv <span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Planar_Subgraph-isolated_verts_da"><span class="command">lemma</span></span> isolated_verts_da<span class="main">:</span> <span class="quoted"><span class="quoted">"H.isolated_verts <span class="main">=</span> G.isolated_verts"</span></span>
    <span class="keyword1"><span class="command">using</span></span> conn_head conn_tail <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> isolated_da_pre<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> bidel_arc_biconnected_same <span class="main">=</span> bidel_arc_biconnected_non_triv <span class="main">+</span>
  bidel_arc_same_face

<span class="keyword1"><span class="command">sublocale</span></span> bidel_arc_biconnected_same <span class="main">⊆</span> bidel_arc_same_face_tail_conn
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>


<span class="keyword1"><span class="command">context</span></span> bidel_arc_biconnected_same <span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">interpretation</span></span> rev<span class="main">:</span> bidel_arc_same_face_tail_conn <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quoted">a'</span>
    <span class="keyword1"><span class="command">using</span></span> arcs_in conn_head <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> same_face rev_H<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-card_face_cycle_sets_da"><span class="command">lemma</span></span> card_face_cycle_sets_da<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>card H.face_cycle_sets<span class="main">)</span> <span class="main">≥</span> <span class="main">(</span>card G.face_cycle_sets<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> card_face_cycle_sets_da' <span class="keyword1"><span class="command">using</span></span> card_fcs_gt_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>

  <span class="keyword1" id="Planar_Subgraph-euler_genus_da"><span class="command">lemma</span></span> euler_genus_da<span class="main">:</span> <span class="quoted"><span class="quoted">"H.euler_genus <span class="main">≤</span> G.euler_genus"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_face_cycle_sets_da
    <span class="keyword1"><span class="command">unfolding</span></span> G.euler_genus_def H.euler_genus_def G.euler_char_def H.euler_char_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> isolated_verts_da verts_H card_arcs_da card_sccs_da <span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>



<span class="keyword1"><span class="command">locale</span></span> bidel_arc_biconnected_diff <span class="main">=</span> bidel_arc_biconnected_non_triv <span class="main">+</span>
  bidel_arc_diff_face
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Planar_Subgraph-fcs_not_triv"><span class="command">lemma</span></span> fcs_not_triv<span class="main">:</span> <span class="quoted"><span class="quoted">"G.face_cycle_set <span class="free">a</span> <span class="main">≠</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">∨</span> G.face_cycle_set a' <span class="main">≠</span> <span class="main">{</span>a'<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"G.face_cycle_succ <span class="free">a</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"G.face_cycle_succ a' <span class="main">=</span> a'"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.fcs_x_eq_x<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"edge_succ <span class="free">M</span> <span class="free">a</span> <span class="main">=</span> a'"</span></span> <span class="quoted"><span class="quoted">"edge_succ <span class="free">M</span> a' <span class="main">=</span> <span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.face_cycle_succ_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>edge_succ <span class="free">M</span> <span class="main">^^</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_nat_numeral<span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>edge_succ <span class="free">M</span> <span class="main">^^</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> * eval_nat_numeral<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>edge_succ <span class="free">M</span> <span class="main">^^</span> <span class="skolem">n</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span>edge_succ <span class="free">M</span> <span class="main">^^</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> funpow_mod_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">n</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>edge_succ <span class="free">M</span> <span class="main">^^</span> <span class="skolem">n</span><span class="main">)</span> <span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span> a'<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"orbit <span class="main">(</span>edge_succ <span class="free">M</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span> a'<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> orbit_altdef_permutation<span class="main"><span class="main">[</span></span><span class="operator">OF</span> G.permutation_edge_succ<span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span> *<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"out_arcs <span class="free">G</span> <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span>a'<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cyclic_on <span class="main">(</span>edge_succ <span class="free">M</span><span class="main">)</span> <span class="main">(</span>out_arcs <span class="free">G</span> <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> arcs_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> G.edge_succ_cyclic<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"orbit <span class="main">(</span>edge_succ <span class="free">M</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> out_arcs <span class="free">G</span> <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> arcs_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> orbit_cyclic_eq3<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹orbit <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">{</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"out_arcs H <span class="main">(</span>tail <span class="free">G</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_H tail_H<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="free">a</span> <span class="main">∈</span> H.isolated_verts"</span></span> <span class="keyword1"><span class="command">using</span></span> arcs_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> H.isolated_verts_def verts_H<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> conn_tail <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-S_ne"><span class="command">lemma</span></span> S_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"S <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fcs_not_triv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def G.segment_face_cycle_x_x_eq<span class="main">)</span>

  <span class="keyword1" id="Planar_Subgraph-card_face_cycle_sets_da"><span class="command">lemma</span></span> card_face_cycle_sets_da<span class="main">:</span> <span class="quoted"><span class="quoted">"card G.face_cycle_sets <span class="main">=</span> Suc <span class="main">(</span>card H.face_cycle_sets<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> card_face_cycle_sets_da' <span class="keyword1"><span class="command">using</span></span> S_ne diff_face card_fcs_aa'_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Planar_Subgraph-euler_genus_da"><span class="command">lemma</span></span> euler_genus_da<span class="main">:</span> <span class="quoted"><span class="quoted">"H.euler_genus <span class="main">=</span> G.euler_genus"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> G.euler_genus_def H.euler_genus_def G.euler_char_def H.euler_char_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> isolated_verts_da verts_H card_arcs_da card_sccs_da card_face_cycle_sets_da<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>



<span class="keyword1"><span class="command">context</span></span> bidel_arc <span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Planar_Subgraph-euler_genus_da"><span class="command">lemma</span></span> euler_genus_da<span class="main">:</span> <span class="quoted"><span class="quoted">"H.euler_genus <span class="main">≤</span> G.euler_genus"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?biconnected</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="free">a</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span><span class="hidden">⇘</span><sub>H</sub><span class="hidden">⇙</span> head <span class="free">G</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?isol_tail</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="free">a</span> <span class="main">∈</span> H.isolated_verts"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?isol_head</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="free">a</span> <span class="main">∈</span> H.isolated_verts"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?same_face</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"G.face_cycle_set a' <span class="main">=</span> G.face_cycle_set <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?biconnected</span></span></span> <span class="var"><span class="quoted"><span class="var">?isol_tail</span></span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> EG<span class="main">:</span> bidel_arc_isolated_loop <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EG.euler_genus_da<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?biconnected</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="var">?isol_tail</span>"</span></span> <span class="var"><span class="quoted"><span class="var">?same_face</span></span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> EG<span class="main">:</span> bidel_arc_biconnected_same <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EG.euler_genus_da<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?biconnected</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="var">?isol_tail</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="var">?same_face</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> EG<span class="main">:</span> bidel_arc_biconnected_diff <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EG.euler_genus_da<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="var">?biconnected</span>"</span></span> <span class="var"><span class="quoted"><span class="var">?isol_tail</span></span></span> <span class="var"><span class="quoted"><span class="var">?isol_head</span></span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> EG<span class="main">:</span> bidel_arc_two_isolated <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EG.euler_genus_da<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="var">?biconnected</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="var">?isol_tail</span>"</span></span> <span class="var"><span class="quoted"><span class="var">?isol_head</span></span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> EG<span class="main">:</span> bidel_arc_only_tail_not_isol <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EG.euler_genus_da<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="var">?biconnected</span>"</span></span> <span class="var"><span class="quoted"><span class="var">?isol_tail</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="var">?isol_head</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> EG<span class="main">:</span> bidel_arc_only_head_not_isol <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EG.euler_genus_da<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="var">?biconnected</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="var">?isol_tail</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="var">?isol_head</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> EG<span class="main">:</span> bidel_arc_two_not_isol <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EG.euler_genus_da<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">satx</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Modifying <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">edge_rev</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pre_digraph_map<span class="main">)</span> <span class="entity">rev_swap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> pre_map"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rev_swap</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">⦇</span> edge_rev <span class="main">=</span> perm_swap <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>edge_rev <span class="free">M</span><span class="main">)</span><span class="main">,</span> edge_succ <span class="main">=</span> perm_swap <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>edge_succ <span class="free">M</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> digraph_map <span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Planar_Subgraph-digraph_map_rev_swap"><span class="command">lemma</span></span> digraph_map_rev_swap<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"arc_to_ends <span class="free">G</span> <span class="free">a</span> <span class="main">=</span> arc_to_ends <span class="free">G</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> arcs <span class="free">G</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"digraph_map <span class="free">G</span> <span class="main">(</span>rev_swap <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rev_swap <span class="free">a</span> <span class="free">b</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> tail_swap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> tail <span class="free">G</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">b</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> tail <span class="free">G</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">}</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arc_to_ends_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> swap_in_arcs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">b</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∈</span> arcs <span class="free">G</span> <span class="main">⟷</span> <span class="bound">x</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">}</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> es_perm<span class="main">:</span> <span class="quoted"><span class="quoted">"edge_succ <span class="var">?M'</span> <span class="keyword1">permutes</span> arcs <span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms edge_succ_permutes <span class="keyword1"><span class="command">unfolding</span></span> permutes_conv_has_dom
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rev_swap_def has_dom_perm_swap<span class="main">)</span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> arcs <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>edge_rev <span class="main">(</span>rev_swap <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">}</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rev_swap_def perm_swap_def arev_dom swap_id_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"edge_rev <span class="var">?M'</span> <span class="main">(</span>edge_rev <span class="var">?M'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rev_swap_def perm_swap_comp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="main">(</span>edge_rev <span class="var">?M'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> head <span class="free">G</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">}</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rev_swap_def perm_swap_def tail_swap arc_to_ends_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"edge_succ <span class="var">?M'</span> <span class="keyword1">permutes</span> arcs <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> verts <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"out_arcs <span class="free">G</span> <span class="skolem">v</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> out_arcs <span class="free">G</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span>perm_swap <span class="free">a</span> <span class="free">b</span> <span class="main">(</span>edge_succ <span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_is_inj bij_edge_succ<span class="main">)</span>
  
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"out_arcs <span class="free">G</span> <span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">b</span><span class="main">)</span> <span class="main">`</span> out_arcs <span class="free">G</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tail_swap swap_swap_id swap_in_arcs <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">b</span><span class="main">)</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">y</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">b</span><span class="main">)</span> <span class="main">`</span>  out_arcs <span class="free">G</span> <span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">b</span><span class="main">)</span> <span class="main">`</span>  orbit <span class="main">(</span>edge_succ <span class="free">M</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">b</span><span class="main">)</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> edge_succ_cyclic <span class="keyword1"><span class="command">using</span></span> A <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(`)</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="free"><span class="free"><span class="free">a</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span></span></span> <span class="free"><span class="free"><span class="free">b</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="main">(</span><span class="operator">intro</span> orbit_cyclic_eq3<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> swap_in_arcs tail_swap<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> orbit <span class="main">(</span>edge_succ <span class="var">?M'</span><span class="main">)</span> <span class="skolem">c</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> orbit_perm_swap rev_swap_def<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> oa_orb<span class="main">:</span> <span class="quoted"><span class="quoted">"out_arcs <span class="free">G</span> <span class="skolem">v</span> <span class="main">=</span> orbit <span class="main">(</span>edge_succ <span class="var">?M'</span><span class="main">)</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cyclic_on <span class="main">(</span>edge_succ <span class="var">?M'</span><span class="main">)</span> <span class="main">(</span>out_arcs <span class="free">G</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> oa_orb <span class="keyword1"><span class="command">using</span></span> es_perm finite_arcs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cyclic_on_orbit<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Planar_Subgraph-euler_genus_rev_swap"><span class="command">lemma</span></span> euler_genus_rev_swap<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"arc_to_ends <span class="free">G</span> <span class="free">a</span> <span class="main">=</span> arc_to_ends <span class="free">G</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> arcs <span class="free">G</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pre_digraph_map.euler_genus <span class="free">G</span> <span class="main">(</span>rev_swap <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> euler_genus"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rev_swap <span class="free">a</span> <span class="free">b</span>"</span></span>
  
    <span class="keyword1"><span class="command">interpret</span></span> G'<span class="main">:</span> digraph_map <span class="quoted"><span class="free">G</span></span> <span class="var"><span class="quoted"><span class="var">?M'</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> digraph_map_rev_swap<span class="main">)</span>
  
    <span class="keyword1"><span class="command">have</span></span> swap_in_arcs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">b</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∈</span> arcs <span class="free">G</span> <span class="main">⟷</span> <span class="bound">x</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">}</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  
    <span class="keyword1"><span class="command">have</span></span> G'_fcs<span class="main">:</span> <span class="quoted"><span class="quoted">"G'.face_cycle_succ <span class="main">=</span> perm_swap <span class="free">a</span> <span class="free">b</span> face_cycle_succ"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> G'.face_cycle_succ_def face_cycle_succ_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff rev_swap_def perm_swap_comp<span class="main">)</span>
  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> G'.face_cycle_set <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">b</span><span class="main">)</span> <span class="main">`</span> face_cycle_set <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">b</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> face_cycle_set_def G'.face_cycle_set_def orbit_perm_swap G'_fcs imageI<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"G'.face_cycle_sets <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">b</span><span class="main">)</span> <span class="main">`</span> <span class="bound">S</span><span class="main">)</span> <span class="main">`</span> face_cycle_sets"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_digraph_map.face_cycle_sets_def swap_in_arcs<span class="main">)</span>
         <span class="main">(</span><span class="operator">metis</span> swap_swap_id image_eqI swap_in_arcs<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card G'.face_cycle_sets <span class="main">=</span> card <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">⇌<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">b</span><span class="main">)</span> <span class="main">`</span> <span class="bound">S</span><span class="main">)</span> <span class="main">`</span> face_cycle_sets<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card face_cycle_sets"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_image<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> inj_on_f_imageI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"UNIV"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pre_digraph_map.euler_genus <span class="free">G</span> <span class="var">?M'</span> <span class="main">=</span> euler_genus"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pre_digraph_map.euler_genus_def pre_digraph_map.euler_char_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Conclusion›</span></span>

<span class="keyword1" id="Planar_Subgraph-bidirected_subgraph_obtain"><span class="command">lemma</span></span> bidirected_subgraph_obtain<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sg<span class="main">:</span> <span class="quoted"><span class="quoted">"subgraph <span class="free">H</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"arcs <span class="free">H</span> <span class="main">≠</span> arcs <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>arcs <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bidir<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">rev</span><span class="main">.</span> bidirected_digraph <span class="free">G</span> <span class="bound">rev</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">rev</span><span class="main">.</span> bidirected_digraph <span class="free">H</span> <span class="bound">rev</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="free">a'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">,</span><span class="free">a'</span><span class="main">}</span> <span class="main">⊆</span> arcs <span class="free">G</span> <span class="main">-</span> arcs <span class="free">H</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a'</span> <span class="main">≠</span> <span class="free">a</span>"</span></span>
    <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="free">a'</span> <span class="main">=</span> head <span class="free">G</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="free">a'</span><span class="main">=</span> tail <span class="free">G</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> arcs <span class="free">G</span> <span class="main">-</span> arcs <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sg <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rev_G</span></span> <span class="skolem"><span class="skolem">rev_H</span></span> <span class="keyword2"><span class="keyword">where</span></span> rev<span class="main">:</span> <span class="quoted"><span class="quoted">"bidirected_digraph <span class="free">G</span> <span class="skolem">rev_G</span>"</span></span> <span class="quoted"><span class="quoted">"bidirected_digraph <span class="free">H</span> <span class="skolem">rev_H</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bidir <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">interpret</span></span> G<span class="main">:</span> bidirected_digraph <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="skolem">rev_G</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rev<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> H<span class="main">:</span> bidirected_digraph <span class="quoted"><span class="free">H</span></span> <span class="quoted"><span class="skolem">rev_H</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rev<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> sg_props<span class="main">:</span> <span class="quoted"><span class="quoted">"arcs <span class="free">H</span> <span class="main">⊆</span> arcs <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"tail <span class="free">H</span> <span class="main">=</span> tail <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"head <span class="free">H</span> <span class="main">=</span> head <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sg <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subgraph_def compatible_def<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w1</span> <span class="skolem">w2</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">w1</span>"</span></span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">w2</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"in_arcs <span class="free">H</span> <span class="skolem">w1</span> <span class="main">∩</span> out_arcs <span class="free">H</span> <span class="skolem">w2</span> <span class="main">=</span> <span class="skolem">rev_H</span> <span class="main">`</span> <span class="main">(</span>out_arcs <span class="free">H</span> <span class="skolem">w1</span> <span class="main">∩</span> in_arcs <span class="free">H</span> <span class="skolem">w2</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Sh</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> H.in_arcs_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_Int image_image H.inj_on_arev<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>in_arcs <span class="free">H</span> <span class="skolem">w1</span> <span class="main">∩</span> out_arcs <span class="free">H</span> <span class="skolem">w2</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>out_arcs <span class="free">H</span> <span class="skolem">w1</span> <span class="main">∩</span> in_arcs <span class="free">H</span> <span class="skolem">w2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_image H.arev_arev inj_on_inverseI<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> card <span class="main">(</span>out_arcs <span class="free">G</span> <span class="skolem">w1</span> <span class="main">∩</span> in_arcs <span class="free">G</span> <span class="skolem">w2</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?Sh1</span> <span class="main">&lt;</span> card <span class="var">?Sg1</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> psubset_card_mono<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?Sg1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fin <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> out_arcs_def<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Sh1</span> <span class="main">⊂</span> <span class="var">?Sg1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A a sg_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Sg1</span> <span class="main">=</span> <span class="skolem">rev_G</span> <span class="main">`</span> <span class="main">(</span>in_arcs <span class="free">G</span> <span class="skolem">w1</span> <span class="main">∩</span> out_arcs <span class="free">G</span> <span class="skolem">w2</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">`</span> <span class="var">?Sg</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> G.in_arcs_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_Int image_image G.inj_on_arev<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">…</span> <span class="main">=</span> card <span class="var">?Sg</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_image G.arev_arev inj_on_inverseI<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> card_less<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?Sh</span> <span class="main">&lt;</span> card <span class="var">?Sg</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

    <span class="keyword1"><span class="command">have</span></span> S_ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Sh</span> <span class="main">⊆</span> <span class="var">?Sg</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sg_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span> <span class="main">=</span> <span class="skolem">w2</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?Sh</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> card <span class="var">?Sh</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">card</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> card <span class="var">?Sg</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"even <span class="main">(</span>card <span class="var">?Sg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"even <span class="main">(</span>card <span class="var">?Sh</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.even_card_loops H.even_card_loops<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> card_less
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> Suc_pred even_Suc le_neq_implies_less lessE less_Suc_eq_le zero_less_Suc<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">(</span><span class="var">?Sg</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fin a A True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> out_arcs_def card_Diff_singleton<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> card_diff_a_less<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?Sh</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span> <span class="main">&lt;</span> card <span class="main">(</span><span class="var">?Sg</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> S_ss <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Sh</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span> <span class="main">⊆</span> <span class="var">?Sg</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> S_ss <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Sh</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span> <span class="main">⊂</span> <span class="var">?Sg</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_psubset<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">∈</span> <span class="main">(</span><span class="var">?Sg</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span><span class="main">-</span> <span class="var">?Sh</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">a'</span><span class="main">}</span> <span class="main">⊆</span> arcs <span class="free">G</span> <span class="main">-</span> arcs <span class="free">H</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">≠</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="skolem">a'</span> <span class="main">=</span> head <span class="free">G</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="skolem">a'</span><span class="main">=</span> tail <span class="free">G</span> <span class="skolem">a</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> A a sg_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">from</span></span> card_less S_ss <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Sh</span> <span class="main">⊂</span> <span class="var">?Sg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">∈</span> <span class="var">?Sg</span> <span class="main">-</span> <span class="var">?Sh</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">a'</span><span class="main">}</span> <span class="main">⊆</span> arcs <span class="free">G</span> <span class="main">-</span> arcs <span class="free">H</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">≠</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="skolem">a'</span> <span class="main">=</span> head <span class="free">G</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="skolem">a'</span><span class="main">=</span> tail <span class="free">G</span> <span class="skolem">a</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> A a sg_props False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Planar_Subgraph-subgraph_euler_genus_le"><span class="command">lemma</span></span> subgraph_euler_genus_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"subgraph <span class="free">H</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"digraph_map <span class="free">G</span> <span class="free">GM</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">rev</span><span class="main">.</span> bidirected_digraph <span class="free">H</span> <span class="bound">rev</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">HM</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"digraph_map <span class="free">H</span> <span class="free">HM</span>"</span></span> <span class="quoted"><span class="quoted">"pre_digraph_map.euler_genus <span class="free">H</span> <span class="free">HM</span> <span class="main">≤</span> pre_digraph_map.euler_genus <span class="free">G</span> <span class="free">GM</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">G</span><span class="main">.</span> card <span class="main">(</span>arcs <span class="bound">G</span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span>verts <span class="bound">G</span><span class="main">)</span> <span class="main">-</span> card <span class="main">(</span>arcs <span class="free">H</span><span class="main">)</span> <span class="main">-</span> card <span class="main">(</span>verts <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> H <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rev_H</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"bidirected_digraph <span class="free">H</span> <span class="skolem">rev_H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> H<span class="main">:</span> bidirected_digraph <span class="quoted"><span class="free">H</span></span> <span class="quoted"><span class="skolem">rev_H</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">from</span></span> G
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">HM</span><span class="main">.</span> digraph_map <span class="free">H</span> <span class="bound">HM</span> <span class="main">∧</span> pre_digraph_map.euler_genus <span class="free">H</span> <span class="bound">HM</span> <span class="main">≤</span> pre_digraph_map.euler_genus <span class="free">G</span> <span class="free">GM</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="var">?d</span> <span class="free">G</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="free">GM</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> less

    <span class="keyword1"><span class="command">from</span></span> less <span class="keyword1"><span class="command">interpret</span></span> G<span class="main">:</span> digraph_map <span class="quoted"><span class="skolem">G</span></span> <span class="quoted"><span class="skolem">GM</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span>

    <span class="keyword1"><span class="command">have</span></span> H_ss<span class="main">:</span> <span class="quoted"><span class="quoted">"arcs <span class="free">H</span> <span class="main">⊆</span> arcs <span class="skolem">G</span>"</span></span> <span class="quoted"><span class="quoted">"verts <span class="free">H</span> <span class="main">⊆</span> verts <span class="skolem">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹subgraph <span class="free">H</span> <span class="skolem">G</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> card_le<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>arcs <span class="free">H</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>arcs <span class="skolem">G</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>verts <span class="free">H</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>verts <span class="skolem">G</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> ends<span class="main">:</span> <span class="quoted"><span class="quoted">"tail <span class="free">H</span> <span class="main">=</span> tail <span class="skolem">G</span>"</span></span> <span class="quoted"><span class="quoted">"head <span class="free">H</span> <span class="main">=</span> head <span class="skolem">G</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹subgraph <span class="free">H</span> <span class="skolem">G</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> compatible_def<span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?d</span> <span class="skolem">G</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>arcs <span class="free">H</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>arcs <span class="skolem">G</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>verts <span class="free">H</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>verts <span class="skolem">G</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> card_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arcs <span class="free">H</span> <span class="main">=</span> arcs <span class="skolem">G</span>"</span></span> <span class="quoted"><span class="quoted">"verts <span class="free">H</span> <span class="main">=</span> verts <span class="skolem">G</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> H_ss <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_subset_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">=</span> <span class="skolem">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹subgraph <span class="free">H</span> <span class="skolem">G</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> compatible_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"digraph_map <span class="free">H</span> <span class="skolem">GM</span> <span class="main">∧</span> pre_digraph_map.euler_genus <span class="free">H</span> <span class="skolem">GM</span> <span class="main">≤</span> G.euler_genus"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> H_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>arcs <span class="skolem">G</span> <span class="main">-</span> arcs <span class="free">H</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∨</span> <span class="main">(</span>verts <span class="skolem">G</span> <span class="main">-</span> verts <span class="free">H</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> H_ss card_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"arcs <span class="skolem">G</span> <span class="main">-</span> arcs <span class="free">H</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="keyword2"><span class="keyword">where</span></span> aa'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">a'</span><span class="main">}</span> <span class="main">⊆</span> arcs <span class="skolem">G</span> <span class="main">-</span> arcs <span class="free">H</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">≠</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"tail <span class="skolem">G</span> <span class="skolem">a'</span> <span class="main">=</span> head <span class="skolem">G</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">G</span> <span class="skolem">a'</span> <span class="main">=</span> tail <span class="skolem">G</span> <span class="skolem">a</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> H_ss <span class="quoted"><span class="quoted">‹subgraph <span class="free">H</span> <span class="skolem">G</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> bidirected_subgraph_obtain<span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?GM'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"G.rev_swap <span class="main">(</span>edge_rev <span class="skolem">GM</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">a'</span>"</span></span>

        <span class="keyword1"><span class="command">interpret</span></span> G'<span class="main">:</span> digraph_map <span class="quoted"><span class="skolem">G</span></span> <span class="var"><span class="quoted"><span class="var">?GM'</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> aa' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> G.digraph_map_rev_swap<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arc_to_ends_def<span class="main">)</span>
        <span class="keyword1"><span class="command">interpret</span></span> G'<span class="main">:</span> bidel_arc <span class="quoted"><span class="skolem">G</span></span> <span class="var"><span class="quoted"><span class="var">?GM'</span></span></span> <span class="quoted"><span class="skolem">a</span></span>
          <span class="keyword1"><span class="command">using</span></span> aa' <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"edge_rev <span class="skolem">GM</span> <span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">a</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> aa' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> G.arev_neq<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> er_a<span class="main">:</span> <span class="quoted"><span class="quoted">"edge_rev <span class="var">?GM'</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">a'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a'</span> <span class="main">≠</span> <span class="skolem">a</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.rev_swap_def perm_swap_def swap_id_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> G.arev_neq<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sg<span class="main">:</span> <span class="quoted"><span class="quoted">"subgraph <span class="free">H</span> G'.H"</span></span>
          <span class="keyword1"><span class="command">using</span></span> H_ss aa' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subgraphI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G'.verts_H G'.arcs_H G'.tail_H G'.head_H ends compatible_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> H.wf_digraph G'.H.wf_digraph<span class="main">)</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">a'</span><span class="main">}</span> <span class="main">≤</span> card <span class="main">(</span>arcs <span class="skolem">G</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> aa' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_mono<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">HM</span></span> <span class="keyword2"><span class="keyword">where</span></span> HM<span class="main">:</span> <span class="quoted"><span class="quoted">"digraph_map <span class="free">H</span> <span class="skolem">HM</span>"</span></span> <span class="quoted"><span class="quoted">"pre_digraph_map.euler_genus <span class="free">H</span> <span class="skolem">HM</span> <span class="main">≤</span> G'.H.euler_genus"</span></span>
          <span class="keyword1"><span class="command">using</span></span> aa' False <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">rule</span> less<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G'.verts_H G'.arcs_H  card_insert_if sg er_a<span class="main">)</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"G'.H.euler_genus <span class="main">≤</span> G'.euler_genus"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> G'.euler_genus_da<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"G'.euler_genus <span class="main">=</span> G.euler_genus"</span></span>
          <span class="keyword1"><span class="command">using</span></span> aa' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.euler_genus_rev_swap arc_to_ends_def<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> HM <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"arcs <span class="skolem">G</span> <span class="main">-</span> arcs <span class="free">H</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> A'<span class="main">:</span> <span class="quoted"><span class="quoted">"verts <span class="skolem">G</span> <span class="main">-</span> verts <span class="free">H</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> arcs_H<span class="main">:</span> <span class="quoted"><span class="quoted">"arcs <span class="free">H</span> <span class="main">=</span> arcs <span class="skolem">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H_ss H_ne <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> verts <span class="skolem">G</span> <span class="main">-</span> verts <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> card_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>verts <span class="free">H</span><span class="main">)</span> <span class="main">&lt;</span> card <span class="main">(</span>verts <span class="skolem">G</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> A' H_ss <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> psubset_card_mono<span class="main">)</span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"out_arcs <span class="skolem">G</span> <span class="skolem">v</span> <span class="main">=</span> out_arcs <span class="free">H</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A H_ss <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ends<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> G<span class="main">:</span> del_vert_props <span class="quoted"><span class="skolem">G</span></span> <span class="quoted"><span class="skolem">GM</span></span> <span class="quoted"><span class="skolem">v</span></span>
          <span class="keyword1"><span class="command">using</span></span> v <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?d</span> <span class="main">(</span>G.del_vert <span class="skolem">v</span><span class="main">)</span> <span class="main">&lt;</span> <span class="var">?d</span> <span class="skolem">G</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> card_lt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> arcs_H G.arcs_dv G.card_verts_dv<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subgraph <span class="free">H</span> <span class="main">(</span>G.del_vert <span class="skolem">v</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> H_ss v <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subgraph_def arcs_H G.arcs_dv G.verts_del_vert H.wf_digraph
            G.H.wf_digraph compatible_def G.tail_del_vert G.head_del_vert ends<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bidirected_digraph <span class="main">(</span>G.del_vert <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span>edge_rev <span class="skolem">GM</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> G.arev_dom <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> G.H.bidirected_digraphI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.arcs_dv<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> G.euler_genus_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> less<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">HM</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"digraph_map <span class="free">H</span> <span class="skolem">HM</span>"</span></span> <span class="quoted"><span class="quoted">"pre_digraph_map.euler_genus <span class="free">H</span> <span class="skolem">HM</span> <span class="main">≤</span> pre_digraph_map.euler_genus <span class="free">G</span> <span class="free">GM</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> digraph_map<span class="main">)</span> nonneg_euler_genus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> euler_genus"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">H</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> <span class="main">⦇</span> verts <span class="main">=</span> <span class="main">{}</span><span class="main">,</span> arcs <span class="main">=</span> <span class="main">{}</span><span class="main">,</span> tail <span class="main">=</span> tail <span class="free">G</span><span class="main">,</span> head <span class="main">=</span> head <span class="free">G</span> <span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> H_simps<span class="main">:</span> <span class="quoted"><span class="quoted">"verts <span class="skolem">H</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"arcs <span class="skolem">H</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"tail <span class="skolem">H</span> <span class="main">=</span> tail <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">H</span> <span class="main">=</span> head <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> H_def<span class="main">)</span>

  <span class="keyword1"><span class="command">interpret</span></span> H<span class="main">:</span> bidirected_digraph <span class="quoted"><span class="skolem">H</span></span> <span class="quoted">id</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_digraph <span class="skolem">H</span>"</span></span> <span class="quoted"><span class="quoted">"wf_digraph <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subgraph <span class="skolem">H</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subgraphI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H_def compatible_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">HM</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"digraph_map <span class="skolem">H</span> <span class="skolem">HM</span>"</span></span> <span class="quoted"><span class="quoted">"pre_digraph_map.euler_genus <span class="skolem">H</span> <span class="skolem">HM</span> <span class="main">≤</span> euler_genus"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subgraph_euler_genus_le<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> H<span class="main">:</span> digraph_map <span class="quoted"><span class="skolem">H</span></span> <span class="quoted"><span class="skolem">HM</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"H.sccs <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> H.sccs_verts"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> H.sccs_verts_subsets <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H_simps<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H.in_sccs_verts_conv_reachable<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H.sccs_verts_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"H.euler_genus <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H.euler_genus_def H.euler_char_def H.isolated_verts_def H.face_cycle_sets_def H_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹H.euler_genus <span class="main">≤</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Planar_Subgraph-subgraph_comb_planar"><span class="command">lemma</span></span> subgraph_comb_planar<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subgraph <span class="free">G</span> <span class="free">H</span>"</span></span> <span class="quoted"><span class="quoted">"comb_planar <span class="free">H</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">rev</span><span class="main">.</span> bidirected_digraph <span class="free">G</span> <span class="bound">rev</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"comb_planar <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹comb_planar <span class="free">H</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">HM</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"digraph_map <span class="free">H</span> <span class="skolem">HM</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> H_genus<span class="main">:</span> <span class="quoted"><span class="quoted">"pre_digraph_map.euler_genus <span class="free">H</span> <span class="skolem">HM</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> comb_planar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">GM</span></span> <span class="keyword2"><span class="keyword">where</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"digraph_map <span class="free">G</span> <span class="skolem">GM</span>"</span></span> <span class="quoted"><span class="quoted">"pre_digraph_map.euler_genus <span class="free">G</span> <span class="skolem">GM</span> <span class="main">≤</span> pre_digraph_map.euler_genus <span class="free">H</span> <span class="skolem">HM</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹digraph_map <span class="free">H</span> <span class="skolem">HM</span>›</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subgraph_euler_genus_le<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> G<span class="main">:</span> digraph_map <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="skolem">GM</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> G H_genus G.nonneg_euler_genus <span class="keyword1"><span class="command">unfolding</span></span> comb_planar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Kuratowski_Combinatorial">
<div class="head">
<h1>Theory Kuratowski_Combinatorial</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Kuratowski_Combinatorial
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Planar_Complete">Planar_Complete</a>
  <a href="#Planar_Subdivision">Planar_Subdivision</a>
  <a href="#Planar_Subgraph">Planar_Subgraph</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">theorem</span></span> comb_planar_compat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"comb_planar <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"kuratowski_planar <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="var">?thesis</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">G0</span></span> <span class="skolem"><span class="skolem">rev_G0</span></span> <span class="skolem"><span class="skolem">K</span></span> <span class="skolem"><span class="skolem">rev_K</span></span> <span class="keyword2"><span class="keyword">where</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"subgraph <span class="skolem">G0</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"subdivision <span class="main">(</span><span class="skolem">K</span><span class="main">,</span> <span class="skolem">rev_K</span><span class="main">)</span> <span class="main">(</span><span class="skolem">G0</span><span class="main">,</span> <span class="skolem">rev_G0</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> is_kur<span class="main">:</span> <span class="quoted"><span class="quoted">"K<span class="hidden">⇘</span><sub><span class="numeral">3</span><span class="main">,</span><span class="numeral">3</span></sub><span class="hidden">⇙</span> <span class="skolem">K</span> <span class="main">∨</span> K<span class="hidden">⇘</span><sub><span class="numeral">5</span></sub><span class="hidden">⇙</span> <span class="skolem">K</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> kuratowski_planar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"comb_planar <span class="skolem">K</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sub assms 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subgraph_comb_planar subdivision_comb_planar subdivision_bidir<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>comb_planar <span class="skolem">K</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> is_kur <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> K5_not_comb_planar K33_not_comb_planar<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Simpl_Anno">
<div class="head">
<h1>Theory Simpl_Anno</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Simpl_Anno <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../simpl/theories/#Vcg">Simpl.Vcg</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">named_loop</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">=</span> UNIV"</span></span>

<span class="keyword1" id="Simpl_Anno-annotate_named_loop_inv"><span class="command">lemma</span></span> annotate_named_loop_inv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"whileAnno <span class="free">b</span> <span class="main">(</span>named_loop <span class="free">name</span><span class="main">)</span> <span class="free">V</span> <span class="free">c</span> <span class="main">=</span> whileAnno <span class="free">b</span> <span class="free">I</span> <span class="free">V</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> whileAnno_def<span class="main">)</span>

<span class="keyword1" id="Simpl_Anno-annotate_named_loop_inv_fix"><span class="command">lemma</span></span> annotate_named_loop_inv_fix<span class="main">:</span>
  <span class="quoted"><span class="quoted">"whileAnno <span class="free">b</span> <span class="main">(</span>named_loop <span class="free">name</span><span class="main">)</span> <span class="free">V</span> <span class="free">c</span> <span class="main">=</span> whileAnnoFix <span class="free">b</span> <span class="free">I</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">V</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> whileAnno_def whileAnnoFix_def<span class="main">)</span>

<span class="keyword1" id="Simpl_Anno-annotate_named_loop_var"><span class="command">lemma</span></span> annotate_named_loop_var<span class="main">:</span>
  <span class="quoted"><span class="quoted">"whileAnno <span class="free">b</span> <span class="main">(</span>named_loop <span class="free">name</span><span class="main">)</span> <span class="free">V'</span> <span class="free">c</span> <span class="main">=</span> whileAnno <span class="free">b</span> <span class="free">I</span> <span class="free">V</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> whileAnno_def<span class="main">)</span>

<span class="keyword1" id="Simpl_Anno-annotate_named_loop_var_fix"><span class="command">lemma</span></span> annotate_named_loop_var_fix<span class="main">:</span>
  <span class="quoted"><span class="quoted">"whileAnno <span class="free">b</span> <span class="main">(</span>named_loop <span class="free">name</span><span class="main">)</span> <span class="free">V'</span> <span class="free">c</span> <span class="main">=</span> whileAnnoFix <span class="free">b</span> <span class="free">I</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">V</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> whileAnno_def whileAnnoFix_def<span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Check_Non_Planarity_Impl">
<div class="head">
<h1>Theory Check_Non_Planarity_Impl</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Implementation of a Non-Planarity Checker›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Check_Non_Planarity_Impl
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../simpl/theories/#Vcg">Simpl.Vcg</a>
  <a href="#Simpl_Anno">Simpl_Anno</a>
  <a href="../../graph_theory/theories/#Graph_Theory">Graph_Theory.Graph_Theory</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹An abstract graph datatype›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> ig_vertex <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> ig_edge <span class="main">=</span> <span class="quoted"><span class="quoted">"ig_vertex <span class="main">×</span> ig_vertex"</span></span>

<span class="keyword1"><span class="command">typedef</span></span> IGraph <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">vs</span> <span class="main">::</span> ig_vertex list<span class="main">,</span> <span class="bound">es</span> <span class="main">::</span> ig_edge list<span class="main">)</span><span class="main">.</span> distinct <span class="bound">vs</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ig_verts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">⇒</span> ig_vertex list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ig_verts</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> fst <span class="main">(</span>Rep_IGraph <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ig_arcs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">⇒</span> ig_edge list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ig_arcs</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> snd <span class="main">(</span>Rep_IGraph <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ig_verts_cnt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ig_verts_cnt</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> length <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ig_arcs_cnt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ig_arcs_cnt</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> length <span class="main">(</span>ig_arcs <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> ig_verts_cnt_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> ig_arcs_cnt_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">IGraph_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">IGraph_inv</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">.</span> fst <span class="bound">e</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">∧</span> snd <span class="bound">e</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ig_empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ig_empty</span> <span class="main">≡</span> Abs_IGraph <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ig_add_v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">⇒</span> ig_vertex <span class="main">⇒</span> IGraph"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ig_add_v</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1">else</span> Abs_IGraph <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">]</span><span class="main">,</span> ig_arcs <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ig_add_e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">⇒</span> ig_vertex <span class="main">⇒</span> ig_vertex <span class="main">⇒</span> IGraph"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ig_add_e</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> Abs_IGraph <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">,</span> ig_arcs <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ig_in_out_arcs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">⇒</span> ig_vertex <span class="main">⇒</span> ig_edge list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ig_in_out_arcs</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≡</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> fst <span class="bound">e</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">∨</span> snd <span class="bound">e</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">(</span>ig_arcs <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ig_opposite</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">⇒</span> ig_edge <span class="main">⇒</span> ig_vertex <span class="main">⇒</span> ig_vertex"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ig_opposite</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> fst <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1">then</span> snd <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">else</span> fst <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ig_neighbors</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">=&gt;</span> ig_vertex <span class="main">=&gt;</span> ig_vertex set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ig_neighbors</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound"><span class="bound">v</span></span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Code›</span></span>

<span class="keyword1"><span class="command">procedures</span></span> is_subgraph <span class="main">(</span>G <span class="main">::</span> IGraph<span class="main">,</span> H <span class="main">::</span> IGraph <span class="main">|</span> R <span class="main">::</span> bool<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    i <span class="main">::</span> nat
    v <span class="main">::</span> <span class="quoted">"ig_vertex"</span>
    ends <span class="main">::</span> <span class="quoted">"ig_edge"</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="quoted">"
    TRY
      ´i :== 0 ;;
      WHILE ´i &lt; ig_verts_cnt ´G INV named_loop ''verts''
      DO
        ´v :== ig_verts ´G ! ´i ;;
        IF ´v ∉ set (ig_verts ´H) THEN
          RAISE ´R :== False
        FI ;;
        ´i :== ´i + 1
      OD ;;

      ´i :== 0 ;;
      WHILE ´i &lt; ig_arcs_cnt ´G INV named_loop ''arcs''
      DO
        ´ends :== ig_arcs ´G ! ´i ;;
        IF ´ends ∉ set (ig_arcs ´H) ∧ (snd ´ends, fst ´ends) ∉ set (ig_arcs ´H) THEN
          RAISE ´R :== False
        FI ;;
        IF fst ´ends ∉ set (ig_verts ´G) ∨ snd ´ends ∉ set (ig_verts ´G) THEN
          RAISE ´R :== False
        FI ;;
        ´i :== ´i + 1
      OD ;;
      ´R :== True
    CATCH SKIP END
  "</span>

<span class="keyword1"><span class="command">procedures</span></span> is_loopfree <span class="main">(</span>G <span class="main">::</span> IGraph <span class="main">|</span> R <span class="main">::</span> bool<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    i <span class="main">::</span> nat
    ends <span class="main">::</span> <span class="quoted">"ig_edge"</span>
    edge_map <span class="main">::</span> <span class="quoted">"ig_edge ⇒ bool"</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="quoted">"
    TRY
      ´i :== 0 ;;
      WHILE ´i &lt; ig_arcs_cnt ´G INV named_loop ''loop''
      DO
        ´ends :== ig_arcs ´G ! ´i ;;
        IF fst ´ends = snd ´ends THEN
          RAISE ´R :== False
        FI ;;
        ´i :== ´i + 1
      OD ;;
      ´R :== True
    CATCH SKIP END
  "</span>


<span class="keyword1"><span class="command">procedures</span></span> select_nodes <span class="main">(</span>G <span class="main">::</span> IGraph <span class="main">|</span> R <span class="main">::</span> IGraph<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    i <span class="main">::</span> nat
    v <span class="main">::</span> ig_vertex
  <span class="keyword2"><span class="keyword">in</span></span> <span class="quoted">"
    ´R :== ig_empty ;;

    ´i :== 0 ;;
    WHILE ´i &lt; ig_verts_cnt ´G
    INV named_loop ''loop''
    DO
      ´v :== ig_verts ´G ! ´i ;;
      IF 2 &lt; card (ig_neighbors ´G ´v) THEN
        ´R :== ig_add_v ´R ´v
      FI ;;
      ´i :== ´i + 1
    OD
  "</span>

<span class="keyword1"><span class="command">procedures</span></span> find_endpoint <span class="main">(</span>G <span class="main">::</span> IGraph<span class="main">,</span> H <span class="main">::</span> IGraph<span class="main">,</span>  v_tail <span class="main">::</span> ig_vertex<span class="main">,</span> v_next <span class="main">::</span> ig_vertex <span class="main">|</span> R <span class="main">::</span> <span class="quoted">"ig_vertex option"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    found <span class="main">::</span> bool
    i <span class="main">::</span> nat
    len <span class="main">::</span> nat
    io_arcs <span class="main">::</span> <span class="quoted">"ig_edge list"</span>
    v0 <span class="main">::</span> ig_vertex
    v1 <span class="main">::</span> ig_vertex
    vt <span class="main">::</span> ig_vertex
  <span class="keyword2"><span class="keyword">in</span></span> <span class="quoted">"
    TRY
      IF ´v_tail = ´v_next THEN RAISE ´R :== None FI ;;
      ´v0 :== ´v_tail ;;
      ´v1 :== ´v_next ;;
      ´len :== 1 ;;
      WHILE ´v1 ∉ set (ig_verts ´H)
      INV named_loop ''path''
      DO
        ´io_arcs :== ig_in_out_arcs ´G ´v1 ;;
        ´i :== 0 ;;
        ´found :== False ;;
        WHILE ´found = False ∧ ´i &lt; length ´io_arcs
        INV named_loop ''arcs''
        DO
          ´vt :== ig_opposite ´G (´io_arcs ! ´i) ´v1 ;;
          IF ´vt ≠ ´v0 THEN
            ´found :== True ;;
            ´v0 :== ´v1 ;;
            ´v1 :== ´vt
          FI ;;
          ´i :== ´i + 1
        OD ;;
        ´len :== ´len + 1 ;;
        IF ¬ ´found THEN RAISE ´R :== None FI
      OD ;;
      IF ´v1 = ´v_tail THEN RAISE ´R :== None FI ;;
      ´R :== Some ´v1
    CATCH SKIP END
  "</span>

<span class="keyword1"><span class="command">procedures</span></span> contract <span class="main">(</span>G <span class="main">::</span> IGraph<span class="main">,</span> H <span class="main">::</span> IGraph <span class="main">|</span> R <span class="main">::</span> <span class="quoted">"IGraph"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    i <span class="main">::</span> nat
    j <span class="main">::</span> nat
    u <span class="main">::</span> ig_vertex
    v <span class="main">::</span> ig_vertex
    vo <span class="main">::</span> <span class="quoted">"ig_vertex option"</span>
    io_arcs <span class="main">::</span> <span class="quoted">"ig_edge list"</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="quoted">"
    ´i :== 0 ;;
    WHILE ´i &lt; ig_verts_cnt ´H
    INV named_loop ''iter_nodes''
    DO
      ´u :== ig_verts ´H ! ´i ;;
      ´io_arcs :== ig_in_out_arcs ´G ´u ;;

      ´j :== 0 ;;
      WHILE ´j &lt; length ´io_arcs
      INV named_loop ''iter_adj''
      DO
        ´v :== ig_opposite ´G (´io_arcs ! ´j) ´u ;;
        ´vo :== CALL find_endpoint(´G, ´H, ´u, ´v) ;;
        IF ´vo ≠ None THEN
          ´H :== ig_add_e ´H ´u (the ´vo)
        FI ;;
        ´j :== ´j + 1
      OD ;;
      ´i :== ´i + 1
    OD ;;
    ´R :== ´H
  "</span>

<span class="keyword1"><span class="command">procedures</span></span> is_K33 <span class="main">(</span>G <span class="main">::</span> IGraph <span class="main">|</span> R <span class="main">::</span> bool<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    i <span class="main">::</span> nat
    j <span class="main">::</span> nat
    u <span class="main">::</span> ig_vertex
    v <span class="main">::</span> ig_vertex
    blue <span class="main">::</span> <span class="quoted">"ig_vertex ⇒ bool"</span>
    blue_cnt <span class="main">::</span> nat
    io_arcs <span class="main">::</span> <span class="quoted">"ig_edge list"</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="quoted">"
    TRY
      IF ig_verts_cnt ´G ≠ 6 THEN RAISE ´R :== False FI ;;
      ´blue :== (λ_. False) ;;

      ´u :== ig_verts ´G ! 0 ;;
      ´i :== 0 ;;
      ´io_arcs :== ig_in_out_arcs ´G ´u ;;

      WHILE ´i &lt; length ´io_arcs INV named_loop ''colorize''
      DO
        ´v :== ig_opposite ´G (´io_arcs ! ´i) ´u ;;
        ´blue :== ´blue(´v := True) ;;
        ´i :== ´i + 1
      OD ;;

      ´blue_cnt :== 0 ;;
      ´i :== 0 ;;
      WHILE ´i &lt; ig_verts_cnt ´G INV named_loop ''component_size''
      DO
        IF ´blue (ig_verts ´G ! ´i) THEN ´blue_cnt :== ´blue_cnt + 1 FI ;;
        ´i :== ´i + 1
      OD ;;
      IF ´blue_cnt ≠ 3 THEN RAISE ´R :== False FI ;;

      ´i :== 0 ;;
      WHILE ´i &lt; ig_verts_cnt ´G INV named_loop ''connected_outer''
      DO
        ´u :== ig_verts ´G ! ´i ;;
        ´j :== 0 ;;
        WHILE ´j &lt; ig_verts_cnt ´G INV named_loop ''connected_inner''
        DO
          ´v :== ig_verts ´G ! ´j ;;
          IF ¬((´blue ´u = ´blue ´v) ⟷ (´u, ´v) ∉ set (ig_arcs ´G)) THEN RAISE ´R :== False FI ;;
          ´j :== ´j + 1
        OD ;;
        ´i :== ´i + 1
      OD ;;
      ´R :== True
    CATCH SKIP END
  "</span>

<span class="keyword1"><span class="command">procedures</span></span> is_K5 <span class="main">(</span>G <span class="main">::</span> IGraph <span class="main">|</span> R <span class="main">::</span> bool<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    i <span class="main">::</span> nat
    j <span class="main">::</span> nat
    u <span class="main">::</span> ig_vertex
  <span class="keyword2"><span class="keyword">in</span></span> <span class="quoted">"
    TRY
      IF ig_verts_cnt ´G ≠ 5 THEN RAISE ´R :== False FI ;;
      ´i :== 0 ;;
      WHILE ´i &lt; 5 INV named_loop ''outer_loop''
        DO
        ´u :== ig_verts ´G ! ´i ;;
        ´j :== 0 ;;
        WHILE ´j &lt; 5 INV named_loop ''inner_loop''
        DO
          IF ¬(´i ≠ ´j ⟷ (´u, ig_verts ´G ! ´j) ∈ set (ig_arcs ´G))
          THEN
            RAISE ´R :== False
          FI ;;
          ´j :== ´j + 1
        OD ;;
        ´i :== ´i + 1
      OD ;;
      ´R :== True
    CATCH SKIP END
  "</span>

<span class="keyword1"><span class="command">procedures</span></span> check_kuratowski <span class="main">(</span>G <span class="main">::</span> IGraph<span class="main">,</span> K <span class="main">::</span> IGraph <span class="main">|</span> R <span class="main">::</span> bool<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    H <span class="main">::</span> IGraph
  <span class="keyword2"><span class="keyword">in</span></span> <span class="quoted">"
    TRY
      ´R :== CALL is_subgraph(´K, ´G) ;;
      IF ¬´R THEN RAISE ´R :== False FI ;;
      ´R :== CALL is_loopfree(´K) ;;
      IF ¬´R THEN RAISE ´R :== False FI ;;
      ´H :== CALL select_nodes(´K) ;;
      ´H :== CALL contract(´K, ´H) ;;
      ´R :== CALL is_K5(´H) ;;
      IF ´R THEN RAISE ´R :== True FI ;;
      ´R :== CALL is_K33(´H)
    CATCH SKIP END
  "</span>



<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Check_Non_Planarity_Verification">
<div class="head">
<h1>Theory Check_Non_Planarity_Verification</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Verification of a Non-Planarity Checker"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Check_Non_Planarity_Verification <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Check_Non_Planarity_Impl">Check_Non_Planarity_Impl</a>
  <span class="quoted">"<a href="#Kuratowski_Combinatorial">../Planarity/Kuratowski_Combinatorial</a>"</span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Rewrite.html">HOL-Library.Rewrite</a>"</span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Eisbach/Eisbach.html">HOL-Eisbach.Eisbach</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Graph Basics and Implementation›</span></span>

<span class="keyword1"><span class="command">context</span></span> pre_digraph <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-cas_nonempty_ends"><span class="command">lemma</span></span> cas_nonempty_ends<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"cas <span class="free">u</span> <span class="free">p</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"cas <span class="free">u'</span> <span class="free">p</span> <span class="free">v'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="free">u'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">v'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cas_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil2 cas.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cas_append_iff cas_simp<span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-awalk_nonempty_ends"><span class="command">lemma</span></span> awalk_nonempty_ends<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"awalk <span class="free">u</span> <span class="free">p</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"awalk <span class="free">u'</span> <span class="free">p</span> <span class="free">v'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="free">u'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">v'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> awalk_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cas_nonempty_ends<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pair_graph<span class="main">)</span> verts2_awalk_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"verts3 <span class="free">G</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">⊆</span> pverts <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"awalk <span class="free">u</span> <span class="free">p</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>inner_verts <span class="free">p</span><span class="main">)</span> <span class="main">∩</span> <span class="free">V</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"progressing <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>inner_verts <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> p
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">e</span> <span class="skolem">es</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>inner_verts <span class="skolem">es</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> snoc.hyps<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> progressing_appendD1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> disjoint_iff_not_equal in_set_inner_verts_appendI_l<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">es'</span></span> <span class="skolem"><span class="skolem">e'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">es</span> <span class="main">=</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e'</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">es</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">es</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">e</span> <span class="main">∈</span> set <span class="main">(</span>inner_verts <span class="skolem">es</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A <span class="quoted"><span class="quoted">‹distinct <span class="main">(</span>inner_verts <span class="skolem">es</span><span class="main">)</span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">es</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inner_verts_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">e'</span> <span class="main">≠</span> fst <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">e'</span> <span class="main">=</span> fst <span class="skolem">e</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">es</span> <span class="main">=</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e'</span><span class="main">]</span>›</span></span> snoc.prems<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> awalk_Cons_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> no_loops<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">es''</span></span> <span class="skolem"><span class="skolem">e''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">es'</span> <span class="main">=</span> <span class="skolem">es''</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e''</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">es'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">es</span> <span class="main">=</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e'</span><span class="main">]</span>›</span></span> inner_verts_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">e''</span> <span class="main">≠</span> fst <span class="skolem">e</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹snd <span class="skolem">e'</span> <span class="main">=</span> fst <span class="skolem">e</span>›</span></span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> snoc.prems<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">es</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">es</span> <span class="main">=</span> <span class="main">_</span>›</span></span> awalk_Cons_iff progressing_append_iff progressing_Cons<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">e'</span> <span class="main">∈</span> set <span class="main">(</span>inner_verts <span class="skolem">es</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">es</span> <span class="main">=</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e'</span><span class="main">]</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">es'</span> <span class="main">=</span> <span class="skolem">es''</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e''</span><span class="main">]</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">es''</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inner_verts_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">e</span> <span class="main">∈</span> set <span class="main">(</span>inner_verts <span class="skolem">es'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">es</span> <span class="main">=</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e'</span><span class="main">]</span>›</span></span> <span class="quoted"><span class="quoted">‹fst <span class="skolem">e</span> <span class="main">∈</span> set <span class="main">(</span>inner_verts <span class="skolem">es</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹fst <span class="skolem">e'</span> <span class="main">≠</span> fst <span class="skolem">e</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">es'</span></span><span class="main">)</span>  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inner_verts_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">e'2</span></span> <span class="skolem"><span class="skolem">e'3</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> Z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">es'</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e'2</span><span class="main">,</span> <span class="skolem">e'3</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">e'2</span> <span class="main">=</span> fst <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">e'3</span> <span class="main">=</span> fst <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e'3'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e'3'</span> <span class="main">∈</span> set <span class="main">(</span>tl <span class="skolem">es'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">e'3'</span> <span class="main">=</span> fst <span class="skolem">e</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fst <span class="skolem">e</span> <span class="main">∈</span> set <span class="main">(</span>inner_verts <span class="skolem">es'</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">es'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inner_verts_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"tl <span class="skolem">es'</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">@</span> <span class="skolem">e'3'</span> <span class="main">#</span> <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> split_list<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> F2<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>last <span class="main">(</span>hd <span class="skolem">es'</span> <span class="main">#</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fst <span class="skolem">e</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">es</span> <span class="main">=</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e'</span><span class="main">]</span>›</span></span> snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹fst <span class="skolem">e'3'</span> <span class="main">=</span> fst <span class="skolem">e</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">es'</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="skolem">q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">es'</span> <span class="main">=</span> <span class="main">(</span>butlast <span class="main">(</span>hd <span class="skolem">es'</span> <span class="main">#</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>last <span class="main">(</span>hd <span class="skolem">es'</span> <span class="main">#</span> <span class="skolem">q</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e'3'</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹tl <span class="skolem">es'</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">@</span> <span class="skolem">e'3'</span> <span class="main">#</span> <span class="skolem">r</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">es'</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> F2 <span class="quoted"><span class="quoted">‹fst <span class="skolem">e'3'</span> <span class="main">=</span> fst <span class="skolem">e</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">e'2</span> <span class="main">≠</span> snd <span class="skolem">e'3</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">es</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> progressing_append_iff progressing_Cons<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> Z <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">e'2</span> <span class="main">=</span> <span class="free">u</span> <span class="main">∨</span> fst <span class="skolem">e'2</span> <span class="main">∈</span> set <span class="main">(</span>inner_verts <span class="skolem">es'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">es</span> <span class="main">=</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e'</span><span class="main">]</span>›</span></span> snoc.prems<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inner_verts_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">e'2</span> <span class="main">≠</span> fst <span class="skolem">e'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">e'2</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">e'2</span> <span class="main">∉</span> set <span class="main">(</span>inner_verts <span class="skolem">es</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> V <span class="quoted"><span class="quoted">‹<span class="skolem">es</span> <span class="main">=</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e'</span><span class="main">]</span>›</span></span> snoc.prems<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">es'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inner_verts_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">e'</span> <span class="main">∈</span> set <span class="main">(</span>inner_verts <span class="skolem">es</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">es</span> <span class="main">=</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e'</span><span class="main">]</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">es'</span> <span class="main">=</span> <span class="skolem">es''</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e''</span><span class="main">]</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">es''</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inner_verts_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">e'2</span> <span class="main">∈</span> set <span class="main">(</span>inner_verts <span class="skolem">es'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">e'</span> <span class="main">∈</span> set <span class="main">(</span>inner_verts <span class="skolem">es</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">es</span> <span class="main">=</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e'</span><span class="main">]</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">es'</span> <span class="main">=</span> <span class="skolem">es''</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e''</span><span class="main">]</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">es''</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inner_verts_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="main">(</span>inner_verts <span class="skolem">es</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">es</span> <span class="main">=</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e'</span><span class="main">]</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">es'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inner_verts_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">e'3</span> <span class="main">≠</span> fst <span class="skolem">e'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">e'3</span> <span class="main">=</span> fst <span class="skolem">e'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> Z <span class="quoted"><span class="quoted">‹<span class="skolem">es</span> <span class="main">=</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e'</span><span class="main">]</span>›</span></span> snoc.prems<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹snd <span class="skolem">e'</span> <span class="main">=</span> fst <span class="skolem">e</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> progressing_append_iff progressing_Cons<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">e'3</span> <span class="main">=</span> fst <span class="skolem">e'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r0</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">r0</span> <span class="main">#</span> <span class="skolem">rs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">e'3</span> <span class="main">=</span> fst <span class="skolem">r0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Z <span class="quoted"><span class="quoted">‹<span class="skolem">es</span> <span class="main">=</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e'</span><span class="main">]</span>›</span></span> snoc.prems<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> awalk_Cons_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">r0</span> <span class="main">=</span> fst <span class="skolem">e'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>distinct <span class="main">(</span>inner_verts <span class="skolem">es</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Z<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">es</span> <span class="main">=</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e'</span><span class="main">]</span>›</span></span>
          <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">r0</span> <span class="main">#</span> <span class="skolem">rs</span>›</span></span> <span class="quoted"><span class="quoted">‹fst <span class="skolem">r0</span> <span class="main">=</span> fst <span class="skolem">e'</span>›</span></span> inner_verts_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="main">(</span>inner_verts <span class="skolem">es</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> card_to_fst_e<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="skolem">e'2</span><span class="main">,</span> <span class="main">(</span>snd <span class="skolem">e'3</span><span class="main">,</span> fst <span class="skolem">e'3</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e'</span><span class="main">}</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_insert_if<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e'3</span> <span class="main">∈</span> parcs <span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Z <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">es</span> <span class="main">=</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e'</span><span class="main">]</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> arcs_symmetric<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="skolem">e'3</span><span class="main">,</span> fst <span class="skolem">e'3</span><span class="main">)</span> <span class="main">∈</span> parcs <span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> arcs_symmetric<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">e'2</span><span class="main">,</span> <span class="main">(</span>snd <span class="skolem">e'3</span><span class="main">,</span> fst <span class="skolem">e'3</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e'</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound"><span class="bound">ed</span></span> <span class="main">∈</span> parcs <span class="free">G</span><span class="main">.</span> snd <span class="bound">ed</span> <span class="main">=</span> fst <span class="skolem">e</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">es</span> <span class="main">=</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e'</span><span class="main">]</span>›</span></span> Z <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">e</span> <span class="main">∈</span> pverts <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> card_to_fst_e_abs<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">ed</span></span> <span class="main">∈</span> parcs <span class="free">G</span><span class="main">.</span> snd <span class="bound">ed</span> <span class="main">=</span> fst <span class="skolem">e</span><span class="main">}</span> <span class="main">≤</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fst <span class="skolem">e</span> <span class="main">∈</span> set <span class="main">(</span>inner_verts <span class="skolem">es</span><span class="main">)</span>›</span></span> V snoc.prems<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> verts3_def in_degree_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">es</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inner_verts_def in_arcs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">e'2</span><span class="main">,</span> <span class="main">(</span>snd <span class="skolem">e'3</span><span class="main">,</span> fst <span class="skolem">e'3</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e'</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">ed</span></span> <span class="main">∈</span> parcs <span class="free">G</span><span class="main">.</span> snd <span class="bound">ed</span> <span class="main">=</span> fst <span class="skolem">e</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_seteq<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> card_to_fst_e card_to_fst_e_abs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> wf_digraph<span class="main">)</span> inner_verts_conv'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"awalk <span class="free">u</span> <span class="free">p</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> length <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inner_verts <span class="free">p</span> <span class="main">=</span> awalk_verts <span class="main">(</span>head <span class="free">G</span> <span class="main">(</span>hd <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>butlast <span class="main">(</span>tl <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> awalk_Cons_iff<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">match</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">premises</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">_</span> <span class="main">#</span> <span class="skolem">as</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">as</span> <span class="main"><span class="main">⇒</span></span> <span class="quoted">‹<span class="operator">cases</span> <span class="quoted"><span class="skolem">as</span></span> <span class="quasi_keyword">rule</span><span class="main">:</span> rev_cases›</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inner_verts_def awalk_verts_conv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-verts3_in_verts"><span class="command">lemma</span></span> verts3_in_verts<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> verts3 <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> verts <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> verts3_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pair_graph<span class="main">)</span> deg2_awalk_is_iapath<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"verts3 <span class="free">G</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">⊆</span> pverts <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"awalk <span class="free">u</span> <span class="free">p</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>inner_verts <span class="free">p</span><span class="main">)</span> <span class="main">∩</span> <span class="free">V</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"progressing <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> in_V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gen_iapath <span class="free">V</span> <span class="free">u</span> <span class="free">p</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> p<span class="main">(</span>1<span class="main">)</span> in_V <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">≠</span> <span class="free">v</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> apath_def gen_iapath_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">p0</span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ev_p<span class="main">:</span> <span class="quoted"><span class="quoted">"awalk_verts <span class="free">u</span> <span class="free">p</span> <span class="main">=</span> <span class="free">u</span> <span class="main">#</span> butlast <span class="main">(</span>tl <span class="main">(</span>awalk_verts <span class="free">u</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">v</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> p<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∉</span> set <span class="main">(</span>inner_verts <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> set <span class="main">(</span>inner_verts <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> p<span class="main">(</span>2<span class="main">)</span> in_V <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> verts2_awalk_distinct<span class="main">[</span><span class="operator">OF</span> V in_V<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> p<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>awalk_verts <span class="free">u</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> p<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">≠</span> <span class="free">v</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ev_p<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inner_verts_conv<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">u</span></span><span class="main"><span class="main">]</span></span> verts3_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> p<span class="main">(</span>1-2<span class="main">)</span> in_V <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">≠</span> <span class="free">v</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> apath_def gen_iapath_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pair_graph<span class="main">)</span> inner_verts_min_degree<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> walk_p<span class="main">:</span> <span class="quoted"><span class="quoted">"awalk <span class="free">u</span> <span class="free">p</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> progress<span class="main">:</span> <span class="quoted"><span class="quoted">"progressing <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> w_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> set <span class="main">(</span>inner_verts <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span>in_degree <span class="free">G</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> w_p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> length <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e1</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="skolem"><span class="skolem">e2</span></span> <span class="keyword2"><span class="keyword">where</span></span> p_decomp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="skolem">e1</span> <span class="main">#</span> <span class="skolem">es</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e2</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_1 Suc_eq_plus1 le0 list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> neq_Nil_conv not_less_eq_eq rev_cases<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> w_es<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> set <span class="main">(</span>awalk_verts <span class="main">(</span>snd <span class="skolem">e1</span><span class="main">)</span> <span class="skolem">es</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> walk_p w_p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> apath_def inner_verts_conv'<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> walk_es<span class="main">:</span> <span class="quoted"><span class="quoted">"awalk <span class="main">(</span>snd <span class="skolem">e1</span><span class="main">)</span> <span class="skolem">es</span> <span class="main">(</span>fst <span class="skolem">e2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> walk_p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p_decomp awalk_simps<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> es_decomp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">es</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">@</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"awalk <span class="main">(</span>snd <span class="skolem">e1</span><span class="main">)</span> <span class="skolem">q</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"awalk <span class="free">w</span> <span class="skolem">r</span> <span class="main">(</span>fst <span class="skolem">e2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> awalk_decomp<span class="main">[</span><span class="operator">OF</span> walk_es w_es<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">ys</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> butlast <span class="main">(</span><span class="skolem">e1</span> <span class="main">#</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> last <span class="main">(</span><span class="skolem">e1</span> <span class="main">#</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> hd <span class="main">(</span><span class="skolem">r</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e2</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> tl <span class="main">(</span><span class="skolem">r</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e2</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p_decomp es_decomp<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"awalk <span class="free">u</span> <span class="main">(</span><span class="skolem">e1</span> <span class="main">#</span> <span class="skolem">q</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"awalk <span class="free">w</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e2</span><span class="main">]</span><span class="main">)</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> walk_p es_decomp p_decomp <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> awalk_Cons_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> inc_w<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">x</span> <span class="main">=</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">y</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> x_def y_def
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> awalk_Cons_iff awalk_verts_conv<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">x</span> <span class="main">≠</span> snd <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> progress <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> progressing_append_iff progressing_Cons<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> parcs <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> parcs <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> walk_p <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">,</span> <span class="main">(</span>snd <span class="skolem">y</span><span class="main">,</span> <span class="free">w</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound"><span class="bound">e</span></span> <span class="main">∈</span> parcs <span class="free">G</span><span class="main">.</span> snd <span class="bound">e</span> <span class="main">=</span> <span class="free">w</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inc_w <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> arcs_symmetric surjective_pairing<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="skolem">x</span><span class="main">,</span> <span class="main">(</span>snd <span class="skolem">y</span><span class="main">,</span> <span class="free">w</span><span class="main">)</span><span class="main">}</span> <span class="main">≤</span> in_degree <span class="free">G</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> in_degree_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_mono<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fst <span class="skolem">x</span> <span class="main">≠</span> snd <span class="skolem">y</span>›</span></span> inc_w
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_insert_if <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pair_pseudo_graph<span class="main">)</span> gen_iapath_same2E<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"verts3 <span class="free">G</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">⊆</span> pverts <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"gen_iapath <span class="free">V</span> <span class="free">u</span> <span class="free">p</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"gen_iapath <span class="free">V</span> <span class="free">w</span> <span class="free">q</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> set <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> set <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms same_gen_iapath_by_common_arc <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>



<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mk_graph'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">⇒</span> ig_vertex pair_pre_digraph"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mk_graph'</span> <span class="free"><span class="bound"><span class="entity">IG</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> pverts <span class="main">=</span> set <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">IG</span></span></span><span class="main">)</span><span class="main">,</span> parcs <span class="main">=</span> set <span class="main">(</span>ig_arcs <span class="free"><span class="bound"><span class="entity">IG</span></span></span><span class="main">)</span><span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mk_graph</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">⇒</span> ig_vertex pair_pre_digraph"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mk_graph</span> <span class="free"><span class="bound"><span class="entity">IG</span></span></span> <span class="main">≡</span> mk_symmetric <span class="main">(</span>mk_graph' <span class="free"><span class="bound"><span class="entity">IG</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-verts_mkg'"><span class="command">lemma</span></span> verts_mkg'<span class="main">:</span> <span class="quoted"><span class="quoted">"pverts <span class="main">(</span>mk_graph' <span class="free">G</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mk_graph'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-arcs_mkg'"><span class="command">lemma</span></span> arcs_mkg'<span class="main">:</span> <span class="quoted"><span class="quoted">"parcs <span class="main">(</span>mk_graph' <span class="free">G</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mk_graph'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> mkg'_simps <span class="main">=</span> verts_mkg' arcs_mkg'

<span class="keyword1" id="Check_Non_Planarity_Verification-verts_mkg"><span class="command">lemma</span></span> verts_mkg<span class="main">:</span> <span class="quoted"><span class="quoted">"pverts <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mk_graph_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mkg'_simps <span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-parcs_mk_symmetric_symcl"><span class="command">lemma</span></span> parcs_mk_symmetric_symcl<span class="main">:</span> <span class="quoted"><span class="quoted">"parcs <span class="main">(</span>mk_symmetric <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>arcs_ends <span class="free">G</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>s</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> parcs_mk_symmetric symcl_def arcs_ends_conv<span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-arcs_mkg"><span class="command">lemma</span></span> arcs_mkg<span class="main">:</span> <span class="quoted"><span class="quoted">"parcs <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>s</sup></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mk_graph_def parcs_mk_symmetric_symcl <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> arcs_mkg'<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> mkg_simps <span class="main">=</span> verts_mkg arcs_mkg



<span class="keyword1"><span class="command">definition</span></span> <span class="entity">iadj</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">⇒</span> ig_vertex <span class="main">⇒</span> ig_vertex <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">iadj</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">loop_free</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> parcs <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">.</span> fst <span class="bound">e</span> <span class="main">≠</span> snd <span class="bound">e</span><span class="main">)</span>"</span></span>


<span class="keyword1" id="Check_Non_Planarity_Verification-ig_opposite_simps"><span class="command">lemma</span></span> ig_opposite_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ig_opposite <span class="free">G</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="free">u</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"ig_opposite <span class="free">G</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">u</span><span class="main">)</span> <span class="free">u</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> ig_opposite_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-distinct_ig_verts"><span class="command">lemma</span></span> distinct_ig_verts<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">G</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ig_verts_def Abs_IGraph_inverse<span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-set_ig_arcs_verts"><span class="command">lemma</span></span> set_ig_arcs_verts<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"IGraph_inv <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> IGraph_inv_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkg'_simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> all_nth_imp_all_set<span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-IGraph_inv_conv"><span class="command">lemma</span></span> IGraph_inv_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"IGraph_inv <span class="free">G</span> <span class="main">⟷</span> pair_fin_digraph <span class="main">(</span>mk_graph' <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span><span class="main">∈</span>set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span><span class="main">.</span> fst <span class="bound">e</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span> <span class="main">∧</span> snd <span class="bound">e</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pair_fin_digraph <span class="main">(</span>mk_graph' <span class="free">G</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkg'_simps<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"pair_fin_digraph <span class="main">(</span>mk_graph' <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> pair_fin_digraph <span class="quoted"><span class="quoted">"mk_graph' <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span><span class="main">∈</span>set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span><span class="main">.</span> fst <span class="bound">e</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span> <span class="main">∧</span> snd <span class="bound">e</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tail_in_verts head_in_verts
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkg'_simps in_set_conv_nth<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> IGraph_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-IGraph_inv_conv'"><span class="command">lemma</span></span> IGraph_inv_conv'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"IGraph_inv <span class="free">G</span> <span class="main">⟷</span> pair_pseudo_graph <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> IGraph_inv_conv
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"pair_fin_digraph <span class="main">(</span>mk_graph' <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> ppd<span class="main">:</span> pair_fin_digraph <span class="quoted"><span class="quoted">"mk_graph' <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> pd<span class="main">:</span> pair_fin_digraph <span class="quoted"><span class="quoted">"mk_graph <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mk_graph_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pair_pseudo_graph <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mk_graph_def symmetric_mk_symmetric<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"pair_pseudo_graph <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> ppg<span class="main">:</span> pair_pseudo_graph <span class="quoted"><span class="quoted">"mk_graph <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pair_fin_digraph <span class="main">(</span>mk_graph' <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ppg.wellformed'
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkg_simps mkg'_simps symcl_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-iadj_io_edge"><span class="command">lemma</span></span> iadj_io_edge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> set <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"iadj <span class="free">G</span> <span class="free">u</span> <span class="main">(</span>ig_opposite <span class="free">G</span> <span class="free">e</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span> <span class="main">∨</span>  <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span><span class="free">u</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ig_in_out_arcs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"ig_opposite <span class="free">G</span> <span class="free">e</span> <span class="free">u</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">safe</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ig_opposite_def<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> e <span class="keyword1"><span class="command">unfolding</span></span> iadj_def * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-All_set_ig_verts"><span class="command">lemma</span></span> All_set_ig_verts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> ig_verts_cnt <span class="free">G</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>ig_verts <span class="free">G</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_nth ig_verts_cnt_def<span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-IGraph_imp_ppd_mkg'"><span class="command">lemma</span></span> IGraph_imp_ppd_mkg'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"IGraph_inv <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pair_fin_digraph <span class="main">(</span>mk_graph' <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> IGraph_inv_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-finite_symcl_iff"><span class="command">lemma</span></span> finite_symcl_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">R</span><span class="keyword1"><span class="hidden">⇧</span><sup>s</sup></span><span class="main">)</span> <span class="main">⟷</span> finite <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> symcl_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pair_fin_digraph<span class="main">)</span> pair_pseudo_graphI_mk_symmetric<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pair_pseudo_graph <span class="main">(</span>mk_symmetric <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> parcs_mk_symmetric symmetric_mk_symmetric wellformed'<span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-IGraph_imp_ppg_mkg"><span class="command">lemma</span></span> IGraph_imp_ppg_mkg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"IGraph_inv <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pair_pseudo_graph <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> mk_graph_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pair_fin_digraph.pair_pseudo_graphI_mk_symmetric IGraph_imp_ppd_mkg'<span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-IGraph_lf_imp_pg_mkg"><span class="command">lemma</span></span> IGraph_lf_imp_pg_mkg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"IGraph_inv <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"loop_free <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pair_graph <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> ppg<span class="main">:</span> pair_pseudo_graph <span class="quoted"><span class="quoted">"mk_graph <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> IGraph_imp_ppg_mkg<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pair_graph <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> loop_free_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-set_ig_arcs_imp_verts"><span class="command">lemma</span></span> set_ig_arcs_imp_verts<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"IGraph_inv <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> pair_pseudo_graph <span class="quoted"><span class="quoted">"mk_graph <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> IGraph_imp_ppg_mkg<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="main">∈</span> parcs <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mkg_simps symcl_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> pverts <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> pverts <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wellformed'<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkg_simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-iadj_imp_verts"><span class="command">lemma</span></span> iadj_imp_verts<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"iadj <span class="free">G</span> <span class="free">u</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"IGraph_inv <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> iadj_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> set_ig_arcs_imp_verts<span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-card_ig_neighbors_indegree"><span class="command">lemma</span></span> card_ig_neighbors_indegree<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"IGraph_inv <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>ig_neighbors <span class="free">G</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> in_degree <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> inj2<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> ig_opposite <span class="free">G</span> <span class="bound">e</span> <span class="free">u</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">e</span></span> <span class="main">∈</span> parcs <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span><span class="main">.</span> snd <span class="bound">e</span> <span class="main">=</span> <span class="free">u</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ig_opposite_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ig_neighbors <span class="free">G</span> <span class="free">u</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> ig_opposite <span class="free">G</span> <span class="bound">e</span> <span class="free">u</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">e</span></span> <span class="main">∈</span> parcs <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span><span class="main">.</span> snd <span class="bound">e</span> <span class="main">=</span> <span class="free">u</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ig_neighbors_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ig_opposite_simps symcl_def mkg_simps set_ig_arcs_verts <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rev_image_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>ig_neighbors <span class="free">G</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> ig_opposite <span class="free">G</span> <span class="bound">e</span> <span class="free">u</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">e</span></span> <span class="main">∈</span> parcs <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span><span class="main">.</span> snd <span class="bound">e</span> <span class="main">=</span> <span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> in_degree <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> in_degree_def in_arcs_def with_proj_simps
    <span class="keyword1"><span class="command">using</span></span> inj2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_image<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-iadjD"><span class="command">lemma</span></span> iadjD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"iadj <span class="free">G</span> <span class="free">u</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">e</span> <span class="main">∈</span> set <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="free">u</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">e</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="main">∨</span> <span class="bound">e</span> <span class="main">=</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">e</span> <span class="main">=</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> iadj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ig_in_out_arcs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-ig_verts_empty"><span class="command">lemma</span></span>
  ig_verts_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ig_verts ig_empty <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  ig_verts_add_e<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ig_verts <span class="main">(</span>ig_add_e <span class="free">G</span> <span class="free">u</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> ig_verts <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  ig_verts_add_v<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ig_verts <span class="main">(</span>ig_add_v <span class="free">G</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> ig_verts <span class="free">G</span> <span class="main">@</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">v</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> <span class="main">[</span><span class="free">v</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ig_verts_def ig_empty_def ig_add_e_def ig_add_v_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Abs_IGraph_inverse distinct_ig_verts<span class="main"><span class="main">[</span></span><span class="operator">simplified</span> ig_verts_def<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-ig_arcs_empty"><span class="command">lemma</span></span>
  ig_arcs_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ig_arcs ig_empty <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  ig_arcs_add_e<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ig_arcs <span class="main">(</span>ig_add_e <span class="free">G</span> <span class="free">u</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> ig_arcs <span class="free">G</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  ig_arcs_add_v<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ig_arcs <span class="main">(</span>ig_add_v <span class="free">G</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> ig_arcs <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ig_arcs_def ig_empty_def ig_add_e_def ig_add_v_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Abs_IGraph_inverse distinct_ig_verts<span class="main">)</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Total Correctness›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Procedure <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">is_subgraph</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_subgraph_verts_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">⇒</span> IGraph <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_subgraph_verts_inv</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> set <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_subgraph_arcs_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">⇒</span> IGraph <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_subgraph_arcs_inv</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">.</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">=</span> ig_arcs <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">!</span> <span class="bound">j</span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span> <span class="bound">u</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-is_subgraph_verts_0"><span class="command">lemma</span></span> is_subgraph_verts_0<span class="main">:</span> <span class="quoted"><span class="quoted">"is_subgraph_verts_inv <span class="free">G</span> <span class="free">H</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_subgraph_verts_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-is_subgraph_verts_step"><span class="command">lemma</span></span> is_subgraph_verts_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_subgraph_verts_inv <span class="free">G</span> <span class="free">H</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"ig_verts <span class="free">G</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_subgraph_verts_inv <span class="free">G</span> <span class="free">H</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_subgraph_verts_inv_def take_Suc_conv_app_nth<span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-is_subgraph_verts_last"><span class="command">lemma</span></span> is_subgraph_verts_last<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_subgraph_verts_inv <span class="free">G</span> <span class="free">H</span> <span class="main">(</span>length <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> pverts <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="main">⊆</span> pverts <span class="main">(</span>mk_graph <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_subgraph_verts_inv_def mkg_simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-is_subgraph_arcs_0"><span class="command">lemma</span></span> is_subgraph_arcs_0<span class="main">:</span> <span class="quoted"><span class="quoted">"is_subgraph_arcs_inv <span class="free">G</span> <span class="free">H</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_subgraph_arcs_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-is_subgraph_arcs_step"><span class="command">lemma</span></span> is_subgraph_arcs_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_subgraph_arcs_inv <span class="free">G</span> <span class="free">H</span> <span class="free">i</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free">H</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>snd <span class="free">e</span><span class="main">,</span> fst <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"fst <span class="free">e</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">e</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> ig_arcs <span class="free">G</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_subgraph_arcs_inv <span class="free">G</span> <span class="free">H</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_subgraph_arcs_inv_def less_Suc_eq<span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-wellformed_pseudo_graph_mkg"><span class="command">lemma</span></span> wellformed_pseudo_graph_mkg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pair_wf_digraph <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="main">=</span> pair_pseudo_graph<span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> ppg<span class="main">:</span> pair_pseudo_graph <span class="quoted"><span class="quoted">"mk_graph <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"symmetric <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mk_graph_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> symmetric_mk_symmetric<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> pair_wf_digraph_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkg_simps finite_symcl_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-is_subgraph_arcs_last"><span class="command">lemma</span></span> is_subgraph_arcs_last<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_subgraph_arcs_inv <span class="free">G</span> <span class="free">H</span> <span class="main">(</span>length <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> parcs <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="main">⊆</span> parcs <span class="main">(</span>mk_graph <span class="free">H</span><span class="main">)</span> <span class="main">∧</span> pair_pseudo_graph <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_subgraph_arcs_inv <span class="free">G</span> <span class="free">H</span> <span class="main">(</span>length <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span><span class="main">)</span>
      <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free">H</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free">H</span><span class="main">)</span><span class="main">)</span>
        <span class="main">∧</span> <span class="bound">u</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_subgraph_arcs_inv_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> all_nth_imp_all_set nth_mem<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span> parcs <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="main">⊆</span> parcs <span class="main">(</span>mk_graph <span class="free">H</span><span class="main">)</span> <span class="main">∧</span> pair_pseudo_graph <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wellformed_pseudo_graph_mkg<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkg_simps pair_wf_digraph_def symcl_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-is_subgraph_verts_arcs_last"><span class="command">lemma</span></span> is_subgraph_verts_arcs_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_subgraph_verts_inv <span class="free">G</span> <span class="free">H</span> <span class="main">(</span>ig_verts_cnt <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_subgraph_arcs_inv <span class="free">G</span> <span class="free">H</span> <span class="main">(</span>ig_arcs_cnt <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"IGraph_inv <span class="free">H</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subgraph <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="main">(</span>mk_graph <span class="free">H</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?T1</span></span></span><span class="main">)</span>
        <span class="quoted"><span class="quoted">"pair_pseudo_graph <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?T2</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> ppg<span class="main">:</span> pair_pseudo_graph <span class="quoted"><span class="quoted">"mk_graph <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_subgraph_arcs_last<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> ppgH<span class="main">:</span> pair_pseudo_graph <span class="quoted"><span class="quoted">"mk_graph <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> IGraph_imp_ppg_mkg<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_digraph <span class="main">(</span>with_proj <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?T1</span></span></span> <span class="var"><span class="quoted"><span class="var">?T2</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_subgraph_verts_last is_subgraph_arcs_last subgraph_def ppgH.wf_digraph<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-is_subgraph_false"><span class="command">lemma</span></span> is_subgraph_false<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subgraph <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="main">(</span>mk_graph <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span><span class="main">.</span> ig_verts <span class="free">G</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">=</span> ig_arcs <span class="free">G</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">in</span>
      <span class="main">(</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free">H</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free">H</span><span class="main">)</span><span class="main">)</span>
      <span class="main">∧</span> <span class="bound">u</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span><span class="main">.</span> ig_verts <span class="free">G</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subgraph_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkg_simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_subgraph_arcs_inv <span class="free">G</span> <span class="free">H</span> <span class="main">(</span>length <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_subgraph_arcs_last subgraph_def wellformed_pseudo_graph_mkg<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_digraph_wp_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">=</span> ig_arcs <span class="free">G</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">in</span>
      <span class="main">(</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free">H</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free">H</span><span class="main">)</span><span class="main">)</span>
      <span class="main">∧</span> <span class="bound">u</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_subgraph_arcs_inv_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> is_subgraph_impl<span class="main">)</span> is_subgraph_spec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>t</sub></span> <span class="main">⦃</span><span class="bound">σ</span><span class="main">.</span> IGraph_inv <span class="main">´</span>H <span class="main">⦄</span> <span class="main">´</span>R <span class="main">:==</span> <span class="keyword1">PROC</span> is_subgraph<span class="main">(</span><span class="main">´</span>G<span class="main">,</span> <span class="main">´</span>H<span class="main">)</span> <span class="main">⦃</span> <span class="main">´</span>G <span class="main">=</span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>G <span class="main">∧</span> <span class="main">´</span>H <span class="main">=</span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>H <span class="main">∧</span> <span class="main">´</span>R <span class="main">=</span> <span class="main">(</span>subgraph <span class="main">(</span>mk_graph <span class="main">´</span>G<span class="main">)</span> <span class="main">(</span>mk_graph <span class="main">´</span>H<span class="main">)</span> <span class="main">∧</span> IGraph_inv <span class="main">´</span>G<span class="main">)</span><span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">vcg_step</span> spec<span class="main"><span class="main">=</span></span>none<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span>
    <span class="quasi_keyword">at</span> <span class="quoted"><span class="quoted"><span class="quoted">"whileAnno <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">(</span></span>named_loop <span class="inner_quoted"><span class="inner_quoted">''verts''</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">σ</span></span><span class="main"><span class="main">)</span></span>
    <span class="quasi_keyword">to</span> <span class="quoted"><span class="quoted"><span class="quoted">"whileAnno <span class="main"><span class="main">_</span></span>
      <span class="main"><span class="main">⦃</span></span> is_subgraph_verts_inv <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">´</span></span>H <span class="main"><span class="main">´</span></span>i <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">=</span></span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>G <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>H <span class="main"><span class="main">=</span></span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>H <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>i <span class="main"><span class="main">≤</span></span> ig_verts_cnt <span class="main"><span class="main">´</span></span>G
      <span class="main"><span class="main">∧</span></span> IGraph_inv <span class="main"><span class="main">´</span></span>H<span class="main"><span class="main">⦄</span></span>
      <span class="main"><span class="main">(</span></span><span class="keyword1"><span class="keyword1">MEASURE</span></span> ig_verts_cnt <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">´</span></span>i<span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">_</span></span>"</span></span></span>
    annotate_named_loop_var<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span>
    <span class="quasi_keyword">at</span> <span class="quoted"><span class="quoted"><span class="quoted">"whileAnno <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">(</span></span>named_loop <span class="inner_quoted"><span class="inner_quoted">''arcs''</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">σ</span></span><span class="main"><span class="main">)</span></span>
    <span class="quasi_keyword">to</span> <span class="quoted"><span class="quoted"><span class="quoted">"whileAnno <span class="main"><span class="main">_</span></span>
      <span class="main"><span class="main">⦃</span></span> is_subgraph_arcs_inv <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">´</span></span>H <span class="main"><span class="main">´</span></span>i <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">=</span></span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>G <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>H <span class="main"><span class="main">=</span></span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>H <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>i <span class="main"><span class="main">≤</span></span> ig_arcs_cnt <span class="main"><span class="main">´</span></span>G
      <span class="main"><span class="main">∧</span></span> is_subgraph_verts_inv <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">´</span></span>H <span class="main"><span class="main">(</span></span>length <span class="main"><span class="main">(</span></span>ig_verts <span class="main"><span class="main">´</span></span>G<span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∧</span></span> IGraph_inv <span class="main"><span class="main">´</span></span>H <span class="main"><span class="main">⦄</span></span>
      <span class="main"><span class="main">(</span></span><span class="keyword1"><span class="keyword1">MEASURE</span></span> ig_arcs_cnt <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">´</span></span>i<span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">_</span></span>"</span></span></span>
    annotate_named_loop_var<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_subgraph_verts_0<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_subgraph_verts_step <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> is_subgraph_false<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_subgraph_arcs_0 not_less<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_subgraph_arcs_step <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> is_subgraph_false<span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IGraph_inv_conv' is_subgraph_verts_arcs_last<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Procedure <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">is_loop_free</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_loopfree_inv</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">.</span> fst <span class="main">(</span>ig_arcs <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≠</span> snd <span class="main">(</span>ig_arcs <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-is_loopfree_0"><span class="command">lemma</span></span> is_loopfree_0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_loopfree_inv <span class="free">G</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_loopfree_inv_def<span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-is_loopfree_step1"><span class="command">lemma</span></span> is_loopfree_step1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_loopfree_inv <span class="free">G</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>ig_arcs <span class="free">G</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> snd <span class="main">(</span>ig_arcs <span class="free">G</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> ig_arcs_cnt <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_loopfree_inv <span class="free">G</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_loopfree_inv_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> less_SucI <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> less_SucE<span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-is_loopfree_step2"><span class="command">lemma</span></span> is_loopfree_step2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"loop_free <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> ig_arcs_cnt <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>ig_arcs <span class="free">G</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> snd <span class="main">(</span>ig_arcs <span class="free">G</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_loopfree_inv_def loop_free_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkg_simps symcl_def<span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-is_loopfree_last"><span class="command">lemma</span></span> is_loopfree_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_loopfree_inv <span class="free">G</span> <span class="main">(</span>ig_arcs_cnt <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"loop_free <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_loopfree_inv_def loop_free_def mkg_simps in_set_conv_nth symcl_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> fst_eqD snd_eqD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> is_loopfree_impl<span class="main">)</span> is_loopfree_spec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>t</sub></span> <span class="main">⦃</span><span class="bound">σ</span><span class="main">.</span> IGraph_inv <span class="main">´</span>G <span class="main">⦄</span> <span class="main">´</span>R <span class="main">:==</span> <span class="keyword1">PROC</span> is_loopfree<span class="main">(</span><span class="main">´</span>G<span class="main">)</span> <span class="main">⦃</span> <span class="main">´</span>G <span class="main">=</span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>G <span class="main">∧</span> <span class="main">´</span>R <span class="main">=</span> loop_free <span class="main">(</span>mk_graph <span class="main">´</span>G<span class="main">)</span> <span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">vcg_step</span> spec<span class="main"><span class="main">=</span></span>none<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span>
    <span class="quasi_keyword">at</span> <span class="quoted"><span class="quoted"><span class="quoted">"whileAnno <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">(</span></span>named_loop <span class="inner_quoted"><span class="inner_quoted">''loop''</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">σ</span></span><span class="main"><span class="main">)</span></span>
    <span class="quasi_keyword">to</span> <span class="quoted"><span class="quoted"><span class="quoted">"whileAnno <span class="main"><span class="main">_</span></span>
      <span class="main"><span class="main">⦃</span></span> is_loopfree_inv <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">´</span></span>i <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">=</span></span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>G <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>i <span class="main"><span class="main">≤</span></span> ig_arcs_cnt <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">⦄</span></span>
      <span class="main"><span class="main">(</span></span><span class="keyword1"><span class="keyword1">MEASURE</span></span> ig_arcs_cnt <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">´</span></span>i<span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">_</span></span>"</span></span></span>
    annotate_named_loop_var<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_loopfree_0<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_loopfree_step1 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> is_loopfree_step2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_loopfree_last<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Procedure <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">select_nodes</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">select_nodes_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">⇒</span> IGraph <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">select_nodes_inv</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> set <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">v</span></span> <span class="main">∈</span> set <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> card <span class="main">(</span>ig_neighbors <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="bound">v</span><span class="main">)</span> <span class="main">≥</span> <span class="numeral">3</span><span class="main">}</span> <span class="main">∧</span> IGraph_inv <span class="free"><span class="bound"><span class="entity">H</span></span></span>"</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-select_nodes_inv_step"><span class="command">lemma</span></span> select_nodes_inv_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">G</span> <span class="free">H</span> <span class="free">i</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≡</span> ig_verts <span class="free">G</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> G_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"IGraph_inv <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sni_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"select_nodes_inv <span class="free">G</span> <span class="free">H</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> ig_verts_cnt <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">H'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="numeral">3</span> <span class="main">≤</span> card <span class="main">(</span>ig_neighbors <span class="free">G</span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">then</span> ig_add_v <span class="free">H</span> <span class="free">v</span> <span class="keyword1">else</span> <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"select_nodes_inv <span class="free">G</span> <span class="free">H'</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"IGraph_inv <span class="free">H'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sni_inv H'
    <span class="keyword1"><span class="command">unfolding</span></span> IGraph_inv_def select_nodes_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> take_Suc_i<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span> <span class="main">=</span> take <span class="free">i</span> <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">v</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> less <span class="keyword1"><span class="command">unfolding</span></span> v_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Suc_conv_app_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> set <span class="main">(</span>take <span class="free">i</span> <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> G_inv less distinct_ig_verts <span class="keyword1"><span class="command">unfolding</span></span> v_def IGraph_inv_conv
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distinct_conv_nth in_set_conv_nth<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> select_nodes_inv_def <span class="keyword1"><span class="command">using</span></span> X sni_inv
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Suc_i select_nodes_inv_def H'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">select_nodes_prop</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">⇒</span> IGraph <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">select_nodes_prop</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">≡</span> pverts <span class="main">(</span>mk_graph <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">)</span> <span class="main">=</span> verts3 <span class="main">(</span>mk_graph <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> select_nodes_impl<span class="main">)</span> select_nodes_spec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>t</sub></span> <span class="main">⦃</span><span class="bound">σ</span><span class="main">.</span> IGraph_inv <span class="main">´</span>G<span class="main">⦄</span> <span class="main">´</span>R <span class="main">:==</span> <span class="keyword1">PROC</span> select_nodes<span class="main">(</span><span class="main">´</span>G<span class="main">)</span>
   <span class="main">⦃</span> select_nodes_prop <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>G <span class="main">´</span>R <span class="main">∧</span> IGraph_inv <span class="main">´</span>R <span class="main">∧</span> set <span class="main">(</span>ig_arcs <span class="main">´</span>R<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_step</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span>
    <span class="quasi_keyword">at</span> <span class="quoted"><span class="quoted"><span class="quoted">"whileAnno <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">(</span></span>named_loop <span class="inner_quoted"><span class="inner_quoted">''loop''</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">σ</span></span><span class="main"><span class="main">)</span></span>
    <span class="quasi_keyword">to</span> <span class="quoted"><span class="quoted"><span class="quoted">"whileAnno <span class="main"><span class="main">_</span></span>
      <span class="main"><span class="main">⦃</span></span> select_nodes_inv <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">´</span></span>R <span class="main"><span class="main">´</span></span>i <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>i <span class="main"><span class="main">≤</span></span> ig_verts_cnt <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">=</span></span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>G  <span class="main"><span class="main">∧</span></span> IGraph_inv <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">∧</span></span> set <span class="main"><span class="main">(</span></span>ig_arcs <span class="main"><span class="main">´</span></span>R<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">{}</span></span><span class="main"><span class="main">⦄</span></span>
      <span class="main"><span class="main">(</span></span><span class="keyword1"><span class="keyword1">MEASURE</span></span> ig_verts_cnt <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">´</span></span>i<span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">_</span></span>"</span></span></span>
    annotate_named_loop_var<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> select_nodes_inv_def IGraph_inv_def mkg'_simps<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> select_nodes_inv_step<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> select_nodes_inv_def select_nodes_prop_def card_ig_neighbors_indegree verts3_def mkg_simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Procedure <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">find_endpoint</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">find_endpoint_path_inv</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_endpoint_path_inv</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="free"><span class="bound"><span class="entity">len</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span>
    <span class="main">∃</span><span class="bound">p</span><span class="main">.</span> pre_digraph.awalk <span class="main">(</span>mk_graph <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> length <span class="bound">p</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">len</span></span></span> <span class="main">∧</span>
      hd <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">∧</span> last <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">∧</span>
      set <span class="main">(</span>pre_digraph.inner_verts <span class="main">(</span>mk_graph <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span>
      progressing <span class="bound">p</span> "</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">find_endpoint_arcs_inv</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_endpoint_arcs_inv</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">found</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v0'</span></span></span> <span class="free"><span class="bound"><span class="entity">v1'</span></span></span> <span class="main">≡</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">found</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">v1'</span></span></span> <span class="main">=</span> ig_opposite <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">(</span>ig_in_out_arcs <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">v0'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">v1'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">¬</span><span class="free"><span class="bound"><span class="entity">found</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">=</span> ig_opposite <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">(</span>ig_in_out_arcs <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v0'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v1'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-find_endpoint_path_first"><span class="command">lemma</span></span> find_endpoint_path_first<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"iadj <span class="free">G</span> <span class="free">u</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"IGraph_inv <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"find_endpoint_path_inv <span class="free">G</span> <span class="free">H</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">u</span> <span class="free">v</span> <span class="free">u</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> ppg<span class="main">:</span> pair_pseudo_graph <span class="quoted"><span class="quoted">"mk_graph <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> IGraph_imp_ppg_mkg<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="main">∈</span> parcs <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> iadj_def mkg_simps symcl_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ppg.awalk <span class="free">u</span> <span class="main">[</span><span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">]</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="main">[</span><span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">[</span><span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="main">[</span><span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"progressing <span class="main">[</span><span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ppg.awalk_simps iadj_imp_verts mkg_simps progressing_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>ppg.inner_verts <span class="main">[</span><span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>ig_verts <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ppg.inner_verts_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> find_endpoint_path_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-find_endpoint_arcs_0"><span class="command">lemma</span></span> find_endpoint_arcs_0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"find_endpoint_arcs_inv <span class="free">G</span> False <span class="main">0</span> <span class="free">v0</span> <span class="free">v1</span> <span class="free">v0</span> <span class="free">v1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> find_endpoint_arcs_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-find_endpoint_path_lastE"><span class="command">lemma</span></span> find_endpoint_path_lastE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"find_endpoint_path_inv <span class="free">G</span> <span class="free">H</span> <span class="free">len</span> <span class="free">u</span> <span class="free">v</span> <span class="free">w</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ig<span class="main">:</span> <span class="quoted"><span class="quoted">"IGraph_inv <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> lf<span class="main">:</span> <span class="quoted"><span class="quoted">"loop_free <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> snp<span class="main">:</span> <span class="quoted"><span class="quoted">"select_nodes_prop <span class="free">G</span> <span class="free">H</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">len</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">p</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"pre_digraph.awalk <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="main">#</span> <span class="free">p</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"progressing <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="main">#</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>pre_digraph.inner_verts <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="main">#</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>ig_verts <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">len</span> <span class="main">≤</span> ig_verts_cnt <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> ig <span class="keyword2"><span class="keyword">and</span></span> lf <span class="keyword1"><span class="command">interpret</span></span> pair_graph <span class="quoted"><span class="quoted">"mk_graph <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> IGraph_lf_imp_pg_mkg<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"verts3 <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>ig_verts <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> select_nodes_prop_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkg_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"awalk <span class="free">u</span> <span class="skolem">q</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">q</span> <span class="main">=</span> <span class="free">len</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> iv<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>inner_verts <span class="skolem">q</span><span class="main">)</span> <span class="main">∩</span> verts3 <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> prg<span class="main">:</span> <span class="quoted"><span class="quoted">"progressing <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> find_endpoint_path_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q0</span></span> <span class="skolem"><span class="skolem">qs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="skolem">q0</span> <span class="main">#</span> <span class="skolem">qs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">len</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">len</span> <span class="main">≤</span> ig_verts_cnt <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> ev_q<span class="main">:</span> <span class="quoted"><span class="quoted">"awalk_verts <span class="free">u</span> <span class="skolem">q</span> <span class="main">=</span> <span class="free">u</span> <span class="main">#</span> inner_verts <span class="skolem">q</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inner_verts_conv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> q <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">=</span> <span class="skolem">q0</span> <span class="main">#</span> <span class="skolem">qs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> len_ev<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>awalk_verts <span class="free">u</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">+</span> length <span class="main">(</span>inner_verts <span class="skolem">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> set_av<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>awalk_verts <span class="free">u</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">⊆</span> pverts <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> q<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> snp u <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> verts3 <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> _ _ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>inner_verts  <span class="skolem">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> q<span class="main">(</span>1<span class="main">)</span> iv prg <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> verts2_awalk_distinct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> verts3_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">u</span> <span class="main">#</span> inner_verts <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> iv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="free">u</span> <span class="main">#</span> inner_verts <span class="skolem">q</span><span class="main">)</span> <span class="main">⊆</span> pverts <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ev_q set_av <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="free">u</span> <span class="main">#</span> inner_verts <span class="skolem">q</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>pverts <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_mono distinct_card finite_set verts_mkg<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>awalk_verts <span class="free">u</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> card <span class="main">(</span>pverts <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> len_ev<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">q</span> <span class="main">≤</span> card <span class="main">(</span>pverts <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_awalk_verts<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> ig_verts_cnt <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkg_simps card_length<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> q<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> that<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-find_endpoint_path_last1"><span class="command">lemma</span></span> find_endpoint_path_last1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"find_endpoint_path_inv <span class="free">G</span> <span class="free">H</span> <span class="free">len</span> <span class="free">u</span> <span class="free">v</span> <span class="free">w</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ig<span class="main">:</span> <span class="quoted"><span class="quoted">"IGraph_inv <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> lf<span class="main">:</span> <span class="quoted"><span class="quoted">"loop_free <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> snp<span class="main">:</span> <span class="quoted"><span class="quoted">"select_nodes_prop <span class="free">G</span> <span class="free">H</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">len</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">H</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">H</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">.</span> pre_digraph.iapath <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="main">#</span> <span class="bound">p</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> ig <span class="keyword2"><span class="keyword">and</span></span> lf <span class="keyword1"><span class="command">interpret</span></span> pair_graph <span class="quoted"><span class="quoted">"mk_graph <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> IGraph_lf_imp_pg_mkg<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"verts3 <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>ig_verts <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> pverts <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> select_nodes_prop_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkg_simps verts3_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> find_endpoint_path_lastE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-5<span class="main"><span class="main">)</span></span> mem<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> deg2_awalk_is_iapath<span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 2<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mem<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-find_endpoint_path_last2D"><span class="command">lemma</span></span> find_endpoint_path_last2D<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">"find_endpoint_path_inv <span class="free">G</span> <span class="free">H</span> <span class="free">len</span> <span class="free">u</span> <span class="free">v</span> <span class="free">w</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ig<span class="main">:</span> <span class="quoted"><span class="quoted">"IGraph_inv <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> lf<span class="main">:</span> <span class="quoted"><span class="quoted">"loop_free <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> snp<span class="main">:</span> <span class="quoted"><span class="quoted">"select_nodes_prop <span class="free">G</span> <span class="free">H</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">len</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> iapath<span class="main">:</span> <span class="quoted"><span class="quoted">"pre_digraph.iapath <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="main">#</span> <span class="free">p</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted">False</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> ig <span class="keyword2"><span class="keyword">and</span></span> lf <span class="keyword1"><span class="command">interpret</span></span> pair_graph <span class="quoted"><span class="quoted">"mk_graph <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> IGraph_lf_imp_pg_mkg<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"verts3 <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>ig_verts <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> select_nodes_prop_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkg_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"verts3 <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="main">⊆</span> verts3 <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"verts3 <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="main">⊆</span> pverts <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> verts3_in_verts<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> G<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"mk_graph <span class="free">G</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> walk_q<span class="main">:</span> <span class="quoted"><span class="quoted">"awalk <span class="free">u</span> <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">q</span><span class="main">)</span> <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      progress_q<span class="main">:</span> <span class="quoted"><span class="quoted">"progressing <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      iv_q<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>inner_verts  <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> verts3 <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> find_endpoint_path_lastE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> path ig lf snp <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">len</span>›</span></span> mem<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> iapath <span class="keyword1"><span class="command">have</span></span> walk_p<span class="main">:</span> <span class="quoted"><span class="quoted">"awalk <span class="free">u</span> <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="main">#</span> <span class="free">p</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      iv_p<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>inner_verts <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">#</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> verts3 <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      uv_verts3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> verts3 <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> verts3 <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gen_iapath_def apath_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> iapath <span class="keyword1"><span class="command">have</span></span> progress_p<span class="main">:</span> <span class="quoted"><span class="quoted">"progressing <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="main">#</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gen_iapath_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> apath_imp_progressing<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> V walk_q walk_p progress_q progress_p iv_q iv_p
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="main">#</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> same_awalk_by_common_arc<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> e<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> uv_verts3
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> iapath apath_nonempty_ends gen_iapath_def awalk_nonempty_ends<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> walk_p walk_q<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-find_endpoint_arcs_last"><span class="command">lemma</span></span> find_endpoint_arcs_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> arcs<span class="main">:</span> <span class="quoted"><span class="quoted">"find_endpoint_arcs_inv <span class="free">G</span> False <span class="main">(</span>length <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="free">v1</span><span class="main">)</span><span class="main">)</span> <span class="free">v0</span> <span class="free">v1</span> <span class="free">v0a</span> <span class="free">v1a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">"find_endpoint_path_inv <span class="free">G</span> <span class="free">H</span> <span class="free">len</span> <span class="free">v_tail</span> <span class="free">v_next</span> <span class="free">v0</span> <span class="free">v1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ig<span class="main">:</span> <span class="quoted"><span class="quoted">"IGraph_inv <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> lf<span class="main">:</span> <span class="quoted"><span class="quoted">"loop_free <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> snp<span class="main">:</span> <span class="quoted"><span class="quoted">"select_nodes_prop <span class="free">G</span> <span class="free">H</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v_tail</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">len</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> pre_digraph.iapath <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="free">v_tail</span> <span class="main">(</span><span class="main">(</span><span class="free">v_tail</span><span class="main">,</span> <span class="free">v_next</span><span class="main">)</span> <span class="main">#</span> <span class="free">p</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="var">?A</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span>

  <span class="keyword1"><span class="command">interpret</span></span> pair_graph <span class="quoted"><span class="quoted">"mk_graph <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ig lf <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> IGraph_lf_imp_pg_mkg<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> v3G_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"verts3 <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>ig_verts <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> select_nodes_prop_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkg_simps<span class="main">)</span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹
    If no extending edge was found (as implied by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> arcs<span class="antiquote"><span class="antiquote">}</span></span></span></span>), the last vertex of the walk
    computed (as implied by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> path<span class="antiquote"><span class="antiquote">}</span></span></span></span>) is of degree 1. Hence we consider all vertices
    except the degree-2 nodes.
  ›</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">V</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">v</span></span> <span class="main">∈</span> pverts <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span><span class="main">.</span> in_degree <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="bound">v</span> <span class="main">≠</span> <span class="numeral">2</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"verts3 <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">⊆</span> pverts <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> verts3_def V_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> walk_p<span class="main">:</span> <span class="quoted"><span class="quoted">"awalk <span class="free">v_tail</span> <span class="main">(</span><span class="main">(</span><span class="free">v_tail</span><span class="main">,</span> <span class="free">v_next</span><span class="main">)</span> <span class="main">#</span> <span class="free">p</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      progress_p<span class="main">:</span> <span class="quoted"><span class="quoted">"progressing <span class="main">(</span><span class="main">(</span><span class="free">v_tail</span><span class="main">,</span> <span class="free">v_next</span><span class="main">)</span> <span class="main">#</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gen_iapath_def apath_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> apath_imp_progressing<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> iapath_V_p<span class="main">:</span> <span class="quoted"><span class="quoted">"gen_iapath  <span class="skolem">V</span> <span class="free">v_tail</span> <span class="main">(</span><span class="main">(</span><span class="free">v_tail</span><span class="main">,</span> <span class="free">v_next</span><span class="main">)</span> <span class="main">#</span> <span class="free">p</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> set <span class="main">(</span>inner_verts <span class="main">(</span><span class="main">(</span><span class="free">v_tail</span><span class="main">,</span> <span class="free">v_next</span><span class="main">)</span> <span class="main">#</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> pverts <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?A</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 2 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_inner_verts gen_iapath_def apath_Cons_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> awalkI_apath<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="quoted"><span class="quoted">‹<span class="var">?A</span>›</span></span> inner_verts_min_degree<span class="main">[</span><span class="operator">OF</span> walk_p progress_p A<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∉</span> <span class="skolem">V</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> gen_iapath_def verts3_def V_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?A</span>›</span></span> V <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gen_iapath_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> arcs_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v_tail</span><span class="main">,</span> <span class="free">v_next</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="main">(</span><span class="free">v_tail</span><span class="main">,</span> <span class="free">v_next</span><span class="main">)</span> <span class="main">#</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gen_iapath_def apath_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> id_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> in_degree <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?A</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gen_iapath_def verts3_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> arcs <span class="keyword1"><span class="command">have</span></span> edge_no_pr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> set <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="free">v1</span><span class="main">)</span> <span class="main">⟹</span>
      <span class="free">v0</span> <span class="main">=</span> ig_opposite <span class="free">G</span> <span class="bound">e</span> <span class="free">v1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span><span class="quoted"><span class="quoted">"<span class="free">v0</span> <span class="main">=</span> <span class="free">v0a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">=</span> <span class="free">v1a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> find_endpoint_arcs_inv_def in_set_conv_nth<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">e</span></span> <span class="main">∈</span> parcs <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span><span class="main">.</span> snd <span class="bound">e</span> <span class="main">=</span> <span class="free">v1</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="free">v0</span><span class="main">,</span><span class="free">v1</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⊆</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">e</span> <span class="main">≠</span> snd <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> no_loops<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e</span> <span class="main">∈</span> <span class="var">?L</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> set <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="free">v1</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>snd <span class="skolem">e</span><span class="main">,</span> fst <span class="skolem">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="free">v1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkg_simps ig_in_out_arcs_def symcl_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v0</span> <span class="main">=</span> ig_opposite <span class="free">G</span> <span class="skolem">e</span> <span class="free">v1</span> <span class="main">∨</span> <span class="free">v0</span> <span class="main">=</span> ig_opposite <span class="free">G</span> <span class="main">(</span>snd <span class="skolem">e</span><span class="main">,</span> fst <span class="skolem">e</span><span class="main">)</span> <span class="free">v1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> edge_no_pr<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e</span> <span class="main">∈</span> <span class="var">?L</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ig_opposite_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> id_v1<span class="main">:</span> <span class="quoted"><span class="quoted">"in_degree <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="free">v1</span> <span class="main">≤</span> card <span class="main">{</span><span class="main">(</span><span class="free">v0</span><span class="main">,</span><span class="free">v1</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> in_degree_def in_arcs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_mono<span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> path <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> walk_q<span class="main">:</span> <span class="quoted"><span class="quoted">"awalk <span class="free">v_tail</span> <span class="skolem">q</span> <span class="free">v1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      q_props<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">q</span> <span class="main">=</span> <span class="free">len</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">v_tail</span><span class="main">,</span> <span class="free">v_next</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      iv_q'<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>inner_verts <span class="skolem">q</span><span class="main">)</span> <span class="main">∩</span> verts3 <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      progress_q<span class="main">:</span> <span class="quoted"><span class="quoted">"progressing <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> find_endpoint_path_inv_def v3G_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">∈</span> pverts <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> awalk_last_in_verts<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">∈</span> <span class="skolem">V</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> id_v1 <span class="keyword1"><span class="command">unfolding</span></span> V_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> set <span class="main">(</span>inner_verts <span class="skolem">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> set <span class="main">(</span>pawalk_verts <span class="free">v_tail</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> walk_q
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inner_verts_conv<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> u<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">v_tail</span></span><span class="main"><span class="main">]</span></span> awalk_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_set_butlastD list_set_tl<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> pverts <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> walk_q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> A iv_q' inner_verts_min_degree<span class="main">[</span><span class="operator">OF</span> walk_q progress_q A<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∉</span> <span class="skolem">V</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> verts3_def V_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> iv_q<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>inner_verts <span class="skolem">q</span><span class="main">)</span> <span class="main">∩</span> <span class="skolem">V</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> arcs_q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v_tail</span><span class="main">,</span> <span class="free">v_next</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> q_props <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">len</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v_tail</span> <span class="main">≠</span> <span class="free">v1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> find_endpoint_path_last2D<span class="main">[</span><span class="operator">OF</span> _ ig lf snp <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">len</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">v_tail</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?A</span>›</span></span><span class="main">]</span> path <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> in_V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v_tail</span> <span class="main">∈</span> <span class="skolem">V</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> iapath_V_p <span class="keyword1"><span class="command">unfolding</span></span> gen_iapath_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> iapath_V_q<span class="main">:</span> <span class="quoted"><span class="quoted">"gen_iapath <span class="skolem">V</span> <span class="free">v_tail</span> <span class="skolem">q</span> <span class="free">v1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> V walk_q iv_q progress_q in_V <span class="quoted"><span class="quoted">‹<span class="free">v1</span> <span class="main">∈</span> <span class="skolem">V</span>›</span></span> neq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> deg2_awalk_is_iapath<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">v_tail</span><span class="main">,</span> <span class="free">v_next</span><span class="main">)</span> <span class="main">#</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> V iapath_V_p iapath_V_q arcs_p arcs_q
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> same_gen_iapath_by_common_arc<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> walk_p walk_q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> id_v1 id_x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-find_endpoint_arcs_step1E"><span class="command">lemma</span></span> find_endpoint_arcs_step1E<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"find_endpoint_arcs_inv <span class="free">G</span> False <span class="free">k</span> <span class="free">v0</span> <span class="free">v1</span> <span class="free">v0'</span> <span class="free">v1'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ig_opposite <span class="free">G</span> <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="free">v1</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="free">v1'</span> <span class="main">≠</span> <span class="free">v0'</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">v0</span> <span class="main">=</span> <span class="free">v0'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">=</span> <span class="free">v1'</span>"</span></span> <span class="quoted"><span class="quoted">"find_endpoint_arcs_inv <span class="free">G</span> True <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="free">v0</span> <span class="free">v1</span> <span class="free">v1</span> <span class="main">(</span>ig_opposite <span class="free">G</span> <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="free">v1</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="free">v1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> find_endpoint_arcs_inv_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> less_SucI <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> less_SucE<span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-find_endpoint_arcs_step2E"><span class="command">lemma</span></span> find_endpoint_arcs_step2E<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"find_endpoint_arcs_inv <span class="free">G</span> False <span class="free">k</span> <span class="free">v0</span> <span class="free">v1</span> <span class="free">v0'</span> <span class="free">v1'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ig_opposite <span class="free">G</span> <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="free">v1</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="free">v1'</span> <span class="main">=</span> <span class="free">v0'</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">v0</span> <span class="main">=</span> <span class="free">v0'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">=</span> <span class="free">v1'</span>"</span></span> <span class="quoted"><span class="quoted">"find_endpoint_arcs_inv <span class="free">G</span> False <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="free">v0</span> <span class="free">v1</span> <span class="free">v0</span> <span class="free">v1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> find_endpoint_arcs_inv_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> less_SucI <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> less_SucE<span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-find_endpoint_path_step"><span class="command">lemma</span></span> find_endpoint_path_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">"find_endpoint_path_inv <span class="free">G</span> <span class="free">H</span> <span class="free">len</span> <span class="free">u</span> <span class="free">v</span> <span class="free">w</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">len</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> arcs<span class="main">:</span> <span class="quoted"><span class="quoted">"find_endpoint_arcs_inv <span class="free">G</span> True <span class="free">k</span> <span class="free">w</span> <span class="free">x</span> <span class="free">w'</span> <span class="free">x'</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> length <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ig<span class="main">:</span> <span class="quoted"><span class="quoted">"IGraph_inv <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> not_end<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="main">(</span>ig_verts <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"find_endpoint_path_inv <span class="free">G</span> <span class="free">H</span> <span class="main">(</span>Suc <span class="free">len</span><span class="main">)</span> <span class="free">u</span> <span class="free">v</span> <span class="free">w'</span> <span class="free">x'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> pg<span class="main">:</span> pair_pseudo_graph <span class="quoted"><span class="quoted">"mk_graph <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ig <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> IGraph_imp_ppg_mkg<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> path <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> awalk<span class="main">:</span> <span class="quoted"><span class="quoted">"pg.awalk <span class="free">u</span> <span class="skolem">p</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      p<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">p</span> <span class="main">=</span> <span class="free">len</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      iv<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>pg.inner_verts <span class="skolem">p</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>ig_verts <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      progress<span class="main">:</span> <span class="quoted"><span class="quoted">"progressing <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> find_endpoint_path_inv_def<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">]</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> path <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> awalk pg.awalk_last_in_verts verts_mkg<span class="main">)</span>

  <span class="keyword1"><span class="command">with</span></span> arcs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"iadj <span class="free">G</span> <span class="free">x</span> <span class="free">x'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">w'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="free">x'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> find_endpoint_arcs_inv_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> iadj_io_edge<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span> <span class="main">∈</span> parcs <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x'</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ig <span class="keyword1"><span class="command">unfolding</span></span> iadj_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkg_simps set_ig_arcs_imp_verts symcl_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pg.awalk <span class="free">u</span> <span class="skolem">p'</span> <span class="free">x'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> p'_def <span class="keyword1"><span class="command">using</span></span> awalk <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pg.awalk_simps mkg_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">p'</span> <span class="main">=</span> Suc <span class="free">len</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">p'</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="skolem">p'</span> <span class="main">=</span> <span class="main">(</span><span class="free">w'</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> <span class="free">w'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">len</span>›</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>pg.inner_verts <span class="skolem">p'</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>ig_verts <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> iv not_end p <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">len</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pg.inner_verts_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ys</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="skolem">zs</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">≠</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">z</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">zs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="var">?A</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span>
      <span class="keyword1"><span class="command">from</span></span> progress <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">zs</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">z</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span> <span class="main">#</span> <span class="bound">zs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> progressing_append_iff progressing_Cons<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">zs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?A</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">≠</span> <span class="free">x'</span>›</span></span> <span class="quoted"><span class="quoted">‹last <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">w</span><span class="main">,</span><span class="free">x</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"progressing <span class="skolem">p'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> progressing_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> find_endpoint_path_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-no_loop_path"><span class="command">lemma</span></span> no_loop_path<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ig<span class="main">:</span> <span class="quoted"><span class="quoted">"IGraph_inv <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">w</span><span class="main">.</span> pre_digraph.iapath <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">#</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">w</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> ppg<span class="main">:</span> pair_pseudo_graph <span class="quoted"><span class="quoted">"mk_graph <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ig <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> IGraph_imp_ppg_mkg<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">=</span> <span class="free">v</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ppg.gen_iapath_def ppg.apath_Cons_iff<span class="main">)</span>
       <span class="main">(</span><span class="operator">metis</span> hd_in_set ppg.awalk_verts_non_Nil ppg.awhd_of_awalk pre_digraph.awalkI_apath<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> find_endpoint_impl<span class="main">)</span> find_endpoint_spec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>t</sub></span> <span class="main">⦃</span><span class="bound">σ</span><span class="main">.</span> select_nodes_prop <span class="main">´</span>G <span class="main">´</span>H <span class="main">∧</span> loop_free <span class="main">(</span>mk_graph <span class="main">´</span>G<span class="main">)</span> <span class="main">∧</span> <span class="main">´</span>v_tail <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="main">´</span>H<span class="main">)</span> <span class="main">∧</span> iadj <span class="main">´</span>G <span class="main">´</span>v_tail <span class="main">´</span>v_next <span class="main">∧</span> IGraph_inv <span class="main">´</span>G<span class="main">⦄</span>
    <span class="main">´</span>R <span class="main">:==</span> <span class="keyword1">PROC</span> find_endpoint<span class="main">(</span><span class="main">´</span>G<span class="main">,</span> <span class="main">´</span>H<span class="main">,</span> <span class="main">´</span>v_tail<span class="main">,</span> <span class="main">´</span>v_next<span class="main">)</span>
  <span class="main">⦃</span><span class="keyword1">case</span> <span class="main">´</span>R <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">w</span><span class="main">.</span> pre_digraph.iapath <span class="main">(</span>mk_graph <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>G<span class="main">)</span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>v_tail <span class="main">(</span><span class="main">(</span><span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>v_tail<span class="main">,</span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>v_next<span class="main">)</span> <span class="main">#</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">w</span><span class="main">)</span>
    <span class="main">|</span> Some <span class="bound">w</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> pre_digraph.iapath <span class="main">(</span>mk_graph <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>G<span class="main">)</span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>v_tail <span class="main">(</span><span class="main">(</span><span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>v_tail<span class="main">,</span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>v_next<span class="main">)</span> <span class="main">#</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">w</span><span class="main">)</span> <span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_step</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span>
    <span class="quasi_keyword">at</span> <span class="quoted"><span class="quoted"><span class="quoted">"whileAnno <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">(</span></span>named_loop <span class="inner_quoted"><span class="inner_quoted">''path''</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">σ</span></span><span class="main"><span class="main">)</span></span>
    <span class="quasi_keyword">to</span> <span class="quoted"><span class="quoted"><span class="quoted">"whileAnno <span class="main"><span class="main">_</span></span>
      <span class="main"><span class="main">⦃</span></span> find_endpoint_path_inv <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">´</span></span>H <span class="main"><span class="main">´</span></span>len <span class="main"><span class="main">´</span></span>v_tail <span class="main"><span class="main">´</span></span>v_next <span class="main"><span class="main">´</span></span>v0 <span class="main"><span class="main">´</span></span>v1
        <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>v_tail <span class="main"><span class="main">=</span></span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>v_tail <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>v_next <span class="main"><span class="main">=</span></span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>v_next <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">=</span></span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>G <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>H <span class="main"><span class="main">=</span></span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>H
        <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">0</span></span> <span class="main"><span class="main">&lt;</span></span> <span class="main"><span class="main">´</span></span> len
        <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>v_tail <span class="main"><span class="main">∈</span></span> set <span class="main"><span class="main">(</span></span>ig_verts <span class="main"><span class="main">´</span></span>H<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∧</span></span> select_nodes_prop <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">´</span></span>H <span class="main"><span class="main">∧</span></span> IGraph_inv <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">∧</span></span> loop_free <span class="main"><span class="main">(</span></span>mk_graph <span class="main"><span class="main">´</span></span>G<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">⦄</span></span>
      <span class="main"><span class="main">(</span></span><span class="keyword1"><span class="keyword1">MEASURE</span></span> Suc <span class="main"><span class="main">(</span></span>ig_verts_cnt <span class="main"><span class="main">´</span></span>G<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">´</span></span>len<span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">_</span></span>"</span></span></span>
    annotate_named_loop_var<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span>
    <span class="quasi_keyword">at</span> <span class="quoted"><span class="quoted"><span class="quoted">"whileAnno <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">(</span></span>named_loop <span class="inner_quoted"><span class="inner_quoted">''arcs''</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">σ</span></span><span class="main"><span class="main">)</span></span>
    <span class="quasi_keyword">to</span> <span class="quoted"><span class="quoted"><span class="quoted">"whileAnnoFix <span class="main"><span class="main">_</span></span>
      <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">v0</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">v1</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">len</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⦃</span></span> find_endpoint_arcs_inv <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">´</span></span>found <span class="main"><span class="main">´</span></span>i <span class="bound"><span class="bound">v0</span></span> <span class="bound"><span class="bound">v1</span></span> <span class="main"><span class="main">´</span></span>v0 <span class="main"><span class="main">´</span></span>v1
        <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>i <span class="main"><span class="main">≤</span></span> length <span class="main"><span class="main">(</span></span>ig_in_out_arcs <span class="main"><span class="main">´</span></span>G <span class="bound"><span class="bound">v1</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>io_arcs <span class="main"><span class="main">=</span></span> ig_in_out_arcs <span class="main"><span class="main">´</span></span>G <span class="bound"><span class="bound">v1</span></span>
        <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>v_tail <span class="main"><span class="main">=</span></span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>v_tail <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>v_next <span class="main"><span class="main">=</span></span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>v_next <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">=</span></span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>G <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>H <span class="main"><span class="main">=</span></span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span> H
        <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>len <span class="main"><span class="main">=</span></span> <span class="bound"><span class="bound">len</span></span>
        <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>v_tail <span class="main"><span class="main">∈</span></span> set <span class="main"><span class="main">(</span></span>ig_verts <span class="main"><span class="main">´</span></span>H<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∧</span></span> select_nodes_prop <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">´</span></span>H <span class="main"><span class="main">∧</span></span> IGraph_inv <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">⦄</span></span><span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="keyword1"><span class="keyword1">MEASURE</span></span> length <span class="main"><span class="main">´</span></span>io_arcs <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">´</span></span>i<span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">_</span></span>"</span></span></span>
    annotate_named_loop_var_fix<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> find_endpoint_path_first no_loop_path<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">match</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">premises</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted">"find_endpoint_path_inv <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="skolem">v0</span> <span class="skolem">v1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">v0</span> <span class="skolem">v1</span>
      <span class="main"><span class="main">⇒</span></span> <span class="quoted">‹<span class="operator">rule</span> exI<span class="main">[</span><span class="operator">where</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">v0</span></span><span class="main">]</span><span class="keyword3">,</span> <span class="operator">rule</span> exI<span class="main">[</span><span class="operator">where</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">v1</span></span><span class="main">]</span>›</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> find_endpoint_arcs_last find_endpoint_arcs_0 find_endpoint_path_step <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> find_endpoint_path_lastE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> find_endpoint_arcs_step1E find_endpoint_arcs_step2E<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> find_endpoint_path_last1 find_endpoint_path_last2D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Procedure <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">contract</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">contract_iter_nodes_inv</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">contract_iter_nodes_inv</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≡</span>
    set <span class="main">(</span>ig_arcs <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="bound">u</span> <span class="main">=</span> <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> pre_digraph.iapath <span class="main">(</span>mk_graph <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="bound">u</span> <span class="bound">p</span> <span class="bound">v</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">contract_iter_adj_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">⇒</span> IGraph <span class="main">⇒</span> IGraph <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">contract_iter_adj_inv</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">H0</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> <span class="main">(</span>set <span class="main">(</span>ig_arcs <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>ig_arcs <span class="free"><span class="bound"><span class="entity">H0</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    ig_verts <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">=</span> ig_verts <span class="free"><span class="bound"><span class="entity">H0</span></span></span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">)</span> <span class="main">⟷</span>
      <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">.</span> <span class="main">∃</span><span class="bound">p</span><span class="main">.</span> pre_digraph.iapath <span class="main">(</span>mk_graph <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> ig_opposite <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">(</span>ig_in_out_arcs <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-contract_iter_adj_invE"><span class="command">lemma</span></span> contract_iter_adj_invE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"contract_iter_adj_inv <span class="free">G</span> <span class="free">H0</span> <span class="free">H</span> <span class="free">u</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>ig_arcs <span class="free">H</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>ig_arcs <span class="free">H0</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"ig_verts <span class="free">H</span> <span class="main">=</span> ig_verts <span class="free">H0</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free">H</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free">l</span><span class="main">.</span> <span class="main">∃</span><span class="bound">p</span><span class="main">.</span> pre_digraph.iapath <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span> ig_opposite <span class="free">G</span> <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="free">u</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span> <span class="main">#</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> contract_iter_adj_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-contract_iter_adj_inv_def'"><span class="command">lemma</span></span> contract_iter_adj_inv_def'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"contract_iter_adj_inv <span class="free">G</span> <span class="free">H0</span> <span class="free">H</span> <span class="free">u</span> <span class="free">l</span> <span class="main">⟷</span> <span class="main">(</span>
    set <span class="main">(</span>ig_arcs <span class="free">H</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>ig_arcs <span class="free">H0</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> ig_verts <span class="free">H</span> <span class="main">=</span> ig_verts <span class="free">H0</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free">l</span><span class="main">.</span> <span class="main">∃</span><span class="bound">p</span><span class="main">.</span> pre_digraph.iapath <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span> ig_opposite <span class="free">G</span> <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="free">u</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span> <span class="main">#</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free">H</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free">l</span><span class="main">.</span> <span class="main">∃</span><span class="bound">p</span><span class="main">.</span> pre_digraph.iapath <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span> ig_opposite <span class="free">G</span> <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="free">u</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span> <span class="main">#</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> contract_iter_adj_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-select_nodes_prop_add_e"><span class="command">lemma</span></span> select_nodes_prop_add_e<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"select_nodes_prop <span class="free">G</span> <span class="main">(</span>ig_add_e <span class="free">H</span> <span class="free">u</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> select_nodes_prop <span class="free">G</span> <span class="free">H</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> select_nodes_prop_def mkg_simps<span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-contract_iter_adj_inv_step1"><span class="command">lemma</span></span> contract_iter_adj_inv_step1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pair_pseudo_graph <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ciai<span class="main">:</span> <span class="quoted"><span class="quoted">"contract_iter_adj_inv <span class="free">G</span> <span class="free">H0</span> <span class="free">H</span> <span class="free">u</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> iapath<span class="main">:</span> <span class="quoted"><span class="quoted">"pre_digraph.iapath <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span> ig_opposite <span class="free">G</span> <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="free">u</span> <span class="main">!</span> <span class="free">l</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span> <span class="main">#</span> <span class="free">p</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"contract_iter_adj_inv <span class="free">G</span> <span class="free">H0</span> <span class="main">(</span>ig_add_e <span class="free">H</span> <span class="free">u</span> <span class="free">w</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> pair_pseudo_graph <span class="quoted"><span class="quoted">"mk_graph <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> Suc <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">.</span> iapath <span class="free">u</span> <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span> ig_opposite <span class="free">G</span> <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="free">u</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span> <span class="main">#</span> <span class="bound">p</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="main">(</span>ig_add_e <span class="free">H</span> <span class="free">u</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">l</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> * ciai <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> contract_iter_adj_inv_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">with</span></span> *<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"iapath <span class="free">u</span> <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span> ig_opposite <span class="free">G</span> <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="free">u</span> <span class="main">!</span> <span class="free">l</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">with</span></span> iapath <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> verts3_in_verts<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> G<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"mk_graph <span class="free">G</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> gen_iapath_same2E<span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 2<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> ** iapath <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_digraph.gen_iapath_def pre_digraph.apath_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> pre_digraph.awalk_nonempty_ends<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="main">(</span>ig_add_e <span class="free">H</span> <span class="free">u</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>Suc <span class="free">l</span><span class="main">.</span> <span class="main">∃</span><span class="bound">p</span><span class="main">.</span> gen_iapath <span class="main">(</span>verts3 <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span> ig_opposite <span class="free">G</span> <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="free">u</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span> <span class="main">#</span> <span class="bound">p</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> iapath <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≠</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ciai *
        <span class="keyword1"><span class="command">unfolding</span></span> contract_iter_adj_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> less_SucI<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>ig_arcs <span class="main">(</span>ig_add_e <span class="free">H</span> <span class="free">u</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>ig_arcs <span class="free">H0</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"ig_verts <span class="main">(</span>ig_add_e <span class="free">H</span> <span class="free">u</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> ig_verts <span class="free">H0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ciai <span class="keyword1"><span class="command">unfolding</span></span> contract_iter_adj_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> contract_iter_adj_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-contract_iter_adj_inv_step2"><span class="command">lemma</span></span> contract_iter_adj_inv_step2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ciai<span class="main">:</span> <span class="quoted"><span class="quoted">"contract_iter_adj_inv <span class="free">G</span> <span class="free">H0</span> <span class="free">H</span> <span class="free">u</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> iapath<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">w</span><span class="main">.</span> <span class="main">¬</span>pre_digraph.iapath <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span> ig_opposite <span class="free">G</span> <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="free">u</span> <span class="main">!</span> <span class="free">l</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span> <span class="main">#</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"contract_iter_adj_inv <span class="free">G</span> <span class="free">H0</span> <span class="free">H</span> <span class="free">u</span> <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> Suc <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">.</span> pre_digraph.iapath <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span> ig_opposite <span class="free">G</span> <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="free">u</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span> <span class="main">#</span> <span class="bound">p</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">l</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> * ciai <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> contract_iter_adj_inv_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> iapath <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>Suc <span class="free">l</span><span class="main">.</span> <span class="main">∃</span><span class="bound">p</span><span class="main">.</span> pre_digraph.gen_iapath <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="main">(</span>verts3 <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span> ig_opposite <span class="free">G</span> <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="free">u</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span> <span class="main">#</span> <span class="bound">p</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ciai <span class="keyword1"><span class="command">unfolding</span></span> contract_iter_adj_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> less_SucI<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>ig_arcs <span class="free">H</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>ig_arcs <span class="free">H0</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"ig_verts <span class="free">H</span> <span class="main">=</span> ig_verts <span class="free">H0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ciai <span class="keyword1"><span class="command">unfolding</span></span> contract_iter_adj_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> contract_iter_adj_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">definition</span></span> <span class="entity">contract_iter_adj_prop</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">contract_iter_adj_prop</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">H0</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≡</span> ig_verts <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">=</span> ig_verts <span class="free"><span class="bound"><span class="entity">H0</span></span></span>
    <span class="main">∧</span> set <span class="main">(</span>ig_arcs <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>ig_arcs <span class="free"><span class="bound"><span class="entity">H0</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span><span class="bound">p</span><span class="main">.</span> pre_digraph.iapath <span class="main">(</span>mk_graph <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="bound">p</span> <span class="bound">v</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-contract_iter_adj_propI"><span class="command">lemma</span></span> contract_iter_adj_propI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nodes<span class="main">:</span> <span class="quoted"><span class="quoted">"contract_iter_nodes_inv <span class="free">G</span> <span class="free">H</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ciai<span class="main">:</span> <span class="quoted"><span class="quoted">"contract_iter_adj_inv <span class="free">G</span> <span class="free">H</span> <span class="free">H'</span> <span class="free">u</span> <span class="main">(</span>length <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> ig_verts <span class="free">H</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"contract_iter_adj_prop <span class="free">G</span> <span class="free">H</span> <span class="free">H'</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ig_verts <span class="free">H'</span> <span class="main">=</span> ig_verts <span class="free">H</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ciai <span class="keyword1"><span class="command">unfolding</span></span> contract_iter_adj_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>ig_arcs <span class="free">H'</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>ig_arcs <span class="free">H</span><span class="main">)</span> <span class="main">∪</span><span class="main">(</span><span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span><span class="bound">p</span><span class="main">.</span> pre_digraph.iapath <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="free">u</span> <span class="bound">p</span> <span class="bound">v</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ciai <span class="keyword1"><span class="command">unfolding</span></span> contract_iter_adj_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">p</span> <span class="keyword3"><span class="command">assume</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">"pre_digraph.iapath <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="free">u</span> <span class="skolem">p</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">e</span> <span class="main">#</span> <span class="skolem">es</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_digraph.gen_iapath_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> parcs <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> path
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_digraph.gen_iapath_def pre_digraph.apath_def pre_digraph.awalk_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">e</span> <span class="main">#</span> <span class="skolem">es</span>›</span></span> path
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_digraph.gen_iapath_def pre_digraph.apath_def pre_digraph.awalk_def pre_digraph.cas.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="skolem">w</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">w</span><span class="main">,</span><span class="free">u</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mk_graph_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> parcs_mk_symmetric mkg'_simps<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e'</span></span> <span class="keyword2"><span class="keyword">where</span></span> H1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e'</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="skolem">w</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">e'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">w</span><span class="main">,</span><span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e'</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e'</span> <span class="main">∈</span>  set <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="free">u</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ig_in_out_arcs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> H2<span class="main">:</span> <span class="quoted"><span class="quoted">"ig_in_out_arcs <span class="free">G</span> <span class="free">u</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">e'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="free">u</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> opp_e'<span class="main">:</span> <span class="quoted"><span class="quoted">"ig_opposite <span class="free">G</span> <span class="skolem">e'</span> <span class="free">u</span> <span class="main">=</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H1 <span class="keyword1"><span class="command">unfolding</span></span> ig_opposite_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free">H'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ciai <span class="keyword1"><span class="command">unfolding</span></span> contract_iter_adj_inv_def'
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> allE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">v</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> notE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">k</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> H2 opp_e'<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> path <span class="quoted"><span class="quoted">‹<span class="skolem">e</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="skolem">w</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">e</span> <span class="main">#</span> <span class="skolem">es</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>ig_arcs <span class="free">H</span><span class="main">)</span> <span class="main">∪</span><span class="main">(</span><span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span><span class="bound">p</span><span class="main">.</span> pre_digraph.iapath <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="free">u</span> <span class="bound">p</span> <span class="bound">v</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>ig_arcs <span class="free">H'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ciai <span class="keyword1"><span class="command">unfolding</span></span> contract_iter_adj_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> contract_iter_adj_prop_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-contract_iter_nodes_inv_step"><span class="command">lemma</span></span> contract_iter_nodes_inv_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nodes<span class="main">:</span> <span class="quoted"><span class="quoted">"contract_iter_nodes_inv <span class="free">G</span> <span class="free">H</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> adj<span class="main">:</span> <span class="quoted"><span class="quoted">"contract_iter_adj_inv <span class="free">G</span> <span class="free">H</span> <span class="free">H'</span> <span class="main">(</span>ig_verts <span class="free">H</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>length <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="main">(</span>ig_verts <span class="free">H</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> snp<span class="main">:</span> <span class="quoted"><span class="quoted">"select_nodes_prop <span class="free">G</span> <span class="free">H</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"contract_iter_nodes_inv <span class="free">G</span> <span class="free">H'</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> ciap<span class="main">:</span> <span class="quoted"><span class="quoted">"contract_iter_adj_prop <span class="free">G</span> <span class="free">H</span> <span class="free">H'</span> <span class="main">(</span>ig_verts <span class="free">H</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nodes adj <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> contract_iter_adj_propI<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ie_H'<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>ig_arcs <span class="free">H'</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>ig_arcs <span class="free">H</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="bound">u</span> <span class="main">=</span> ig_verts <span class="free">H'</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> pre_digraph.gen_iapath <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="main">(</span>verts3 <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="bound">u</span> <span class="bound">p</span> <span class="bound">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ig_verts <span class="free">H'</span> <span class="main">=</span> ig_verts <span class="free">H</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> contract_iter_adj_prop_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ie_H<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>ig_arcs <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">j</span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="bound">u</span> <span class="main">=</span> ig_verts <span class="free">H'</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> pre_digraph.gen_iapath <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="main">(</span>verts3 <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="bound">u</span> <span class="bound">p</span> <span class="bound">v</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nodes <span class="keyword1"><span class="command">unfolding</span></span> contract_iter_nodes_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">S</span> <span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span> <span class="main">&lt;</span> Suc <span class="bound">k</span><span class="main">.</span> <span class="bound">S</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">S</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∪</span> <span class="bound">S</span> <span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UN_insert lessThan_Suc sup_commute<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> contract_iter_nodes_inv_def ie_H ie_H' *<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-contract_iter_nodes_0"><span class="command">lemma</span></span> contract_iter_nodes_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>ig_arcs <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"contract_iter_nodes_inv <span class="free">G</span> <span class="free">H</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> contract_iter_nodes_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-contract_iter_adj_0"><span class="command">lemma</span></span> contract_iter_adj_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nodes<span class="main">:</span> <span class="quoted"><span class="quoted">"contract_iter_nodes_inv <span class="free">G</span> <span class="free">H</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> ig_verts_cnt <span class="free">H</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"contract_iter_adj_inv <span class="free">G</span> <span class="free">H</span> <span class="free">H</span> <span class="main">(</span>ig_verts <span class="free">H</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms distinct_ig_verts
  <span class="keyword1"><span class="command">unfolding</span></span> contract_iter_adj_inv_def contract_iter_nodes_inv_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distinct_conv_nth<span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-snp_vertexes"><span class="command">lemma</span></span> snp_vertexes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"select_nodes_prop <span class="free">G</span> <span class="free">H</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">H</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> select_nodes_prop_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> verts3_def mkg_simps<span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-igraph_ig_add_eI"><span class="command">lemma</span></span> igraph_ig_add_eI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"IGraph_inv <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"IGraph_inv <span class="main">(</span>ig_add_e <span class="free">G</span> <span class="free">u</span> <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> IGraph_inv_def  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-snp_iapath_ends_in"><span class="command">lemma</span></span> snp_iapath_ends_in<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"select_nodes_prop <span class="free">G</span> <span class="free">H</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pre_digraph.iapath <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="free">u</span> <span class="free">p</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">H</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> pre_digraph.gen_iapath_def select_nodes_prop_def verts3_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkg_simps<span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-contract_iter_nodes_last"><span class="command">lemma</span></span> contract_iter_nodes_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nodes<span class="main">:</span> <span class="quoted"><span class="quoted">"contract_iter_nodes_inv <span class="free">G</span> <span class="free">H</span> <span class="main">(</span>ig_verts_cnt <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> snp<span class="main">:</span> <span class="quoted"><span class="quoted">"select_nodes_prop <span class="free">G</span> <span class="free">H</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> igraph<span class="main">:</span> <span class="quoted"><span class="quoted">"IGraph_inv <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mk_graph' <span class="free">H</span> <span class="main">=</span> contr_graph <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?t1</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"symmetric <span class="main">(</span>mk_graph' <span class="free">H</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?t2</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> ppg_mkG<span class="main">:</span> pair_pseudo_graph <span class="quoted"><span class="quoted">"mk_graph <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> igraph <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> IGraph_imp_ppg_mkg<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">v</span> <span class="skolem">p</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"pre_digraph.iapath <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="skolem">u</span> <span class="skolem">p</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">.</span> pre_digraph.iapath <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="skolem">v</span> <span class="bound">p</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ppg_mkG.gen_iapath_rev_path<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> u<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> v<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">v</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ie_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> pre_digraph.iapath <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="bound">u</span> <span class="bound">p</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> pre_digraph.iapath <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="bound">v</span> <span class="bound">p</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> nodes <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>ig_arcs <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">H</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> pre_digraph.gen_iapath <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="main">(</span>verts3 <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="bound">u</span> <span class="bound">p</span> <span class="bound">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> contract_iter_nodes_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>ig_arcs <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">.</span>  <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> pre_digraph.iapath <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="bound">u</span> <span class="bound">p</span> <span class="bound">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> snp <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> snp_iapath_ends_in<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>ig_arcs <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> pre_digraph.iapath <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="bound">u</span> <span class="bound">p</span> <span class="bound">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ie_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">have</span></span> sym<span class="main">:</span> <span class="quoted"><span class="quoted">"symmetric <span class="main">(</span>mk_graph' <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> symmetric_conv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkg'_simps * ie_sym<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pverts <span class="main">(</span>mk_graph' <span class="free">H</span><span class="main">)</span> <span class="main">=</span> verts3 <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> snp <span class="keyword1"><span class="command">unfolding</span></span> select_nodes_prop_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mkg_simps mkg'_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"parcs <span class="main">(</span>mk_graph' <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> ppg_mkG.iapath <span class="bound">u</span> <span class="bound">p</span> <span class="bound">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> *  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkg_simps mkg'_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?t1</span></span></span> <span class="var"><span class="quoted"><span class="var">?t2</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> snp sym <span class="keyword1"><span class="command">unfolding</span></span> gen_contr_graph_def select_nodes_prop_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> contract_impl<span class="main">)</span> contract_spec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>t</sub></span> <span class="main">⦃</span><span class="bound">σ</span><span class="main">.</span> select_nodes_prop <span class="main">´</span>G <span class="main">´</span>H <span class="main">∧</span> IGraph_inv <span class="main">´</span>G <span class="main">∧</span> loop_free <span class="main">(</span>mk_graph <span class="main">´</span>G<span class="main">)</span> <span class="main">∧</span> IGraph_inv <span class="main">´</span>H <span class="main">∧</span> set <span class="main">(</span>ig_arcs <span class="main">´</span>H<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">⦄</span>
    <span class="main">´</span>R <span class="main">:==</span> <span class="keyword1">PROC</span> contract<span class="main">(</span><span class="main">´</span>G<span class="main">,</span> <span class="main">´</span>H<span class="main">)</span>
  <span class="main">⦃</span><span class="main">´</span>G <span class="main">=</span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>G <span class="main">∧</span> mk_graph' <span class="main">´</span>R <span class="main">=</span> contr_graph <span class="main">(</span>mk_graph <span class="main">´</span>G<span class="main">)</span> <span class="main">∧</span> symmetric <span class="main">(</span>mk_graph' <span class="main">´</span>R<span class="main">)</span> <span class="main">∧</span> IGraph_inv <span class="main">´</span>R<span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_step</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span>
    <span class="quasi_keyword">at</span> <span class="quoted"><span class="quoted"><span class="quoted">"whileAnno <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">(</span></span>named_loop <span class="inner_quoted"><span class="inner_quoted">''iter_nodes''</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">σ</span></span><span class="main"><span class="main">)</span></span>
    <span class="quasi_keyword">to</span> <span class="quoted"><span class="quoted"><span class="quoted">"whileAnno <span class="main"><span class="main">_</span></span>
      <span class="main"><span class="main">⦃</span></span>contract_iter_nodes_inv <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">´</span></span>H <span class="main"><span class="main">´</span></span>i
        <span class="main"><span class="main">∧</span></span> select_nodes_prop <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">´</span></span>H <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>i <span class="main"><span class="main">≤</span></span> ig_verts_cnt <span class="main"><span class="main">´</span></span>H <span class="main"><span class="main">∧</span></span> IGraph_inv <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">∧</span></span> loop_free <span class="main"><span class="main">(</span></span>mk_graph <span class="main"><span class="main">´</span></span>G<span class="main"><span class="main">)</span></span>
        <span class="main"><span class="main">∧</span></span> IGraph_inv <span class="main"><span class="main">´</span></span>H  <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">=</span></span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>G<span class="main"><span class="main">⦄</span></span>
      <span class="main"><span class="main">(</span></span><span class="keyword1"><span class="keyword1">MEASURE</span></span> ig_verts_cnt <span class="main"><span class="main">´</span></span>H <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">´</span></span>i<span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">_</span></span>"</span></span></span>
    annotate_named_loop_var<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span>
    <span class="quasi_keyword">at</span> <span class="quoted"><span class="quoted"><span class="quoted">"whileAnno <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">(</span></span>named_loop <span class="inner_quoted"><span class="inner_quoted">''iter_adj''</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">σ</span></span><span class="main"><span class="main">)</span></span>
    <span class="quasi_keyword">to</span> <span class="quoted"><span class="quoted"><span class="quoted">"whileAnnoFix <span class="main"><span class="main">_</span></span>
      <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">H</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">u</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⦃</span></span>contract_iter_adj_inv <span class="main"><span class="main">´</span></span>G <span class="bound"><span class="bound">H</span></span> <span class="main"><span class="main">´</span></span>H <span class="bound"><span class="bound">u</span></span> <span class="main"><span class="main">´</span></span>j
        <span class="main"><span class="main">∧</span></span> select_nodes_prop <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">´</span></span>H <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>u <span class="main"><span class="main">=</span></span> <span class="bound"><span class="bound">u</span></span> <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>j <span class="main"><span class="main">≤</span></span> length <span class="main"><span class="main">(</span></span>ig_in_out_arcs <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">´</span></span>u<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>io_arcs <span class="main"><span class="main">=</span></span> ig_in_out_arcs <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">´</span></span>u
        <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">u</span></span> <span class="main"><span class="main">∈</span></span> set <span class="main"><span class="main">(</span></span>ig_verts <span class="main"><span class="main">´</span></span>H<span class="main"><span class="main">)</span></span>  <span class="main"><span class="main">∧</span></span>  IGraph_inv <span class="main"><span class="main">´</span></span>G  <span class="main"><span class="main">∧</span></span> loop_free <span class="main"><span class="main">(</span></span>mk_graph <span class="main"><span class="main">´</span></span>G<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∧</span></span> IGraph_inv <span class="main"><span class="main">´</span></span>H <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">=</span></span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>G <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>i <span class="main"><span class="main">=</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">⦄</span></span><span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="keyword1"><span class="keyword1">MEASURE</span></span> length <span class="main"><span class="main">´</span></span>io_arcs <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">´</span></span>j<span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">_</span></span>"</span></span></span>
    annotate_named_loop_var_fix<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> contract_iter_nodes_0<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">match</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">premises</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted">"select_nodes_prop <span class="main">_</span> <span class="skolem">H</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">H</span> <span class="main"><span class="main">⇒</span></span> <span class="quoted">‹<span class="operator">rule</span> exI<span class="main">[</span><span class="operator">where</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">H</span></span><span class="main">]</span>›</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> contract_iter_adj_0 contract_iter_nodes_inv_step <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> contract_iter_adj_invE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> contract_iter_adj_inv_step2 contract_iter_adj_inv_step1
     IGraph_imp_ppg_mkg igraph_ig_add_eI snp_iapath_ends_in iadj_io_edge snp_vertexes<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_less <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> contract_iter_nodes_last<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Procedure <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">is_K33</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_K33_colorize_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">⇒</span> ig_vertex <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span>ig_vertex <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_K33_colorize_inv</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">blue</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">blue</span></span></span> <span class="bound">v</span> <span class="main">⟷</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">.</span> <span class="bound">v</span> <span class="main">=</span> ig_opposite <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">(</span>ig_in_out_arcs <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_K33_component_size_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span>ig_vertex <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_K33_component_size_inv</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">blue</span></span></span> <span class="free"><span class="bound"><span class="entity">cnt</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">cnt</span></span></span> <span class="main">=</span> card <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">blue</span></span></span> <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_K33_outer_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span>ig_vertex <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_K33_outer_inv</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">blue</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">.</span>
    <span class="free"><span class="bound"><span class="entity">blue</span></span></span> <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">blue</span></span></span> <span class="bound">v</span> <span class="main">⟷</span> <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>ig_arcs <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_K33_inner_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span>ig_vertex <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_K33_inner_inv</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">blue</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">.</span>
    <span class="free"><span class="bound"><span class="entity">blue</span></span></span> <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">blue</span></span></span> <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> ig_verts <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>ig_arcs <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-is_K33_colorize_0"><span class="command">lemma</span></span> is_K33_colorize_0<span class="main">:</span> <span class="quoted"><span class="quoted">"is_K33_colorize_inv <span class="free">G</span> <span class="free">u</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_K33_colorize_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-is_K33_component_size_0"><span class="command">lemma</span></span> is_K33_component_size_0<span class="main">:</span> <span class="quoted"><span class="quoted">"is_K33_component_size_inv <span class="free">G</span> <span class="main">0</span> <span class="free">blue</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_K33_component_size_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-is_K33_outer_0"><span class="command">lemma</span></span> is_K33_outer_0<span class="main">:</span> <span class="quoted"><span class="quoted">"is_K33_outer_inv <span class="free">G</span> <span class="main">0</span> <span class="free">blue</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_K33_outer_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-is_K33_inner_0"><span class="command">lemma</span></span> is_K33_inner_0<span class="main">:</span> <span class="quoted"><span class="quoted">"is_K33_inner_inv <span class="free">G</span> <span class="free">k</span> <span class="main">0</span> <span class="free">blue</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_K33_inner_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-is_K33_colorize_last"><span class="command">lemma</span></span> is_K33_colorize_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_K33_colorize_inv <span class="free">G</span> <span class="free">u</span> <span class="main">(</span>length <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="free">blue</span>
    <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span><span class="main">.</span> <span class="free">blue</span> <span class="bound">v</span> <span class="main">⟷</span> iadj <span class="free">G</span> <span class="free">u</span> <span class="bound">v</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="free">u</span><span class="main">)</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">=</span> ig_opposite <span class="free">G</span> <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="free">u</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span>
        <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">e</span> <span class="main">∈</span> set <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="free">u</span><span class="main">)</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">=</span> ig_opposite <span class="free">G</span> <span class="bound">e</span> <span class="free">u</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">⟷</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> iadj <span class="free">G</span> <span class="free">u</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> iadj_io_edge ig_opposite_simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> iadjD<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">⟷</span> iadj <span class="free">G</span> <span class="free">u</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_K33_colorize_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-is_K33_component_size_last"><span class="command">lemma</span></span> is_K33_component_size_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> ig_verts_cnt <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_K33_component_size_inv <span class="free">G</span> <span class="free">k</span> <span class="free">blue</span> <span class="free">cnt</span> <span class="main">⟷</span> card <span class="main">{</span><span class="bound"><span class="bound">u</span></span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span><span class="main">.</span> <span class="free">blue</span> <span class="bound">u</span><span class="main">}</span> <span class="main">=</span> <span class="free">cnt</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">u</span></span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span><span class="main">.</span> <span class="free">blue</span> <span class="bound">u</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> ig_verts <span class="free">G</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> ig_verts_cnt <span class="free">G</span> <span class="main">∧</span> <span class="free">blue</span> <span class="main">(</span>ig_verts <span class="free">G</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth <span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> ig_verts <span class="free">G</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> ig_verts_cnt <span class="free">G</span> <span class="main">∧</span> <span class="free">blue</span> <span class="main">(</span>ig_verts <span class="free">G</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> distinct_ig_verts <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_eq_iff_index_eq <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_onI<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> * is_K33_component_size_inv_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_image<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-is_K33_outer_last"><span class="command">lemma</span></span> is_K33_outer_last<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_K33_outer_inv <span class="free">G</span> <span class="main">(</span>ig_verts_cnt <span class="free">G</span><span class="main">)</span> <span class="free">blue</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span><span class="main">.</span>
    <span class="free">blue</span> <span class="bound">u</span> <span class="main">=</span> <span class="free">blue</span> <span class="bound">v</span> <span class="main">⟷</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_K33_outer_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> All_set_ig_verts<span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-is_K33_inner_last"><span class="command">lemma</span></span> is_K33_inner_last<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_K33_inner_inv <span class="free">G</span> <span class="free">k</span> <span class="main">(</span>ig_verts_cnt <span class="free">G</span><span class="main">)</span> <span class="free">blue</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span><span class="main">.</span>
    <span class="free">blue</span> <span class="main">(</span>ig_verts <span class="free">G</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">blue</span> <span class="bound">v</span> <span class="main">⟷</span> <span class="main">(</span>ig_verts <span class="free">G</span> <span class="main">!</span> <span class="free">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_K33_inner_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> All_set_ig_verts<span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-is_K33_colorize_step"><span class="command">lemma</span></span> is_K33_colorize_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">G</span> <span class="free">u</span> <span class="free">i</span> <span class="free">blue</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> colorize<span class="main">:</span> <span class="quoted"><span class="quoted">"is_K33_colorize_inv <span class="free">G</span> <span class="free">u</span> <span class="free">k</span> <span class="free">blue</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">" is_K33_colorize_inv <span class="free">G</span> <span class="free">u</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">blue</span> <span class="main">(</span>ig_opposite <span class="free">G</span> <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="free">u</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="free">u</span> <span class="main">:=</span> True<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_K33_colorize_inv_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> less_SucE <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> less_SucI<span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-is_K33_component_size_step1"><span class="command">lemma</span></span> is_K33_component_size_step1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> comp<span class="main">:</span><span class="quoted"><span class="quoted">"is_K33_component_size_inv <span class="free">G</span> <span class="free">k</span> <span class="free">blue</span> <span class="free">blue_cnt</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> blue<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">blue</span> <span class="main">(</span>ig_verts <span class="free">G</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_K33_component_size_inv <span class="free">G</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="free">blue</span> <span class="main">(</span>Suc <span class="free">blue_cnt</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> Suc <span class="free">k</span> <span class="main">∧</span> <span class="free">blue</span> <span class="main">(</span>ig_verts <span class="free">G</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>
      <span class="main">=</span> insert <span class="free">k</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">∧</span> <span class="free">blue</span> <span class="main">(</span>ig_verts <span class="free">G</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> blue <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> comp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_K33_component_size_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-is_K33_component_size_step2"><span class="command">lemma</span></span> is_K33_component_size_step2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> comp<span class="main">:</span><span class="quoted"><span class="quoted">"is_K33_component_size_inv <span class="free">G</span> <span class="free">k</span> <span class="free">blue</span> <span class="free">blue_cnt</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> blue<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">blue</span> <span class="main">(</span>ig_verts <span class="free">G</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_K33_component_size_inv <span class="free">G</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="free">blue</span> <span class="free">blue_cnt</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> Suc <span class="free">k</span> <span class="main">∧</span> <span class="free">blue</span> <span class="main">(</span>ig_verts <span class="free">G</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">∧</span> <span class="free">blue</span> <span class="main">(</span>ig_verts <span class="free">G</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> blue <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> less_SucE<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> comp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_K33_component_size_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-is_K33_outer_step"><span class="command">lemma</span></span> is_K33_outer_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_K33_outer_inv <span class="free">G</span> <span class="free">i</span> <span class="free">blue</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_K33_inner_inv <span class="free">G</span> <span class="free">i</span> <span class="main">(</span>ig_verts_cnt <span class="free">G</span><span class="main">)</span> <span class="free">blue</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_K33_outer_inv <span class="free">G</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">blue</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_K33_outer_inv_def is_K33_inner_last
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> less_SucI <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> less_SucE<span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-is_K33_inner_step"><span class="command">lemma</span></span> is_K33_inner_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_K33_inner_inv <span class="free">G</span> <span class="free">i</span> <span class="free">j</span> <span class="free">blue</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">blue</span> <span class="main">(</span>ig_verts <span class="free">G</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">blue</span> <span class="main">(</span>ig_verts <span class="free">G</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>ig_verts <span class="free">G</span> <span class="main">!</span> <span class="free">i</span><span class="main">,</span> ig_verts <span class="free">G</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_K33_inner_inv <span class="free">G</span> <span class="free">i</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">blue</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_K33_inner_inv_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> less_SucE<span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-K33_mkg'I"><span class="command">lemma</span></span> K33_mkg'I<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">G</span> <span class="free">col</span> <span class="free">cnt</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≡</span> ig_verts <span class="free">G</span> <span class="main">!</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ig<span class="main">:</span> <span class="quoted"><span class="quoted">"IGraph_inv <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> iv_cnt<span class="main">:</span> <span class="quoted"><span class="quoted">"ig_verts_cnt <span class="free">G</span> <span class="main">=</span> <span class="numeral">6</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c1_cnt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cnt</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> colorize<span class="main">:</span> <span class="quoted"><span class="quoted">"is_K33_colorize_inv <span class="free">G</span> <span class="free">u</span> <span class="main">(</span>length <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="free">blue</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> comp<span class="main">:</span> <span class="quoted"><span class="quoted">"is_K33_component_size_inv <span class="free">G</span> <span class="main">(</span>ig_verts_cnt <span class="free">G</span><span class="main">)</span> <span class="free">blue</span> <span class="free">cnt</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> outer<span class="main">:</span> <span class="quoted"><span class="quoted">"is_K33_outer_inv <span class="free">G</span> <span class="main">(</span>ig_verts_cnt <span class="free">G</span><span class="main">)</span> <span class="free">blue</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"K<span class="hidden">⇘</span><sub><span class="numeral">3</span><span class="main">,</span><span class="numeral">3</span></sub><span class="hidden">⇙</span> <span class="main">(</span>mk_graph' <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> u_def <span class="keyword1"><span class="command">using</span></span> iv_cnt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">∈</span>set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span><span class="main">.</span> <span class="free">blue</span> <span class="bound">v</span> <span class="main">⟷</span> iadj <span class="free">G</span> <span class="free">u</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> colorize <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_K33_colorize_last<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="skolem"><span class="skolem">V</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">u</span></span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span><span class="free">blue</span> <span class="bound">u</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">v</span></span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span><span class="main">.</span> <span class="free">blue</span> <span class="bound">v</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> UV_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">⊆</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">⊆</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">∪</span> <span class="skolem">V</span> <span class="main">=</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">∩</span> <span class="skolem">V</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fin_UV<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">U</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> card_verts<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">6</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> iv_cnt distinct_ig_verts <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_card<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> ig comp c1_cnt <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">V</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_K33_component_size_last V_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="skolem">U</span> <span class="main">∪</span> <span class="skolem">V</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">6</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> UV_set distinct_ig_verts iv_cnt
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distinct_card<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">U</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_Un_disjoint<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fin_UV UV_set<span class="main"><span class="main"><span class="main">(</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> cards <span class="main">=</span> <span class="quoted"><span class="quoted">‹card <span class="skolem">V</span> <span class="main">=</span> <span class="numeral">3</span>›</span></span> <span class="quoted"><span class="quoted">‹card <span class="skolem">U</span> <span class="main">=</span> <span class="numeral">3</span>›</span></span> card_verts

  <span class="keyword1"><span class="command">from</span></span> is_K33_outer_last<span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">,</span> <span class="operator">OF</span> outer<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">∈</span><span class="skolem">U</span><span class="main">.</span> <span class="main">∀</span><span class="bound">v</span><span class="main">∈</span><span class="skolem">V</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span><span class="main">)</span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">∈</span><span class="skolem">U</span><span class="main">.</span> <span class="main">∀</span><span class="bound">u'</span><span class="main">∈</span><span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">u'</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span><span class="main">)</span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">∈</span><span class="skolem">V</span><span class="main">.</span> <span class="main">∀</span><span class="bound">v'</span><span class="main">∈</span><span class="skolem">V</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">v'</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> U_def V_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">×</span> <span class="skolem">V</span> <span class="main">⊆</span> set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">×</span> <span class="skolem">U</span> <span class="main">⊆</span> set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">×</span> <span class="skolem">U</span> <span class="main">∩</span> set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">×</span> <span class="skolem">V</span> <span class="main">∩</span> set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="skolem">U</span> <span class="main">∪</span> <span class="skolem">V</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="skolem">U</span> <span class="main">∪</span> <span class="skolem">V</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">U</span> <span class="main">∪</span> <span class="skolem">V</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ig set_ig_arcs_verts<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> conn<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">U</span> <span class="main">×</span> <span class="skolem">V</span> <span class="main">∪</span> <span class="skolem">V</span> <span class="main">×</span> <span class="skolem">U</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">interpret</span></span> ppg_mkg'<span class="main">:</span> pair_fin_digraph <span class="quoted"><span class="quoted">"mk_graph' <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ig <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> IGraph_imp_ppd_mkg'<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> complete_bipartite_digraph_pair_def mkg'_simps
    <span class="keyword1"><span class="command">using</span></span> cards UV_set conn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-K33_mkg'E"><span class="command">lemma</span></span> K33_mkg'E<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> K33<span class="main">:</span> <span class="quoted"><span class="quoted">"K<span class="hidden">⇘</span><sub><span class="numeral">3</span><span class="main">,</span><span class="numeral">3</span></sub><span class="hidden">⇙</span> <span class="main">(</span>mk_graph' <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ig<span class="main">:</span> <span class="quoted"><span class="quoted">"IGraph_inv <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> colorize<span class="main">:</span> <span class="quoted"><span class="quoted">"is_K33_colorize_inv <span class="free">G</span> <span class="free">u</span> <span class="main">(</span>length <span class="main">(</span>ig_in_out_arcs <span class="free">G</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="free">blue</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"is_K33_component_size_inv <span class="free">G</span> <span class="main">(</span>ig_verts_cnt <span class="free">G</span><span class="main">)</span> <span class="free">blue</span> <span class="numeral">3</span>"</span></span>
    <span class="quoted"><span class="quoted">"is_K33_outer_inv <span class="free">G</span> <span class="main">(</span>ig_verts_cnt <span class="free">G</span><span class="main">)</span> <span class="free">blue</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> K33 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="skolem"><span class="skolem">V</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      verts_G<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">U</span> <span class="main">∪</span> <span class="skolem">V</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      arcs_G<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">U</span> <span class="main">×</span> <span class="skolem">V</span> <span class="main">∪</span> <span class="skolem">V</span> <span class="main">×</span> <span class="skolem">U</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      disj_UV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">∩</span> <span class="skolem">V</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span>
      card<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="skolem">U</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">V</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> complete_bipartite_digraph_pair_def mkg'_simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> colorize u <span class="keyword1"><span class="command">have</span></span> col_adj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">blue</span> <span class="bound">v</span> <span class="main">⟷</span> iadj <span class="free">G</span> <span class="free">u</span> <span class="bound">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> is_K33_colorize_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> iadj_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> iadj <span class="free">G</span> <span class="bound">u</span> <span class="bound">v</span> <span class="main">⟷</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="main">×</span> <span class="skolem">V</span> <span class="main">∪</span> <span class="skolem">V</span> <span class="main">×</span> <span class="skolem">U</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> iadj_def arcs_G <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">v</span></span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span><span class="main">.</span> <span class="free">blue</span> <span class="bound">v</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> disj_UV <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> iadj_conv verts_G col_adj<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_K33_component_size_inv <span class="free">G</span> <span class="main">(</span>ig_verts_cnt <span class="free">G</span><span class="main">)</span> <span class="free">blue</span> <span class="numeral">3</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ig card <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_K33_component_size_last<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="main">∪</span> <span class="skolem">V</span> <span class="main">⟹</span> <span class="free">blue</span> <span class="bound">v</span> <span class="main">⟷</span> <span class="bound">v</span> <span class="main">∈</span> <span class="skolem">V</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> <span class="skolem">U</span>›</span></span> disj_UV <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> verts_G col_adj iadj_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_K33_outer_inv <span class="free">G</span> <span class="main">(</span>ig_verts_cnt <span class="free">G</span><span class="main">)</span> <span class="free">blue</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">U</span> <span class="main">∩</span> <span class="skolem">V</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> is_K33_outer_last<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_G verts_G <span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="skolem">V</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">v</span></span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span><span class="main">.</span> <span class="free">blue</span> <span class="bound">v</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> disj_UV <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> iadj_conv verts_G col_adj<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_K33_component_size_inv <span class="free">G</span> <span class="main">(</span>ig_verts_cnt <span class="free">G</span><span class="main">)</span> <span class="free">blue</span> <span class="numeral">3</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ig card <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_K33_component_size_last<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="main">∪</span> <span class="skolem">V</span> <span class="main">⟹</span> <span class="free">blue</span> <span class="bound">v</span> <span class="main">⟷</span> <span class="bound">v</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> <span class="skolem">V</span>›</span></span> disj_UV <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> verts_G col_adj iadj_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_K33_outer_inv <span class="free">G</span> <span class="main">(</span>ig_verts_cnt <span class="free">G</span><span class="main">)</span> <span class="free">blue</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">U</span> <span class="main">∩</span> <span class="skolem">V</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> is_K33_outer_last<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_G verts_G <span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> verts_G u <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-K33_card"><span class="command">lemma</span></span> K33_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"K<span class="hidden">⇘</span><sub><span class="numeral">3</span><span class="main">,</span><span class="numeral">3</span></sub><span class="hidden">⇙</span> <span class="main">(</span>mk_graph' <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ig_verts_cnt <span class="free">G</span> <span class="main">=</span> <span class="numeral">6</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>verts <span class="main">(</span>mk_graph' <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">6</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> complete_bipartite_digraph_pair_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_Un_disjoint<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> distinct_ig_verts <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkg'_simps distinct_card<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">is_K33_colorize_inv_last</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">⇒</span> <span class="main">(</span>ig_vertex <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_K33_colorize_inv_last</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">blue</span></span></span> <span class="main">≡</span> is_K33_colorize_inv <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>length <span class="main">(</span>ig_in_out_arcs <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">blue</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">is_K33_component_size_inv_last</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">⇒</span> <span class="main">(</span>ig_vertex <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_K33_component_size_inv_last</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">blue</span></span></span> <span class="main">≡</span> is_K33_component_size_inv <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">(</span>ig_verts_cnt <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">blue</span></span></span> <span class="numeral">3</span>"</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-is_K33_outerD"><span class="command">lemma</span></span> is_K33_outerD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_K33_outer_inv <span class="free">G</span> <span class="main">(</span>ig_verts_cnt <span class="free">G</span><span class="main">)</span> <span class="free">blue</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> ig_verts_cnt <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> ig_verts_cnt <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">blue</span> <span class="main">(</span>ig_verts <span class="free">G</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">blue</span> <span class="main">(</span>ig_verts <span class="free">G</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>ig_verts <span class="free">G</span> <span class="main">!</span> <span class="free">i</span><span class="main">,</span> ig_verts <span class="free">G</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_K33_outer_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> is_K33_impl<span class="main">)</span> is_K33_spec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>t</sub></span> <span class="main">⦃</span><span class="bound">σ</span><span class="main">.</span> IGraph_inv <span class="main">´</span>G <span class="main">∧</span> symmetric <span class="main">(</span>mk_graph' <span class="main">´</span>G<span class="main">)</span><span class="main">⦄</span>
    <span class="main">´</span>R <span class="main">:==</span> <span class="keyword1">PROC</span> is_K33<span class="main">(</span><span class="main">´</span>G<span class="main">)</span>
  <span class="main">⦃</span> <span class="main">´</span>G <span class="main">=</span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>G <span class="main">∧</span> <span class="main">´</span>R <span class="main">=</span> K<span class="hidden">⇘</span><sub><span class="numeral">3</span><span class="main">,</span><span class="numeral">3</span></sub><span class="hidden">⇙</span><span class="main">(</span>mk_graph' <span class="main">´</span>G<span class="main">)</span> <span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_step</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span>
    <span class="quasi_keyword">at</span> <span class="quoted"><span class="quoted"><span class="quoted">"whileAnno <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">(</span></span>named_loop <span class="inner_quoted"><span class="inner_quoted">''colorize''</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">σ</span></span><span class="main"><span class="main">)</span></span>
    <span class="quasi_keyword">to</span> <span class="quoted"><span class="quoted"><span class="quoted">"whileAnno <span class="main"><span class="main">_</span></span>
      <span class="main"><span class="main">⦃</span></span> is_K33_colorize_inv <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">´</span></span>u <span class="main"><span class="main">´</span></span>i <span class="main"><span class="main">´</span></span>blue <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>i <span class="main"><span class="main">≤</span></span> length <span class="main"><span class="main">´</span></span>io_arcs
        <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>io_arcs <span class="main"><span class="main">=</span></span> ig_in_out_arcs <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">´</span></span>u <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>u <span class="main"><span class="main">=</span></span> ig_verts <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">!</span></span> <span class="main"><span class="main">0</span></span> <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">=</span></span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>G <span class="main"><span class="main">∧</span></span> IGraph_inv <span class="main"><span class="main">´</span></span>G
        <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>u <span class="main"><span class="main">=</span></span> ig_verts <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">!</span></span> <span class="main"><span class="main">0</span></span> <span class="main"><span class="main">∧</span></span> ig_verts_cnt <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">=</span></span> <span class="numeral"><span class="numeral">6</span></span><span class="main"><span class="main">⦄</span></span>
      <span class="main"><span class="main">(</span></span><span class="keyword1"><span class="keyword1">MEASURE</span></span> length <span class="main"><span class="main">´</span></span>io_arcs <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">´</span></span>i<span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">_</span></span>"</span></span></span>
    annotate_named_loop_var<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span>
    <span class="quasi_keyword">at</span> <span class="quoted"><span class="quoted"><span class="quoted">"whileAnno <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">(</span></span>named_loop <span class="inner_quoted"><span class="inner_quoted">''component_size''</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">σ</span></span><span class="main"><span class="main">)</span></span>
    <span class="quasi_keyword">to</span> <span class="quoted"><span class="quoted"><span class="quoted">"whileAnnoFix <span class="main"><span class="main">_</span></span>
      <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">blue</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⦃</span></span> is_K33_component_size_inv <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">´</span></span>i <span class="main"><span class="main">´</span></span>blue <span class="main"><span class="main">´</span></span>blue_cnt
      <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>i <span class="main"><span class="main">≤</span></span> ig_verts_cnt <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>blue <span class="main"><span class="main">=</span></span> <span class="bound"><span class="bound">blue</span></span> <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">=</span></span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>G <span class="main"><span class="main">∧</span></span> IGraph_inv <span class="main"><span class="main">´</span></span>G
      <span class="main"><span class="main">∧</span></span> ig_verts_cnt <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">=</span></span> <span class="numeral"><span class="numeral">6</span></span> <span class="main"><span class="main">∧</span></span> is_K33_colorize_inv_last <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">´</span></span>blue <span class="main"><span class="main">⦄</span></span><span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="keyword1"><span class="keyword1">MEASURE</span></span> ig_verts_cnt <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">´</span></span>i<span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">_</span></span>"</span></span></span>
    annotate_named_loop_var_fix<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span>
    <span class="quasi_keyword">at</span> <span class="quoted"><span class="quoted"><span class="quoted">"whileAnno <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">(</span></span>named_loop <span class="inner_quoted"><span class="inner_quoted">''connected_outer''</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">σ</span></span><span class="main"><span class="main">)</span></span>
    <span class="quasi_keyword">to</span> <span class="quoted"><span class="quoted"><span class="quoted">"whileAnnoFix <span class="main"><span class="main">_</span></span>
      <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">blue</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⦃</span></span> is_K33_outer_inv <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">´</span></span>i <span class="main"><span class="main">´</span></span>blue <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>i <span class="main"><span class="main">≤</span></span> ig_verts_cnt <span class="main"><span class="main">´</span></span>G
        <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>blue <span class="main"><span class="main">=</span></span> <span class="bound"><span class="bound">blue</span></span> <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">=</span></span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>G <span class="main"><span class="main">∧</span></span> IGraph_inv <span class="main"><span class="main">´</span></span>G
        <span class="main"><span class="main">∧</span></span> ig_verts_cnt <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">=</span></span> <span class="numeral"><span class="numeral">6</span></span> <span class="main"><span class="main">∧</span></span> is_K33_colorize_inv_last <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">´</span></span>blue <span class="main"><span class="main">∧</span></span> is_K33_component_size_inv_last <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">´</span></span>blue <span class="main"><span class="main">⦄</span></span><span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="keyword1"><span class="keyword1">MEASURE</span></span> ig_verts_cnt <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">´</span></span>i<span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">_</span></span>"</span></span></span>
    annotate_named_loop_var_fix<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span>
    <span class="quasi_keyword">at</span> <span class="quoted"><span class="quoted"><span class="quoted">"whileAnno <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">(</span></span>named_loop <span class="inner_quoted"><span class="inner_quoted">''connected_inner''</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">σ</span></span><span class="main"><span class="main">)</span></span>
    <span class="quasi_keyword">to</span> <span class="quoted"><span class="quoted"><span class="quoted">"whileAnnoFix <span class="main"><span class="main">_</span></span>
      <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">blue</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⦃</span></span> is_K33_inner_inv <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">´</span></span>i <span class="main"><span class="main">´</span></span>j <span class="main"><span class="main">´</span></span>blue <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>j <span class="main"><span class="main">≤</span></span> ig_verts_cnt <span class="main"><span class="main">´</span></span>G
        <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>i <span class="main"><span class="main">=</span></span> <span class="bound"><span class="bound">i</span></span> <span class="main"><span class="main">∧</span></span><span class="main"><span class="main">´</span></span>i <span class="main"><span class="main">&lt;</span></span> ig_verts_cnt <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>blue <span class="main"><span class="main">=</span></span> <span class="bound"><span class="bound">blue</span></span> <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">=</span></span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>G <span class="main"><span class="main">∧</span></span> IGraph_inv <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>u <span class="main"><span class="main">=</span></span> ig_verts <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">!</span></span> <span class="main"><span class="main">´</span></span>i
        <span class="main"><span class="main">∧</span></span> ig_verts_cnt <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">=</span></span> <span class="numeral"><span class="numeral">6</span></span> <span class="main"><span class="main">∧</span></span> is_K33_colorize_inv_last <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">´</span></span>blue <span class="main"><span class="main">∧</span></span> is_K33_component_size_inv_last <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">´</span></span>blue <span class="main"><span class="main">⦄</span></span><span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="keyword1"><span class="keyword1">MEASURE</span></span> ig_verts_cnt <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">´</span></span>j<span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">_</span></span>"</span></span></span>
    annotate_named_loop_var_fix<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_K33_colorize_0 is_K33_component_size_0 is_K33_outer_0 is_K33_component_size_last
         <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> K33_mkg'E <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> K33_card <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> K33_mkg'I<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_K33_colorize_step<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_K33_colorize_0 is_K33_component_size_0 is_K33_outer_0 is_K33_component_size_last
       <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> K33_mkg'E  <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> K33_mkg'I<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_K33_component_size_step1 is_K33_component_size_step2<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_K33_inner_0 is_K33_outer_step<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> simp_thms<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI allI impI notI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> K33_mkg'E <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> is_K33_outerD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> K33_mkg'E <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> is_K33_outerD<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_K33_inner_step<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Procedure <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">is_K5</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_K5_outer_inv</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">.</span> ig_verts <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">v</span>
    <span class="main">⟷</span> <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_K5_inner_inv</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">.</span> ig_verts <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≠</span> ig_verts <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">!</span> <span class="bound">j</span>
    <span class="main">⟷</span> <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> ig_verts <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-K5_card"><span class="command">lemma</span></span> K5_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"K<span class="hidden">⇘</span><sub><span class="numeral">5</span></sub><span class="hidden">⇙</span> <span class="main">(</span>mk_graph' <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ig_verts_cnt <span class="free">G</span> <span class="main">=</span> <span class="numeral">5</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms distinct_ig_verts <span class="keyword1"><span class="command">unfolding</span></span> complete_digraph_pair_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mkg'_simps distinct_card<span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-is_K5_inner_0"><span class="command">lemma</span></span> is_K5_inner_0<span class="main">:</span> <span class="quoted"><span class="quoted">"is_K5_inner_inv <span class="free">G</span> <span class="free">k</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_K5_inner_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-is_K5_inner_last"><span class="command">lemma</span></span> is_K5_inner_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> ig_verts_cnt <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_K5_inner_inv <span class="free">G</span> <span class="free">k</span> <span class="free">l</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span><span class="main">.</span> ig_verts <span class="free">G</span> <span class="main">!</span> <span class="free">k</span> <span class="main">≠</span> <span class="bound">v</span>
    <span class="main">⟷</span> <span class="main">(</span>ig_verts <span class="free">G</span> <span class="main">!</span> <span class="free">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> set <span class="main">(</span>ig_verts <span class="free">G</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>ig_verts_cnt <span class="free">G</span><span class="main">.</span> ig_verts <span class="free">G</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="bound">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_K5_inner_inv_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-is_K5_outer_step"><span class="command">lemma</span></span> is_K5_outer_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_K5_outer_inv <span class="free">G</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_K5_inner_inv <span class="free">G</span> <span class="free">k</span> <span class="main">(</span>ig_verts_cnt <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_K5_outer_inv <span class="free">G</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_K5_outer_inv_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_K5_inner_last <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> less_SucE<span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-is_K5_outer_last"><span class="command">lemma</span></span> is_K5_outer_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_K5_outer_inv <span class="free">G</span> <span class="main">(</span>ig_verts_cnt <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"IGraph_inv <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"ig_verts_cnt <span class="free">G</span> <span class="main">=</span> <span class="numeral">5</span>"</span></span> <span class="quoted"><span class="quoted">"symmetric <span class="main">(</span>mk_graph' <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"K<span class="hidden">⇘</span><sub><span class="numeral">5</span></sub><span class="hidden">⇙</span> <span class="main">(</span>mk_graph' <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> ppg_mkg'<span class="main">:</span> pair_fin_digraph <span class="quoted"><span class="quoted">"mk_graph' <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> IGraph_imp_ppd_mkg'<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">u</span> <span class="main">≠</span> <span class="bound">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> is_K5_outer_inv_def ig_verts_cnt_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span>  in_set_conv_nth set_ig_arcs_verts<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> ppg_mkg'<span class="main">:</span> pair_graph <span class="quoted"><span class="quoted">"<span class="main">(</span>mk_graph' <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkg'_simps arc_to_ends_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> pverts <span class="main">(</span>mk_graph' <span class="free">G</span><span class="main">)</span> <span class="main">⟹</span>
           <span class="bound">b</span> <span class="main">∈</span> pverts <span class="main">(</span>mk_graph' <span class="free">G</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">≠</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> parcs <span class="main">(</span>mk_graph' <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> is_K5_outer_inv_def mkg'_simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_nth ig_verts_cnt_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>pverts <span class="main">(</span>mk_graph' <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">5</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹ig_verts_cnt <span class="free">G</span> <span class="main">=</span> <span class="numeral">5</span>›</span></span> distinct_ig_verts <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkg'_simps distinct_card<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> complete_digraph_pair_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ppg_mkg'.in_arcsD1 ppg_mkg'.in_arcsD2 ppg_mkg'.no_loops'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Check_Non_Planarity_Verification-is_K5_inner_step"><span class="command">lemma</span></span> is_K5_inner_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_K5_inner_inv <span class="free">G</span> <span class="free">k</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> ig_verts_cnt <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="free">l</span> <span class="main">⟷</span> <span class="main">(</span>ig_verts <span class="free">G</span> <span class="main">!</span> <span class="free">k</span><span class="main">,</span> ig_verts <span class="free">G</span> <span class="main">!</span> <span class="free">l</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_K5_inner_inv <span class="free">G</span> <span class="free">k</span> <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms distinct_ig_verts <span class="keyword1"><span class="command">unfolding</span></span> is_K5_inner_inv_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> less_SucE<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> Suc_lessD less_SucE less_trans_Suc linorder_neqE_nat nth_eq_iff_index_eq<span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-iK5E"><span class="command">lemma</span></span> iK5E<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"K<span class="hidden">⇘</span><sub><span class="numeral">5</span></sub><span class="hidden">⇙</span> <span class="main">(</span>mk_graph' <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"ig_verts_cnt <span class="free">G</span> <span class="main">=</span> <span class="numeral">5</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">i</span> <span class="main">&lt;</span> ig_verts_cnt <span class="free">G</span><span class="main">;</span> <span class="free">j</span> <span class="main">&lt;</span> ig_verts_cnt <span class="free">G</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≠</span> <span class="free">j</span> <span class="main">⟷</span> <span class="main">(</span>ig_verts <span class="free">G</span> <span class="main">!</span> <span class="free">i</span><span class="main">,</span> ig_verts <span class="free">G</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ig_verts_cnt <span class="free">G</span> <span class="main">=</span> <span class="numeral">5</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> ig_verts_cnt <span class="free">G</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> ig_verts_cnt <span class="free">G</span> <span class="main">⟹</span>
        <span class="main">(</span><span class="free">i</span> <span class="main">≠</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>ig_verts <span class="free">G</span> <span class="main">!</span> <span class="free">i</span><span class="main">,</span> ig_verts <span class="free">G</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ig_arcs <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms distinct_ig_verts
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> complete_digraph_pair_def mkg'_simps distinct_card nth_eq_iff_index_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> is_K5_impl<span class="main">)</span> is_K5_spec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>t</sub></span> <span class="main">⦃</span><span class="bound">σ</span><span class="main">.</span> IGraph_inv <span class="main">´</span>G <span class="main">∧</span> symmetric <span class="main">(</span>mk_graph' <span class="main">´</span>G<span class="main">)</span><span class="main">⦄</span>
    <span class="main">´</span>R <span class="main">:==</span> <span class="keyword1">PROC</span> is_K5<span class="main">(</span><span class="main">´</span>G<span class="main">)</span>
  <span class="main">⦃</span> <span class="main">´</span>G <span class="main">=</span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>G <span class="main">∧</span> <span class="main">´</span>R <span class="main">=</span> K<span class="hidden">⇘</span><sub><span class="numeral">5</span></sub><span class="hidden">⇙</span><span class="main">(</span>mk_graph' <span class="main">´</span>G<span class="main">)</span> <span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_step</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span>
    <span class="quasi_keyword">at</span> <span class="quoted"><span class="quoted"><span class="quoted">"whileAnno <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">(</span></span>named_loop <span class="inner_quoted"><span class="inner_quoted">''outer_loop''</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">σ</span></span><span class="main"><span class="main">)</span></span>
    <span class="quasi_keyword">to</span> <span class="quoted"><span class="quoted"><span class="quoted">"whileAnno <span class="main"><span class="main">_</span></span>
      <span class="main"><span class="main">⦃</span></span> is_K5_outer_inv <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">´</span></span>i <span class="main"><span class="main">∧</span></span><span class="main"><span class="main">´</span></span>i <span class="main"><span class="main">≤</span></span> <span class="numeral"><span class="numeral">5</span></span> <span class="main"><span class="main">∧</span></span> IGraph_inv <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">∧</span></span> symmetric <span class="main"><span class="main">(</span></span>mk_graph' <span class="main"><span class="main">´</span></span>G<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">=</span></span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>G <span class="main"><span class="main">∧</span></span> ig_verts_cnt <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">=</span></span> <span class="numeral"><span class="numeral">5</span></span> <span class="main"><span class="main">⦄</span></span>
      <span class="main"><span class="main">(</span></span><span class="keyword1"><span class="keyword1">MEASURE</span></span> <span class="numeral"><span class="numeral">5</span></span> <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">´</span></span>i<span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">_</span></span>"</span></span></span>
    annotate_named_loop_var<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span>
    <span class="quasi_keyword">at</span> <span class="quoted"><span class="quoted"><span class="quoted">"whileAnno <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">(</span></span>named_loop <span class="inner_quoted"><span class="inner_quoted">''inner_loop''</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">σ</span></span><span class="main"><span class="main">)</span></span>
    <span class="quasi_keyword">to</span> <span class="quoted"><span class="quoted"><span class="quoted">"whileAnnoFix <span class="main"><span class="main">_</span></span>
      <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⦃</span></span> is_K5_inner_inv <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">´</span></span>i <span class="main"><span class="main">´</span></span>j
        <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>j <span class="main"><span class="main">≤</span></span> <span class="numeral"><span class="numeral">5</span></span> <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>i <span class="main"><span class="main">&lt;</span></span> <span class="numeral"><span class="numeral">5</span></span> <span class="main"><span class="main">∧</span></span> IGraph_inv <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">∧</span></span> symmetric <span class="main"><span class="main">(</span></span>mk_graph' <span class="main"><span class="main">´</span></span>G<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">=</span></span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>G <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>i <span class="main"><span class="main">=</span></span> <span class="bound"><span class="bound">i</span></span>
        <span class="main"><span class="main">∧</span></span> ig_verts_cnt <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">=</span></span> <span class="numeral"><span class="numeral">5</span></span> <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">´</span></span>u <span class="main"><span class="main">=</span></span> ig_verts <span class="main"><span class="main">´</span></span>G <span class="main"><span class="main">!</span></span> <span class="main"><span class="main">´</span></span>i<span class="main"><span class="main">⦄</span></span><span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="keyword1"><span class="keyword1">MEASURE</span></span> <span class="numeral"><span class="numeral">5</span></span> <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">´</span></span>j<span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">_</span></span>"</span></span></span>
    annotate_named_loop_var_fix<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_K5_outer_inv_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> K5_card<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_K5_inner_0 is_K5_outer_step<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_K5_inner_step <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> iK5E<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_K5_outer_last<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Soundness of the Checker›</span></span>

<span class="keyword1" id="Check_Non_Planarity_Verification-planar_theorem"><span class="command">lemma</span></span> planar_theorem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pair_pseudo_graph <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"pair_pseudo_graph <span class="free">K</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"subgraph <span class="free">K</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"K<span class="hidden">⇘</span><sub><span class="numeral">3</span><span class="main">,</span><span class="numeral">3</span></sub><span class="hidden">⇙</span> <span class="main">(</span>contr_graph <span class="free">K</span><span class="main">)</span> <span class="main">∨</span> K<span class="hidden">⇘</span><sub><span class="numeral">5</span></sub><span class="hidden">⇙</span> <span class="main">(</span>contr_graph <span class="free">K</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>kuratowski_planar <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> pair_pseudo_graph.kuratowski_contr<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">witness</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pair_pre_digraph <span class="main">⇒</span> <span class="tfree">'a</span> pair_pre_digraph <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">witness</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">≡</span> loop_free <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">∧</span> pair_pseudo_graph <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">∧</span> subgraph <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span>
    <span class="main">∧</span> <span class="main">(</span>K<span class="hidden">⇘</span><sub><span class="numeral">3</span><span class="main">,</span><span class="numeral">3</span></sub><span class="hidden">⇙</span> <span class="main">(</span>contr_graph <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">)</span> <span class="main">∨</span> K<span class="hidden">⇘</span><sub><span class="numeral">5</span></sub><span class="hidden">⇙</span> <span class="main">(</span>contr_graph <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"witness <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="main">(</span>mk_graph <span class="free">K</span><span class="main">)</span> <span class="main">⟷</span> pair_pre_digraph.certify <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span> <span class="main">(</span>mk_graph <span class="free">K</span><span class="main">)</span> <span class="main">∧</span> loop_free <span class="main">(</span>mk_graph <span class="free">K</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> witness_def pair_pre_digraph.certify_def Let_def wf_digraph_wp_iff wellformed_pseudo_graph_mkg<span class="main">)</span>


<span class="keyword1" id="Check_Non_Planarity_Verification-pwd_imp_ppg_mkg"><span class="command">lemma</span></span> pwd_imp_ppg_mkg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pair_wf_digraph <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pair_pseudo_graph <span class="main">(</span>mk_graph <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> pair_wf_digraph <span class="quoted"><span class="quoted">"mk_graph <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkg_simps finite_symcl_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mk_graph_def symmetric_mk_symmetric<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> check_kuratowski_impl<span class="main">)</span> check_kuratowski_spec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>t</sub></span> <span class="main">⦃</span><span class="bound">σ</span><span class="main">.</span> pair_wf_digraph <span class="main">(</span>mk_graph <span class="main">´</span>G<span class="main">)</span><span class="main">⦄</span>
    <span class="main">´</span>R <span class="main">:==</span> <span class="keyword1">PROC</span> check_kuratowski<span class="main">(</span><span class="main">´</span>G<span class="main">,</span> <span class="main">´</span>K<span class="main">)</span>
  <span class="main">⦃</span> <span class="main">´</span>G <span class="main">=</span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>G <span class="main">∧</span> <span class="main">´</span>K <span class="main">=</span> <span class="hidden">⇗</span><sup>σ</sup><span class="hidden">⇖</span>K <span class="main">∧</span> <span class="main">´</span>R <span class="main">⟷</span> witness <span class="main">(</span>mk_graph <span class="main">´</span>G<span class="main">)</span> <span class="main">(</span>mk_graph <span class="main">´</span>K<span class="main">)</span><span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> witness_def IGraph_inv_conv' pwd_imp_ppg_mkg<span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-check_kuratowski_correct"><span class="command">lemma</span></span> check_kuratowski_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pair_pseudo_graph <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"witness <span class="free">G</span> <span class="free">K</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>kuratowski_planar <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> planar_theorem<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> K<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">K</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> witness_def<span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-check_kuratowski_correct_comb"><span class="command">lemma</span></span> check_kuratowski_correct_comb<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pair_pseudo_graph <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"witness <span class="free">G</span> <span class="free">K</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>comb_planar <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> check_kuratowski_correct comb_planar_compat<span class="main">)</span>

<span class="keyword1" id="Check_Non_Planarity_Verification-check_kuratowski_complete"><span class="command">lemma</span></span> check_kuratowski_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pair_pseudo_graph <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"pair_pseudo_graph <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"loop_free <span class="free">K</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subgraph <span class="free">K</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subdivision_pair <span class="free">H</span> <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"K<span class="hidden">⇘</span><sub><span class="numeral">3</span><span class="main">,</span><span class="numeral">3</span></sub><span class="hidden">⇙</span> <span class="free">H</span> <span class="main">∨</span> K<span class="hidden">⇘</span><sub><span class="numeral">5</span></sub><span class="hidden">⇙</span> <span class="free">H</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"witness <span class="free">G</span> <span class="free">K</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> witness_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> K33_contractedI K5_contractedI<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="AutoCorres_Misc">
<div class="head">
<h1>Theory AutoCorres_Misc</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> AutoCorres_Misc <span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="#OptionMonadWP">../l4v/lib/OptionMonadWP</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Auxilliary Lemmas for Autocorres›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Option monad›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">owhile_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> lookup<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> lookup"</span></span>   <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">owhile_inv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> owhile <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1" id="AutoCorres_Misc-owhile_unfold"><span class="command">lemma</span></span> owhile_unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"owhile <span class="free">C</span> <span class="free">B</span> <span class="free">r</span> <span class="free">s</span> <span class="main">=</span> ocondition <span class="main">(</span><span class="free">C</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="free">r</span> <span class="main">|&gt;&gt;</span> owhile <span class="free">C</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span>oreturn <span class="free">r</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ocondition_def obind_def oreturn_def owhile_def option_while_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1" id="AutoCorres_Misc-ovalidNF_owhile"><span class="command">lemma</span></span> ovalidNF_owhile<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="free">r</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">I</span> <span class="free">r</span> <span class="bound">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> ovalidNF <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="free">I</span> <span class="bound">r</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">r</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r'</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">I</span> <span class="bound">r'</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">r'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">R</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">r</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">C</span> <span class="bound">r</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">r</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ovalidNF <span class="main">(</span><span class="free">P</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>OptionMonad.owhile <span class="free">C</span> <span class="free">B</span> <span class="free">r</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ovalidNF_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">r</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">r</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹wf <span class="free">R</span>›</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="free">I</span> <span class="bound">r</span> <span class="skolem">s</span> <span class="main">⟹</span> <span class="free">C</span> <span class="bound">r</span> <span class="skolem">s</span> <span class="main">⟹</span> <span class="free">B</span> <span class="bound">r</span> <span class="skolem">s</span> <span class="main">=</span> Some <span class="bound">r'</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">r'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> ovalidNF_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="free">I</span> <span class="bound">r</span> <span class="skolem">s</span> <span class="main">⟹</span> <span class="free">C</span> <span class="bound">r</span> <span class="skolem">s</span> <span class="main">⟹</span> <span class="free">B</span> <span class="bound">r</span> <span class="skolem">s</span> <span class="main">=</span> Some <span class="bound">r'</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">r'</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> ovalidNF_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="free">I</span> <span class="bound">r</span> <span class="skolem">s</span> <span class="main">⟹</span> <span class="free">C</span> <span class="bound">r</span> <span class="skolem">s</span> <span class="main">⟹</span> <span class="free">B</span> <span class="bound">r</span> <span class="skolem">s</span> <span class="main">=</span> None <span class="main">⟹</span>
      None <span class="main">≠</span> None <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r'</span><span class="main">.</span> None <span class="main">=</span> Some <span class="bound">r'</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">r'</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> ovalidNF_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="free">I</span> <span class="bound">r</span> <span class="skolem">s</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">C</span> <span class="bound">r</span> <span class="skolem">s</span> <span class="main">⟹</span> Some <span class="bound">r</span> <span class="main">≠</span> None <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r'</span><span class="main">.</span> Some <span class="bound">r</span> <span class="main">=</span> Some <span class="bound">r'</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">r'</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> ovalidNF_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"owhile <span class="free">C</span> <span class="free">B</span> <span class="free">r</span> <span class="skolem">s</span> <span class="main">≠</span> None <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r'</span><span class="main">.</span> owhile <span class="free">C</span> <span class="free">B</span> <span class="free">r</span> <span class="skolem">s</span> <span class="main">=</span> Some <span class="bound">r'</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">r'</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> owhile_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">I</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="AutoCorres_Misc-ovalidNF_owhile_inv"><span class="command">lemma</span></span> ovalidNF_owhile_inv<span class="main">[</span><span class="operator">wp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> ovalidNF <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="free">I</span> <span class="bound">r</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">r</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r'</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">I</span> <span class="bound">r'</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">r'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">R</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">r</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">C</span> <span class="bound">r</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">r</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ovalidNF <span class="main">(</span><span class="free">I</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>owhile_inv <span class="free">C</span> <span class="free">B</span> <span class="free">r</span> <span class="free">I</span> <span class="free">R</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> owhile_inv_def <span class="keyword1"><span class="command">using</span></span> _ assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ovalidNF_owhile<span class="main">)</span>



<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Setup_AutoCorres">
<div class="head">
<h1>Theory Setup_AutoCorres</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Setup_AutoCorres
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../case_labeling/theories/#Case_Labeling">Case_Labeling.Case_Labeling</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Eisbach/Eisbach.html">HOL-Eisbach.Eisbach</a>"</span>
  <a href="#AutoCorres_Misc">AutoCorres_Misc</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹AutoCorres setup for VCG labelling›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Theorem collections for the VCG›</span></span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹../../Case_Labeling/util.ML›</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">vcg_tac</span> <span class="entity">nt_rules</span> <span class="entity">nt_comb</span> <span class="entity">ctxt</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rules</span> <span class="main">=</span> <span class="entity">Named_Theorems.get</span> <span class="entity">ctxt</span> <span class="entity">nt_rules</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">comb</span> <span class="main">=</span> <span class="entity">Named_Theorems.get</span> <span class="entity">ctxt</span> <span class="entity">nt_comb</span>
    <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">REPEAT_ALL_NEW_FWD</span> <span class="main">(</span> resolve_tac <span class="entity">ctxt</span> <span class="entity">rules</span> ORELSE' <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="entity">comb</span> THEN' resolve_tac <span class="entity">ctxt</span> <span class="entity">rules</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">named_theorems</span></span> vcg_l
<span class="keyword1"><span class="command">named_theorems</span></span> vcg_l_comb
<span class="keyword1"><span class="command">named_theorems</span></span> vcg_elim
<span class="keyword1"><span class="command">named_theorems</span></span> vcg_simp

<span class="keyword1"><span class="command">method_setup</span></span> vcg_l <span class="main">=</span> <span class="quoted">‹
  Scan.succeed <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD</span> <span class="main">(</span>FIRSTGOAL <span class="main">(</span><span class="entity">vcg_tac</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_theorems</span> "vcg_l"<span class="antiquote">}</span></span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_theorems</span> "vcg_l_comb"<span class="antiquote">}</span></span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
›</span>

<span class="keyword1"><span class="command">method</span></span> vcg_l' <span class="main">=</span> <span class="main">(</span><span class="operator">vcg_l</span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">elim</span> <span class="dynamic"><span class="dynamic">vcg_elim</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">unfold</span> <span class="dynamic"><span class="dynamic">vcg_simp</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">method</span></span> vcg_casify <span class="main">=</span> <span class="main">(</span><span class="operator">rule</span> Initial_Label<span class="main"><span class="keyword3">,</span></span> <span class="operator">vcg_l'</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">casify</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Labeled VCG theorems for branching›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">BRANCH</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1"><span class="command">named_theorems</span></span> branch_l
<span class="keyword1"><span class="command">named_theorems</span></span> branch_l_comb

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">interpretation</span></span> Labeling_Syntax <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1" id="Setup_AutoCorres-DC_if"><span class="command">lemma</span></span> DC_if<span class="main">[</span><span class="operator">branch_l</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ct</span> <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ct'</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">pos</span> <span class="bound">name</span><span class="main">.</span> <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">pos</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="free">ct</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⟹</span> <span class="keyword1">C⟨</span>Suc <span class="free">inp</span><span class="main">,</span><span class="free">ct'</span> <span class="free">inp</span> <span class="inner_quoted">''then''</span><span class="main">,</span> <span class="free">outp'</span><span class="main">:</span> <span class="free">b</span><span class="main">⟩</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">a</span> <span class="main">⟹</span> <span class="keyword1">C⟨</span>Suc <span class="free">outp'</span><span class="main">,</span><span class="free">ct'</span> <span class="free">outp'</span> <span class="inner_quoted">''else''</span><span class="main">,</span> <span class="free">outp</span><span class="main">:</span> <span class="free">c</span><span class="main">⟩</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">C⟨</span><span class="free">inp</span><span class="main">,</span><span class="free">ct</span><span class="main">,</span><span class="free">outp</span><span class="main">:</span> BRANCH <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="keyword1">then</span> <span class="free">b</span> <span class="keyword1">else</span> <span class="free">c</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> LABEL_simps BRANCH_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Setup_AutoCorres-DC_final"><span class="command">lemma</span></span> DC_final<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">V⟨</span><span class="main">(</span><span class="inner_quoted">''g''</span><span class="main">,</span><span class="free">inp</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="free">ct</span><span class="main">:</span> <span class="free">a</span><span class="main">⟩</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">C⟨</span><span class="free">inp</span><span class="main">,</span><span class="free">ct</span><span class="main">,</span>Suc <span class="free">inp</span><span class="main">:</span> <span class="free">a</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> LABEL_simps BRANCH_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">method_setup</span></span> branch_l <span class="main">=</span> <span class="quoted">‹
  Scan.succeed <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD</span> <span class="main">(</span>FIRSTGOAL <span class="main">(</span><span class="entity">vcg_tac</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_theorems</span> branch_l<span class="antiquote">}</span></span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_theorems</span> branch_l_comb<span class="antiquote">}</span></span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
›</span>

<span class="keyword1"><span class="command">method</span></span> branch_casify <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> Initial_Label<span class="main"><span class="keyword3">,</span></span> <span class="operator">branch_l</span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">rule</span> DC_final<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">casify</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Labelled VCG theorems for the option monad›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">lpred_conj</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">land</span>"</span> 35<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lpred_conj</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">x</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">interpretation</span></span> Labeling_Syntax <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1" id="Setup_AutoCorres-ovalidNF_obind_K_bind"><span class="command">lemma</span></span> ovalidNF_obind_K_bind <span class="main">[</span><span class="operator">vcg_l</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"CTXT <span class="main">(</span>Suc <span class="free">OC1</span><span class="main">)</span> <span class="free">CT</span> <span class="free">OC</span> <span class="main">(</span>ovalidNF <span class="free">R</span> <span class="free">g</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"CTXT <span class="free">IC</span> <span class="free">CT</span> <span class="free">OC1</span> <span class="main">(</span>ovalidNF <span class="free">P</span> <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"CTXT <span class="free">IC</span> <span class="free">CT</span> <span class="free">OC</span> <span class="main">(</span>ovalidNF <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="main">|&gt;&gt;</span> K_bind <span class="free">g</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> LABEL_simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">wp</span>

  <span class="keyword1" id="Setup_AutoCorres-L_ovalidNF_obind_oreturn"><span class="command">lemma</span></span> L_ovalidNF_obind_oreturn<span class="main">[</span><span class="operator">vcg_l</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"CTXT <span class="free">IC</span> <span class="free">CT</span> <span class="free">OC</span> <span class="main">(</span>ovalidNF <span class="free">P</span> <span class="main">(</span><span class="free">g</span> <span class="free">x</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"CTXT <span class="free">IC</span> <span class="free">CT</span> <span class="free">OC</span> <span class="main">(</span>ovalidNF <span class="free">P</span> <span class="main">(</span>oreturn <span class="free">x</span> <span class="main">|&gt;&gt;</span> <span class="free">g</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LABEL_simps<span class="main">)</span>

  <span class="keyword1" id="Setup_AutoCorres-L_ovalidNF_obind"><span class="command">lemma</span></span> L_ovalidNF_obind<span class="main">[</span><span class="operator">vcg_l</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> CTXT <span class="main">(</span>Suc <span class="free">OC1</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="inner_quoted">''bind''</span><span class="main">,</span> Suc <span class="free">OC1</span><span class="main">,</span> <span class="main">[</span>VAR <span class="bound">r</span><span class="main">]</span><span class="main">)</span> <span class="main">#</span> <span class="free">CT</span><span class="main">)</span> <span class="free">OC</span>
        <span class="main">(</span>ovalidNF <span class="main">(</span><span class="free">R</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">r</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"CTXT <span class="free">IC</span> <span class="free">CT</span> <span class="free">OC1</span> <span class="main">(</span>ovalidNF <span class="free">P</span> <span class="free">f</span> <span class="free">R</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"CTXT <span class="free">IC</span> <span class="free">CT</span> <span class="free">OC</span> <span class="main">(</span>ovalidNF <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="main">|&gt;&gt;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">g</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> LABEL_simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">wp</span>

  <span class="keyword1" id="Setup_AutoCorres-ovalidNF_K_bind"><span class="command">lemma</span></span> ovalidNF_K_bind<span class="main">[</span><span class="operator">vcg_l</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"CTXT <span class="free">IC</span> <span class="free">CT</span> <span class="free">OC</span> <span class="main">(</span>ovalidNF <span class="free">P</span> <span class="free">f</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"CTXT <span class="free">IC</span> <span class="free">CT</span> <span class="free">OC</span> <span class="main">(</span>ovalidNF <span class="free">P</span> <span class="main">(</span>K_bind <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Setup_AutoCorres-L_ovalidNF_prod_case"><span class="command">lemma</span></span> L_ovalidNF_prod_case<span class="main">[</span><span class="operator">vcg_l</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> SPLIT <span class="free">v</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> CTXT <span class="free">IC</span> <span class="free">CT</span> <span class="free">OC</span> <span class="main">(</span>ovalidNF <span class="main">(</span><span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"CTXT <span class="free">IC</span> <span class="free">CT</span> <span class="free">OC</span> <span class="main">(</span>ovalidNF <span class="main">(</span><span class="keyword1">case</span> <span class="free">v</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">v</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">B</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> LABEL_simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ovalidNF_def<span class="main">)</span>

  <span class="keyword1" id="Setup_AutoCorres-L_ovalidNF_oreturn_NF"><span class="command">lemma</span></span> L_ovalidNF_oreturn_NF<span class="main">[</span><span class="operator">vcg_l</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"CTXT <span class="free">IC</span> <span class="free">CT</span> <span class="free">IC</span> <span class="main">(</span>ovalidNF <span class="main">(</span><span class="free">P</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>oreturn <span class="free">x</span><span class="main">)</span> <span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> LABEL_simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">wp</span>

  <span class="keyword1" id="Setup_AutoCorres-L_ovalidNF_owhile_inv"><span class="command">lemma</span></span> L_ovalidNF_owhile_inv<span class="main">[</span><span class="operator">vcg_l</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">CT</span> <span class="free">IC</span>
    <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT'</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="inner_quoted">''while''</span><span class="main">,</span> <span class="free">IC</span><span class="main">,</span> <span class="main">[</span>VAR <span class="bound">r</span><span class="main">]</span><span class="main">)</span> <span class="main">#</span> <span class="free">CT</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> CTXT <span class="free">IC</span> <span class="main">(</span><span class="main">(</span><span class="inner_quoted">''invariant''</span><span class="main">,</span> <span class="free">IC</span><span class="main">,</span> <span class="main">[</span>VAR <span class="bound">s</span><span class="main">]</span><span class="main">)</span> <span class="main">#</span> <span class="free">CT'</span> <span class="bound">r</span><span class="main">)</span> <span class="free">OC</span>
        <span class="main">(</span>ovalidNF
          <span class="main">(</span>BIND <span class="inner_quoted">''loop_inv''</span> <span class="free">IC</span> <span class="main">(</span><span class="free">I</span> <span class="bound">r</span><span class="main">)</span> <span class="keyword1">land</span>
            BIND <span class="inner_quoted">''loop_cond''</span> <span class="free">IC</span> <span class="main">(</span><span class="free">C</span> <span class="bound">r</span><span class="main">)</span> <span class="keyword1">land</span>
            BIND <span class="inner_quoted">''loop_var''</span> <span class="free">IC</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span><span class="free">B</span> <span class="bound">r</span><span class="main">)</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">r'</span><span class="main">.</span> BIND <span class="inner_quoted">''inv''</span> <span class="free">IC</span> <span class="main">(</span><span class="free">I</span> <span class="bound">r'</span><span class="main">)</span> <span class="keyword1">land</span> BIND <span class="inner_quoted">''var''</span> <span class="free">IC</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">(</span><span class="bound">r'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> VC <span class="main">(</span><span class="inner_quoted">''wf''</span><span class="main">,</span> <span class="free">OC</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="free">CT'</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span>wf <span class="free">R</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">r</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">C</span> <span class="bound">r</span> <span class="bound">s</span> <span class="main">⟹</span>
        VC <span class="main">(</span><span class="inner_quoted">''postcondition''</span><span class="main">,</span> Suc <span class="free">OC</span><span class="main">,</span> <span class="main">[</span>VAR <span class="bound">s</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">CT'</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">Q</span> <span class="bound">r</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"CTXT <span class="free">IC</span> <span class="free">CT</span> <span class="main">(</span>Suc <span class="free">OC</span><span class="main">)</span> <span class="main">(</span>ovalidNF <span class="main">(</span><span class="free">I</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>owhile_inv <span class="free">C</span> <span class="free">B</span> <span class="free">r</span> <span class="free">I</span> <span class="free">R</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> LABEL_simps lpred_conj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">wp</span> <span class="operator">auto</span>

  <span class="keyword1" id="Setup_AutoCorres-L_ovalidNF_wp_comb2"><span class="command">lemma</span></span> L_ovalidNF_wp_comb2<span class="main">[</span><span class="operator">vcg_l_comb</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"CTXT <span class="free">IC</span> <span class="free">CT</span> <span class="free">OC</span> <span class="main">(</span>ovalidNF <span class="free">P</span> <span class="free">f</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P'</span> <span class="bound">s</span> <span class="main">⟹</span> VC <span class="main">(</span><span class="inner_quoted">''weaken''</span><span class="main">,</span> <span class="free">IC</span><span class="main">,</span> <span class="main">[</span>VAR <span class="bound">s</span><span class="main">]</span><span class="main">)</span> <span class="free">CT</span> <span class="main">(</span><span class="free">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"CTXT <span class="free">IC</span> <span class="free">CT</span> <span class="free">OC</span> <span class="main">(</span>ovalidNF <span class="free">P'</span> <span class="free">f</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> LABEL_simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ovalidNF_wp_comb2<span class="main">)</span>

  <span class="keyword1" id="Setup_AutoCorres-L_condition_NF_wp"><span class="command">lemma</span></span> L_condition_NF_wp<span class="main">[</span><span class="operator">vcg_l</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">CT</span> <span class="free">IC</span>
    <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT'</span> <span class="main">≡</span> <span class="main">(</span><span class="inner_quoted">''if''</span><span class="main">,</span> <span class="free">IC</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="free">CT</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"CTXT <span class="free">IC</span> <span class="main">(</span><span class="main">(</span><span class="inner_quoted">''then''</span><span class="main">,</span> <span class="free">IC</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="free">CT'</span><span class="main">)</span> <span class="free">OC1</span> <span class="main">(</span>ovalidNF <span class="free">L</span> <span class="free">l</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"CTXT <span class="main">(</span>Suc <span class="free">OC1</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="inner_quoted">''else''</span><span class="main">,</span> Suc <span class="free">OC1</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="free">CT'</span><span class="main">)</span> <span class="free">OC</span> <span class="main">(</span>ovalidNF <span class="free">R</span> <span class="free">r</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"CTXT <span class="free">IC</span> <span class="free">CT</span> <span class="free">OC</span> <span class="main">(</span>ovalidNF <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> BRANCH <span class="main">(</span><span class="keyword1">if</span> <span class="free">C</span> <span class="bound">s</span> <span class="keyword1">then</span> <span class="free">L</span> <span class="bound">s</span> <span class="keyword1">else</span> <span class="free">R</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ocondition <span class="free">C</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> LABEL_simps BRANCH_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">wp</span>

  <span class="keyword1" id="Setup_AutoCorres-L_ogets_NF_wp"><span class="command">lemma</span></span> L_ogets_NF_wp<span class="main">[</span><span class="operator">vcg_l</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"CTXT <span class="free">IC</span> <span class="free">CT</span> <span class="free">IC</span> <span class="main">(</span>ovalidNF <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>ogets <span class="free">f</span><span class="main">)</span> <span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> LABEL_simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">wp</span>

  <span class="keyword1" id="Setup_AutoCorres-elim_land"><span class="command">lemma</span></span> elim_land<span class="main">[</span><span class="operator">vcg_elim</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">land</span> <span class="free">Q</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lpred_conj_def<span class="main">)</span>

  <span class="keyword1" id="Setup_AutoCorres-simp_bind"><span class="command">lemma</span></span> simp_bind<span class="main">[</span><span class="operator">vcg_simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"BIND <span class="free">ct</span> <span class="free">n</span> <span class="free">P</span> <span class="free">s</span> <span class="main">⟷</span> BIND <span class="free">ct</span> <span class="free">n</span> <span class="main">(</span><span class="free">P</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LABEL_simps<span class="main">)</span>

  <span class="keyword1" id="Setup_AutoCorres-simp_land"><span class="command">lemma</span></span> simp_land<span class="main">[</span><span class="operator">vcg_simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">land</span> <span class="free">Q</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟷</span> <span class="free">P</span> <span class="free">s</span> <span class="main">∧</span> <span class="free">Q</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lpred_conj_def<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/AFP/Case_Labeling/util.ML">
<div class="head">
<h1>File ‹$AFP/Case_Labeling/util.ML›</h1>
</div>
<pre class="source"><span class="keyword1"><span class="keyword">infix</span></span> <span class="inner_numeral">1</span> THEN_CONTEXT
<span class="keyword1"><span class="keyword">infix</span></span> <span class="inner_numeral">1</span> THEN_ALL_NEW_FWD

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">BASIC_UTIL</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> INTERVAL_FWD<span class="main">:</span> <span class="main">(</span>int <span class="main">-&gt;</span> tactic<span class="main">)</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> REPEAT_ALL_NEW_FWD<span class="main">:</span> <span class="main">(</span>int <span class="main">-&gt;</span> tactic<span class="main">)</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> THEN_CONTEXT<span class="main">:</span> tactic * <span class="entity">context_tactic</span> <span class="main">-&gt;</span> <span class="entity">context_tactic</span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> THEN_ALL_NEW_FWD<span class="main">:</span> <span class="main">(</span>int <span class="main">-&gt;</span> tactic<span class="main">)</span> * <span class="main">(</span>int <span class="main">-&gt;</span> tactic<span class="main">)</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">UTIL</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">include</span></span> <span class="entity">BASIC_UTIL</span>
  <span class="keyword1"><span class="keyword">val</span></span> appair<span class="main">:</span> <span class="main">(</span>'a <span class="main">-&gt;</span> 'c<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>'b <span class="main">-&gt;</span> 'd<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>'a * 'b<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>'c * 'd<span class="main">)</span>

  <span class="keyword1"><span class="keyword">val</span></span> infst<span class="main">:</span> <span class="main">(</span>'a <span class="main">-&gt;</span> 'b <span class="main">-&gt;</span> 'c * 'b<span class="main">)</span> <span class="main">-&gt;</span> 'a * 'e <span class="main">-&gt;</span> 'b <span class="main">-&gt;</span> <span class="main">(</span>'c * 'e<span class="main">)</span> * 'b

  <span class="keyword1"><span class="keyword">val</span></span> fst_ord<span class="main">:</span> <span class="main">(</span>'a * 'a <span class="main">-&gt;</span> order<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>'a * 'b<span class="main">)</span> * <span class="main">(</span>'a * 'b<span class="main">)</span> <span class="main">-&gt;</span> order
  <span class="keyword1"><span class="keyword">val</span></span> snd_ord<span class="main">:</span> <span class="main">(</span>'b * 'b <span class="main">-&gt;</span> order<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>'a * 'b<span class="main">)</span> * <span class="main">(</span>'a * 'b<span class="main">)</span> <span class="main">-&gt;</span> order
  <span class="keyword1"><span class="keyword">val</span></span> none_inf_ord<span class="main">:</span> <span class="main">(</span>'a * 'a <span class="main">-&gt;</span> order<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>'a option * 'a option<span class="main">)</span> <span class="main">-&gt;</span> order

  <span class="keyword1"><span class="keyword">val</span></span> dest_bool<span class="main">:</span> term <span class="main">-&gt;</span> bool
  <span class="keyword1"><span class="keyword">val</span></span> dest_option<span class="main">:</span> term <span class="main">-&gt;</span> term option
  <span class="keyword1"><span class="keyword">val</span></span> dest_pair<span class="main">:</span> term <span class="main">-&gt;</span> term * term
  <span class="keyword1"><span class="keyword">val</span></span> dest_tuple<span class="main">:</span> term <span class="main">-&gt;</span> term list

  <span class="keyword1"><span class="keyword">val</span></span> SIMPLE_METHOD_CASES<span class="main">:</span> <span class="entity">context_tactic</span> <span class="main">-&gt;</span> <span class="entity">Method.method</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Util</span> <span class="main">:</span> <span class="entity">UTIL</span> <span class="main">=</span>
 <span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="main">(</span><span class="entity">tac1</span> <span class="entity">THEN_CONTEXT</span> <span class="entity">tac2</span><span class="main">)</span> <span class="main">:</span> <span class="entity">context_tactic</span> <span class="main">=</span>
  <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span> <span class="entity">st</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">st</span> |&gt; <span class="entity">tac1</span> |&gt; Seq.maps <span class="main">(</span>pair <span class="entity">ctxt</span> #&gt; <span class="entity">tac2</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">appair</span> <span class="entity">f</span> <span class="entity">g</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">f</span> <span class="entity">x</span><span class="main">,</span> <span class="entity">g</span> <span class="entity">y</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">infst</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span> <span class="entity">c</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">x'</span><span class="main">,</span><span class="entity">c'</span><span class="main">)</span> <span class="main">=</span> <span class="entity">f</span> <span class="entity">x</span> <span class="entity">c</span> <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">x'</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span><span class="main">,</span> <span class="entity">c'</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fst_ord</span> <span class="entity">ord</span> <span class="main">(</span><span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="entity">x'</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">ord</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">x'</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">snd_ord</span> <span class="entity">ord</span> <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">y'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">ord</span> <span class="main">(</span><span class="entity">y</span><span class="main">,</span> <span class="entity">y'</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">none_inf_ord</span> <span class="entity">ord</span> <span class="main">(</span>SOME <span class="entity">x</span><span class="main">,</span> SOME <span class="entity">y</span><span class="main">)</span> <span class="main">=</span> <span class="entity">ord</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">none_inf_ord</span> <span class="main">_</span> <span class="main">(</span>NONE<span class="main">,</span> NONE<span class="main">)</span> <span class="main">=</span> EQUAL
  <span class="main">|</span> <span class="entity">none_inf_ord</span> <span class="main">_</span> <span class="main">(</span>NONE<span class="main">,</span> SOME <span class="main">_</span><span class="main">)</span> <span class="main">=</span> GREATER
  <span class="main">|</span> <span class="entity">none_inf_ord</span> <span class="main">_</span> <span class="main">(</span>SOME <span class="main">_</span><span class="main">,</span> NONE<span class="main">)</span> <span class="main">=</span> LESS<span class="main">;</span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_option</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> "None"<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> NONE
  <span class="main">|</span> <span class="entity">dest_option</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> "Some"<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> SOME <span class="entity">t</span>
  <span class="main">|</span> <span class="entity">dest_option</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"dest_option"</span><span class="main">,</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_bool</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> "True"<span class="antiquote">}</span></span> <span class="main">=</span> true
  <span class="main">|</span> <span class="entity">dest_bool</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> "False"<span class="antiquote">}</span></span> <span class="main">=</span> false
  <span class="main">|</span> <span class="entity">dest_bool</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"dest_bool"</span><span class="main">,</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_pair</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> "Pair"<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">t</span> $ <span class="entity">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span><span class="entity">u</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">dest_pair</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"dest_pair"</span><span class="main">,</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_tuple</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Pair<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">t1</span> $ <span class="entity">t2</span><span class="main">)</span> <span class="main">=</span>
      <span class="entity">t1</span> :: <span class="entity">dest_tuple</span> <span class="entity">t2</span>
  <span class="main">|</span> <span class="entity">dest_tuple</span> <span class="entity">t</span> <span class="main">=</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span>



<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">SIMPLE_METHOD_CASES</span> <span class="entity">tac</span> <span class="main">=</span>
  <span class="entity">CONTEXT_METHOD</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">facts</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span> <span class="entity">st</span><span class="main">)</span> <span class="main">=&gt;</span>
    <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span> <span class="entity">st</span><span class="main">)</span> |&gt; <span class="main">(</span>ALLGOALS <span class="main">(</span><span class="entity">Method.insert_tac</span> <span class="entity">ctxt</span> <span class="entity">facts</span><span class="main">)</span> <span class="entity">THEN_CONTEXT</span> <span class="entity">tac</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* Apply tactic to subgoals in interval, in a forward manner, skipping over
  emerging subgoals *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">INTERVAL_FWD</span> <span class="entity">tac</span> <span class="entity">l</span> <span class="entity">u</span> <span class="entity">st</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">l</span>&gt;<span class="entity">u</span> <span class="keyword2"><span class="keyword">then</span></span> all_tac <span class="entity">st</span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="entity">tac</span> <span class="entity">l</span> THEN <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st'</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ofs</span> <span class="main">=</span> Thm.nprems_of <span class="entity">st'</span> - Thm.nprems_of <span class="entity">st</span><span class="main">;</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">ofs</span> &lt; <span class="inner_numeral">~1</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="keyword3"><span class="keyword">raise</span></span> THM <span class="main">(</span>
        <span class="inner_quoted">"INTERVAL_FWD: Tac solved more than one goal"</span><span class="main">,</span><span class="inner_numeral">~1</span><span class="main">,</span><span class="main">[</span><span class="entity">st</span><span class="main">,</span><span class="entity">st'</span><span class="main">]</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">INTERVAL_FWD</span> <span class="entity">tac</span> <span class="main">(</span><span class="entity">l</span>+<span class="inner_numeral">1</span>+<span class="entity">ofs</span><span class="main">)</span> <span class="main">(</span><span class="entity">u</span>+<span class="entity">ofs</span><span class="main">)</span> <span class="entity">st'</span>
    <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span><span class="main">)</span> <span class="entity">st</span><span class="main">;</span>

<span class="comment1">(* Apply tac2 to all subgoals emerged from tac1, in forward manner. *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="main">(</span><span class="entity">tac1</span> <span class="entity">THEN_ALL_NEW_FWD</span> <span class="entity">tac2</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span>
  <span class="main">(</span><span class="entity">tac1</span> <span class="entity">i</span>
    THEN <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st'</span> <span class="main">=&gt;</span> <span class="entity">INTERVAL_FWD</span> <span class="entity">tac2</span> <span class="entity">i</span> <span class="main">(</span><span class="entity">i</span> + Thm.nprems_of <span class="entity">st'</span> - Thm.nprems_of <span class="entity">st</span><span class="main">)</span> <span class="entity">st'</span><span class="main">)</span>
  <span class="main">)</span> <span class="entity">st</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">REPEAT_ALL_NEW_FWD</span> <span class="entity">tac</span> <span class="main">=</span>
  <span class="entity">tac</span> <span class="entity">THEN_ALL_NEW_FWD</span> <span class="main">(</span>TRY o <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> <span class="entity">REPEAT_ALL_NEW_FWD</span> <span class="entity">tac</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>


<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Basic_Util</span><span class="main">:</span> <span class="entity">BASIC_UTIL</span> <span class="main">=</span> <span class="entity">Util</span>
<span class="keyword3"><span class="keyword">open</span></span> <span class="entity">Basic_Util</span>
</pre>
</div><div id="Check_Planarity_Verification">
<div class="head">
<h1>Theory Check_Planarity_Verification</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Verififcation of a Planarity Checker›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Check_Planarity_Verification
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="#Graph_Genus">../Planarity/Graph_Genus</a>"</span>
  <a href="#Setup_AutoCorres">Setup_AutoCorres</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Rewrite.html">HOL-Library.Rewrite</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span>  <span class="quoted"><span class="plain_text">‹Implementation Types›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> IVert <span class="main">=</span> <span class="quoted"><span class="quoted">"nat"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> IEdge <span class="main">=</span> <span class="quoted"><span class="quoted">"IVert <span class="main">×</span> IVert"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> IGraph <span class="main">=</span> <span class="quoted"><span class="quoted">"IVert list <span class="main">×</span> IEdge list"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">ig_edges</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">⇒</span> IEdge list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ig_edges</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> snd <span class="free"><span class="bound"><span class="entity">G</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">ig_verts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">⇒</span> IVert list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ig_verts</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> fst <span class="free"><span class="bound"><span class="entity">G</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ig_tail</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">⇒</span> nat <span class="main">⇒</span> IVert"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ig_tail</span> <span class="free"><span class="bound"><span class="entity">IG</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> fst <span class="main">(</span>ig_edges <span class="free"><span class="bound"><span class="entity">IG</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ig_head</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">⇒</span> nat <span class="main">⇒</span> IVert"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ig_head</span> <span class="free"><span class="bound"><span class="entity">IG</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> snd <span class="main">(</span>ig_edges <span class="free"><span class="bound"><span class="entity">IG</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> IMap <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>nat <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>nat <span class="main">⇒</span> nat<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">im_rev</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IMap <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> nat<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">im_rev</span> <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="main">=</span> fst <span class="free"><span class="bound"><span class="entity">iM</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">im_succ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IMap <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> nat<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">im_succ</span> <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="main">=</span> fst <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">iM</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">im_pred</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IMap <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> nat<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">im_pred</span> <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="main">=</span> snd <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">iM</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mk_graph</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">⇒</span> <span class="main">(</span>IVert<span class="main">,</span> nat<span class="main">)</span> pre_digraph"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mk_graph</span> <span class="free"><span class="bound"><span class="entity">IG</span></span></span> <span class="main">≡</span> <span class="main">⦇</span>
    verts <span class="main">=</span> set <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">IG</span></span></span><span class="main">)</span><span class="main">,</span>
    arcs <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span> length <span class="main">(</span>ig_edges <span class="free"><span class="bound"><span class="entity">IG</span></span></span><span class="main">)</span><span class="main">}</span><span class="main">,</span>
    tail <span class="main">=</span> ig_tail <span class="free"><span class="bound"><span class="entity">IG</span></span></span><span class="main">,</span>
    head <span class="main">=</span> ig_head <span class="free"><span class="bound"><span class="entity">IG</span></span></span>
  <span class="main">⦈</span>"</span></span>

<span class="keyword1" id="Check_Planarity_Verification-mkg_simps"><span class="command">lemma</span></span> mkg_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"verts <span class="main">(</span>mk_graph <span class="free">IG</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>ig_verts <span class="free">IG</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"tail <span class="main">(</span>mk_graph <span class="free">IG</span><span class="main">)</span> <span class="main">=</span> ig_tail <span class="free">IG</span>"</span></span>
  <span class="quoted"><span class="quoted">"head <span class="main">(</span>mk_graph <span class="free">IG</span><span class="main">)</span> <span class="main">=</span> ig_head <span class="free">IG</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mk_graph_def<span class="main">)</span>

<span class="keyword1" id="Check_Planarity_Verification-arcs_mkg"><span class="command">lemma</span></span> arcs_mkg<span class="main">:</span> <span class="quoted"><span class="quoted">"arcs <span class="main">(</span>mk_graph <span class="free">IG</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span> length <span class="main">(</span>ig_edges <span class="free">IG</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mk_graph_def<span class="main">)</span>

<span class="keyword1" id="Check_Planarity_Verification-arc_to_ends_mkg"><span class="command">lemma</span></span> arc_to_ends_mkg<span class="main">:</span> <span class="quoted"><span class="quoted">"arc_to_ends <span class="main">(</span>mk_graph <span class="free">IG</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> ig_edges <span class="free">IG</span> <span class="main">!</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arc_to_ends_def mkg_simps ig_tail_def ig_head_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mk_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> nat<span class="main">)</span> pre_digraph <span class="main">⇒</span> IMap <span class="main">⇒</span> nat pre_map"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mk_map</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="main">≡</span> <span class="main">⦇</span>
    edge_rev <span class="main">=</span> perm_restrict <span class="main">(</span>im_rev <span class="free"><span class="bound"><span class="entity">iM</span></span></span><span class="main">)</span> <span class="main">(</span>arcs <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">,</span>
    edge_succ <span class="main">=</span> perm_restrict <span class="main">(</span>im_succ <span class="free"><span class="bound"><span class="entity">iM</span></span></span><span class="main">)</span> <span class="main">(</span>arcs <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>
  <span class="main">⦈</span>"</span></span>

<span class="keyword1" id="Check_Planarity_Verification-mkm_simps"><span class="command">lemma</span></span> mkm_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"edge_rev <span class="main">(</span>mk_map <span class="free">G</span> <span class="free">iM</span><span class="main">)</span> <span class="main">=</span> perm_restrict <span class="main">(</span>im_rev <span class="free">iM</span><span class="main">)</span> <span class="main">(</span>arcs <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"edge_succ <span class="main">(</span>mk_map <span class="free">G</span> <span class="free">iM</span><span class="main">)</span> <span class="main">=</span> perm_restrict <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="main">(</span>arcs <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mk_map_def<span class="main">)</span>

<span class="keyword1" id="Check_Planarity_Verification-es_eq_im"><span class="command">lemma</span></span> es_eq_im<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="main">⟹</span> edge_succ <span class="main">(</span>mk_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> im_succ <span class="free">iM</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkm_simps arcs_mkg perm_restrict_simps<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Implementation›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_map</span> <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="main">≡</span>
  <span class="keyword1">DO</span> <span class="bound">ecnt</span> <span class="main">←</span> oreturn <span class="main">(</span>length <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">iG</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
     <span class="bound">vcnt</span> <span class="main">←</span> oreturn <span class="main">(</span>length <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">iG</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
     <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">revOk</span><span class="main">)</span> <span class="main">←</span> owhile
      <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">ok</span><span class="main">)</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">ecnt</span> <span class="main">∧</span> <span class="bound">ok</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">ok</span><span class="main">)</span><span class="main">.</span>
        <span class="keyword1">DO</span>
          <span class="bound">j</span> <span class="main">←</span> oreturn <span class="main">(</span>im_rev <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">;</span>
          <span class="bound">revIn</span> <span class="main">←</span> oreturn <span class="main">(</span><span class="bound">j</span> <span class="main">&lt;</span> length <span class="main">(</span>ig_edges <span class="free"><span class="bound"><span class="entity">iG</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
          <span class="bound">revNeq</span> <span class="main">←</span> oreturn <span class="main">(</span><span class="bound">j</span> <span class="main">≠</span> <span class="bound">i</span><span class="main">)</span><span class="main">;</span>
          <span class="bound">revRevs</span> <span class="main">←</span> oreturn <span class="main">(</span>ig_edges <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> prod.swap <span class="main">(</span>ig_edges <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
          <span class="bound">invol</span> <span class="main">←</span> oreturn <span class="main">(</span>im_rev <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="bound">j</span> <span class="main">=</span> <span class="bound">i</span><span class="main">)</span><span class="main">;</span>
          oreturn <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="bound">revIn</span> <span class="main">∧</span> <span class="bound">revNeq</span> <span class="main">∧</span> <span class="bound">revRevs</span> <span class="main">∧</span> <span class="bound">invol</span><span class="main">)</span>
        <span class="keyword1">OD</span><span class="main">)</span>
      <span class="main">(</span><span class="main">0</span><span class="main">,</span> True<span class="main">)</span><span class="main">;</span>
     <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">succPerm</span><span class="main">)</span> <span class="main">←</span> owhile
      <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">ok</span><span class="main">)</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">ecnt</span> <span class="main">∧</span> <span class="bound">ok</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">ok</span><span class="main">)</span><span class="main">.</span>
        <span class="keyword1">DO</span>
          <span class="bound">j</span> <span class="main">←</span> oreturn <span class="main">(</span>im_succ <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">;</span>
          <span class="bound">succIn</span> <span class="main">←</span> oreturn <span class="main">(</span><span class="bound">j</span> <span class="main">&lt;</span> length <span class="main">(</span>ig_edges <span class="free"><span class="bound"><span class="entity">iG</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
          <span class="bound">succEnd</span> <span class="main">←</span> oreturn <span class="main">(</span>ig_tail <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="bound">i</span> <span class="main">=</span> ig_tail <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="bound">j</span><span class="main">)</span><span class="main">;</span>
          <span class="bound">isPerm</span> <span class="main">←</span> oreturn <span class="main">(</span>im_pred <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="bound">j</span> <span class="main">=</span> <span class="bound">i</span><span class="main">)</span><span class="main">;</span>
          oreturn <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="bound">succIn</span> <span class="main">∧</span> <span class="bound">succEnd</span> <span class="main">∧</span> <span class="bound">isPerm</span><span class="main">)</span>
        <span class="keyword1">OD</span><span class="main">)</span>
      <span class="main">(</span><span class="main">0</span><span class="main">,</span> True<span class="main">)</span><span class="main">;</span>
     <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">succOrbits</span><span class="main">,</span> <span class="bound">V</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="main">←</span> owhile
      <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">ok</span><span class="main">,</span> <span class="bound">V</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">ecnt</span> <span class="main">∧</span> <span class="bound">succPerm</span> <span class="main">∧</span> <span class="bound">ok</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">ok</span><span class="main">,</span> <span class="bound">V</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span><span class="main">.</span>
        <span class="keyword1">DO</span>
          <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">V</span><span class="main">,</span><span class="bound">A</span><span class="main">)</span> <span class="main">←</span> ocondition <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> ig_tail <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="bound">i</span> <span class="main">∈</span> <span class="bound">V</span><span class="main">)</span>
            <span class="main">(</span>oreturn <span class="main">(</span><span class="bound">i</span> <span class="main">∈</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">V</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span><span class="keyword1">DO</span>
              <span class="main">(</span><span class="bound">A'</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">←</span> owhile
                <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">A'</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∉</span> <span class="bound">A'</span><span class="main">)</span>
                <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">A'</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">DO</span>
                    <span class="bound">A'</span> <span class="main">←</span> oreturn <span class="main">(</span>insert <span class="bound">j</span> <span class="bound">A'</span><span class="main">)</span><span class="main">;</span>
                    <span class="bound">j</span> <span class="main">←</span> oreturn <span class="main">(</span>im_succ <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="bound">j</span><span class="main">)</span><span class="main">;</span>
                    oreturn <span class="main">(</span><span class="bound">A'</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span>
                  <span class="keyword1">OD</span><span class="main">)</span>
                <span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">;</span>
              <span class="bound">V</span> <span class="main">←</span> oreturn <span class="main">(</span>insert <span class="main">(</span>ig_tail <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="bound">j</span><span class="main">)</span> <span class="bound">V</span><span class="main">)</span><span class="main">;</span>
              oreturn <span class="main">(</span>True<span class="main">,</span><span class="bound">V</span><span class="main">,</span><span class="bound">A</span> <span class="main">∪</span> <span class="bound">A'</span><span class="main">)</span>
            <span class="keyword1">OD</span><span class="main">)</span><span class="main">;</span>
          oreturn <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">V</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span>
        <span class="keyword1">OD</span><span class="main">)</span>
      <span class="main">(</span><span class="main">0</span><span class="main">,</span> True<span class="main">,</span> <span class="main">{}</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">;</span>
     oreturn <span class="main">(</span><span class="bound">revOk</span> <span class="main">∧</span> <span class="bound">succPerm</span> <span class="main">∧</span> <span class="bound">succOrbits</span><span class="main">)</span>
  <span class="keyword1">OD</span>
"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isolated_nodes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> nat option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">isolated_nodes</span> <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="main">≡</span>
  <span class="keyword1">DO</span> <span class="bound">ecnt</span> <span class="main">←</span> oreturn <span class="main">(</span>length <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">iG</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
     <span class="bound">vcnt</span> <span class="main">←</span> oreturn <span class="main">(</span>length <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">iG</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
     <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">nz</span><span class="main">)</span> <span class="main">←</span>
     owhile
      <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">nz</span><span class="main">)</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">vcnt</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">nz</span><span class="main">)</span><span class="main">.</span>
          <span class="keyword1">DO</span> <span class="bound">v</span> <span class="main">←</span> oreturn <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">;</span>
             <span class="bound">j</span> <span class="main">←</span> oreturn <span class="main">0</span><span class="main">;</span>
             <span class="bound">ret</span> <span class="main">←</span> ocondition <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="bound">ecnt</span><span class="main">)</span> <span class="main">(</span>oreturn <span class="main">(</span>ig_tail <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="bound">j</span> <span class="main">≠</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>oreturn False<span class="main">)</span><span class="main">;</span>
             <span class="bound">ret</span> <span class="main">←</span> ocondition <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">ret</span><span class="main">)</span> <span class="main">(</span>oreturn <span class="main">(</span>ig_head <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="bound">j</span> <span class="main">≠</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>oreturn <span class="bound">ret</span><span class="main">)</span><span class="main">;</span>
             <span class="main">(</span><span class="bound">j</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">←</span>
             owhile
              <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">j</span><span class="main">,</span> <span class="bound">cond</span><span class="main">)</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">cond</span><span class="main">)</span>
              <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">j</span><span class="main">,</span> <span class="bound">cond</span><span class="main">)</span><span class="main">.</span>
                  <span class="keyword1">DO</span> <span class="bound">j</span> <span class="main">←</span> oreturn <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
                     <span class="bound">cond</span> <span class="main">←</span> ocondition <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="bound">ecnt</span><span class="main">)</span> <span class="main">(</span>oreturn <span class="main">(</span>ig_tail <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="bound">j</span> <span class="main">≠</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>oreturn False<span class="main">)</span><span class="main">;</span>
                     <span class="bound">cond</span> <span class="main">←</span> ocondition <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">cond</span><span class="main">)</span> <span class="main">(</span>oreturn <span class="main">(</span>ig_head <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="bound">j</span> <span class="main">≠</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>oreturn <span class="bound">cond</span><span class="main">)</span><span class="main">;</span>
                     oreturn <span class="main">(</span><span class="bound">j</span><span class="main">,</span> <span class="bound">cond</span><span class="main">)</span>
                  <span class="keyword1">OD</span><span class="main">)</span>
              <span class="main">(</span><span class="bound">j</span><span class="main">,</span> <span class="bound">ret</span><span class="main">)</span><span class="main">;</span>
             <span class="bound">nz</span> <span class="main">←</span> oreturn <span class="main">(</span><span class="keyword1">if</span> <span class="bound">j</span> <span class="main">=</span> <span class="bound">ecnt</span> <span class="keyword1">then</span> <span class="bound">nz</span> <span class="main">+</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="bound">nz</span><span class="main">)</span><span class="main">;</span>
             oreturn <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="bound">nz</span><span class="main">)</span>
          <span class="keyword1">OD</span><span class="main">)</span>
      <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">;</span>
     oreturn <span class="bound">nz</span>
  <span class="keyword1">OD</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">face_cycles</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IGraph <span class="main">⇒</span> nat pre_map <span class="main">⇒</span> <span class="main">_</span>  <span class="main">⇒</span> nat option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">face_cycles</span> <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="main">≡</span>
  <span class="keyword1">DO</span> <span class="bound">ecnt</span> <span class="main">←</span> oreturn <span class="main">(</span>length <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">iG</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
     <span class="main">(</span><span class="bound">edge_info</span><span class="main">,</span> <span class="bound">c</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">←</span>
     owhile
      <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">edge_info</span><span class="main">,</span> <span class="bound">c</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">ecnt</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">edge_info</span><span class="main">,</span> <span class="bound">c</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span>
          <span class="keyword1">DO</span> <span class="main">(</span><span class="bound">edge_info</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="main">←</span>
             ocondition <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∉</span> <span class="bound">edge_info</span><span class="main">)</span>
              <span class="main">(</span><span class="keyword1">DO</span> <span class="bound">j</span> <span class="main">←</span> oreturn <span class="bound">i</span><span class="main">;</span>
                  <span class="bound">edge_info</span> <span class="main">←</span> oreturn <span class="main">(</span>insert <span class="bound">j</span> <span class="bound">edge_info</span><span class="main">)</span><span class="main">;</span>
                  <span class="bound">ret'</span> <span class="main">←</span> oreturn <span class="main">(</span>pre_digraph_map.face_cycle_succ <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="bound">j</span><span class="main">)</span><span class="main">;</span>
                  <span class="main">(</span><span class="bound">edge_info</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">←</span>
                  owhile
                   <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">edge_info</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span><span class="main">)</span>
                   <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">edge_info</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span>
                       oreturn <span class="main">(</span>insert <span class="bound">j</span> <span class="bound">edge_info</span><span class="main">,</span> pre_digraph_map.face_cycle_succ <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>
                   <span class="main">(</span><span class="bound">edge_info</span><span class="main">,</span> <span class="bound">ret'</span><span class="main">)</span><span class="main">;</span>
                  oreturn <span class="main">(</span><span class="bound">edge_info</span><span class="main">,</span> <span class="bound">c</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>
               <span class="keyword1">OD</span><span class="main">)</span>
              <span class="main">(</span>oreturn <span class="main">(</span><span class="bound">edge_info</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
             oreturn <span class="main">(</span><span class="bound">edge_info</span><span class="main">,</span> <span class="bound">c</span><span class="main">,</span> <span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>
          <span class="keyword1">OD</span><span class="main">)</span>
      <span class="main">(</span><span class="main">{}</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">;</span>
     oreturn <span class="bound">c</span>
  <span class="keyword1">OD</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">euler_genus</span> <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span>
   <span class="keyword1">DO</span> <span class="bound">n</span> <span class="main">←</span> oreturn <span class="main">(</span>length <span class="main">(</span>ig_edges <span class="free"><span class="bound"><span class="entity">iG</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">m</span> <span class="main">←</span> oreturn <span class="main">(</span>length <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">iG</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">nz</span> <span class="main">←</span> isolated_nodes <span class="free"><span class="bound"><span class="entity">iG</span></span></span><span class="main">;</span>
      <span class="bound">fc</span> <span class="main">←</span> face_cycles <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="free"><span class="bound"><span class="entity">iM</span></span></span><span class="main">;</span>
      oreturn <span class="main">(</span><span class="main">(</span>int <span class="bound">n</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> int <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">-</span> int <span class="bound">m</span> <span class="main">-</span> int <span class="bound">nz</span> <span class="main">-</span> int <span class="bound">fc</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>
   <span class="keyword1">OD</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">certify</span> <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span>
  <span class="keyword1">DO</span>
     <span class="bound">map</span> <span class="main">←</span> is_map <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="free"><span class="bound"><span class="entity">iM</span></span></span><span class="main">;</span>
     ocondition <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">map</span><span class="main">)</span>
       <span class="main">(</span><span class="keyword1">DO</span>
          <span class="bound">gen</span> <span class="main">←</span> euler_genus <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="main">(</span>mk_map <span class="main">(</span>mk_graph <span class="free"><span class="bound"><span class="entity">iG</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">iM</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">;</span>
          oreturn <span class="main">(</span><span class="bound">gen</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>
       <span class="keyword1">OD</span><span class="main">)</span>
       <span class="main">(</span>oreturn False<span class="main">)</span>
  <span class="keyword1">OD</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Verification›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">interpretation</span></span> Labeling_Syntax <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1" id="Check_Planarity_Verification-trivial_label"><span class="command">lemma</span></span> trivial_label<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⟹</span> CTXT <span class="free">IC</span> <span class="free">CT</span> <span class="free">OC</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> LABEL_simps <span class="keyword1"><span class="command">.</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Check_Planarity_Verification-ovalidNF_wp"><span class="command">lemma</span></span> ovalidNF_wp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ovalidNF <span class="free">P</span> <span class="free">c</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ovalidNF <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="free">x</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ovalidNF_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">is_map</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_map_rev_ok_inv</span> <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">ok</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">ok</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">.</span>
  im_rev <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>ig_edges <span class="free"><span class="bound"><span class="entity">iG</span></span></span><span class="main">)</span>
  <span class="main">∧</span> ig_edges <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="main">!</span> im_rev <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="bound">i</span> <span class="main">=</span> prod.swap <span class="main">(</span>ig_edges <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>
  <span class="main">∧</span> im_rev <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">i</span>
  <span class="main">∧</span> im_rev <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="main">(</span>im_rev <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="bound">i</span><span class="main">)</span>
"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_map_succ_perm_inv</span> <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">ok</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">ok</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">.</span>
  im_succ <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>ig_edges <span class="free"><span class="bound"><span class="entity">iG</span></span></span><span class="main">)</span>
  <span class="main">∧</span> ig_tail <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="main">(</span>im_succ <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> ig_tail <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="bound">i</span>
  <span class="main">∧</span> im_pred <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="main">(</span>im_succ <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="bound">i</span><span class="main">)</span>
"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_map_succ_orbits_inv</span> <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">ok</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span>
  <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">&lt;</span><span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">ok</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">.</span> orbit <span class="main">(</span>im_succ <span class="free"><span class="bound"><span class="entity">iM</span></span></span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span>
  <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">=</span> <span class="main">{</span>ig_tail <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">ok</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span> <span class="main">∧</span>
  <span class="free"><span class="bound"><span class="entity">ok</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">.</span> ig_tail <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="bound">i</span> <span class="main">=</span> ig_tail <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="bound">j</span> <span class="main">⟶</span> <span class="bound">j</span> <span class="main">∈</span> orbit <span class="main">(</span>im_succ <span class="free"><span class="bound"><span class="entity">iM</span></span></span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span>
"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_map_succ_orbits_inner_inv</span> <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="main">≡</span>
  <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">}</span> <span class="main">∪</span> segment <span class="main">(</span>im_succ <span class="free"><span class="bound"><span class="entity">iM</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>
  <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∈</span> orbit <span class="main">(</span>im_succ <span class="free"><span class="bound"><span class="entity">iM</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>
"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_map_final</span> <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">ok</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ok</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> length <span class="main">(</span>ig_edges <span class="free"><span class="bound"><span class="entity">iG</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≤</span> length <span class="main">(</span>ig_edges <span class="free"><span class="bound"><span class="entity">iG</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Check_Planarity_Verification-bij_betwI_finite_dom"><span class="command">lemma</span></span> bij_betwI_finite_dom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">→</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">g</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">f</span> <span class="free">A</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> inj_onI<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pi_iff assms<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> endo_inj_surj image_subsetI<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Planarity_Verification-permutesI_finite_dom"><span class="command">lemma</span></span> permutesI_finite_dom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">→</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">g</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">permutes</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bij_imp_permutes bij_betwI_finite_dom<span class="main">)</span>

<span class="keyword1" id="Check_Planarity_Verification-orbit_ss"><span class="command">lemma</span></span> orbit_ss<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">→</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"orbit <span class="free">f</span> <span class="free">a</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> orbit <span class="free">f</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Planarity_Verification-segment_eq_orbit"><span class="command">lemma</span></span> segment_eq_orbit<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> orbit <span class="free">f</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"segment <span class="free">f</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> orbit <span class="free">f</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> set_eqI iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> segment <span class="free">f</span> <span class="free">x</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> orbit <span class="free">f</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> segmentD_orbit<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> orbit <span class="free">f</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> segment <span class="free">f</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> segment.intros orbit_eqI <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> orbit.cases<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Planarity_Verification-funpow_in_funcset"><span class="command">lemma</span></span> funpow_in_funcset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">→</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Check_Planarity_Verification-funpow_eq_funcset"><span class="command">lemma</span></span> funpow_eq_funcset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">→</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">g</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> funpow_in_funcset<span class="main">)</span>

<span class="keyword1" id="Check_Planarity_Verification-funpow_dist1_eq_funcset"><span class="command">lemma</span></span> funpow_dist1_eq_funcset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> orbit <span class="free">f</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">→</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"funpow_dist1 <span class="free">f</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> funpow_dist1 <span class="free">g</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">^^</span> funpow_dist1 <span class="free">f</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> funpow_dist1_prop<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">g</span> <span class="main">^^</span> funpow_dist1 <span class="free">f</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2-<span class="main"><span class="main">)</span></span> funpow_eq_funcset<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="free">g</span> <span class="main">^^</span> funpow_dist1 <span class="free">f</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span> <span class="main">^^</span> funpow_dist1 <span class="free">g</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> funpow_dist1_prop1 zero_less_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> gf<span class="main">:</span> <span class="quoted"><span class="quoted">"funpow_dist1 <span class="free">g</span> <span class="free">x</span> <span class="free">y</span> <span class="main">≤</span> funpow_dist1 <span class="free">f</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> funpow_dist1_least not_le zero_less_Suc<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">^^</span> funpow_dist1 <span class="free">g</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">g</span> <span class="main">^^</span> funpow_dist1 <span class="free">g</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2-<span class="main"><span class="main">)</span></span> funpow_eq_funcset<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"funpow_dist1 <span class="free">f</span> <span class="free">x</span> <span class="free">y</span> <span class="main">≤</span> funpow_dist1 <span class="free">g</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="main">_</span><span class="main">)</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> funpow_dist1_least not_le zero_less_Suc<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> gf fg <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Planarity_Verification-segment_cong0"><span class="command">lemma</span></span> segment_cong0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">→</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">y</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"segment <span class="free">f</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> segment <span class="free">g</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> orbit <span class="free">f</span> <span class="free">x</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"orbit <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> orbit <span class="free">g</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> orbit_cong0<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="skolem">n</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">g</span> <span class="main">^^</span> <span class="skolem">n</span><span class="main">)</span> <span class="free">x</span> <span class="main">∧</span> <span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="skolem">n</span><span class="main">)</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat.induct<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> segment_altdef funpow_dist1_eq_funcset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"orbit <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> orbit <span class="free">g</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> orbit_cong0<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> segment_eq_orbit<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Planarity_Verification-rev_ok_final"><span class="command">lemma</span></span> rev_ok_final<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf_iG<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_digraph <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rev<span class="main">:</span> <span class="quoted"><span class="quoted">"is_map_rev_ok_inv <span class="free">iG</span> <span class="free">iM</span> <span class="free">rev_i</span> <span class="free">rev_ok</span>"</span></span> <span class="quoted"><span class="quoted">"is_map_final <span class="free">iG</span> <span class="free">rev_i</span> <span class="free">rev_ok</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">rev_ok</span> <span class="main">⟷</span> bidirected_digraph <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="main">(</span>edge_rev <span class="main">(</span>mk_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">rev_ok</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> wf_digraph <span class="quoted"><span class="quoted">"mk_graph <span class="free">iG</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_iG<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> rev_inv_sep<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>ig_edges <span class="free">iG</span><span class="main">)</span> <span class="main">⟹</span> im_rev <span class="free">iM</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>ig_edges <span class="free">iG</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>ig_edges <span class="free">iG</span><span class="main">)</span> <span class="main">⟹</span> ig_edges <span class="free">iG</span> <span class="main">!</span> im_rev <span class="free">iM</span> <span class="bound">i</span> <span class="main">=</span> prod.swap <span class="main">(</span>ig_edges <span class="free">iG</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>ig_edges <span class="free">iG</span><span class="main">)</span> <span class="main">⟹</span> im_rev <span class="free">iM</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">i</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>ig_edges <span class="free">iG</span><span class="main">)</span> <span class="main">⟹</span> im_rev <span class="free">iM</span> <span class="main">(</span>im_rev <span class="free">iM</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rev <span class="quoted"><span class="quoted">‹<span class="free">rev_ok</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_map_rev_ok_inv_def is_map_final_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>ig_edges <span class="free">iG</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ig_tail <span class="free">iG</span> <span class="main">(</span>im_rev <span class="free">iM</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> ig_head <span class="free">iG</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rev_inv_sep<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"ig_edges <span class="free">iG</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ig_head_def ig_tail_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> wf <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkg_simps arcs_mkg mkm_simps perm_restrict_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rev</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"perm_restrict <span class="main">(</span>im_rev <span class="free">iM</span><span class="main">)</span> <span class="main">(</span>arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> bidirected_digraph <span class="quoted"><span class="quoted">"mk_graph <span class="free">iG</span>"</span></span> <span class="quoted"><span class="quoted">"perm_restrict <span class="main">(</span>im_rev <span class="free">iM</span><span class="main">)</span> <span class="main">(</span>arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?R</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mkm_simps mkg_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="main">⟹</span> <span class="var">?rev</span> <span class="bound">a</span> <span class="main">∈</span> arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span>"</span></span>
       <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="main">⟹</span>
        arc_to_ends <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="main">(</span><span class="var">?rev</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> prod.swap <span class="main">(</span>arc_to_ends <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
       <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="main">⟹</span> <span class="var">?rev</span> <span class="bound">a</span> <span class="main">≠</span> <span class="bound">a</span>"</span></span>
       <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="main">⟹</span> <span class="var">?rev</span> <span class="main">(</span><span class="var">?rev</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="bound">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arev_dom<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">rev_ok</span></span>
    <span class="keyword1"><span class="command">using</span></span> rev <span class="keyword1"><span class="command">unfolding</span></span> is_map_rev_ok_inv_def is_map_final_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> perm_restrict_simps arcs_mkg arc_to_ends_mkg<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">locale</span></span> is_map_postcondition0 <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">iG</span> <span class="free">iM</span> <span class="free">rev_ok</span> <span class="free">succ_i</span> <span class="free">succ_ok</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> succ_perm<span class="main">:</span> <span class="quoted"><span class="quoted">"is_map_succ_perm_inv <span class="free">iG</span> <span class="free">iM</span> <span class="free">succ_i</span> <span class="free">succ_ok</span>"</span></span> <span class="quoted"><span class="quoted">"is_map_final <span class="free">iG</span> <span class="free">succ_i</span> <span class="free">succ_ok</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Check_Planarity_Verification-succ_ok_tail_eq"><span class="command">lemma</span></span> succ_ok_tail_eq<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">succ_ok</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>ig_edges <span class="free">iG</span><span class="main">)</span> <span class="main">⟹</span> ig_tail <span class="free">iG</span> <span class="main">(</span>im_succ <span class="free">iM</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> ig_tail <span class="free">iG</span> <span class="free">i</span> "</span></span>
    <span class="keyword1"><span class="command">using</span></span> succ_perm <span class="keyword1"><span class="command">unfolding</span></span> is_map_succ_perm_inv_def is_map_final_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Check_Planarity_Verification-succ_ok_imp_pred"><span class="command">lemma</span></span> succ_ok_imp_pred<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">succ_ok</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>ig_edges <span class="free">iG</span><span class="main">)</span> <span class="main">⟹</span> im_pred <span class="free">iM</span> <span class="main">(</span>im_succ <span class="free">iM</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> succ_perm <span class="keyword1"><span class="command">unfolding</span></span> is_map_succ_perm_inv_def is_map_final_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Check_Planarity_Verification-succ_ok_imp_permutes"><span class="command">lemma</span></span> succ_ok_imp_permutes<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">succ_ok</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"edge_succ <span class="main">(</span>mk_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span><span class="main">)</span> <span class="keyword1">permutes</span> arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span><span class="main">.</span> edge_succ <span class="main">(</span>mk_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span><span class="main">)</span> <span class="bound">a</span> <span class="main">∈</span> arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> succ_perm <span class="keyword1"><span class="command">unfolding</span></span> is_map_succ_perm_inv_def is_map_final_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkg_simps mkm_simps arcs_mkg perm_restrict_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> succ_ok_imp_pred<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> permutesI_finite_dom<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"im_pred <span class="free">iM</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> perm_restrict_simps mkm_simps arcs_mkg<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Check_Planarity_Verification-es_A2A"><span class="command">lemma</span></span> es_A2A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">succ_ok</span> <span class="main">⟹</span> edge_succ <span class="main">(</span>mk_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span><span class="main">)</span> <span class="main">∈</span> arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="main">→</span> arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> succ_ok_imp_permutes <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> permutes_in_image<span class="main">)</span>

  <span class="keyword1" id="Check_Planarity_Verification-im_succ_le_length"><span class="command">lemma</span></span> im_succ_le_length<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">succ_ok</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>ig_edges <span class="free">iG</span><span class="main">)</span> <span class="main">⟹</span> im_succ <span class="free">iM</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>ig_edges <span class="free">iG</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> is_map_final_def is_map_succ_perm_inv_def succ_perm<span class="main">(</span>1<span class="main">)</span> succ_perm<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Check_Planarity_Verification-orbit_es_eq_im"><span class="command">lemma</span></span> orbit_es_eq_im<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">succ_ok</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈</span> arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="main">⟹</span> orbit <span class="main">(</span>edge_succ <span class="main">(</span>mk_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> orbit <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> _ es_A2A es_eq_im <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> orbit_cong0<span class="main">)</span>

  <span class="keyword1" id="Check_Planarity_Verification-segment_es_eq_im"><span class="command">lemma</span></span> segment_es_eq_im<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">succ_ok</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈</span> arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="main">⟹</span> segment <span class="main">(</span>edge_succ <span class="main">(</span>mk_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> segment <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> _ es_A2A es_eq_im <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> segment_cong0<span class="main">)</span>


  <span class="keyword1" id="Check_Planarity_Verification-in_orbit_im_succE"><span class="command">lemma</span></span> in_orbit_im_succE<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∈</span> orbit <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">succ_ok</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>ig_edges <span class="free">iG</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"ig_tail <span class="free">iG</span> <span class="free">j</span> <span class="main">=</span> ig_tail <span class="free">iG</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="main">(</span>ig_edges <span class="free">iG</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms es_A2A <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> succ_ok_tail_eq es_eq_im arcs_mkg<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1" id="Check_Planarity_Verification-self_in_orbit_im_succ"><span class="command">lemma</span></span> self_in_orbit_im_succ<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">succ_ok</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>ig_edges <span class="free">iG</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> orbit <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> orbit <span class="main">(</span>edge_succ <span class="main">(</span>mk_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms succ_ok_imp_permutes
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> permutation_self_in_orbit<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutation_permutes arcs_mkg<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>orbit_es_eq_im arcs_mkg<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> is_map_postcondition <span class="main">=</span> is_map_postcondition0 <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">so_i</span> <span class="free">so_ok</span> <span class="free">V</span> <span class="free">A</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rev_ok</span> <span class="main">⟷</span> bidirected_digraph <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="main">(</span>edge_rev <span class="main">(</span>mk_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> succ_orbits<span class="main">:</span> <span class="quoted"><span class="quoted">"is_map_succ_orbits_inv <span class="free">iG</span> <span class="free">iM</span> <span class="free">so_i</span> <span class="free">so_ok</span> <span class="free">V</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">succ_ok</span> <span class="main">⟶</span> is_map_final <span class="free">iG</span> <span class="free">so_i</span> <span class="free">so_ok</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Check_Planarity_Verification-ok_imp_digraph"><span class="command">lemma</span></span> ok_imp_digraph<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="free">rev_ok</span></span> <span class="quoted"><span class="free">succ_ok</span></span> <span class="quoted"><span class="free">so_ok</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"digraph_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="main">(</span>mk_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">interpret</span></span> bidirected_digraph <span class="quoted"><span class="quoted">"mk_graph <span class="free">iG</span>"</span></span> <span class="quoted"><span class="quoted">"edge_rev <span class="main">(</span>mk_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">rev_ok</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">succ_ok</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> perm<span class="main">:</span> <span class="quoted"><span class="quoted">"edge_succ <span class="main">(</span>mk_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span><span class="main">)</span> <span class="keyword1">permutes</span> arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> succ_ok_imp_permutes<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">succ_ok</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> ig_tail<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="main">⟹</span> ig_tail <span class="free">iG</span> <span class="main">(</span>im_succ <span class="free">iM</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> ig_tail <span class="free">iG</span> <span class="bound">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> succ_ok_tail_eq arcs_mkg<span class="main">)</span>

    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> verts <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"out_arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"tail <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"out_arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">b</span></span> <span class="main">∈</span> arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span><span class="main">.</span> ig_tail <span class="free">iG</span> <span class="skolem">a</span> <span class="main">=</span> ig_tail <span class="free">iG</span> <span class="bound">b</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkg_simps<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> orbit <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="main">(</span>snd <span class="free">iG</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>length <span class="main">(</span>snd <span class="free">iG</span><span class="main">)</span><span class="main">.</span>
            ig_tail <span class="free">iG</span> <span class="bound">i</span> <span class="main">=</span> ig_tail <span class="free">iG</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="bound">j</span> <span class="main">∈</span> orbit <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">succ_ok</span> ›</span></span><span class="quoted"><span class="quoted">‹<span class="free">so_ok</span>›</span></span> succ_orbits <span class="keyword1"><span class="command">unfolding</span></span> is_map_succ_orbits_inv_def is_map_final_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">with</span></span> a <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_mkg<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"out_arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">⊆</span> orbit <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"orbit <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">⊆</span> out_arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> orbit <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tail <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> a ig_tail
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induct</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkg_simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> orbit.intros<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">succ_ok</span>›</span></span> contra_subsetD orbit_es_eq_im permutes_orbit_subset perm<span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"orbit <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">⊆</span> arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> _ a<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> orbit_ss<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> assms arcs_mkg is_map_final_def is_map_succ_perm_inv_def succ_perm<span class="main">(</span>1<span class="main">)</span> succ_perm<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"out_arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">=</span> orbit <span class="main">(</span>edge_succ <span class="main">(</span>mk_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span><span class="main">)</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">succ_ok</span>›</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> orbit_es_eq_im<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cyclic_on <span class="main">(</span>edge_succ <span class="main">(</span>mk_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>out_arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> cyclic_on_def <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">with</span></span> perm <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">rev_ok</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkg_simps arcs_mkg<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Check_Planarity_Verification-digraph_imp_ok"><span class="command">lemma</span></span> digraph_imp_ok<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> dm<span class="main">:</span> <span class="quoted"><span class="quoted">"digraph_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="main">(</span>mk_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> pred<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>ig_edges <span class="free">iG</span><span class="main">)</span> <span class="main">⟹</span> im_pred <span class="free">iM</span> <span class="main">(</span>im_succ <span class="free">iM</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="bound">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="free">rev_ok</span></span> <span class="quoted"><span class="free">succ_ok</span></span> <span class="quoted"><span class="free">so_ok</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">interpret</span></span> dm<span class="main">:</span> digraph_map <span class="quoted"><span class="quoted">"mk_graph <span class="free">iG</span>"</span></span> <span class="quoted"><span class="quoted">"mk_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> dm<span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">rev_ok</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rev <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">succ_ok</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
            <span class="quoted"><span class="quoted">"edge_succ <span class="main">(</span>mk_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">∈</span> arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span>"</span></span>
            <span class="quoted"><span class="quoted">"tail <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="main">(</span>edge_succ <span class="main">(</span>mk_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> tail <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
            <span class="quoted"><span class="quoted">"im_succ <span class="free">iM</span> <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="free">iG</span><span class="main">)</span>"</span></span>
            <span class="quoted"><span class="quoted">"ig_tail <span class="free">iG</span> <span class="main">(</span>im_succ <span class="free">iM</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> ig_tail <span class="free">iG</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> es_eq_im<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> arcs <span class="main">_</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_mkg mkg_simps<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="main">(</span>ig_edges <span class="free">iG</span><span class="main">)</span><span class="main">.</span>
        im_succ <span class="free">iM</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="free">iG</span><span class="main">)</span> <span class="main">∧</span>
        ig_tail <span class="free">iG</span> <span class="main">(</span>im_succ <span class="free">iM</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> ig_tail <span class="free">iG</span> <span class="bound">i</span> <span class="main">∧</span> im_pred <span class="free">iM</span> <span class="main">(</span>im_succ <span class="free">iM</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> pred <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_mkg es_eq_im<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> succ_perm <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> is_map_succ_perm_inv_def is_map_final_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">so_ok</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>ig_edges <span class="free">iG</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>ig_edges <span class="free">iG</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"ig_tail <span class="free">iG</span> <span class="skolem">i</span> <span class="main">=</span> ig_tail <span class="free">iG</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"tail <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> tail <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="skolem">j</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkg_simps arcs_mkg<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cyclic_on <span class="main">(</span>edge_succ <span class="main">(</span>mk_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>out_arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="main">(</span>tail <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> dm.edge_succ_cyclic<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"orbit <span class="main">(</span>edge_succ <span class="main">(</span>mk_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> out_arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="main">(</span>ig_tail <span class="free">iG</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span>›</span></span> mkg_simps orbit_cyclic_eq3<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> orbit <span class="main">(</span>edge_succ <span class="main">(</span>mk_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mkg_simps<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"orbit <span class="main">(</span>edge_succ <span class="main">(</span>mk_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> orbit <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> arcs <span class="main">_</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> orbit_cong0<span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> es_eq_im<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> orbit <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> succ_orbits <span class="keyword1"><span class="command">unfolding</span></span> is_map_succ_orbits_inv_def is_map_final_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">safe</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">succ_ok</span>›</span></span> simp_thms<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Check_Planarity_Verification-all_less_Suc_eq"><span class="command">lemma</span></span> all_less_Suc_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">x</span></span> <span class="main">&lt;</span> Suc <span class="free">n</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">x</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> less_SucE<span class="main">)</span>

<span class="keyword1" id="Check_Planarity_Verification-in_orbit_imp_in_segment"><span class="command">lemma</span></span> in_orbit_imp_in_segment<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> orbit <span class="free">f</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"bij <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> segment <span class="free">f</span> <span class="free">x</span> <span class="main">(</span><span class="free">f</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
  <span class="keyword3"><span class="command">case</span></span> base <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> segment.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> segment.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> step <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">y</span> <span class="main">≠</span> <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bij_is_inj inv_f_f not_in_segment2<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> step False
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> segment.intros segment_step_2 bij_is_inj<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Check_Planarity_Verification-ovalidNF_is_map"><span class="command">lemma</span></span> ovalidNF_is_map<span class="main">:</span> <span class="quoted"><span class="quoted">"
  ovalidNF <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> distinct <span class="main">(</span>ig_verts <span class="free">iG</span><span class="main">)</span> <span class="main">∧</span> wf_digraph <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>is_map <span class="free">iG</span> <span class="free">iM</span><span class="main">)</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">r</span> <span class="main">⟷</span> digraph_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="main">(</span>mk_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="main">(</span>ig_edges <span class="free">iG</span><span class="main">)</span><span class="main">.</span> im_pred <span class="free">iM</span> <span class="main">(</span>im_succ <span class="free">iM</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>
"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_map_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"oreturn <span class="main"><span class="main">(</span></span>length <span class="main"><span class="main">(</span></span>ig_edges <span class="free"><span class="free">iG</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">|&gt;&gt;</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">ecnt</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⌑</span></span><span class="main"><span class="main">)</span></span>"</span></span></span>
    <span class="quasi_keyword">to</span> <span class="quoted"><span class="quoted"><span class="quoted">"owhile_inv <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span>
      <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">ok</span></span><span class="main"><span class="main">)</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">.</span></span> is_map_rev_ok_inv <span class="free"><span class="free">iG</span></span> <span class="free"><span class="free">iM</span></span> <span class="bound"><span class="bound">i</span></span> <span class="bound"><span class="bound">ok</span></span>
        <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">i</span></span> <span class="main"><span class="main">≤</span></span> <span class="skolem"><span class="skolem">ecnt</span></span> <span class="main"><span class="main">∧</span></span> wf_digraph <span class="main"><span class="main">(</span></span>mk_graph <span class="free"><span class="free">iG</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">(</span></span>measure <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">ok</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="skolem"><span class="skolem">ecnt</span></span> <span class="main"><span class="main">-</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>
    "</span></span></span> owhile_inv_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"owhile_inv <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">|&gt;&gt;</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">rev_i</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">rev_ok</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⌑</span></span><span class="main"><span class="main">)</span></span>"</span></span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"oreturn <span class="main"><span class="main">(</span></span>length <span class="main"><span class="main">(</span></span>ig_edges <span class="free"><span class="free">iG</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">|&gt;&gt;</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">ecnt</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⌑</span></span><span class="main"><span class="main">)</span></span>"</span></span></span>
    <span class="quasi_keyword">to</span> <span class="quoted"><span class="quoted"><span class="quoted">"owhile_inv <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span>
      <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">ok</span></span><span class="main"><span class="main">)</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">.</span></span> is_map_succ_perm_inv <span class="free"><span class="free">iG</span></span> <span class="free"><span class="free">iM</span></span> <span class="bound"><span class="bound">i</span></span> <span class="bound"><span class="bound">ok</span></span>
        <span class="main"><span class="main">∧</span></span> <span class="skolem"><span class="skolem">rev_ok</span></span> <span class="main"><span class="main">=</span></span> bidirected_digraph <span class="main"><span class="main">(</span></span>mk_graph <span class="free"><span class="free">iG</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>edge_rev <span class="main"><span class="main">(</span></span>mk_map <span class="main"><span class="main">(</span></span>mk_graph <span class="free"><span class="free">iG</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">iM</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>
        <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">i</span></span> <span class="main"><span class="main">≤</span></span> <span class="skolem"><span class="skolem">ecnt</span></span> <span class="main"><span class="main">∧</span></span> wf_digraph <span class="main"><span class="main">(</span></span>mk_graph <span class="free"><span class="free">iG</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">(</span></span>measure <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">ok</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="skolem"><span class="skolem">ecnt</span></span> <span class="main"><span class="main">-</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>
    "</span></span></span> owhile_inv_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"owhile_inv <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">|&gt;&gt;</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">succ_i</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">succ_ok</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⌑</span></span><span class="main"><span class="main">)</span></span>"</span></span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"owhile_inv <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">|&gt;&gt;</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">rev_i</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">rev_ok</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⌑</span></span><span class="main"><span class="main">)</span></span>"</span></span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"oreturn <span class="main"><span class="main">(</span></span>length <span class="main"><span class="main">(</span></span>ig_edges <span class="free"><span class="free">iG</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">|&gt;&gt;</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">ecnt</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⌑</span></span><span class="main"><span class="main">)</span></span>"</span></span></span>
    <span class="quasi_keyword">to</span> <span class="quoted"><span class="quoted"><span class="quoted">"owhile_inv <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span>
      <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">ok</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">V</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">A</span></span><span class="main"><span class="main">)</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">.</span></span> is_map_succ_orbits_inv <span class="free"><span class="free">iG</span></span> <span class="free"><span class="free">iM</span></span> <span class="bound"><span class="bound">i</span></span> <span class="bound"><span class="bound">ok</span></span> <span class="bound"><span class="bound">V</span></span> <span class="bound"><span class="bound">A</span></span>
        <span class="main"><span class="main">∧</span></span> <span class="skolem"><span class="skolem">rev_ok</span></span> <span class="main"><span class="main">=</span></span> bidirected_digraph <span class="main"><span class="main">(</span></span>mk_graph <span class="free"><span class="free">iG</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>edge_rev <span class="main"><span class="main">(</span></span>mk_map <span class="main"><span class="main">(</span></span>mk_graph <span class="free"><span class="free">iG</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">iM</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>
        <span class="main"><span class="main">∧</span></span> is_map_succ_perm_inv <span class="free"><span class="free">iG</span></span> <span class="free"><span class="free">iM</span></span> <span class="skolem"><span class="skolem">succ_i</span></span> <span class="skolem"><span class="skolem">succ_ok</span></span> <span class="main"><span class="main">∧</span></span> is_map_final <span class="free"><span class="free">iG</span></span> <span class="skolem"><span class="skolem">succ_i</span></span> <span class="skolem"><span class="skolem">succ_ok</span></span>
        <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">i</span></span> <span class="main"><span class="main">≤</span></span> <span class="skolem"><span class="skolem">ecnt</span></span> <span class="main"><span class="main">∧</span></span> wf_digraph <span class="main"><span class="main">(</span></span>mk_graph <span class="free"><span class="free">iG</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">(</span></span>measure <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">ok</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">V</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">A</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="skolem"><span class="skolem">ecnt</span></span> <span class="main"><span class="main">-</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>
    "</span></span></span> owhile_inv_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"owhile_inv <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">ok</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">V</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">A</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⌑</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"owhile_inv <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">|&gt;&gt;</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">succ_i</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">succ_ok</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⌑</span></span><span class="main"><span class="main">)</span></span>"</span></span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"owhile_inv <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">|&gt;&gt;</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">rev_i</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">rev_ok</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⌑</span></span><span class="main"><span class="main">)</span></span>"</span></span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"oreturn <span class="main"><span class="main">(</span></span>length <span class="main"><span class="main">(</span></span>ig_edges <span class="free"><span class="free">iG</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">|&gt;&gt;</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">ecnt</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⌑</span></span><span class="main"><span class="main">)</span></span>"</span></span></span>
    <span class="quasi_keyword">to</span> <span class="quoted"><span class="quoted"><span class="quoted">"owhile_inv <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span>
      <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">A'</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">j</span></span><span class="main"><span class="main">)</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">.</span></span> is_map_succ_orbits_inner_inv <span class="free"><span class="free">iG</span></span> <span class="free"><span class="free">iM</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="bound"><span class="bound">j</span></span> <span class="bound"><span class="bound">A'</span></span>
        <span class="main"><span class="main">∧</span></span> ig_tail <span class="free"><span class="free">iG</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="main"><span class="main">∉</span></span> <span class="skolem"><span class="skolem">V</span></span> <span class="main"><span class="main">∧</span></span> <span class="skolem"><span class="skolem">succ_ok</span></span> <span class="main"><span class="main">∧</span></span> <span class="skolem"><span class="skolem">ok</span></span> <span class="main"><span class="main">∧</span></span> is_map_succ_orbits_inv <span class="free"><span class="free">iG</span></span> <span class="free"><span class="free">iM</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">ok</span></span> <span class="skolem"><span class="skolem">V</span></span> <span class="skolem"><span class="skolem">A</span></span>
        <span class="main"><span class="main">∧</span></span> <span class="skolem"><span class="skolem">rev_ok</span></span> <span class="main"><span class="main">=</span></span> bidirected_digraph <span class="main"><span class="main">(</span></span>mk_graph <span class="free"><span class="free">iG</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>edge_rev <span class="main"><span class="main">(</span></span>mk_map <span class="main"><span class="main">(</span></span>mk_graph <span class="free"><span class="free">iG</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">iM</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>
        <span class="main"><span class="main">∧</span></span> is_map_succ_perm_inv <span class="free"><span class="free">iG</span></span> <span class="free"><span class="free">iM</span></span> <span class="skolem"><span class="skolem">succ_i</span></span> <span class="skolem"><span class="skolem">succ_ok</span></span> <span class="main"><span class="main">∧</span></span> is_map_final <span class="free"><span class="free">iG</span></span> <span class="skolem"><span class="skolem">succ_i</span></span> <span class="skolem"><span class="skolem">succ_ok</span></span>
        <span class="main"><span class="main">∧</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="main"><span class="main">&lt;</span></span> <span class="skolem"><span class="skolem">ecnt</span></span> <span class="main"><span class="main">∧</span></span> wf_digraph <span class="main"><span class="main">(</span></span>mk_graph <span class="free"><span class="free">iG</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">(</span></span>measure <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">A'</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">j</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> length <span class="main"><span class="main">(</span></span>ig_edges <span class="free"><span class="free">iG</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">-</span></span> card <span class="bound"><span class="bound">A'</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>
    "</span></span></span> owhile_inv_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">vcg_casify</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?es</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"edge_succ <span class="main">(</span>mk_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> weaken <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_map_rev_ok_inv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>while <span class="skolem">i</span> <span class="skolem">ok</span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> invariant
      <span class="keyword3"><span class="command">case</span></span> weaken <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_map_rev_ok_inv_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> less_SucE<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> wf <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> postcondition
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ok</span> <span class="main">⟷</span> bidirected_digraph <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="main">(</span>edge_rev <span class="main">(</span>mk_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> rev_ok_final<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_map_final_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> postcondition <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_map_succ_perm_inv_def<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>bind _ <span class="skolem">rev_ok</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>while <span class="skolem">i</span> <span class="skolem">ok</span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> invariant <span class="keyword3"><span class="command">case</span></span> weaken
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_map_succ_perm_inv_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> less_SucE<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> wf <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> postcondition
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_map_final_def is_map_succ_orbits_inv_def<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>bind <span class="skolem">succ_i</span> <span class="skolem">succ_ok</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>while <span class="skolem">i</span> <span class="skolem">ok</span> <span class="skolem">V</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> invariant
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> weaken
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> pc0<span class="main">:</span> is_map_postcondition0 <span class="quoted"><span class="free">iG</span></span> <span class="quoted"><span class="free">iM</span></span> <span class="quoted"><span class="skolem">rev_ok</span></span> <span class="quoted"><span class="skolem">succ_i</span></span> <span class="quoted"><span class="skolem">succ_ok</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> weaken.loop_cond <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>ig_edges <span class="free">iG</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">succ_ok</span></span> <span class="quoted"><span class="skolem">ok</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> weaken.loop_inv <span class="keyword1"><span class="command">have</span></span>
            V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">=</span> <span class="main">{</span>ig_tail <span class="free">iG</span> <span class="bound">k</span> <span class="main">|</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">i</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">k</span><span class="main">&lt;</span><span class="skolem">i</span><span class="main">.</span> orbit <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_map_succ_orbits_inv_def<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">branch_casify</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"then"</span> <span class="keyword3"><span class="command">case</span></span> g
          <span class="keyword1"><span class="command">have</span></span> V'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">=</span> <span class="main">{</span>ig_tail <span class="free">iG</span> <span class="bound">ia</span> <span class="main">|</span><span class="bound">ia</span><span class="main">.</span> <span class="bound">ia</span> <span class="main">&lt;</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="keyword1">then</span> Suc <span class="skolem">i</span> <span class="keyword1">else</span> Suc <span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> g <span class="quoted"><span class="quoted">‹<span class="skolem">V</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> less_SucE<span class="main">)</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_map_succ_orbits_inv <span class="free">iG</span> <span class="free">iM</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">)</span> <span class="skolem">V</span> <span class="skolem">A</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> orbit <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="skolem">j</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> True <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> i_in_less_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="main">{..&lt;</span><span class="skolem">i</span><span class="main">}</span><span class="main">.</span> <span class="skolem">i</span> <span class="main">∈</span> orbit <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> True <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> A'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">i</span><span class="main">&lt;</span><span class="keyword1">if</span> True <span class="keyword1">then</span> Suc <span class="skolem">i</span> <span class="keyword1">else</span> Suc <span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> orbit <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> orbit_trans <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> less_SucE<span class="main">)</span>

            <span class="keyword1"><span class="command">have</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="skolem">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">l</span></span><span class="main">&lt;</span><span class="skolem">i</span><span class="main">.</span> ig_tail <span class="free">iG</span> <span class="bound">k</span> <span class="main">=</span> ig_tail <span class="free">iG</span> <span class="bound">l</span> <span class="main">⟶</span> <span class="bound">l</span> <span class="main">∈</span> orbit <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="bound">k</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> weaken <span class="keyword1"><span class="command">unfolding</span></span> is_map_succ_orbits_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"ig_tail <span class="free">iG</span> <span class="skolem">j</span> <span class="main">=</span> ig_tail <span class="free">iG</span> <span class="skolem">i</span>"</span></span>
              <span class="keyword1"><span class="command">from</span></span> i_in_less_i <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> orbit <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ig_tail <span class="free">iG</span> <span class="skolem">k</span> <span class="main">=</span> ig_tail <span class="free">iG</span> <span class="skolem">i</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">succ_ok</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> pc0.in_orbit_im_succE<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> orbit <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="skolem">j</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> j <span class="quoted"><span class="quoted">‹ig_tail <span class="free">iG</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">_</span>›</span></span> k X <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> orbit <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> orbit_trans<span class="main">)</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">ultimately</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>Suc <span class="skolem">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">l</span></span><span class="main">&lt;</span>Suc <span class="skolem">i</span><span class="main">.</span> ig_tail <span class="free">iG</span> <span class="bound">k</span> <span class="main">=</span> ig_tail <span class="free">iG</span> <span class="bound">l</span> <span class="main">⟶</span> <span class="bound">l</span> <span class="main">∈</span> orbit <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="bound">k</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> all_less_Suc_eq <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">succ_ok</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> orbit_swap pc0.self_in_orbit_im_succ<span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> A' V' simp_thms is_map_succ_orbits_inv_def<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False

            <span class="keyword1"><span class="command">from</span></span> V g <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"ig_tail <span class="free">iG</span> <span class="skolem">j</span> <span class="main">=</span> ig_tail <span class="free">iG</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_map_succ_orbits_inv_def V' A <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> weaken <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"else"</span> <span class="keyword3"><span class="command">case</span></span> g
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_map_succ_orbits_inner_inv <span class="free">iG</span> <span class="free">iM</span> <span class="skolem">i</span> <span class="skolem">i</span> <span class="main">{}</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> is_map_succ_orbits_inner_inv_def
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">succ_ok</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pc0.self_in_orbit_im_succ<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> g weaken <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"if"</span> <span class="keyword3"><span class="command">case</span></span> else <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>while <span class="skolem">A'</span> <span class="skolem">i'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> invariant <span class="keyword3"><span class="command">case</span></span> weaken
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> pc0<span class="main">:</span> is_map_postcondition0 <span class="quoted"><span class="free">iG</span></span> <span class="quoted"><span class="free">iM</span></span> <span class="quoted"><span class="skolem">rev_ok</span></span> <span class="quoted"><span class="skolem">succ_i</span></span> <span class="quoted"><span class="skolem">succ_ok</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">succ_ok</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>ig_edges <span class="free">iG</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">∈</span> orbit <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> weaken <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_map_succ_orbits_inner_inv_def<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="main">(</span>ig_edges <span class="free">iG</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">succ_ok</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pc0.in_orbit_im_succE<span class="main">)</span>

          <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">∈</span> orbit <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">i'</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">∈</span> orbit <span class="main">(</span><span class="var">?es</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pc0.orbit_es_eq_im<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">succ_ok</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="main">_</span>›</span></span> arcs_mkg<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">∈</span> segment <span class="main">(</span><span class="var">?es</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span><span class="var">?es</span> <span class="skolem">i'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">i'</span>›</span></span> pc0.succ_ok_imp_permutes <span class="quoted"><span class="quoted">‹<span class="skolem">succ_ok</span> ›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> in_orbit_imp_in_segment<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutes_conv_has_dom<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">∈</span> segment <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>im_succ <span class="free">iM</span> <span class="skolem">i'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pc0.segment_es_eq_im<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> es_eq_im<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span>
                  <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">succ_ok</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="main">_</span>›</span></span> arcs_mkg<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> X <span class="main">=</span> this

          <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> segment <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">i'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">i'</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> segment <span class="main">(</span><span class="var">?es</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">i'</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pc0.segment_es_eq_im<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">succ_ok</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="main">_</span>›</span></span> arcs_mkg<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> segment <span class="main">(</span><span class="var">?es</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span><span class="var">?es</span> <span class="skolem">i'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">i'</span>›</span></span> pc0.succ_ok_imp_permutes <span class="quoted"><span class="quoted">‹<span class="skolem">succ_ok</span> ›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutes_conv_has_dom bij_is_inj <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> segment_step_2<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> segment <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>im_succ <span class="free">iM</span> <span class="skolem">i'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pc0.segment_es_eq_im<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> es_eq_im<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span>
                  <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">succ_ok</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="main">_</span>›</span></span> arcs_mkg<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> Y <span class="main">=</span> this

          <span class="keyword1"><span class="command">have</span></span> Z<span class="main">:</span> <span class="quoted"><span class="quoted">"is_map_succ_orbits_inner_inv <span class="free">iG</span> <span class="free">iM</span> <span class="skolem">i</span> <span class="main">(</span>im_succ <span class="free">iM</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">(</span>insert <span class="skolem">i'</span> <span class="skolem">A'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> weaken <span class="keyword1"><span class="command">unfolding</span></span> is_map_succ_orbits_inner_inv_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> segment_step_2D X Y <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> orbit.intros segment1_empty <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A'</span> <span class="main">⊆</span> orbit <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> weaken <span class="keyword1"><span class="command">unfolding</span></span> is_map_succ_orbits_inner_inv_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pc0.self_in_orbit_im_succ <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> segmentD_orbit <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> orbit_ss<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_mkg pc0.im_succ_le_length <span class="quoted"><span class="quoted">‹<span class="skolem">succ_ok</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="main">_</span>›</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">A'</span> <span class="main">&lt;</span> card <span class="main">(</span>arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">∉</span> <span class="skolem">A'</span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">intro</span> psubset_card_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_mkg <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">A'</span> <span class="main">&lt;</span> length <span class="main">(</span>ig_edges <span class="free">iG</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> arcs_mkg<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> weaken Z <span class="quoted"><span class="quoted">‹card <span class="skolem">A'</span> <span class="main">&lt;</span> length <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_insert_if <span class="quoted"><span class="quoted">‹finite <span class="skolem">A'</span>›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> wf <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> postcondition
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> pc0<span class="main">:</span> is_map_postcondition0 <span class="quoted"><span class="free">iG</span></span> <span class="quoted"><span class="free">iM</span></span> <span class="quoted"><span class="skolem">rev_ok</span></span> <span class="quoted"><span class="skolem">succ_i</span></span> <span class="quoted"><span class="skolem">succ_ok</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> postcondition <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ok</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">succ_ok</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>ig_edges <span class="free">iG</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

          <span class="keyword1"><span class="command">from</span></span> postcondition
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">∈</span> <span class="skolem">A'</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="skolem">A'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">i'</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">∉</span> <span class="skolem">A'</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="main">{</span><span class="skolem">i</span><span class="main">}</span> <span class="main">∪</span> segment <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">i'</span><span class="main">)</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">∈</span> orbit <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
              <span class="quoted"><span class="quoted">"ig_tail <span class="free">iG</span> <span class="skolem">i</span> <span class="main">∉</span> <span class="skolem">V</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_map_succ_orbits_inner_inv_def<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_in_segment2<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A'</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">i</span><span class="main">}</span> <span class="main">∪</span> segment <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"segment <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">i</span> <span class="main">=</span> segment <span class="var">?es</span> <span class="skolem">i</span> <span class="skolem">i</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pc0.segment_es_eq_im <span class="quoted"><span class="quoted">‹<span class="skolem">succ_ok</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="main">_</span>›</span></span> arcs_mkg<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> orbit <span class="var">?es</span> <span class="skolem">i</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">i</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> pc0.succ_ok_imp_permutes <span class="quoted"><span class="quoted">‹<span class="skolem">succ_ok</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutation_permutes arcs_mkg <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> segment_x_x_eq<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> orbit <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">i</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pc0.orbit_es_eq_im <span class="quoted"><span class="quoted">‹<span class="skolem">succ_ok</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="main">_</span>›</span></span> arcs_mkg<span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span>
          <span class="keyword1"><span class="command">have</span></span> A'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A'</span> <span class="main">=</span> orbit <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">succ_ok</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pc0.self_in_orbit_im_succ<span class="main">)</span>

          <span class="keyword1"><span class="command">from</span></span> postcondition
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">k</span><span class="main">&lt;</span><span class="skolem">i</span><span class="main">.</span> orbit <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> is_map_succ_orbits_inner_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_map_succ_orbits_inv_def<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">A'</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">k</span><span class="main">&lt;</span>Suc <span class="skolem">i</span><span class="main">.</span> orbit <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> A' <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 2 3 <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> less_SucE<span class="main">)</span>

          <span class="keyword1"><span class="command">from</span></span> postcondition <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">=</span> <span class="main">{</span>ig_tail <span class="free">iG</span> <span class="bound">ia</span> <span class="main">|</span><span class="bound">ia</span><span class="main">.</span> <span class="bound">ia</span> <span class="main">&lt;</span> <span class="skolem">i</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ok</span>›</span></span> is_map_succ_orbits_inv_def<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> V'<span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="main">(</span>ig_tail <span class="free">iG</span> <span class="skolem">i'</span><span class="main">)</span> <span class="skolem">V</span> <span class="main">=</span> <span class="main">{</span>ig_tail <span class="free">iG</span> <span class="bound">ia</span> <span class="main">|</span><span class="bound">ia</span><span class="main">.</span> <span class="bound">ia</span> <span class="main">&lt;</span> Suc <span class="skolem">i</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> less_SucE<span class="main">)</span>

          <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">i</span> <span class="main">⟹</span> ig_tail <span class="free">iG</span> <span class="bound">k</span> <span class="main">≠</span> ig_tail <span class="free">iG</span> <span class="skolem">i</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">V</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹ig_tail <span class="free">iG</span> <span class="skolem">i</span> <span class="main">∉</span> <span class="skolem">V</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">from</span></span> postcondition <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="skolem">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">l</span></span><span class="main">&lt;</span><span class="skolem">i</span><span class="main">.</span> ig_tail <span class="free">iG</span> <span class="bound">k</span> <span class="main">=</span> ig_tail <span class="free">iG</span> <span class="bound">l</span> <span class="main">⟶</span> <span class="bound">l</span> <span class="main">∈</span> orbit <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_map_succ_orbits_inv_def <span class="quoted"><span class="quoted">‹<span class="skolem">ok</span>›</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>Suc <span class="skolem">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">l</span></span><span class="main">&lt;</span>Suc <span class="skolem">i</span><span class="main">.</span> ig_tail <span class="free">iG</span> <span class="bound">k</span> <span class="main">=</span> ig_tail <span class="free">iG</span> <span class="bound">l</span> <span class="main">⟶</span> <span class="bound">l</span> <span class="main">∈</span> orbit <span class="main">(</span>im_succ <span class="free">iM</span><span class="main">)</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_less_Suc_eq pc0.self_in_orbit_im_succ <span class="quoted"><span class="quoted">‹<span class="skolem">succ_ok</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="main">_</span>›</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_map_succ_orbits_inv <span class="free">iG</span> <span class="free">iM</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> True <span class="main">(</span>insert <span class="main">(</span>ig_tail <span class="free">iG</span> <span class="skolem">i'</span><span class="main">)</span> <span class="skolem">V</span><span class="main">)</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">A'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> is_map_succ_orbits_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">A'</span> <span class="main">=</span> <span class="main">_</span>›</span></span> V' X<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> postcondition <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> wf <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> postcondition
      <span class="keyword1"><span class="command">interpret</span></span> pc<span class="main">:</span> is_map_postcondition <span class="quoted"><span class="free">iG</span></span> <span class="quoted"><span class="free">iM</span></span> <span class="quoted"><span class="skolem">rev_ok</span></span> <span class="quoted"><span class="skolem">succ_i</span></span> <span class="quoted"><span class="skolem">succ_ok</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">ok</span></span> <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="skolem">A</span></span>
        <span class="keyword1"><span class="command">using</span></span> postcondition <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_map_final_def<span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pc.ok_imp_digraph <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> pc.succ_ok_imp_pred <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> pc.digraph_imp_ok<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> ovalidNF_is_map<span class="main">[</span><span class="operator">THEN</span> ovalidNF_wp<span class="main">,</span> <span class="operator">THEN</span> trivial_label<span class="main">,</span> <span class="operator">vcg_l</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">isolated_nodes</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">inv_isolated_nodes</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="free"><span class="bound"><span class="entity">vcnt</span></span></span> <span class="free"><span class="bound"><span class="entity">ecnt</span></span></span> <span class="main">≡</span>
  <span class="free"><span class="bound"><span class="entity">vcnt</span></span></span> <span class="main">=</span> length <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">iG</span></span></span><span class="main">)</span>
  <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">ecnt</span></span></span> <span class="main">=</span> length <span class="main">(</span>ig_edges <span class="free"><span class="bound"><span class="entity">iG</span></span></span><span class="main">)</span>
  <span class="main">∧</span> distinct <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">iG</span></span></span><span class="main">)</span>
  <span class="main">∧</span> sym_digraph <span class="main">(</span>mk_graph <span class="free"><span class="bound"><span class="entity">iG</span></span></span><span class="main">)</span>
  "</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">inv_isolated_nodes_outer</span> <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">nz</span></span></span> <span class="main">≡</span>
  <span class="free"><span class="bound"><span class="entity">nz</span></span></span> <span class="main">=</span> card <span class="main">(</span>pre_digraph.isolated_verts <span class="main">(</span>mk_graph <span class="free"><span class="bound"><span class="entity">iG</span></span></span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>ig_verts <span class="free"><span class="bound"><span class="entity">iG</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">inv_isolated_nodes_inner</span> <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span>
  <span class="main">∀</span><span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≠</span> ig_tail <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="bound">k</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≠</span> ig_head <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="bound">k</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> sym_digraph<span class="main">)</span> in_arcs_empty_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"in_arcs <span class="free">G</span> <span class="free">v</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> out_arcs <span class="free">G</span> <span class="free">v</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> out_arcs_def in_arcs_def<span class="main">)</span>
     <span class="main">(</span><span class="operator">metis</span> graph_symmetric in_arcs_imp_in_arcs_ends reachableE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Check_Planarity_Verification-take_nth_distinct"><span class="command">lemma</span></span> take_nth_distinct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>distinct <span class="free">xs</span><span class="main">;</span> <span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">;</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">n</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distinct_conv_nth in_set_conv_nth<span class="main">)</span>

<span class="keyword1" id="Check_Planarity_Verification-ovalidNF_isolated_nodes"><span class="command">lemma</span></span> ovalidNF_isolated_nodes<span class="main">:</span> <span class="quoted"><span class="quoted">"
  ovalidNF <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> distinct <span class="main">(</span>ig_verts <span class="free">iG</span><span class="main">)</span> <span class="main">∧</span> sym_digraph <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>isolated_nodes <span class="free">iG</span><span class="main">)</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span>card <span class="main">(</span>pre_digraph.isolated_verts <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> isolated_nodes_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"oreturn <span class="main"><span class="main">(</span></span>length <span class="main"><span class="main">(</span></span>ig_verts <span class="free"><span class="free">iG</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">|&gt;&gt;</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">vcnt</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⌑</span></span><span class="main"><span class="main">)</span></span>"</span></span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"oreturn <span class="main"><span class="main">(</span></span>length <span class="main"><span class="main">(</span></span>ig_edges <span class="free"><span class="free">iG</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">|&gt;&gt;</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">ecnt</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⌑</span></span><span class="main"><span class="main">)</span></span>"</span></span></span>
    <span class="quasi_keyword">to</span> <span class="quoted"><span class="quoted"><span class="quoted">"owhile_inv <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span>
      <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">nz</span></span><span class="main"><span class="main">)</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">.</span></span> inv_isolated_nodes <span class="bound"><span class="bound">s</span></span> <span class="free"><span class="free">iG</span></span> <span class="skolem"><span class="skolem">vcnt</span></span> <span class="skolem"><span class="skolem">ecnt</span></span>
            <span class="main"><span class="main">∧</span></span> inv_isolated_nodes_outer <span class="free"><span class="free">iG</span></span> <span class="bound"><span class="bound">i</span></span> <span class="bound"><span class="bound">nz</span></span>
            <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">i</span></span> <span class="main"><span class="main">≤</span></span> <span class="skolem"><span class="skolem">vcnt</span></span><span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">(</span></span>measure <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">nz</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="skolem"><span class="skolem">vcnt</span></span> <span class="main"><span class="main">-</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>
    "</span></span></span> owhile_inv_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"oreturn <span class="main"><span class="main">(</span></span>fst <span class="free"><span class="free">iG</span></span> <span class="main"><span class="main">!</span></span> <span class="skolem"><span class="skolem">i</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">|&gt;&gt;</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">v</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⌑</span></span><span class="main"><span class="main">)</span></span>"</span></span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"owhile_inv <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">nz</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⌑</span></span><span class="main"><span class="main">)</span></span>"</span></span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"oreturn <span class="main"><span class="main">(</span></span>length <span class="main"><span class="main">(</span></span>ig_verts <span class="free"><span class="free">iG</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">|&gt;&gt;</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">vcnt</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⌑</span></span><span class="main"><span class="main">)</span></span>"</span></span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"oreturn <span class="main"><span class="main">(</span></span>length <span class="main"><span class="main">(</span></span>ig_edges <span class="free"><span class="free">iG</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">|&gt;&gt;</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">ecnt</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⌑</span></span><span class="main"><span class="main">)</span></span>"</span></span></span>
    <span class="quasi_keyword">to</span> <span class="quoted"><span class="quoted"><span class="quoted">"owhile_inv <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span>
      <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">j</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">ret</span></span><span class="main"><span class="main">)</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">.</span></span> inv_isolated_nodes <span class="bound"><span class="bound">s</span></span> <span class="free"><span class="free">iG</span></span> <span class="skolem"><span class="skolem">vcnt</span></span> <span class="skolem"><span class="skolem">ecnt</span></span>
           <span class="main"><span class="main">∧</span></span> inv_isolated_nodes_inner <span class="free"><span class="free">iG</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="bound"><span class="bound">j</span></span>
           <span class="main"><span class="main">∧</span></span> inv_isolated_nodes_outer <span class="free"><span class="free">iG</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">nz</span></span>
           <span class="main"><span class="main">∧</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="main"><span class="main">=</span></span> ig_verts <span class="free"><span class="free">iG</span></span> <span class="main"><span class="main">!</span></span> <span class="skolem"><span class="skolem">i</span></span>
           <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">ret</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">j</span></span> <span class="main"><span class="main">&lt;</span></span> <span class="skolem"><span class="skolem">ecnt</span></span> <span class="main"><span class="main">∧</span></span> ig_tail <span class="free"><span class="free">iG</span></span> <span class="bound"><span class="bound">j</span></span> <span class="main"><span class="main">≠</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="main"><span class="main">∧</span></span> ig_head <span class="free"><span class="free">iG</span></span> <span class="bound"><span class="bound">j</span></span> <span class="main"><span class="main">≠</span></span> <span class="skolem"><span class="skolem">v</span></span><span class="main"><span class="main">)</span></span>
           <span class="main"><span class="main">∧</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="main"><span class="main">&lt;</span></span> <span class="skolem"><span class="skolem">vcnt</span></span>
           <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">j</span></span> <span class="main"><span class="main">≤</span></span> <span class="skolem"><span class="skolem">ecnt</span></span><span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">(</span></span>measure <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">j</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">ret</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="skolem"><span class="skolem">ecnt</span></span> <span class="main"><span class="main">-</span></span> <span class="bound"><span class="bound">j</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>
    "</span></span></span> owhile_inv_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">vcg_casify</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>weaken <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_isolated_nodes_def inv_isolated_nodes_outer_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>while <span class="skolem">i</span> <span class="skolem">nz</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> invariant
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>weaken <span class="skolem">s'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> BRANCH_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_isolated_nodes_inner_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> bind
      <span class="keyword3"><span class="command">case</span></span> bind
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>while <span class="skolem">j</span> <span class="skolem">cond</span><span class="main">)</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> invariant
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> weaken
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">branch_casify</span>
            <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"else"</span> <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"else"</span> <span class="keyword3"><span class="command">case</span></span> g
            <span class="keyword1"><span class="command">with</span></span> weaken <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>ig_edges <span class="free">iG</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
            <span class="keyword1"><span class="command">with</span></span> weaken <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_isolated_nodes_inner_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> less_SucE<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> weaken<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_isolated_nodes_inner_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> less_SucE<span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> wf <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> postcondition
        <span class="keyword1"><span class="command">interpret</span></span> G<span class="main">:</span> sym_digraph <span class="quoted"><span class="quoted">"mk_graph <span class="free">iG</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> postcondition <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_isolated_nodes_def<span class="main">)</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?var</span></span></span> <span class="keyword1"><span class="command">using</span></span> postcondition <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"ig_verts <span class="free">iG</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>

        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> length <span class="main">(</span>snd <span class="free">iG</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="main">∈</span> pre_digraph.isolated_verts <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> A postcondition <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_digraph.isolated_verts_def mkg_simps inv_isolated_nodes_inner_def arcs_mkg<span class="main">)</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>ig_verts <span class="free">iG</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="main">=</span> ig_verts <span class="free">iG</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>ig_verts <span class="free">iG</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> postcondition <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_isolated_nodes_def<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="main">∉</span> set <span class="main">(</span>take <span class="skolem">i</span> <span class="main">(</span>ig_verts <span class="free">iG</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> take_nth_distinct<span class="main">)</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>card <span class="main">(</span>pre_digraph.isolated_verts <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>take <span class="skolem">i</span> <span class="main">(</span>fst <span class="free">iG</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="main">=</span> card <span class="main">(</span>insert <span class="var">?v</span> <span class="main">(</span>pre_digraph.isolated_verts <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>take <span class="skolem">i</span> <span class="main">(</span>fst <span class="free">iG</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> card <span class="var">?S</span>"</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?v</span> <span class="main">∉</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">=</span> pre_digraph.isolated_verts <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">iG</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?v</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?v</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Suc_conv_app_nth<span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv_isolated_nodes_outer <span class="free">iG</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">nz</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> postcondition <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_isolated_nodes_outer_def<span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> length <span class="main">(</span>snd <span class="free">iG</span><span class="main">)</span>"</span></span>

          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">(</span>out_arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="var">?v</span> <span class="main">∪</span> in_arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="var">?v</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> postcondition <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arcs_mkg mkg_simps ig_tail_def ig_head_def<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"out_arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="var">?v</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> in_in_arcs_conv in_out_arcs_conv<span class="main">)</span>
               <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.in_arcs_empty_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="main">∉</span> pre_digraph.isolated_verts <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_digraph.isolated_verts_def<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv_isolated_nodes_outer <span class="free">iG</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">nz</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> postcondition <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_isolated_nodes_outer_def take_Suc_conv_app_nth<span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?inv</span></span></span> <span class="keyword1"><span class="command">using</span></span> postcondition <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?var</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?inv</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> wf <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> postcondition
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pre_digraph.isolated_verts <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>fst <span class="free">iG</span><span class="main">)</span> <span class="main">=</span> pre_digraph.isolated_verts <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_digraph.isolated_verts_def mkg_simps<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> postcondition <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_isolated_nodes_def inv_isolated_nodes_outer_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> ovalidNF_isolated_nodes<span class="main">[</span><span class="operator">THEN</span> ovalidNF_wp<span class="main">,</span> <span class="operator">THEN</span> trivial_label<span class="main">,</span> <span class="operator">vcg_l</span><span class="main">]</span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">face_cycles</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">inv_face_cycles</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="free"><span class="bound"><span class="entity">ecnt</span></span></span> <span class="main">≡</span>
  <span class="free"><span class="bound"><span class="entity">ecnt</span></span></span> <span class="main">=</span> length <span class="main">(</span>ig_edges <span class="free"><span class="bound"><span class="entity">iG</span></span></span><span class="main">)</span>
  <span class="main">∧</span> digraph_map <span class="main">(</span>mk_graph <span class="free"><span class="bound"><span class="entity">iG</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">iM</span></span></span>
  "</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fcs_upto</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat pre_map <span class="main">⇒</span> nat <span class="main">⇒</span> nat set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fcs_upto</span> <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="main">{</span>pre_digraph_map.face_cycle_set <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="bound">k</span> <span class="main">|</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">inv_face_cycles_outer</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">edge_info</span></span></span> <span class="main">≡</span>
  <span class="keyword1">let</span> <span class="bound">fcs</span> <span class="main">=</span> fcs_upto <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">in</span>
  <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> card <span class="bound">fcs</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> length <span class="main">(</span>ig_edges <span class="free"><span class="bound"><span class="entity">iG</span></span></span><span class="main">)</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">edge_info</span></span></span> <span class="main">⟷</span> <span class="bound">k</span> <span class="main">∈</span> <span class="main">⋃</span><span class="bound">fcs</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">inv_face_cycles_inner</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">iG</span></span></span> <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">edge_info</span></span></span> <span class="main">≡</span>
  <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∈</span> pre_digraph_map.face_cycle_set <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>
  <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> card <span class="main">(</span>fcs_upto <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>
  <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∉</span> <span class="main">⋃</span><span class="main">(</span>fcs_upto <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> length <span class="main">(</span>ig_edges <span class="free"><span class="bound"><span class="entity">iG</span></span></span><span class="main">)</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">edge_info</span></span></span> <span class="main">⟷</span>
    <span class="main">(</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span>fcs_upto <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>
    <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">l</span></span> <span class="main">&lt;</span> funpow_dist1 <span class="main">(</span>pre_digraph_map.face_cycle_succ <span class="free"><span class="bound"><span class="entity">iM</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">.</span> <span class="main">(</span>pre_digraph_map.face_cycle_succ <span class="free"><span class="bound"><span class="entity">iM</span></span></span> <span class="main">^^</span> <span class="bound">l</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Check_Planarity_Verification-finite_fcs_upto"><span class="command">lemma</span></span> finite_fcs_upto<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>fcs_upto <span class="free">iM</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fcs_upto_def<span class="main">)</span>

<span class="keyword1" id="Check_Planarity_Verification-card_orbit_eq_funpow_dist1"><span class="command">lemma</span></span> card_orbit_eq_funpow_dist1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> orbit <span class="free">f</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>orbit <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> funpow_dist1 <span class="free">f</span> <span class="free">x</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>orbit <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="bound">n</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>funpow_dist1 <span class="free">f</span> <span class="free">x</span> <span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> orbit_conv_funpow_dist1<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>funpow_dist1 <span class="free">f</span> <span class="free">x</span> <span class="free">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_image inj_on_funpow_dist1<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Check_Planarity_Verification-funpow_dist1_le"><span class="command">lemma</span></span> funpow_dist1_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> orbit <span class="free">f</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> orbit <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"funpow_dist1 <span class="free">f</span> <span class="free">x</span> <span class="free">y</span> <span class="main">≤</span> funpow_dist1 <span class="free">f</span> <span class="free">x</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> funpow_dist1_le_self funpow_dist1_prop<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Check_Planarity_Verification-funpow_dist1_le_card"><span class="command">lemma</span></span> funpow_dist1_le_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> orbit <span class="free">f</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> orbit <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"funpow_dist1 <span class="free">f</span> <span class="free">x</span> <span class="free">y</span> <span class="main">≤</span> card <span class="main">(</span>orbit <span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> funpow_dist1_le<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_orbit_eq_funpow_dist1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> digraph_map<span class="main">)</span> funpow_dist1_le_card_fcs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> face_cycle_set <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"funpow_dist1 face_cycle_succ <span class="free">a</span> <span class="free">b</span> <span class="main">≤</span> card <span class="main">(</span>face_cycle_set <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms face_cycle_set_def face_cycle_set_self funpow_dist1_le_card<span class="main">)</span>

<span class="keyword1" id="Check_Planarity_Verification-funpow_dist1_f_eq"><span class="command">lemma</span></span> funpow_dist1_f_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> orbit <span class="free">f</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> orbit <span class="free">f</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"funpow_dist1 <span class="free">f</span> <span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>funpow_dist1 <span class="free">f</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> f_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="bound">n</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>funpow_dist1 <span class="free">f</span> <span class="free">a</span> <span class="free">a</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inj_on_funpow_dist1<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"funpow_dist1 <span class="free">f</span> <span class="free">a</span> <span class="free">b</span> <span class="main">≤</span> funpow_dist1 <span class="free">f</span> <span class="free">a</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> funpow_dist1_le<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"funpow_dist1 <span class="free">f</span> <span class="free">a</span> <span class="free">b</span> <span class="main">≠</span> funpow_dist1 <span class="free">f</span> <span class="free">a</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms funpow_dist1_prop<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> f_less<span class="main">:</span> <span class="quoted"><span class="quoted">"funpow_dist1 <span class="free">f</span> <span class="free">a</span> <span class="free">b</span> <span class="main">&lt;</span> funpow_dist1 <span class="free">f</span> <span class="free">a</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> f_Suc_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">^^</span> Suc <span class="main">(</span>funpow_dist1 <span class="free">f</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="free">f</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> funpow.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> o_apply funpow_dist1_prop<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">b</span> <span class="main">=</span> <span class="free">a</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_lessI f_Suc_eq f_less assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> funpow.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> funpow_neq_less_funpow_dist1 id_apply old.nat.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> zero_less_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>funpow_dist1 <span class="free">f</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">&lt;</span> funpow_dist1 <span class="free">f</span> <span class="free">a</span> <span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f_Suc_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> f_less funpow_dist1_prop le_less_Suc_eq less_Suc_eq_le not_less_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> f_inj <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> funpow_dist1 <span class="free">f</span> <span class="free">a</span> <span class="free">a</span> <span class="main">⟹</span> <span class="bound">n</span> <span class="main">≠</span> Suc <span class="main">(</span>funpow_dist1 <span class="free">f</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="bound">n</span><span class="main">)</span> <span class="free">a</span> <span class="main">≠</span> <span class="free">f</span> <span class="free">b</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f_Suc_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inj_onD<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> * assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> f_Suc_eq funpow_neq_less_funpow_dist1<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="var">?thesis</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="main">(</span>funpow_dist1 <span class="free">f</span> <span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span>  <span class="main">=</span> <span class="free">f</span> <span class="free">b</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> funpow_dist1_prop<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> orbit.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> A ** <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"funpow_dist1 <span class="free">f</span> <span class="free">a</span> <span class="free">a</span> <span class="main">≤</span> <span class="main">(</span>funpow_dist1 <span class="free">f</span> <span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_Suc_eq_le not_less_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>funpow_dist1 <span class="free">f</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span>funpow_dist1 <span class="free">f</span> <span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">^^</span> Suc <span class="main">(</span>funpow_dist1 <span class="free">f</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span> <span class="main">≠</span> <span class="free">f</span> <span class="free">b</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> funpow_dist1_least<span class="main">)</span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> f_Suc_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> funpow_dist1_less_f<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> orbit <span class="free">f</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> orbit <span class="free">f</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"funpow_dist1 <span class="free">f</span> <span class="free">a</span> <span class="free">b</span> <span class="main">&lt;</span> funpow_dist1 <span class="free">f</span> <span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funpow_dist1_f_eq<span class="main">)</span>

<span class="keyword1" id="Check_Planarity_Verification-ovalidNF_face_cycles"><span class="command">lemma</span></span> ovalidNF_face_cycles<span class="main">:</span> <span class="quoted"><span class="quoted">"
  ovalidNF <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> digraph_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span><span class="main">)</span>
    <span class="main">(</span>face_cycles <span class="free">iG</span> <span class="free">iM</span><span class="main">)</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> card <span class="main">(</span>pre_digraph_map.face_cycle_sets <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span><span class="main">)</span><span class="main">)</span>
"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> face_cycles_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"oreturn <span class="main"><span class="main">(</span></span>length <span class="main"><span class="main">(</span></span>ig_edges <span class="free"><span class="free">iG</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">|&gt;&gt;</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">ecnt</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⌑</span></span><span class="main"><span class="main">)</span></span>"</span></span></span>
    <span class="quasi_keyword">to</span> <span class="quoted"><span class="quoted"><span class="quoted">"owhile_inv <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span>
          <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">edge_info</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">c</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">)</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">.</span></span> inv_face_cycles <span class="bound"><span class="bound">s</span></span> <span class="free"><span class="free">iG</span></span> <span class="free"><span class="free">iM</span></span> <span class="skolem"><span class="skolem">ecnt</span></span>
            <span class="main"><span class="main">∧</span></span> inv_face_cycles_outer <span class="bound"><span class="bound">s</span></span> <span class="free"><span class="free">iG</span></span> <span class="free"><span class="free">iM</span></span> <span class="bound"><span class="bound">i</span></span> <span class="bound"><span class="bound">c</span></span> <span class="bound"><span class="bound">edge_info</span></span>
            <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">i</span></span> <span class="main"><span class="main">≤</span></span> <span class="skolem"><span class="skolem">ecnt</span></span><span class="main"><span class="main">)</span></span>
          <span class="main"><span class="main">(</span></span>measure <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">edge_info</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">c</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="skolem"><span class="skolem">ecnt</span></span> <span class="main"><span class="main">-</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>
      "</span></span></span> owhile_inv_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
  <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"owhile_inv <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">c</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⌑</span></span><span class="main"><span class="main">)</span></span>"</span></span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"oreturn <span class="main"><span class="main">(</span></span>length <span class="main"><span class="main">(</span></span>ig_edges <span class="free"><span class="free">iG</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">|&gt;&gt;</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">ecnt</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⌑</span></span><span class="main"><span class="main">)</span></span>"</span></span></span>
    <span class="quasi_keyword">to</span> <span class="quoted"><span class="quoted"><span class="quoted">"owhile_inv <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span>
          <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">edge_info</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">j</span></span><span class="main"><span class="main">)</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">.</span></span> inv_face_cycles <span class="bound"><span class="bound">s</span></span> <span class="free"><span class="free">iG</span></span> <span class="free"><span class="free">iM</span></span> <span class="skolem"><span class="skolem">ecnt</span></span>
            <span class="main"><span class="main">∧</span></span> inv_face_cycles_inner <span class="bound"><span class="bound">s</span></span> <span class="free"><span class="free">iG</span></span> <span class="free"><span class="free">iM</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="bound"><span class="bound">j</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="bound"><span class="bound">edge_info</span></span>
            <span class="main"><span class="main">∧</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="main"><span class="main">&lt;</span></span> <span class="skolem"><span class="skolem">ecnt</span></span><span class="main"><span class="main">)</span></span>
          <span class="main"><span class="main">(</span></span>measure <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">edge_info</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">j</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> card <span class="main"><span class="main">(</span></span>pre_digraph_map.face_cycle_set <span class="free"><span class="free">iM</span></span> <span class="skolem"><span class="skolem">i</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">-</span></span> funpow_dist1 <span class="main"><span class="main">(</span></span>pre_digraph_map.face_cycle_succ <span class="free"><span class="free">iM</span></span><span class="main"><span class="main">)</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="bound"><span class="bound">j</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>
      "</span></span></span> owhile_inv_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
  <span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">vcg_casify</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>weaken <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_face_cycles_def inv_face_cycles_outer_def fcs_upto_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>while <span class="skolem">edge_info</span> <span class="skolem">c</span> <span class="skolem">i</span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>postcondition <span class="skolem">s</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fcs_upto <span class="free">iM</span> <span class="main">(</span>length <span class="main">(</span>ig_edges <span class="free">iG</span><span class="main">)</span><span class="main">)</span>
          <span class="main">=</span> pre_digraph_map.face_cycle_sets <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_digraph_map.face_cycle_sets_def arcs_mkg fcs_upto_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_face_cycles_outer_def Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>invariant <span class="skolem">s</span><span class="main">)</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>weaken <span class="skolem">s'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">interpret</span></span> G<span class="main">:</span> digraph_map <span class="quoted"><span class="quoted">"mk_graph <span class="free">iG</span>"</span></span> <span class="quoted"><span class="free">iM</span></span>
          <span class="keyword1"><span class="command">using</span></span> weaken <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_face_cycles_def<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">branch_casify</span>
          <span class="keyword3"><span class="command">case</span></span> else <span class="keyword3"><span class="command">case</span></span> g
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"G.face_cycle_set <span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span>G.face_cycle_set <span class="bound">k</span> <span class="main">|</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">i</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> weaken <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_face_cycles_outer_def fcs_upto_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> G.face_cycle_eq<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>G.face_cycle_set <span class="bound">k</span> <span class="main">|</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> Suc <span class="skolem">i</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span>G.face_cycle_set <span class="bound">k</span> <span class="main">|</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">i</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> less_SucE<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv_face_cycles_outer <span class="skolem">s'</span> <span class="free">iG</span> <span class="free">iM</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">c</span> <span class="skolem">edge_info</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> weaken <span class="keyword1"><span class="command">unfolding</span></span> inv_face_cycles_outer_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fcs_upto_def<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?inv</span></span></span> <span class="keyword1"><span class="command">using</span></span> weaken <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> weaken <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"then"</span> <span class="keyword3"><span class="command">case</span></span> g
          <span class="keyword1"><span class="command">have</span></span> fd1_triv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> funpow_dist1 <span class="bound">f</span> <span class="bound">x</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funpow_dist_0<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> fcs_in<span class="main">:</span> <span class="quoted"><span class="quoted">"G.face_cycle_succ <span class="skolem">i</span> <span class="main">∈</span> G.face_cycle_set <span class="skolem">i</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> G.face_cycle_succ_inI<span class="main">)</span>

          <span class="keyword1"><span class="command">have</span></span> i_not_in_fcs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∉</span> <span class="main">⋃</span><span class="main">(</span>fcs_upto <span class="free">iM</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> g weaken
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_face_cycles_outer_def fcs_upto_def<span class="main">)</span>

          <span class="keyword1"><span class="command">from</span></span> weaken <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> inv_face_cycles_inner_def inv_face_cycles_outer_def
            <span class="keyword1"><span class="command">using</span></span> i_not_in_fcs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fd1_triv fcs_in fcs_upto_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"if"</span> <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"then"</span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>while <span class="skolem">edge_info</span> <span class="skolem">j</span><span class="main">)</span>
          <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>postcondition <span class="skolem">s'</span><span class="main">)</span>

            <span class="keyword1"><span class="command">interpret</span></span> G<span class="main">:</span> digraph_map <span class="quoted"><span class="quoted">"mk_graph <span class="free">iG</span>"</span></span> <span class="quoted"><span class="free">iM</span></span>
              <span class="keyword1"><span class="command">using</span></span> postcondition <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_face_cycles_def<span class="main">)</span>

            <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?var</span></span></span> <span class="keyword1"><span class="command">using</span></span> postcondition <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

            <span class="keyword1"><span class="command">have</span></span> fu_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"fcs_upto <span class="free">iM</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> fcs_upto <span class="free">iM</span> <span class="skolem">j</span> <span class="main">∪</span> <span class="main">{</span>G.face_cycle_set <span class="skolem">j</span><span class="main">}</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fcs_upto_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> less_SucE<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"G.face_cycle_set <span class="skolem">j</span> <span class="main">∉</span> fcs_upto <span class="free">iM</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span>  <span class="main">=</span> card <span class="main">(</span>fcs_upto <span class="free">iM</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> postcondition <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_face_cycles_inner_def<span class="main">)</span>
            <span class="keyword1"><span class="command">ultimately</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">c</span> <span class="main">=</span> card <span class="main">(</span>fcs_upto <span class="free">iM</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_fcs_upto<span class="main">)</span>

            <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>length <span class="main">(</span>snd <span class="free">iG</span><span class="main">)</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> <span class="skolem">edge_info</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">∈</span>fcs_upto <span class="free">iM</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> orbit G.face_cycle_succ <span class="skolem">j</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> G.face_cycle_set_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">l</span></span><span class="main">&lt;</span>funpow_dist1 G.face_cycle_succ <span class="skolem">j</span> <span class="skolem">j</span><span class="main">.</span> <span class="main">(</span>G.face_cycle_succ <span class="main">^^</span> <span class="bound">l</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">=</span> <span class="bound">k</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="bound">k</span> <span class="main">∈</span> G.face_cycle_set <span class="skolem">j</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.face_cycle_set_def orbit_conv_funpow_dist1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">moreover</span></span>
              <span class="keyword1"><span class="command">from</span></span> postcondition <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv_face_cycles_inner <span class="skolem">s'</span> <span class="free">iG</span> <span class="free">iM</span> <span class="skolem">j</span> <span class="skolem">j</span> <span class="skolem">c</span> <span class="skolem">edge_info</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">ultimately</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> inv_face_cycles_inner_def fu_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>

            <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?inv</span></span></span> <span class="keyword1"><span class="command">using</span></span> postcondition *
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_face_cycles_outer_def <span class="quoted"><span class="quoted">‹Suc <span class="skolem">c</span> <span class="main">=</span> <span class="main">_</span>›</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?var</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>invariant <span class="skolem">s'</span><span class="main">)</span>
            <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>weaken <span class="skolem">s''</span><span class="main">)</span>
              <span class="keyword1"><span class="command">interpret</span></span> G<span class="main">:</span> digraph_map <span class="quoted"><span class="quoted">"mk_graph <span class="free">iG</span>"</span></span> <span class="quoted"><span class="free">iM</span></span>
                <span class="keyword1"><span class="command">using</span></span> weaken <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_face_cycles_def<span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> G.face_cycle_set <span class="skolem">i</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> weaken <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_face_cycles_inner_def<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> G.face_cycle_set_def G.funpow_face_cycle_succ_no_arc G.in_face_cycle_setD
                  funpow_dist1_prop weaken.loop_cond<span class="main">)</span>

              <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> pre_digraph_map.face_cycle_set <span class="free">iM</span> <span class="skolem">i</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> weaken <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_face_cycles_inner_def<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> A'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>G.face_cycle_succ <span class="main">^^</span> funpow_dist1 G.face_cycle_succ <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> funpow_dist1_prop<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> G.face_cycle_set_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

              <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
                <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">n</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">n</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">f</span> <span class="main">^^</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="bound">f</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">l</span></span><span class="main">&lt;</span>funpow_dist1 G.face_cycle_succ <span class="skolem">i</span> <span class="main">(</span>G.face_cycle_succ <span class="skolem">j</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>G.face_cycle_succ <span class="main">^^</span> <span class="bound">l</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">)</span>
                    <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">l</span></span><span class="main">&lt;</span>Suc <span class="main">(</span>funpow_dist1 G.face_cycle_succ <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>G.face_cycle_succ <span class="main">^^</span> <span class="bound">l</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="main">_</span>"</span></span><span class="main">)</span>
                  <span class="keyword1"><span class="command">using</span></span> A <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">j</span>›</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> funpow_dist1_f_eq<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> G.face_cycle_set_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">l</span></span><span class="main">&lt;</span>funpow_dist1 G.face_cycle_succ <span class="skolem">i</span> <span class="skolem">j</span><span class="main">.</span> <span class="main">(</span>G.face_cycle_succ <span class="main">^^</span> <span class="bound">l</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
                  <span class="keyword1"><span class="command">using</span></span> A' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> less_SucE
                    <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> * exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>funpow_dist1 G.face_cycle_succ <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
              <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> B <span class="main">=</span> this

              <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?inv</span></span></span>
                <span class="keyword1"><span class="command">using</span></span> weaken <span class="keyword1"><span class="command">unfolding</span></span> inv_face_cycles_inner_def B
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.face_cycle_succ_inI<span class="main">)</span>

              <span class="keyword1"><span class="command">have</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"funpow_dist1 G.face_cycle_succ <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">&lt;</span> card <span class="main">(</span>G.face_cycle_set <span class="skolem">i</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"funpow_dist1 G.face_cycle_succ <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">≤</span> funpow_dist1 G.face_cycle_succ <span class="skolem">i</span> <span class="skolem">i</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> _ _ A <span class="keyword1"><span class="command">unfolding</span></span> G.face_cycle_set_def
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> funpow_dist1_le_self<span class="main">)</span>
                   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> funpow_dist1_prop<span class="main">)</span>
                   <span class="keyword1"><span class="command">unfolding</span></span> G.face_cycle_set_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
                   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
                <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"funpow_dist1 G.face_cycle_succ <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">≠</span> funpow_dist1 G.face_cycle_succ <span class="skolem">i</span> <span class="skolem">i</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> A G.face_cycle_set_def G.face_cycle_set_self funpow_dist1_prop
                    weaken.loop_cond<span class="main">)</span>
                <span class="keyword1"><span class="command">ultimately</span></span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"funpow_dist1 G.face_cycle_succ <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">&lt;</span> funpow_dist1 G.face_cycle_succ <span class="skolem">i</span> <span class="skolem">i</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> card <span class="main">(</span>G.face_cycle_set <span class="skolem">i</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> G.funpow_dist1_le_card_fcs<span class="main">)</span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
              <span class="keyword1"><span class="command">qed</span></span>

              <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?var</span></span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">using</span></span> _ X <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> diff_less_mono2<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> funpow_dist1_less_f<span class="main">)</span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">j</span>›</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.face_cycle_set_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?inv</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">declare</span></span> ovalidNF_face_cycles<span class="main">[</span><span class="operator">THEN</span> ovalidNF_wp<span class="main">,</span> <span class="operator">THEN</span> trivial_label<span class="main">,</span> <span class="operator">vcg_l</span><span class="main">]</span>

<span class="keyword1" id="Check_Planarity_Verification-ovalidNF_euler_genus"><span class="command">lemma</span></span> ovalidNF_euler_genus<span class="main">:</span> <span class="quoted"><span class="quoted">"
  ovalidNF <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> distinct <span class="main">(</span>ig_verts <span class="free">iG</span><span class="main">)</span> <span class="main">∧</span> digraph_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">=</span> card <span class="main">(</span>pre_digraph.sccs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>euler_genus <span class="free">iG</span> <span class="free">iM</span> <span class="free">c</span><span class="main">)</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> pre_digraph_map.euler_genus <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span><span class="main">)</span>
"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> euler_genus_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">vcg_casify</span>
  <span class="keyword3"><span class="command">case</span></span> weaken
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>ig_verts <span class="free">iG</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> weaken <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">interpret</span></span> G<span class="main">:</span> digraph_map <span class="quoted"><span class="quoted">"mk_graph <span class="free">iG</span>"</span></span> <span class="quoted"><span class="free">iM</span></span> <span class="keyword1"><span class="command">using</span></span> weaken <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> len_card<span class="main">:</span>
      <span class="quoted"><span class="quoted">"length <span class="main">(</span>ig_verts <span class="free">iG</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>verts <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"length <span class="main">(</span>ig_edges <span class="free">iG</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>arcs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkg_simps arcs_mkg distinct_card<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> weaken <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.euler_genus_def G.euler_char_def len_card<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> ovalidNF_euler_genus<span class="main">[</span><span class="operator">THEN</span> ovalidNF_wp<span class="main">,</span> <span class="operator">THEN</span> trivial_label<span class="main">,</span> <span class="operator">vcg_l</span><span class="main">]</span>

<span class="keyword1" id="Check_Planarity_Verification-ovalidNF_certify"><span class="command">lemma</span></span> ovalidNF_certify<span class="main">:</span> <span class="quoted"><span class="quoted">"
  ovalidNF <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> distinct <span class="main">(</span>ig_verts <span class="free">iG</span><span class="main">)</span> <span class="main">∧</span> fin_digraph <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">=</span> card <span class="main">(</span>pre_digraph.sccs <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>certify <span class="free">iG</span> <span class="free">iM</span> <span class="free">c</span><span class="main">)</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">r</span> <span class="main">⟷</span> pre_digraph_map.euler_genus <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="main">(</span>mk_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>
    <span class="main">∧</span> digraph_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="main">(</span>mk_map <span class="main">(</span>mk_graph <span class="free">iG</span><span class="main">)</span> <span class="free">iM</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="main">(</span>ig_edges <span class="free">iG</span><span class="main">)</span><span class="main">.</span> im_pred <span class="free">iM</span> <span class="main">(</span>im_succ <span class="free">iM</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="bound">i</span><span class="main">)</span> <span class="main">)</span>
"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> certify_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">vcg_casify</span>
  <span class="keyword3"><span class="command">case</span></span> weaken
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> fin_digraph <span class="quoted"><span class="quoted">"mk_graph <span class="free">iG</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> weaken <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> BRANCH_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_digraph<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Planarity_Certificates">
<div class="head">
<h1>Theory Planarity_Certificates</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Planarity_Certificates
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="#Kuratowski_Combinatorial">Planarity/Kuratowski_Combinatorial</a>"</span>
  <span class="quoted">"<a href="#Check_Non_Planarity_Verification">Verification/Check_Non_Planarity_Verification</a>"</span>
  <span class="quoted">"<a href="#Check_Planarity_Verification">Verification/Check_Planarity_Verification</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>